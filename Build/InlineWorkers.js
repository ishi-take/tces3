globalThis.CESIUM_WORKERS = atob("dmFyIENlc2l1bVdvcmtlcnMgPSAoKCkgPT4gewogIHZhciBfX2NyZWF0ZSA9IE9iamVjdC5jcmVhdGU7CiAgdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICB2YXIgX19nZXRPd25Qcm9wRGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3I7CiAgdmFyIF9fZ2V0T3duUHJvcE5hbWVzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM7CiAgdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKICB2YXIgX19oYXNPd25Qcm9wID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICB2YXIgX19yZXF1aXJlID0gLyogQF9fUFVSRV9fICovICgoeCkgPT4gdHlwZW9mIHJlcXVpcmUgIT09ICJ1bmRlZmluZWQiID8gcmVxdWlyZSA6IHR5cGVvZiBQcm94eSAhPT0gInVuZGVmaW5lZCIgPyBuZXcgUHJveHkoeCwgewogICAgZ2V0OiAoYTMsIGIpID0+ICh0eXBlb2YgcmVxdWlyZSAhPT0gInVuZGVmaW5lZCIgPyByZXF1aXJlIDogYTMpW2JdCiAgfSkgOiB4KShmdW5jdGlvbih4KSB7CiAgICBpZiAodHlwZW9mIHJlcXVpcmUgIT09ICJ1bmRlZmluZWQiKSByZXR1cm4gcmVxdWlyZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhyb3cgRXJyb3IoJ0R5bmFtaWMgcmVxdWlyZSBvZiAiJyArIHggKyAnIiBpcyBub3Qgc3VwcG9ydGVkJyk7CiAgfSk7CiAgdmFyIF9fZ2xvYiA9IChtYXApID0+IChwYXRoKSA9PiB7CiAgICB2YXIgZm4gPSBtYXBbcGF0aF07CiAgICBpZiAoZm4pIHJldHVybiBmbigpOwogICAgdGhyb3cgbmV3IEVycm9yKCJNb2R1bGUgbm90IGZvdW5kIGluIGJ1bmRsZTogIiArIHBhdGgpOwogIH07CiAgdmFyIF9fZXNtID0gKGZuLCByZXMpID0+IGZ1bmN0aW9uIF9faW5pdCgpIHsKICAgIHJldHVybiBmbiAmJiAocmVzID0gKDAsIGZuW19fZ2V0T3duUHJvcE5hbWVzKGZuKVswXV0pKGZuID0gMCkpLCByZXM7CiAgfTsKICB2YXIgX19jb21tb25KUyA9IChjYiwgbW9kKSA9PiBmdW5jdGlvbiBfX3JlcXVpcmUyKCkgewogICAgcmV0dXJuIG1vZCB8fCAoMCwgY2JbX19nZXRPd25Qcm9wTmFtZXMoY2IpWzBdXSkoKG1vZCA9IHsgZXhwb3J0czoge30gfSkuZXhwb3J0cywgbW9kKSwgbW9kLmV4cG9ydHM7CiAgfTsKICB2YXIgX19leHBvcnQgPSAodGFyZ2V0LCBhbGwpID0+IHsKICAgIGZvciAodmFyIG5hbWUgaW4gYWxsKQogICAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwogIH07CiAgdmFyIF9fY29weVByb3BzID0gKHRvLCBmcm9tLCBleGNlcHQsIGRlc2MpID0+IHsKICAgIGlmIChmcm9tICYmIHR5cGVvZiBmcm9tID09PSAib2JqZWN0IiB8fCB0eXBlb2YgZnJvbSA9PT0gImZ1bmN0aW9uIikgewogICAgICBmb3IgKGxldCBrZXkgb2YgX19nZXRPd25Qcm9wTmFtZXMoZnJvbSkpCiAgICAgICAgaWYgKCFfX2hhc093blByb3AuY2FsbCh0bywga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICAgIF9fZGVmUHJvcCh0bywga2V5LCB7IGdldDogKCkgPT4gZnJvbVtrZXldLCBlbnVtZXJhYmxlOiAhKGRlc2MgPSBfX2dldE93blByb3BEZXNjKGZyb20sIGtleSkpIHx8IGRlc2MuZW51bWVyYWJsZSB9KTsKICAgIH0KICAgIHJldHVybiB0bzsKICB9OwogIHZhciBfX3RvRVNNID0gKG1vZCwgaXNOb2RlTW9kZSwgdGFyZ2V0KSA9PiAodGFyZ2V0ID0gbW9kICE9IG51bGwgPyBfX2NyZWF0ZShfX2dldFByb3RvT2YobW9kKSkgOiB7fSwgX19jb3B5UHJvcHMoCiAgICAvLyBJZiB0aGUgaW1wb3J0ZXIgaXMgaW4gbm9kZSBjb21wYXRpYmlsaXR5IG1vZGUgb3IgdGhpcyBpcyBub3QgYW4gRVNNCiAgICAvLyBmaWxlIHRoYXQgaGFzIGJlZW4gY29udmVydGVkIHRvIGEgQ29tbW9uSlMgZmlsZSB1c2luZyBhIEJhYmVsLQogICAgLy8gY29tcGF0aWJsZSB0cmFuc2Zvcm0gKGkuZS4gIl9fZXNNb2R1bGUiIGhhcyBub3QgYmVlbiBzZXQpLCB0aGVuIHNldAogICAgLy8gImRlZmF1bHQiIHRvIHRoZSBDb21tb25KUyAibW9kdWxlLmV4cG9ydHMiIGZvciBub2RlIGNvbXBhdGliaWxpdHkuCiAgICBpc05vZGVNb2RlIHx8ICFtb2QgfHwgIW1vZC5fX2VzTW9kdWxlID8gX19kZWZQcm9wKHRhcmdldCwgImRlZmF1bHQiLCB7IHZhbHVlOiBtb2QsIGVudW1lcmFibGU6IHRydWUgfSkgOiB0YXJnZXQsCiAgICBtb2QKICApKTsKICB2YXIgX190b0NvbW1vbkpTID0gKG1vZCkgPT4gX19jb3B5UHJvcHMoX19kZWZQcm9wKHt9LCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSksIG1vZCk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9kZWZpbmVkLmpzCiAgZnVuY3Rpb24gZGVmaW5lZCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlICE9PSB2b2lkIDAgJiYgdmFsdWUgIT09IG51bGw7CiAgfQogIHZhciBkZWZpbmVkX2RlZmF1bHQ7CiAgdmFyIGluaXRfZGVmaW5lZCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVmaW5lZC5qcyIoKSB7CiAgICAgIGRlZmluZWRfZGVmYXVsdCA9IGRlZmluZWQ7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9EZXZlbG9wZXJFcnJvci5qcwogIGZ1bmN0aW9uIERldmVsb3BlckVycm9yKG1lc3NhZ2UpIHsKICAgIHRoaXMubmFtZSA9ICJEZXZlbG9wZXJFcnJvciI7CiAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgbGV0IHN0YWNrOwogICAgdHJ5IHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHN0YWNrID0gZS5zdGFjazsKICAgIH0KICAgIHRoaXMuc3RhY2sgPSBzdGFjazsKICB9CiAgdmFyIERldmVsb3BlckVycm9yX2RlZmF1bHQ7CiAgdmFyIGluaXRfRGV2ZWxvcGVyRXJyb3IgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0RldmVsb3BlckVycm9yLmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoT2JqZWN0LmNyZWF0ZSkpIHsKICAgICAgICBEZXZlbG9wZXJFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVycm9yLnByb3RvdHlwZSk7CiAgICAgICAgRGV2ZWxvcGVyRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRGV2ZWxvcGVyRXJyb3I7CiAgICAgIH0KICAgICAgRGV2ZWxvcGVyRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbGV0IHN0ciA9IGAke3RoaXMubmFtZX06ICR7dGhpcy5tZXNzYWdlfWA7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aGlzLnN0YWNrKSkgewogICAgICAgICAgc3RyICs9IGAKJHt0aGlzLnN0YWNrLnRvU3RyaW5nKCl9YDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgfTsKICAgICAgRGV2ZWxvcGVyRXJyb3IudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoCiAgICAgICAgICAiVGhpcyBmdW5jdGlvbiBkZWZpbmVzIGFuIGludGVyZmFjZSBhbmQgc2hvdWxkIG5vdCBiZSBjYWxsZWQgZGlyZWN0bHkuIgogICAgICAgICk7CiAgICAgIH07CiAgICAgIERldmVsb3BlckVycm9yX2RlZmF1bHQgPSBEZXZlbG9wZXJFcnJvcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NoZWNrLmpzCiAgZnVuY3Rpb24gZ2V0VW5kZWZpbmVkRXJyb3JNZXNzYWdlKG5hbWUpIHsKICAgIHJldHVybiBgJHtuYW1lfSBpcyByZXF1aXJlZCwgYWN0dWFsIHZhbHVlIHdhcyB1bmRlZmluZWRgOwogIH0KICBmdW5jdGlvbiBnZXRGYWlsZWRUeXBlRXJyb3JNZXNzYWdlKGFjdHVhbCwgZXhwZWN0ZWQsIG5hbWUpIHsKICAgIHJldHVybiBgRXhwZWN0ZWQgJHtuYW1lfSB0byBiZSB0eXBlb2YgJHtleHBlY3RlZH0sIGFjdHVhbCB0eXBlb2Ygd2FzICR7YWN0dWFsfWA7CiAgfQogIHZhciBDaGVjaywgQ2hlY2tfZGVmYXVsdDsKICB2YXIgaW5pdF9DaGVjayA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2hlY2suanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBDaGVjayA9IHt9OwogICAgICBDaGVjay50eXBlT2YgPSB7fTsKICAgICAgQ2hlY2suZGVmaW5lZCA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0ZXN0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoZ2V0VW5kZWZpbmVkRXJyb3JNZXNzYWdlKG5hbWUpKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrLnR5cGVPZi5mdW5jID0gZnVuY3Rpb24obmFtZSwgdGVzdCkgewogICAgICAgIGlmICh0eXBlb2YgdGVzdCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGdldEZhaWxlZFR5cGVFcnJvck1lc3NhZ2UodHlwZW9mIHRlc3QsICJmdW5jdGlvbiIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLnN0cmluZyA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgInN0cmluZyIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlciA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgIm51bWJlciIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlci5sZXNzVGhhbiA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA+PSBsaW1pdCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGBFeHBlY3RlZCAke25hbWV9IHRvIGJlIGxlc3MgdGhhbiAke2xpbWl0fSwgYWN0dWFsIHZhbHVlIHdhcyAke3Rlc3R9YAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrLnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscyA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA+IGxpbWl0KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYEV4cGVjdGVkICR7bmFtZX0gdG8gYmUgbGVzcyB0aGFuIG9yIGVxdWFsIHRvICR7bGltaXR9LCBhY3R1YWwgdmFsdWUgd2FzICR7dGVzdH1gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbiA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA8PSBsaW1pdCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGBFeHBlY3RlZCAke25hbWV9IHRvIGJlIGdyZWF0ZXIgdGhhbiAke2xpbWl0fSwgYWN0dWFsIHZhbHVlIHdhcyAke3Rlc3R9YAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrLnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscyA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QsIGxpbWl0KSB7CiAgICAgICAgQ2hlY2sudHlwZU9mLm51bWJlcihuYW1lLCB0ZXN0KTsKICAgICAgICBpZiAodGVzdCA8IGxpbWl0KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYEV4cGVjdGVkICR7bmFtZX0gdG8gYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvICR7bGltaXR9LCBhY3R1YWwgdmFsdWUgd2FzICR7dGVzdH1gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm9iamVjdCA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgIm9iamVjdCIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLmJvb2wgPSBmdW5jdGlvbihuYW1lLCB0ZXN0KSB7CiAgICAgICAgaWYgKHR5cGVvZiB0ZXN0ICE9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICBnZXRGYWlsZWRUeXBlRXJyb3JNZXNzYWdlKHR5cGVvZiB0ZXN0LCAiYm9vbGVhbiIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLmJpZ2ludCA9IGZ1bmN0aW9uKG5hbWUsIHRlc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHRlc3QgIT09ICJiaWdpbnQiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgZ2V0RmFpbGVkVHlwZUVycm9yTWVzc2FnZSh0eXBlb2YgdGVzdCwgImJpZ2ludCIsIG5hbWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ2hlY2sudHlwZU9mLm51bWJlci5lcXVhbHMgPSBmdW5jdGlvbihuYW1lMSwgbmFtZTIsIHRlc3QxLCB0ZXN0MikgewogICAgICAgIENoZWNrLnR5cGVPZi5udW1iZXIobmFtZTEsIHRlc3QxKTsKICAgICAgICBDaGVjay50eXBlT2YubnVtYmVyKG5hbWUyLCB0ZXN0Mik7CiAgICAgICAgaWYgKHRlc3QxICE9PSB0ZXN0MikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGAke25hbWUxfSBtdXN0IGJlIGVxdWFsIHRvICR7bmFtZTJ9LCB0aGUgYWN0dWFsIHZhbHVlcyBhcmUgJHt0ZXN0MX0gYW5kICR7dGVzdDJ9YAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENoZWNrX2RlZmF1bHQgPSBDaGVjazsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlZmF1bHRWYWx1ZS5qcwogIGZ1bmN0aW9uIGRlZmF1bHRWYWx1ZShhMywgYikgewogICAgaWYgKGEzICE9PSB2b2lkIDAgJiYgYTMgIT09IG51bGwpIHsKICAgICAgcmV0dXJuIGEzOwogICAgfQogICAgcmV0dXJuIGI7CiAgfQogIHZhciBkZWZhdWx0VmFsdWVfZGVmYXVsdDsKICB2YXIgaW5pdF9kZWZhdWx0VmFsdWUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlZmF1bHRWYWx1ZS5qcyIoKSB7CiAgICAgIGRlZmF1bHRWYWx1ZS5FTVBUWV9PQkpFQ1QgPSBPYmplY3QuZnJlZXplKHt9KTsKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQgPSBkZWZhdWx0VmFsdWU7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9tZXJzZW5uZS10d2lzdGVyL3NyYy9tZXJzZW5uZS10d2lzdGVyLmpzCiAgdmFyIHJlcXVpcmVfbWVyc2VubmVfdHdpc3RlciA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9tZXJzZW5uZS10d2lzdGVyL3NyYy9tZXJzZW5uZS10d2lzdGVyLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgIHZhciBNZXJzZW5uZVR3aXN0ZXIyID0gZnVuY3Rpb24oc2VlZCkgewogICAgICAgIGlmIChzZWVkID09IHZvaWQgMCkgewogICAgICAgICAgc2VlZCA9ICgvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSkuZ2V0VGltZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzLk4gPSA2MjQ7CiAgICAgICAgdGhpcy5NID0gMzk3OwogICAgICAgIHRoaXMuTUFUUklYX0EgPSAyNTY3NDgzNjE1OwogICAgICAgIHRoaXMuVVBQRVJfTUFTSyA9IDIxNDc0ODM2NDg7CiAgICAgICAgdGhpcy5MT1dFUl9NQVNLID0gMjE0NzQ4MzY0NzsKICAgICAgICB0aGlzLm10ID0gbmV3IEFycmF5KHRoaXMuTik7CiAgICAgICAgdGhpcy5tdGkgPSB0aGlzLk4gKyAxOwogICAgICAgIGlmIChzZWVkLmNvbnN0cnVjdG9yID09IEFycmF5KSB7CiAgICAgICAgICB0aGlzLmluaXRfYnlfYXJyYXkoc2VlZCwgc2VlZC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmluaXRfc2VlZChzZWVkKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIE1lcnNlbm5lVHdpc3RlcjIucHJvdG90eXBlLmluaXRfc2VlZCA9IGZ1bmN0aW9uKHMpIHsKICAgICAgICB0aGlzLm10WzBdID0gcyA+Pj4gMDsKICAgICAgICBmb3IgKHRoaXMubXRpID0gMTsgdGhpcy5tdGkgPCB0aGlzLk47IHRoaXMubXRpKyspIHsKICAgICAgICAgIHZhciBzID0gdGhpcy5tdFt0aGlzLm10aSAtIDFdIF4gdGhpcy5tdFt0aGlzLm10aSAtIDFdID4+PiAzMDsKICAgICAgICAgIHRoaXMubXRbdGhpcy5tdGldID0gKCgocyAmIDQyOTQ5MDE3NjApID4+PiAxNikgKiAxODEyNDMzMjUzIDw8IDE2KSArIChzICYgNjU1MzUpICogMTgxMjQzMzI1MyArIHRoaXMubXRpOwogICAgICAgICAgdGhpcy5tdFt0aGlzLm10aV0gPj4+PSAwOwogICAgICAgIH0KICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUuaW5pdF9ieV9hcnJheSA9IGZ1bmN0aW9uKGluaXRfa2V5LCBrZXlfbGVuZ3RoKSB7CiAgICAgICAgdmFyIGksIGosIGs7CiAgICAgICAgdGhpcy5pbml0X3NlZWQoMTk2NTAyMTgpOwogICAgICAgIGkgPSAxOwogICAgICAgIGogPSAwOwogICAgICAgIGsgPSB0aGlzLk4gPiBrZXlfbGVuZ3RoID8gdGhpcy5OIDoga2V5X2xlbmd0aDsKICAgICAgICBmb3IgKDsgazsgay0tKSB7CiAgICAgICAgICB2YXIgcyA9IHRoaXMubXRbaSAtIDFdIF4gdGhpcy5tdFtpIC0gMV0gPj4+IDMwOwogICAgICAgICAgdGhpcy5tdFtpXSA9ICh0aGlzLm10W2ldIF4gKCgocyAmIDQyOTQ5MDE3NjApID4+PiAxNikgKiAxNjY0NTI1IDw8IDE2KSArIChzICYgNjU1MzUpICogMTY2NDUyNSkgKyBpbml0X2tleVtqXSArIGo7CiAgICAgICAgICB0aGlzLm10W2ldID4+Pj0gMDsKICAgICAgICAgIGkrKzsKICAgICAgICAgIGorKzsKICAgICAgICAgIGlmIChpID49IHRoaXMuTikgewogICAgICAgICAgICB0aGlzLm10WzBdID0gdGhpcy5tdFt0aGlzLk4gLSAxXTsKICAgICAgICAgICAgaSA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaiA+PSBrZXlfbGVuZ3RoKSBqID0gMDsKICAgICAgICB9CiAgICAgICAgZm9yIChrID0gdGhpcy5OIC0gMTsgazsgay0tKSB7CiAgICAgICAgICB2YXIgcyA9IHRoaXMubXRbaSAtIDFdIF4gdGhpcy5tdFtpIC0gMV0gPj4+IDMwOwogICAgICAgICAgdGhpcy5tdFtpXSA9ICh0aGlzLm10W2ldIF4gKCgocyAmIDQyOTQ5MDE3NjApID4+PiAxNikgKiAxNTY2MDgzOTQxIDw8IDE2KSArIChzICYgNjU1MzUpICogMTU2NjA4Mzk0MSkgLSBpOwogICAgICAgICAgdGhpcy5tdFtpXSA+Pj49IDA7CiAgICAgICAgICBpKys7CiAgICAgICAgICBpZiAoaSA+PSB0aGlzLk4pIHsKICAgICAgICAgICAgdGhpcy5tdFswXSA9IHRoaXMubXRbdGhpcy5OIC0gMV07CiAgICAgICAgICAgIGkgPSAxOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLm10WzBdID0gMjE0NzQ4MzY0ODsKICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUucmFuZG9tX2ludCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB5OwogICAgICAgIHZhciBtYWcwMSA9IG5ldyBBcnJheSgwLCB0aGlzLk1BVFJJWF9BKTsKICAgICAgICBpZiAodGhpcy5tdGkgPj0gdGhpcy5OKSB7CiAgICAgICAgICB2YXIga2s7CiAgICAgICAgICBpZiAodGhpcy5tdGkgPT0gdGhpcy5OICsgMSkKICAgICAgICAgICAgdGhpcy5pbml0X3NlZWQoNTQ4OSk7CiAgICAgICAgICBmb3IgKGtrID0gMDsga2sgPCB0aGlzLk4gLSB0aGlzLk07IGtrKyspIHsKICAgICAgICAgICAgeSA9IHRoaXMubXRba2tdICYgdGhpcy5VUFBFUl9NQVNLIHwgdGhpcy5tdFtrayArIDFdICYgdGhpcy5MT1dFUl9NQVNLOwogICAgICAgICAgICB0aGlzLm10W2trXSA9IHRoaXMubXRba2sgKyB0aGlzLk1dIF4geSA+Pj4gMSBeIG1hZzAxW3kgJiAxXTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoOyBrayA8IHRoaXMuTiAtIDE7IGtrKyspIHsKICAgICAgICAgICAgeSA9IHRoaXMubXRba2tdICYgdGhpcy5VUFBFUl9NQVNLIHwgdGhpcy5tdFtrayArIDFdICYgdGhpcy5MT1dFUl9NQVNLOwogICAgICAgICAgICB0aGlzLm10W2trXSA9IHRoaXMubXRba2sgKyAodGhpcy5NIC0gdGhpcy5OKV0gXiB5ID4+PiAxIF4gbWFnMDFbeSAmIDFdOwogICAgICAgICAgfQogICAgICAgICAgeSA9IHRoaXMubXRbdGhpcy5OIC0gMV0gJiB0aGlzLlVQUEVSX01BU0sgfCB0aGlzLm10WzBdICYgdGhpcy5MT1dFUl9NQVNLOwogICAgICAgICAgdGhpcy5tdFt0aGlzLk4gLSAxXSA9IHRoaXMubXRbdGhpcy5NIC0gMV0gXiB5ID4+PiAxIF4gbWFnMDFbeSAmIDFdOwogICAgICAgICAgdGhpcy5tdGkgPSAwOwogICAgICAgIH0KICAgICAgICB5ID0gdGhpcy5tdFt0aGlzLm10aSsrXTsKICAgICAgICB5IF49IHkgPj4+IDExOwogICAgICAgIHkgXj0geSA8PCA3ICYgMjYzNjkyODY0MDsKICAgICAgICB5IF49IHkgPDwgMTUgJiA0MDIyNzMwNzUyOwogICAgICAgIHkgXj0geSA+Pj4gMTg7CiAgICAgICAgcmV0dXJuIHkgPj4+IDA7CiAgICAgIH07CiAgICAgIE1lcnNlbm5lVHdpc3RlcjIucHJvdG90eXBlLnJhbmRvbV9pbnQzMSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnJhbmRvbV9pbnQoKSA+Pj4gMTsKICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUucmFuZG9tX2luY2wgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5yYW5kb21faW50KCkgKiAoMSAvIDQyOTQ5NjcyOTUpOwogICAgICB9OwogICAgICBNZXJzZW5uZVR3aXN0ZXIyLnByb3RvdHlwZS5yYW5kb20gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5yYW5kb21faW50KCkgKiAoMSAvIDQyOTQ5NjcyOTYpOwogICAgICB9OwogICAgICBNZXJzZW5uZVR3aXN0ZXIyLnByb3RvdHlwZS5yYW5kb21fZXhjbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAodGhpcy5yYW5kb21faW50KCkgKyAwLjUpICogKDEgLyA0Mjk0OTY3Mjk2KTsKICAgICAgfTsKICAgICAgTWVyc2VubmVUd2lzdGVyMi5wcm90b3R5cGUucmFuZG9tX2xvbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYTMgPSB0aGlzLnJhbmRvbV9pbnQoKSA+Pj4gNSwgYiA9IHRoaXMucmFuZG9tX2ludCgpID4+PiA2OwogICAgICAgIHJldHVybiAoYTMgKiA2NzEwODg2NCArIGIpICogKDEgLyA5MDA3MTk5MjU0NzQwOTkyKTsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBNZXJzZW5uZVR3aXN0ZXIyOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvTWF0aC5qcwogIHZhciBpbXBvcnRfbWVyc2VubmVfdHdpc3RlciwgQ2VzaXVtTWF0aCwgZmFjdG9yaWFscywgcmFuZG9tTnVtYmVyR2VuZXJhdG9yLCBNYXRoX2RlZmF1bHQ7CiAgdmFyIGluaXRfTWF0aCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvTWF0aC5qcyIoKSB7CiAgICAgIGltcG9ydF9tZXJzZW5uZV90d2lzdGVyID0gX190b0VTTShyZXF1aXJlX21lcnNlbm5lX3R3aXN0ZXIoKSwgMSk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgQ2VzaXVtTWF0aCA9IHt9OwogICAgICBDZXNpdW1NYXRoLkVQU0lMT04xID0gMC4xOwogICAgICBDZXNpdW1NYXRoLkVQU0lMT04yID0gMC4wMTsKICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9OMyA9IDFlLTM7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjQgPSAxZS00OwogICAgICBDZXNpdW1NYXRoLkVQU0lMT041ID0gMWUtNTsKICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9ONiA9IDFlLTY7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjcgPSAxZS03OwogICAgICBDZXNpdW1NYXRoLkVQU0lMT044ID0gMWUtODsKICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9OOSA9IDFlLTk7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjEwID0gMWUtMTA7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjExID0gMWUtMTE7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjEyID0gMWUtMTI7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjEzID0gMWUtMTM7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE0ID0gMWUtMTQ7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE1ID0gMWUtMTU7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE2ID0gMWUtMTY7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE3ID0gMWUtMTc7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE4ID0gMWUtMTg7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjE5ID0gMWUtMTk7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjIwID0gMWUtMjA7CiAgICAgIENlc2l1bU1hdGguRVBTSUxPTjIxID0gMWUtMjE7CiAgICAgIENlc2l1bU1hdGguR1JBVklUQVRJT05BTFBBUkFNRVRFUiA9IDM5ODYwMDQ0MThlNTsKICAgICAgQ2VzaXVtTWF0aC5TT0xBUl9SQURJVVMgPSA2OTU1ZTU7CiAgICAgIENlc2l1bU1hdGguTFVOQVJfUkFESVVTID0gMTczNzQwMDsKICAgICAgQ2VzaXVtTWF0aC5TSVhUWV9GT1VSX0tJTE9CWVRFUyA9IDY0ICogMTAyNDsKICAgICAgQ2VzaXVtTWF0aC5GT1VSX0dJR0FCWVRFUyA9IDQgKiAxMDI0ICogMTAyNCAqIDEwMjQ7CiAgICAgIENlc2l1bU1hdGguc2lnbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KE1hdGguc2lnbiwgZnVuY3Rpb24gc2lnbih2YWx1ZSkgewogICAgICAgIHZhbHVlID0gK3ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gMCB8fCB2YWx1ZSAhPT0gdmFsdWUpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlID4gMCA/IDEgOiAtMTsKICAgICAgfSk7CiAgICAgIENlc2l1bU1hdGguc2lnbk5vdFplcm8gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSA8IDAgPyAtMSA6IDE7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgudG9TTm9ybSA9IGZ1bmN0aW9uKHZhbHVlLCByYW5nZU1heGltdW0pIHsKICAgICAgICByYW5nZU1heGltdW0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChyYW5nZU1heGltdW0sIDI1NSk7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoCiAgICAgICAgICAoQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgLTEsIDEpICogMC41ICsgMC41KSAqIHJhbmdlTWF4aW11bQogICAgICAgICk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguZnJvbVNOb3JtID0gZnVuY3Rpb24odmFsdWUsIHJhbmdlTWF4aW11bSkgewogICAgICAgIHJhbmdlTWF4aW11bSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHJhbmdlTWF4aW11bSwgMjU1KTsKICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgMCwgcmFuZ2VNYXhpbXVtKSAvIHJhbmdlTWF4aW11bSAqIDIgLSAxOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uKHZhbHVlLCByYW5nZU1pbmltdW0sIHJhbmdlTWF4aW11bSkgewogICAgICAgIHJhbmdlTWF4aW11bSA9IE1hdGgubWF4KHJhbmdlTWF4aW11bSAtIHJhbmdlTWluaW11bSwgMCk7CiAgICAgICAgcmV0dXJuIHJhbmdlTWF4aW11bSA9PT0gMCA/IDAgOiBDZXNpdW1NYXRoLmNsYW1wKCh2YWx1ZSAtIHJhbmdlTWluaW11bSkgLyByYW5nZU1heGltdW0sIDAsIDEpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLnNpbmggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChNYXRoLnNpbmgsIGZ1bmN0aW9uIHNpbmgodmFsdWUpIHsKICAgICAgICByZXR1cm4gKE1hdGguZXhwKHZhbHVlKSAtIE1hdGguZXhwKC12YWx1ZSkpIC8gMjsKICAgICAgfSk7CiAgICAgIENlc2l1bU1hdGguY29zaCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KE1hdGguY29zaCwgZnVuY3Rpb24gY29zaCh2YWx1ZSkgewogICAgICAgIHJldHVybiAoTWF0aC5leHAodmFsdWUpICsgTWF0aC5leHAoLXZhbHVlKSkgLyAyOwogICAgICB9KTsKICAgICAgQ2VzaXVtTWF0aC5sZXJwID0gZnVuY3Rpb24ocCwgcSwgdGltZSkgewogICAgICAgIHJldHVybiAoMSAtIHRpbWUpICogcCArIHRpbWUgKiBxOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLlBJID0gTWF0aC5QSTsKICAgICAgQ2VzaXVtTWF0aC5PTkVfT1ZFUl9QSSA9IDEgLyBNYXRoLlBJOwogICAgICBDZXNpdW1NYXRoLlBJX09WRVJfVFdPID0gTWF0aC5QSSAvIDI7CiAgICAgIENlc2l1bU1hdGguUElfT1ZFUl9USFJFRSA9IE1hdGguUEkgLyAzOwogICAgICBDZXNpdW1NYXRoLlBJX09WRVJfRk9VUiA9IE1hdGguUEkgLyA0OwogICAgICBDZXNpdW1NYXRoLlBJX09WRVJfU0lYID0gTWF0aC5QSSAvIDY7CiAgICAgIENlc2l1bU1hdGguVEhSRUVfUElfT1ZFUl9UV08gPSAzICogTWF0aC5QSSAvIDI7CiAgICAgIENlc2l1bU1hdGguVFdPX1BJID0gMiAqIE1hdGguUEk7CiAgICAgIENlc2l1bU1hdGguT05FX09WRVJfVFdPX1BJID0gMSAvICgyICogTWF0aC5QSSk7CiAgICAgIENlc2l1bU1hdGguUkFESUFOU19QRVJfREVHUkVFID0gTWF0aC5QSSAvIDE4MDsKICAgICAgQ2VzaXVtTWF0aC5ERUdSRUVTX1BFUl9SQURJQU4gPSAxODAgLyBNYXRoLlBJOwogICAgICBDZXNpdW1NYXRoLlJBRElBTlNfUEVSX0FSQ1NFQ09ORCA9IENlc2l1bU1hdGguUkFESUFOU19QRVJfREVHUkVFIC8gMzYwMDsKICAgICAgQ2VzaXVtTWF0aC50b1JhZGlhbnMgPSBmdW5jdGlvbihkZWdyZWVzKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGVncmVlcykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkZWdyZWVzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVncmVlcyAqIENlc2l1bU1hdGguUkFESUFOU19QRVJfREVHUkVFOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLnRvRGVncmVlcyA9IGZ1bmN0aW9uKHJhZGlhbnMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyYWRpYW5zKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJhZGlhbnMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiByYWRpYW5zICogQ2VzaXVtTWF0aC5ERUdSRUVTX1BFUl9SQURJQU47CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguY29udmVydExvbmdpdHVkZVJhbmdlID0gZnVuY3Rpb24oYW5nbGUpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhbmdsZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhbmdsZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdHdvUGkgPSBDZXNpdW1NYXRoLlRXT19QSTsKICAgICAgICBjb25zdCBzaW1wbGlmaWVkID0gYW5nbGUgLSBNYXRoLmZsb29yKGFuZ2xlIC8gdHdvUGkpICogdHdvUGk7CiAgICAgICAgaWYgKHNpbXBsaWZpZWQgPCAtTWF0aC5QSSkgewogICAgICAgICAgcmV0dXJuIHNpbXBsaWZpZWQgKyB0d29QaTsKICAgICAgICB9CiAgICAgICAgaWYgKHNpbXBsaWZpZWQgPj0gTWF0aC5QSSkgewogICAgICAgICAgcmV0dXJuIHNpbXBsaWZpZWQgLSB0d29QaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNpbXBsaWZpZWQ7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguY2xhbXBUb0xhdGl0dWRlUmFuZ2UgPSBmdW5jdGlvbihhbmdsZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFuZ2xlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFuZ2xlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC5jbGFtcCgKICAgICAgICAgIGFuZ2xlLAogICAgICAgICAgLTEgKiBDZXNpdW1NYXRoLlBJX09WRVJfVFdPLAogICAgICAgICAgQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTwogICAgICAgICk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubmVnYXRpdmVQaVRvUGkgPSBmdW5jdGlvbihhbmdsZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFuZ2xlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFuZ2xlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoYW5nbGUgPj0gLUNlc2l1bU1hdGguUEkgJiYgYW5nbGUgPD0gQ2VzaXVtTWF0aC5QSSkgewogICAgICAgICAgcmV0dXJuIGFuZ2xlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC56ZXJvVG9Ud29QaShhbmdsZSArIENlc2l1bU1hdGguUEkpIC0gQ2VzaXVtTWF0aC5QSTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC56ZXJvVG9Ud29QaSA9IGZ1bmN0aW9uKGFuZ2xlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYW5nbGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYW5nbGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChhbmdsZSA+PSAwICYmIGFuZ2xlIDw9IENlc2l1bU1hdGguVFdPX1BJKSB7CiAgICAgICAgICByZXR1cm4gYW5nbGU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1vZCA9IENlc2l1bU1hdGgubW9kKGFuZ2xlLCBDZXNpdW1NYXRoLlRXT19QSSk7CiAgICAgICAgaWYgKE1hdGguYWJzKG1vZCkgPCBDZXNpdW1NYXRoLkVQU0lMT04xNCAmJiBNYXRoLmFicyhhbmdsZSkgPiBDZXNpdW1NYXRoLkVQU0lMT04xNCkgewogICAgICAgICAgcmV0dXJuIENlc2l1bU1hdGguVFdPX1BJOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbW9kOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLm1vZCA9IGZ1bmN0aW9uKG0sIG4pIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm0gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG4pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG4gPT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkaXZpc29yIGNhbm5vdCBiZSAwLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoQ2VzaXVtTWF0aC5zaWduKG0pID09PSBDZXNpdW1NYXRoLnNpZ24obikgJiYgTWF0aC5hYnMobSkgPCBNYXRoLmFicyhuKSkgewogICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgfQogICAgICAgIHJldHVybiAobSAlIG4gKyBuKSAlIG47CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlZnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibGVmdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmlnaHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJlbGF0aXZlRXBzaWxvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHJlbGF0aXZlRXBzaWxvbiwgMCk7CiAgICAgICAgYWJzb2x1dGVFcHNpbG9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoYWJzb2x1dGVFcHNpbG9uLCByZWxhdGl2ZUVwc2lsb24pOwogICAgICAgIGNvbnN0IGFic0RpZmYgPSBNYXRoLmFicyhsZWZ0IC0gcmlnaHQpOwogICAgICAgIHJldHVybiBhYnNEaWZmIDw9IGFic29sdXRlRXBzaWxvbiB8fCBhYnNEaWZmIDw9IHJlbGF0aXZlRXBzaWxvbiAqIE1hdGgubWF4KE1hdGguYWJzKGxlZnQpLCBNYXRoLmFicyhyaWdodCkpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmxlc3NUaGFuID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlZnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZmlyc3QgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInNlY29uZCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYWJzb2x1dGVFcHNpbG9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFic29sdXRlRXBzaWxvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxlZnQgLSByaWdodCA8IC1hYnNvbHV0ZUVwc2lsb247CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubGVzc1RoYW5PckVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChsZWZ0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImZpcnN0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyaWdodCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzZWNvbmQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFic29sdXRlRXBzaWxvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhYnNvbHV0ZUVwc2lsb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBsZWZ0IC0gcmlnaHQgPCBhYnNvbHV0ZUVwc2lsb247CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguZ3JlYXRlclRoYW4gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVmdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJmaXJzdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2Vjb25kIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhYnNvbHV0ZUVwc2lsb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYWJzb2x1dGVFcHNpbG9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbGVmdCAtIHJpZ2h0ID4gYWJzb2x1dGVFcHNpbG9uOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmdyZWF0ZXJUaGFuT3JFcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobGVmdCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJmaXJzdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2Vjb25kIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhYnNvbHV0ZUVwc2lsb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYWJzb2x1dGVFcHNpbG9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbGVmdCAtIHJpZ2h0ID4gLWFic29sdXRlRXBzaWxvbjsKICAgICAgfTsKICAgICAgZmFjdG9yaWFscyA9IFsxXTsKICAgICAgQ2VzaXVtTWF0aC5mYWN0b3JpYWwgPSBmdW5jdGlvbihuKSB7CiAgICAgICAgaWYgKHR5cGVvZiBuICE9PSAibnVtYmVyIiB8fCBuIDwgMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJBIG51bWJlciBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gMCBpcyByZXF1aXJlZC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBmYWN0b3JpYWxzLmxlbmd0aDsKICAgICAgICBpZiAobiA+PSBsZW5ndGgpIHsKICAgICAgICAgIGxldCBzdW0gPSBmYWN0b3JpYWxzW2xlbmd0aCAtIDFdOwogICAgICAgICAgZm9yIChsZXQgaSA9IGxlbmd0aDsgaSA8PSBuOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgbmV4dCA9IHN1bSAqIGk7CiAgICAgICAgICAgIGZhY3RvcmlhbHMucHVzaChuZXh0KTsKICAgICAgICAgICAgc3VtID0gbmV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhY3RvcmlhbHNbbl07CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGguaW5jcmVtZW50V3JhcCA9IGZ1bmN0aW9uKG4sIG1heGltdW1WYWx1ZSwgbWluaW11bVZhbHVlKSB7CiAgICAgICAgbWluaW11bVZhbHVlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobWluaW11bVZhbHVlLCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChuKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm4gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChtYXhpbXVtVmFsdWUgPD0gbWluaW11bVZhbHVlKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibWF4aW11bVZhbHVlIG11c3QgYmUgZ3JlYXRlciB0aGFuIG1pbmltdW1WYWx1ZS4iKTsKICAgICAgICB9CiAgICAgICAgKytuOwogICAgICAgIGlmIChuID4gbWF4aW11bVZhbHVlKSB7CiAgICAgICAgICBuID0gbWluaW11bVZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbjsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5pc1Bvd2VyT2ZUd28gPSBmdW5jdGlvbihuKSB7CiAgICAgICAgaWYgKHR5cGVvZiBuICE9PSAibnVtYmVyIiB8fCBuIDwgMCB8fCBuID4gNDI5NDk2NzI5NSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIkEgbnVtYmVyIGJldHdlZW4gMCBhbmQgKDJeMzIpLTEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuICE9PSAwICYmIChuICYgbiAtIDEpID09PSAwOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLm5leHRQb3dlck9mVHdvID0gZnVuY3Rpb24obikgewogICAgICAgIGlmICh0eXBlb2YgbiAhPT0gIm51bWJlciIgfHwgbiA8IDAgfHwgbiA+IDIxNDc0ODM2NDgpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJBIG51bWJlciBiZXR3ZWVuIDAgYW5kIDJeMzEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIC0tbjsKICAgICAgICBuIHw9IG4gPj4gMTsKICAgICAgICBuIHw9IG4gPj4gMjsKICAgICAgICBuIHw9IG4gPj4gNDsKICAgICAgICBuIHw9IG4gPj4gODsKICAgICAgICBuIHw9IG4gPj4gMTY7CiAgICAgICAgKytuOwogICAgICAgIHJldHVybiBuOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLnByZXZpb3VzUG93ZXJPZlR3byA9IGZ1bmN0aW9uKG4pIHsKICAgICAgICBpZiAodHlwZW9mIG4gIT09ICJudW1iZXIiIHx8IG4gPCAwIHx8IG4gPiA0Mjk0OTY3Mjk1KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiQSBudW1iZXIgYmV0d2VlbiAwIGFuZCAoMl4zMiktMSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgbiB8PSBuID4+IDE7CiAgICAgICAgbiB8PSBuID4+IDI7CiAgICAgICAgbiB8PSBuID4+IDQ7CiAgICAgICAgbiB8PSBuID4+IDg7CiAgICAgICAgbiB8PSBuID4+IDE2OwogICAgICAgIG4gfD0gbiA+PiAzMjsKICAgICAgICBuID0gKG4gPj4+IDApIC0gKG4gPj4+IDEpOwogICAgICAgIHJldHVybiBuOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmNsYW1wID0gZnVuY3Rpb24odmFsdWUsIG1pbjMsIG1heDMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibWluIiwgbWluMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJtYXgiLCBtYXgzKTsKICAgICAgICByZXR1cm4gdmFsdWUgPCBtaW4zID8gbWluMyA6IHZhbHVlID4gbWF4MyA/IG1heDMgOiB2YWx1ZTsKICAgICAgfTsKICAgICAgcmFuZG9tTnVtYmVyR2VuZXJhdG9yID0gbmV3IGltcG9ydF9tZXJzZW5uZV90d2lzdGVyLmRlZmF1bHQoKTsKICAgICAgQ2VzaXVtTWF0aC5zZXRSYW5kb21OdW1iZXJTZWVkID0gZnVuY3Rpb24oc2VlZCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNlZWQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2VlZCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmFuZG9tTnVtYmVyR2VuZXJhdG9yID0gbmV3IGltcG9ydF9tZXJzZW5uZV90d2lzdGVyLmRlZmF1bHQoc2VlZCk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubmV4dFJhbmRvbU51bWJlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiByYW5kb21OdW1iZXJHZW5lcmF0b3IucmFuZG9tKCk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgucmFuZG9tQmV0d2VlbiA9IGZ1bmN0aW9uKG1pbjMsIG1heDMpIHsKICAgICAgICByZXR1cm4gQ2VzaXVtTWF0aC5uZXh0UmFuZG9tTnVtYmVyKCkgKiAobWF4MyAtIG1pbjMpICsgbWluMzsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5hY29zQ2xhbXBlZCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRoLmFjb3MoQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgLTEsIDEpKTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5hc2luQ2xhbXBlZCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRoLmFzaW4oQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgLTEsIDEpKTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5jaG9yZExlbmd0aCA9IGZ1bmN0aW9uKGFuZ2xlLCByYWRpdXMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhbmdsZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhbmdsZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmFkaXVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJhZGl1cyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDIgKiByYWRpdXMgKiBNYXRoLnNpbihhbmdsZSAqIDAuNSk7CiAgICAgIH07CiAgICAgIENlc2l1bU1hdGgubG9nQmFzZSA9IGZ1bmN0aW9uKG51bWJlciwgYmFzZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG51bWJlcikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJudW1iZXIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJhc2UpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYmFzZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE1hdGgubG9nKG51bWJlcikgLyBNYXRoLmxvZyhiYXNlKTsKICAgICAgfTsKICAgICAgQ2VzaXVtTWF0aC5jYnJ0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoTWF0aC5jYnJ0LCBmdW5jdGlvbiBjYnJ0KG51bWJlcikgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IE1hdGgucG93KE1hdGguYWJzKG51bWJlciksIDEgLyAzKTsKICAgICAgICByZXR1cm4gbnVtYmVyIDwgMCA/IC1yZXN1bHQgOiByZXN1bHQ7CiAgICAgIH0pOwogICAgICBDZXNpdW1NYXRoLmxvZzIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChNYXRoLmxvZzIsIGZ1bmN0aW9uIGxvZzIobnVtYmVyKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubG9nKG51bWJlcikgKiBNYXRoLkxPRzJFOwogICAgICB9KTsKICAgICAgQ2VzaXVtTWF0aC5mb2cgPSBmdW5jdGlvbihkaXN0YW5jZVRvQ2FtZXJhLCBkZW5zaXR5KSB7CiAgICAgICAgY29uc3Qgc2NhbGFyID0gZGlzdGFuY2VUb0NhbWVyYSAqIGRlbnNpdHk7CiAgICAgICAgcmV0dXJuIDEgLSBNYXRoLmV4cCgtKHNjYWxhciAqIHNjYWxhcikpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmZhc3RBcHByb3hpbWF0ZUF0YW4gPSBmdW5jdGlvbih4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ4IiwgeCk7CiAgICAgICAgcmV0dXJuIHggKiAoLTAuMTc4NCAqIE1hdGguYWJzKHgpIC0gMC4wNjYzICogeCAqIHggKyAxLjAzMDEpOwogICAgICB9OwogICAgICBDZXNpdW1NYXRoLmZhc3RBcHByb3hpbWF0ZUF0YW4yID0gZnVuY3Rpb24oeCwgeSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieCIsIHgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieSIsIHkpOwogICAgICAgIGxldCBvcHBvc2l0ZTsKICAgICAgICBsZXQgdCA9IE1hdGguYWJzKHgpOwogICAgICAgIG9wcG9zaXRlID0gTWF0aC5hYnMoeSk7CiAgICAgICAgY29uc3QgYWRqYWNlbnQgPSBNYXRoLm1heCh0LCBvcHBvc2l0ZSk7CiAgICAgICAgb3Bwb3NpdGUgPSBNYXRoLm1pbih0LCBvcHBvc2l0ZSk7CiAgICAgICAgY29uc3Qgb3Bwb3NpdGVPdmVyQWRqYWNlbnQgPSBvcHBvc2l0ZSAvIGFkamFjZW50OwogICAgICAgIGlmIChpc05hTihvcHBvc2l0ZU92ZXJBZGphY2VudCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJlaXRoZXIgeCBvciB5IG11c3QgYmUgbm9uemVybyIpOwogICAgICAgIH0KICAgICAgICB0ID0gQ2VzaXVtTWF0aC5mYXN0QXBwcm94aW1hdGVBdGFuKG9wcG9zaXRlT3ZlckFkamFjZW50KTsKICAgICAgICB0ID0gTWF0aC5hYnMoeSkgPiBNYXRoLmFicyh4KSA/IENlc2l1bU1hdGguUElfT1ZFUl9UV08gLSB0IDogdDsKICAgICAgICB0ID0geCA8IDAgPyBDZXNpdW1NYXRoLlBJIC0gdCA6IHQ7CiAgICAgICAgdCA9IHkgPCAwID8gLXQgOiB0OwogICAgICAgIHJldHVybiB0OwogICAgICB9OwogICAgICBNYXRoX2RlZmF1bHQgPSBDZXNpdW1NYXRoOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydGVzaWFuMy5qcwogIGZ1bmN0aW9uIENhcnRlc2lhbjMoeCwgeSwgeikgewogICAgdGhpcy54ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB0aGlzLnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5LCAwKTsKICAgIHRoaXMueiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogIH0KICB2YXIgZGlzdGFuY2VTY3JhdGNoLCBsZXJwU2NyYXRjaCwgYW5nbGVCZXR3ZWVuU2NyYXRjaCwgYW5nbGVCZXR3ZWVuU2NyYXRjaDIsIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2gsIHNjcmF0Y2hOLCBzY3JhdGNoSywgd2dzODRSYWRpaVNxdWFyZWQsIENhcnRlc2lhbjNfZGVmYXVsdDsKICB2YXIgaW5pdF9DYXJ0ZXNpYW4zID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DYXJ0ZXNpYW4zLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgQ2FydGVzaWFuMy5mcm9tU3BoZXJpY2FsID0gZnVuY3Rpb24oc3BoZXJpY2FsLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNwaGVyaWNhbCIsIHNwaGVyaWNhbCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2xvY2sgPSBzcGhlcmljYWwuY2xvY2s7CiAgICAgICAgY29uc3QgY29uZSA9IHNwaGVyaWNhbC5jb25lOwogICAgICAgIGNvbnN0IG1hZ25pdHVkZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHNwaGVyaWNhbC5tYWduaXR1ZGUsIDEpOwogICAgICAgIGNvbnN0IHJhZGlhbCA9IG1hZ25pdHVkZSAqIE1hdGguc2luKGNvbmUpOwogICAgICAgIHJlc3VsdC54ID0gcmFkaWFsICogTWF0aC5jb3MoY2xvY2spOwogICAgICAgIHJlc3VsdC55ID0gcmFkaWFsICogTWF0aC5zaW4oY2xvY2spOwogICAgICAgIHJlc3VsdC56ID0gbWFnbml0dWRlICogTWF0aC5jb3MoY29uZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5mcm9tRWxlbWVudHMgPSBmdW5jdGlvbih4LCB5LCB6LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjMoeCwgeSwgeik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuY2xvbmUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydGVzaWFuMTEpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjMoY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSwgY2FydGVzaWFuMTEueik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gY2FydGVzaWFuMTEueDsKICAgICAgICByZXN1bHQueSA9IGNhcnRlc2lhbjExLnk7CiAgICAgICAgcmVzdWx0LnogPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZnJvbUNhcnRlc2lhbjQgPSBDYXJ0ZXNpYW4zLmNsb25lOwogICAgICBDYXJ0ZXNpYW4zLnBhY2tlZExlbmd0aCA9IDM7CiAgICAgIENhcnRlc2lhbjMucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLng7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS56OwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC55ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQueiA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMucGFja0FycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgICAgIGNvbnN0IHJlc3VsdExlbmd0aCA9IGxlbmd0aCAqIDM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KHJlc3VsdExlbmd0aCk7CiAgICAgICAgfSBlbHNlIGlmICghQXJyYXkuaXNBcnJheShyZXN1bHQpICYmIHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJJZiByZXN1bHQgaXMgYSB0eXBlZCBhcnJheSwgaXQgbXVzdCBoYXZlIGV4YWN0bHkgYXJyYXkubGVuZ3RoICogMyBlbGVtZW50cyIKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQubGVuZ3RoICE9PSByZXN1bHRMZW5ndGgpIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSByZXN1bHRMZW5ndGg7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIENhcnRlc2lhbjMucGFjayhhcnJheVtpXSwgcmVzdWx0LCBpICogMyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMudW5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiYXJyYXkubGVuZ3RoIiwgYXJyYXkubGVuZ3RoLCAzKTsKICAgICAgICBpZiAoYXJyYXkubGVuZ3RoICUgMyAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMy4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGggLyAzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aCAvIDM7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IGluZGV4ID0gaSAvIDM7CiAgICAgICAgICByZXN1bHRbaW5kZXhdID0gQ2FydGVzaWFuMy51bnBhY2soYXJyYXksIGksIHJlc3VsdFtpbmRleF0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmZyb21BcnJheSA9IENhcnRlc2lhbjMudW5wYWNrOwogICAgICBDYXJ0ZXNpYW4zLm1heGltdW1Db21wb25lbnQgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIHJldHVybiBNYXRoLm1heChjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55LCBjYXJ0ZXNpYW4xMS56KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5taW5pbXVtQ29tcG9uZW50ID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICByZXR1cm4gTWF0aC5taW4oY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSwgY2FydGVzaWFuMTEueik7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubWluaW11bUJ5Q29tcG9uZW50ID0gZnVuY3Rpb24oZmlyc3QsIHNlY29uZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJmaXJzdCIsIGZpcnN0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNlY29uZCIsIHNlY29uZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gTWF0aC5taW4oZmlyc3QueCwgc2Vjb25kLngpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aC5taW4oZmlyc3QueSwgc2Vjb25kLnkpOwogICAgICAgIHJlc3VsdC56ID0gTWF0aC5taW4oZmlyc3Queiwgc2Vjb25kLnopOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubWF4aW11bUJ5Q29tcG9uZW50ID0gZnVuY3Rpb24oZmlyc3QsIHNlY29uZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJmaXJzdCIsIGZpcnN0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNlY29uZCIsIHNlY29uZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gTWF0aC5tYXgoZmlyc3QueCwgc2Vjb25kLngpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aC5tYXgoZmlyc3QueSwgc2Vjb25kLnkpOwogICAgICAgIHJlc3VsdC56ID0gTWF0aC5tYXgoZmlyc3Queiwgc2Vjb25kLnopOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuY2xhbXAgPSBmdW5jdGlvbih2YWx1ZSwgbWluMywgbWF4MywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1pbiIsIG1pbjMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF4IiwgbWF4Myk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBNYXRoX2RlZmF1bHQuY2xhbXAodmFsdWUueCwgbWluMy54LCBtYXgzLngpOwogICAgICAgIGNvbnN0IHkgPSBNYXRoX2RlZmF1bHQuY2xhbXAodmFsdWUueSwgbWluMy55LCBtYXgzLnkpOwogICAgICAgIGNvbnN0IHogPSBNYXRoX2RlZmF1bHQuY2xhbXAodmFsdWUueiwgbWluMy56LCBtYXgzLnopOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubWFnbml0dWRlU3F1YXJlZCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggKiBjYXJ0ZXNpYW4xMS54ICsgY2FydGVzaWFuMTEueSAqIGNhcnRlc2lhbjExLnkgKyBjYXJ0ZXNpYW4xMS56ICogY2FydGVzaWFuMTEuejsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5tYWduaXR1ZGUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSkgewogICAgICAgIHJldHVybiBNYXRoLnNxcnQoQ2FydGVzaWFuMy5tYWduaXR1ZGVTcXVhcmVkKGNhcnRlc2lhbjExKSk7CiAgICAgIH07CiAgICAgIGRpc3RhbmNlU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zKCk7CiAgICAgIENhcnRlc2lhbjMuZGlzdGFuY2UgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuMy5zdWJ0cmFjdChsZWZ0LCByaWdodCwgZGlzdGFuY2VTY3JhdGNoKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5tYWduaXR1ZGUoZGlzdGFuY2VTY3JhdGNoKTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5kaXN0YW5jZVNxdWFyZWQgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuMy5zdWJ0cmFjdChsZWZ0LCByaWdodCwgZGlzdGFuY2VTY3JhdGNoKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5tYWduaXR1ZGVTcXVhcmVkKGRpc3RhbmNlU2NyYXRjaCk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubm9ybWFsaXplID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBtYWduaXR1ZGUgPSBDYXJ0ZXNpYW4zLm1hZ25pdHVkZShjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54IC8gbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAvIG1hZ25pdHVkZTsKICAgICAgICByZXN1bHQueiA9IGNhcnRlc2lhbjExLnogLyBtYWduaXR1ZGU7CiAgICAgICAgaWYgKGlzTmFOKHJlc3VsdC54KSB8fCBpc05hTihyZXN1bHQueSkgfHwgaXNOYU4ocmVzdWx0LnopKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibm9ybWFsaXplZCByZXN1bHQgaXMgbm90IGEgbnVtYmVyIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZG90ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIHJldHVybiBsZWZ0LnggKiByaWdodC54ICsgbGVmdC55ICogcmlnaHQueSArIGxlZnQueiAqIHJpZ2h0Lno7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubXVsdGlwbHlDb21wb25lbnRzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54ICogcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSAqIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogKiByaWdodC56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZGl2aWRlQ29tcG9uZW50cyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAvIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgLyByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56IC8gcmlnaHQuejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmFkZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCArIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgKyByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56ICsgcmlnaHQuejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLnN1YnRyYWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54IC0gcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSAtIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogLSByaWdodC56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMubXVsdGlwbHlCeVNjYWxhciA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAqIHNjYWxhcjsKICAgICAgICByZXN1bHQueiA9IGNhcnRlc2lhbjExLnogKiBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5kaXZpZGVCeVNjYWxhciA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54IC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAvIHNjYWxhcjsKICAgICAgICByZXN1bHQueiA9IGNhcnRlc2lhbjExLnogLyBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5uZWdhdGUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gLWNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0LnkgPSAtY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHQueiA9IC1jYXJ0ZXNpYW4xMS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuYWJzID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGguYWJzKGNhcnRlc2lhbjExLngpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aC5hYnMoY2FydGVzaWFuMTEueSk7CiAgICAgICAgcmVzdWx0LnogPSBNYXRoLmFicyhjYXJ0ZXNpYW4xMS56KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBsZXJwU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zKCk7CiAgICAgIENhcnRlc2lhbjMubGVycCA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3RhcnQiLCBzdGFydCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbmQiLCBlbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBDYXJ0ZXNpYW4zLm11bHRpcGx5QnlTY2FsYXIoZW5kLCB0LCBsZXJwU2NyYXRjaCk7CiAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuMy5tdWx0aXBseUJ5U2NhbGFyKHN0YXJ0LCAxIC0gdCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5hZGQobGVycFNjcmF0Y2gsIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zKCk7CiAgICAgIGFuZ2xlQmV0d2VlblNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgQ2FydGVzaWFuMy5hbmdsZUJldHdlZW4gPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuMy5ub3JtYWxpemUobGVmdCwgYW5nbGVCZXR3ZWVuU2NyYXRjaCk7CiAgICAgICAgQ2FydGVzaWFuMy5ub3JtYWxpemUocmlnaHQsIGFuZ2xlQmV0d2VlblNjcmF0Y2gyKTsKICAgICAgICBjb25zdCBjb3NpbmUgPSBDYXJ0ZXNpYW4zLmRvdChhbmdsZUJldHdlZW5TY3JhdGNoLCBhbmdsZUJldHdlZW5TY3JhdGNoMik7CiAgICAgICAgY29uc3Qgc2luZSA9IENhcnRlc2lhbjMubWFnbml0dWRlKAogICAgICAgICAgQ2FydGVzaWFuMy5jcm9zcygKICAgICAgICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaCwKICAgICAgICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaDIsCiAgICAgICAgICAgIGFuZ2xlQmV0d2VlblNjcmF0Y2gKICAgICAgICAgICkKICAgICAgICApOwogICAgICAgIHJldHVybiBNYXRoLmF0YW4yKHNpbmUsIGNvc2luZSk7CiAgICAgIH07CiAgICAgIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMygpOwogICAgICBDYXJ0ZXNpYW4zLm1vc3RPcnRob2dvbmFsQXhpcyA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZiA9IENhcnRlc2lhbjMubm9ybWFsaXplKGNhcnRlc2lhbjExLCBtb3N0T3J0aG9nb25hbEF4aXNTY3JhdGNoKTsKICAgICAgICBDYXJ0ZXNpYW4zLmFicyhmLCBmKTsKICAgICAgICBpZiAoZi54IDw9IGYueSkgewogICAgICAgICAgaWYgKGYueCA8PSBmLnopIHsKICAgICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuMy5jbG9uZShDYXJ0ZXNpYW4zLlVOSVRfWCwgcmVzdWx0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjMuY2xvbmUoQ2FydGVzaWFuMy5VTklUX1osIHJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChmLnkgPD0gZi56KSB7CiAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zLmNsb25lKENhcnRlc2lhbjMuVU5JVF9ZLCByZXN1bHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zLmNsb25lKENhcnRlc2lhbjMuVU5JVF9aLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLnByb2plY3RWZWN0b3IgPSBmdW5jdGlvbihhMywgYiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhIiwgYTMpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYiIsIGIpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzY2FsYXIgPSBDYXJ0ZXNpYW4zLmRvdChhMywgYikgLyBDYXJ0ZXNpYW4zLmRvdChiLCBiKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5tdWx0aXBseUJ5U2NhbGFyKGIsIHNjYWxhciwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LnggPT09IHJpZ2h0LnggJiYgbGVmdC55ID09PSByaWdodC55ICYmIGxlZnQueiA9PT0gcmlnaHQuejsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5lcXVhbHNBcnJheSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggPT09IGFycmF5W29mZnNldF0gJiYgY2FydGVzaWFuMTEueSA9PT0gYXJyYXlbb2Zmc2V0ICsgMV0gJiYgY2FydGVzaWFuMTEueiA9PT0gYXJyYXlbb2Zmc2V0ICsgMl07CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQueCwKICAgICAgICAgIHJpZ2h0LngsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgbGVmdC55LAogICAgICAgICAgcmlnaHQueSwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LnosCiAgICAgICAgICByaWdodC56LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5jcm9zcyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBsZWZ0WCA9IGxlZnQueDsKICAgICAgICBjb25zdCBsZWZ0WSA9IGxlZnQueTsKICAgICAgICBjb25zdCBsZWZ0WiA9IGxlZnQuejsKICAgICAgICBjb25zdCByaWdodFggPSByaWdodC54OwogICAgICAgIGNvbnN0IHJpZ2h0WSA9IHJpZ2h0Lnk7CiAgICAgICAgY29uc3QgcmlnaHRaID0gcmlnaHQuejsKICAgICAgICBjb25zdCB4ID0gbGVmdFkgKiByaWdodFogLSBsZWZ0WiAqIHJpZ2h0WTsKICAgICAgICBjb25zdCB5ID0gbGVmdFogKiByaWdodFggLSBsZWZ0WCAqIHJpZ2h0WjsKICAgICAgICBjb25zdCB6ID0gbGVmdFggKiByaWdodFkgLSBsZWZ0WSAqIHJpZ2h0WDsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLm1pZHBvaW50ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gKGxlZnQueCArIHJpZ2h0LngpICogMC41OwogICAgICAgIHJlc3VsdC55ID0gKGxlZnQueSArIHJpZ2h0LnkpICogMC41OwogICAgICAgIHJlc3VsdC56ID0gKGxlZnQueiArIHJpZ2h0LnopICogMC41OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZnJvbURlZ3JlZXMgPSBmdW5jdGlvbihsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsb25naXR1ZGUiLCBsb25naXR1ZGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibGF0aXR1ZGUiLCBsYXRpdHVkZSk7CiAgICAgICAgbG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhsb25naXR1ZGUpOwogICAgICAgIGxhdGl0dWRlID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhsYXRpdHVkZSk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjMuZnJvbVJhZGlhbnMobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCBlbGxpcHNvaWQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hOID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgc2NyYXRjaEsgPSBuZXcgQ2FydGVzaWFuMygpOwogICAgICB3Z3M4NFJhZGlpU3F1YXJlZCA9IG5ldyBDYXJ0ZXNpYW4zKAogICAgICAgIDYzNzgxMzcgKiA2Mzc4MTM3LAogICAgICAgIDYzNzgxMzcgKiA2Mzc4MTM3LAogICAgICAgIDYzNTY3NTIzMTQyNDUxNzllLTkgKiA2MzU2NzUyMzE0MjQ1MTc5ZS05CiAgICAgICk7CiAgICAgIENhcnRlc2lhbjMuZnJvbVJhZGlhbnMgPSBmdW5jdGlvbihsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsb25naXR1ZGUiLCBsb25naXR1ZGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibGF0aXR1ZGUiLCBsYXRpdHVkZSk7CiAgICAgICAgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaGVpZ2h0LCAwKTsKICAgICAgICBjb25zdCByYWRpaVNxdWFyZWQgPSBkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkKSA/IGVsbGlwc29pZC5yYWRpaVNxdWFyZWQgOiB3Z3M4NFJhZGlpU3F1YXJlZDsKICAgICAgICBjb25zdCBjb3NMYXRpdHVkZSA9IE1hdGguY29zKGxhdGl0dWRlKTsKICAgICAgICBzY3JhdGNoTi54ID0gY29zTGF0aXR1ZGUgKiBNYXRoLmNvcyhsb25naXR1ZGUpOwogICAgICAgIHNjcmF0Y2hOLnkgPSBjb3NMYXRpdHVkZSAqIE1hdGguc2luKGxvbmdpdHVkZSk7CiAgICAgICAgc2NyYXRjaE4ueiA9IE1hdGguc2luKGxhdGl0dWRlKTsKICAgICAgICBzY3JhdGNoTiA9IENhcnRlc2lhbjMubm9ybWFsaXplKHNjcmF0Y2hOLCBzY3JhdGNoTik7CiAgICAgICAgQ2FydGVzaWFuMy5tdWx0aXBseUNvbXBvbmVudHMocmFkaWlTcXVhcmVkLCBzY3JhdGNoTiwgc2NyYXRjaEspOwogICAgICAgIGNvbnN0IGdhbW1hID0gTWF0aC5zcXJ0KENhcnRlc2lhbjMuZG90KHNjcmF0Y2hOLCBzY3JhdGNoSykpOwogICAgICAgIHNjcmF0Y2hLID0gQ2FydGVzaWFuMy5kaXZpZGVCeVNjYWxhcihzY3JhdGNoSywgZ2FtbWEsIHNjcmF0Y2hLKTsKICAgICAgICBzY3JhdGNoTiA9IENhcnRlc2lhbjMubXVsdGlwbHlCeVNjYWxhcihzY3JhdGNoTiwgaGVpZ2h0LCBzY3JhdGNoTik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjMoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjMuYWRkKHNjcmF0Y2hLLCBzY3JhdGNoTiwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5mcm9tRGVncmVlc0FycmF5ID0gZnVuY3Rpb24oY29vcmRpbmF0ZXMsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjb29yZGluYXRlcyIsIGNvb3JkaW5hdGVzKTsKICAgICAgICBpZiAoY29vcmRpbmF0ZXMubGVuZ3RoIDwgMiB8fCBjb29yZGluYXRlcy5sZW5ndGggJSAyICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgInRoZSBudW1iZXIgb2YgY29vcmRpbmF0ZXMgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDIgYW5kIGF0IGxlYXN0IDIiCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBjb29yZGluYXRlcy5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCAvIDIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gMjsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gY29vcmRpbmF0ZXNbaV07CiAgICAgICAgICBjb25zdCBsYXRpdHVkZSA9IGNvb3JkaW5hdGVzW2kgKyAxXTsKICAgICAgICAgIGNvbnN0IGluZGV4ID0gaSAvIDI7CiAgICAgICAgICByZXN1bHRbaW5kZXhdID0gQ2FydGVzaWFuMy5mcm9tRGVncmVlcygKICAgICAgICAgICAgbG9uZ2l0dWRlLAogICAgICAgICAgICBsYXRpdHVkZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICByZXN1bHRbaW5kZXhdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLmZyb21SYWRpYW5zQXJyYXkgPSBmdW5jdGlvbihjb29yZGluYXRlcywgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNvb3JkaW5hdGVzIiwgY29vcmRpbmF0ZXMpOwogICAgICAgIGlmIChjb29yZGluYXRlcy5sZW5ndGggPCAyIHx8IGNvb3JkaW5hdGVzLmxlbmd0aCAlIDIgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAidGhlIG51bWJlciBvZiBjb29yZGluYXRlcyBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMiBhbmQgYXQgbGVhc3QgMiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNvb3JkaW5hdGVzLmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGggLyAyOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBjb29yZGluYXRlc1tpXTsKICAgICAgICAgIGNvbnN0IGxhdGl0dWRlID0gY29vcmRpbmF0ZXNbaSArIDFdOwogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gMjsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBDYXJ0ZXNpYW4zLmZyb21SYWRpYW5zKAogICAgICAgICAgICBsb25naXR1ZGUsCiAgICAgICAgICAgIGxhdGl0dWRlLAogICAgICAgICAgICAwLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHJlc3VsdFtpbmRleF0KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMuZnJvbURlZ3JlZXNBcnJheUhlaWdodHMgPSBmdW5jdGlvbihjb29yZGluYXRlcywgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNvb3JkaW5hdGVzIiwgY29vcmRpbmF0ZXMpOwogICAgICAgIGlmIChjb29yZGluYXRlcy5sZW5ndGggPCAzIHx8IGNvb3JkaW5hdGVzLmxlbmd0aCAlIDMgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAidGhlIG51bWJlciBvZiBjb29yZGluYXRlcyBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMyBhbmQgYXQgbGVhc3QgMyIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNvb3JkaW5hdGVzLmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gMyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGggLyAzOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBjb29yZGluYXRlc1tpXTsKICAgICAgICAgIGNvbnN0IGxhdGl0dWRlID0gY29vcmRpbmF0ZXNbaSArIDFdOwogICAgICAgICAgY29uc3QgaGVpZ2h0ID0gY29vcmRpbmF0ZXNbaSArIDJdOwogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gMzsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBDYXJ0ZXNpYW4zLmZyb21EZWdyZWVzKAogICAgICAgICAgICBsb25naXR1ZGUsCiAgICAgICAgICAgIGxhdGl0dWRlLAogICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgcmVzdWx0W2luZGV4XQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5mcm9tUmFkaWFuc0FycmF5SGVpZ2h0cyA9IGZ1bmN0aW9uKGNvb3JkaW5hdGVzLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY29vcmRpbmF0ZXMiLCBjb29yZGluYXRlcyk7CiAgICAgICAgaWYgKGNvb3JkaW5hdGVzLmxlbmd0aCA8IDMgfHwgY29vcmRpbmF0ZXMubGVuZ3RoICUgMyAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJ0aGUgbnVtYmVyIG9mIGNvb3JkaW5hdGVzIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAzIGFuZCBhdCBsZWFzdCAzIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gY29vcmRpbmF0ZXMubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGggLyAzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aCAvIDM7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IGNvb3JkaW5hdGVzW2ldOwogICAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBjb29yZGluYXRlc1tpICsgMV07CiAgICAgICAgICBjb25zdCBoZWlnaHQgPSBjb29yZGluYXRlc1tpICsgMl07CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgLyAzOwogICAgICAgICAgcmVzdWx0W2luZGV4XSA9IENhcnRlc2lhbjMuZnJvbVJhZGlhbnMoCiAgICAgICAgICAgIGxvbmdpdHVkZSwKICAgICAgICAgICAgbGF0aXR1ZGUsCiAgICAgICAgICAgIGhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICByZXN1bHRbaW5kZXhdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLlpFUk8gPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDAsIDAsIDApKTsKICAgICAgQ2FydGVzaWFuMy5PTkUgPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDEsIDEsIDEpKTsKICAgICAgQ2FydGVzaWFuMy5VTklUX1ggPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDEsIDAsIDApKTsKICAgICAgQ2FydGVzaWFuMy5VTklUX1kgPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDAsIDEsIDApKTsKICAgICAgQ2FydGVzaWFuMy5VTklUX1ogPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zKDAsIDAsIDEpKTsKICAgICAgQ2FydGVzaWFuMy5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4zLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjMucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihyaWdodCwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMy5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcywKICAgICAgICAgIHJpZ2h0LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMy5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYCgke3RoaXMueH0sICR7dGhpcy55fSwgJHt0aGlzLnp9KWA7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdCA9IENhcnRlc2lhbjM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9zY2FsZVRvR2VvZGV0aWNTdXJmYWNlLmpzCiAgZnVuY3Rpb24gc2NhbGVUb0dlb2RldGljU3VyZmFjZShjYXJ0ZXNpYW4xMSwgb25lT3ZlclJhZGlpLCBvbmVPdmVyUmFkaWlTcXVhcmVkLCBjZW50ZXJUb2xlcmFuY2VTcXVhcmVkLCByZXN1bHQpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNhcnRlc2lhbjExKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2FydGVzaWFuIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob25lT3ZlclJhZGlpKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib25lT3ZlclJhZGlpIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob25lT3ZlclJhZGlpU3F1YXJlZCkpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9uZU92ZXJSYWRpaVNxdWFyZWQgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjZW50ZXJUb2xlcmFuY2VTcXVhcmVkKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2VudGVyVG9sZXJhbmNlU3F1YXJlZCBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGNvbnN0IHBvc2l0aW9uWCA9IGNhcnRlc2lhbjExLng7CiAgICBjb25zdCBwb3NpdGlvblkgPSBjYXJ0ZXNpYW4xMS55OwogICAgY29uc3QgcG9zaXRpb25aID0gY2FydGVzaWFuMTEuejsKICAgIGNvbnN0IG9uZU92ZXJSYWRpaVggPSBvbmVPdmVyUmFkaWkueDsKICAgIGNvbnN0IG9uZU92ZXJSYWRpaVkgPSBvbmVPdmVyUmFkaWkueTsKICAgIGNvbnN0IG9uZU92ZXJSYWRpaVogPSBvbmVPdmVyUmFkaWkuejsKICAgIGNvbnN0IHgyID0gcG9zaXRpb25YICogcG9zaXRpb25YICogb25lT3ZlclJhZGlpWCAqIG9uZU92ZXJSYWRpaVg7CiAgICBjb25zdCB5MiA9IHBvc2l0aW9uWSAqIHBvc2l0aW9uWSAqIG9uZU92ZXJSYWRpaVkgKiBvbmVPdmVyUmFkaWlZOwogICAgY29uc3QgejIgPSBwb3NpdGlvblogKiBwb3NpdGlvblogKiBvbmVPdmVyUmFkaWlaICogb25lT3ZlclJhZGlpWjsKICAgIGNvbnN0IHNxdWFyZWROb3JtID0geDIgKyB5MiArIHoyOwogICAgY29uc3QgcmF0aW8gPSBNYXRoLnNxcnQoMSAvIHNxdWFyZWROb3JtKTsKICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBjYXJ0ZXNpYW4xMSwKICAgICAgcmF0aW8sCiAgICAgIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VJbnRlcnNlY3Rpb24KICAgICk7CiAgICBpZiAoc3F1YXJlZE5vcm0gPCBjZW50ZXJUb2xlcmFuY2VTcXVhcmVkKSB7CiAgICAgIHJldHVybiAhaXNGaW5pdGUocmF0aW8pID8gdm9pZCAwIDogQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGludGVyc2VjdGlvbiwgcmVzdWx0KTsKICAgIH0KICAgIGNvbnN0IG9uZU92ZXJSYWRpaVNxdWFyZWRYID0gb25lT3ZlclJhZGlpU3F1YXJlZC54OwogICAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZFkgPSBvbmVPdmVyUmFkaWlTcXVhcmVkLnk7CiAgICBjb25zdCBvbmVPdmVyUmFkaWlTcXVhcmVkWiA9IG9uZU92ZXJSYWRpaVNxdWFyZWQuejsKICAgIGNvbnN0IGdyYWRpZW50ID0gc2NhbGVUb0dlb2RldGljU3VyZmFjZUdyYWRpZW50OwogICAgZ3JhZGllbnQueCA9IGludGVyc2VjdGlvbi54ICogb25lT3ZlclJhZGlpU3F1YXJlZFggKiAyOwogICAgZ3JhZGllbnQueSA9IGludGVyc2VjdGlvbi55ICogb25lT3ZlclJhZGlpU3F1YXJlZFkgKiAyOwogICAgZ3JhZGllbnQueiA9IGludGVyc2VjdGlvbi56ICogb25lT3ZlclJhZGlpU3F1YXJlZFogKiAyOwogICAgbGV0IGxhbWJkYSA9ICgxIC0gcmF0aW8pICogQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShjYXJ0ZXNpYW4xMSkgLyAoMC41ICogQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShncmFkaWVudCkpOwogICAgbGV0IGNvcnJlY3Rpb24gPSAwOwogICAgbGV0IGZ1bmM7CiAgICBsZXQgZGVub21pbmF0b3I7CiAgICBsZXQgeE11bHRpcGxpZXI7CiAgICBsZXQgeU11bHRpcGxpZXI7CiAgICBsZXQgek11bHRpcGxpZXI7CiAgICBsZXQgeE11bHRpcGxpZXIyOwogICAgbGV0IHlNdWx0aXBsaWVyMjsKICAgIGxldCB6TXVsdGlwbGllcjI7CiAgICBsZXQgeE11bHRpcGxpZXIzOwogICAgbGV0IHlNdWx0aXBsaWVyMzsKICAgIGxldCB6TXVsdGlwbGllcjM7CiAgICBkbyB7CiAgICAgIGxhbWJkYSAtPSBjb3JyZWN0aW9uOwogICAgICB4TXVsdGlwbGllciA9IDEgLyAoMSArIGxhbWJkYSAqIG9uZU92ZXJSYWRpaVNxdWFyZWRYKTsKICAgICAgeU11bHRpcGxpZXIgPSAxIC8gKDEgKyBsYW1iZGEgKiBvbmVPdmVyUmFkaWlTcXVhcmVkWSk7CiAgICAgIHpNdWx0aXBsaWVyID0gMSAvICgxICsgbGFtYmRhICogb25lT3ZlclJhZGlpU3F1YXJlZFopOwogICAgICB4TXVsdGlwbGllcjIgPSB4TXVsdGlwbGllciAqIHhNdWx0aXBsaWVyOwogICAgICB5TXVsdGlwbGllcjIgPSB5TXVsdGlwbGllciAqIHlNdWx0aXBsaWVyOwogICAgICB6TXVsdGlwbGllcjIgPSB6TXVsdGlwbGllciAqIHpNdWx0aXBsaWVyOwogICAgICB4TXVsdGlwbGllcjMgPSB4TXVsdGlwbGllcjIgKiB4TXVsdGlwbGllcjsKICAgICAgeU11bHRpcGxpZXIzID0geU11bHRpcGxpZXIyICogeU11bHRpcGxpZXI7CiAgICAgIHpNdWx0aXBsaWVyMyA9IHpNdWx0aXBsaWVyMiAqIHpNdWx0aXBsaWVyOwogICAgICBmdW5jID0geDIgKiB4TXVsdGlwbGllcjIgKyB5MiAqIHlNdWx0aXBsaWVyMiArIHoyICogek11bHRpcGxpZXIyIC0gMTsKICAgICAgZGVub21pbmF0b3IgPSB4MiAqIHhNdWx0aXBsaWVyMyAqIG9uZU92ZXJSYWRpaVNxdWFyZWRYICsgeTIgKiB5TXVsdGlwbGllcjMgKiBvbmVPdmVyUmFkaWlTcXVhcmVkWSArIHoyICogek11bHRpcGxpZXIzICogb25lT3ZlclJhZGlpU3F1YXJlZFo7CiAgICAgIGNvbnN0IGRlcml2YXRpdmUgPSAtMiAqIGRlbm9taW5hdG9yOwogICAgICBjb3JyZWN0aW9uID0gZnVuYyAvIGRlcml2YXRpdmU7CiAgICB9IHdoaWxlIChNYXRoLmFicyhmdW5jKSA+IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTIpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgKICAgICAgICBwb3NpdGlvblggKiB4TXVsdGlwbGllciwKICAgICAgICBwb3NpdGlvblkgKiB5TXVsdGlwbGllciwKICAgICAgICBwb3NpdGlvblogKiB6TXVsdGlwbGllcgogICAgICApOwogICAgfQogICAgcmVzdWx0LnggPSBwb3NpdGlvblggKiB4TXVsdGlwbGllcjsKICAgIHJlc3VsdC55ID0gcG9zaXRpb25ZICogeU11bHRpcGxpZXI7CiAgICByZXN1bHQueiA9IHBvc2l0aW9uWiAqIHpNdWx0aXBsaWVyOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VJbnRlcnNlY3Rpb24sIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VHcmFkaWVudCwgc2NhbGVUb0dlb2RldGljU3VyZmFjZV9kZWZhdWx0OwogIHZhciBpbml0X3NjYWxlVG9HZW9kZXRpY1N1cmZhY2UgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL3NjYWxlVG9HZW9kZXRpY1N1cmZhY2UuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VJbnRlcnNlY3Rpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VHcmFkaWVudCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NhbGVUb0dlb2RldGljU3VyZmFjZV9kZWZhdWx0ID0gc2NhbGVUb0dlb2RldGljU3VyZmFjZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NhcnRvZ3JhcGhpYy5qcwogIGZ1bmN0aW9uIENhcnRvZ3JhcGhpYyhsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQpIHsKICAgIHRoaXMubG9uZ2l0dWRlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobG9uZ2l0dWRlLCAwKTsKICAgIHRoaXMubGF0aXR1ZGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChsYXRpdHVkZSwgMCk7CiAgICB0aGlzLmhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGhlaWdodCwgMCk7CiAgfQogIHZhciBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04sIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUCwgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNILCB3Z3M4NE9uZU92ZXJSYWRpaSwgd2dzODRPbmVPdmVyUmFkaWlTcXVhcmVkLCB3Z3M4NENlbnRlclRvbGVyYW5jZVNxdWFyZWQsIENhcnRvZ3JhcGhpY19kZWZhdWx0OwogIHZhciBpbml0X0NhcnRvZ3JhcGhpYyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydG9ncmFwaGljLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X3NjYWxlVG9HZW9kZXRpY1N1cmZhY2UoKTsKICAgICAgQ2FydG9ncmFwaGljLmZyb21SYWRpYW5zID0gZnVuY3Rpb24obG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImxvbmdpdHVkZSIsIGxvbmdpdHVkZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsYXRpdHVkZSIsIGxhdGl0dWRlKTsKICAgICAgICBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChoZWlnaHQsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IGhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMuZnJvbURlZ3JlZXMgPSBmdW5jdGlvbihsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibG9uZ2l0dWRlIiwgbG9uZ2l0dWRlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImxhdGl0dWRlIiwgbGF0aXR1ZGUpOwogICAgICAgIGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMobG9uZ2l0dWRlKTsKICAgICAgICBsYXRpdHVkZSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMobGF0aXR1ZGUpOwogICAgICAgIHJldHVybiBDYXJ0b2dyYXBoaWMuZnJvbVJhZGlhbnMobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCByZXN1bHQpOwogICAgICB9OwogICAgICBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNIID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB3Z3M4NE9uZU92ZXJSYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoCiAgICAgICAgMSAvIDYzNzgxMzcsCiAgICAgICAgMSAvIDYzNzgxMzcsCiAgICAgICAgMSAvIDYzNTY3NTIzMTQyNDUxNzllLTkKICAgICAgKTsKICAgICAgd2dzODRPbmVPdmVyUmFkaWlTcXVhcmVkID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgKICAgICAgICAxIC8gKDYzNzgxMzcgKiA2Mzc4MTM3KSwKICAgICAgICAxIC8gKDYzNzgxMzcgKiA2Mzc4MTM3KSwKICAgICAgICAxIC8gKDYzNTY3NTIzMTQyNDUxNzllLTkgKiA2MzU2NzUyMzE0MjQ1MTc5ZS05KQogICAgICApOwogICAgICB3Z3M4NENlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjE7CiAgICAgIENhcnRvZ3JhcGhpYy5mcm9tQ2FydGVzaWFuID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3Qgb25lT3ZlclJhZGlpID0gZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkgPyBlbGxpcHNvaWQub25lT3ZlclJhZGlpIDogd2dzODRPbmVPdmVyUmFkaWk7CiAgICAgICAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZCA9IGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpID8gZWxsaXBzb2lkLm9uZU92ZXJSYWRpaVNxdWFyZWQgOiB3Z3M4NE9uZU92ZXJSYWRpaVNxdWFyZWQ7CiAgICAgICAgY29uc3QgY2VudGVyVG9sZXJhbmNlU3F1YXJlZCA9IGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpID8gZWxsaXBzb2lkLl9jZW50ZXJUb2xlcmFuY2VTcXVhcmVkIDogd2dzODRDZW50ZXJUb2xlcmFuY2VTcXVhcmVkOwogICAgICAgIGNvbnN0IHAgPSBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlX2RlZmF1bHQoCiAgICAgICAgICBjYXJ0ZXNpYW4xMSwKICAgICAgICAgIG9uZU92ZXJSYWRpaSwKICAgICAgICAgIG9uZU92ZXJSYWRpaVNxdWFyZWQsCiAgICAgICAgICBjZW50ZXJUb2xlcmFuY2VTcXVhcmVkLAogICAgICAgICAgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNQCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgbGV0IG4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKAogICAgICAgICAgcCwKICAgICAgICAgIG9uZU92ZXJSYWRpaVNxdWFyZWQsCiAgICAgICAgICBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04KICAgICAgICApOwogICAgICAgIG4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKG4sIG4pOwogICAgICAgIGNvbnN0IGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY2FydGVzaWFuMTEsIHAsIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljSCk7CiAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gTWF0aC5hdGFuMihuLnksIG4ueCk7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBNYXRoLmFzaW4obi56KTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBNYXRoX2RlZmF1bHQuc2lnbihDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGgsIGNhcnRlc2lhbjExKSkgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGgpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IGhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMudG9DYXJ0ZXNpYW4gPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWMyLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydG9ncmFwaGljIiwgY2FydG9ncmFwaGljMik7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlLAogICAgICAgICAgY2FydG9ncmFwaGljMi5sYXRpdHVkZSwKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIuaGVpZ2h0LAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ2FydG9ncmFwaGljLmNsb25lID0gZnVuY3Rpb24oY2FydG9ncmFwaGljMiwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydG9ncmFwaGljMikpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljKAogICAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZSwKICAgICAgICAgICAgY2FydG9ncmFwaGljMi5sYXRpdHVkZSwKICAgICAgICAgICAgY2FydG9ncmFwaGljMi5oZWlnaHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZTsKICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSBjYXJ0b2dyYXBoaWMyLmhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC5sb25naXR1ZGUgPT09IHJpZ2h0LmxvbmdpdHVkZSAmJiBsZWZ0LmxhdGl0dWRlID09PSByaWdodC5sYXRpdHVkZSAmJiBsZWZ0LmhlaWdodCA9PT0gcmlnaHQuaGVpZ2h0OwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgZXBzaWxvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVwc2lsb24sIDApOwogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoLmFicyhsZWZ0LmxvbmdpdHVkZSAtIHJpZ2h0LmxvbmdpdHVkZSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0LmxhdGl0dWRlIC0gcmlnaHQubGF0aXR1ZGUpIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC5oZWlnaHQgLSByaWdodC5oZWlnaHQpIDw9IGVwc2lsb247CiAgICAgIH07CiAgICAgIENhcnRvZ3JhcGhpYy5aRVJPID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydG9ncmFwaGljKDAsIDAsIDApKTsKICAgICAgQ2FydG9ncmFwaGljLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBDYXJ0b2dyYXBoaWMuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQ2FydG9ncmFwaGljLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBDYXJ0b2dyYXBoaWMuZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgQ2FydG9ncmFwaGljLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ocmlnaHQsIGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gQ2FydG9ncmFwaGljLmVxdWFsc0Vwc2lsb24odGhpcywgcmlnaHQsIGVwc2lsb24pOwogICAgICB9OwogICAgICBDYXJ0b2dyYXBoaWMucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzLmxvbmdpdHVkZX0sICR7dGhpcy5sYXRpdHVkZX0sICR7dGhpcy5oZWlnaHR9KWA7CiAgICAgIH07CiAgICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0ID0gQ2FydG9ncmFwaGljOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydGVzaWFuMi5qcwogIGZ1bmN0aW9uIENhcnRlc2lhbjIoeCwgeSkgewogICAgdGhpcy54ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB0aGlzLnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5LCAwKTsKICB9CiAgdmFyIGRpc3RhbmNlU2NyYXRjaDIsIGxlcnBTY3JhdGNoMiwgYW5nbGVCZXR3ZWVuU2NyYXRjaDMsIGFuZ2xlQmV0d2VlblNjcmF0Y2gyMiwgbW9zdE9ydGhvZ29uYWxBeGlzU2NyYXRjaDIsIENhcnRlc2lhbjJfZGVmYXVsdDsKICB2YXIgaW5pdF9DYXJ0ZXNpYW4yID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DYXJ0ZXNpYW4yLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgQ2FydGVzaWFuMi5mcm9tRWxlbWVudHMgPSBmdW5jdGlvbih4LCB5LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjIoeCwgeSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5jbG9uZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjYXJ0ZXNpYW4xMSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuMihjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmZyb21DYXJ0ZXNpYW4zID0gQ2FydGVzaWFuMi5jbG9uZTsKICAgICAgQ2FydGVzaWFuMi5mcm9tQ2FydGVzaWFuNCA9IENhcnRlc2lhbjIuY2xvbmU7CiAgICAgIENhcnRlc2lhbjIucGFja2VkTGVuZ3RoID0gMjsKICAgICAgQ2FydGVzaWFuMi5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLnk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnkgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBjb25zdCByZXN1bHRMZW5ndGggPSBsZW5ndGggKiAyOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShyZXN1bHRMZW5ndGgpOwogICAgICAgIH0gZWxzZSBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0KSAmJiByZXN1bHQubGVuZ3RoICE9PSByZXN1bHRMZW5ndGgpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiSWYgcmVzdWx0IGlzIGEgdHlwZWQgYXJyYXksIGl0IG11c3QgaGF2ZSBleGFjdGx5IGFycmF5Lmxlbmd0aCAqIDIgZWxlbWVudHMiCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAocmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gcmVzdWx0TGVuZ3RoOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4yLnBhY2soYXJyYXlbaV0sIHJlc3VsdCwgaSAqIDIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnVucGFja0FycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImFycmF5Lmxlbmd0aCIsIGFycmF5Lmxlbmd0aCwgMik7CiAgICAgICAgaWYgKGFycmF5Lmxlbmd0aCAlIDIgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBsZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDIuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGggLyAyOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgLyAyOwogICAgICAgICAgcmVzdWx0W2luZGV4XSA9IENhcnRlc2lhbjIudW5wYWNrKGFycmF5LCBpLCByZXN1bHRbaW5kZXhdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5mcm9tQXJyYXkgPSBDYXJ0ZXNpYW4yLnVucGFjazsKICAgICAgQ2FydGVzaWFuMi5tYXhpbXVtQ29tcG9uZW50ID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICByZXR1cm4gTWF0aC5tYXgoY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubWluaW11bUNvbXBvbmVudCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIE1hdGgubWluKGNhcnRlc2lhbjExLngsIGNhcnRlc2lhbjExLnkpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLm1pbmltdW1CeUNvbXBvbmVudCA9IGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZmlyc3QiLCBmaXJzdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzZWNvbmQiLCBzZWNvbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGgubWluKGZpcnN0LngsIHNlY29uZC54KTsKICAgICAgICByZXN1bHQueSA9IE1hdGgubWluKGZpcnN0LnksIHNlY29uZC55KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLm1heGltdW1CeUNvbXBvbmVudCA9IGZ1bmN0aW9uKGZpcnN0LCBzZWNvbmQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZmlyc3QiLCBmaXJzdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzZWNvbmQiLCBzZWNvbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGgubWF4KGZpcnN0LngsIHNlY29uZC54KTsKICAgICAgICByZXN1bHQueSA9IE1hdGgubWF4KGZpcnN0LnksIHNlY29uZC55KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmNsYW1wID0gZnVuY3Rpb24odmFsdWUsIG1pbjMsIG1heDMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtaW4iLCBtaW4zKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1heCIsIG1heDMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB4ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHZhbHVlLngsIG1pbjMueCwgbWF4My54KTsKICAgICAgICBjb25zdCB5ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHZhbHVlLnksIG1pbjMueSwgbWF4My55KTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubWFnbml0dWRlU3F1YXJlZCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggKiBjYXJ0ZXNpYW4xMS54ICsgY2FydGVzaWFuMTEueSAqIGNhcnRlc2lhbjExLnk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubWFnbml0dWRlID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KENhcnRlc2lhbjIubWFnbml0dWRlU3F1YXJlZChjYXJ0ZXNpYW4xMSkpOwogICAgICB9OwogICAgICBkaXN0YW5jZVNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjIoKTsKICAgICAgQ2FydGVzaWFuMi5kaXN0YW5jZSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW4yLnN1YnRyYWN0KGxlZnQsIHJpZ2h0LCBkaXN0YW5jZVNjcmF0Y2gyKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMi5tYWduaXR1ZGUoZGlzdGFuY2VTY3JhdGNoMik7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZGlzdGFuY2VTcXVhcmVkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENhcnRlc2lhbjIuc3VidHJhY3QobGVmdCwgcmlnaHQsIGRpc3RhbmNlU2NyYXRjaDIpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLm1hZ25pdHVkZVNxdWFyZWQoZGlzdGFuY2VTY3JhdGNoMik7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubm9ybWFsaXplID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBtYWduaXR1ZGUgPSBDYXJ0ZXNpYW4yLm1hZ25pdHVkZShjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54IC8gbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAvIG1hZ25pdHVkZTsKICAgICAgICBpZiAoaXNOYU4ocmVzdWx0LngpIHx8IGlzTmFOKHJlc3VsdC55KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm5vcm1hbGl6ZWQgcmVzdWx0IGlzIG5vdCBhIG51bWJlciIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmRvdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICByZXR1cm4gbGVmdC54ICogcmlnaHQueCArIGxlZnQueSAqIHJpZ2h0Lnk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuY3Jvc3MgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgcmV0dXJuIGxlZnQueCAqIHJpZ2h0LnkgLSBsZWZ0LnkgKiByaWdodC54OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLm11bHRpcGx5Q29tcG9uZW50cyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAqIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgKiByaWdodC55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZGl2aWRlQ29tcG9uZW50cyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAvIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgLyByaWdodC55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuYWRkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54ICsgcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSArIHJpZ2h0Lnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5zdWJ0cmFjdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAtIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgLSByaWdodC55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubXVsdGlwbHlCeVNjYWxhciA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAqIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLmRpdmlkZUJ5U2NhbGFyID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGNhcnRlc2lhbjExLnggLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55IC8gc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIubmVnYXRlID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IC1jYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdC55ID0gLWNhcnRlc2lhbjExLnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5hYnMgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gTWF0aC5hYnMoY2FydGVzaWFuMTEueCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoLmFicyhjYXJ0ZXNpYW4xMS55KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBsZXJwU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBDYXJ0ZXNpYW4yLmxlcnAgPSBmdW5jdGlvbihzdGFydCwgZW5kLCB0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN0YXJ0Iiwgc3RhcnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZW5kIiwgZW5kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInQiLCB0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgQ2FydGVzaWFuMi5tdWx0aXBseUJ5U2NhbGFyKGVuZCwgdCwgbGVycFNjcmF0Y2gyKTsKICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4yLm11bHRpcGx5QnlTY2FsYXIoc3RhcnQsIDEgLSB0LCByZXN1bHQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLmFkZChsZXJwU2NyYXRjaDIsIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaDMgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBhbmdsZUJldHdlZW5TY3JhdGNoMjIgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBDYXJ0ZXNpYW4yLmFuZ2xlQmV0d2VlbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW4yLm5vcm1hbGl6ZShsZWZ0LCBhbmdsZUJldHdlZW5TY3JhdGNoMyk7CiAgICAgICAgQ2FydGVzaWFuMi5ub3JtYWxpemUocmlnaHQsIGFuZ2xlQmV0d2VlblNjcmF0Y2gyMik7CiAgICAgICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5hY29zQ2xhbXBlZCgKICAgICAgICAgIENhcnRlc2lhbjIuZG90KGFuZ2xlQmV0d2VlblNjcmF0Y2gzLCBhbmdsZUJldHdlZW5TY3JhdGNoMjIpCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgbW9zdE9ydGhvZ29uYWxBeGlzU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuMigpOwogICAgICBDYXJ0ZXNpYW4yLm1vc3RPcnRob2dvbmFsQXhpcyA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZiA9IENhcnRlc2lhbjIubm9ybWFsaXplKGNhcnRlc2lhbjExLCBtb3N0T3J0aG9nb25hbEF4aXNTY3JhdGNoMik7CiAgICAgICAgQ2FydGVzaWFuMi5hYnMoZiwgZik7CiAgICAgICAgaWYgKGYueCA8PSBmLnkpIHsKICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjIuY2xvbmUoQ2FydGVzaWFuMi5VTklUX1gsIHJlc3VsdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjIuY2xvbmUoQ2FydGVzaWFuMi5VTklUX1ksIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC54ID09PSByaWdodC54ICYmIGxlZnQueSA9PT0gcmlnaHQueTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5lcXVhbHNBcnJheSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggPT09IGFycmF5W29mZnNldF0gJiYgY2FydGVzaWFuMTEueSA9PT0gYXJyYXlbb2Zmc2V0ICsgMV07CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQueCwKICAgICAgICAgIHJpZ2h0LngsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgbGVmdC55LAogICAgICAgICAgcmlnaHQueSwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIuWkVSTyA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMCwgMCkpOwogICAgICBDYXJ0ZXNpYW4yLk9ORSA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMSwgMSkpOwogICAgICBDYXJ0ZXNpYW4yLlVOSVRfWCA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMSwgMCkpOwogICAgICBDYXJ0ZXNpYW4yLlVOSVRfWSA9IE9iamVjdC5mcmVlemUobmV3IENhcnRlc2lhbjIoMCwgMSkpOwogICAgICBDYXJ0ZXNpYW4yLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjIucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjIuZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuMi5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yLmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLAogICAgICAgICAgcmlnaHQsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW4yLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBgKCR7dGhpcy54fSwgJHt0aGlzLnl9KWA7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjJfZGVmYXVsdCA9IENhcnRlc2lhbjI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWQuanMKICBmdW5jdGlvbiBpbml0aWFsaXplKGVsbGlwc29pZCwgeCwgeSwgeikgewogICAgeCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHgsIDApOwogICAgeSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHksIDApOwogICAgeiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIngiLCB4LCAwKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJ5IiwgeSwgMCk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygieiIsIHosIDApOwogICAgZWxsaXBzb2lkLl9yYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgeSwgeik7CiAgICBlbGxpcHNvaWQuX3JhZGlpU3F1YXJlZCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCAqIHgsIHkgKiB5LCB6ICogeik7CiAgICBlbGxpcHNvaWQuX3JhZGlpVG9UaGVGb3VydGggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KAogICAgICB4ICogeCAqIHggKiB4LAogICAgICB5ICogeSAqIHkgKiB5LAogICAgICB6ICogeiAqIHogKiB6CiAgICApOwogICAgZWxsaXBzb2lkLl9vbmVPdmVyUmFkaWkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KAogICAgICB4ID09PSAwID8gMCA6IDEgLyB4LAogICAgICB5ID09PSAwID8gMCA6IDEgLyB5LAogICAgICB6ID09PSAwID8gMCA6IDEgLyB6CiAgICApOwogICAgZWxsaXBzb2lkLl9vbmVPdmVyUmFkaWlTcXVhcmVkID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgKICAgICAgeCA9PT0gMCA/IDAgOiAxIC8gKHggKiB4KSwKICAgICAgeSA9PT0gMCA/IDAgOiAxIC8gKHkgKiB5KSwKICAgICAgeiA9PT0gMCA/IDAgOiAxIC8gKHogKiB6KQogICAgKTsKICAgIGVsbGlwc29pZC5fbWluaW11bVJhZGl1cyA9IE1hdGgubWluKHgsIHksIHopOwogICAgZWxsaXBzb2lkLl9tYXhpbXVtUmFkaXVzID0gTWF0aC5tYXgoeCwgeSwgeik7CiAgICBlbGxpcHNvaWQuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjE7CiAgICBpZiAoZWxsaXBzb2lkLl9yYWRpaVNxdWFyZWQueiAhPT0gMCkgewogICAgICBlbGxpcHNvaWQuX3NxdWFyZWRYT3ZlclNxdWFyZWRaID0gZWxsaXBzb2lkLl9yYWRpaVNxdWFyZWQueCAvIGVsbGlwc29pZC5fcmFkaWlTcXVhcmVkLno7CiAgICB9CiAgfQogIGZ1bmN0aW9uIEVsbGlwc29pZCh4LCB5LCB6KSB7CiAgICB0aGlzLl9yYWRpaSA9IHZvaWQgMDsKICAgIHRoaXMuX3JhZGlpU3F1YXJlZCA9IHZvaWQgMDsKICAgIHRoaXMuX3JhZGlpVG9UaGVGb3VydGggPSB2b2lkIDA7CiAgICB0aGlzLl9vbmVPdmVyUmFkaWkgPSB2b2lkIDA7CiAgICB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkID0gdm9pZCAwOwogICAgdGhpcy5fbWluaW11bVJhZGl1cyA9IHZvaWQgMDsKICAgIHRoaXMuX21heGltdW1SYWRpdXMgPSB2b2lkIDA7CiAgICB0aGlzLl9jZW50ZXJUb2xlcmFuY2VTcXVhcmVkID0gdm9pZCAwOwogICAgdGhpcy5fc3F1YXJlZFhPdmVyU3F1YXJlZFogPSB2b2lkIDA7CiAgICBpbml0aWFsaXplKHRoaXMsIHgsIHksIHopOwogIH0KICBmdW5jdGlvbiBnYXVzc0xlZ2VuZHJlUXVhZHJhdHVyZShhMywgYiwgZnVuYykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhIiwgYTMpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJiIiwgYik7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5mdW5jKCJmdW5jIiwgZnVuYyk7CiAgICBjb25zdCB4TWVhbiA9IDAuNSAqIChiICsgYTMpOwogICAgY29uc3QgeFJhbmdlID0gMC41ICogKGIgLSBhMyk7CiAgICBsZXQgc3VtID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNTsgaSsrKSB7CiAgICAgIGNvbnN0IGR4ID0geFJhbmdlICogYWJzY2lzc2FzW2ldOwogICAgICBzdW0gKz0gd2VpZ2h0c1tpXSAqIChmdW5jKHhNZWFuICsgZHgpICsgZnVuYyh4TWVhbiAtIGR4KSk7CiAgICB9CiAgICBzdW0gKj0geFJhbmdlOwogICAgcmV0dXJuIHN1bTsKICB9CiAgdmFyIGNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuTm9ybWFsLCBjYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbkssIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljTjIsIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUDIsIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljSDIsIHNjcmF0Y2hFbmRwb2ludCwgYWJzY2lzc2FzLCB3ZWlnaHRzLCBFbGxpcHNvaWRfZGVmYXVsdDsKICB2YXIgaW5pdF9FbGxpcHNvaWQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZC5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEVsbGlwc29pZC5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSByYWRpaSBvZiB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWQucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0NhcnRlc2lhbjN9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgcmFkaWk6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yYWRpaTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHNxdWFyZWQgcmFkaWkgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHJhZGlpU3F1YXJlZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JhZGlpU3F1YXJlZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHJhZGlpIG9mIHRoZSBlbGxpcHNvaWQgcmFpc2UgdG8gdGhlIGZvdXJ0aCBwb3dlci4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHJhZGlpVG9UaGVGb3VydGg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yYWRpaVRvVGhlRm91cnRoOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBvbmUgb3ZlciB0aGUgcmFkaWkgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIG9uZU92ZXJSYWRpaTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29uZU92ZXJSYWRpaTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgb25lIG92ZXIgdGhlIHNxdWFyZWQgcmFkaWkgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0ZXNpYW4zfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIG9uZU92ZXJSYWRpaVNxdWFyZWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgbWluaW11bSByYWRpdXMgb2YgdGhlIGVsbGlwc29pZC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgbWluaW11bVJhZGl1czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21pbmltdW1SYWRpdXM7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBtYXhpbXVtIHJhZGl1cyBvZiB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWQucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBtYXhpbXVtUmFkaXVzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbWF4aW11bVJhZGl1czsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBFbGxpcHNvaWQuY2xvbmUgPSBmdW5jdGlvbihlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJhZGlpID0gZWxsaXBzb2lkLl9yYWRpaTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEVsbGlwc29pZChyYWRpaS54LCByYWRpaS55LCByYWRpaS56KTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJhZGlpLCByZXN1bHQuX3JhZGlpKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLl9yYWRpaVNxdWFyZWQsIHJlc3VsdC5fcmFkaWlTcXVhcmVkKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLl9yYWRpaVRvVGhlRm91cnRoLCByZXN1bHQuX3JhZGlpVG9UaGVGb3VydGgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQuX29uZU92ZXJSYWRpaSwgcmVzdWx0Ll9vbmVPdmVyUmFkaWkpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQuX29uZU92ZXJSYWRpaVNxdWFyZWQsIHJlc3VsdC5fb25lT3ZlclJhZGlpU3F1YXJlZCk7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtUmFkaXVzID0gZWxsaXBzb2lkLl9taW5pbXVtUmFkaXVzOwogICAgICAgIHJlc3VsdC5fbWF4aW11bVJhZGl1cyA9IGVsbGlwc29pZC5fbWF4aW11bVJhZGl1czsKICAgICAgICByZXN1bHQuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSBlbGxpcHNvaWQuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLmZyb21DYXJ0ZXNpYW4zID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBFbGxpcHNvaWQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydGVzaWFuMTEpKSB7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBpbml0aWFsaXplKHJlc3VsdCwgY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSwgY2FydGVzaWFuMTEueik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLldHUzg0ID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgRWxsaXBzb2lkKDYzNzgxMzcsIDYzNzgxMzcsIDYzNTY3NTIzMTQyNDUxNzllLTkpCiAgICAgICk7CiAgICAgIEVsbGlwc29pZC5VTklUX1NQSEVSRSA9IE9iamVjdC5mcmVlemUobmV3IEVsbGlwc29pZCgxLCAxLCAxKSk7CiAgICAgIEVsbGlwc29pZC5NT09OID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgRWxsaXBzb2lkKAogICAgICAgICAgTWF0aF9kZWZhdWx0LkxVTkFSX1JBRElVUywKICAgICAgICAgIE1hdGhfZGVmYXVsdC5MVU5BUl9SQURJVVMsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuTFVOQVJfUkFESVVTCiAgICAgICAgKQogICAgICApOwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEVsbGlwc29pZC5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucGFja2VkTGVuZ3RoID0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgRWxsaXBzb2lkLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9yYWRpaSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCByYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHJldHVybiBFbGxpcHNvaWQuZnJvbUNhcnRlc2lhbjMocmFkaWksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuZ2VvY2VudHJpY1N1cmZhY2VOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplOwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmdlb2RldGljU3VyZmFjZU5vcm1hbENhcnRvZ3JhcGhpYyA9IGZ1bmN0aW9uKGNhcnRvZ3JhcGhpYzIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydG9ncmFwaGljIiwgY2FydG9ncmFwaGljMik7CiAgICAgICAgY29uc3QgbG9uZ2l0dWRlID0gY2FydG9ncmFwaGljMi5sb25naXR1ZGU7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlOwogICAgICAgIGNvbnN0IGNvc0xhdGl0dWRlID0gTWF0aC5jb3MobGF0aXR1ZGUpOwogICAgICAgIGNvbnN0IHggPSBjb3NMYXRpdHVkZSAqIE1hdGguY29zKGxvbmdpdHVkZSk7CiAgICAgICAgY29uc3QgeSA9IGNvc0xhdGl0dWRlICogTWF0aC5zaW4obG9uZ2l0dWRlKTsKICAgICAgICBjb25zdCB6ID0gTWF0aC5zaW4obGF0aXR1ZGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmdlb2RldGljU3VyZmFjZU5vcm1hbCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBpZiAoaXNOYU4oY2FydGVzaWFuMTEueCkgfHwgaXNOYU4oY2FydGVzaWFuMTEueSkgfHwgaXNOYU4oY2FydGVzaWFuMTEueikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjYXJ0ZXNpYW4gaGFzIGEgTmFOIGNvbXBvbmVudCIpOwogICAgICAgIH0KICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oY2FydGVzaWFuMTEsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKAogICAgICAgICAgY2FydGVzaWFuMTEsCiAgICAgICAgICB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyZXN1bHQsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIGNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbksgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4gPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWMyLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBuID0gY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW5Ob3JtYWw7CiAgICAgICAgY29uc3QgayA9IGNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuSzsKICAgICAgICB0aGlzLmdlb2RldGljU3VyZmFjZU5vcm1hbENhcnRvZ3JhcGhpYyhjYXJ0b2dyYXBoaWMyLCBuKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKHRoaXMuX3JhZGlpU3F1YXJlZCwgbiwgayk7CiAgICAgICAgY29uc3QgZ2FtbWEgPSBNYXRoLnNxcnQoQ2FydGVzaWFuM19kZWZhdWx0LmRvdChuLCBrKSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRpdmlkZUJ5U2NhbGFyKGssIGdhbW1hLCBrKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuLCBjYXJ0b2dyYXBoaWMyLmhlaWdodCwgbik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChrLCBuLCByZXN1bHQpOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmNhcnRvZ3JhcGhpY0FycmF5VG9DYXJ0ZXNpYW5BcnJheSA9IGZ1bmN0aW9uKGNhcnRvZ3JhcGhpY3MsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydG9ncmFwaGljcyIsIGNhcnRvZ3JhcGhpY3MpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNhcnRvZ3JhcGhpY3MubGVuZ3RoOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICByZXN1bHRbaV0gPSB0aGlzLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGNhcnRvZ3JhcGhpY3NbaV0sIHJlc3VsdFtpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljTjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljUDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljSDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgcCA9IHRoaXMuc2NhbGVUb0dlb2RldGljU3VyZmFjZShjYXJ0ZXNpYW4xMSwgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNQMik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG4gPSB0aGlzLmdlb2RldGljU3VyZmFjZU5vcm1hbChwLCBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY04yKTsKICAgICAgICBjb25zdCBoID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNhcnRlc2lhbjExLCBwLCBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY0gyKTsKICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBNYXRoLmF0YW4yKG4ueSwgbi54KTsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IE1hdGguYXNpbihuLnopOwogICAgICAgIGNvbnN0IGhlaWdodCA9IE1hdGhfZGVmYXVsdC5zaWduKENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoaCwgY2FydGVzaWFuMTEpKSAqIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoaCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQubG9uZ2l0dWRlID0gbG9uZ2l0dWRlOwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IGxhdGl0dWRlOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS5jYXJ0ZXNpYW5BcnJheVRvQ2FydG9ncmFwaGljQXJyYXkgPSBmdW5jdGlvbihjYXJ0ZXNpYW5zLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbnMiLCBjYXJ0ZXNpYW5zKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBjYXJ0ZXNpYW5zLmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgcmVzdWx0W2ldID0gdGhpcy5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhjYXJ0ZXNpYW5zW2ldLCByZXN1bHRbaV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2VfZGVmYXVsdCgKICAgICAgICAgIGNhcnRlc2lhbjExLAogICAgICAgICAgdGhpcy5fb25lT3ZlclJhZGlpLAogICAgICAgICAgdGhpcy5fb25lT3ZlclJhZGlpU3F1YXJlZCwKICAgICAgICAgIHRoaXMuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLnNjYWxlVG9HZW9jZW50cmljU3VyZmFjZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvc2l0aW9uWCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgY29uc3QgcG9zaXRpb25ZID0gY2FydGVzaWFuMTEueTsKICAgICAgICBjb25zdCBwb3NpdGlvblogPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIGNvbnN0IG9uZU92ZXJSYWRpaVNxdWFyZWQgPSB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkOwogICAgICAgIGNvbnN0IGJldGEgPSAxIC8gTWF0aC5zcXJ0KAogICAgICAgICAgcG9zaXRpb25YICogcG9zaXRpb25YICogb25lT3ZlclJhZGlpU3F1YXJlZC54ICsgcG9zaXRpb25ZICogcG9zaXRpb25ZICogb25lT3ZlclJhZGlpU3F1YXJlZC55ICsgcG9zaXRpb25aICogcG9zaXRpb25aICogb25lT3ZlclJhZGlpU3F1YXJlZC56CiAgICAgICAgKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoY2FydGVzaWFuMTEsIGJldGEsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUudHJhbnNmb3JtUG9zaXRpb25Ub1NjYWxlZFNwYWNlID0gZnVuY3Rpb24ocG9zaXRpb24sIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUNvbXBvbmVudHMocG9zaXRpb24sIHRoaXMuX29uZU92ZXJSYWRpaSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS50cmFuc2Zvcm1Qb3NpdGlvbkZyb21TY2FsZWRTcGFjZSA9IGZ1bmN0aW9uKHBvc2l0aW9uLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlDb21wb25lbnRzKHBvc2l0aW9uLCB0aGlzLl9yYWRpaSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiB0aGlzID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHModGhpcy5fcmFkaWksIHJpZ2h0Ll9yYWRpaSk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmFkaWkudG9TdHJpbmcoKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkLnByb3RvdHlwZS5nZXRTdXJmYWNlTm9ybWFsSW50ZXJzZWN0aW9uV2l0aFpBeGlzID0gZnVuY3Rpb24ocG9zaXRpb24sIGJ1ZmZlciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwb3NpdGlvbiIsIHBvc2l0aW9uKTsKICAgICAgICBpZiAoIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5fcmFkaWkueCwKICAgICAgICAgIHRoaXMuX3JhZGlpLnksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1CiAgICAgICAgKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJFbGxpcHNvaWQgbXVzdCBiZSBhbiBlbGxpcHNvaWQgb2YgcmV2b2x1dGlvbiAocmFkaWkueCA9PSByYWRpaS55KSIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiRWxsaXBzb2lkLnJhZGlpLnoiLCB0aGlzLl9yYWRpaS56LCAwKTsKICAgICAgICBidWZmZXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChidWZmZXIsIDApOwogICAgICAgIGNvbnN0IHNxdWFyZWRYT3ZlclNxdWFyZWRaID0gdGhpcy5fc3F1YXJlZFhPdmVyU3F1YXJlZFo7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IDA7CiAgICAgICAgcmVzdWx0LnkgPSAwOwogICAgICAgIHJlc3VsdC56ID0gcG9zaXRpb24ueiAqICgxIC0gc3F1YXJlZFhPdmVyU3F1YXJlZFopOwogICAgICAgIGlmIChNYXRoLmFicyhyZXN1bHQueikgPj0gdGhpcy5fcmFkaWkueiAtIGJ1ZmZlcikgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEVuZHBvaW50ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBFbGxpcHNvaWQucHJvdG90eXBlLmdldExvY2FsQ3VydmF0dXJlID0gZnVuY3Rpb24oc3VyZmFjZVBvc2l0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN1cmZhY2VQb3NpdGlvbiIsIHN1cmZhY2VQb3NpdGlvbik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwcmltZVZlcnRpY2FsRW5kcG9pbnQgPSB0aGlzLmdldFN1cmZhY2VOb3JtYWxJbnRlcnNlY3Rpb25XaXRoWkF4aXMoCiAgICAgICAgICBzdXJmYWNlUG9zaXRpb24sCiAgICAgICAgICAwLAogICAgICAgICAgc2NyYXRjaEVuZHBvaW50CiAgICAgICAgKTsKICAgICAgICBjb25zdCBwcmltZVZlcnRpY2FsUmFkaXVzID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKAogICAgICAgICAgc3VyZmFjZVBvc2l0aW9uLAogICAgICAgICAgcHJpbWVWZXJ0aWNhbEVuZHBvaW50CiAgICAgICAgKTsKICAgICAgICBjb25zdCByYWRpdXNSYXRpbyA9IHRoaXMubWluaW11bVJhZGl1cyAqIHByaW1lVmVydGljYWxSYWRpdXMgLyB0aGlzLm1heGltdW1SYWRpdXMgKiogMjsKICAgICAgICBjb25zdCBtZXJpZGlvbmFsUmFkaXVzID0gcHJpbWVWZXJ0aWNhbFJhZGl1cyAqIHJhZGl1c1JhdGlvICoqIDI7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgICAgICAxIC8gcHJpbWVWZXJ0aWNhbFJhZGl1cywKICAgICAgICAgIDEgLyBtZXJpZGlvbmFsUmFkaXVzLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgYWJzY2lzc2FzID0gWwogICAgICAgIDAuMTQ4ODc0MzM4OTgxNjMsCiAgICAgICAgMC40MzMzOTUzOTQxMjkyNSwKICAgICAgICAwLjY3OTQwOTU2ODI5OTAyLAogICAgICAgIDAuODY1MDYzMzY2Njg4OTgsCiAgICAgICAgMC45NzM5MDY1Mjg1MTcxNywKICAgICAgICAwCiAgICAgIF07CiAgICAgIHdlaWdodHMgPSBbCiAgICAgICAgMC4yOTU1MjQyMjQ3MTQ3NSwKICAgICAgICAwLjI2OTI2NjcxOTMwOTk5LAogICAgICAgIDAuMjE5MDg2MzYyNTE1OTgsCiAgICAgICAgMC4xNDk0NTEzNDkxNTA1OCwKICAgICAgICAwLjA2NjY3MTM0NDMwODY4NCwKICAgICAgICAwCiAgICAgIF07CiAgICAgIEVsbGlwc29pZC5wcm90b3R5cGUuc3VyZmFjZUFyZWEgPSBmdW5jdGlvbihyZWN0YW5nbGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgY29uc3QgbWluTG9uZ2l0dWRlID0gcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgbGV0IG1heExvbmdpdHVkZSA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIGNvbnN0IG1pbkxhdGl0dWRlID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgICAgIGNvbnN0IG1heExhdGl0dWRlID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgICAgIHdoaWxlIChtYXhMb25naXR1ZGUgPCBtaW5Mb25naXR1ZGUpIHsKICAgICAgICAgIG1heExvbmdpdHVkZSArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0KICAgICAgICBjb25zdCByYWRpaVNxdWFyZWQgPSB0aGlzLl9yYWRpaVNxdWFyZWQ7CiAgICAgICAgY29uc3QgYTIyID0gcmFkaWlTcXVhcmVkLng7CiAgICAgICAgY29uc3QgYjIgPSByYWRpaVNxdWFyZWQueTsKICAgICAgICBjb25zdCBjMiA9IHJhZGlpU3F1YXJlZC56OwogICAgICAgIGNvbnN0IGEyYjIgPSBhMjIgKiBiMjsKICAgICAgICByZXR1cm4gZ2F1c3NMZWdlbmRyZVF1YWRyYXR1cmUobWluTGF0aXR1ZGUsIG1heExhdGl0dWRlLCBmdW5jdGlvbihsYXQpIHsKICAgICAgICAgIGNvbnN0IHNpblBoaSA9IE1hdGguY29zKGxhdCk7CiAgICAgICAgICBjb25zdCBjb3NQaGkgPSBNYXRoLnNpbihsYXQpOwogICAgICAgICAgcmV0dXJuIE1hdGguY29zKGxhdCkgKiBnYXVzc0xlZ2VuZHJlUXVhZHJhdHVyZShtaW5Mb25naXR1ZGUsIG1heExvbmdpdHVkZSwgZnVuY3Rpb24obG9uKSB7CiAgICAgICAgICAgIGNvbnN0IGNvc1RoZXRhID0gTWF0aC5jb3MobG9uKTsKICAgICAgICAgICAgY29uc3Qgc2luVGhldGEgPSBNYXRoLnNpbihsb24pOwogICAgICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KAogICAgICAgICAgICAgIGEyYjIgKiBjb3NQaGkgKiBjb3NQaGkgKyBjMiAqIChiMiAqIGNvc1RoZXRhICogY29zVGhldGEgKyBhMjIgKiBzaW5UaGV0YSAqIHNpblRoZXRhKSAqIHNpblBoaSAqIHNpblBoaQogICAgICAgICAgICApOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZF9kZWZhdWx0ID0gRWxsaXBzb2lkOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvZ3JhcGhpY1Byb2plY3Rpb24uanMKICBmdW5jdGlvbiBHZW9ncmFwaGljUHJvamVjdGlvbihlbGxpcHNvaWQpIHsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgdGhpcy5fc2VtaW1ham9yQXhpcyA9IHRoaXMuX2VsbGlwc29pZC5tYXhpbXVtUmFkaXVzOwogICAgdGhpcy5fb25lT3ZlclNlbWltYWpvckF4aXMgPSAxIC8gdGhpcy5fc2VtaW1ham9yQXhpczsKICB9CiAgdmFyIEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQ7CiAgdmFyIGluaXRfR2VvZ3JhcGhpY1Byb2plY3Rpb24gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb2dyYXBoaWNQcm9qZWN0aW9uLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEdlb2dyYXBoaWNQcm9qZWN0aW9uLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHtAbGluayBFbGxpcHNvaWR9LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIEdlb2dyYXBoaWNQcm9qZWN0aW9uLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgR2VvZ3JhcGhpY1Byb2plY3Rpb24ucHJvdG90eXBlLnByb2plY3QgPSBmdW5jdGlvbihjYXJ0b2dyYXBoaWMyLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBzZW1pbWFqb3JBeGlzID0gdGhpcy5fc2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCB4ID0gY2FydG9ncmFwaGljMi5sb25naXR1ZGUgKiBzZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IHkgPSBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlICogc2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCB6ID0gY2FydG9ncmFwaGljMi5oZWlnaHQ7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgeSwgeik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEdlb2dyYXBoaWNQcm9qZWN0aW9uLnByb3RvdHlwZS51bnByb2plY3QgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydGVzaWFuMTEpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2FydGVzaWFuIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG9uZU92ZXJFYXJ0aFNlbWltYWpvckF4aXMgPSB0aGlzLl9vbmVPdmVyU2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCBsb25naXR1ZGUgPSBjYXJ0ZXNpYW4xMS54ICogb25lT3ZlckVhcnRoU2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IGNhcnRlc2lhbjExLnkgKiBvbmVPdmVyRWFydGhTZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IGhlaWdodCA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQubG9uZ2l0dWRlID0gbG9uZ2l0dWRlOwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IGxhdGl0dWRlOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgR2VvZ3JhcGhpY1Byb2plY3Rpb25fZGVmYXVsdCA9IEdlb2dyYXBoaWNQcm9qZWN0aW9uOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSW50ZXJzZWN0LmpzCiAgdmFyIEludGVyc2VjdCwgSW50ZXJzZWN0X2RlZmF1bHQ7CiAgdmFyIGluaXRfSW50ZXJzZWN0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbnRlcnNlY3QuanMiKCkgewogICAgICBJbnRlcnNlY3QgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogUmVwcmVzZW50cyB0aGF0IGFuIG9iamVjdCBpcyBub3QgY29udGFpbmVkIHdpdGhpbiB0aGUgZnJ1c3R1bS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgT1VUU0lERTogLTEsCiAgICAgICAgLyoqCiAgICAgICAgICogUmVwcmVzZW50cyB0aGF0IGFuIG9iamVjdCBpbnRlcnNlY3RzIG9uZSBvZiB0aGUgZnJ1c3R1bSdzIHBsYW5lcy4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgSU5URVJTRUNUSU5HOiAwLAogICAgICAgIC8qKgogICAgICAgICAqIFJlcHJlc2VudHMgdGhhdCBhbiBvYmplY3QgaXMgZnVsbHkgd2l0aGluIHRoZSBmcnVzdHVtLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBJTlNJREU6IDEKICAgICAgfTsKICAgICAgSW50ZXJzZWN0X2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKEludGVyc2VjdCk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbnRlcnZhbC5qcwogIGZ1bmN0aW9uIEludGVydmFsKHN0YXJ0LCBzdG9wKSB7CiAgICB0aGlzLnN0YXJ0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnQsIDApOwogICAgdGhpcy5zdG9wID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RvcCwgMCk7CiAgfQogIHZhciBJbnRlcnZhbF9kZWZhdWx0OwogIHZhciBpbml0X0ludGVydmFsID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbnRlcnZhbC5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIEludGVydmFsX2RlZmF1bHQgPSBJbnRlcnZhbDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL01hdHJpeDMuanMKICBmdW5jdGlvbiBNYXRyaXgzKGNvbHVtbjBSb3cwLCBjb2x1bW4xUm93MCwgY29sdW1uMlJvdzAsIGNvbHVtbjBSb3cxLCBjb2x1bW4xUm93MSwgY29sdW1uMlJvdzEsIGNvbHVtbjBSb3cyLCBjb2x1bW4xUm93MiwgY29sdW1uMlJvdzIpIHsKICAgIHRoaXNbMF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4wUm93MCwgMCk7CiAgICB0aGlzWzFdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMFJvdzEsIDApOwogICAgdGhpc1syXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjBSb3cyLCAwKTsKICAgIHRoaXNbM10gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4xUm93MCwgMCk7CiAgICB0aGlzWzRdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMVJvdzEsIDApOwogICAgdGhpc1s1XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjFSb3cyLCAwKTsKICAgIHRoaXNbNl0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4yUm93MCwgMCk7CiAgICB0aGlzWzddID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMlJvdzEsIDApOwogICAgdGhpc1s4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjJSb3cyLCAwKTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUZyb2Jlbml1c05vcm0obWF0cml4KSB7CiAgICBsZXQgbm9ybSA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDk7ICsraSkgewogICAgICBjb25zdCB0ZW1wID0gbWF0cml4W2ldOwogICAgICBub3JtICs9IHRlbXAgKiB0ZW1wOwogICAgfQogICAgcmV0dXJuIE1hdGguc3FydChub3JtKTsKICB9CiAgZnVuY3Rpb24gb2ZmRGlhZ29uYWxGcm9iZW5pdXNOb3JtKG1hdHJpeCkgewogICAgbGV0IG5vcm0gPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCAzOyArK2kpIHsKICAgICAgY29uc3QgdGVtcCA9IG1hdHJpeFtNYXRyaXgzLmdldEVsZW1lbnRJbmRleChjb2xWYWxbaV0sIHJvd1ZhbFtpXSldOwogICAgICBub3JtICs9IDIgKiB0ZW1wICogdGVtcDsKICAgIH0KICAgIHJldHVybiBNYXRoLnNxcnQobm9ybSk7CiAgfQogIGZ1bmN0aW9uIHNodXJEZWNvbXBvc2l0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICBjb25zdCB0b2xlcmFuY2UgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1OwogICAgbGV0IG1heERpYWdvbmFsID0gMDsKICAgIGxldCByb3RBeGlzMiA9IDE7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDM7ICsraSkgewogICAgICBjb25zdCB0ZW1wID0gTWF0aC5hYnMoCiAgICAgICAgbWF0cml4W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KGNvbFZhbFtpXSwgcm93VmFsW2ldKV0KICAgICAgKTsKICAgICAgaWYgKHRlbXAgPiBtYXhEaWFnb25hbCkgewogICAgICAgIHJvdEF4aXMyID0gaTsKICAgICAgICBtYXhEaWFnb25hbCA9IHRlbXA7CiAgICAgIH0KICAgIH0KICAgIGxldCBjID0gMTsKICAgIGxldCBzID0gMDsKICAgIGNvbnN0IHAgPSByb3dWYWxbcm90QXhpczJdOwogICAgY29uc3QgcSA9IGNvbFZhbFtyb3RBeGlzMl07CiAgICBpZiAoTWF0aC5hYnMobWF0cml4W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KHEsIHApXSkgPiB0b2xlcmFuY2UpIHsKICAgICAgY29uc3QgcXEgPSBtYXRyaXhbTWF0cml4My5nZXRFbGVtZW50SW5kZXgocSwgcSldOwogICAgICBjb25zdCBwcCA9IG1hdHJpeFtNYXRyaXgzLmdldEVsZW1lbnRJbmRleChwLCBwKV07CiAgICAgIGNvbnN0IHFwID0gbWF0cml4W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KHEsIHApXTsKICAgICAgY29uc3QgdGF1ID0gKHFxIC0gcHApIC8gMiAvIHFwOwogICAgICBsZXQgdDsKICAgICAgaWYgKHRhdSA8IDApIHsKICAgICAgICB0ID0gLTEgLyAoLXRhdSArIE1hdGguc3FydCgxICsgdGF1ICogdGF1KSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdCA9IDEgLyAodGF1ICsgTWF0aC5zcXJ0KDEgKyB0YXUgKiB0YXUpKTsKICAgICAgfQogICAgICBjID0gMSAvIE1hdGguc3FydCgxICsgdCAqIHQpOwogICAgICBzID0gdCAqIGM7CiAgICB9CiAgICByZXN1bHQgPSBNYXRyaXgzLmNsb25lKE1hdHJpeDMuSURFTlRJVFksIHJlc3VsdCk7CiAgICByZXN1bHRbTWF0cml4My5nZXRFbGVtZW50SW5kZXgocCwgcCldID0gcmVzdWx0W01hdHJpeDMuZ2V0RWxlbWVudEluZGV4KHEsIHEpXSA9IGM7CiAgICByZXN1bHRbTWF0cml4My5nZXRFbGVtZW50SW5kZXgocSwgcCldID0gczsKICAgIHJlc3VsdFtNYXRyaXgzLmdldEVsZW1lbnRJbmRleChwLCBxKV0gPSAtczsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBzY2FsZVNjcmF0Y2gxLCBzY2FsZVNjcmF0Y2gyLCBzY3JhdGNoQ29sdW1uLCBzY2FsZVNjcmF0Y2gzLCBzY2FsZVNjcmF0Y2g0LCBzY2FsZVNjcmF0Y2g1LCByb3dWYWwsIGNvbFZhbCwgak1hdHJpeCwgak1hdHJpeFRyYW5zcG9zZSwgc2NyYXRjaFRyYW5zcG9zZU1hdHJpeCwgTWF0cml4M19kZWZhdWx0OwogIHZhciBpbml0X01hdHJpeDMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL01hdHJpeDMuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgTWF0cml4My5wYWNrZWRMZW5ndGggPSA5OwogICAgICBNYXRyaXgzLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVswXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMV07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzJdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVszXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbNF07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzVdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVs2XTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbN107CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzhdOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgTWF0cml4My51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE1hdHJpeDMoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbMV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsyXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzNdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbNF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs1XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzZdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbN10gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs4XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgY29uc3QgcmVzdWx0TGVuZ3RoID0gbGVuZ3RoICogOTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkocmVzdWx0TGVuZ3RoKTsKICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdCkgJiYgcmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIklmIHJlc3VsdCBpcyBhIHR5cGVkIGFycmF5LCBpdCBtdXN0IGhhdmUgZXhhY3RseSBhcnJheS5sZW5ndGggKiA5IGVsZW1lbnRzIgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IHJlc3VsdExlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgTWF0cml4My5wYWNrKGFycmF5W2ldLCByZXN1bHQsIGkgKiA5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My51bnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJhcnJheS5sZW5ndGgiLCBhcnJheS5sZW5ndGgsIDkpOwogICAgICAgIGlmIChhcnJheS5sZW5ndGggJSA5ICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA5LiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCAvIDkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gOTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gOSkgewogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gOTsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBNYXRyaXgzLnVucGFjayhhcnJheSwgaSwgcmVzdWx0W2luZGV4XSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuY2xvbmUgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG1hdHJpeCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MygKICAgICAgICAgICAgbWF0cml4WzBdLAogICAgICAgICAgICBtYXRyaXhbM10sCiAgICAgICAgICAgIG1hdHJpeFs2XSwKICAgICAgICAgICAgbWF0cml4WzFdLAogICAgICAgICAgICBtYXRyaXhbNF0sCiAgICAgICAgICAgIG1hdHJpeFs3XSwKICAgICAgICAgICAgbWF0cml4WzJdLAogICAgICAgICAgICBtYXRyaXhbNV0sCiAgICAgICAgICAgIG1hdHJpeFs4XQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV07CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tQXJyYXkgPSBNYXRyaXgzLnVucGFjazsKICAgICAgTWF0cml4My5mcm9tQ29sdW1uTWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIHJldHVybiBNYXRyaXgzLmNsb25lKHZhbHVlcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tUm93TWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MygKICAgICAgICAgICAgdmFsdWVzWzBdLAogICAgICAgICAgICB2YWx1ZXNbMV0sCiAgICAgICAgICAgIHZhbHVlc1syXSwKICAgICAgICAgICAgdmFsdWVzWzNdLAogICAgICAgICAgICB2YWx1ZXNbNF0sCiAgICAgICAgICAgIHZhbHVlc1s1XSwKICAgICAgICAgICAgdmFsdWVzWzZdLAogICAgICAgICAgICB2YWx1ZXNbN10sCiAgICAgICAgICAgIHZhbHVlc1s4XQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gdmFsdWVzWzBdOwogICAgICAgIHJlc3VsdFsxXSA9IHZhbHVlc1szXTsKICAgICAgICByZXN1bHRbMl0gPSB2YWx1ZXNbNl07CiAgICAgICAgcmVzdWx0WzNdID0gdmFsdWVzWzFdOwogICAgICAgIHJlc3VsdFs0XSA9IHZhbHVlc1s0XTsKICAgICAgICByZXN1bHRbNV0gPSB2YWx1ZXNbN107CiAgICAgICAgcmVzdWx0WzZdID0gdmFsdWVzWzJdOwogICAgICAgIHJlc3VsdFs3XSA9IHZhbHVlc1s1XTsKICAgICAgICByZXN1bHRbOF0gPSB2YWx1ZXNbOF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tUXVhdGVybmlvbiA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicXVhdGVybmlvbiIsIHF1YXRlcm5pb24pOwogICAgICAgIGNvbnN0IHgyID0gcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi54OwogICAgICAgIGNvbnN0IHh5ID0gcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi55OwogICAgICAgIGNvbnN0IHh6ID0gcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi56OwogICAgICAgIGNvbnN0IHh3ID0gcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi53OwogICAgICAgIGNvbnN0IHkyID0gcXVhdGVybmlvbi55ICogcXVhdGVybmlvbi55OwogICAgICAgIGNvbnN0IHl6ID0gcXVhdGVybmlvbi55ICogcXVhdGVybmlvbi56OwogICAgICAgIGNvbnN0IHl3ID0gcXVhdGVybmlvbi55ICogcXVhdGVybmlvbi53OwogICAgICAgIGNvbnN0IHoyID0gcXVhdGVybmlvbi56ICogcXVhdGVybmlvbi56OwogICAgICAgIGNvbnN0IHp3ID0gcXVhdGVybmlvbi56ICogcXVhdGVybmlvbi53OwogICAgICAgIGNvbnN0IHcyID0gcXVhdGVybmlvbi53ICogcXVhdGVybmlvbi53OwogICAgICAgIGNvbnN0IG0wMCA9IHgyIC0geTIgLSB6MiArIHcyOwogICAgICAgIGNvbnN0IG0wMSA9IDIgKiAoeHkgLSB6dyk7CiAgICAgICAgY29uc3QgbTAyID0gMiAqICh4eiArIHl3KTsKICAgICAgICBjb25zdCBtMTAgPSAyICogKHh5ICsgencpOwogICAgICAgIGNvbnN0IG0xMSA9IC14MiArIHkyIC0gejIgKyB3MjsKICAgICAgICBjb25zdCBtMTIgPSAyICogKHl6IC0geHcpOwogICAgICAgIGNvbnN0IG0yMCA9IDIgKiAoeHogLSB5dyk7CiAgICAgICAgY29uc3QgbTIxID0gMiAqICh5eiArIHh3KTsKICAgICAgICBjb25zdCBtMjIgPSAteDIgLSB5MiArIHoyICsgdzI7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgzKG0wMCwgbTAxLCBtMDIsIG0xMCwgbTExLCBtMTIsIG0yMCwgbTIxLCBtMjIpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtMDA7CiAgICAgICAgcmVzdWx0WzFdID0gbTEwOwogICAgICAgIHJlc3VsdFsyXSA9IG0yMDsKICAgICAgICByZXN1bHRbM10gPSBtMDE7CiAgICAgICAgcmVzdWx0WzRdID0gbTExOwogICAgICAgIHJlc3VsdFs1XSA9IG0yMTsKICAgICAgICByZXN1bHRbNl0gPSBtMDI7CiAgICAgICAgcmVzdWx0WzddID0gbTEyOwogICAgICAgIHJlc3VsdFs4XSA9IG0yMjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21IZWFkaW5nUGl0Y2hSb2xsID0gZnVuY3Rpb24oaGVhZGluZ1BpdGNoUm9sbCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJoZWFkaW5nUGl0Y2hSb2xsIiwgaGVhZGluZ1BpdGNoUm9sbCk7CiAgICAgICAgY29uc3QgY29zVGhldGEgPSBNYXRoLmNvcygtaGVhZGluZ1BpdGNoUm9sbC5waXRjaCk7CiAgICAgICAgY29uc3QgY29zUHNpID0gTWF0aC5jb3MoLWhlYWRpbmdQaXRjaFJvbGwuaGVhZGluZyk7CiAgICAgICAgY29uc3QgY29zUGhpID0gTWF0aC5jb3MoaGVhZGluZ1BpdGNoUm9sbC5yb2xsKTsKICAgICAgICBjb25zdCBzaW5UaGV0YSA9IE1hdGguc2luKC1oZWFkaW5nUGl0Y2hSb2xsLnBpdGNoKTsKICAgICAgICBjb25zdCBzaW5Qc2kgPSBNYXRoLnNpbigtaGVhZGluZ1BpdGNoUm9sbC5oZWFkaW5nKTsKICAgICAgICBjb25zdCBzaW5QaGkgPSBNYXRoLnNpbihoZWFkaW5nUGl0Y2hSb2xsLnJvbGwpOwogICAgICAgIGNvbnN0IG0wMCA9IGNvc1RoZXRhICogY29zUHNpOwogICAgICAgIGNvbnN0IG0wMSA9IC1jb3NQaGkgKiBzaW5Qc2kgKyBzaW5QaGkgKiBzaW5UaGV0YSAqIGNvc1BzaTsKICAgICAgICBjb25zdCBtMDIgPSBzaW5QaGkgKiBzaW5Qc2kgKyBjb3NQaGkgKiBzaW5UaGV0YSAqIGNvc1BzaTsKICAgICAgICBjb25zdCBtMTAgPSBjb3NUaGV0YSAqIHNpblBzaTsKICAgICAgICBjb25zdCBtMTEgPSBjb3NQaGkgKiBjb3NQc2kgKyBzaW5QaGkgKiBzaW5UaGV0YSAqIHNpblBzaTsKICAgICAgICBjb25zdCBtMTIgPSAtc2luUGhpICogY29zUHNpICsgY29zUGhpICogc2luVGhldGEgKiBzaW5Qc2k7CiAgICAgICAgY29uc3QgbTIwID0gLXNpblRoZXRhOwogICAgICAgIGNvbnN0IG0yMSA9IHNpblBoaSAqIGNvc1RoZXRhOwogICAgICAgIGNvbnN0IG0yMiA9IGNvc1BoaSAqIGNvc1RoZXRhOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MyhtMDAsIG0wMSwgbTAyLCBtMTAsIG0xMSwgbTEyLCBtMjAsIG0yMSwgbTIyKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gbTAwOwogICAgICAgIHJlc3VsdFsxXSA9IG0xMDsKICAgICAgICByZXN1bHRbMl0gPSBtMjA7CiAgICAgICAgcmVzdWx0WzNdID0gbTAxOwogICAgICAgIHJlc3VsdFs0XSA9IG0xMTsKICAgICAgICByZXN1bHRbNV0gPSBtMjE7CiAgICAgICAgcmVzdWx0WzZdID0gbTAyOwogICAgICAgIHJlc3VsdFs3XSA9IG0xMjsKICAgICAgICByZXN1bHRbOF0gPSBtMjI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tU2NhbGUgPSBmdW5jdGlvbihzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDMoc2NhbGUueCwgMCwgMCwgMCwgc2NhbGUueSwgMCwgMCwgMCwgc2NhbGUueik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gc2NhbGUueTsKICAgICAgICByZXN1bHRbNV0gPSAwOwogICAgICAgIHJlc3VsdFs2XSA9IDA7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSBzY2FsZS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZnJvbVVuaWZvcm1TY2FsZSA9IGZ1bmN0aW9uKHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MyhzY2FsZSwgMCwgMCwgMCwgc2NhbGUsIDAsIDAsIDAsIHNjYWxlKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gc2NhbGU7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gc2NhbGU7CiAgICAgICAgcmVzdWx0WzVdID0gMDsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gc2NhbGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5mcm9tQ3Jvc3NQcm9kdWN0ID0gZnVuY3Rpb24odmVjdG9yLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZlY3RvciIsIHZlY3Rvcik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgzKAogICAgICAgICAgICAwLAogICAgICAgICAgICAtdmVjdG9yLnosCiAgICAgICAgICAgIHZlY3Rvci55LAogICAgICAgICAgICB2ZWN0b3IueiwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgLXZlY3Rvci54LAogICAgICAgICAgICAtdmVjdG9yLnksCiAgICAgICAgICAgIHZlY3Rvci54LAogICAgICAgICAgICAwCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSAwOwogICAgICAgIHJlc3VsdFsxXSA9IHZlY3Rvci56OwogICAgICAgIHJlc3VsdFsyXSA9IC12ZWN0b3IueTsKICAgICAgICByZXN1bHRbM10gPSAtdmVjdG9yLno7CiAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICByZXN1bHRbNV0gPSB2ZWN0b3IueDsKICAgICAgICByZXN1bHRbNl0gPSB2ZWN0b3IueTsKICAgICAgICByZXN1bHRbN10gPSAtdmVjdG9yLng7CiAgICAgICAgcmVzdWx0WzhdID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21Sb3RhdGlvblggPSBmdW5jdGlvbihhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhbmdsZSIsIGFuZ2xlKTsKICAgICAgICBjb25zdCBjb3NBbmdsZSA9IE1hdGguY29zKGFuZ2xlKTsKICAgICAgICBjb25zdCBzaW5BbmdsZSA9IE1hdGguc2luKGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDMoCiAgICAgICAgICAgIDEsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIGNvc0FuZ2xlLAogICAgICAgICAgICAtc2luQW5nbGUsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIHNpbkFuZ2xlLAogICAgICAgICAgICBjb3NBbmdsZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gMTsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSBjb3NBbmdsZTsKICAgICAgICByZXN1bHRbNV0gPSBzaW5BbmdsZTsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IC1zaW5BbmdsZTsKICAgICAgICByZXN1bHRbOF0gPSBjb3NBbmdsZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21Sb3RhdGlvblkgPSBmdW5jdGlvbihhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhbmdsZSIsIGFuZ2xlKTsKICAgICAgICBjb25zdCBjb3NBbmdsZSA9IE1hdGguY29zKGFuZ2xlKTsKICAgICAgICBjb25zdCBzaW5BbmdsZSA9IE1hdGguc2luKGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDMoCiAgICAgICAgICAgIGNvc0FuZ2xlLAogICAgICAgICAgICAwLAogICAgICAgICAgICBzaW5BbmdsZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgLXNpbkFuZ2xlLAogICAgICAgICAgICAwLAogICAgICAgICAgICBjb3NBbmdsZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gY29zQW5nbGU7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAtc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSAxOwogICAgICAgIHJlc3VsdFs1XSA9IDA7CiAgICAgICAgcmVzdWx0WzZdID0gc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSBjb3NBbmdsZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmZyb21Sb3RhdGlvblogPSBmdW5jdGlvbihhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhbmdsZSIsIGFuZ2xlKTsKICAgICAgICBjb25zdCBjb3NBbmdsZSA9IE1hdGguY29zKGFuZ2xlKTsKICAgICAgICBjb25zdCBzaW5BbmdsZSA9IE1hdGguc2luKGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDMoCiAgICAgICAgICAgIGNvc0FuZ2xlLAogICAgICAgICAgICAtc2luQW5nbGUsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIHNpbkFuZ2xlLAogICAgICAgICAgICBjb3NBbmdsZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gY29zQW5nbGU7CiAgICAgICAgcmVzdWx0WzFdID0gc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAtc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzRdID0gY29zQW5nbGU7CiAgICAgICAgcmVzdWx0WzVdID0gMDsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnRvQXJyYXkgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICBtYXRyaXhbMF0sCiAgICAgICAgICAgIG1hdHJpeFsxXSwKICAgICAgICAgICAgbWF0cml4WzJdLAogICAgICAgICAgICBtYXRyaXhbM10sCiAgICAgICAgICAgIG1hdHJpeFs0XSwKICAgICAgICAgICAgbWF0cml4WzVdLAogICAgICAgICAgICBtYXRyaXhbNl0sCiAgICAgICAgICAgIG1hdHJpeFs3XSwKICAgICAgICAgICAgbWF0cml4WzhdCiAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmdldEVsZW1lbnRJbmRleCA9IGZ1bmN0aW9uKGNvbHVtbiwgcm93KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoInJvdyIsIHJvdywgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoInJvdyIsIHJvdywgMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImNvbHVtbiIsIGNvbHVtbiwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImNvbHVtbiIsIGNvbHVtbiwgMik7CiAgICAgICAgcmV0dXJuIGNvbHVtbiAqIDMgKyByb3c7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZ2V0Q29sdW1uID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBpbmRleCAqIDM7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFtzdGFydEluZGV4XTsKICAgICAgICBjb25zdCB5ID0gbWF0cml4W3N0YXJ0SW5kZXggKyAxXTsKICAgICAgICBjb25zdCB6ID0gbWF0cml4W3N0YXJ0SW5kZXggKyAyXTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnNldENvbHVtbiA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0ID0gTWF0cml4My5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogMzsKICAgICAgICByZXN1bHRbc3RhcnRJbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMV0gPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMl0gPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZ2V0Um93ID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbaW5kZXhdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbaW5kZXggKyAzXTsKICAgICAgICBjb25zdCB6ID0gbWF0cml4W2luZGV4ICsgNl07CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5zZXRSb3cgPSBmdW5jdGlvbihtYXRyaXgsIGluZGV4LCBjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdCA9IE1hdHJpeDMuY2xvbmUobWF0cml4LCByZXN1bHQpOwogICAgICAgIHJlc3VsdFtpbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtpbmRleCArIDNdID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHRbaW5kZXggKyA2XSA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4My5zZXRTY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCwgc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBleGlzdGluZ1NjYWxlID0gTWF0cml4My5nZXRTY2FsZShtYXRyaXgsIHNjYWxlU2NyYXRjaDEpOwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9YID0gc2NhbGUueCAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlLnkgLyBleGlzdGluZ1NjYWxlLnk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ogPSBzY2FsZS56IC8gZXhpc3RpbmdTY2FsZS56OwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDMuc2V0VW5pZm9ybVNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGV4aXN0aW5nU2NhbGUgPSBNYXRyaXgzLmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMik7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ggPSBzY2FsZSAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlIC8gZXhpc3RpbmdTY2FsZS55OwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9aID0gc2NhbGUgLyBleGlzdGluZ1NjYWxlLno7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdICogc2NhbGVSYXRpb1k7CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaENvbHVtbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4My5nZXRTY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKG1hdHJpeFswXSwgbWF0cml4WzFdLCBtYXRyaXhbMl0sIHNjcmF0Y2hDb2x1bW4pCiAgICAgICAgKTsKICAgICAgICByZXN1bHQueSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKG1hdHJpeFszXSwgbWF0cml4WzRdLCBtYXRyaXhbNV0sIHNjcmF0Y2hDb2x1bW4pCiAgICAgICAgKTsKICAgICAgICByZXN1bHQueiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKG1hdHJpeFs2XSwgbWF0cml4WzddLCBtYXRyaXhbOF0sIHNjcmF0Y2hDb2x1bW4pCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXgzLmdldE1heGltdW1TY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCkgewogICAgICAgIE1hdHJpeDMuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gzKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm1heGltdW1Db21wb25lbnQoc2NhbGVTY3JhdGNoMyk7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDMuc2V0Um90YXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHJvdGF0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHNjYWxlID0gTWF0cml4My5nZXRTY2FsZShtYXRyaXgsIHNjYWxlU2NyYXRjaDQpOwogICAgICAgIHJlc3VsdFswXSA9IHJvdGF0aW9uWzBdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSByb3RhdGlvblsxXSAqIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzJdID0gcm90YXRpb25bMl0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFszXSA9IHJvdGF0aW9uWzNdICogc2NhbGUueTsKICAgICAgICByZXN1bHRbNF0gPSByb3RhdGlvbls0XSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzVdID0gcm90YXRpb25bNV0gKiBzY2FsZS55OwogICAgICAgIHJlc3VsdFs2XSA9IHJvdGF0aW9uWzZdICogc2NhbGUuejsKICAgICAgICByZXN1bHRbN10gPSByb3RhdGlvbls3XSAqIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzhdID0gcm90YXRpb25bOF0gKiBzY2FsZS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDMuZ2V0Um90YXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc2NhbGUgPSBNYXRyaXgzLmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoNSk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdIC8gc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gLyBzY2FsZS54OwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAvIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdIC8gc2NhbGUueTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gLyBzY2FsZS55OwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAvIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdIC8gc2NhbGUuejsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN10gLyBzY2FsZS56OwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XSAvIHNjYWxlLno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5tdWx0aXBseSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IGxlZnRbMF0gKiByaWdodFswXSArIGxlZnRbM10gKiByaWdodFsxXSArIGxlZnRbNl0gKiByaWdodFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MSA9IGxlZnRbMV0gKiByaWdodFswXSArIGxlZnRbNF0gKiByaWdodFsxXSArIGxlZnRbN10gKiByaWdodFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MiA9IGxlZnRbMl0gKiByaWdodFswXSArIGxlZnRbNV0gKiByaWdodFsxXSArIGxlZnRbOF0gKiByaWdodFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MCA9IGxlZnRbMF0gKiByaWdodFszXSArIGxlZnRbM10gKiByaWdodFs0XSArIGxlZnRbNl0gKiByaWdodFs1XTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IGxlZnRbMV0gKiByaWdodFszXSArIGxlZnRbNF0gKiByaWdodFs0XSArIGxlZnRbN10gKiByaWdodFs1XTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MiA9IGxlZnRbMl0gKiByaWdodFszXSArIGxlZnRbNV0gKiByaWdodFs0XSArIGxlZnRbOF0gKiByaWdodFs1XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IGxlZnRbMF0gKiByaWdodFs2XSArIGxlZnRbM10gKiByaWdodFs3XSArIGxlZnRbNl0gKiByaWdodFs4XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MSA9IGxlZnRbMV0gKiByaWdodFs2XSArIGxlZnRbNF0gKiByaWdodFs3XSArIGxlZnRbN10gKiByaWdodFs4XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MiA9IGxlZnRbMl0gKiByaWdodFs2XSArIGxlZnRbNV0gKiByaWdodFs3XSArIGxlZnRbOF0gKiByaWdodFs4XTsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSBjb2x1bW4wUm93MTsKICAgICAgICByZXN1bHRbMl0gPSBjb2x1bW4wUm93MjsKICAgICAgICByZXN1bHRbM10gPSBjb2x1bW4xUm93MDsKICAgICAgICByZXN1bHRbNF0gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXN1bHRbNV0gPSBjb2x1bW4xUm93MjsKICAgICAgICByZXN1bHRbNl0gPSBjb2x1bW4yUm93MDsKICAgICAgICByZXN1bHRbN10gPSBjb2x1bW4yUm93MTsKICAgICAgICByZXN1bHRbOF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLmFkZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBsZWZ0WzBdICsgcmlnaHRbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbGVmdFsxXSArIHJpZ2h0WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IGxlZnRbMl0gKyByaWdodFsyXTsKICAgICAgICByZXN1bHRbM10gPSBsZWZ0WzNdICsgcmlnaHRbM107CiAgICAgICAgcmVzdWx0WzRdID0gbGVmdFs0XSArIHJpZ2h0WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IGxlZnRbNV0gKyByaWdodFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBsZWZ0WzZdICsgcmlnaHRbNl07CiAgICAgICAgcmVzdWx0WzddID0gbGVmdFs3XSArIHJpZ2h0WzddOwogICAgICAgIHJlc3VsdFs4XSA9IGxlZnRbOF0gKyByaWdodFs4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnN1YnRyYWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IGxlZnRbMF0gLSByaWdodFswXTsKICAgICAgICByZXN1bHRbMV0gPSBsZWZ0WzFdIC0gcmlnaHRbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbGVmdFsyXSAtIHJpZ2h0WzJdOwogICAgICAgIHJlc3VsdFszXSA9IGxlZnRbM10gLSByaWdodFszXTsKICAgICAgICByZXN1bHRbNF0gPSBsZWZ0WzRdIC0gcmlnaHRbNF07CiAgICAgICAgcmVzdWx0WzVdID0gbGVmdFs1XSAtIHJpZ2h0WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IGxlZnRbNl0gLSByaWdodFs2XTsKICAgICAgICByZXN1bHRbN10gPSBsZWZ0WzddIC0gcmlnaHRbN107CiAgICAgICAgcmVzdWx0WzhdID0gbGVmdFs4XSAtIHJpZ2h0WzhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMubXVsdGlwbHlCeVZlY3RvciA9IGZ1bmN0aW9uKG1hdHJpeCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdlggPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIGNvbnN0IHZZID0gY2FydGVzaWFuMTEueTsKICAgICAgICBjb25zdCB2WiA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFswXSAqIHZYICsgbWF0cml4WzNdICogdlkgKyBtYXRyaXhbNl0gKiB2WjsKICAgICAgICBjb25zdCB5ID0gbWF0cml4WzFdICogdlggKyBtYXRyaXhbNF0gKiB2WSArIG1hdHJpeFs3XSAqIHZaOwogICAgICAgIGNvbnN0IHogPSBtYXRyaXhbMl0gKiB2WCArIG1hdHJpeFs1XSAqIHZZICsgbWF0cml4WzhdICogdlo7CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4My5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24obWF0cml4LCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN10gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdICogc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMubXVsdGlwbHlCeVNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdICogc2NhbGUueTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV0gKiBzY2FsZS55OwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddICogc2NhbGUuejsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsZS56OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMubXVsdGlwbHlCeVVuaWZvcm1TY2FsZSA9IGZ1bmN0aW9uKG1hdHJpeCwgc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gKiBzY2FsZTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN10gKiBzY2FsZTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLm5lZ2F0ZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSAtbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IC1tYXRyaXhbMV07CiAgICAgICAgcmVzdWx0WzJdID0gLW1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSAtbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IC1tYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzVdID0gLW1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSAtbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IC1tYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gLW1hdHJpeFs4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgzLnRyYW5zcG9zZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IG1hdHJpeFswXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MSA9IG1hdHJpeFszXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MiA9IG1hdHJpeFs2XTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MCA9IG1hdHJpeFsxXTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IG1hdHJpeFs0XTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MiA9IG1hdHJpeFs3XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MSA9IG1hdHJpeFs1XTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MiA9IG1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSBjb2x1bW4wUm93MTsKICAgICAgICByZXN1bHRbMl0gPSBjb2x1bW4wUm93MjsKICAgICAgICByZXN1bHRbM10gPSBjb2x1bW4xUm93MDsKICAgICAgICByZXN1bHRbNF0gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXN1bHRbNV0gPSBjb2x1bW4xUm93MjsKICAgICAgICByZXN1bHRbNl0gPSBjb2x1bW4yUm93MDsKICAgICAgICByZXN1bHRbN10gPSBjb2x1bW4yUm93MTsKICAgICAgICByZXN1bHRbOF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICByb3dWYWwgPSBbMSwgMCwgMF07CiAgICAgIGNvbFZhbCA9IFsyLCAyLCAxXTsKICAgICAgak1hdHJpeCA9IG5ldyBNYXRyaXgzKCk7CiAgICAgIGpNYXRyaXhUcmFuc3Bvc2UgPSBuZXcgTWF0cml4MygpOwogICAgICBNYXRyaXgzLmNvbXB1dGVFaWdlbkRlY29tcG9zaXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBjb25zdCB0b2xlcmFuY2UgPSBNYXRoX2RlZmF1bHQuRVBTSUxPTjIwOwogICAgICAgIGNvbnN0IG1heFN3ZWVwcyA9IDEwOwogICAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgICAgbGV0IHN3ZWVwID0gMDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSB7fTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdW5pdGFyeU1hdHJpeCA9IHJlc3VsdC51bml0YXJ5ID0gTWF0cml4My5jbG9uZSgKICAgICAgICAgIE1hdHJpeDMuSURFTlRJVFksCiAgICAgICAgICByZXN1bHQudW5pdGFyeQogICAgICAgICk7CiAgICAgICAgY29uc3QgZGlhZ01hdHJpeCA9IHJlc3VsdC5kaWFnb25hbCA9IE1hdHJpeDMuY2xvbmUobWF0cml4LCByZXN1bHQuZGlhZ29uYWwpOwogICAgICAgIGNvbnN0IGVwc2lsb24gPSB0b2xlcmFuY2UgKiBjb21wdXRlRnJvYmVuaXVzTm9ybShkaWFnTWF0cml4KTsKICAgICAgICB3aGlsZSAoc3dlZXAgPCBtYXhTd2VlcHMgJiYgb2ZmRGlhZ29uYWxGcm9iZW5pdXNOb3JtKGRpYWdNYXRyaXgpID4gZXBzaWxvbikgewogICAgICAgICAgc2h1ckRlY29tcG9zaXRpb24oZGlhZ01hdHJpeCwgak1hdHJpeCk7CiAgICAgICAgICBNYXRyaXgzLnRyYW5zcG9zZShqTWF0cml4LCBqTWF0cml4VHJhbnNwb3NlKTsKICAgICAgICAgIE1hdHJpeDMubXVsdGlwbHkoZGlhZ01hdHJpeCwgak1hdHJpeCwgZGlhZ01hdHJpeCk7CiAgICAgICAgICBNYXRyaXgzLm11bHRpcGx5KGpNYXRyaXhUcmFuc3Bvc2UsIGRpYWdNYXRyaXgsIGRpYWdNYXRyaXgpOwogICAgICAgICAgTWF0cml4My5tdWx0aXBseSh1bml0YXJ5TWF0cml4LCBqTWF0cml4LCB1bml0YXJ5TWF0cml4KTsKICAgICAgICAgIGlmICgrK2NvdW50ID4gMikgewogICAgICAgICAgICArK3N3ZWVwOwogICAgICAgICAgICBjb3VudCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuYWJzID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IE1hdGguYWJzKG1hdHJpeFswXSk7CiAgICAgICAgcmVzdWx0WzFdID0gTWF0aC5hYnMobWF0cml4WzFdKTsKICAgICAgICByZXN1bHRbMl0gPSBNYXRoLmFicyhtYXRyaXhbMl0pOwogICAgICAgIHJlc3VsdFszXSA9IE1hdGguYWJzKG1hdHJpeFszXSk7CiAgICAgICAgcmVzdWx0WzRdID0gTWF0aC5hYnMobWF0cml4WzRdKTsKICAgICAgICByZXN1bHRbNV0gPSBNYXRoLmFicyhtYXRyaXhbNV0pOwogICAgICAgIHJlc3VsdFs2XSA9IE1hdGguYWJzKG1hdHJpeFs2XSk7CiAgICAgICAgcmVzdWx0WzddID0gTWF0aC5hYnMobWF0cml4WzddKTsKICAgICAgICByZXN1bHRbOF0gPSBNYXRoLmFicyhtYXRyaXhbOF0pOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDMuZGV0ZXJtaW5hbnQgPSBmdW5jdGlvbihtYXRyaXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgY29uc3QgbTExID0gbWF0cml4WzBdOwogICAgICAgIGNvbnN0IG0yMSA9IG1hdHJpeFszXTsKICAgICAgICBjb25zdCBtMzEgPSBtYXRyaXhbNl07CiAgICAgICAgY29uc3QgbTEyID0gbWF0cml4WzFdOwogICAgICAgIGNvbnN0IG0yMiA9IG1hdHJpeFs0XTsKICAgICAgICBjb25zdCBtMzIgPSBtYXRyaXhbN107CiAgICAgICAgY29uc3QgbTEzID0gbWF0cml4WzJdOwogICAgICAgIGNvbnN0IG0yMyA9IG1hdHJpeFs1XTsKICAgICAgICBjb25zdCBtMzMgPSBtYXRyaXhbOF07CiAgICAgICAgcmV0dXJuIG0xMSAqIChtMjIgKiBtMzMgLSBtMjMgKiBtMzIpICsgbTEyICogKG0yMyAqIG0zMSAtIG0yMSAqIG0zMykgKyBtMTMgKiAobTIxICogbTMyIC0gbTIyICogbTMxKTsKICAgICAgfTsKICAgICAgTWF0cml4My5pbnZlcnNlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IG0xMSA9IG1hdHJpeFswXTsKICAgICAgICBjb25zdCBtMjEgPSBtYXRyaXhbMV07CiAgICAgICAgY29uc3QgbTMxID0gbWF0cml4WzJdOwogICAgICAgIGNvbnN0IG0xMiA9IG1hdHJpeFszXTsKICAgICAgICBjb25zdCBtMjIgPSBtYXRyaXhbNF07CiAgICAgICAgY29uc3QgbTMyID0gbWF0cml4WzVdOwogICAgICAgIGNvbnN0IG0xMyA9IG1hdHJpeFs2XTsKICAgICAgICBjb25zdCBtMjMgPSBtYXRyaXhbN107CiAgICAgICAgY29uc3QgbTMzID0gbWF0cml4WzhdOwogICAgICAgIGNvbnN0IGRldGVybWluYW50ID0gTWF0cml4My5kZXRlcm1pbmFudChtYXRyaXgpOwogICAgICAgIGlmIChNYXRoLmFicyhkZXRlcm1pbmFudCkgPD0gTWF0aF9kZWZhdWx0LkVQU0lMT04xNSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm1hdHJpeCBpcyBub3QgaW52ZXJ0aWJsZSIpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtMjIgKiBtMzMgLSBtMjMgKiBtMzI7CiAgICAgICAgcmVzdWx0WzFdID0gbTIzICogbTMxIC0gbTIxICogbTMzOwogICAgICAgIHJlc3VsdFsyXSA9IG0yMSAqIG0zMiAtIG0yMiAqIG0zMTsKICAgICAgICByZXN1bHRbM10gPSBtMTMgKiBtMzIgLSBtMTIgKiBtMzM7CiAgICAgICAgcmVzdWx0WzRdID0gbTExICogbTMzIC0gbTEzICogbTMxOwogICAgICAgIHJlc3VsdFs1XSA9IG0xMiAqIG0zMSAtIG0xMSAqIG0zMjsKICAgICAgICByZXN1bHRbNl0gPSBtMTIgKiBtMjMgLSBtMTMgKiBtMjI7CiAgICAgICAgcmVzdWx0WzddID0gbTEzICogbTIxIC0gbTExICogbTIzOwogICAgICAgIHJlc3VsdFs4XSA9IG0xMSAqIG0yMiAtIG0xMiAqIG0yMTsKICAgICAgICBjb25zdCBzY2FsZSA9IDEgLyBkZXRlcm1pbmFudDsKICAgICAgICByZXR1cm4gTWF0cml4My5tdWx0aXBseUJ5U2NhbGFyKHJlc3VsdCwgc2NhbGUsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hUcmFuc3Bvc2VNYXRyaXggPSBuZXcgTWF0cml4MygpOwogICAgICBNYXRyaXgzLmludmVyc2VUcmFuc3Bvc2UgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIE1hdHJpeDMuaW52ZXJzZSgKICAgICAgICAgIE1hdHJpeDMudHJhbnNwb3NlKG1hdHJpeCwgc2NyYXRjaFRyYW5zcG9zZU1hdHJpeCksCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBNYXRyaXgzLmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIGxlZnRbMF0gPT09IHJpZ2h0WzBdICYmIGxlZnRbMV0gPT09IHJpZ2h0WzFdICYmIGxlZnRbMl0gPT09IHJpZ2h0WzJdICYmIGxlZnRbM10gPT09IHJpZ2h0WzNdICYmIGxlZnRbNF0gPT09IHJpZ2h0WzRdICYmIGxlZnRbNV0gPT09IHJpZ2h0WzVdICYmIGxlZnRbNl0gPT09IHJpZ2h0WzZdICYmIGxlZnRbN10gPT09IHJpZ2h0WzddICYmIGxlZnRbOF0gPT09IHJpZ2h0WzhdOwogICAgICB9OwogICAgICBNYXRyaXgzLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgZXBzaWxvbikgewogICAgICAgIGVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlcHNpbG9uLCAwKTsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aC5hYnMobGVmdFswXSAtIHJpZ2h0WzBdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMV0gLSByaWdodFsxXSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzJdIC0gcmlnaHRbMl0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFszXSAtIHJpZ2h0WzNdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbNF0gLSByaWdodFs0XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzVdIC0gcmlnaHRbNV0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFs2XSAtIHJpZ2h0WzZdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbN10gLSByaWdodFs3XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzhdIC0gcmlnaHRbOF0pIDw9IGVwc2lsb247CiAgICAgIH07CiAgICAgIE1hdHJpeDMuSURFTlRJVFkgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBNYXRyaXgzKDEsIDAsIDAsIDAsIDEsIDAsIDAsIDAsIDEpCiAgICAgICk7CiAgICAgIE1hdHJpeDMuWkVSTyA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IE1hdHJpeDMoMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCkKICAgICAgKTsKICAgICAgTWF0cml4My5DT0xVTU4wUk9XMCA9IDA7CiAgICAgIE1hdHJpeDMuQ09MVU1OMFJPVzEgPSAxOwogICAgICBNYXRyaXgzLkNPTFVNTjBST1cyID0gMjsKICAgICAgTWF0cml4My5DT0xVTU4xUk9XMCA9IDM7CiAgICAgIE1hdHJpeDMuQ09MVU1OMVJPVzEgPSA0OwogICAgICBNYXRyaXgzLkNPTFVNTjFST1cyID0gNTsKICAgICAgTWF0cml4My5DT0xVTU4yUk9XMCA9IDY7CiAgICAgIE1hdHJpeDMuQ09MVU1OMlJPVzEgPSA3OwogICAgICBNYXRyaXgzLkNPTFVNTjJST1cyID0gODsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoTWF0cml4My5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBudW1iZXIgb2YgaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgICogQG1lbWJlcm9mIE1hdHJpeDMucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGxlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdHJpeDMucGFja2VkTGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIE1hdHJpeDMucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDMuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4My5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gTWF0cml4My5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBNYXRyaXgzLmVxdWFsc0FycmF5ID0gZnVuY3Rpb24obWF0cml4LCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIG1hdHJpeFswXSA9PT0gYXJyYXlbb2Zmc2V0XSAmJiBtYXRyaXhbMV0gPT09IGFycmF5W29mZnNldCArIDFdICYmIG1hdHJpeFsyXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMl0gJiYgbWF0cml4WzNdID09PSBhcnJheVtvZmZzZXQgKyAzXSAmJiBtYXRyaXhbNF0gPT09IGFycmF5W29mZnNldCArIDRdICYmIG1hdHJpeFs1XSA9PT0gYXJyYXlbb2Zmc2V0ICsgNV0gJiYgbWF0cml4WzZdID09PSBhcnJheVtvZmZzZXQgKyA2XSAmJiBtYXRyaXhbN10gPT09IGFycmF5W29mZnNldCArIDddICYmIG1hdHJpeFs4XSA9PT0gYXJyYXlbb2Zmc2V0ICsgOF07CiAgICAgIH07CiAgICAgIE1hdHJpeDMucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihyaWdodCwgZXBzaWxvbikgewogICAgICAgIHJldHVybiBNYXRyaXgzLmVxdWFsc0Vwc2lsb24odGhpcywgcmlnaHQsIGVwc2lsb24pOwogICAgICB9OwogICAgICBNYXRyaXgzLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBgKCR7dGhpc1swXX0sICR7dGhpc1szXX0sICR7dGhpc1s2XX0pCigke3RoaXNbMV19LCAke3RoaXNbNF19LCAke3RoaXNbN119KQooJHt0aGlzWzJdfSwgJHt0aGlzWzVdfSwgJHt0aGlzWzhdfSlgOwogICAgICB9OwogICAgICBNYXRyaXgzX2RlZmF1bHQgPSBNYXRyaXgzOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2FydGVzaWFuNC5qcwogIGZ1bmN0aW9uIENhcnRlc2lhbjQoeCwgeSwgeiwgdykgewogICAgdGhpcy54ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB0aGlzLnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5LCAwKTsKICAgIHRoaXMueiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogICAgdGhpcy53ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodywgMCk7CiAgfQogIHZhciBkaXN0YW5jZVNjcmF0Y2gzLCBsZXJwU2NyYXRjaDMsIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2gzLCBzY3JhdGNoRjMyQXJyYXksIHNjcmF0Y2hVOEFycmF5LCB0ZXN0VTMyLCB0ZXN0VTgsIGxpdHRsZUVuZGlhbiwgQ2FydGVzaWFuNF9kZWZhdWx0OwogIHZhciBpbml0X0NhcnRlc2lhbjQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NhcnRlc2lhbjQuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBDYXJ0ZXNpYW40LmZyb21FbGVtZW50cyA9IGZ1bmN0aW9uKHgsIHksIHosIHcsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuNCh4LCB5LCB6LCB3KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmVzdWx0LncgPSB3OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuZnJvbUNvbG9yID0gZnVuY3Rpb24oY29sb3IsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY29sb3IiLCBjb2xvcik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW40KGNvbG9yLnJlZCwgY29sb3IuZ3JlZW4sIGNvbG9yLmJsdWUsIGNvbG9yLmFscGhhKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBjb2xvci5yZWQ7CiAgICAgICAgcmVzdWx0LnkgPSBjb2xvci5ncmVlbjsKICAgICAgICByZXN1bHQueiA9IGNvbG9yLmJsdWU7CiAgICAgICAgcmVzdWx0LncgPSBjb2xvci5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmNsb25lID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNhcnRlc2lhbjExKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0ZXNpYW40KGNhcnRlc2lhbjExLngsIGNhcnRlc2lhbjExLnksIGNhcnRlc2lhbjExLnosIGNhcnRlc2lhbjExLncpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJlc3VsdC56ID0gY2FydGVzaWFuMTEuejsKICAgICAgICByZXN1bHQudyA9IGNhcnRlc2lhbjExLnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5wYWNrZWRMZW5ndGggPSA0OwogICAgICBDYXJ0ZXNpYW40LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS54OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS55OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS56OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUudzsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW40KCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQueSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnogPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC53ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgY29uc3QgcmVzdWx0TGVuZ3RoID0gbGVuZ3RoICogNDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkocmVzdWx0TGVuZ3RoKTsKICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdCkgJiYgcmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIklmIHJlc3VsdCBpcyBhIHR5cGVkIGFycmF5LCBpdCBtdXN0IGhhdmUgZXhhY3RseSBhcnJheS5sZW5ndGggKiA0IGVsZW1lbnRzIgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IHJlc3VsdExlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgQ2FydGVzaWFuNC5wYWNrKGFycmF5W2ldLCByZXN1bHQsIGkgKiA0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC51bnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJhcnJheS5sZW5ndGgiLCBhcnJheS5sZW5ndGgsIDQpOwogICAgICAgIGlmIChhcnJheS5sZW5ndGggJSA0ICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0LiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCAvIDQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gNDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gNCkgewogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gNDsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBDYXJ0ZXNpYW40LnVucGFjayhhcnJheSwgaSwgcmVzdWx0W2luZGV4XSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuZnJvbUFycmF5ID0gQ2FydGVzaWFuNC51bnBhY2s7CiAgICAgIENhcnRlc2lhbjQubWF4aW11bUNvbXBvbmVudCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KGNhcnRlc2lhbjExLngsIGNhcnRlc2lhbjExLnksIGNhcnRlc2lhbjExLnosIGNhcnRlc2lhbjExLncpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm1pbmltdW1Db21wb25lbnQgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIHJldHVybiBNYXRoLm1pbihjYXJ0ZXNpYW4xMS54LCBjYXJ0ZXNpYW4xMS55LCBjYXJ0ZXNpYW4xMS56LCBjYXJ0ZXNpYW4xMS53KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5taW5pbXVtQnlDb21wb25lbnQgPSBmdW5jdGlvbihmaXJzdCwgc2Vjb25kLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImZpcnN0IiwgZmlyc3QpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2Vjb25kIiwgc2Vjb25kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBNYXRoLm1pbihmaXJzdC54LCBzZWNvbmQueCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoLm1pbihmaXJzdC55LCBzZWNvbmQueSk7CiAgICAgICAgcmVzdWx0LnogPSBNYXRoLm1pbihmaXJzdC56LCBzZWNvbmQueik7CiAgICAgICAgcmVzdWx0LncgPSBNYXRoLm1pbihmaXJzdC53LCBzZWNvbmQudyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5tYXhpbXVtQnlDb21wb25lbnQgPSBmdW5jdGlvbihmaXJzdCwgc2Vjb25kLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImZpcnN0IiwgZmlyc3QpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2Vjb25kIiwgc2Vjb25kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBNYXRoLm1heChmaXJzdC54LCBzZWNvbmQueCk7CiAgICAgICAgcmVzdWx0LnkgPSBNYXRoLm1heChmaXJzdC55LCBzZWNvbmQueSk7CiAgICAgICAgcmVzdWx0LnogPSBNYXRoLm1heChmaXJzdC56LCBzZWNvbmQueik7CiAgICAgICAgcmVzdWx0LncgPSBNYXRoLm1heChmaXJzdC53LCBzZWNvbmQudyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5jbGFtcCA9IGZ1bmN0aW9uKHZhbHVlLCBtaW4zLCBtYXgzLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWluIiwgbWluMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXgiLCBtYXgzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgeCA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS54LCBtaW4zLngsIG1heDMueCk7CiAgICAgICAgY29uc3QgeSA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS55LCBtaW4zLnksIG1heDMueSk7CiAgICAgICAgY29uc3QgeiA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS56LCBtaW4zLnosIG1heDMueik7CiAgICAgICAgY29uc3QgdyA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2YWx1ZS53LCBtaW4zLncsIG1heDMudyk7CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmVzdWx0LncgPSB3OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQubWFnbml0dWRlU3F1YXJlZCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgcmV0dXJuIGNhcnRlc2lhbjExLnggKiBjYXJ0ZXNpYW4xMS54ICsgY2FydGVzaWFuMTEueSAqIGNhcnRlc2lhbjExLnkgKyBjYXJ0ZXNpYW4xMS56ICogY2FydGVzaWFuMTEueiArIGNhcnRlc2lhbjExLncgKiBjYXJ0ZXNpYW4xMS53OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm1hZ25pdHVkZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgcmV0dXJuIE1hdGguc3FydChDYXJ0ZXNpYW40Lm1hZ25pdHVkZVNxdWFyZWQoY2FydGVzaWFuMTEpKTsKICAgICAgfTsKICAgICAgZGlzdGFuY2VTY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW40KCk7CiAgICAgIENhcnRlc2lhbjQuZGlzdGFuY2UgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuNC5zdWJ0cmFjdChsZWZ0LCByaWdodCwgZGlzdGFuY2VTY3JhdGNoMyk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjQubWFnbml0dWRlKGRpc3RhbmNlU2NyYXRjaDMpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmRpc3RhbmNlU3F1YXJlZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW40LnN1YnRyYWN0KGxlZnQsIHJpZ2h0LCBkaXN0YW5jZVNjcmF0Y2gzKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuNC5tYWduaXR1ZGVTcXVhcmVkKGRpc3RhbmNlU2NyYXRjaDMpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm5vcm1hbGl6ZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbWFnbml0dWRlID0gQ2FydGVzaWFuNC5tYWduaXR1ZGUoY2FydGVzaWFuMTEpOwogICAgICAgIHJlc3VsdC54ID0gY2FydGVzaWFuMTEueCAvIG1hZ25pdHVkZTsKICAgICAgICByZXN1bHQueSA9IGNhcnRlc2lhbjExLnkgLyBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LnogPSBjYXJ0ZXNpYW4xMS56IC8gbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC53ID0gY2FydGVzaWFuMTEudyAvIG1hZ25pdHVkZTsKICAgICAgICBpZiAoaXNOYU4ocmVzdWx0LngpIHx8IGlzTmFOKHJlc3VsdC55KSB8fCBpc05hTihyZXN1bHQueikgfHwgaXNOYU4ocmVzdWx0LncpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibm9ybWFsaXplZCByZXN1bHQgaXMgbm90IGEgbnVtYmVyIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuZG90ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIHJldHVybiBsZWZ0LnggKiByaWdodC54ICsgbGVmdC55ICogcmlnaHQueSArIGxlZnQueiAqIHJpZ2h0LnogKyBsZWZ0LncgKiByaWdodC53OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40Lm11bHRpcGx5Q29tcG9uZW50cyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAqIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgKiByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56ICogcmlnaHQuejsKICAgICAgICByZXN1bHQudyA9IGxlZnQudyAqIHJpZ2h0Lnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5kaXZpZGVDb21wb25lbnRzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbGVmdC54IC8gcmlnaHQueDsKICAgICAgICByZXN1bHQueSA9IGxlZnQueSAvIHJpZ2h0Lnk7CiAgICAgICAgcmVzdWx0LnogPSBsZWZ0LnogLyByaWdodC56OwogICAgICAgIHJlc3VsdC53ID0gbGVmdC53IC8gcmlnaHQudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmFkZCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCArIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgKyByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56ICsgcmlnaHQuejsKICAgICAgICByZXN1bHQudyA9IGxlZnQudyArIHJpZ2h0Lnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5zdWJ0cmFjdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGxlZnQueCAtIHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsZWZ0LnkgLSByaWdodC55OwogICAgICAgIHJlc3VsdC56ID0gbGVmdC56IC0gcmlnaHQuejsKICAgICAgICByZXN1bHQudyA9IGxlZnQudyAtIHJpZ2h0Lnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHNjYWxhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IGNhcnRlc2lhbjExLnggKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC56ID0gY2FydGVzaWFuMTEueiAqIHNjYWxhcjsKICAgICAgICByZXN1bHQudyA9IGNhcnRlc2lhbjExLncgKiBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5kaXZpZGVCeVNjYWxhciA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54IC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gY2FydGVzaWFuMTEueSAvIHNjYWxhcjsKICAgICAgICByZXN1bHQueiA9IGNhcnRlc2lhbjExLnogLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LncgPSBjYXJ0ZXNpYW4xMS53IC8gc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQubmVnYXRlID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IC1jYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdC55ID0gLWNhcnRlc2lhbjExLnk7CiAgICAgICAgcmVzdWx0LnogPSAtY2FydGVzaWFuMTEuejsKICAgICAgICByZXN1bHQudyA9IC1jYXJ0ZXNpYW4xMS53OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuYWJzID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IE1hdGguYWJzKGNhcnRlc2lhbjExLngpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aC5hYnMoY2FydGVzaWFuMTEueSk7CiAgICAgICAgcmVzdWx0LnogPSBNYXRoLmFicyhjYXJ0ZXNpYW4xMS56KTsKICAgICAgICByZXN1bHQudyA9IE1hdGguYWJzKGNhcnRlc2lhbjExLncpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGxlcnBTY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW40KCk7CiAgICAgIENhcnRlc2lhbjQubGVycCA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3RhcnQiLCBzdGFydCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbmQiLCBlbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBDYXJ0ZXNpYW40Lm11bHRpcGx5QnlTY2FsYXIoZW5kLCB0LCBsZXJwU2NyYXRjaDMpOwogICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjQubXVsdGlwbHlCeVNjYWxhcihzdGFydCwgMSAtIHQsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjQuYWRkKGxlcnBTY3JhdGNoMywgcmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBtb3N0T3J0aG9nb25hbEF4aXNTY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW40KCk7CiAgICAgIENhcnRlc2lhbjQubW9zdE9ydGhvZ29uYWxBeGlzID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBmID0gQ2FydGVzaWFuNC5ub3JtYWxpemUoY2FydGVzaWFuMTEsIG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2gzKTsKICAgICAgICBDYXJ0ZXNpYW40LmFicyhmLCBmKTsKICAgICAgICBpZiAoZi54IDw9IGYueSkgewogICAgICAgICAgaWYgKGYueCA8PSBmLnopIHsKICAgICAgICAgICAgaWYgKGYueCA8PSBmLncpIHsKICAgICAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW40LmNsb25lKENhcnRlc2lhbjQuVU5JVF9YLCByZXN1bHQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjQuY2xvbmUoQ2FydGVzaWFuNC5VTklUX1csIHJlc3VsdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoZi56IDw9IGYudykgewogICAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW40LmNsb25lKENhcnRlc2lhbjQuVU5JVF9aLCByZXN1bHQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuNC5jbG9uZShDYXJ0ZXNpYW40LlVOSVRfVywgcmVzdWx0KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGYueSA8PSBmLnopIHsKICAgICAgICAgIGlmIChmLnkgPD0gZi53KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IENhcnRlc2lhbjQuY2xvbmUoQ2FydGVzaWFuNC5VTklUX1ksIHJlc3VsdCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW40LmNsb25lKENhcnRlc2lhbjQuVU5JVF9XLCByZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZi56IDw9IGYudykgewogICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuNC5jbG9uZShDYXJ0ZXNpYW40LlVOSVRfWiwgcmVzdWx0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuNC5jbG9uZShDYXJ0ZXNpYW40LlVOSVRfVywgcmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LnggPT09IHJpZ2h0LnggJiYgbGVmdC55ID09PSByaWdodC55ICYmIGxlZnQueiA9PT0gcmlnaHQueiAmJiBsZWZ0LncgPT09IHJpZ2h0Lnc7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQuZXF1YWxzQXJyYXkgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgYXJyYXksIG9mZnNldCkgewogICAgICAgIHJldHVybiBjYXJ0ZXNpYW4xMS54ID09PSBhcnJheVtvZmZzZXRdICYmIGNhcnRlc2lhbjExLnkgPT09IGFycmF5W29mZnNldCArIDFdICYmIGNhcnRlc2lhbjExLnogPT09IGFycmF5W29mZnNldCArIDJdICYmIGNhcnRlc2lhbjExLncgPT09IGFycmF5W29mZnNldCArIDNdOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LngsCiAgICAgICAgICByaWdodC54LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQueSwKICAgICAgICAgIHJpZ2h0LnksCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgbGVmdC56LAogICAgICAgICAgcmlnaHQueiwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LncsCiAgICAgICAgICByaWdodC53LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5aRVJPID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgwLCAwLCAwLCAwKSk7CiAgICAgIENhcnRlc2lhbjQuT05FID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgxLCAxLCAxLCAxKSk7CiAgICAgIENhcnRlc2lhbjQuVU5JVF9YID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgxLCAwLCAwLCAwKSk7CiAgICAgIENhcnRlc2lhbjQuVU5JVF9ZID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgwLCAxLCAwLCAwKSk7CiAgICAgIENhcnRlc2lhbjQuVU5JVF9aID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgwLCAwLCAxLCAwKSk7CiAgICAgIENhcnRlc2lhbjQuVU5JVF9XID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuNCgwLCAwLCAwLCAxKSk7CiAgICAgIENhcnRlc2lhbjQucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjQuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuNC5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBDYXJ0ZXNpYW40LnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ocmlnaHQsIHJlbGF0aXZlRXBzaWxvbiwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMsCiAgICAgICAgICByaWdodCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICk7CiAgICAgIH07CiAgICAgIENhcnRlc2lhbjQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzLnh9LCAke3RoaXMueX0sICR7dGhpcy56fSwgJHt0aGlzLnd9KWA7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hGMzJBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoMSk7CiAgICAgIHNjcmF0Y2hVOEFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoc2NyYXRjaEYzMkFycmF5LmJ1ZmZlcik7CiAgICAgIHRlc3RVMzIgPSBuZXcgVWludDMyQXJyYXkoWzI4NzQ1NDAyMF0pOwogICAgICB0ZXN0VTggPSBuZXcgVWludDhBcnJheSh0ZXN0VTMyLmJ1ZmZlcik7CiAgICAgIGxpdHRsZUVuZGlhbiA9IHRlc3RVOFswXSA9PT0gNjg7CiAgICAgIENhcnRlc2lhbjQucGFja0Zsb2F0ID0gZnVuY3Rpb24odmFsdWUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjQoKTsKICAgICAgICB9CiAgICAgICAgc2NyYXRjaEYzMkFycmF5WzBdID0gdmFsdWU7CiAgICAgICAgaWYgKGxpdHRsZUVuZGlhbikgewogICAgICAgICAgcmVzdWx0LnggPSBzY3JhdGNoVThBcnJheVswXTsKICAgICAgICAgIHJlc3VsdC55ID0gc2NyYXRjaFU4QXJyYXlbMV07CiAgICAgICAgICByZXN1bHQueiA9IHNjcmF0Y2hVOEFycmF5WzJdOwogICAgICAgICAgcmVzdWx0LncgPSBzY3JhdGNoVThBcnJheVszXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0LnggPSBzY3JhdGNoVThBcnJheVszXTsKICAgICAgICAgIHJlc3VsdC55ID0gc2NyYXRjaFU4QXJyYXlbMl07CiAgICAgICAgICByZXN1bHQueiA9IHNjcmF0Y2hVOEFycmF5WzFdOwogICAgICAgICAgcmVzdWx0LncgPSBzY3JhdGNoVThBcnJheVswXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNC51bnBhY2tGbG9hdCA9IGZ1bmN0aW9uKHBhY2tlZEZsb2F0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwYWNrZWRGbG9hdCIsIHBhY2tlZEZsb2F0KTsKICAgICAgICBpZiAobGl0dGxlRW5kaWFuKSB7CiAgICAgICAgICBzY3JhdGNoVThBcnJheVswXSA9IHBhY2tlZEZsb2F0Lng7CiAgICAgICAgICBzY3JhdGNoVThBcnJheVsxXSA9IHBhY2tlZEZsb2F0Lnk7CiAgICAgICAgICBzY3JhdGNoVThBcnJheVsyXSA9IHBhY2tlZEZsb2F0Lno7CiAgICAgICAgICBzY3JhdGNoVThBcnJheVszXSA9IHBhY2tlZEZsb2F0Lnc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzBdID0gcGFja2VkRmxvYXQudzsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzFdID0gcGFja2VkRmxvYXQuejsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzJdID0gcGFja2VkRmxvYXQueTsKICAgICAgICAgIHNjcmF0Y2hVOEFycmF5WzNdID0gcGFja2VkRmxvYXQueDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNjcmF0Y2hGMzJBcnJheVswXTsKICAgICAgfTsKICAgICAgQ2FydGVzaWFuNF9kZWZhdWx0ID0gQ2FydGVzaWFuNDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1J1bnRpbWVFcnJvci5qcwogIGZ1bmN0aW9uIFJ1bnRpbWVFcnJvcihtZXNzYWdlKSB7CiAgICB0aGlzLm5hbWUgPSAiUnVudGltZUVycm9yIjsKICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICBsZXQgc3RhY2s7CiAgICB0cnkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgc3RhY2sgPSBlLnN0YWNrOwogICAgfQogICAgdGhpcy5zdGFjayA9IHN0YWNrOwogIH0KICB2YXIgUnVudGltZUVycm9yX2RlZmF1bHQ7CiAgdmFyIGluaXRfUnVudGltZUVycm9yID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SdW50aW1lRXJyb3IuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChPYmplY3QuY3JlYXRlKSkgewogICAgICAgIFJ1bnRpbWVFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVycm9yLnByb3RvdHlwZSk7CiAgICAgICAgUnVudGltZUVycm9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFJ1bnRpbWVFcnJvcjsKICAgICAgfQogICAgICBSdW50aW1lRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbGV0IHN0ciA9IGAke3RoaXMubmFtZX06ICR7dGhpcy5tZXNzYWdlfWA7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aGlzLnN0YWNrKSkgewogICAgICAgICAgc3RyICs9IGAKJHt0aGlzLnN0YWNrLnRvU3RyaW5nKCl9YDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgfTsKICAgICAgUnVudGltZUVycm9yX2RlZmF1bHQgPSBSdW50aW1lRXJyb3I7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9NYXRyaXg0LmpzCiAgZnVuY3Rpb24gTWF0cml4NChjb2x1bW4wUm93MCwgY29sdW1uMVJvdzAsIGNvbHVtbjJSb3cwLCBjb2x1bW4zUm93MCwgY29sdW1uMFJvdzEsIGNvbHVtbjFSb3cxLCBjb2x1bW4yUm93MSwgY29sdW1uM1JvdzEsIGNvbHVtbjBSb3cyLCBjb2x1bW4xUm93MiwgY29sdW1uMlJvdzIsIGNvbHVtbjNSb3cyLCBjb2x1bW4wUm93MywgY29sdW1uMVJvdzMsIGNvbHVtbjJSb3czLCBjb2x1bW4zUm93MykgewogICAgdGhpc1swXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjBSb3cwLCAwKTsKICAgIHRoaXNbMV0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4wUm93MSwgMCk7CiAgICB0aGlzWzJdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMFJvdzIsIDApOwogICAgdGhpc1szXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjBSb3czLCAwKTsKICAgIHRoaXNbNF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4xUm93MCwgMCk7CiAgICB0aGlzWzVdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMVJvdzEsIDApOwogICAgdGhpc1s2XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjFSb3cyLCAwKTsKICAgIHRoaXNbN10gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4xUm93MywgMCk7CiAgICB0aGlzWzhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMlJvdzAsIDApOwogICAgdGhpc1s5XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjJSb3cxLCAwKTsKICAgIHRoaXNbMTBdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMlJvdzIsIDApOwogICAgdGhpc1sxMV0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4yUm93MywgMCk7CiAgICB0aGlzWzEyXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjNSb3cwLCAwKTsKICAgIHRoaXNbMTNdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uM1JvdzEsIDApOwogICAgdGhpc1sxNF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4zUm93MiwgMCk7CiAgICB0aGlzWzE1XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjNSb3czLCAwKTsKICB9CiAgdmFyIGZyb21DYW1lcmFGLCBmcm9tQ2FtZXJhUiwgZnJvbUNhbWVyYVUsIHNjYWxlU2NyYXRjaDEyLCBzY2FsZVNjcmF0Y2gyMiwgc2NyYXRjaENvbHVtbjIsIHNjYWxlU2NyYXRjaDMyLCBzY2FsZVNjcmF0Y2g0Miwgc2NhbGVTY3JhdGNoNTIsIHNjcmF0Y2hJbnZlcnNlUm90YXRpb24sIHNjcmF0Y2hNYXRyaXgzWmVybywgc2NyYXRjaEJvdHRvbVJvdywgc2NyYXRjaEV4cGVjdGVkQm90dG9tUm93LCBzY3JhdGNoVHJhbnNwb3NlTWF0cml4MiwgTWF0cml4NF9kZWZhdWx0OwogIHZhciBpbml0X01hdHJpeDQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL01hdHJpeDQuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X1J1bnRpbWVFcnJvcigpOwogICAgICBNYXRyaXg0LnBhY2tlZExlbmd0aCA9IDE2OwogICAgICBNYXRyaXg0LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVswXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMV07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzJdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVszXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbNF07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzVdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVs2XTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbN107CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzhdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVs5XTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMTBdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVsxMV07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzEyXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMTNdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVsxNF07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZVsxNV07CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBNYXRyaXg0LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4NCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzJdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbM10gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs0XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzVdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbNl0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFs3XSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzhdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbOV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxMF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxMV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxMl0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxM10gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxNF0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFsxNV0gPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBjb25zdCByZXN1bHRMZW5ndGggPSBsZW5ndGggKiAxNjsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkocmVzdWx0TGVuZ3RoKTsKICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdCkgJiYgcmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIklmIHJlc3VsdCBpcyBhIHR5cGVkIGFycmF5LCBpdCBtdXN0IGhhdmUgZXhhY3RseSBhcnJheS5sZW5ndGggKiAxNiBlbGVtZW50cyIKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQubGVuZ3RoICE9PSByZXN1bHRMZW5ndGgpIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSByZXN1bHRMZW5ndGg7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIE1hdHJpeDQucGFjayhhcnJheVtpXSwgcmVzdWx0LCBpICogMTYpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnVucGFja0FycmF5ID0gZnVuY3Rpb24oYXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImFycmF5Lmxlbmd0aCIsIGFycmF5Lmxlbmd0aCwgMTYpOwogICAgICAgIGlmIChhcnJheS5sZW5ndGggJSAxNiAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoIC8gMTYpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gMTY7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDE2KSB7CiAgICAgICAgICBjb25zdCBpbmRleCA9IGkgLyAxNjsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBNYXRyaXg0LnVucGFjayhhcnJheSwgaSwgcmVzdWx0W2luZGV4XSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuY2xvbmUgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG1hdHJpeCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4NCgKICAgICAgICAgICAgbWF0cml4WzBdLAogICAgICAgICAgICBtYXRyaXhbNF0sCiAgICAgICAgICAgIG1hdHJpeFs4XSwKICAgICAgICAgICAgbWF0cml4WzEyXSwKICAgICAgICAgICAgbWF0cml4WzFdLAogICAgICAgICAgICBtYXRyaXhbNV0sCiAgICAgICAgICAgIG1hdHJpeFs5XSwKICAgICAgICAgICAgbWF0cml4WzEzXSwKICAgICAgICAgICAgbWF0cml4WzJdLAogICAgICAgICAgICBtYXRyaXhbNl0sCiAgICAgICAgICAgIG1hdHJpeFsxMF0sCiAgICAgICAgICAgIG1hdHJpeFsxNF0sCiAgICAgICAgICAgIG1hdHJpeFszXSwKICAgICAgICAgICAgbWF0cml4WzddLAogICAgICAgICAgICBtYXRyaXhbMTFdLAogICAgICAgICAgICBtYXRyaXhbMTVdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV07CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IG1hdHJpeFsxMl07CiAgICAgICAgcmVzdWx0WzEzXSA9IG1hdHJpeFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzE1XSA9IG1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tQXJyYXkgPSBNYXRyaXg0LnVucGFjazsKICAgICAgTWF0cml4NC5mcm9tQ29sdW1uTWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIHJldHVybiBNYXRyaXg0LmNsb25lKHZhbHVlcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tUm93TWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4NCgKICAgICAgICAgICAgdmFsdWVzWzBdLAogICAgICAgICAgICB2YWx1ZXNbMV0sCiAgICAgICAgICAgIHZhbHVlc1syXSwKICAgICAgICAgICAgdmFsdWVzWzNdLAogICAgICAgICAgICB2YWx1ZXNbNF0sCiAgICAgICAgICAgIHZhbHVlc1s1XSwKICAgICAgICAgICAgdmFsdWVzWzZdLAogICAgICAgICAgICB2YWx1ZXNbN10sCiAgICAgICAgICAgIHZhbHVlc1s4XSwKICAgICAgICAgICAgdmFsdWVzWzldLAogICAgICAgICAgICB2YWx1ZXNbMTBdLAogICAgICAgICAgICB2YWx1ZXNbMTFdLAogICAgICAgICAgICB2YWx1ZXNbMTJdLAogICAgICAgICAgICB2YWx1ZXNbMTNdLAogICAgICAgICAgICB2YWx1ZXNbMTRdLAogICAgICAgICAgICB2YWx1ZXNbMTVdCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSB2YWx1ZXNbMF07CiAgICAgICAgcmVzdWx0WzFdID0gdmFsdWVzWzRdOwogICAgICAgIHJlc3VsdFsyXSA9IHZhbHVlc1s4XTsKICAgICAgICByZXN1bHRbM10gPSB2YWx1ZXNbMTJdOwogICAgICAgIHJlc3VsdFs0XSA9IHZhbHVlc1sxXTsKICAgICAgICByZXN1bHRbNV0gPSB2YWx1ZXNbNV07CiAgICAgICAgcmVzdWx0WzZdID0gdmFsdWVzWzldOwogICAgICAgIHJlc3VsdFs3XSA9IHZhbHVlc1sxM107CiAgICAgICAgcmVzdWx0WzhdID0gdmFsdWVzWzJdOwogICAgICAgIHJlc3VsdFs5XSA9IHZhbHVlc1s2XTsKICAgICAgICByZXN1bHRbMTBdID0gdmFsdWVzWzEwXTsKICAgICAgICByZXN1bHRbMTFdID0gdmFsdWVzWzE0XTsKICAgICAgICByZXN1bHRbMTJdID0gdmFsdWVzWzNdOwogICAgICAgIHJlc3VsdFsxM10gPSB2YWx1ZXNbN107CiAgICAgICAgcmVzdWx0WzE0XSA9IHZhbHVlc1sxMV07CiAgICAgICAgcmVzdWx0WzE1XSA9IHZhbHVlc1sxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tUm90YXRpb25UcmFuc2xhdGlvbiA9IGZ1bmN0aW9uKHJvdGF0aW9uLCB0cmFuc2xhdGlvbjIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicm90YXRpb24iLCByb3RhdGlvbik7CiAgICAgICAgdHJhbnNsYXRpb24yID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodHJhbnNsYXRpb24yLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTyk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXg0KAogICAgICAgICAgICByb3RhdGlvblswXSwKICAgICAgICAgICAgcm90YXRpb25bM10sCiAgICAgICAgICAgIHJvdGF0aW9uWzZdLAogICAgICAgICAgICB0cmFuc2xhdGlvbjIueCwKICAgICAgICAgICAgcm90YXRpb25bMV0sCiAgICAgICAgICAgIHJvdGF0aW9uWzRdLAogICAgICAgICAgICByb3RhdGlvbls3XSwKICAgICAgICAgICAgdHJhbnNsYXRpb24yLnksCiAgICAgICAgICAgIHJvdGF0aW9uWzJdLAogICAgICAgICAgICByb3RhdGlvbls1XSwKICAgICAgICAgICAgcm90YXRpb25bOF0sCiAgICAgICAgICAgIHRyYW5zbGF0aW9uMi56LAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAxCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSByb3RhdGlvblswXTsKICAgICAgICByZXN1bHRbMV0gPSByb3RhdGlvblsxXTsKICAgICAgICByZXN1bHRbMl0gPSByb3RhdGlvblsyXTsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IHJvdGF0aW9uWzNdOwogICAgICAgIHJlc3VsdFs1XSA9IHJvdGF0aW9uWzRdOwogICAgICAgIHJlc3VsdFs2XSA9IHJvdGF0aW9uWzVdOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gcm90YXRpb25bNl07CiAgICAgICAgcmVzdWx0WzldID0gcm90YXRpb25bN107CiAgICAgICAgcmVzdWx0WzEwXSA9IHJvdGF0aW9uWzhdOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSB0cmFuc2xhdGlvbjIueDsKICAgICAgICByZXN1bHRbMTNdID0gdHJhbnNsYXRpb24yLnk7CiAgICAgICAgcmVzdWx0WzE0XSA9IHRyYW5zbGF0aW9uMi56OwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZnJvbVRyYW5zbGF0aW9uUXVhdGVybmlvblJvdGF0aW9uU2NhbGUgPSBmdW5jdGlvbih0cmFuc2xhdGlvbjIsIHJvdGF0aW9uLCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2xhdGlvbiIsIHRyYW5zbGF0aW9uMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyb3RhdGlvbiIsIHJvdGF0aW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXg0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNjYWxlWCA9IHNjYWxlLng7CiAgICAgICAgY29uc3Qgc2NhbGVZID0gc2NhbGUueTsKICAgICAgICBjb25zdCBzY2FsZVogPSBzY2FsZS56OwogICAgICAgIGNvbnN0IHgyID0gcm90YXRpb24ueCAqIHJvdGF0aW9uLng7CiAgICAgICAgY29uc3QgeHkgPSByb3RhdGlvbi54ICogcm90YXRpb24ueTsKICAgICAgICBjb25zdCB4eiA9IHJvdGF0aW9uLnggKiByb3RhdGlvbi56OwogICAgICAgIGNvbnN0IHh3ID0gcm90YXRpb24ueCAqIHJvdGF0aW9uLnc7CiAgICAgICAgY29uc3QgeTIgPSByb3RhdGlvbi55ICogcm90YXRpb24ueTsKICAgICAgICBjb25zdCB5eiA9IHJvdGF0aW9uLnkgKiByb3RhdGlvbi56OwogICAgICAgIGNvbnN0IHl3ID0gcm90YXRpb24ueSAqIHJvdGF0aW9uLnc7CiAgICAgICAgY29uc3QgejIgPSByb3RhdGlvbi56ICogcm90YXRpb24uejsKICAgICAgICBjb25zdCB6dyA9IHJvdGF0aW9uLnogKiByb3RhdGlvbi53OwogICAgICAgIGNvbnN0IHcyID0gcm90YXRpb24udyAqIHJvdGF0aW9uLnc7CiAgICAgICAgY29uc3QgbTAwID0geDIgLSB5MiAtIHoyICsgdzI7CiAgICAgICAgY29uc3QgbTAxID0gMiAqICh4eSAtIHp3KTsKICAgICAgICBjb25zdCBtMDIgPSAyICogKHh6ICsgeXcpOwogICAgICAgIGNvbnN0IG0xMCA9IDIgKiAoeHkgKyB6dyk7CiAgICAgICAgY29uc3QgbTExID0gLXgyICsgeTIgLSB6MiArIHcyOwogICAgICAgIGNvbnN0IG0xMiA9IDIgKiAoeXogLSB4dyk7CiAgICAgICAgY29uc3QgbTIwID0gMiAqICh4eiAtIHl3KTsKICAgICAgICBjb25zdCBtMjEgPSAyICogKHl6ICsgeHcpOwogICAgICAgIGNvbnN0IG0yMiA9IC14MiAtIHkyICsgejIgKyB3MjsKICAgICAgICByZXN1bHRbMF0gPSBtMDAgKiBzY2FsZVg7CiAgICAgICAgcmVzdWx0WzFdID0gbTEwICogc2NhbGVYOwogICAgICAgIHJlc3VsdFsyXSA9IG0yMCAqIHNjYWxlWDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IG0wMSAqIHNjYWxlWTsKICAgICAgICByZXN1bHRbNV0gPSBtMTEgKiBzY2FsZVk7CiAgICAgICAgcmVzdWx0WzZdID0gbTIxICogc2NhbGVZOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gbTAyICogc2NhbGVaOwogICAgICAgIHJlc3VsdFs5XSA9IG0xMiAqIHNjYWxlWjsKICAgICAgICByZXN1bHRbMTBdID0gbTIyICogc2NhbGVaOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSB0cmFuc2xhdGlvbjIueDsKICAgICAgICByZXN1bHRbMTNdID0gdHJhbnNsYXRpb24yLnk7CiAgICAgICAgcmVzdWx0WzE0XSA9IHRyYW5zbGF0aW9uMi56OwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZnJvbVRyYW5zbGF0aW9uUm90YXRpb25TY2FsZSA9IGZ1bmN0aW9uKHRyYW5zbGF0aW9uUm90YXRpb25TY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2xhdGlvblJvdGF0aW9uU2NhbGUiLCB0cmFuc2xhdGlvblJvdGF0aW9uU2NhbGUpOwogICAgICAgIHJldHVybiBNYXRyaXg0LmZyb21UcmFuc2xhdGlvblF1YXRlcm5pb25Sb3RhdGlvblNjYWxlKAogICAgICAgICAgdHJhbnNsYXRpb25Sb3RhdGlvblNjYWxlLnRyYW5zbGF0aW9uLAogICAgICAgICAgdHJhbnNsYXRpb25Sb3RhdGlvblNjYWxlLnJvdGF0aW9uLAogICAgICAgICAgdHJhbnNsYXRpb25Sb3RhdGlvblNjYWxlLnNjYWxlLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tVHJhbnNsYXRpb24gPSBmdW5jdGlvbih0cmFuc2xhdGlvbjIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidHJhbnNsYXRpb24iLCB0cmFuc2xhdGlvbjIpOwogICAgICAgIHJldHVybiBNYXRyaXg0LmZyb21Sb3RhdGlvblRyYW5zbGF0aW9uKE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWSwgdHJhbnNsYXRpb24yLCByZXN1bHQpOwogICAgICB9OwogICAgICBNYXRyaXg0LmZyb21TY2FsZSA9IGZ1bmN0aW9uKHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNjYWxlIiwgc2NhbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4NCgKICAgICAgICAgICAgc2NhbGUueCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgc2NhbGUueSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgc2NhbGUueiwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSAwOwogICAgICAgIHJlc3VsdFs1XSA9IHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IDA7CiAgICAgICAgcmVzdWx0WzldID0gMDsKICAgICAgICByZXN1bHRbMTBdID0gc2NhbGUuejsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0gMDsKICAgICAgICByZXN1bHRbMTNdID0gMDsKICAgICAgICByZXN1bHRbMTRdID0gMDsKICAgICAgICByZXN1bHRbMTVdID0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmZyb21Vbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDQoCiAgICAgICAgICAgIHNjYWxlLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICBzY2FsZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgc2NhbGUsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDEKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlOwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IDA7CiAgICAgICAgcmVzdWx0WzVdID0gc2NhbGU7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IDA7CiAgICAgICAgcmVzdWx0WzldID0gMDsKICAgICAgICByZXN1bHRbMTBdID0gc2NhbGU7CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IDA7CiAgICAgICAgcmVzdWx0WzEzXSA9IDA7CiAgICAgICAgcmVzdWx0WzE0XSA9IDA7CiAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5mcm9tUm90YXRpb24gPSBmdW5jdGlvbihyb3RhdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyb3RhdGlvbiIsIHJvdGF0aW9uKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4NCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSByb3RhdGlvblswXTsKICAgICAgICByZXN1bHRbMV0gPSByb3RhdGlvblsxXTsKICAgICAgICByZXN1bHRbMl0gPSByb3RhdGlvblsyXTsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IHJvdGF0aW9uWzNdOwogICAgICAgIHJlc3VsdFs1XSA9IHJvdGF0aW9uWzRdOwogICAgICAgIHJlc3VsdFs2XSA9IHJvdGF0aW9uWzVdOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gcm90YXRpb25bNl07CiAgICAgICAgcmVzdWx0WzldID0gcm90YXRpb25bN107CiAgICAgICAgcmVzdWx0WzEwXSA9IHJvdGF0aW9uWzhdOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSAwOwogICAgICAgIHJlc3VsdFsxM10gPSAwOwogICAgICAgIHJlc3VsdFsxNF0gPSAwOwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGZyb21DYW1lcmFGID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tQ2FtZXJhUiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbUNhbWVyYVUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDQuZnJvbUNhbWVyYSA9IGZ1bmN0aW9uKGNhbWVyYSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYW1lcmEiLCBjYW1lcmEpOwogICAgICAgIGNvbnN0IHBvc2l0aW9uID0gY2FtZXJhLnBvc2l0aW9uOwogICAgICAgIGNvbnN0IGRpcmVjdGlvbjIgPSBjYW1lcmEuZGlyZWN0aW9uOwogICAgICAgIGNvbnN0IHVwID0gY2FtZXJhLnVwOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FtZXJhLnBvc2l0aW9uIiwgcG9zaXRpb24pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FtZXJhLmRpcmVjdGlvbiIsIGRpcmVjdGlvbjIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FtZXJhLnVwIiwgdXApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZGlyZWN0aW9uMiwgZnJvbUNhbWVyYUYpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoZnJvbUNhbWVyYUYsIHVwLCBmcm9tQ2FtZXJhUiksCiAgICAgICAgICBmcm9tQ2FtZXJhUgogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhmcm9tQ2FtZXJhUiwgZnJvbUNhbWVyYUYsIGZyb21DYW1lcmFVKSwKICAgICAgICAgIGZyb21DYW1lcmFVCiAgICAgICAgKTsKICAgICAgICBjb25zdCBzWCA9IGZyb21DYW1lcmFSLng7CiAgICAgICAgY29uc3Qgc1kgPSBmcm9tQ2FtZXJhUi55OwogICAgICAgIGNvbnN0IHNaID0gZnJvbUNhbWVyYVIuejsKICAgICAgICBjb25zdCBmWCA9IGZyb21DYW1lcmFGLng7CiAgICAgICAgY29uc3QgZlkgPSBmcm9tQ2FtZXJhRi55OwogICAgICAgIGNvbnN0IGZaID0gZnJvbUNhbWVyYUYuejsKICAgICAgICBjb25zdCB1WCA9IGZyb21DYW1lcmFVLng7CiAgICAgICAgY29uc3QgdVkgPSBmcm9tQ2FtZXJhVS55OwogICAgICAgIGNvbnN0IHVaID0gZnJvbUNhbWVyYVUuejsKICAgICAgICBjb25zdCBwb3NpdGlvblggPSBwb3NpdGlvbi54OwogICAgICAgIGNvbnN0IHBvc2l0aW9uWSA9IHBvc2l0aW9uLnk7CiAgICAgICAgY29uc3QgcG9zaXRpb25aID0gcG9zaXRpb24uejsKICAgICAgICBjb25zdCB0MCA9IHNYICogLXBvc2l0aW9uWCArIHNZICogLXBvc2l0aW9uWSArIHNaICogLXBvc2l0aW9uWjsKICAgICAgICBjb25zdCB0MSA9IHVYICogLXBvc2l0aW9uWCArIHVZICogLXBvc2l0aW9uWSArIHVaICogLXBvc2l0aW9uWjsKICAgICAgICBjb25zdCB0MiA9IGZYICogcG9zaXRpb25YICsgZlkgKiBwb3NpdGlvblkgKyBmWiAqIHBvc2l0aW9uWjsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDQoCiAgICAgICAgICAgIHNYLAogICAgICAgICAgICBzWSwKICAgICAgICAgICAgc1osCiAgICAgICAgICAgIHQwLAogICAgICAgICAgICB1WCwKICAgICAgICAgICAgdVksCiAgICAgICAgICAgIHVaLAogICAgICAgICAgICB0MSwKICAgICAgICAgICAgLWZYLAogICAgICAgICAgICAtZlksCiAgICAgICAgICAgIC1mWiwKICAgICAgICAgICAgdDIsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDEKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNYOwogICAgICAgIHJlc3VsdFsxXSA9IHVYOwogICAgICAgIHJlc3VsdFsyXSA9IC1mWDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IHNZOwogICAgICAgIHJlc3VsdFs1XSA9IHVZOwogICAgICAgIHJlc3VsdFs2XSA9IC1mWTsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IHNaOwogICAgICAgIHJlc3VsdFs5XSA9IHVaOwogICAgICAgIHJlc3VsdFsxMF0gPSAtZlo7CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IHQwOwogICAgICAgIHJlc3VsdFsxM10gPSB0MTsKICAgICAgICByZXN1bHRbMTRdID0gdDI7CiAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5jb21wdXRlUGVyc3BlY3RpdmVGaWVsZE9mVmlldyA9IGZ1bmN0aW9uKGZvdlksIGFzcGVjdFJhdGlvLCBuZWFyLCBmYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiZm92WSIsIGZvdlksIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbigiZm92WSIsIGZvdlksIE1hdGguUEkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigibmVhciIsIG5lYXIsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiZmFyIiwgZmFyLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgYm90dG9tID0gTWF0aC50YW4oZm92WSAqIDAuNSk7CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzEgPSAxIC8gYm90dG9tOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cwID0gY29sdW1uMVJvdzEgLyBhc3BlY3RSYXRpbzsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MiA9IChmYXIgKyBuZWFyKSAvIChuZWFyIC0gZmFyKTsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MiA9IDIgKiBmYXIgKiBuZWFyIC8gKG5lYXIgLSBmYXIpOwogICAgICAgIHJlc3VsdFswXSA9IGNvbHVtbjBSb3cwOwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IDA7CiAgICAgICAgcmVzdWx0WzVdID0gY29sdW1uMVJvdzE7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IDA7CiAgICAgICAgcmVzdWx0WzldID0gMDsKICAgICAgICByZXN1bHRbMTBdID0gY29sdW1uMlJvdzI7CiAgICAgICAgcmVzdWx0WzExXSA9IC0xOwogICAgICAgIHJlc3VsdFsxMl0gPSAwOwogICAgICAgIHJlc3VsdFsxM10gPSAwOwogICAgICAgIHJlc3VsdFsxNF0gPSBjb2x1bW4zUm93MjsKICAgICAgICByZXN1bHRbMTVdID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmNvbXB1dGVPcnRob2dyYXBoaWNPZmZDZW50ZXIgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYm90dG9tLCB0b3AsIG5lYXIsIGZhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImJvdHRvbSIsIGJvdHRvbSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0b3AiLCB0b3ApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibmVhciIsIG5lYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiZmFyIiwgZmFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgbGV0IGEzID0gMSAvIChyaWdodCAtIGxlZnQpOwogICAgICAgIGxldCBiID0gMSAvICh0b3AgLSBib3R0b20pOwogICAgICAgIGxldCBjID0gMSAvIChmYXIgLSBuZWFyKTsKICAgICAgICBjb25zdCB0eCA9IC0ocmlnaHQgKyBsZWZ0KSAqIGEzOwogICAgICAgIGNvbnN0IHR5ID0gLSh0b3AgKyBib3R0b20pICogYjsKICAgICAgICBjb25zdCB0eiA9IC0oZmFyICsgbmVhcikgKiBjOwogICAgICAgIGEzICo9IDI7CiAgICAgICAgYiAqPSAyOwogICAgICAgIGMgKj0gLTI7CiAgICAgICAgcmVzdWx0WzBdID0gYTM7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICByZXN1bHRbNV0gPSBiOwogICAgICAgIHJlc3VsdFs2XSA9IDA7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSAwOwogICAgICAgIHJlc3VsdFs5XSA9IDA7CiAgICAgICAgcmVzdWx0WzEwXSA9IGM7CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IHR4OwogICAgICAgIHJlc3VsdFsxM10gPSB0eTsKICAgICAgICByZXN1bHRbMTRdID0gdHo7CiAgICAgICAgcmVzdWx0WzE1XSA9IDE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5jb21wdXRlUGVyc3BlY3RpdmVPZmZDZW50ZXIgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYm90dG9tLCB0b3AsIG5lYXIsIGZhciwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImJvdHRvbSIsIGJvdHRvbSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0b3AiLCB0b3ApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibmVhciIsIG5lYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiZmFyIiwgZmFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSAyICogbmVhciAvIChyaWdodCAtIGxlZnQpOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gMiAqIG5lYXIgLyAodG9wIC0gYm90dG9tKTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IChyaWdodCArIGxlZnQpIC8gKHJpZ2h0IC0gbGVmdCk7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzEgPSAodG9wICsgYm90dG9tKSAvICh0b3AgLSBib3R0b20pOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gLShmYXIgKyBuZWFyKSAvIChmYXIgLSBuZWFyKTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MyA9IC0xOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cyID0gLTIgKiBmYXIgKiBuZWFyIC8gKGZhciAtIG5lYXIpOwogICAgICAgIHJlc3VsdFswXSA9IGNvbHVtbjBSb3cwOwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IDA7CiAgICAgICAgcmVzdWx0WzVdID0gY29sdW1uMVJvdzE7CiAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IGNvbHVtbjJSb3cwOwogICAgICAgIHJlc3VsdFs5XSA9IGNvbHVtbjJSb3cxOwogICAgICAgIHJlc3VsdFsxMF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXN1bHRbMTFdID0gY29sdW1uMlJvdzM7CiAgICAgICAgcmVzdWx0WzEyXSA9IDA7CiAgICAgICAgcmVzdWx0WzEzXSA9IDA7CiAgICAgICAgcmVzdWx0WzE0XSA9IGNvbHVtbjNSb3cyOwogICAgICAgIHJlc3VsdFsxNV0gPSAwOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuY29tcHV0ZUluZmluaXRlUGVyc3BlY3RpdmVPZmZDZW50ZXIgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgYm90dG9tLCB0b3AsIG5lYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJib3R0b20iLCBib3R0b20pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidG9wIiwgdG9wKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm5lYXIiLCBuZWFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSAyICogbmVhciAvIChyaWdodCAtIGxlZnQpOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gMiAqIG5lYXIgLyAodG9wIC0gYm90dG9tKTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IChyaWdodCArIGxlZnQpIC8gKHJpZ2h0IC0gbGVmdCk7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzEgPSAodG9wICsgYm90dG9tKSAvICh0b3AgLSBib3R0b20pOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gLTE7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzMgPSAtMTsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MiA9IC0yICogbmVhcjsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSAwOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSAwOwogICAgICAgIHJlc3VsdFs1XSA9IGNvbHVtbjFSb3cxOwogICAgICAgIHJlc3VsdFs2XSA9IDA7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSBjb2x1bW4yUm93MDsKICAgICAgICByZXN1bHRbOV0gPSBjb2x1bW4yUm93MTsKICAgICAgICByZXN1bHRbMTBdID0gY29sdW1uMlJvdzI7CiAgICAgICAgcmVzdWx0WzExXSA9IGNvbHVtbjJSb3czOwogICAgICAgIHJlc3VsdFsxMl0gPSAwOwogICAgICAgIHJlc3VsdFsxM10gPSAwOwogICAgICAgIHJlc3VsdFsxNF0gPSBjb2x1bW4zUm93MjsKICAgICAgICByZXN1bHRbMTVdID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmNvbXB1dGVWaWV3cG9ydFRyYW5zZm9ybWF0aW9uID0gZnVuY3Rpb24odmlld3BvcnQsIG5lYXJEZXB0aFJhbmdlLCBmYXJEZXB0aFJhbmdlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4NCgpOwogICAgICAgIH0KICAgICAgICB2aWV3cG9ydCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZpZXdwb3J0LCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2aWV3cG9ydC54LCAwKTsKICAgICAgICBjb25zdCB5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmlld3BvcnQueSwgMCk7CiAgICAgICAgY29uc3Qgd2lkdGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2aWV3cG9ydC53aWR0aCwgMCk7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmlld3BvcnQuaGVpZ2h0LCAwKTsKICAgICAgICBuZWFyRGVwdGhSYW5nZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG5lYXJEZXB0aFJhbmdlLCAwKTsKICAgICAgICBmYXJEZXB0aFJhbmdlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZmFyRGVwdGhSYW5nZSwgMSk7CiAgICAgICAgY29uc3QgaGFsZldpZHRoID0gd2lkdGggKiAwLjU7CiAgICAgICAgY29uc3QgaGFsZkhlaWdodCA9IGhlaWdodCAqIDAuNTsKICAgICAgICBjb25zdCBoYWxmRGVwdGggPSAoZmFyRGVwdGhSYW5nZSAtIG5lYXJEZXB0aFJhbmdlKSAqIDAuNTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IGhhbGZXaWR0aDsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IGhhbGZIZWlnaHQ7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzIgPSBoYWxmRGVwdGg7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzAgPSB4ICsgaGFsZldpZHRoOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cxID0geSArIGhhbGZIZWlnaHQ7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzIgPSBuZWFyRGVwdGhSYW5nZSArIGhhbGZEZXB0aDsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MyA9IDE7CiAgICAgICAgcmVzdWx0WzBdID0gY29sdW1uMFJvdzA7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICByZXN1bHRbNV0gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXN1bHRbNl0gPSAwOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gMDsKICAgICAgICByZXN1bHRbOV0gPSAwOwogICAgICAgIHJlc3VsdFsxMF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0gY29sdW1uM1JvdzA7CiAgICAgICAgcmVzdWx0WzEzXSA9IGNvbHVtbjNSb3cxOwogICAgICAgIHJlc3VsdFsxNF0gPSBjb2x1bW4zUm93MjsKICAgICAgICByZXN1bHRbMTVdID0gY29sdW1uM1JvdzM7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5jb21wdXRlVmlldyA9IGZ1bmN0aW9uKHBvc2l0aW9uLCBkaXJlY3Rpb24yLCB1cCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicG9zaXRpb24iLCBwb3NpdGlvbik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkaXJlY3Rpb24iLCBkaXJlY3Rpb24yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInVwIiwgdXApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IHJpZ2h0Lng7CiAgICAgICAgcmVzdWx0WzFdID0gdXAueDsKICAgICAgICByZXN1bHRbMl0gPSAtZGlyZWN0aW9uMi54OwogICAgICAgIHJlc3VsdFszXSA9IDA7CiAgICAgICAgcmVzdWx0WzRdID0gcmlnaHQueTsKICAgICAgICByZXN1bHRbNV0gPSB1cC55OwogICAgICAgIHJlc3VsdFs2XSA9IC1kaXJlY3Rpb24yLnk7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSByaWdodC56OwogICAgICAgIHJlc3VsdFs5XSA9IHVwLno7CiAgICAgICAgcmVzdWx0WzEwXSA9IC1kaXJlY3Rpb24yLno7CiAgICAgICAgcmVzdWx0WzExXSA9IDA7CiAgICAgICAgcmVzdWx0WzEyXSA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHJpZ2h0LCBwb3NpdGlvbik7CiAgICAgICAgcmVzdWx0WzEzXSA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHVwLCBwb3NpdGlvbik7CiAgICAgICAgcmVzdWx0WzE0XSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgcG9zaXRpb24pOwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQudG9BcnJheSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgIG1hdHJpeFswXSwKICAgICAgICAgICAgbWF0cml4WzFdLAogICAgICAgICAgICBtYXRyaXhbMl0sCiAgICAgICAgICAgIG1hdHJpeFszXSwKICAgICAgICAgICAgbWF0cml4WzRdLAogICAgICAgICAgICBtYXRyaXhbNV0sCiAgICAgICAgICAgIG1hdHJpeFs2XSwKICAgICAgICAgICAgbWF0cml4WzddLAogICAgICAgICAgICBtYXRyaXhbOF0sCiAgICAgICAgICAgIG1hdHJpeFs5XSwKICAgICAgICAgICAgbWF0cml4WzEwXSwKICAgICAgICAgICAgbWF0cml4WzExXSwKICAgICAgICAgICAgbWF0cml4WzEyXSwKICAgICAgICAgICAgbWF0cml4WzEzXSwKICAgICAgICAgICAgbWF0cml4WzE0XSwKICAgICAgICAgICAgbWF0cml4WzE1XQogICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV07CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF07CiAgICAgICAgcmVzdWx0WzldID0gbWF0cml4WzldOwogICAgICAgIHJlc3VsdFsxMF0gPSBtYXRyaXhbMTBdOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBtYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSBtYXRyaXhbMTNdOwogICAgICAgIHJlc3VsdFsxNF0gPSBtYXRyaXhbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZ2V0RWxlbWVudEluZGV4ID0gZnVuY3Rpb24oY29sdW1uLCByb3cpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygicm93Iiwgcm93LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygicm93Iiwgcm93LCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiY29sdW1uIiwgY29sdW1uLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiY29sdW1uIiwgY29sdW1uLCAzKTsKICAgICAgICByZXR1cm4gY29sdW1uICogNCArIHJvdzsKICAgICAgfTsKICAgICAgTWF0cml4NC5nZXRDb2x1bW4gPSBmdW5jdGlvbihtYXRyaXgsIGluZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogNDsKICAgICAgICBjb25zdCB4ID0gbWF0cml4W3N0YXJ0SW5kZXhdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbc3RhcnRJbmRleCArIDFdOwogICAgICAgIGNvbnN0IHogPSBtYXRyaXhbc3RhcnRJbmRleCArIDJdOwogICAgICAgIGNvbnN0IHcgPSBtYXRyaXhbc3RhcnRJbmRleCArIDNdOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJlc3VsdC53ID0gdzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnNldENvbHVtbiA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0ID0gTWF0cml4NC5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogNDsKICAgICAgICByZXN1bHRbc3RhcnRJbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMV0gPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMl0gPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgM10gPSBjYXJ0ZXNpYW4xMS53OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZ2V0Um93ID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbaW5kZXhdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbaW5kZXggKyA0XTsKICAgICAgICBjb25zdCB6ID0gbWF0cml4W2luZGV4ICsgOF07CiAgICAgICAgY29uc3QgdyA9IG1hdHJpeFtpbmRleCArIDEyXTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5zZXRSb3cgPSBmdW5jdGlvbihtYXRyaXgsIGluZGV4LCBjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdCA9IE1hdHJpeDQuY2xvbmUobWF0cml4LCByZXN1bHQpOwogICAgICAgIHJlc3VsdFtpbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtpbmRleCArIDRdID0gY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHRbaW5kZXggKyA4XSA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgcmVzdWx0W2luZGV4ICsgMTJdID0gY2FydGVzaWFuMTEudzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnNldFRyYW5zbGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCB0cmFuc2xhdGlvbjIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInRyYW5zbGF0aW9uIiwgdHJhbnNsYXRpb24yKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV07CiAgICAgICAgcmVzdWx0WzZdID0gbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF07CiAgICAgICAgcmVzdWx0WzldID0gbWF0cml4WzldOwogICAgICAgIHJlc3VsdFsxMF0gPSBtYXRyaXhbMTBdOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSB0cmFuc2xhdGlvbjIueDsKICAgICAgICByZXN1bHRbMTNdID0gdHJhbnNsYXRpb24yLnk7CiAgICAgICAgcmVzdWx0WzE0XSA9IHRyYW5zbGF0aW9uMi56OwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDEyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXg0LnNldFNjYWxlID0gZnVuY3Rpb24obWF0cml4LCBzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGV4aXN0aW5nU2NhbGUgPSBNYXRyaXg0LmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMTIpOwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9YID0gc2NhbGUueCAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlLnkgLyBleGlzdGluZ1NjYWxlLnk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ogPSBzY2FsZS56IC8gZXhpc3RpbmdTY2FsZS56OwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNV0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzldID0gbWF0cml4WzldICogc2NhbGVSYXRpb1o7CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeFsxMF0gKiBzY2FsZVJhdGlvWjsKICAgICAgICByZXN1bHRbMTFdID0gbWF0cml4WzExXTsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gyMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4NC5zZXRVbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZXhpc3RpbmdTY2FsZSA9IE1hdHJpeDQuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gyMik7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ggPSBzY2FsZSAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlIC8gZXhpc3RpbmdTY2FsZS55OwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9aID0gc2NhbGUgLyBleGlzdGluZ1NjYWxlLno7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGVSYXRpb1g7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsZVJhdGlvWjsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV0gKiBzY2FsZVJhdGlvWjsKICAgICAgICByZXN1bHRbMTBdID0gbWF0cml4WzEwXSAqIHNjYWxlUmF0aW9aOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBtYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSBtYXRyaXhbMTNdOwogICAgICAgIHJlc3VsdFsxNF0gPSBtYXRyaXhbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDb2x1bW4yID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXg0LmdldFNjYWxlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tRWxlbWVudHMobWF0cml4WzBdLCBtYXRyaXhbMV0sIG1hdHJpeFsyXSwgc2NyYXRjaENvbHVtbjIpCiAgICAgICAgKTsKICAgICAgICByZXN1bHQueSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKG1hdHJpeFs0XSwgbWF0cml4WzVdLCBtYXRyaXhbNl0sIHNjcmF0Y2hDb2x1bW4yKQogICAgICAgICk7CiAgICAgICAgcmVzdWx0LnogPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21FbGVtZW50cyhtYXRyaXhbOF0sIG1hdHJpeFs5XSwgbWF0cml4WzEwXSwgc2NyYXRjaENvbHVtbjIpCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gzMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTWF0cml4NC5nZXRNYXhpbXVtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgpIHsKICAgICAgICBNYXRyaXg0LmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMzIpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubWF4aW11bUNvbXBvbmVudChzY2FsZVNjcmF0Y2gzMik7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDQyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBNYXRyaXg0LnNldFJvdGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCByb3RhdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzY2FsZSA9IE1hdHJpeDQuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2g0Mik7CiAgICAgICAgcmVzdWx0WzBdID0gcm90YXRpb25bMF0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFsxXSA9IHJvdGF0aW9uWzFdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMl0gPSByb3RhdGlvblsyXSAqIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IHJvdGF0aW9uWzNdICogc2NhbGUueTsKICAgICAgICByZXN1bHRbNV0gPSByb3RhdGlvbls0XSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzZdID0gcm90YXRpb25bNV0gKiBzY2FsZS55OwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSByb3RhdGlvbls2XSAqIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzldID0gcm90YXRpb25bN10gKiBzY2FsZS56OwogICAgICAgIHJlc3VsdFsxMF0gPSByb3RhdGlvbls4XSAqIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IG1hdHJpeFsxMl07CiAgICAgICAgcmVzdWx0WzEzXSA9IG1hdHJpeFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzE1XSA9IG1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoNTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDQuZ2V0Um90YXRpb24gPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc2NhbGUgPSBNYXRyaXg0LmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoNTIpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAvIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdIC8gc2NhbGUueDsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gLyBzY2FsZS54OwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFs0XSAvIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzVdIC8gc2NhbGUueTsKICAgICAgICByZXN1bHRbNV0gPSBtYXRyaXhbNl0gLyBzY2FsZS55OwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs4XSAvIHNjYWxlLno7CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzldIC8gc2NhbGUuejsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbMTBdIC8gc2NhbGUuejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGxlZnQwID0gbGVmdFswXTsKICAgICAgICBjb25zdCBsZWZ0MSA9IGxlZnRbMV07CiAgICAgICAgY29uc3QgbGVmdDIgPSBsZWZ0WzJdOwogICAgICAgIGNvbnN0IGxlZnQzID0gbGVmdFszXTsKICAgICAgICBjb25zdCBsZWZ0NCA9IGxlZnRbNF07CiAgICAgICAgY29uc3QgbGVmdDUgPSBsZWZ0WzVdOwogICAgICAgIGNvbnN0IGxlZnQ2ID0gbGVmdFs2XTsKICAgICAgICBjb25zdCBsZWZ0NyA9IGxlZnRbN107CiAgICAgICAgY29uc3QgbGVmdDggPSBsZWZ0WzhdOwogICAgICAgIGNvbnN0IGxlZnQ5ID0gbGVmdFs5XTsKICAgICAgICBjb25zdCBsZWZ0MTAgPSBsZWZ0WzEwXTsKICAgICAgICBjb25zdCBsZWZ0MTEgPSBsZWZ0WzExXTsKICAgICAgICBjb25zdCBsZWZ0MTIgPSBsZWZ0WzEyXTsKICAgICAgICBjb25zdCBsZWZ0MTMgPSBsZWZ0WzEzXTsKICAgICAgICBjb25zdCBsZWZ0MTQgPSBsZWZ0WzE0XTsKICAgICAgICBjb25zdCBsZWZ0MTUgPSBsZWZ0WzE1XTsKICAgICAgICBjb25zdCByaWdodDAgPSByaWdodFswXTsKICAgICAgICBjb25zdCByaWdodDEgPSByaWdodFsxXTsKICAgICAgICBjb25zdCByaWdodDIgPSByaWdodFsyXTsKICAgICAgICBjb25zdCByaWdodDMgPSByaWdodFszXTsKICAgICAgICBjb25zdCByaWdodDQgPSByaWdodFs0XTsKICAgICAgICBjb25zdCByaWdodDUgPSByaWdodFs1XTsKICAgICAgICBjb25zdCByaWdodDYgPSByaWdodFs2XTsKICAgICAgICBjb25zdCByaWdodDcgPSByaWdodFs3XTsKICAgICAgICBjb25zdCByaWdodDggPSByaWdodFs4XTsKICAgICAgICBjb25zdCByaWdodDkgPSByaWdodFs5XTsKICAgICAgICBjb25zdCByaWdodDEwID0gcmlnaHRbMTBdOwogICAgICAgIGNvbnN0IHJpZ2h0MTEgPSByaWdodFsxMV07CiAgICAgICAgY29uc3QgcmlnaHQxMiA9IHJpZ2h0WzEyXTsKICAgICAgICBjb25zdCByaWdodDEzID0gcmlnaHRbMTNdOwogICAgICAgIGNvbnN0IHJpZ2h0MTQgPSByaWdodFsxNF07CiAgICAgICAgY29uc3QgcmlnaHQxNSA9IHJpZ2h0WzE1XTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IGxlZnQwICogcmlnaHQwICsgbGVmdDQgKiByaWdodDEgKyBsZWZ0OCAqIHJpZ2h0MiArIGxlZnQxMiAqIHJpZ2h0MzsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MSA9IGxlZnQxICogcmlnaHQwICsgbGVmdDUgKiByaWdodDEgKyBsZWZ0OSAqIHJpZ2h0MiArIGxlZnQxMyAqIHJpZ2h0MzsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MiA9IGxlZnQyICogcmlnaHQwICsgbGVmdDYgKiByaWdodDEgKyBsZWZ0MTAgKiByaWdodDIgKyBsZWZ0MTQgKiByaWdodDM7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzMgPSBsZWZ0MyAqIHJpZ2h0MCArIGxlZnQ3ICogcmlnaHQxICsgbGVmdDExICogcmlnaHQyICsgbGVmdDE1ICogcmlnaHQzOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cwID0gbGVmdDAgKiByaWdodDQgKyBsZWZ0NCAqIHJpZ2h0NSArIGxlZnQ4ICogcmlnaHQ2ICsgbGVmdDEyICogcmlnaHQ3OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gbGVmdDEgKiByaWdodDQgKyBsZWZ0NSAqIHJpZ2h0NSArIGxlZnQ5ICogcmlnaHQ2ICsgbGVmdDEzICogcmlnaHQ3OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cyID0gbGVmdDIgKiByaWdodDQgKyBsZWZ0NiAqIHJpZ2h0NSArIGxlZnQxMCAqIHJpZ2h0NiArIGxlZnQxNCAqIHJpZ2h0NzsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MyA9IGxlZnQzICogcmlnaHQ0ICsgbGVmdDcgKiByaWdodDUgKyBsZWZ0MTEgKiByaWdodDYgKyBsZWZ0MTUgKiByaWdodDc7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzAgPSBsZWZ0MCAqIHJpZ2h0OCArIGxlZnQ0ICogcmlnaHQ5ICsgbGVmdDggKiByaWdodDEwICsgbGVmdDEyICogcmlnaHQxMTsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MSA9IGxlZnQxICogcmlnaHQ4ICsgbGVmdDUgKiByaWdodDkgKyBsZWZ0OSAqIHJpZ2h0MTAgKyBsZWZ0MTMgKiByaWdodDExOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gbGVmdDIgKiByaWdodDggKyBsZWZ0NiAqIHJpZ2h0OSArIGxlZnQxMCAqIHJpZ2h0MTAgKyBsZWZ0MTQgKiByaWdodDExOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3czID0gbGVmdDMgKiByaWdodDggKyBsZWZ0NyAqIHJpZ2h0OSArIGxlZnQxMSAqIHJpZ2h0MTAgKyBsZWZ0MTUgKiByaWdodDExOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cwID0gbGVmdDAgKiByaWdodDEyICsgbGVmdDQgKiByaWdodDEzICsgbGVmdDggKiByaWdodDE0ICsgbGVmdDEyICogcmlnaHQxNTsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MSA9IGxlZnQxICogcmlnaHQxMiArIGxlZnQ1ICogcmlnaHQxMyArIGxlZnQ5ICogcmlnaHQxNCArIGxlZnQxMyAqIHJpZ2h0MTU7CiAgICAgICAgY29uc3QgY29sdW1uM1JvdzIgPSBsZWZ0MiAqIHJpZ2h0MTIgKyBsZWZ0NiAqIHJpZ2h0MTMgKyBsZWZ0MTAgKiByaWdodDE0ICsgbGVmdDE0ICogcmlnaHQxNTsKICAgICAgICBjb25zdCBjb2x1bW4zUm93MyA9IGxlZnQzICogcmlnaHQxMiArIGxlZnQ3ICogcmlnaHQxMyArIGxlZnQxMSAqIHJpZ2h0MTQgKyBsZWZ0MTUgKiByaWdodDE1OwogICAgICAgIHJlc3VsdFswXSA9IGNvbHVtbjBSb3cwOwogICAgICAgIHJlc3VsdFsxXSA9IGNvbHVtbjBSb3cxOwogICAgICAgIHJlc3VsdFsyXSA9IGNvbHVtbjBSb3cyOwogICAgICAgIHJlc3VsdFszXSA9IGNvbHVtbjBSb3czOwogICAgICAgIHJlc3VsdFs0XSA9IGNvbHVtbjFSb3cwOwogICAgICAgIHJlc3VsdFs1XSA9IGNvbHVtbjFSb3cxOwogICAgICAgIHJlc3VsdFs2XSA9IGNvbHVtbjFSb3cyOwogICAgICAgIHJlc3VsdFs3XSA9IGNvbHVtbjFSb3czOwogICAgICAgIHJlc3VsdFs4XSA9IGNvbHVtbjJSb3cwOwogICAgICAgIHJlc3VsdFs5XSA9IGNvbHVtbjJSb3cxOwogICAgICAgIHJlc3VsdFsxMF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXN1bHRbMTFdID0gY29sdW1uMlJvdzM7CiAgICAgICAgcmVzdWx0WzEyXSA9IGNvbHVtbjNSb3cwOwogICAgICAgIHJlc3VsdFsxM10gPSBjb2x1bW4zUm93MTsKICAgICAgICByZXN1bHRbMTRdID0gY29sdW1uM1JvdzI7CiAgICAgICAgcmVzdWx0WzE1XSA9IGNvbHVtbjNSb3czOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuYWRkID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IGxlZnRbMF0gKyByaWdodFswXTsKICAgICAgICByZXN1bHRbMV0gPSBsZWZ0WzFdICsgcmlnaHRbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbGVmdFsyXSArIHJpZ2h0WzJdOwogICAgICAgIHJlc3VsdFszXSA9IGxlZnRbM10gKyByaWdodFszXTsKICAgICAgICByZXN1bHRbNF0gPSBsZWZ0WzRdICsgcmlnaHRbNF07CiAgICAgICAgcmVzdWx0WzVdID0gbGVmdFs1XSArIHJpZ2h0WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IGxlZnRbNl0gKyByaWdodFs2XTsKICAgICAgICByZXN1bHRbN10gPSBsZWZ0WzddICsgcmlnaHRbN107CiAgICAgICAgcmVzdWx0WzhdID0gbGVmdFs4XSArIHJpZ2h0WzhdOwogICAgICAgIHJlc3VsdFs5XSA9IGxlZnRbOV0gKyByaWdodFs5XTsKICAgICAgICByZXN1bHRbMTBdID0gbGVmdFsxMF0gKyByaWdodFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IGxlZnRbMTFdICsgcmlnaHRbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBsZWZ0WzEyXSArIHJpZ2h0WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbGVmdFsxM10gKyByaWdodFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IGxlZnRbMTRdICsgcmlnaHRbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBsZWZ0WzE1XSArIHJpZ2h0WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LnN1YnRyYWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IGxlZnRbMF0gLSByaWdodFswXTsKICAgICAgICByZXN1bHRbMV0gPSBsZWZ0WzFdIC0gcmlnaHRbMV07CiAgICAgICAgcmVzdWx0WzJdID0gbGVmdFsyXSAtIHJpZ2h0WzJdOwogICAgICAgIHJlc3VsdFszXSA9IGxlZnRbM10gLSByaWdodFszXTsKICAgICAgICByZXN1bHRbNF0gPSBsZWZ0WzRdIC0gcmlnaHRbNF07CiAgICAgICAgcmVzdWx0WzVdID0gbGVmdFs1XSAtIHJpZ2h0WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IGxlZnRbNl0gLSByaWdodFs2XTsKICAgICAgICByZXN1bHRbN10gPSBsZWZ0WzddIC0gcmlnaHRbN107CiAgICAgICAgcmVzdWx0WzhdID0gbGVmdFs4XSAtIHJpZ2h0WzhdOwogICAgICAgIHJlc3VsdFs5XSA9IGxlZnRbOV0gLSByaWdodFs5XTsKICAgICAgICByZXN1bHRbMTBdID0gbGVmdFsxMF0gLSByaWdodFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IGxlZnRbMTFdIC0gcmlnaHRbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBsZWZ0WzEyXSAtIHJpZ2h0WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbGVmdFsxM10gLSByaWdodFsxM107CiAgICAgICAgcmVzdWx0WzE0XSA9IGxlZnRbMTRdIC0gcmlnaHRbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBsZWZ0WzE1XSAtIHJpZ2h0WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5VHJhbnNmb3JtYXRpb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbGVmdDAgPSBsZWZ0WzBdOwogICAgICAgIGNvbnN0IGxlZnQxID0gbGVmdFsxXTsKICAgICAgICBjb25zdCBsZWZ0MiA9IGxlZnRbMl07CiAgICAgICAgY29uc3QgbGVmdDQgPSBsZWZ0WzRdOwogICAgICAgIGNvbnN0IGxlZnQ1ID0gbGVmdFs1XTsKICAgICAgICBjb25zdCBsZWZ0NiA9IGxlZnRbNl07CiAgICAgICAgY29uc3QgbGVmdDggPSBsZWZ0WzhdOwogICAgICAgIGNvbnN0IGxlZnQ5ID0gbGVmdFs5XTsKICAgICAgICBjb25zdCBsZWZ0MTAgPSBsZWZ0WzEwXTsKICAgICAgICBjb25zdCBsZWZ0MTIgPSBsZWZ0WzEyXTsKICAgICAgICBjb25zdCBsZWZ0MTMgPSBsZWZ0WzEzXTsKICAgICAgICBjb25zdCBsZWZ0MTQgPSBsZWZ0WzE0XTsKICAgICAgICBjb25zdCByaWdodDAgPSByaWdodFswXTsKICAgICAgICBjb25zdCByaWdodDEgPSByaWdodFsxXTsKICAgICAgICBjb25zdCByaWdodDIgPSByaWdodFsyXTsKICAgICAgICBjb25zdCByaWdodDQgPSByaWdodFs0XTsKICAgICAgICBjb25zdCByaWdodDUgPSByaWdodFs1XTsKICAgICAgICBjb25zdCByaWdodDYgPSByaWdodFs2XTsKICAgICAgICBjb25zdCByaWdodDggPSByaWdodFs4XTsKICAgICAgICBjb25zdCByaWdodDkgPSByaWdodFs5XTsKICAgICAgICBjb25zdCByaWdodDEwID0gcmlnaHRbMTBdOwogICAgICAgIGNvbnN0IHJpZ2h0MTIgPSByaWdodFsxMl07CiAgICAgICAgY29uc3QgcmlnaHQxMyA9IHJpZ2h0WzEzXTsKICAgICAgICBjb25zdCByaWdodDE0ID0gcmlnaHRbMTRdOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cwID0gbGVmdDAgKiByaWdodDAgKyBsZWZ0NCAqIHJpZ2h0MSArIGxlZnQ4ICogcmlnaHQyOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cxID0gbGVmdDEgKiByaWdodDAgKyBsZWZ0NSAqIHJpZ2h0MSArIGxlZnQ5ICogcmlnaHQyOwogICAgICAgIGNvbnN0IGNvbHVtbjBSb3cyID0gbGVmdDIgKiByaWdodDAgKyBsZWZ0NiAqIHJpZ2h0MSArIGxlZnQxMCAqIHJpZ2h0MjsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MCA9IGxlZnQwICogcmlnaHQ0ICsgbGVmdDQgKiByaWdodDUgKyBsZWZ0OCAqIHJpZ2h0NjsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IGxlZnQxICogcmlnaHQ0ICsgbGVmdDUgKiByaWdodDUgKyBsZWZ0OSAqIHJpZ2h0NjsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MiA9IGxlZnQyICogcmlnaHQ0ICsgbGVmdDYgKiByaWdodDUgKyBsZWZ0MTAgKiByaWdodDY7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzAgPSBsZWZ0MCAqIHJpZ2h0OCArIGxlZnQ0ICogcmlnaHQ5ICsgbGVmdDggKiByaWdodDEwOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cxID0gbGVmdDEgKiByaWdodDggKyBsZWZ0NSAqIHJpZ2h0OSArIGxlZnQ5ICogcmlnaHQxMDsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MiA9IGxlZnQyICogcmlnaHQ4ICsgbGVmdDYgKiByaWdodDkgKyBsZWZ0MTAgKiByaWdodDEwOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cwID0gbGVmdDAgKiByaWdodDEyICsgbGVmdDQgKiByaWdodDEzICsgbGVmdDggKiByaWdodDE0ICsgbGVmdDEyOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cxID0gbGVmdDEgKiByaWdodDEyICsgbGVmdDUgKiByaWdodDEzICsgbGVmdDkgKiByaWdodDE0ICsgbGVmdDEzOwogICAgICAgIGNvbnN0IGNvbHVtbjNSb3cyID0gbGVmdDIgKiByaWdodDEyICsgbGVmdDYgKiByaWdodDEzICsgbGVmdDEwICogcmlnaHQxNCArIGxlZnQxNDsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSBjb2x1bW4wUm93MTsKICAgICAgICByZXN1bHRbMl0gPSBjb2x1bW4wUm93MjsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IGNvbHVtbjFSb3cwOwogICAgICAgIHJlc3VsdFs1XSA9IGNvbHVtbjFSb3cxOwogICAgICAgIHJlc3VsdFs2XSA9IGNvbHVtbjFSb3cyOwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gY29sdW1uMlJvdzA7CiAgICAgICAgcmVzdWx0WzldID0gY29sdW1uMlJvdzE7CiAgICAgICAgcmVzdWx0WzEwXSA9IGNvbHVtbjJSb3cyOwogICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgIHJlc3VsdFsxMl0gPSBjb2x1bW4zUm93MDsKICAgICAgICByZXN1bHRbMTNdID0gY29sdW1uM1JvdzE7CiAgICAgICAgcmVzdWx0WzE0XSA9IGNvbHVtbjNSb3cyOwogICAgICAgIHJlc3VsdFsxNV0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQubXVsdGlwbHlCeU1hdHJpeDMgPSBmdW5jdGlvbihtYXRyaXgsIHJvdGF0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyb3RhdGlvbiIsIHJvdGF0aW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbGVmdDAgPSBtYXRyaXhbMF07CiAgICAgICAgY29uc3QgbGVmdDEgPSBtYXRyaXhbMV07CiAgICAgICAgY29uc3QgbGVmdDIgPSBtYXRyaXhbMl07CiAgICAgICAgY29uc3QgbGVmdDQgPSBtYXRyaXhbNF07CiAgICAgICAgY29uc3QgbGVmdDUgPSBtYXRyaXhbNV07CiAgICAgICAgY29uc3QgbGVmdDYgPSBtYXRyaXhbNl07CiAgICAgICAgY29uc3QgbGVmdDggPSBtYXRyaXhbOF07CiAgICAgICAgY29uc3QgbGVmdDkgPSBtYXRyaXhbOV07CiAgICAgICAgY29uc3QgbGVmdDEwID0gbWF0cml4WzEwXTsKICAgICAgICBjb25zdCByaWdodDAgPSByb3RhdGlvblswXTsKICAgICAgICBjb25zdCByaWdodDEgPSByb3RhdGlvblsxXTsKICAgICAgICBjb25zdCByaWdodDIgPSByb3RhdGlvblsyXTsKICAgICAgICBjb25zdCByaWdodDQgPSByb3RhdGlvblszXTsKICAgICAgICBjb25zdCByaWdodDUgPSByb3RhdGlvbls0XTsKICAgICAgICBjb25zdCByaWdodDYgPSByb3RhdGlvbls1XTsKICAgICAgICBjb25zdCByaWdodDggPSByb3RhdGlvbls2XTsKICAgICAgICBjb25zdCByaWdodDkgPSByb3RhdGlvbls3XTsKICAgICAgICBjb25zdCByaWdodDEwID0gcm90YXRpb25bOF07CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSBsZWZ0MCAqIHJpZ2h0MCArIGxlZnQ0ICogcmlnaHQxICsgbGVmdDggKiByaWdodDI7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzEgPSBsZWZ0MSAqIHJpZ2h0MCArIGxlZnQ1ICogcmlnaHQxICsgbGVmdDkgKiByaWdodDI7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzIgPSBsZWZ0MiAqIHJpZ2h0MCArIGxlZnQ2ICogcmlnaHQxICsgbGVmdDEwICogcmlnaHQyOwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cwID0gbGVmdDAgKiByaWdodDQgKyBsZWZ0NCAqIHJpZ2h0NSArIGxlZnQ4ICogcmlnaHQ2OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gbGVmdDEgKiByaWdodDQgKyBsZWZ0NSAqIHJpZ2h0NSArIGxlZnQ5ICogcmlnaHQ2OwogICAgICAgIGNvbnN0IGNvbHVtbjFSb3cyID0gbGVmdDIgKiByaWdodDQgKyBsZWZ0NiAqIHJpZ2h0NSArIGxlZnQxMCAqIHJpZ2h0NjsKICAgICAgICBjb25zdCBjb2x1bW4yUm93MCA9IGxlZnQwICogcmlnaHQ4ICsgbGVmdDQgKiByaWdodDkgKyBsZWZ0OCAqIHJpZ2h0MTA7CiAgICAgICAgY29uc3QgY29sdW1uMlJvdzEgPSBsZWZ0MSAqIHJpZ2h0OCArIGxlZnQ1ICogcmlnaHQ5ICsgbGVmdDkgKiByaWdodDEwOwogICAgICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gbGVmdDIgKiByaWdodDggKyBsZWZ0NiAqIHJpZ2h0OSArIGxlZnQxMCAqIHJpZ2h0MTA7CiAgICAgICAgcmVzdWx0WzBdID0gY29sdW1uMFJvdzA7CiAgICAgICAgcmVzdWx0WzFdID0gY29sdW1uMFJvdzE7CiAgICAgICAgcmVzdWx0WzJdID0gY29sdW1uMFJvdzI7CiAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICByZXN1bHRbNF0gPSBjb2x1bW4xUm93MDsKICAgICAgICByZXN1bHRbNV0gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXN1bHRbNl0gPSBjb2x1bW4xUm93MjsKICAgICAgICByZXN1bHRbN10gPSAwOwogICAgICAgIHJlc3VsdFs4XSA9IGNvbHVtbjJSb3cwOwogICAgICAgIHJlc3VsdFs5XSA9IGNvbHVtbjJSb3cxOwogICAgICAgIHJlc3VsdFsxMF0gPSBjb2x1bW4yUm93MjsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5QnlUcmFuc2xhdGlvbiA9IGZ1bmN0aW9uKG1hdHJpeCwgdHJhbnNsYXRpb24yLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2xhdGlvbiIsIHRyYW5zbGF0aW9uMik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSB0cmFuc2xhdGlvbjIueDsKICAgICAgICBjb25zdCB5ID0gdHJhbnNsYXRpb24yLnk7CiAgICAgICAgY29uc3QgeiA9IHRyYW5zbGF0aW9uMi56OwogICAgICAgIGNvbnN0IHR4ID0geCAqIG1hdHJpeFswXSArIHkgKiBtYXRyaXhbNF0gKyB6ICogbWF0cml4WzhdICsgbWF0cml4WzEyXTsKICAgICAgICBjb25zdCB0eSA9IHggKiBtYXRyaXhbMV0gKyB5ICogbWF0cml4WzVdICsgeiAqIG1hdHJpeFs5XSArIG1hdHJpeFsxM107CiAgICAgICAgY29uc3QgdHogPSB4ICogbWF0cml4WzJdICsgeSAqIG1hdHJpeFs2XSArIHogKiBtYXRyaXhbMTBdICsgbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzRdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbNl07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzddOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV07CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IHR4OwogICAgICAgIHJlc3VsdFsxM10gPSB0eTsKICAgICAgICByZXN1bHRbMTRdID0gdHo7CiAgICAgICAgcmVzdWx0WzE1XSA9IG1hdHJpeFsxNV07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5tdWx0aXBseUJ5U2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc2NhbGVYID0gc2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVkgPSBzY2FsZS55OwogICAgICAgIGNvbnN0IHNjYWxlWiA9IHNjYWxlLno7CiAgICAgICAgaWYgKHNjYWxlWCA9PT0gMSAmJiBzY2FsZVkgPT09IDEgJiYgc2NhbGVaID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gTWF0cml4NC5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlWCAqIG1hdHJpeFswXTsKICAgICAgICByZXN1bHRbMV0gPSBzY2FsZVggKiBtYXRyaXhbMV07CiAgICAgICAgcmVzdWx0WzJdID0gc2NhbGVYICogbWF0cml4WzJdOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXTsKICAgICAgICByZXN1bHRbNF0gPSBzY2FsZVkgKiBtYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzVdID0gc2NhbGVZICogbWF0cml4WzVdOwogICAgICAgIHJlc3VsdFs2XSA9IHNjYWxlWSAqIG1hdHJpeFs2XTsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gc2NhbGVaICogbWF0cml4WzhdOwogICAgICAgIHJlc3VsdFs5XSA9IHNjYWxlWiAqIG1hdHJpeFs5XTsKICAgICAgICByZXN1bHRbMTBdID0gc2NhbGVaICogbWF0cml4WzEwXTsKICAgICAgICByZXN1bHRbMTFdID0gbWF0cml4WzExXTsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4WzE0XTsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm11bHRpcGx5QnlVbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeFs0XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFs3XSA9IG1hdHJpeFs3XTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXhbOF0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXhbOV0gKiBzY2FsZTsKICAgICAgICByZXN1bHRbMTBdID0gbWF0cml4WzEwXSAqIHNjYWxlOwogICAgICAgIHJlc3VsdFsxMV0gPSBtYXRyaXhbMTFdOwogICAgICAgIHJlc3VsdFsxMl0gPSBtYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSBtYXRyaXhbMTNdOwogICAgICAgIHJlc3VsdFsxNF0gPSBtYXRyaXhbMTRdOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQubXVsdGlwbHlCeVZlY3RvciA9IGZ1bmN0aW9uKG1hdHJpeCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdlggPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIGNvbnN0IHZZID0gY2FydGVzaWFuMTEueTsKICAgICAgICBjb25zdCB2WiA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgY29uc3QgdlcgPSBjYXJ0ZXNpYW4xMS53OwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbMF0gKiB2WCArIG1hdHJpeFs0XSAqIHZZICsgbWF0cml4WzhdICogdlogKyBtYXRyaXhbMTJdICogdlc7CiAgICAgICAgY29uc3QgeSA9IG1hdHJpeFsxXSAqIHZYICsgbWF0cml4WzVdICogdlkgKyBtYXRyaXhbOV0gKiB2WiArIG1hdHJpeFsxM10gKiB2VzsKICAgICAgICBjb25zdCB6ID0gbWF0cml4WzJdICogdlggKyBtYXRyaXhbNl0gKiB2WSArIG1hdHJpeFsxMF0gKiB2WiArIG1hdHJpeFsxNF0gKiB2VzsKICAgICAgICBjb25zdCB3ID0gbWF0cml4WzNdICogdlggKyBtYXRyaXhbN10gKiB2WSArIG1hdHJpeFsxMV0gKiB2WiArIG1hdHJpeFsxNV0gKiB2VzsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5tdWx0aXBseUJ5UG9pbnRBc1ZlY3RvciA9IGZ1bmN0aW9uKG1hdHJpeCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdlggPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIGNvbnN0IHZZID0gY2FydGVzaWFuMTEueTsKICAgICAgICBjb25zdCB2WiA9IGNhcnRlc2lhbjExLno7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFswXSAqIHZYICsgbWF0cml4WzRdICogdlkgKyBtYXRyaXhbOF0gKiB2WjsKICAgICAgICBjb25zdCB5ID0gbWF0cml4WzFdICogdlggKyBtYXRyaXhbNV0gKiB2WSArIG1hdHJpeFs5XSAqIHZaOwogICAgICAgIGNvbnN0IHogPSBtYXRyaXhbMl0gKiB2WCArIG1hdHJpeFs2XSAqIHZZICsgbWF0cml4WzEwXSAqIHZaOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQubXVsdGlwbHlCeVBvaW50ID0gZnVuY3Rpb24obWF0cml4LCBjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB2WCA9IGNhcnRlc2lhbjExLng7CiAgICAgICAgY29uc3QgdlkgPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIGNvbnN0IHZaID0gY2FydGVzaWFuMTEuejsKICAgICAgICBjb25zdCB4ID0gbWF0cml4WzBdICogdlggKyBtYXRyaXhbNF0gKiB2WSArIG1hdHJpeFs4XSAqIHZaICsgbWF0cml4WzEyXTsKICAgICAgICBjb25zdCB5ID0gbWF0cml4WzFdICogdlggKyBtYXRyaXhbNV0gKiB2WSArIG1hdHJpeFs5XSAqIHZaICsgbWF0cml4WzEzXTsKICAgICAgICBjb25zdCB6ID0gbWF0cml4WzJdICogdlggKyBtYXRyaXhbNl0gKiB2WSArIG1hdHJpeFsxMF0gKiB2WiArIG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXN1bHQueiA9IHo7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24obWF0cml4LCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXhbNF0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4WzVdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFs2XSA9IG1hdHJpeFs2XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbN10gPSBtYXRyaXhbN10gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4WzhdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFs5XSA9IG1hdHJpeFs5XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTBdID0gbWF0cml4WzEwXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTFdID0gbWF0cml4WzExXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTJdID0gbWF0cml4WzEyXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTNdID0gbWF0cml4WzEzXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTRdID0gbWF0cml4WzE0XSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbMTVdID0gbWF0cml4WzE1XSAqIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0Lm5lZ2F0ZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSAtbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IC1tYXRyaXhbMV07CiAgICAgICAgcmVzdWx0WzJdID0gLW1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSAtbWF0cml4WzNdOwogICAgICAgIHJlc3VsdFs0XSA9IC1tYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzVdID0gLW1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSAtbWF0cml4WzZdOwogICAgICAgIHJlc3VsdFs3XSA9IC1tYXRyaXhbN107CiAgICAgICAgcmVzdWx0WzhdID0gLW1hdHJpeFs4XTsKICAgICAgICByZXN1bHRbOV0gPSAtbWF0cml4WzldOwogICAgICAgIHJlc3VsdFsxMF0gPSAtbWF0cml4WzEwXTsKICAgICAgICByZXN1bHRbMTFdID0gLW1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzEyXSA9IC1tYXRyaXhbMTJdOwogICAgICAgIHJlc3VsdFsxM10gPSAtbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbMTRdID0gLW1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzE1XSA9IC1tYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQudHJhbnNwb3NlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IG1hdHJpeDEgPSBtYXRyaXhbMV07CiAgICAgICAgY29uc3QgbWF0cml4MiA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBtYXRyaXgzID0gbWF0cml4WzNdOwogICAgICAgIGNvbnN0IG1hdHJpeDYgPSBtYXRyaXhbNl07CiAgICAgICAgY29uc3QgbWF0cml4NyA9IG1hdHJpeFs3XTsKICAgICAgICBjb25zdCBtYXRyaXgxMSA9IG1hdHJpeFsxMV07CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFs0XTsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbOF07CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHRbNF0gPSBtYXRyaXgxOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs1XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbOV07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzEzXTsKICAgICAgICByZXN1bHRbOF0gPSBtYXRyaXgyOwogICAgICAgIHJlc3VsdFs5XSA9IG1hdHJpeDY7CiAgICAgICAgcmVzdWx0WzEwXSA9IG1hdHJpeFsxMF07CiAgICAgICAgcmVzdWx0WzExXSA9IG1hdHJpeFsxNF07CiAgICAgICAgcmVzdWx0WzEyXSA9IG1hdHJpeDM7CiAgICAgICAgcmVzdWx0WzEzXSA9IG1hdHJpeDc7CiAgICAgICAgcmVzdWx0WzE0XSA9IG1hdHJpeDExOwogICAgICAgIHJlc3VsdFsxNV0gPSBtYXRyaXhbMTVdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuYWJzID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdFswXSA9IE1hdGguYWJzKG1hdHJpeFswXSk7CiAgICAgICAgcmVzdWx0WzFdID0gTWF0aC5hYnMobWF0cml4WzFdKTsKICAgICAgICByZXN1bHRbMl0gPSBNYXRoLmFicyhtYXRyaXhbMl0pOwogICAgICAgIHJlc3VsdFszXSA9IE1hdGguYWJzKG1hdHJpeFszXSk7CiAgICAgICAgcmVzdWx0WzRdID0gTWF0aC5hYnMobWF0cml4WzRdKTsKICAgICAgICByZXN1bHRbNV0gPSBNYXRoLmFicyhtYXRyaXhbNV0pOwogICAgICAgIHJlc3VsdFs2XSA9IE1hdGguYWJzKG1hdHJpeFs2XSk7CiAgICAgICAgcmVzdWx0WzddID0gTWF0aC5hYnMobWF0cml4WzddKTsKICAgICAgICByZXN1bHRbOF0gPSBNYXRoLmFicyhtYXRyaXhbOF0pOwogICAgICAgIHJlc3VsdFs5XSA9IE1hdGguYWJzKG1hdHJpeFs5XSk7CiAgICAgICAgcmVzdWx0WzEwXSA9IE1hdGguYWJzKG1hdHJpeFsxMF0pOwogICAgICAgIHJlc3VsdFsxMV0gPSBNYXRoLmFicyhtYXRyaXhbMTFdKTsKICAgICAgICByZXN1bHRbMTJdID0gTWF0aC5hYnMobWF0cml4WzEyXSk7CiAgICAgICAgcmVzdWx0WzEzXSA9IE1hdGguYWJzKG1hdHJpeFsxM10pOwogICAgICAgIHJlc3VsdFsxNF0gPSBNYXRoLmFicyhtYXRyaXhbMTRdKTsKICAgICAgICByZXN1bHRbMTVdID0gTWF0aC5hYnMobWF0cml4WzE1XSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4NC5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiAvLyBUcmFuc2xhdGlvbgogICAgICAgIGxlZnRbMTJdID09PSByaWdodFsxMl0gJiYgbGVmdFsxM10gPT09IHJpZ2h0WzEzXSAmJiBsZWZ0WzE0XSA9PT0gcmlnaHRbMTRdICYmIC8vIFJvdGF0aW9uL3NjYWxlCiAgICAgICAgbGVmdFswXSA9PT0gcmlnaHRbMF0gJiYgbGVmdFsxXSA9PT0gcmlnaHRbMV0gJiYgbGVmdFsyXSA9PT0gcmlnaHRbMl0gJiYgbGVmdFs0XSA9PT0gcmlnaHRbNF0gJiYgbGVmdFs1XSA9PT0gcmlnaHRbNV0gJiYgbGVmdFs2XSA9PT0gcmlnaHRbNl0gJiYgbGVmdFs4XSA9PT0gcmlnaHRbOF0gJiYgbGVmdFs5XSA9PT0gcmlnaHRbOV0gJiYgbGVmdFsxMF0gPT09IHJpZ2h0WzEwXSAmJiAvLyBCb3R0b20gcm93CiAgICAgICAgbGVmdFszXSA9PT0gcmlnaHRbM10gJiYgbGVmdFs3XSA9PT0gcmlnaHRbN10gJiYgbGVmdFsxMV0gPT09IHJpZ2h0WzExXSAmJiBsZWZ0WzE1XSA9PT0gcmlnaHRbMTVdOwogICAgICB9OwogICAgICBNYXRyaXg0LmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgZXBzaWxvbikgewogICAgICAgIGVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlcHNpbG9uLCAwKTsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aC5hYnMobGVmdFswXSAtIHJpZ2h0WzBdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMV0gLSByaWdodFsxXSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzJdIC0gcmlnaHRbMl0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFszXSAtIHJpZ2h0WzNdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbNF0gLSByaWdodFs0XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzVdIC0gcmlnaHRbNV0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFs2XSAtIHJpZ2h0WzZdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbN10gLSByaWdodFs3XSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzhdIC0gcmlnaHRbOF0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFs5XSAtIHJpZ2h0WzldKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTBdIC0gcmlnaHRbMTBdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTFdIC0gcmlnaHRbMTFdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTJdIC0gcmlnaHRbMTJdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTNdIC0gcmlnaHRbMTNdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTRdIC0gcmlnaHRbMTRdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMTVdIC0gcmlnaHRbMTVdKSA8PSBlcHNpbG9uOwogICAgICB9OwogICAgICBNYXRyaXg0LmdldFRyYW5zbGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gbWF0cml4WzEyXTsKICAgICAgICByZXN1bHQueSA9IG1hdHJpeFsxM107CiAgICAgICAgcmVzdWx0LnogPSBtYXRyaXhbMTRdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDQuZ2V0TWF0cml4MyA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbNF07CiAgICAgICAgcmVzdWx0WzRdID0gbWF0cml4WzVdOwogICAgICAgIHJlc3VsdFs1XSA9IG1hdHJpeFs2XTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXhbOF07CiAgICAgICAgcmVzdWx0WzddID0gbWF0cml4WzldOwogICAgICAgIHJlc3VsdFs4XSA9IG1hdHJpeFsxMF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEludmVyc2VSb3RhdGlvbiA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1hdHJpeDNaZXJvID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQm90dG9tUm93ID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRXhwZWN0ZWRCb3R0b21Sb3cgPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KDAsIDAsIDAsIDEpOwogICAgICBNYXRyaXg0LmludmVyc2UgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3JjMCA9IG1hdHJpeFswXTsKICAgICAgICBjb25zdCBzcmMxID0gbWF0cml4WzRdOwogICAgICAgIGNvbnN0IHNyYzIgPSBtYXRyaXhbOF07CiAgICAgICAgY29uc3Qgc3JjMyA9IG1hdHJpeFsxMl07CiAgICAgICAgY29uc3Qgc3JjNCA9IG1hdHJpeFsxXTsKICAgICAgICBjb25zdCBzcmM1ID0gbWF0cml4WzVdOwogICAgICAgIGNvbnN0IHNyYzYgPSBtYXRyaXhbOV07CiAgICAgICAgY29uc3Qgc3JjNyA9IG1hdHJpeFsxM107CiAgICAgICAgY29uc3Qgc3JjOCA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBzcmM5ID0gbWF0cml4WzZdOwogICAgICAgIGNvbnN0IHNyYzEwID0gbWF0cml4WzEwXTsKICAgICAgICBjb25zdCBzcmMxMSA9IG1hdHJpeFsxNF07CiAgICAgICAgY29uc3Qgc3JjMTIgPSBtYXRyaXhbM107CiAgICAgICAgY29uc3Qgc3JjMTMgPSBtYXRyaXhbN107CiAgICAgICAgY29uc3Qgc3JjMTQgPSBtYXRyaXhbMTFdOwogICAgICAgIGNvbnN0IHNyYzE1ID0gbWF0cml4WzE1XTsKICAgICAgICBsZXQgdG1wMCA9IHNyYzEwICogc3JjMTU7CiAgICAgICAgbGV0IHRtcDEgPSBzcmMxMSAqIHNyYzE0OwogICAgICAgIGxldCB0bXAyID0gc3JjOSAqIHNyYzE1OwogICAgICAgIGxldCB0bXAzID0gc3JjMTEgKiBzcmMxMzsKICAgICAgICBsZXQgdG1wNCA9IHNyYzkgKiBzcmMxNDsKICAgICAgICBsZXQgdG1wNSA9IHNyYzEwICogc3JjMTM7CiAgICAgICAgbGV0IHRtcDYgPSBzcmM4ICogc3JjMTU7CiAgICAgICAgbGV0IHRtcDcgPSBzcmMxMSAqIHNyYzEyOwogICAgICAgIGxldCB0bXA4ID0gc3JjOCAqIHNyYzE0OwogICAgICAgIGxldCB0bXA5ID0gc3JjMTAgKiBzcmMxMjsKICAgICAgICBsZXQgdG1wMTAgPSBzcmM4ICogc3JjMTM7CiAgICAgICAgbGV0IHRtcDExID0gc3JjOSAqIHNyYzEyOwogICAgICAgIGNvbnN0IGRzdDAgPSB0bXAwICogc3JjNSArIHRtcDMgKiBzcmM2ICsgdG1wNCAqIHNyYzcgLSAodG1wMSAqIHNyYzUgKyB0bXAyICogc3JjNiArIHRtcDUgKiBzcmM3KTsKICAgICAgICBjb25zdCBkc3QxID0gdG1wMSAqIHNyYzQgKyB0bXA2ICogc3JjNiArIHRtcDkgKiBzcmM3IC0gKHRtcDAgKiBzcmM0ICsgdG1wNyAqIHNyYzYgKyB0bXA4ICogc3JjNyk7CiAgICAgICAgY29uc3QgZHN0MiA9IHRtcDIgKiBzcmM0ICsgdG1wNyAqIHNyYzUgKyB0bXAxMCAqIHNyYzcgLSAodG1wMyAqIHNyYzQgKyB0bXA2ICogc3JjNSArIHRtcDExICogc3JjNyk7CiAgICAgICAgY29uc3QgZHN0MyA9IHRtcDUgKiBzcmM0ICsgdG1wOCAqIHNyYzUgKyB0bXAxMSAqIHNyYzYgLSAodG1wNCAqIHNyYzQgKyB0bXA5ICogc3JjNSArIHRtcDEwICogc3JjNik7CiAgICAgICAgY29uc3QgZHN0NCA9IHRtcDEgKiBzcmMxICsgdG1wMiAqIHNyYzIgKyB0bXA1ICogc3JjMyAtICh0bXAwICogc3JjMSArIHRtcDMgKiBzcmMyICsgdG1wNCAqIHNyYzMpOwogICAgICAgIGNvbnN0IGRzdDUgPSB0bXAwICogc3JjMCArIHRtcDcgKiBzcmMyICsgdG1wOCAqIHNyYzMgLSAodG1wMSAqIHNyYzAgKyB0bXA2ICogc3JjMiArIHRtcDkgKiBzcmMzKTsKICAgICAgICBjb25zdCBkc3Q2ID0gdG1wMyAqIHNyYzAgKyB0bXA2ICogc3JjMSArIHRtcDExICogc3JjMyAtICh0bXAyICogc3JjMCArIHRtcDcgKiBzcmMxICsgdG1wMTAgKiBzcmMzKTsKICAgICAgICBjb25zdCBkc3Q3ID0gdG1wNCAqIHNyYzAgKyB0bXA5ICogc3JjMSArIHRtcDEwICogc3JjMiAtICh0bXA1ICogc3JjMCArIHRtcDggKiBzcmMxICsgdG1wMTEgKiBzcmMyKTsKICAgICAgICB0bXAwID0gc3JjMiAqIHNyYzc7CiAgICAgICAgdG1wMSA9IHNyYzMgKiBzcmM2OwogICAgICAgIHRtcDIgPSBzcmMxICogc3JjNzsKICAgICAgICB0bXAzID0gc3JjMyAqIHNyYzU7CiAgICAgICAgdG1wNCA9IHNyYzEgKiBzcmM2OwogICAgICAgIHRtcDUgPSBzcmMyICogc3JjNTsKICAgICAgICB0bXA2ID0gc3JjMCAqIHNyYzc7CiAgICAgICAgdG1wNyA9IHNyYzMgKiBzcmM0OwogICAgICAgIHRtcDggPSBzcmMwICogc3JjNjsKICAgICAgICB0bXA5ID0gc3JjMiAqIHNyYzQ7CiAgICAgICAgdG1wMTAgPSBzcmMwICogc3JjNTsKICAgICAgICB0bXAxMSA9IHNyYzEgKiBzcmM0OwogICAgICAgIGNvbnN0IGRzdDggPSB0bXAwICogc3JjMTMgKyB0bXAzICogc3JjMTQgKyB0bXA0ICogc3JjMTUgLSAodG1wMSAqIHNyYzEzICsgdG1wMiAqIHNyYzE0ICsgdG1wNSAqIHNyYzE1KTsKICAgICAgICBjb25zdCBkc3Q5ID0gdG1wMSAqIHNyYzEyICsgdG1wNiAqIHNyYzE0ICsgdG1wOSAqIHNyYzE1IC0gKHRtcDAgKiBzcmMxMiArIHRtcDcgKiBzcmMxNCArIHRtcDggKiBzcmMxNSk7CiAgICAgICAgY29uc3QgZHN0MTAgPSB0bXAyICogc3JjMTIgKyB0bXA3ICogc3JjMTMgKyB0bXAxMCAqIHNyYzE1IC0gKHRtcDMgKiBzcmMxMiArIHRtcDYgKiBzcmMxMyArIHRtcDExICogc3JjMTUpOwogICAgICAgIGNvbnN0IGRzdDExID0gdG1wNSAqIHNyYzEyICsgdG1wOCAqIHNyYzEzICsgdG1wMTEgKiBzcmMxNCAtICh0bXA0ICogc3JjMTIgKyB0bXA5ICogc3JjMTMgKyB0bXAxMCAqIHNyYzE0KTsKICAgICAgICBjb25zdCBkc3QxMiA9IHRtcDIgKiBzcmMxMCArIHRtcDUgKiBzcmMxMSArIHRtcDEgKiBzcmM5IC0gKHRtcDQgKiBzcmMxMSArIHRtcDAgKiBzcmM5ICsgdG1wMyAqIHNyYzEwKTsKICAgICAgICBjb25zdCBkc3QxMyA9IHRtcDggKiBzcmMxMSArIHRtcDAgKiBzcmM4ICsgdG1wNyAqIHNyYzEwIC0gKHRtcDYgKiBzcmMxMCArIHRtcDkgKiBzcmMxMSArIHRtcDEgKiBzcmM4KTsKICAgICAgICBjb25zdCBkc3QxNCA9IHRtcDYgKiBzcmM5ICsgdG1wMTEgKiBzcmMxMSArIHRtcDMgKiBzcmM4IC0gKHRtcDEwICogc3JjMTEgKyB0bXAyICogc3JjOCArIHRtcDcgKiBzcmM5KTsKICAgICAgICBjb25zdCBkc3QxNSA9IHRtcDEwICogc3JjMTAgKyB0bXA0ICogc3JjOCArIHRtcDkgKiBzcmM5IC0gKHRtcDggKiBzcmM5ICsgdG1wMTEgKiBzcmMxMCArIHRtcDUgKiBzcmM4KTsKICAgICAgICBsZXQgZGV0ID0gc3JjMCAqIGRzdDAgKyBzcmMxICogZHN0MSArIHNyYzIgKiBkc3QyICsgc3JjMyAqIGRzdDM7CiAgICAgICAgaWYgKE1hdGguYWJzKGRldCkgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjIxKSB7CiAgICAgICAgICBpZiAoTWF0cml4M19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICAgIE1hdHJpeDQuZ2V0TWF0cml4MyhtYXRyaXgsIHNjcmF0Y2hJbnZlcnNlUm90YXRpb24pLAogICAgICAgICAgICBzY3JhdGNoTWF0cml4M1plcm8sCiAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9ONwogICAgICAgICAgKSAmJiBDYXJ0ZXNpYW40X2RlZmF1bHQuZXF1YWxzKAogICAgICAgICAgICBNYXRyaXg0LmdldFJvdyhtYXRyaXgsIDMsIHNjcmF0Y2hCb3R0b21Sb3cpLAogICAgICAgICAgICBzY3JhdGNoRXhwZWN0ZWRCb3R0b21Sb3cKICAgICAgICAgICkpIHsKICAgICAgICAgICAgcmVzdWx0WzBdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzRdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzVdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzZdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICAgICAgcmVzdWx0WzhdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzldID0gMDsKICAgICAgICAgICAgcmVzdWx0WzEwXSA9IDA7CiAgICAgICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgICAgICByZXN1bHRbMTJdID0gLW1hdHJpeFsxMl07CiAgICAgICAgICAgIHJlc3VsdFsxM10gPSAtbWF0cml4WzEzXTsKICAgICAgICAgICAgcmVzdWx0WzE0XSA9IC1tYXRyaXhbMTRdOwogICAgICAgICAgICByZXN1bHRbMTVdID0gMTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIm1hdHJpeCBpcyBub3QgaW52ZXJ0aWJsZSBiZWNhdXNlIGl0cyBkZXRlcm1pbmF0ZSBpcyB6ZXJvLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGRldCA9IDEgLyBkZXQ7CiAgICAgICAgcmVzdWx0WzBdID0gZHN0MCAqIGRldDsKICAgICAgICByZXN1bHRbMV0gPSBkc3QxICogZGV0OwogICAgICAgIHJlc3VsdFsyXSA9IGRzdDIgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzNdID0gZHN0MyAqIGRldDsKICAgICAgICByZXN1bHRbNF0gPSBkc3Q0ICogZGV0OwogICAgICAgIHJlc3VsdFs1XSA9IGRzdDUgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzZdID0gZHN0NiAqIGRldDsKICAgICAgICByZXN1bHRbN10gPSBkc3Q3ICogZGV0OwogICAgICAgIHJlc3VsdFs4XSA9IGRzdDggKiBkZXQ7CiAgICAgICAgcmVzdWx0WzldID0gZHN0OSAqIGRldDsKICAgICAgICByZXN1bHRbMTBdID0gZHN0MTAgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzExXSA9IGRzdDExICogZGV0OwogICAgICAgIHJlc3VsdFsxMl0gPSBkc3QxMiAqIGRldDsKICAgICAgICByZXN1bHRbMTNdID0gZHN0MTMgKiBkZXQ7CiAgICAgICAgcmVzdWx0WzE0XSA9IGRzdDE0ICogZGV0OwogICAgICAgIHJlc3VsdFsxNV0gPSBkc3QxNSAqIGRldDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXg0LmludmVyc2VUcmFuc2Zvcm1hdGlvbiA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBtYXRyaXgwID0gbWF0cml4WzBdOwogICAgICAgIGNvbnN0IG1hdHJpeDEgPSBtYXRyaXhbMV07CiAgICAgICAgY29uc3QgbWF0cml4MiA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBtYXRyaXg0ID0gbWF0cml4WzRdOwogICAgICAgIGNvbnN0IG1hdHJpeDUgPSBtYXRyaXhbNV07CiAgICAgICAgY29uc3QgbWF0cml4NiA9IG1hdHJpeFs2XTsKICAgICAgICBjb25zdCBtYXRyaXg4ID0gbWF0cml4WzhdOwogICAgICAgIGNvbnN0IG1hdHJpeDkgPSBtYXRyaXhbOV07CiAgICAgICAgY29uc3QgbWF0cml4MTAgPSBtYXRyaXhbMTBdOwogICAgICAgIGNvbnN0IHZYID0gbWF0cml4WzEyXTsKICAgICAgICBjb25zdCB2WSA9IG1hdHJpeFsxM107CiAgICAgICAgY29uc3QgdlogPSBtYXRyaXhbMTRdOwogICAgICAgIGNvbnN0IHggPSAtbWF0cml4MCAqIHZYIC0gbWF0cml4MSAqIHZZIC0gbWF0cml4MiAqIHZaOwogICAgICAgIGNvbnN0IHkgPSAtbWF0cml4NCAqIHZYIC0gbWF0cml4NSAqIHZZIC0gbWF0cml4NiAqIHZaOwogICAgICAgIGNvbnN0IHogPSAtbWF0cml4OCAqIHZYIC0gbWF0cml4OSAqIHZZIC0gbWF0cml4MTAgKiB2WjsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXgwOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeDQ7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4ODsKICAgICAgICByZXN1bHRbM10gPSAwOwogICAgICAgIHJlc3VsdFs0XSA9IG1hdHJpeDE7CiAgICAgICAgcmVzdWx0WzVdID0gbWF0cml4NTsKICAgICAgICByZXN1bHRbNl0gPSBtYXRyaXg5OwogICAgICAgIHJlc3VsdFs3XSA9IDA7CiAgICAgICAgcmVzdWx0WzhdID0gbWF0cml4MjsKICAgICAgICByZXN1bHRbOV0gPSBtYXRyaXg2OwogICAgICAgIHJlc3VsdFsxMF0gPSBtYXRyaXgxMDsKICAgICAgICByZXN1bHRbMTFdID0gMDsKICAgICAgICByZXN1bHRbMTJdID0geDsKICAgICAgICByZXN1bHRbMTNdID0geTsKICAgICAgICByZXN1bHRbMTRdID0gejsKICAgICAgICByZXN1bHRbMTVdID0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoVHJhbnNwb3NlTWF0cml4MiA9IG5ldyBNYXRyaXg0KCk7CiAgICAgIE1hdHJpeDQuaW52ZXJzZVRyYW5zcG9zZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gTWF0cml4NC5pbnZlcnNlKAogICAgICAgICAgTWF0cml4NC50cmFuc3Bvc2UobWF0cml4LCBzY3JhdGNoVHJhbnNwb3NlTWF0cml4MiksCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBNYXRyaXg0LklERU5USVRZID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgTWF0cml4NCgKICAgICAgICAgIDEsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMSwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAxLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDEKICAgICAgICApCiAgICAgICk7CiAgICAgIE1hdHJpeDQuWkVSTyA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IE1hdHJpeDQoCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMCwKICAgICAgICAgIDAsCiAgICAgICAgICAwCiAgICAgICAgKQogICAgICApOwogICAgICBNYXRyaXg0LkNPTFVNTjBST1cwID0gMDsKICAgICAgTWF0cml4NC5DT0xVTU4wUk9XMSA9IDE7CiAgICAgIE1hdHJpeDQuQ09MVU1OMFJPVzIgPSAyOwogICAgICBNYXRyaXg0LkNPTFVNTjBST1czID0gMzsKICAgICAgTWF0cml4NC5DT0xVTU4xUk9XMCA9IDQ7CiAgICAgIE1hdHJpeDQuQ09MVU1OMVJPVzEgPSA1OwogICAgICBNYXRyaXg0LkNPTFVNTjFST1cyID0gNjsKICAgICAgTWF0cml4NC5DT0xVTU4xUk9XMyA9IDc7CiAgICAgIE1hdHJpeDQuQ09MVU1OMlJPVzAgPSA4OwogICAgICBNYXRyaXg0LkNPTFVNTjJST1cxID0gOTsKICAgICAgTWF0cml4NC5DT0xVTU4yUk9XMiA9IDEwOwogICAgICBNYXRyaXg0LkNPTFVNTjJST1czID0gMTE7CiAgICAgIE1hdHJpeDQuQ09MVU1OM1JPVzAgPSAxMjsKICAgICAgTWF0cml4NC5DT0xVTU4zUk9XMSA9IDEzOwogICAgICBNYXRyaXg0LkNPTFVNTjNST1cyID0gMTQ7CiAgICAgIE1hdHJpeDQuQ09MVU1OM1JPVzMgPSAxNTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoTWF0cml4NC5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBudW1iZXIgb2YgaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgICogQG1lbWJlcm9mIE1hdHJpeDQucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGxlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdHJpeDQucGFja2VkTGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIE1hdHJpeDQucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDQuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4NC5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gTWF0cml4NC5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBNYXRyaXg0LmVxdWFsc0FycmF5ID0gZnVuY3Rpb24obWF0cml4LCBhcnJheSwgb2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIG1hdHJpeFswXSA9PT0gYXJyYXlbb2Zmc2V0XSAmJiBtYXRyaXhbMV0gPT09IGFycmF5W29mZnNldCArIDFdICYmIG1hdHJpeFsyXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMl0gJiYgbWF0cml4WzNdID09PSBhcnJheVtvZmZzZXQgKyAzXSAmJiBtYXRyaXhbNF0gPT09IGFycmF5W29mZnNldCArIDRdICYmIG1hdHJpeFs1XSA9PT0gYXJyYXlbb2Zmc2V0ICsgNV0gJiYgbWF0cml4WzZdID09PSBhcnJheVtvZmZzZXQgKyA2XSAmJiBtYXRyaXhbN10gPT09IGFycmF5W29mZnNldCArIDddICYmIG1hdHJpeFs4XSA9PT0gYXJyYXlbb2Zmc2V0ICsgOF0gJiYgbWF0cml4WzldID09PSBhcnJheVtvZmZzZXQgKyA5XSAmJiBtYXRyaXhbMTBdID09PSBhcnJheVtvZmZzZXQgKyAxMF0gJiYgbWF0cml4WzExXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMTFdICYmIG1hdHJpeFsxMl0gPT09IGFycmF5W29mZnNldCArIDEyXSAmJiBtYXRyaXhbMTNdID09PSBhcnJheVtvZmZzZXQgKyAxM10gJiYgbWF0cml4WzE0XSA9PT0gYXJyYXlbb2Zmc2V0ICsgMTRdICYmIG1hdHJpeFsxNV0gPT09IGFycmF5W29mZnNldCArIDE1XTsKICAgICAgfTsKICAgICAgTWF0cml4NC5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDQuZXF1YWxzRXBzaWxvbih0aGlzLCByaWdodCwgZXBzaWxvbik7CiAgICAgIH07CiAgICAgIE1hdHJpeDQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzWzBdfSwgJHt0aGlzWzRdfSwgJHt0aGlzWzhdfSwgJHt0aGlzWzEyXX0pCigke3RoaXNbMV19LCAke3RoaXNbNV19LCAke3RoaXNbOV19LCAke3RoaXNbMTNdfSkKKCR7dGhpc1syXX0sICR7dGhpc1s2XX0sICR7dGhpc1sxMF19LCAke3RoaXNbMTRdfSkKKCR7dGhpc1szXX0sICR7dGhpc1s3XX0sICR7dGhpc1sxMV19LCAke3RoaXNbMTVdfSlgOwogICAgICB9OwogICAgICBNYXRyaXg0X2RlZmF1bHQgPSBNYXRyaXg0OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYmluYXJ5U2VhcmNoLmpzCiAgZnVuY3Rpb24gYmluYXJ5U2VhcmNoKGFycmF5LCBpdGVtVG9GaW5kLCBjb21wYXJhdG9yKSB7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJpdGVtVG9GaW5kIiwgaXRlbVRvRmluZCk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNvbXBhcmF0b3IiLCBjb21wYXJhdG9yKTsKICAgIGxldCBsb3cgPSAwOwogICAgbGV0IGhpZ2ggPSBhcnJheS5sZW5ndGggLSAxOwogICAgbGV0IGk7CiAgICBsZXQgY29tcGFyaXNvbjsKICAgIHdoaWxlIChsb3cgPD0gaGlnaCkgewogICAgICBpID0gfn4oKGxvdyArIGhpZ2gpIC8gMik7CiAgICAgIGNvbXBhcmlzb24gPSBjb21wYXJhdG9yKGFycmF5W2ldLCBpdGVtVG9GaW5kKTsKICAgICAgaWYgKGNvbXBhcmlzb24gPCAwKSB7CiAgICAgICAgbG93ID0gaSArIDE7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKGNvbXBhcmlzb24gPiAwKSB7CiAgICAgICAgaGlnaCA9IGkgLSAxOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIHJldHVybiBpOwogICAgfQogICAgcmV0dXJuIH4oaGlnaCArIDEpOwogIH0KICB2YXIgYmluYXJ5U2VhcmNoX2RlZmF1bHQ7CiAgdmFyIGluaXRfYmluYXJ5U2VhcmNoID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9iaW5hcnlTZWFyY2guanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGJpbmFyeVNlYXJjaF9kZWZhdWx0ID0gYmluYXJ5U2VhcmNoOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGUuanMKICBmdW5jdGlvbiBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc1NhbXBsZSh4UG9sZVdhbmRlciwgeVBvbGVXYW5kZXIsIHhQb2xlT2Zmc2V0LCB5UG9sZU9mZnNldCwgdXQxTWludXNVdGMpIHsKICAgIHRoaXMueFBvbGVXYW5kZXIgPSB4UG9sZVdhbmRlcjsKICAgIHRoaXMueVBvbGVXYW5kZXIgPSB5UG9sZVdhbmRlcjsKICAgIHRoaXMueFBvbGVPZmZzZXQgPSB4UG9sZU9mZnNldDsKICAgIHRoaXMueVBvbGVPZmZzZXQgPSB5UG9sZU9mZnNldDsKICAgIHRoaXMudXQxTWludXNVdGMgPSB1dDFNaW51c1V0YzsKICB9CiAgdmFyIEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlX2RlZmF1bHQ7CiAgdmFyIGluaXRfRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlLmpzIigpIHsKICAgICAgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGVfZGVmYXVsdCA9IEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvaXNMZWFwWWVhci5qcwogIGZ1bmN0aW9uIGlzTGVhcFllYXIoeWVhcikgewogICAgaWYgKHllYXIgPT09IG51bGwgfHwgaXNOYU4oeWVhcikpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInllYXIgaXMgcmVxdWlyZWQgYW5kIG11c3QgYmUgYSBudW1iZXIuIik7CiAgICB9CiAgICByZXR1cm4geWVhciAlIDQgPT09IDAgJiYgeWVhciAlIDEwMCAhPT0gMCB8fCB5ZWFyICUgNDAwID09PSAwOwogIH0KICB2YXIgaXNMZWFwWWVhcl9kZWZhdWx0OwogIHZhciBpbml0X2lzTGVhcFllYXIgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzTGVhcFllYXIuanMiKCkgewogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGlzTGVhcFllYXJfZGVmYXVsdCA9IGlzTGVhcFllYXI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HcmVnb3JpYW5EYXRlLmpzCiAgZnVuY3Rpb24gR3JlZ29yaWFuRGF0ZSh5ZWFyLCBtb250aCwgZGF5LCBob3VyLCBtaW51dGUsIHNlY29uZCwgbWlsbGlzZWNvbmQsIGlzTGVhcFNlY29uZCkgewogICAgY29uc3QgbWluaW11bVllYXIgPSAxOwogICAgY29uc3QgbWluaW11bU1vbnRoID0gMTsKICAgIGNvbnN0IG1pbmltdW1EYXkgPSAxOwogICAgY29uc3QgbWluaW11bUhvdXIgPSAwOwogICAgY29uc3QgbWluaW11bU1pbnV0ZSA9IDA7CiAgICBjb25zdCBtaW5pbXVtU2Vjb25kID0gMDsKICAgIGNvbnN0IG1pbmltdW1NaWxsaXNlY29uZCA9IDA7CiAgICB5ZWFyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeWVhciwgbWluaW11bVllYXIpOwogICAgbW9udGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChtb250aCwgbWluaW11bU1vbnRoKTsKICAgIGRheSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGRheSwgbWluaW11bURheSk7CiAgICBob3VyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaG91ciwgbWluaW11bUhvdXIpOwogICAgbWludXRlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobWludXRlLCBtaW5pbXVtTWludXRlKTsKICAgIHNlY29uZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHNlY29uZCwgbWluaW11bVNlY29uZCk7CiAgICBtaWxsaXNlY29uZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG1pbGxpc2Vjb25kLCBtaW5pbXVtTWlsbGlzZWNvbmQpOwogICAgaXNMZWFwU2Vjb25kID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaXNMZWFwU2Vjb25kLCBmYWxzZSk7CiAgICB2YWxpZGF0ZVJhbmdlKCk7CiAgICB2YWxpZGF0ZURhdGUoKTsKICAgIHRoaXMueWVhciA9IHllYXI7CiAgICB0aGlzLm1vbnRoID0gbW9udGg7CiAgICB0aGlzLmRheSA9IGRheTsKICAgIHRoaXMuaG91ciA9IGhvdXI7CiAgICB0aGlzLm1pbnV0ZSA9IG1pbnV0ZTsKICAgIHRoaXMuc2Vjb25kID0gc2Vjb25kOwogICAgdGhpcy5taWxsaXNlY29uZCA9IG1pbGxpc2Vjb25kOwogICAgdGhpcy5pc0xlYXBTZWNvbmQgPSBpc0xlYXBTZWNvbmQ7CiAgICBmdW5jdGlvbiB2YWxpZGF0ZVJhbmdlKCkgewogICAgICBjb25zdCBtYXhpbXVtWWVhciA9IDk5OTk7CiAgICAgIGNvbnN0IG1heGltdW1Nb250aCA9IDEyOwogICAgICBjb25zdCBtYXhpbXVtRGF5ID0gMzE7CiAgICAgIGNvbnN0IG1heGltdW1Ib3VyID0gMjM7CiAgICAgIGNvbnN0IG1heGltdW1NaW51dGUgPSA1OTsKICAgICAgY29uc3QgbWF4aW11bVNlY29uZCA9IDU5OwogICAgICBjb25zdCBleGNsdWRlZE1heGltdW1NaWxpc2Vjb25kID0gMWUzOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiWWVhciIsIHllYXIsIG1pbmltdW1ZZWFyKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoIlllYXIiLCB5ZWFyLCBtYXhpbXVtWWVhcik7CiAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJNb250aCIsIG1vbnRoLCBtaW5pbXVtTW9udGgpOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiTW9udGgiLCBtb250aCwgbWF4aW11bU1vbnRoKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIkRheSIsIGRheSwgbWluaW11bURheSk7CiAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJEYXkiLCBkYXksIG1heGltdW1EYXkpOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiSG91ciIsIGhvdXIsIG1pbmltdW1Ib3VyKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoIkhvdXIiLCBob3VyLCBtYXhpbXVtSG91cik7CiAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJNaW51dGUiLCBtaW51dGUsIG1pbmltdW1NaW51dGUpOwogICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiTWludXRlIiwgbWludXRlLCBtYXhpbXVtTWludXRlKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YuYm9vbCgiSXNMZWFwU2Vjb25kIiwgaXNMZWFwU2Vjb25kKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIlNlY29uZCIsIHNlY29uZCwgbWluaW11bVNlY29uZCk7CiAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKAogICAgICAgICJTZWNvbmQiLAogICAgICAgIHNlY29uZCwKICAgICAgICBpc0xlYXBTZWNvbmQgPyBtYXhpbXVtU2Vjb25kICsgMSA6IG1heGltdW1TZWNvbmQKICAgICAgKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoCiAgICAgICAgIk1pbGxpc2Vjb25kIiwKICAgICAgICBtaWxsaXNlY29uZCwKICAgICAgICBtaW5pbXVtTWlsbGlzZWNvbmQKICAgICAgKTsKICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuKAogICAgICAgICJNaWxsaXNlY29uZCIsCiAgICAgICAgbWlsbGlzZWNvbmQsCiAgICAgICAgZXhjbHVkZWRNYXhpbXVtTWlsaXNlY29uZAogICAgICApOwogICAgfQogICAgZnVuY3Rpb24gdmFsaWRhdGVEYXRlKCkgewogICAgICBjb25zdCBkYXlzSW5Nb250aDIgPSBtb250aCA9PT0gMiAmJiBpc0xlYXBZZWFyX2RlZmF1bHQoeWVhcikgPyBkYXlzSW5ZZWFyW21vbnRoIC0gMV0gKyAxIDogZGF5c0luWWVhclttb250aCAtIDFdOwogICAgICBpZiAoZGF5ID4gZGF5c0luTW9udGgyKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIk1vbnRoIGFuZCBEYXkgcmVwcmVzZW50cyBpbnZhbGlkIGRhdGUiKTsKICAgICAgfQogICAgfQogIH0KICB2YXIgZGF5c0luWWVhciwgR3JlZ29yaWFuRGF0ZV9kZWZhdWx0OwogIHZhciBpbml0X0dyZWdvcmlhbkRhdGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dyZWdvcmlhbkRhdGUuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9pc0xlYXBZZWFyKCk7CiAgICAgIGRheXNJblllYXIgPSBbMzEsIDI4LCAzMSwgMzAsIDMxLCAzMCwgMzEsIDMxLCAzMCwgMzEsIDMwLCAzMV07CiAgICAgIEdyZWdvcmlhbkRhdGVfZGVmYXVsdCA9IEdyZWdvcmlhbkRhdGU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9MZWFwU2Vjb25kLmpzCiAgZnVuY3Rpb24gTGVhcFNlY29uZChkYXRlLCBvZmZzZXQpIHsKICAgIHRoaXMuanVsaWFuRGF0ZSA9IGRhdGU7CiAgICB0aGlzLm9mZnNldCA9IG9mZnNldDsKICB9CiAgdmFyIExlYXBTZWNvbmRfZGVmYXVsdDsKICB2YXIgaW5pdF9MZWFwU2Vjb25kID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9MZWFwU2Vjb25kLmpzIigpIHsKICAgICAgTGVhcFNlY29uZF9kZWZhdWx0ID0gTGVhcFNlY29uZDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RpbWVDb25zdGFudHMuanMKICB2YXIgVGltZUNvbnN0YW50cywgVGltZUNvbnN0YW50c19kZWZhdWx0OwogIHZhciBpbml0X1RpbWVDb25zdGFudHMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RpbWVDb25zdGFudHMuanMiKCkgewogICAgICBUaW1lQ29uc3RhbnRzID0gewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2Ygc2Vjb25kcyBpbiBvbmUgbWlsbGlzZWNvbmQ6IDxjb2RlPjAuMDAxPC9jb2RlPgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgU0VDT05EU19QRVJfTUlMTElTRUNPTkQ6IDFlLTMsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBzZWNvbmRzIGluIG9uZSBtaW51dGU6IDxjb2RlPjYwPC9jb2RlPi4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFNFQ09ORFNfUEVSX01JTlVURTogNjAsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBtaW51dGVzIGluIG9uZSBob3VyOiA8Y29kZT42MDwvY29kZT4uCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBNSU5VVEVTX1BFUl9IT1VSOiA2MCwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbnVtYmVyIG9mIGhvdXJzIGluIG9uZSBkYXk6IDxjb2RlPjI0PC9jb2RlPi4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEhPVVJTX1BFUl9EQVk6IDI0LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2Ygc2Vjb25kcyBpbiBvbmUgaG91cjogPGNvZGU+MzYwMDwvY29kZT4uCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBTRUNPTkRTX1BFUl9IT1VSOiAzNjAwLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2YgbWludXRlcyBpbiBvbmUgZGF5OiA8Y29kZT4xNDQwPC9jb2RlPi4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE1JTlVURVNfUEVSX0RBWTogMTQ0MCwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbnVtYmVyIG9mIHNlY29uZHMgaW4gb25lIGRheSwgaWdub3JpbmcgbGVhcCBzZWNvbmRzOiA8Y29kZT44NjQwMDwvY29kZT4uCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBTRUNPTkRTX1BFUl9EQVk6IDg2NDAwLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2YgZGF5cyBpbiBvbmUgSnVsaWFuIGNlbnR1cnk6IDxjb2RlPjM2NTI1PC9jb2RlPi4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIERBWVNfUEVSX0pVTElBTl9DRU5UVVJZOiAzNjUyNSwKICAgICAgICAvKioKICAgICAgICAgKiBPbmUgdHJpbGxpb250aCBvZiBhIHNlY29uZC4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFBJQ09TRUNPTkQ6IDFlLTksCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBkYXlzIHRvIHN1YnRyYWN0IGZyb20gYSBKdWxpYW4gZGF0ZSB0byBkZXRlcm1pbmUgdGhlCiAgICAgICAgICogbW9kaWZpZWQgSnVsaWFuIGRhdGUsIHdoaWNoIGdpdmVzIHRoZSBudW1iZXIgb2YgZGF5cyBzaW5jZSBtaWRuaWdodAogICAgICAgICAqIG9uIE5vdmVtYmVyIDE3LCAxODU4LgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTU9ESUZJRURfSlVMSUFOX0RBVEVfRElGRkVSRU5DRTogMjQwMDAwMDVlLTEKICAgICAgfTsKICAgICAgVGltZUNvbnN0YW50c19kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShUaW1lQ29uc3RhbnRzKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RpbWVTdGFuZGFyZC5qcwogIHZhciBUaW1lU3RhbmRhcmQsIFRpbWVTdGFuZGFyZF9kZWZhdWx0OwogIHZhciBpbml0X1RpbWVTdGFuZGFyZCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGltZVN0YW5kYXJkLmpzIigpIHsKICAgICAgVGltZVN0YW5kYXJkID0gewogICAgICAgIC8qKgogICAgICAgICAqIFJlcHJlc2VudHMgdGhlIGNvb3JkaW5hdGVkIFVuaXZlcnNhbCBUaW1lIChVVEMpIHRpbWUgc3RhbmRhcmQuCiAgICAgICAgICoKICAgICAgICAgKiBVVEMgaXMgcmVsYXRlZCB0byBUQUkgYWNjb3JkaW5nIHRvIHRoZSByZWxhdGlvbnNoaXAKICAgICAgICAgKiA8Y29kZT5VVEMgPSBUQUkgLSBkZWx0YVQ8L2NvZGU+IHdoZXJlIDxjb2RlPmRlbHRhVDwvY29kZT4gaXMgdGhlIG51bWJlciBvZiBsZWFwCiAgICAgICAgICogc2Vjb25kcyB3aGljaCBoYXZlIGJlZW4gaW50cm9kdWNlZCBhcyBvZiB0aGUgdGltZSBpbiBUQUkuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFVUQzogMCwKICAgICAgICAvKioKICAgICAgICAgKiBSZXByZXNlbnRzIHRoZSBJbnRlcm5hdGlvbmFsIEF0b21pYyBUaW1lIChUQUkpIHRpbWUgc3RhbmRhcmQuCiAgICAgICAgICogVEFJIGlzIHRoZSBwcmluY2lwYWwgdGltZSBzdGFuZGFyZCB0byB3aGljaCB0aGUgb3RoZXIgdGltZSBzdGFuZGFyZHMgYXJlIHJlbGF0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFRBSTogMQogICAgICB9OwogICAgICBUaW1lU3RhbmRhcmRfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoVGltZVN0YW5kYXJkKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0p1bGlhbkRhdGUuanMKICBmdW5jdGlvbiBjb21wYXJlTGVhcFNlY29uZERhdGVzKGxlYXBTZWNvbmQsIGRhdGVUb0ZpbmQpIHsKICAgIHJldHVybiBKdWxpYW5EYXRlLmNvbXBhcmUobGVhcFNlY29uZC5qdWxpYW5EYXRlLCBkYXRlVG9GaW5kLmp1bGlhbkRhdGUpOwogIH0KICBmdW5jdGlvbiBjb252ZXJ0VXRjVG9UYWkoanVsaWFuRGF0ZSkgewogICAgYmluYXJ5U2VhcmNoU2NyYXRjaExlYXBTZWNvbmQuanVsaWFuRGF0ZSA9IGp1bGlhbkRhdGU7CiAgICBjb25zdCBsZWFwU2Vjb25kcyA9IEp1bGlhbkRhdGUubGVhcFNlY29uZHM7CiAgICBsZXQgaW5kZXggPSBiaW5hcnlTZWFyY2hfZGVmYXVsdCgKICAgICAgbGVhcFNlY29uZHMsCiAgICAgIGJpbmFyeVNlYXJjaFNjcmF0Y2hMZWFwU2Vjb25kLAogICAgICBjb21wYXJlTGVhcFNlY29uZERhdGVzCiAgICApOwogICAgaWYgKGluZGV4IDwgMCkgewogICAgICBpbmRleCA9IH5pbmRleDsKICAgIH0KICAgIGlmIChpbmRleCA+PSBsZWFwU2Vjb25kcy5sZW5ndGgpIHsKICAgICAgaW5kZXggPSBsZWFwU2Vjb25kcy5sZW5ndGggLSAxOwogICAgfQogICAgbGV0IG9mZnNldCA9IGxlYXBTZWNvbmRzW2luZGV4XS5vZmZzZXQ7CiAgICBpZiAoaW5kZXggPiAwKSB7CiAgICAgIGNvbnN0IGRpZmZlcmVuY2UgPSBKdWxpYW5EYXRlLnNlY29uZHNEaWZmZXJlbmNlKAogICAgICAgIGxlYXBTZWNvbmRzW2luZGV4XS5qdWxpYW5EYXRlLAogICAgICAgIGp1bGlhbkRhdGUKICAgICAgKTsKICAgICAgaWYgKGRpZmZlcmVuY2UgPiBvZmZzZXQpIHsKICAgICAgICBpbmRleC0tOwogICAgICAgIG9mZnNldCA9IGxlYXBTZWNvbmRzW2luZGV4XS5vZmZzZXQ7CiAgICAgIH0KICAgIH0KICAgIEp1bGlhbkRhdGUuYWRkU2Vjb25kcyhqdWxpYW5EYXRlLCBvZmZzZXQsIGp1bGlhbkRhdGUpOwogIH0KICBmdW5jdGlvbiBjb252ZXJ0VGFpVG9VdGMoanVsaWFuRGF0ZSwgcmVzdWx0KSB7CiAgICBiaW5hcnlTZWFyY2hTY3JhdGNoTGVhcFNlY29uZC5qdWxpYW5EYXRlID0ganVsaWFuRGF0ZTsKICAgIGNvbnN0IGxlYXBTZWNvbmRzID0gSnVsaWFuRGF0ZS5sZWFwU2Vjb25kczsKICAgIGxldCBpbmRleCA9IGJpbmFyeVNlYXJjaF9kZWZhdWx0KAogICAgICBsZWFwU2Vjb25kcywKICAgICAgYmluYXJ5U2VhcmNoU2NyYXRjaExlYXBTZWNvbmQsCiAgICAgIGNvbXBhcmVMZWFwU2Vjb25kRGF0ZXMKICAgICk7CiAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgIGluZGV4ID0gfmluZGV4OwogICAgfQogICAgaWYgKGluZGV4ID09PSAwKSB7CiAgICAgIHJldHVybiBKdWxpYW5EYXRlLmFkZFNlY29uZHMoanVsaWFuRGF0ZSwgLWxlYXBTZWNvbmRzWzBdLm9mZnNldCwgcmVzdWx0KTsKICAgIH0KICAgIGlmIChpbmRleCA+PSBsZWFwU2Vjb25kcy5sZW5ndGgpIHsKICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuYWRkU2Vjb25kcygKICAgICAgICBqdWxpYW5EYXRlLAogICAgICAgIC1sZWFwU2Vjb25kc1tpbmRleCAtIDFdLm9mZnNldCwKICAgICAgICByZXN1bHQKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGRpZmZlcmVuY2UgPSBKdWxpYW5EYXRlLnNlY29uZHNEaWZmZXJlbmNlKAogICAgICBsZWFwU2Vjb25kc1tpbmRleF0uanVsaWFuRGF0ZSwKICAgICAganVsaWFuRGF0ZQogICAgKTsKICAgIGlmIChkaWZmZXJlbmNlID09PSAwKSB7CiAgICAgIHJldHVybiBKdWxpYW5EYXRlLmFkZFNlY29uZHMoCiAgICAgICAganVsaWFuRGF0ZSwKICAgICAgICAtbGVhcFNlY29uZHNbaW5kZXhdLm9mZnNldCwKICAgICAgICByZXN1bHQKICAgICAgKTsKICAgIH0KICAgIGlmIChkaWZmZXJlbmNlIDw9IDEpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHJldHVybiBKdWxpYW5EYXRlLmFkZFNlY29uZHMoCiAgICAgIGp1bGlhbkRhdGUsCiAgICAgIC1sZWFwU2Vjb25kc1stLWluZGV4XS5vZmZzZXQsCiAgICAgIHJlc3VsdAogICAgKTsKICB9CiAgZnVuY3Rpb24gc2V0Q29tcG9uZW50cyh3aG9sZURheXMsIHNlY29uZHNPZkRheSwganVsaWFuRGF0ZSkgewogICAgY29uc3QgZXh0cmFEYXlzID0gc2Vjb25kc09mRGF5IC8gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWSB8IDA7CiAgICB3aG9sZURheXMgKz0gZXh0cmFEYXlzOwogICAgc2Vjb25kc09mRGF5IC09IFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9EQVkgKiBleHRyYURheXM7CiAgICBpZiAoc2Vjb25kc09mRGF5IDwgMCkgewogICAgICB3aG9sZURheXMtLTsKICAgICAgc2Vjb25kc09mRGF5ICs9IFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9EQVk7CiAgICB9CiAgICBqdWxpYW5EYXRlLmRheU51bWJlciA9IHdob2xlRGF5czsKICAgIGp1bGlhbkRhdGUuc2Vjb25kc09mRGF5ID0gc2Vjb25kc09mRGF5OwogICAgcmV0dXJuIGp1bGlhbkRhdGU7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVKdWxpYW5EYXRlQ29tcG9uZW50cyh5ZWFyLCBtb250aCwgZGF5LCBob3VyLCBtaW51dGUsIHNlY29uZCwgbWlsbGlzZWNvbmQpIHsKICAgIGNvbnN0IGEzID0gKG1vbnRoIC0gMTQpIC8gMTIgfCAwOwogICAgY29uc3QgYiA9IHllYXIgKyA0ODAwICsgYTM7CiAgICBsZXQgZGF5TnVtYmVyID0gKDE0NjEgKiBiIC8gNCB8IDApICsgKDM2NyAqIChtb250aCAtIDIgLSAxMiAqIGEzKSAvIDEyIHwgMCkgLSAoMyAqICgoYiArIDEwMCkgLyAxMDAgfCAwKSAvIDQgfCAwKSArIGRheSAtIDMyMDc1OwogICAgaG91ciA9IGhvdXIgLSAxMjsKICAgIGlmIChob3VyIDwgMCkgewogICAgICBob3VyICs9IDI0OwogICAgfQogICAgY29uc3Qgc2Vjb25kc09mRGF5ID0gc2Vjb25kICsgKGhvdXIgKiBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfSE9VUiArIG1pbnV0ZSAqIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9NSU5VVEUgKyBtaWxsaXNlY29uZCAqIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9NSUxMSVNFQ09ORCk7CiAgICBpZiAoc2Vjb25kc09mRGF5ID49IDQzMjAwKSB7CiAgICAgIGRheU51bWJlciAtPSAxOwogICAgfQogICAgcmV0dXJuIFtkYXlOdW1iZXIsIHNlY29uZHNPZkRheV07CiAgfQogIGZ1bmN0aW9uIEp1bGlhbkRhdGUoanVsaWFuRGF5TnVtYmVyLCBzZWNvbmRzT2ZEYXksIHRpbWVTdGFuZGFyZCkgewogICAgdGhpcy5kYXlOdW1iZXIgPSB2b2lkIDA7CiAgICB0aGlzLnNlY29uZHNPZkRheSA9IHZvaWQgMDsKICAgIGp1bGlhbkRheU51bWJlciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGp1bGlhbkRheU51bWJlciwgMCk7CiAgICBzZWNvbmRzT2ZEYXkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzZWNvbmRzT2ZEYXksIDApOwogICAgdGltZVN0YW5kYXJkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodGltZVN0YW5kYXJkLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5VVEMpOwogICAgY29uc3Qgd2hvbGVEYXlzID0ganVsaWFuRGF5TnVtYmVyIHwgMDsKICAgIHNlY29uZHNPZkRheSA9IHNlY29uZHNPZkRheSArIChqdWxpYW5EYXlOdW1iZXIgLSB3aG9sZURheXMpICogVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWTsKICAgIHNldENvbXBvbmVudHMod2hvbGVEYXlzLCBzZWNvbmRzT2ZEYXksIHRoaXMpOwogICAgaWYgKHRpbWVTdGFuZGFyZCA9PT0gVGltZVN0YW5kYXJkX2RlZmF1bHQuVVRDKSB7CiAgICAgIGNvbnZlcnRVdGNUb1RhaSh0aGlzKTsKICAgIH0KICB9CiAgdmFyIGdyZWdvcmlhbkRhdGVTY3JhdGNoLCBkYXlzSW5Nb250aCwgZGF5c0luTGVhcEZlYnVyYXJ5LCBiaW5hcnlTZWFyY2hTY3JhdGNoTGVhcFNlY29uZCwgbWF0Y2hDYWxlbmRhclllYXIsIG1hdGNoQ2FsZW5kYXJNb250aCwgbWF0Y2hPcmRpbmFsRGF0ZSwgbWF0Y2hXZWVrRGF0ZSwgbWF0Y2hDYWxlbmRhckRhdGUsIHV0Y09mZnNldCwgbWF0Y2hIb3VycywgbWF0Y2hIb3Vyc01pbnV0ZXMsIG1hdGNoSG91cnNNaW51dGVzU2Vjb25kcywgaXNvODYwMUVycm9yTWVzc2FnZSwgdG9HcmVnb3JpYW5EYXRlU2NyYXRjaCwgSnVsaWFuRGF0ZV9kZWZhdWx0OwogIHZhciBpbml0X0p1bGlhbkRhdGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0p1bGlhbkRhdGUuanMiKCkgewogICAgICBpbml0X2JpbmFyeVNlYXJjaCgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0dyZWdvcmlhbkRhdGUoKTsKICAgICAgaW5pdF9pc0xlYXBZZWFyKCk7CiAgICAgIGluaXRfTGVhcFNlY29uZCgpOwogICAgICBpbml0X1RpbWVDb25zdGFudHMoKTsKICAgICAgaW5pdF9UaW1lU3RhbmRhcmQoKTsKICAgICAgZ3JlZ29yaWFuRGF0ZVNjcmF0Y2ggPSBuZXcgR3JlZ29yaWFuRGF0ZV9kZWZhdWx0KCk7CiAgICAgIGRheXNJbk1vbnRoID0gWzMxLCAyOCwgMzEsIDMwLCAzMSwgMzAsIDMxLCAzMSwgMzAsIDMxLCAzMCwgMzFdOwogICAgICBkYXlzSW5MZWFwRmVidXJhcnkgPSAyOTsKICAgICAgYmluYXJ5U2VhcmNoU2NyYXRjaExlYXBTZWNvbmQgPSBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KCk7CiAgICAgIG1hdGNoQ2FsZW5kYXJZZWFyID0gL14oXGR7NH0pJC87CiAgICAgIG1hdGNoQ2FsZW5kYXJNb250aCA9IC9eKFxkezR9KS0oXGR7Mn0pJC87CiAgICAgIG1hdGNoT3JkaW5hbERhdGUgPSAvXihcZHs0fSktPyhcZHszfSkkLzsKICAgICAgbWF0Y2hXZWVrRGF0ZSA9IC9eKFxkezR9KS0/VyhcZHsyfSktPyhcZHsxfSk/JC87CiAgICAgIG1hdGNoQ2FsZW5kYXJEYXRlID0gL14oXGR7NH0pLT8oXGR7Mn0pLT8oXGR7Mn0pJC87CiAgICAgIHV0Y09mZnNldCA9IC8oW1orXC1dKT8oXGR7Mn0pPzo/KFxkezJ9KT8kLzsKICAgICAgbWF0Y2hIb3VycyA9IC9eKFxkezJ9KShcLlxkKyk/Ly5zb3VyY2UgKyB1dGNPZmZzZXQuc291cmNlOwogICAgICBtYXRjaEhvdXJzTWludXRlcyA9IC9eKFxkezJ9KTo/KFxkezJ9KShcLlxkKyk/Ly5zb3VyY2UgKyB1dGNPZmZzZXQuc291cmNlOwogICAgICBtYXRjaEhvdXJzTWludXRlc1NlY29uZHMgPSAvXihcZHsyfSk6PyhcZHsyfSk6PyhcZHsyfSkoXC5cZCspPy8uc291cmNlICsgdXRjT2Zmc2V0LnNvdXJjZTsKICAgICAgaXNvODYwMUVycm9yTWVzc2FnZSA9ICJJbnZhbGlkIElTTyA4NjAxIGRhdGUuIjsKICAgICAgSnVsaWFuRGF0ZS5mcm9tR3JlZ29yaWFuRGF0ZSA9IGZ1bmN0aW9uKGRhdGUsIHJlc3VsdCkgewogICAgICAgIGlmICghKGRhdGUgaW5zdGFuY2VvZiBHcmVnb3JpYW5EYXRlX2RlZmF1bHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZGF0ZSBtdXN0IGJlIGEgdmFsaWQgR3JlZ29yaWFuRGF0ZS4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29tcG9uZW50cyA9IGNvbXB1dGVKdWxpYW5EYXRlQ29tcG9uZW50cygKICAgICAgICAgIGRhdGUueWVhciwKICAgICAgICAgIGRhdGUubW9udGgsCiAgICAgICAgICBkYXRlLmRheSwKICAgICAgICAgIGRhdGUuaG91ciwKICAgICAgICAgIGRhdGUubWludXRlLAogICAgICAgICAgZGF0ZS5zZWNvbmQsCiAgICAgICAgICBkYXRlLm1pbGxpc2Vjb25kCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEp1bGlhbkRhdGUoY29tcG9uZW50c1swXSwgY29tcG9uZW50c1sxXSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVVRDKTsKICAgICAgICB9CiAgICAgICAgc2V0Q29tcG9uZW50cyhjb21wb25lbnRzWzBdLCBjb21wb25lbnRzWzFdLCByZXN1bHQpOwogICAgICAgIGNvbnZlcnRVdGNUb1RhaShyZXN1bHQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuZnJvbURhdGUgPSBmdW5jdGlvbihkYXRlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIShkYXRlIGluc3RhbmNlb2YgRGF0ZSkgfHwgaXNOYU4oZGF0ZS5nZXRUaW1lKCkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZGF0ZSBtdXN0IGJlIGEgdmFsaWQgSmF2YVNjcmlwdCBEYXRlLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb21wb25lbnRzID0gY29tcHV0ZUp1bGlhbkRhdGVDb21wb25lbnRzKAogICAgICAgICAgZGF0ZS5nZXRVVENGdWxsWWVhcigpLAogICAgICAgICAgZGF0ZS5nZXRVVENNb250aCgpICsgMSwKICAgICAgICAgIGRhdGUuZ2V0VVRDRGF0ZSgpLAogICAgICAgICAgZGF0ZS5nZXRVVENIb3VycygpLAogICAgICAgICAgZGF0ZS5nZXRVVENNaW51dGVzKCksCiAgICAgICAgICBkYXRlLmdldFVUQ1NlY29uZHMoKSwKICAgICAgICAgIGRhdGUuZ2V0VVRDTWlsbGlzZWNvbmRzKCkKICAgICAgICApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgSnVsaWFuRGF0ZShjb21wb25lbnRzWzBdLCBjb21wb25lbnRzWzFdLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5VVEMpOwogICAgICAgIH0KICAgICAgICBzZXRDb21wb25lbnRzKGNvbXBvbmVudHNbMF0sIGNvbXBvbmVudHNbMV0sIHJlc3VsdCk7CiAgICAgICAgY29udmVydFV0Y1RvVGFpKHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5mcm9tSXNvODYwMSA9IGZ1bmN0aW9uKGlzbzg2MDFTdHJpbmcsIHJlc3VsdCkgewogICAgICAgIGlmICh0eXBlb2YgaXNvODYwMVN0cmluZyAhPT0gInN0cmluZyIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgIH0KICAgICAgICBpc284NjAxU3RyaW5nID0gaXNvODYwMVN0cmluZy5yZXBsYWNlKCIsIiwgIi4iKTsKICAgICAgICBsZXQgdG9rZW5zID0gaXNvODYwMVN0cmluZy5zcGxpdCgiVCIpOwogICAgICAgIGxldCB5ZWFyOwogICAgICAgIGxldCBtb250aCA9IDE7CiAgICAgICAgbGV0IGRheSA9IDE7CiAgICAgICAgbGV0IGhvdXIgPSAwOwogICAgICAgIGxldCBtaW51dGUgPSAwOwogICAgICAgIGxldCBzZWNvbmQgPSAwOwogICAgICAgIGxldCBtaWxsaXNlY29uZCA9IDA7CiAgICAgICAgY29uc3QgZGF0ZSA9IHRva2Vuc1swXTsKICAgICAgICBjb25zdCB0aW1lID0gdG9rZW5zWzFdOwogICAgICAgIGxldCB0bXAyOwogICAgICAgIGxldCBpbkxlYXBZZWFyOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICB9CiAgICAgICAgbGV0IGRhc2hDb3VudDsKICAgICAgICB0b2tlbnMgPSBkYXRlLm1hdGNoKG1hdGNoQ2FsZW5kYXJEYXRlKTsKICAgICAgICBpZiAodG9rZW5zICE9PSBudWxsKSB7CiAgICAgICAgICBkYXNoQ291bnQgPSBkYXRlLnNwbGl0KCItIikubGVuZ3RoIC0gMTsKICAgICAgICAgIGlmIChkYXNoQ291bnQgPiAwICYmIGRhc2hDb3VudCAhPT0gMikgewogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICAgIH0KICAgICAgICAgIHllYXIgPSArdG9rZW5zWzFdOwogICAgICAgICAgbW9udGggPSArdG9rZW5zWzJdOwogICAgICAgICAgZGF5ID0gK3Rva2Vuc1szXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdG9rZW5zID0gZGF0ZS5tYXRjaChtYXRjaENhbGVuZGFyTW9udGgpOwogICAgICAgICAgaWYgKHRva2VucyAhPT0gbnVsbCkgewogICAgICAgICAgICB5ZWFyID0gK3Rva2Vuc1sxXTsKICAgICAgICAgICAgbW9udGggPSArdG9rZW5zWzJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdG9rZW5zID0gZGF0ZS5tYXRjaChtYXRjaENhbGVuZGFyWWVhcik7CiAgICAgICAgICAgIGlmICh0b2tlbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB5ZWFyID0gK3Rva2Vuc1sxXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsZXQgZGF5T2ZZZWFyOwogICAgICAgICAgICAgIHRva2VucyA9IGRhdGUubWF0Y2gobWF0Y2hPcmRpbmFsRGF0ZSk7CiAgICAgICAgICAgICAgaWYgKHRva2VucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgeWVhciA9ICt0b2tlbnNbMV07CiAgICAgICAgICAgICAgICBkYXlPZlllYXIgPSArdG9rZW5zWzJdOwogICAgICAgICAgICAgICAgaW5MZWFwWWVhciA9IGlzTGVhcFllYXJfZGVmYXVsdCh5ZWFyKTsKICAgICAgICAgICAgICAgIGlmIChkYXlPZlllYXIgPCAxIHx8IGluTGVhcFllYXIgJiYgZGF5T2ZZZWFyID4gMzY2IHx8ICFpbkxlYXBZZWFyICYmIGRheU9mWWVhciA+IDM2NSkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdG9rZW5zID0gZGF0ZS5tYXRjaChtYXRjaFdlZWtEYXRlKTsKICAgICAgICAgICAgICAgIGlmICh0b2tlbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgeWVhciA9ICt0b2tlbnNbMV07CiAgICAgICAgICAgICAgICAgIGNvbnN0IHdlZWtOdW1iZXIgPSArdG9rZW5zWzJdOwogICAgICAgICAgICAgICAgICBjb25zdCBkYXlPZldlZWsgPSArdG9rZW5zWzNdIHx8IDA7CiAgICAgICAgICAgICAgICAgIGRhc2hDb3VudCA9IGRhdGUuc3BsaXQoIi0iKS5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICBpZiAoZGFzaENvdW50ID4gMCAmJiAoIWRlZmluZWRfZGVmYXVsdCh0b2tlbnNbM10pICYmIGRhc2hDb3VudCAhPT0gMSB8fCBkZWZpbmVkX2RlZmF1bHQodG9rZW5zWzNdKSAmJiBkYXNoQ291bnQgIT09IDIpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoaXNvODYwMUVycm9yTWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29uc3QgamFudWFyeTQgPSBuZXcgRGF0ZShEYXRlLlVUQyh5ZWFyLCAwLCA0KSk7CiAgICAgICAgICAgICAgICAgIGRheU9mWWVhciA9IHdlZWtOdW1iZXIgKiA3ICsgZGF5T2ZXZWVrIC0gamFudWFyeTQuZ2V0VVRDRGF5KCkgLSAzOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoaXNvODYwMUVycm9yTWVzc2FnZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRtcDIgPSBuZXcgRGF0ZShEYXRlLlVUQyh5ZWFyLCAwLCAxKSk7CiAgICAgICAgICAgICAgdG1wMi5zZXRVVENEYXRlKGRheU9mWWVhcik7CiAgICAgICAgICAgICAgbW9udGggPSB0bXAyLmdldFVUQ01vbnRoKCkgKyAxOwogICAgICAgICAgICAgIGRheSA9IHRtcDIuZ2V0VVRDRGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGluTGVhcFllYXIgPSBpc0xlYXBZZWFyX2RlZmF1bHQoeWVhcik7CiAgICAgICAgaWYgKG1vbnRoIDwgMSB8fCBtb250aCA+IDEyIHx8IGRheSA8IDEgfHwgKG1vbnRoICE9PSAyIHx8ICFpbkxlYXBZZWFyKSAmJiBkYXkgPiBkYXlzSW5Nb250aFttb250aCAtIDFdIHx8IGluTGVhcFllYXIgJiYgbW9udGggPT09IDIgJiYgZGF5ID4gZGF5c0luTGVhcEZlYnVyYXJ5KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICB9CiAgICAgICAgbGV0IG9mZnNldEluZGV4OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGltZSkpIHsKICAgICAgICAgIHRva2VucyA9IHRpbWUubWF0Y2gobWF0Y2hIb3Vyc01pbnV0ZXNTZWNvbmRzKTsKICAgICAgICAgIGlmICh0b2tlbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgZGFzaENvdW50ID0gdGltZS5zcGxpdCgiOiIpLmxlbmd0aCAtIDE7CiAgICAgICAgICAgIGlmIChkYXNoQ291bnQgPiAwICYmIGRhc2hDb3VudCAhPT0gMiAmJiBkYXNoQ291bnQgIT09IDMpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBob3VyID0gK3Rva2Vuc1sxXTsKICAgICAgICAgICAgbWludXRlID0gK3Rva2Vuc1syXTsKICAgICAgICAgICAgc2Vjb25kID0gK3Rva2Vuc1szXTsKICAgICAgICAgICAgbWlsbGlzZWNvbmQgPSArKHRva2Vuc1s0XSB8fCAwKSAqIDFlMzsKICAgICAgICAgICAgb2Zmc2V0SW5kZXggPSA1OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdG9rZW5zID0gdGltZS5tYXRjaChtYXRjaEhvdXJzTWludXRlcyk7CiAgICAgICAgICAgIGlmICh0b2tlbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBkYXNoQ291bnQgPSB0aW1lLnNwbGl0KCI6IikubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICBpZiAoZGFzaENvdW50ID4gMikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoaXNvODYwMUVycm9yTWVzc2FnZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGhvdXIgPSArdG9rZW5zWzFdOwogICAgICAgICAgICAgIG1pbnV0ZSA9ICt0b2tlbnNbMl07CiAgICAgICAgICAgICAgc2Vjb25kID0gKyh0b2tlbnNbM10gfHwgMCkgKiA2MDsKICAgICAgICAgICAgICBvZmZzZXRJbmRleCA9IDQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdG9rZW5zID0gdGltZS5tYXRjaChtYXRjaEhvdXJzKTsKICAgICAgICAgICAgICBpZiAodG9rZW5zICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBob3VyID0gK3Rva2Vuc1sxXTsKICAgICAgICAgICAgICAgIG1pbnV0ZSA9ICsodG9rZW5zWzJdIHx8IDApICogNjA7CiAgICAgICAgICAgICAgICBvZmZzZXRJbmRleCA9IDM7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KGlzbzg2MDFFcnJvck1lc3NhZ2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG1pbnV0ZSA+PSA2MCB8fCBzZWNvbmQgPj0gNjEgfHwgaG91ciA+IDI0IHx8IGhvdXIgPT09IDI0ICYmIChtaW51dGUgPiAwIHx8IHNlY29uZCA+IDAgfHwgbWlsbGlzZWNvbmQgPiAwKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdChpc284NjAxRXJyb3JNZXNzYWdlKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IG9mZnNldCA9IHRva2Vuc1tvZmZzZXRJbmRleF07CiAgICAgICAgICBjb25zdCBvZmZzZXRIb3VycyA9ICt0b2tlbnNbb2Zmc2V0SW5kZXggKyAxXTsKICAgICAgICAgIGNvbnN0IG9mZnNldE1pbnV0ZXMgPSArKHRva2Vuc1tvZmZzZXRJbmRleCArIDJdIHx8IDApOwogICAgICAgICAgc3dpdGNoIChvZmZzZXQpIHsKICAgICAgICAgICAgY2FzZSAiKyI6CiAgICAgICAgICAgICAgaG91ciA9IGhvdXIgLSBvZmZzZXRIb3VyczsKICAgICAgICAgICAgICBtaW51dGUgPSBtaW51dGUgLSBvZmZzZXRNaW51dGVzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICItIjoKICAgICAgICAgICAgICBob3VyID0gaG91ciArIG9mZnNldEhvdXJzOwogICAgICAgICAgICAgIG1pbnV0ZSA9IG1pbnV0ZSArIG9mZnNldE1pbnV0ZXM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIloiOgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIG1pbnV0ZSA9IG1pbnV0ZSArIG5ldyBEYXRlKAogICAgICAgICAgICAgICAgRGF0ZS5VVEMoeWVhciwgbW9udGggLSAxLCBkYXksIGhvdXIsIG1pbnV0ZSkKICAgICAgICAgICAgICApLmdldFRpbWV6b25lT2Zmc2V0KCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGlzTGVhcFNlY29uZCA9IHNlY29uZCA9PT0gNjA7CiAgICAgICAgaWYgKGlzTGVhcFNlY29uZCkgewogICAgICAgICAgc2Vjb25kLS07CiAgICAgICAgfQogICAgICAgIHdoaWxlIChtaW51dGUgPj0gNjApIHsKICAgICAgICAgIG1pbnV0ZSAtPSA2MDsKICAgICAgICAgIGhvdXIrKzsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKGhvdXIgPj0gMjQpIHsKICAgICAgICAgIGhvdXIgLT0gMjQ7CiAgICAgICAgICBkYXkrKzsKICAgICAgICB9CiAgICAgICAgdG1wMiA9IGluTGVhcFllYXIgJiYgbW9udGggPT09IDIgPyBkYXlzSW5MZWFwRmVidXJhcnkgOiBkYXlzSW5Nb250aFttb250aCAtIDFdOwogICAgICAgIHdoaWxlIChkYXkgPiB0bXAyKSB7CiAgICAgICAgICBkYXkgLT0gdG1wMjsKICAgICAgICAgIG1vbnRoKys7CiAgICAgICAgICBpZiAobW9udGggPiAxMikgewogICAgICAgICAgICBtb250aCAtPSAxMjsKICAgICAgICAgICAgeWVhcisrOwogICAgICAgICAgfQogICAgICAgICAgdG1wMiA9IGluTGVhcFllYXIgJiYgbW9udGggPT09IDIgPyBkYXlzSW5MZWFwRmVidXJhcnkgOiBkYXlzSW5Nb250aFttb250aCAtIDFdOwogICAgICAgIH0KICAgICAgICB3aGlsZSAobWludXRlIDwgMCkgewogICAgICAgICAgbWludXRlICs9IDYwOwogICAgICAgICAgaG91ci0tOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoaG91ciA8IDApIHsKICAgICAgICAgIGhvdXIgKz0gMjQ7CiAgICAgICAgICBkYXktLTsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKGRheSA8IDEpIHsKICAgICAgICAgIG1vbnRoLS07CiAgICAgICAgICBpZiAobW9udGggPCAxKSB7CiAgICAgICAgICAgIG1vbnRoICs9IDEyOwogICAgICAgICAgICB5ZWFyLS07CiAgICAgICAgICB9CiAgICAgICAgICB0bXAyID0gaW5MZWFwWWVhciAmJiBtb250aCA9PT0gMiA/IGRheXNJbkxlYXBGZWJ1cmFyeSA6IGRheXNJbk1vbnRoW21vbnRoIC0gMV07CiAgICAgICAgICBkYXkgKz0gdG1wMjsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29tcG9uZW50cyA9IGNvbXB1dGVKdWxpYW5EYXRlQ29tcG9uZW50cygKICAgICAgICAgIHllYXIsCiAgICAgICAgICBtb250aCwKICAgICAgICAgIGRheSwKICAgICAgICAgIGhvdXIsCiAgICAgICAgICBtaW51dGUsCiAgICAgICAgICBzZWNvbmQsCiAgICAgICAgICBtaWxsaXNlY29uZAogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEp1bGlhbkRhdGUoY29tcG9uZW50c1swXSwgY29tcG9uZW50c1sxXSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVVRDKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2V0Q29tcG9uZW50cyhjb21wb25lbnRzWzBdLCBjb21wb25lbnRzWzFdLCByZXN1bHQpOwogICAgICAgICAgY29udmVydFV0Y1RvVGFpKHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIGlmIChpc0xlYXBTZWNvbmQpIHsKICAgICAgICAgIEp1bGlhbkRhdGUuYWRkU2Vjb25kcyhyZXN1bHQsIDEsIHJlc3VsdCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUubm93ID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuZnJvbURhdGUoLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHRvR3JlZ29yaWFuRGF0ZVNjcmF0Y2ggPSBuZXcgSnVsaWFuRGF0ZSgwLCAwLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpOwogICAgICBKdWxpYW5EYXRlLnRvR3JlZ29yaWFuRGF0ZSA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGp1bGlhbkRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgianVsaWFuRGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IGlzTGVhcFNlY29uZCA9IGZhbHNlOwogICAgICAgIGxldCB0aGlzVXRjID0gY29udmVydFRhaVRvVXRjKGp1bGlhbkRhdGUsIHRvR3JlZ29yaWFuRGF0ZVNjcmF0Y2gpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXNVdGMpKSB7CiAgICAgICAgICBKdWxpYW5EYXRlLmFkZFNlY29uZHMoanVsaWFuRGF0ZSwgLTEsIHRvR3JlZ29yaWFuRGF0ZVNjcmF0Y2gpOwogICAgICAgICAgdGhpc1V0YyA9IGNvbnZlcnRUYWlUb1V0Yyh0b0dyZWdvcmlhbkRhdGVTY3JhdGNoLCB0b0dyZWdvcmlhbkRhdGVTY3JhdGNoKTsKICAgICAgICAgIGlzTGVhcFNlY29uZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGxldCBqdWxpYW5EYXlOdW1iZXIgPSB0aGlzVXRjLmRheU51bWJlcjsKICAgICAgICBjb25zdCBzZWNvbmRzT2ZEYXkgPSB0aGlzVXRjLnNlY29uZHNPZkRheTsKICAgICAgICBpZiAoc2Vjb25kc09mRGF5ID49IDQzMjAwKSB7CiAgICAgICAgICBqdWxpYW5EYXlOdW1iZXIgKz0gMTsKICAgICAgICB9CiAgICAgICAgbGV0IEwgPSBqdWxpYW5EYXlOdW1iZXIgKyA2ODU2OSB8IDA7CiAgICAgICAgY29uc3QgTiA9IDQgKiBMIC8gMTQ2MDk3IHwgMDsKICAgICAgICBMID0gTCAtICgoMTQ2MDk3ICogTiArIDMpIC8gNCB8IDApIHwgMDsKICAgICAgICBjb25zdCBJID0gNGUzICogKEwgKyAxKSAvIDE0NjEwMDEgfCAwOwogICAgICAgIEwgPSBMIC0gKDE0NjEgKiBJIC8gNCB8IDApICsgMzEgfCAwOwogICAgICAgIGNvbnN0IEogPSA4MCAqIEwgLyAyNDQ3IHwgMDsKICAgICAgICBjb25zdCBkYXkgPSBMIC0gKDI0NDcgKiBKIC8gODAgfCAwKSB8IDA7CiAgICAgICAgTCA9IEogLyAxMSB8IDA7CiAgICAgICAgY29uc3QgbW9udGggPSBKICsgMiAtIDEyICogTCB8IDA7CiAgICAgICAgY29uc3QgeWVhciA9IDEwMCAqIChOIC0gNDkpICsgSSArIEwgfCAwOwogICAgICAgIGxldCBob3VyID0gc2Vjb25kc09mRGF5IC8gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0hPVVIgfCAwOwogICAgICAgIGxldCByZW1haW5pbmdTZWNvbmRzID0gc2Vjb25kc09mRGF5IC0gaG91ciAqIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9IT1VSOwogICAgICAgIGNvbnN0IG1pbnV0ZSA9IHJlbWFpbmluZ1NlY29uZHMgLyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfTUlOVVRFIHwgMDsKICAgICAgICByZW1haW5pbmdTZWNvbmRzID0gcmVtYWluaW5nU2Vjb25kcyAtIG1pbnV0ZSAqIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9NSU5VVEU7CiAgICAgICAgbGV0IHNlY29uZCA9IHJlbWFpbmluZ1NlY29uZHMgfCAwOwogICAgICAgIGNvbnN0IG1pbGxpc2Vjb25kID0gKHJlbWFpbmluZ1NlY29uZHMgLSBzZWNvbmQpIC8gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX01JTExJU0VDT05EOwogICAgICAgIGhvdXIgKz0gMTI7CiAgICAgICAgaWYgKGhvdXIgPiAyMykgewogICAgICAgICAgaG91ciAtPSAyNDsKICAgICAgICB9CiAgICAgICAgaWYgKGlzTGVhcFNlY29uZCkgewogICAgICAgICAgc2Vjb25kICs9IDE7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgR3JlZ29yaWFuRGF0ZV9kZWZhdWx0KAogICAgICAgICAgICB5ZWFyLAogICAgICAgICAgICBtb250aCwKICAgICAgICAgICAgZGF5LAogICAgICAgICAgICBob3VyLAogICAgICAgICAgICBtaW51dGUsCiAgICAgICAgICAgIHNlY29uZCwKICAgICAgICAgICAgbWlsbGlzZWNvbmQsCiAgICAgICAgICAgIGlzTGVhcFNlY29uZAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnllYXIgPSB5ZWFyOwogICAgICAgIHJlc3VsdC5tb250aCA9IG1vbnRoOwogICAgICAgIHJlc3VsdC5kYXkgPSBkYXk7CiAgICAgICAgcmVzdWx0LmhvdXIgPSBob3VyOwogICAgICAgIHJlc3VsdC5taW51dGUgPSBtaW51dGU7CiAgICAgICAgcmVzdWx0LnNlY29uZCA9IHNlY29uZDsKICAgICAgICByZXN1bHQubWlsbGlzZWNvbmQgPSBtaWxsaXNlY29uZDsKICAgICAgICByZXN1bHQuaXNMZWFwU2Vjb25kID0gaXNMZWFwU2Vjb25kOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUudG9EYXRlID0gZnVuY3Rpb24oanVsaWFuRGF0ZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGp1bGlhbkRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgianVsaWFuRGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ0RhdGUgPSBKdWxpYW5EYXRlLnRvR3JlZ29yaWFuRGF0ZShqdWxpYW5EYXRlLCBncmVnb3JpYW5EYXRlU2NyYXRjaCk7CiAgICAgICAgbGV0IHNlY29uZCA9IGdEYXRlLnNlY29uZDsKICAgICAgICBpZiAoZ0RhdGUuaXNMZWFwU2Vjb25kKSB7CiAgICAgICAgICBzZWNvbmQgLT0gMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKAogICAgICAgICAgRGF0ZS5VVEMoCiAgICAgICAgICAgIGdEYXRlLnllYXIsCiAgICAgICAgICAgIGdEYXRlLm1vbnRoIC0gMSwKICAgICAgICAgICAgZ0RhdGUuZGF5LAogICAgICAgICAgICBnRGF0ZS5ob3VyLAogICAgICAgICAgICBnRGF0ZS5taW51dGUsCiAgICAgICAgICAgIHNlY29uZCwKICAgICAgICAgICAgZ0RhdGUubWlsbGlzZWNvbmQKICAgICAgICAgICkKICAgICAgICApOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLnRvSXNvODYwMSA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUsIHByZWNpc2lvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGp1bGlhbkRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgianVsaWFuRGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ0RhdGUgPSBKdWxpYW5EYXRlLnRvR3JlZ29yaWFuRGF0ZShqdWxpYW5EYXRlLCBncmVnb3JpYW5EYXRlU2NyYXRjaCk7CiAgICAgICAgbGV0IHllYXIgPSBnRGF0ZS55ZWFyOwogICAgICAgIGxldCBtb250aCA9IGdEYXRlLm1vbnRoOwogICAgICAgIGxldCBkYXkgPSBnRGF0ZS5kYXk7CiAgICAgICAgbGV0IGhvdXIgPSBnRGF0ZS5ob3VyOwogICAgICAgIGNvbnN0IG1pbnV0ZSA9IGdEYXRlLm1pbnV0ZTsKICAgICAgICBjb25zdCBzZWNvbmQgPSBnRGF0ZS5zZWNvbmQ7CiAgICAgICAgY29uc3QgbWlsbGlzZWNvbmQgPSBnRGF0ZS5taWxsaXNlY29uZDsKICAgICAgICBpZiAoeWVhciA9PT0gMWU0ICYmIG1vbnRoID09PSAxICYmIGRheSA9PT0gMSAmJiBob3VyID09PSAwICYmIG1pbnV0ZSA9PT0gMCAmJiBzZWNvbmQgPT09IDAgJiYgbWlsbGlzZWNvbmQgPT09IDApIHsKICAgICAgICAgIHllYXIgPSA5OTk5OwogICAgICAgICAgbW9udGggPSAxMjsKICAgICAgICAgIGRheSA9IDMxOwogICAgICAgICAgaG91ciA9IDI0OwogICAgICAgIH0KICAgICAgICBsZXQgbWlsbGlzZWNvbmRTdHI7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocHJlY2lzaW9uKSAmJiBtaWxsaXNlY29uZCAhPT0gMCkgewogICAgICAgICAgbWlsbGlzZWNvbmRTdHIgPSAobWlsbGlzZWNvbmQgKiAwLjAxKS50b1N0cmluZygpLnJlcGxhY2UoIi4iLCAiIik7CiAgICAgICAgICByZXR1cm4gYCR7eWVhci50b1N0cmluZygpLnBhZFN0YXJ0KDQsICIwIil9LSR7bW9udGgudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfS0ke2RheS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9VCR7aG91ci50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9OiR7bWludXRlLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX06JHtzZWNvbmQudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfS4ke21pbGxpc2Vjb25kU3RyfVpgOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcmVjaXNpb24pIHx8IHByZWNpc2lvbiA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIGAke3llYXIudG9TdHJpbmcoKS5wYWRTdGFydCg0LCAiMCIpfS0ke21vbnRoLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX0tJHtkYXkudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfVQke2hvdXIudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfToke21pbnV0ZS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9OiR7c2Vjb25kLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX1aYDsKICAgICAgICB9CiAgICAgICAgbWlsbGlzZWNvbmRTdHIgPSAobWlsbGlzZWNvbmQgKiAwLjAxKS50b0ZpeGVkKHByZWNpc2lvbikucmVwbGFjZSgiLiIsICIiKS5zbGljZSgwLCBwcmVjaXNpb24pOwogICAgICAgIHJldHVybiBgJHt5ZWFyLnRvU3RyaW5nKCkucGFkU3RhcnQoNCwgIjAiKX0tJHttb250aC50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9LSR7ZGF5LnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX1UJHtob3VyLnRvU3RyaW5nKCkucGFkU3RhcnQoMiwgIjAiKX06JHttaW51dGUudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpfToke3NlY29uZC50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIil9LiR7bWlsbGlzZWNvbmRTdHJ9WmA7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuY2xvbmUgPSBmdW5jdGlvbihqdWxpYW5EYXRlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChqdWxpYW5EYXRlKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBKdWxpYW5EYXRlKAogICAgICAgICAgICBqdWxpYW5EYXRlLmRheU51bWJlciwKICAgICAgICAgICAganVsaWFuRGF0ZS5zZWNvbmRzT2ZEYXksCiAgICAgICAgICAgIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmRheU51bWJlciA9IGp1bGlhbkRhdGUuZGF5TnVtYmVyOwogICAgICAgIHJlc3VsdC5zZWNvbmRzT2ZEYXkgPSBqdWxpYW5EYXRlLnNlY29uZHNPZkRheTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmNvbXBhcmUgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlZnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibGVmdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmlnaHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGp1bGlhbkRheU51bWJlckRpZmZlcmVuY2UgPSBsZWZ0LmRheU51bWJlciAtIHJpZ2h0LmRheU51bWJlcjsKICAgICAgICBpZiAoanVsaWFuRGF5TnVtYmVyRGlmZmVyZW5jZSAhPT0gMCkgewogICAgICAgICAgcmV0dXJuIGp1bGlhbkRheU51bWJlckRpZmZlcmVuY2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiBsZWZ0LnNlY29uZHNPZkRheSAtIHJpZ2h0LnNlY29uZHNPZkRheTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LmRheU51bWJlciA9PT0gcmlnaHQuZGF5TnVtYmVyICYmIGxlZnQuc2Vjb25kc09mRGF5ID09PSByaWdodC5zZWNvbmRzT2ZEYXk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgZXBzaWxvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVwc2lsb24sIDApOwogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoLmFicyhKdWxpYW5EYXRlLnNlY29uZHNEaWZmZXJlbmNlKGxlZnQsIHJpZ2h0KSkgPD0gZXBzaWxvbjsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS50b3RhbERheXMgPSBmdW5jdGlvbihqdWxpYW5EYXRlKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoanVsaWFuRGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJqdWxpYW5EYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4ganVsaWFuRGF0ZS5kYXlOdW1iZXIgKyBqdWxpYW5EYXRlLnNlY29uZHNPZkRheSAvIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9EQVk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuc2Vjb25kc0RpZmZlcmVuY2UgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlZnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibGVmdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmlnaHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRheURpZmZlcmVuY2UgPSAobGVmdC5kYXlOdW1iZXIgLSByaWdodC5kYXlOdW1iZXIpICogVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWTsKICAgICAgICByZXR1cm4gZGF5RGlmZmVyZW5jZSArIChsZWZ0LnNlY29uZHNPZkRheSAtIHJpZ2h0LnNlY29uZHNPZkRheSk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuZGF5c0RpZmZlcmVuY2UgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGxlZnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibGVmdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmlnaHQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRheURpZmZlcmVuY2UgPSBsZWZ0LmRheU51bWJlciAtIHJpZ2h0LmRheU51bWJlcjsKICAgICAgICBjb25zdCBzZWNvbmREaWZmZXJlbmNlID0gKGxlZnQuc2Vjb25kc09mRGF5IC0gcmlnaHQuc2Vjb25kc09mRGF5KSAvIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9EQVk7CiAgICAgICAgcmV0dXJuIGRheURpZmZlcmVuY2UgKyBzZWNvbmREaWZmZXJlbmNlOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmNvbXB1dGVUYWlNaW51c1V0YyA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUpIHsKICAgICAgICBiaW5hcnlTZWFyY2hTY3JhdGNoTGVhcFNlY29uZC5qdWxpYW5EYXRlID0ganVsaWFuRGF0ZTsKICAgICAgICBjb25zdCBsZWFwU2Vjb25kcyA9IEp1bGlhbkRhdGUubGVhcFNlY29uZHM7CiAgICAgICAgbGV0IGluZGV4ID0gYmluYXJ5U2VhcmNoX2RlZmF1bHQoCiAgICAgICAgICBsZWFwU2Vjb25kcywKICAgICAgICAgIGJpbmFyeVNlYXJjaFNjcmF0Y2hMZWFwU2Vjb25kLAogICAgICAgICAgY29tcGFyZUxlYXBTZWNvbmREYXRlcwogICAgICAgICk7CiAgICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgaW5kZXggPSB+aW5kZXg7CiAgICAgICAgICAtLWluZGV4OwogICAgICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgICBpbmRleCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBsZWFwU2Vjb25kc1tpbmRleF0ub2Zmc2V0OwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmFkZFNlY29uZHMgPSBmdW5jdGlvbihqdWxpYW5EYXRlLCBzZWNvbmRzLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChqdWxpYW5EYXRlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImp1bGlhbkRhdGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNlY29uZHMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2Vjb25kcyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJlc3VsdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNldENvbXBvbmVudHMoCiAgICAgICAgICBqdWxpYW5EYXRlLmRheU51bWJlciwKICAgICAgICAgIGp1bGlhbkRhdGUuc2Vjb25kc09mRGF5ICsgc2Vjb25kcywKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuYWRkTWludXRlcyA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUsIG1pbnV0ZXMsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGp1bGlhbkRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgianVsaWFuRGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobWludXRlcykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJtaW51dGVzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVzdWx0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdTZWNvbmRzT2ZEYXkgPSBqdWxpYW5EYXRlLnNlY29uZHNPZkRheSArIG1pbnV0ZXMgKiBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfTUlOVVRFOwogICAgICAgIHJldHVybiBzZXRDb21wb25lbnRzKGp1bGlhbkRhdGUuZGF5TnVtYmVyLCBuZXdTZWNvbmRzT2ZEYXksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuYWRkSG91cnMgPSBmdW5jdGlvbihqdWxpYW5EYXRlLCBob3VycywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoanVsaWFuRGF0ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJqdWxpYW5EYXRlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChob3VycykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJob3VycyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJlc3VsdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbmV3U2Vjb25kc09mRGF5ID0ganVsaWFuRGF0ZS5zZWNvbmRzT2ZEYXkgKyBob3VycyAqIFRpbWVDb25zdGFudHNfZGVmYXVsdC5TRUNPTkRTX1BFUl9IT1VSOwogICAgICAgIHJldHVybiBzZXRDb21wb25lbnRzKGp1bGlhbkRhdGUuZGF5TnVtYmVyLCBuZXdTZWNvbmRzT2ZEYXksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuYWRkRGF5cyA9IGZ1bmN0aW9uKGp1bGlhbkRhdGUsIGRheXMsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGp1bGlhbkRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgianVsaWFuRGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGF5cykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkYXlzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVzdWx0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdKdWxpYW5EYXlOdW1iZXIgPSBqdWxpYW5EYXRlLmRheU51bWJlciArIGRheXM7CiAgICAgICAgcmV0dXJuIHNldENvbXBvbmVudHMobmV3SnVsaWFuRGF5TnVtYmVyLCBqdWxpYW5EYXRlLnNlY29uZHNPZkRheSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5sZXNzVGhhbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuY29tcGFyZShsZWZ0LCByaWdodCkgPCAwOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmxlc3NUaGFuT3JFcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBKdWxpYW5EYXRlLmNvbXBhcmUobGVmdCwgcmlnaHQpIDw9IDA7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUuZ3JlYXRlclRoYW4gPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBKdWxpYW5EYXRlLmNvbXBhcmUobGVmdCwgcmlnaHQpID4gMDsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5ncmVhdGVyVGhhbk9yRXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gSnVsaWFuRGF0ZS5jb21wYXJlKGxlZnQsIHJpZ2h0KSA+PSAwOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBKdWxpYW5EYXRlLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgSnVsaWFuRGF0ZS5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUuZXF1YWxzRXBzaWxvbih0aGlzLCByaWdodCwgZXBzaWxvbik7CiAgICAgIH07CiAgICAgIEp1bGlhbkRhdGUucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIEp1bGlhbkRhdGUudG9Jc284NjAxKHRoaXMpOwogICAgICB9OwogICAgICBKdWxpYW5EYXRlLmxlYXBTZWNvbmRzID0gWwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0MTMxNywgNDMyMTAsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDEwKSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5NzIgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQxNDk5LCA0MzIxMSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMTEpLAogICAgICAgIC8vIEp1bHkgMSwgMTk3MiAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDE2ODMsIDQzMjEyLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAxMiksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTczIDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0MjA0OCwgNDMyMTMsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDEzKSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5NzQgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQyNDEzLCA0MzIxNCwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMTQpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk3NSAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDI3NzgsIDQzMjE1LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAxNSksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTc2IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0MzE0NCwgNDMyMTYsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDE2KSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5NzcgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQzNTA5LCA0MzIxNywgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMTcpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk3OCAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDM4NzQsIDQzMjE4LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAxOCksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTc5IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0NDIzOSwgNDMyMTksIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDE5KSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5ODAgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ0Nzg2LCA0MzIyMCwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMjApLAogICAgICAgIC8vIEp1bHkgMSwgMTk4MSAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDUxNTEsIDQzMjIxLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAyMSksCiAgICAgICAgLy8gSnVseSAxLCAxOTgyIDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0NTUxNiwgNDMyMjIsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDIyKSwKICAgICAgICAvLyBKdWx5IDEsIDE5ODMgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ2MjQ3LCA0MzIyMywgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMjMpLAogICAgICAgIC8vIEp1bHkgMSwgMTk4NSAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDcxNjEsIDQzMjI0LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAyNCksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTg4IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0Nzg5MiwgNDMyMjUsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDI1KSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDE5OTAgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ4MjU3LCA0MzIyNiwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMjYpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk5MSAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NDg4MDQsIDQzMjI3LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAyNyksCiAgICAgICAgLy8gSnVseSAxLCAxOTkyIDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ0OTE2OSwgNDMyMjgsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDI4KSwKICAgICAgICAvLyBKdWx5IDEsIDE5OTMgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDQ5NTM0LCA0MzIyOSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMjkpLAogICAgICAgIC8vIEp1bHkgMSwgMTk5NCAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NTAwODMsIDQzMjMwLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAzMCksCiAgICAgICAgLy8gSmFudWFyeSAxLCAxOTk2IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ1MDYzMCwgNDMyMzEsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDMxKSwKICAgICAgICAvLyBKdWx5IDEsIDE5OTcgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDUxMTc5LCA0MzIzMiwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMzIpLAogICAgICAgIC8vIEphbnVhcnkgMSwgMTk5OSAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NTM3MzYsIDQzMjMzLCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAzMyksCiAgICAgICAgLy8gSmFudWFyeSAxLCAyMDA2IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ1NDgzMiwgNDMyMzQsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDM0KSwKICAgICAgICAvLyBKYW51YXJ5IDEsIDIwMDkgMDA6MDA6MDAgVVRDCiAgICAgICAgbmV3IExlYXBTZWNvbmRfZGVmYXVsdChuZXcgSnVsaWFuRGF0ZSgyNDU2MTA5LCA0MzIzNSwgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKSwgMzUpLAogICAgICAgIC8vIEp1bHkgMSwgMjAxMiAwMDowMDowMCBVVEMKICAgICAgICBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KG5ldyBKdWxpYW5EYXRlKDI0NTcyMDQsIDQzMjM2LCBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkpLCAzNiksCiAgICAgICAgLy8gSnVseSAxLCAyMDE1IDAwOjAwOjAwIFVUQwogICAgICAgIG5ldyBMZWFwU2Vjb25kX2RlZmF1bHQobmV3IEp1bGlhbkRhdGUoMjQ1Nzc1NCwgNDMyMzcsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSksIDM3KQogICAgICAgIC8vIEphbnVhcnkgMSwgMjAxNyAwMDowMDowMCBVVEMKICAgICAgXTsKICAgICAgSnVsaWFuRGF0ZV9kZWZhdWx0ID0gSnVsaWFuRGF0ZTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3VyaWpzL3NyYy9wdW55Y29kZS5qcwogIHZhciByZXF1aXJlX3B1bnljb2RlID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3VyaWpzL3NyYy9wdW55Y29kZS5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAvKiEgaHR0cHM6Ly9tdGhzLmJlL3B1bnljb2RlIHYxLjQuMCBieSBAbWF0aGlhcyAqLwogICAgICAoZnVuY3Rpb24ocm9vdCkgewogICAgICAgIHZhciBmcmVlRXhwb3J0cyA9IHR5cGVvZiBleHBvcnRzMiA9PSAib2JqZWN0IiAmJiBleHBvcnRzMiAmJiAhZXhwb3J0czIubm9kZVR5cGUgJiYgZXhwb3J0czI7CiAgICAgICAgdmFyIGZyZWVNb2R1bGUgPSB0eXBlb2YgbW9kdWxlID09ICJvYmplY3QiICYmIG1vZHVsZSAmJiAhbW9kdWxlLm5vZGVUeXBlICYmIG1vZHVsZTsKICAgICAgICB2YXIgZnJlZUdsb2JhbCA9IHR5cGVvZiBnbG9iYWwgPT0gIm9iamVjdCIgJiYgZ2xvYmFsOwogICAgICAgIGlmIChmcmVlR2xvYmFsLmdsb2JhbCA9PT0gZnJlZUdsb2JhbCB8fCBmcmVlR2xvYmFsLndpbmRvdyA9PT0gZnJlZUdsb2JhbCB8fCBmcmVlR2xvYmFsLnNlbGYgPT09IGZyZWVHbG9iYWwpIHsKICAgICAgICAgIHJvb3QgPSBmcmVlR2xvYmFsOwogICAgICAgIH0KICAgICAgICB2YXIgcHVueWNvZGUsIG1heEludCA9IDIxNDc0ODM2NDcsIGJhc2UgPSAzNiwgdE1pbiA9IDEsIHRNYXggPSAyNiwgc2tldyA9IDM4LCBkYW1wID0gNzAwLCBpbml0aWFsQmlhcyA9IDcyLCBpbml0aWFsTiA9IDEyOCwgZGVsaW1pdGVyID0gIi0iLCByZWdleFB1bnljb2RlID0gL154bi0tLywgcmVnZXhOb25BU0NJSSA9IC9bXlx4MjAtXHg3RV0vLCByZWdleFNlcGFyYXRvcnMgPSAvW1x4MkVcdTMwMDJcdUZGMEVcdUZGNjFdL2csIGVycm9ycyA9IHsKICAgICAgICAgICJvdmVyZmxvdyI6ICJPdmVyZmxvdzogaW5wdXQgbmVlZHMgd2lkZXIgaW50ZWdlcnMgdG8gcHJvY2VzcyIsCiAgICAgICAgICAibm90LWJhc2ljIjogIklsbGVnYWwgaW5wdXQgPj0gMHg4MCAobm90IGEgYmFzaWMgY29kZSBwb2ludCkiLAogICAgICAgICAgImludmFsaWQtaW5wdXQiOiAiSW52YWxpZCBpbnB1dCIKICAgICAgICB9LCBiYXNlTWludXNUTWluID0gYmFzZSAtIHRNaW4sIGZsb29yID0gTWF0aC5mbG9vciwgc3RyaW5nRnJvbUNoYXJDb2RlID0gU3RyaW5nLmZyb21DaGFyQ29kZSwga2V5OwogICAgICAgIGZ1bmN0aW9uIGVycm9yKHR5cGUpIHsKICAgICAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKGVycm9yc1t0eXBlXSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcChhcnJheSwgZm4pIHsKICAgICAgICAgIHZhciBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBmbihhcnJheVtsZW5ndGhdKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcERvbWFpbihzdHJpbmcsIGZuKSB7CiAgICAgICAgICB2YXIgcGFydHMgPSBzdHJpbmcuc3BsaXQoIkAiKTsKICAgICAgICAgIHZhciByZXN1bHQgPSAiIjsKICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHBhcnRzWzBdICsgIkAiOwogICAgICAgICAgICBzdHJpbmcgPSBwYXJ0c1sxXTsKICAgICAgICAgIH0KICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKHJlZ2V4U2VwYXJhdG9ycywgIi4iKTsKICAgICAgICAgIHZhciBsYWJlbHMgPSBzdHJpbmcuc3BsaXQoIi4iKTsKICAgICAgICAgIHZhciBlbmNvZGVkID0gbWFwKGxhYmVscywgZm4pLmpvaW4oIi4iKTsKICAgICAgICAgIHJldHVybiByZXN1bHQgKyBlbmNvZGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1Y3MyZGVjb2RlKHN0cmluZykgewogICAgICAgICAgdmFyIG91dHB1dCA9IFtdLCBjb3VudGVyID0gMCwgbGVuZ3RoID0gc3RyaW5nLmxlbmd0aCwgdmFsdWUsIGV4dHJhOwogICAgICAgICAgd2hpbGUgKGNvdW50ZXIgPCBsZW5ndGgpIHsKICAgICAgICAgICAgdmFsdWUgPSBzdHJpbmcuY2hhckNvZGVBdChjb3VudGVyKyspOwogICAgICAgICAgICBpZiAodmFsdWUgPj0gNTUyOTYgJiYgdmFsdWUgPD0gNTYzMTkgJiYgY291bnRlciA8IGxlbmd0aCkgewogICAgICAgICAgICAgIGV4dHJhID0gc3RyaW5nLmNoYXJDb2RlQXQoY291bnRlcisrKTsKICAgICAgICAgICAgICBpZiAoKGV4dHJhICYgNjQ1MTIpID09IDU2MzIwKSB7CiAgICAgICAgICAgICAgICBvdXRwdXQucHVzaCgoKHZhbHVlICYgMTAyMykgPDwgMTApICsgKGV4dHJhICYgMTAyMykgKyA2NTUzNik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgICAgIGNvdW50ZXItLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgb3V0cHV0LnB1c2godmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1Y3MyZW5jb2RlKGFycmF5KSB7CiAgICAgICAgICByZXR1cm4gbWFwKGFycmF5LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICB2YXIgb3V0cHV0ID0gIiI7CiAgICAgICAgICAgIGlmICh2YWx1ZSA+IDY1NTM1KSB7CiAgICAgICAgICAgICAgdmFsdWUgLT0gNjU1MzY7CiAgICAgICAgICAgICAgb3V0cHV0ICs9IHN0cmluZ0Zyb21DaGFyQ29kZSh2YWx1ZSA+Pj4gMTAgJiAxMDIzIHwgNTUyOTYpOwogICAgICAgICAgICAgIHZhbHVlID0gNTYzMjAgfCB2YWx1ZSAmIDEwMjM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3V0cHV0ICs9IHN0cmluZ0Zyb21DaGFyQ29kZSh2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgICB9KS5qb2luKCIiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmFzaWNUb0RpZ2l0KGNvZGVQb2ludCkgewogICAgICAgICAgaWYgKGNvZGVQb2ludCAtIDQ4IDwgMTApIHsKICAgICAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDIyOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvZGVQb2ludCAtIDY1IDwgMjYpIHsKICAgICAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDY1OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvZGVQb2ludCAtIDk3IDwgMjYpIHsKICAgICAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDk3OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJhc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZ2l0VG9CYXNpYyhkaWdpdCwgZmxhZykgewogICAgICAgICAgcmV0dXJuIGRpZ2l0ICsgMjIgKyA3NSAqIChkaWdpdCA8IDI2KSAtICgoZmxhZyAhPSAwKSA8PCA1KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRhcHQoZGVsdGEsIG51bVBvaW50cywgZmlyc3RUaW1lKSB7CiAgICAgICAgICB2YXIgayA9IDA7CiAgICAgICAgICBkZWx0YSA9IGZpcnN0VGltZSA/IGZsb29yKGRlbHRhIC8gZGFtcCkgOiBkZWx0YSA+PiAxOwogICAgICAgICAgZGVsdGEgKz0gZmxvb3IoZGVsdGEgLyBudW1Qb2ludHMpOwogICAgICAgICAgZm9yICg7IGRlbHRhID4gYmFzZU1pbnVzVE1pbiAqIHRNYXggPj4gMTsgayArPSBiYXNlKSB7CiAgICAgICAgICAgIGRlbHRhID0gZmxvb3IoZGVsdGEgLyBiYXNlTWludXNUTWluKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbG9vcihrICsgKGJhc2VNaW51c1RNaW4gKyAxKSAqIGRlbHRhIC8gKGRlbHRhICsgc2tldykpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWNvZGUzKGlucHV0KSB7CiAgICAgICAgICB2YXIgb3V0cHV0ID0gW10sIGlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoLCBvdXQsIGkgPSAwLCBuID0gaW5pdGlhbE4sIGJpYXMgPSBpbml0aWFsQmlhcywgYmFzaWMsIGosIGluZGV4LCBvbGRpLCB3LCBrLCBkaWdpdCwgdCwgYmFzZU1pbnVzVDsKICAgICAgICAgIGJhc2ljID0gaW5wdXQubGFzdEluZGV4T2YoZGVsaW1pdGVyKTsKICAgICAgICAgIGlmIChiYXNpYyA8IDApIHsKICAgICAgICAgICAgYmFzaWMgPSAwOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChqID0gMDsgaiA8IGJhc2ljOyArK2opIHsKICAgICAgICAgICAgaWYgKGlucHV0LmNoYXJDb2RlQXQoaikgPj0gMTI4KSB7CiAgICAgICAgICAgICAgZXJyb3IoIm5vdC1iYXNpYyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG91dHB1dC5wdXNoKGlucHV0LmNoYXJDb2RlQXQoaikpOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChpbmRleCA9IGJhc2ljID4gMCA/IGJhc2ljICsgMSA6IDA7IGluZGV4IDwgaW5wdXRMZW5ndGg7ICkgewogICAgICAgICAgICBmb3IgKG9sZGkgPSBpLCB3ID0gMSwgayA9IGJhc2U7IDsgayArPSBiYXNlKSB7CiAgICAgICAgICAgICAgaWYgKGluZGV4ID49IGlucHV0TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiaW52YWxpZC1pbnB1dCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaWdpdCA9IGJhc2ljVG9EaWdpdChpbnB1dC5jaGFyQ29kZUF0KGluZGV4KyspKTsKICAgICAgICAgICAgICBpZiAoZGlnaXQgPj0gYmFzZSB8fCBkaWdpdCA+IGZsb29yKChtYXhJbnQgLSBpKSAvIHcpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigib3ZlcmZsb3ciKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaSArPSBkaWdpdCAqIHc7CiAgICAgICAgICAgICAgdCA9IGsgPD0gYmlhcyA/IHRNaW4gOiBrID49IGJpYXMgKyB0TWF4ID8gdE1heCA6IGsgLSBiaWFzOwogICAgICAgICAgICAgIGlmIChkaWdpdCA8IHQpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBiYXNlTWludXNUID0gYmFzZSAtIHQ7CiAgICAgICAgICAgICAgaWYgKHcgPiBmbG9vcihtYXhJbnQgLyBiYXNlTWludXNUKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIm92ZXJmbG93Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHcgKj0gYmFzZU1pbnVzVDsKICAgICAgICAgICAgfQogICAgICAgICAgICBvdXQgPSBvdXRwdXQubGVuZ3RoICsgMTsKICAgICAgICAgICAgYmlhcyA9IGFkYXB0KGkgLSBvbGRpLCBvdXQsIG9sZGkgPT0gMCk7CiAgICAgICAgICAgIGlmIChmbG9vcihpIC8gb3V0KSA+IG1heEludCAtIG4pIHsKICAgICAgICAgICAgICBlcnJvcigib3ZlcmZsb3ciKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuICs9IGZsb29yKGkgLyBvdXQpOwogICAgICAgICAgICBpICU9IG91dDsKICAgICAgICAgICAgb3V0cHV0LnNwbGljZShpKyssIDAsIG4pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVjczJlbmNvZGUob3V0cHV0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5jb2RlKGlucHV0KSB7CiAgICAgICAgICB2YXIgbiwgZGVsdGEsIGhhbmRsZWRDUENvdW50LCBiYXNpY0xlbmd0aCwgYmlhcywgaiwgbSwgcSwgaywgdCwgY3VycmVudFZhbHVlLCBvdXRwdXQgPSBbXSwgaW5wdXRMZW5ndGgsIGhhbmRsZWRDUENvdW50UGx1c09uZSwgYmFzZU1pbnVzVCwgcU1pbnVzVDsKICAgICAgICAgIGlucHV0ID0gdWNzMmRlY29kZShpbnB1dCk7CiAgICAgICAgICBpbnB1dExlbmd0aCA9IGlucHV0Lmxlbmd0aDsKICAgICAgICAgIG4gPSBpbml0aWFsTjsKICAgICAgICAgIGRlbHRhID0gMDsKICAgICAgICAgIGJpYXMgPSBpbml0aWFsQmlhczsKICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBpbnB1dExlbmd0aDsgKytqKSB7CiAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwogICAgICAgICAgICBpZiAoY3VycmVudFZhbHVlIDwgMTI4KSB7CiAgICAgICAgICAgICAgb3V0cHV0LnB1c2goc3RyaW5nRnJvbUNoYXJDb2RlKGN1cnJlbnRWYWx1ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBoYW5kbGVkQ1BDb3VudCA9IGJhc2ljTGVuZ3RoID0gb3V0cHV0Lmxlbmd0aDsKICAgICAgICAgIGlmIChiYXNpY0xlbmd0aCkgewogICAgICAgICAgICBvdXRwdXQucHVzaChkZWxpbWl0ZXIpOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGhhbmRsZWRDUENvdW50IDwgaW5wdXRMZW5ndGgpIHsKICAgICAgICAgICAgZm9yIChtID0gbWF4SW50LCBqID0gMDsgaiA8IGlucHV0TGVuZ3RoOyArK2opIHsKICAgICAgICAgICAgICBjdXJyZW50VmFsdWUgPSBpbnB1dFtqXTsKICAgICAgICAgICAgICBpZiAoY3VycmVudFZhbHVlID49IG4gJiYgY3VycmVudFZhbHVlIDwgbSkgewogICAgICAgICAgICAgICAgbSA9IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGFuZGxlZENQQ291bnRQbHVzT25lID0gaGFuZGxlZENQQ291bnQgKyAxOwogICAgICAgICAgICBpZiAobSAtIG4gPiBmbG9vcigobWF4SW50IC0gZGVsdGEpIC8gaGFuZGxlZENQQ291bnRQbHVzT25lKSkgewogICAgICAgICAgICAgIGVycm9yKCJvdmVyZmxvdyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlbHRhICs9IChtIC0gbikgKiBoYW5kbGVkQ1BDb3VudFBsdXNPbmU7CiAgICAgICAgICAgIG4gPSBtOwogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewogICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwogICAgICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPCBuICYmICsrZGVsdGEgPiBtYXhJbnQpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJvdmVyZmxvdyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY3VycmVudFZhbHVlID09IG4pIHsKICAgICAgICAgICAgICAgIGZvciAocSA9IGRlbHRhLCBrID0gYmFzZTsgOyBrICs9IGJhc2UpIHsKICAgICAgICAgICAgICAgICAgdCA9IGsgPD0gYmlhcyA/IHRNaW4gOiBrID49IGJpYXMgKyB0TWF4ID8gdE1heCA6IGsgLSBiaWFzOwogICAgICAgICAgICAgICAgICBpZiAocSA8IHQpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBxTWludXNUID0gcSAtIHQ7CiAgICAgICAgICAgICAgICAgIGJhc2VNaW51c1QgPSBiYXNlIC0gdDsKICAgICAgICAgICAgICAgICAgb3V0cHV0LnB1c2goCiAgICAgICAgICAgICAgICAgICAgc3RyaW5nRnJvbUNoYXJDb2RlKGRpZ2l0VG9CYXNpYyh0ICsgcU1pbnVzVCAlIGJhc2VNaW51c1QsIDApKQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBxID0gZmxvb3IocU1pbnVzVCAvIGJhc2VNaW51c1QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgb3V0cHV0LnB1c2goc3RyaW5nRnJvbUNoYXJDb2RlKGRpZ2l0VG9CYXNpYyhxLCAwKSkpOwogICAgICAgICAgICAgICAgYmlhcyA9IGFkYXB0KGRlbHRhLCBoYW5kbGVkQ1BDb3VudFBsdXNPbmUsIGhhbmRsZWRDUENvdW50ID09IGJhc2ljTGVuZ3RoKTsKICAgICAgICAgICAgICAgIGRlbHRhID0gMDsKICAgICAgICAgICAgICAgICsraGFuZGxlZENQQ291bnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgICsrZGVsdGE7CiAgICAgICAgICAgICsrbjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBvdXRwdXQuam9pbigiIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRvVW5pY29kZShpbnB1dCkgewogICAgICAgICAgcmV0dXJuIG1hcERvbWFpbihpbnB1dCwgZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiByZWdleFB1bnljb2RlLnRlc3Qoc3RyaW5nKSA/IGRlY29kZTMoc3RyaW5nLnNsaWNlKDQpLnRvTG93ZXJDYXNlKCkpIDogc3RyaW5nOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRvQVNDSUkoaW5wdXQpIHsKICAgICAgICAgIHJldHVybiBtYXBEb21haW4oaW5wdXQsIGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gcmVnZXhOb25BU0NJSS50ZXN0KHN0cmluZykgPyAieG4tLSIgKyBlbmNvZGUoc3RyaW5nKSA6IHN0cmluZzsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBwdW55Y29kZSA9IHsKICAgICAgICAgIC8qKgogICAgICAgICAgICogQSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBjdXJyZW50IFB1bnljb2RlLmpzIHZlcnNpb24gbnVtYmVyLgogICAgICAgICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgICAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAgICAgICAqLwogICAgICAgICAgInZlcnNpb24iOiAiMS4zLjIiLAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBBbiBvYmplY3Qgb2YgbWV0aG9kcyB0byBjb252ZXJ0IGZyb20gSmF2YVNjcmlwdCdzIGludGVybmFsIGNoYXJhY3RlcgogICAgICAgICAgICogcmVwcmVzZW50YXRpb24gKFVDUy0yKSB0byBVbmljb2RlIGNvZGUgcG9pbnRzLCBhbmQgYmFjay4KICAgICAgICAgICAqIEBzZWUgPGh0dHBzOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9qYXZhc2NyaXB0LWVuY29kaW5nPgogICAgICAgICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgICAgICAgKiBAdHlwZSBPYmplY3QKICAgICAgICAgICAqLwogICAgICAgICAgInVjczIiOiB7CiAgICAgICAgICAgICJkZWNvZGUiOiB1Y3MyZGVjb2RlLAogICAgICAgICAgICAiZW5jb2RlIjogdWNzMmVuY29kZQogICAgICAgICAgfSwKICAgICAgICAgICJkZWNvZGUiOiBkZWNvZGUzLAogICAgICAgICAgImVuY29kZSI6IGVuY29kZSwKICAgICAgICAgICJ0b0FTQ0lJIjogdG9BU0NJSSwKICAgICAgICAgICJ0b1VuaWNvZGUiOiB0b1VuaWNvZGUKICAgICAgICB9OwogICAgICAgIGlmICh0eXBlb2YgZGVmaW5lID09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGRlZmluZS5hbWQgPT0gIm9iamVjdCIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgICAgZGVmaW5lKCJwdW55Y29kZSIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gcHVueWNvZGU7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKGZyZWVFeHBvcnRzICYmIGZyZWVNb2R1bGUpIHsKICAgICAgICAgIGlmIChtb2R1bGUuZXhwb3J0cyA9PSBmcmVlRXhwb3J0cykgewogICAgICAgICAgICBmcmVlTW9kdWxlLmV4cG9ydHMgPSBwdW55Y29kZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIHB1bnljb2RlKSB7CiAgICAgICAgICAgICAgcHVueWNvZGUuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAoZnJlZUV4cG9ydHNba2V5XSA9IHB1bnljb2RlW2tleV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJvb3QucHVueWNvZGUgPSBwdW55Y29kZTsKICAgICAgICB9CiAgICAgIH0pKGV4cG9ydHMyKTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3VyaWpzL3NyYy9JUHY2LmpzCiAgdmFyIHJlcXVpcmVfSVB2NiA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy91cmlqcy9zcmMvSVB2Ni5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAvKiEKICAgICAgICogVVJJLmpzIC0gTXV0YXRpbmcgVVJMcwogICAgICAgKiBJUHY2IFN1cHBvcnQKICAgICAgICoKICAgICAgICogVmVyc2lvbjogMS4xOS4xMQogICAgICAgKgogICAgICAgKiBBdXRob3I6IFJvZG5leSBSZWhtCiAgICAgICAqIFdlYjogaHR0cDovL21lZGlhbGl6ZS5naXRodWIuaW8vVVJJLmpzLwogICAgICAgKgogICAgICAgKiBMaWNlbnNlZCB1bmRlcgogICAgICAgKiAgIE1JVCBMaWNlbnNlIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UKICAgICAgICoKICAgICAgICovCiAgICAgIChmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgbW9kdWxlID09PSAib2JqZWN0IiAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICAgICAgICAgIGRlZmluZShmYWN0b3J5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcm9vdC5JUHY2ID0gZmFjdG9yeShyb290KTsKICAgICAgICB9CiAgICAgIH0pKGV4cG9ydHMyLCBmdW5jdGlvbihyb290KSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBfSVB2NiA9IHJvb3QgJiYgcm9vdC5JUHY2OwogICAgICAgIGZ1bmN0aW9uIGJlc3RQcmVzZW50YXRpb24oYWRkcmVzcykgewogICAgICAgICAgdmFyIF9hZGRyZXNzID0gYWRkcmVzcy50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgdmFyIHNlZ21lbnRzID0gX2FkZHJlc3Muc3BsaXQoIjoiKTsKICAgICAgICAgIHZhciBsZW5ndGggPSBzZWdtZW50cy5sZW5ndGg7CiAgICAgICAgICB2YXIgdG90YWwgPSA4OwogICAgICAgICAgaWYgKHNlZ21lbnRzWzBdID09PSAiIiAmJiBzZWdtZW50c1sxXSA9PT0gIiIgJiYgc2VnbWVudHNbMl0gPT09ICIiKSB7CiAgICAgICAgICAgIHNlZ21lbnRzLnNoaWZ0KCk7CiAgICAgICAgICAgIHNlZ21lbnRzLnNoaWZ0KCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHNlZ21lbnRzWzBdID09PSAiIiAmJiBzZWdtZW50c1sxXSA9PT0gIiIpIHsKICAgICAgICAgICAgc2VnbWVudHMuc2hpZnQoKTsKICAgICAgICAgIH0gZWxzZSBpZiAoc2VnbWVudHNbbGVuZ3RoIC0gMV0gPT09ICIiICYmIHNlZ21lbnRzW2xlbmd0aCAtIDJdID09PSAiIikgewogICAgICAgICAgICBzZWdtZW50cy5wb3AoKTsKICAgICAgICAgIH0KICAgICAgICAgIGxlbmd0aCA9IHNlZ21lbnRzLmxlbmd0aDsKICAgICAgICAgIGlmIChzZWdtZW50c1tsZW5ndGggLSAxXS5pbmRleE9mKCIuIikgIT09IC0xKSB7CiAgICAgICAgICAgIHRvdGFsID0gNzsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwb3M7CiAgICAgICAgICBmb3IgKHBvcyA9IDA7IHBvcyA8IGxlbmd0aDsgcG9zKyspIHsKICAgICAgICAgICAgaWYgKHNlZ21lbnRzW3Bvc10gPT09ICIiKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwb3MgPCB0b3RhbCkgewogICAgICAgICAgICBzZWdtZW50cy5zcGxpY2UocG9zLCAxLCAiMDAwMCIpOwogICAgICAgICAgICB3aGlsZSAoc2VnbWVudHMubGVuZ3RoIDwgdG90YWwpIHsKICAgICAgICAgICAgICBzZWdtZW50cy5zcGxpY2UocG9zLCAwLCAiMDAwMCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgX3NlZ21lbnRzOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b3RhbDsgaSsrKSB7CiAgICAgICAgICAgIF9zZWdtZW50cyA9IHNlZ21lbnRzW2ldLnNwbGl0KCIiKTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCAzOyBqKyspIHsKICAgICAgICAgICAgICBpZiAoX3NlZ21lbnRzWzBdID09PSAiMCIgJiYgX3NlZ21lbnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgIF9zZWdtZW50cy5zcGxpY2UoMCwgMSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzZWdtZW50c1tpXSA9IF9zZWdtZW50cy5qb2luKCIiKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBiZXN0ID0gLTE7CiAgICAgICAgICB2YXIgX2Jlc3QgPSAwOwogICAgICAgICAgdmFyIF9jdXJyZW50ID0gMDsKICAgICAgICAgIHZhciBjdXJyZW50ID0gLTE7CiAgICAgICAgICB2YXIgaW56ZXJvZXMgPSBmYWxzZTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0b3RhbDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChpbnplcm9lcykgewogICAgICAgICAgICAgIGlmIChzZWdtZW50c1tpXSA9PT0gIjAiKSB7CiAgICAgICAgICAgICAgICBfY3VycmVudCArPSAxOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbnplcm9lcyA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKF9jdXJyZW50ID4gX2Jlc3QpIHsKICAgICAgICAgICAgICAgICAgYmVzdCA9IGN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIF9iZXN0ID0gX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChzZWdtZW50c1tpXSA9PT0gIjAiKSB7CiAgICAgICAgICAgICAgICBpbnplcm9lcyA9IHRydWU7CiAgICAgICAgICAgICAgICBjdXJyZW50ID0gaTsKICAgICAgICAgICAgICAgIF9jdXJyZW50ID0gMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChfY3VycmVudCA+IF9iZXN0KSB7CiAgICAgICAgICAgIGJlc3QgPSBjdXJyZW50OwogICAgICAgICAgICBfYmVzdCA9IF9jdXJyZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKF9iZXN0ID4gMSkgewogICAgICAgICAgICBzZWdtZW50cy5zcGxpY2UoYmVzdCwgX2Jlc3QsICIiKTsKICAgICAgICAgIH0KICAgICAgICAgIGxlbmd0aCA9IHNlZ21lbnRzLmxlbmd0aDsKICAgICAgICAgIHZhciByZXN1bHQgPSAiIjsKICAgICAgICAgIGlmIChzZWdtZW50c1swXSA9PT0gIiIpIHsKICAgICAgICAgICAgcmVzdWx0ID0gIjoiOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHJlc3VsdCArPSBzZWdtZW50c1tpXTsKICAgICAgICAgICAgaWYgKGkgPT09IGxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHQgKz0gIjoiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNlZ21lbnRzW2xlbmd0aCAtIDFdID09PSAiIikgewogICAgICAgICAgICByZXN1bHQgKz0gIjoiOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbm9Db25mbGljdCgpIHsKICAgICAgICAgIGlmIChyb290LklQdjYgPT09IHRoaXMpIHsKICAgICAgICAgICAgcm9vdC5JUHY2ID0gX0lQdjY7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGJlc3Q6IGJlc3RQcmVzZW50YXRpb24sCiAgICAgICAgICBub0NvbmZsaWN0CiAgICAgICAgfTsKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy91cmlqcy9zcmMvU2Vjb25kTGV2ZWxEb21haW5zLmpzCiAgdmFyIHJlcXVpcmVfU2Vjb25kTGV2ZWxEb21haW5zID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3VyaWpzL3NyYy9TZWNvbmRMZXZlbERvbWFpbnMuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgLyohCiAgICAgICAqIFVSSS5qcyAtIE11dGF0aW5nIFVSTHMKICAgICAgICogU2Vjb25kIExldmVsIERvbWFpbiAoU0xEKSBTdXBwb3J0CiAgICAgICAqCiAgICAgICAqIFZlcnNpb246IDEuMTkuMTEKICAgICAgICoKICAgICAgICogQXV0aG9yOiBSb2RuZXkgUmVobQogICAgICAgKiBXZWI6IGh0dHA6Ly9tZWRpYWxpemUuZ2l0aHViLmlvL1VSSS5qcy8KICAgICAgICoKICAgICAgICogTGljZW5zZWQgdW5kZXIKICAgICAgICogICBNSVQgTGljZW5zZSBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlCiAgICAgICAqCiAgICAgICAqLwogICAgICAoZnVuY3Rpb24ocm9vdCwgZmFjdG9yeSkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIG1vZHVsZSA9PT0gIm9iamVjdCIgJiYgbW9kdWxlLmV4cG9ydHMpIHsKICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgICBkZWZpbmUoZmFjdG9yeSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJvb3QuU2Vjb25kTGV2ZWxEb21haW5zID0gZmFjdG9yeShyb290KTsKICAgICAgICB9CiAgICAgIH0pKGV4cG9ydHMyLCBmdW5jdGlvbihyb290KSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBfU2Vjb25kTGV2ZWxEb21haW5zID0gcm9vdCAmJiByb290LlNlY29uZExldmVsRG9tYWluczsKICAgICAgICB2YXIgU0xEID0gewogICAgICAgICAgLy8gbGlzdCBvZiBrbm93biBTZWNvbmQgTGV2ZWwgRG9tYWlucwogICAgICAgICAgLy8gY29udmVydGVkIGxpc3Qgb2YgU0xEcyBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9nYXZpbmdtaWxsZXIvc2Vjb25kLWxldmVsLWRvbWFpbnMKICAgICAgICAgIC8vIC0tLS0KICAgICAgICAgIC8vIHB1YmxpY3N1ZmZpeC5vcmcgaXMgbW9yZSBjdXJyZW50IGFuZCBhY3R1YWxseSB1c2VkIGJ5IGEgY291cGxlIG9mIGJyb3dzZXJzIGludGVybmFsbHkuCiAgICAgICAgICAvLyBkb3duc2lkZSBpcyBpdCBhbHNvIGNvbnRhaW5zIGRvbWFpbnMgbGlrZSAiZHluZG5zLm9yZyIgLSB3aGljaCBpcyBmaW5lIGZvciB0aGUgc2VjdXJpdHkKICAgICAgICAgIC8vIGlzc3VlcyBicm93c2VyIGhhdmUgdG8gZGVhbCB3aXRoIChTT1AgZm9yIGNvb2tpZXMsIGV0YykgLSBidXQgaXMgd2F5IG92ZXJib2FyZCBmb3IgVVJJLmpzCiAgICAgICAgICAvLyAtLS0tCiAgICAgICAgICBsaXN0OiB7CiAgICAgICAgICAgICJhYyI6ICIgY29tIGdvdiBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAiYWUiOiAiIGFjIGNvIGdvdiBtaWwgbmFtZSBuZXQgb3JnIHBybyBzY2ggIiwKICAgICAgICAgICAgImFmIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJhbCI6ICIgY29tIGVkdSBnb3YgbWlsIG5ldCBvcmcgIiwKICAgICAgICAgICAgImFvIjogIiBjbyBlZCBndiBpdCBvZyBwYiAiLAogICAgICAgICAgICAiYXIiOiAiIGNvbSBlZHUgZ29iIGdvdiBpbnQgbWlsIG5ldCBvcmcgdHVyICIsCiAgICAgICAgICAgICJhdCI6ICIgYWMgY28gZ3Ygb3IgIiwKICAgICAgICAgICAgImF1IjogIiBhc24gY29tIGNzaXJvIGVkdSBnb3YgaWQgbmV0IG9yZyAiLAogICAgICAgICAgICAiYmEiOiAiIGNvIGNvbSBlZHUgZ292IG1pbCBuZXQgb3JnIHJzIHVuYmkgdW5tbyB1bnNhIHVudHogdW56ZSAiLAogICAgICAgICAgICAiYmIiOiAiIGJpeiBjbyBjb20gZWR1IGdvdiBpbmZvIG5ldCBvcmcgc3RvcmUgdHYgIiwKICAgICAgICAgICAgImJoIjogIiBiaXogY2MgY29tIGVkdSBnb3YgaW5mbyBuZXQgb3JnICIsCiAgICAgICAgICAgICJibiI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAiYm8iOiAiIGNvbSBlZHUgZ29iIGdvdiBpbnQgbWlsIG5ldCBvcmcgdHYgIiwKICAgICAgICAgICAgImJyIjogIiBhZG0gYWR2IGFnciBhbSBhcnEgYXJ0IGF0byBiIGJpbyBibG9nIGJtZCBjaW0gY25nIGNudCBjb20gY29vcCBlY24gZWR1IGVuZyBlc3AgZXRjIGV0aSBmYXIgZmxvZyBmbSBmbmQgZm90IGZzdCBnMTIgZ2dmIGdvdiBpbWIgaW5kIGluZiBqb3IganVzIGxlbCBtYXQgbWVkIG1pbCBtdXMgbmV0IG5vbSBub3QgbnRyIG9kbyBvcmcgcHBnIHBybyBwc2MgcHNpIHFzbCByZWMgc2xnIHNydiB0bXAgdHJkIHR1ciB0diB2ZXQgdmxvZyB3aWtpIHpsZyAiLAogICAgICAgICAgICAiYnMiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImJ6IjogIiBkdSBldCBvbSBvdiByZyAiLAogICAgICAgICAgICAiY2EiOiAiIGFiIGJjIG1iIG5iIG5mIG5sIG5zIG50IG51IG9uIHBlIHFjIHNrIHlrICIsCiAgICAgICAgICAgICJjayI6ICIgYml6IGNvIGVkdSBnZW4gZ292IGluZm8gbmV0IG9yZyAiLAogICAgICAgICAgICAiY24iOiAiIGFjIGFoIGJqIGNvbSBjcSBlZHUgZmogZ2QgZ292IGdzIGd4IGd6IGhhIGhiIGhlIGhpIGhsIGhuIGpsIGpzIGp4IGxuIG1pbCBuZXQgbm0gbnggb3JnIHFoIHNjIHNkIHNoIHNuIHN4IHRqIHR3IHhqIHh6IHluIHpqICIsCiAgICAgICAgICAgICJjbyI6ICIgY29tIGVkdSBnb3YgbWlsIG5ldCBub20gb3JnICIsCiAgICAgICAgICAgICJjciI6ICIgYWMgYyBjbyBlZCBmaSBnbyBvciBzYSAiLAogICAgICAgICAgICAiY3kiOiAiIGFjIGJpeiBjb20gZWtsb2dlcyBnb3YgbHRkIG5hbWUgbmV0IG9yZyBwYXJsaWFtZW50IHByZXNzIHBybyB0bSAiLAogICAgICAgICAgICAiZG8iOiAiIGFydCBjb20gZWR1IGdvYiBnb3YgbWlsIG5ldCBvcmcgc2xkIHdlYiAiLAogICAgICAgICAgICAiZHoiOiAiIGFydCBhc3NvIGNvbSBlZHUgZ292IG5ldCBvcmcgcG9sICIsCiAgICAgICAgICAgICJlYyI6ICIgY29tIGVkdSBmaW4gZ292IGluZm8gbWVkIG1pbCBuZXQgb3JnIHBybyAiLAogICAgICAgICAgICAiZWciOiAiIGNvbSBlZHUgZXVuIGdvdiBtaWwgbmFtZSBuZXQgb3JnIHNjaSAiLAogICAgICAgICAgICAiZXIiOiAiIGNvbSBlZHUgZ292IGluZCBtaWwgbmV0IG9yZyByb2NoZXN0IHcgIiwKICAgICAgICAgICAgImVzIjogIiBjb20gZWR1IGdvYiBub20gb3JnICIsCiAgICAgICAgICAgICJldCI6ICIgYml6IGNvbSBlZHUgZ292IGluZm8gbmFtZSBuZXQgb3JnICIsCiAgICAgICAgICAgICJmaiI6ICIgYWMgYml6IGNvbSBpbmZvIG1pbCBuYW1lIG5ldCBvcmcgcHJvICIsCiAgICAgICAgICAgICJmayI6ICIgYWMgY28gZ292IG5ldCBub20gb3JnICIsCiAgICAgICAgICAgICJmciI6ICIgYXNzbyBjb20gZiBnb3V2IG5vbSBwcmQgcHJlc3NlIHRtICIsCiAgICAgICAgICAgICJnZyI6ICIgY28gbmV0IG9yZyAiLAogICAgICAgICAgICAiZ2giOiAiIGNvbSBlZHUgZ292IG1pbCBvcmcgIiwKICAgICAgICAgICAgImduIjogIiBhYyBjb20gZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImdyIjogIiBjb20gZWR1IGdvdiBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAiZ3QiOiAiIGNvbSBlZHUgZ29iIGluZCBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAiZ3UiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImhrIjogIiBjb20gZWR1IGdvdiBpZHYgbmV0IG9yZyAiLAogICAgICAgICAgICAiaHUiOiAiIDIwMDAgYWdyYXIgYm9sdCBjYXNpbm8gY2l0eSBjbyBlcm90aWNhIGVyb3Rpa2EgZmlsbSBmb3J1bSBnYW1lcyBob3RlbCBpbmZvIGluZ2F0bGFuIGpvZ2FzeiBrb255dmVsbyBsYWthcyBtZWRpYSBuZXdzIG9yZyBwcml2IHJla2xhbSBzZXggc2hvcCBzcG9ydCBzdWxpIHN6ZXggdG0gdG96c2RlIHV0YXphcyB2aWRlbyAiLAogICAgICAgICAgICAiaWQiOiAiIGFjIGNvIGdvIG1pbCBuZXQgb3Igc2NoIHdlYiAiLAogICAgICAgICAgICAiaWwiOiAiIGFjIGNvIGdvdiBpZGYgazEyIG11bmkgbmV0IG9yZyAiLAogICAgICAgICAgICAiaW4iOiAiIGFjIGNvIGVkdSBlcm5ldCBmaXJtIGdlbiBnb3YgaSBpbmQgbWlsIG5ldCBuaWMgb3JnIHJlcyAiLAogICAgICAgICAgICAiaXEiOiAiIGNvbSBlZHUgZ292IGkgbWlsIG5ldCBvcmcgIiwKICAgICAgICAgICAgImlyIjogIiBhYyBjbyBkbnNzZWMgZ292IGkgaWQgbmV0IG9yZyBzY2ggIiwKICAgICAgICAgICAgIml0IjogIiBlZHUgZ292ICIsCiAgICAgICAgICAgICJqZSI6ICIgY28gbmV0IG9yZyAiLAogICAgICAgICAgICAiam8iOiAiIGNvbSBlZHUgZ292IG1pbCBuYW1lIG5ldCBvcmcgc2NoICIsCiAgICAgICAgICAgICJqcCI6ICIgYWMgYWQgY28gZWQgZ28gZ3IgbGcgbmUgb3IgIiwKICAgICAgICAgICAgImtlIjogIiBhYyBjbyBnbyBpbmZvIG1lIG1vYmkgbmUgb3Igc2MgIiwKICAgICAgICAgICAgImtoIjogIiBjb20gZWR1IGdvdiBtaWwgbmV0IG9yZyBwZXIgIiwKICAgICAgICAgICAgImtpIjogIiBiaXogY29tIGRlIGVkdSBnb3YgaW5mbyBtb2IgbmV0IG9yZyB0ZWwgIiwKICAgICAgICAgICAgImttIjogIiBhc3NvIGNvbSBjb29wIGVkdSBnb3V2IGsgbWVkZWNpbiBtaWwgbm9tIG5vdGFpcmVzIHBoYXJtYWNpZW5zIHByZXNzZSB0bSB2ZXRlcmluYWlyZSAiLAogICAgICAgICAgICAia24iOiAiIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAia3IiOiAiIGFjIGJ1c2FuIGNodW5nYnVrIGNodW5nbmFtIGNvIGRhZWd1IGRhZWplb24gZXMgZ2FuZ3dvbiBnbyBnd2FuZ2p1IGd5ZW9uZ2J1ayBneWVvbmdnaSBneWVvbmduYW0gaHMgaW5jaGVvbiBqZWp1IGplb25idWsgamVvbm5hbSBrIGtnIG1pbCBtcyBuZSBvciBwZSByZSBzYyBzZW91bCB1bHNhbiAiLAogICAgICAgICAgICAia3ciOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImt5IjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJreiI6ICIgY29tIGVkdSBnb3YgbWlsIG5ldCBvcmcgIiwKICAgICAgICAgICAgImxiIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJsayI6ICIgYXNzbiBjb20gZWR1IGdvdiBncnAgaG90ZWwgaW50IGx0ZCBuZXQgbmdvIG9yZyBzY2ggc29jIHdlYiAiLAogICAgICAgICAgICAibHIiOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgImx2IjogIiBhc24gY29tIGNvbmYgZWR1IGdvdiBpZCBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAibHkiOiAiIGNvbSBlZHUgZ292IGlkIG1lZCBuZXQgb3JnIHBsYyBzY2ggIiwKICAgICAgICAgICAgIm1hIjogIiBhYyBjbyBnb3YgbSBuZXQgb3JnIHByZXNzICIsCiAgICAgICAgICAgICJtYyI6ICIgYXNzbyB0bSAiLAogICAgICAgICAgICAibWUiOiAiIGFjIGNvIGVkdSBnb3YgaXRzIG5ldCBvcmcgcHJpdiAiLAogICAgICAgICAgICAibWciOiAiIGNvbSBlZHUgZ292IG1pbCBub20gb3JnIHByZCB0bSAiLAogICAgICAgICAgICAibWsiOiAiIGNvbSBlZHUgZ292IGluZiBuYW1lIG5ldCBvcmcgcHJvICIsCiAgICAgICAgICAgICJtbCI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyBwcmVzc2UgIiwKICAgICAgICAgICAgIm1uIjogIiBlZHUgZ292IG9yZyAiLAogICAgICAgICAgICAibW8iOiAiIGNvbSBlZHUgZ292IG5ldCBvcmcgIiwKICAgICAgICAgICAgIm10IjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJtdiI6ICIgYWVybyBiaXogY29tIGNvb3AgZWR1IGdvdiBpbmZvIGludCBtaWwgbXVzZXVtIG5hbWUgbmV0IG9yZyBwcm8gIiwKICAgICAgICAgICAgIm13IjogIiBhYyBjbyBjb20gY29vcCBlZHUgZ292IGludCBtdXNldW0gbmV0IG9yZyAiLAogICAgICAgICAgICAibXgiOiAiIGNvbSBlZHUgZ29iIG5ldCBvcmcgIiwKICAgICAgICAgICAgIm15IjogIiBjb20gZWR1IGdvdiBtaWwgbmFtZSBuZXQgb3JnIHNjaCAiLAogICAgICAgICAgICAibmYiOiAiIGFydHMgY29tIGZpcm0gaW5mbyBuZXQgb3RoZXIgcGVyIHJlYyBzdG9yZSB3ZWIgIiwKICAgICAgICAgICAgIm5nIjogIiBiaXogY29tIGVkdSBnb3YgbWlsIG1vYmkgbmFtZSBuZXQgb3JnIHNjaCAiLAogICAgICAgICAgICAibmkiOiAiIGFjIGNvIGNvbSBlZHUgZ29iIG1pbCBuZXQgbm9tIG9yZyAiLAogICAgICAgICAgICAibnAiOiAiIGNvbSBlZHUgZ292IG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJuciI6ICIgYml6IGNvbSBlZHUgZ292IGluZm8gbmV0IG9yZyAiLAogICAgICAgICAgICAib20iOiAiIGFjIGJpeiBjbyBjb20gZWR1IGdvdiBtZWQgbWlsIG11c2V1bSBuZXQgb3JnIHBybyBzY2ggIiwKICAgICAgICAgICAgInBlIjogIiBjb20gZWR1IGdvYiBtaWwgbmV0IG5vbSBvcmcgc2xkICIsCiAgICAgICAgICAgICJwaCI6ICIgY29tIGVkdSBnb3YgaSBtaWwgbmV0IG5nbyBvcmcgIiwKICAgICAgICAgICAgInBrIjogIiBiaXogY29tIGVkdSBmYW0gZ29iIGdvayBnb24gZ29wIGdvcyBnb3YgbmV0IG9yZyB3ZWIgIiwKICAgICAgICAgICAgInBsIjogIiBhcnQgYmlhbHlzdG9rIGJpeiBjb20gZWR1IGdkYSBnZGFuc2sgZ29yem93IGdvdiBpbmZvIGthdG93aWNlIGtyYWtvdyBsb2R6IGx1YmxpbiBtaWwgbmV0IG5nbyBvbHN6dHluIG9yZyBwb3puYW4gcHdyIHJhZG9tIHNsdXBzayBzemN6ZWNpbiB0b3J1biB3YXJzemF3YSB3YXcgd3JvYyB3cm9jbGF3IHpnb3JhICIsCiAgICAgICAgICAgICJwciI6ICIgYWMgYml6IGNvbSBlZHUgZXN0IGdvdiBpbmZvIGlzbGEgbmFtZSBuZXQgb3JnIHBybyBwcm9mICIsCiAgICAgICAgICAgICJwcyI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyBwbG8gc2VjICIsCiAgICAgICAgICAgICJwdyI6ICIgYmVsYXUgY28gZWQgZ28gbmUgb3IgIiwKICAgICAgICAgICAgInJvIjogIiBhcnRzIGNvbSBmaXJtIGluZm8gbm9tIG50IG9yZyByZWMgc3RvcmUgdG0gd3d3ICIsCiAgICAgICAgICAgICJycyI6ICIgYWMgY28gZWR1IGdvdiBpbiBvcmcgIiwKICAgICAgICAgICAgInNiIjogIiBjb20gZWR1IGdvdiBuZXQgb3JnICIsCiAgICAgICAgICAgICJzYyI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAic2giOiAiIGNvIGNvbSBlZHUgZ292IG5ldCBub20gb3JnICIsCiAgICAgICAgICAgICJzbCI6ICIgY29tIGVkdSBnb3YgbmV0IG9yZyAiLAogICAgICAgICAgICAic3QiOiAiIGNvIGNvbSBjb25zdWxhZG8gZWR1IGVtYmFpeGFkYSBnb3YgbWlsIG5ldCBvcmcgcHJpbmNpcGUgc2FvdG9tZSBzdG9yZSAiLAogICAgICAgICAgICAic3YiOiAiIGNvbSBlZHUgZ29iIG9yZyByZWQgIiwKICAgICAgICAgICAgInN6IjogIiBhYyBjbyBvcmcgIiwKICAgICAgICAgICAgInRyIjogIiBhdiBiYnMgYmVsIGJpeiBjb20gZHIgZWR1IGdlbiBnb3YgaW5mbyBrMTIgbmFtZSBuZXQgb3JnIHBvbCB0ZWwgdHNrIHR2IHdlYiAiLAogICAgICAgICAgICAidHQiOiAiIGFlcm8gYml6IGNhdCBjbyBjb20gY29vcCBlZHUgZ292IGluZm8gaW50IGpvYnMgbWlsIG1vYmkgbXVzZXVtIG5hbWUgbmV0IG9yZyBwcm8gdGVsIHRyYXZlbCAiLAogICAgICAgICAgICAidHciOiAiIGNsdWIgY29tIGViaXogZWR1IGdhbWUgZ292IGlkdiBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAibXUiOiAiIGFjIGNvIGNvbSBnb3YgbmV0IG9yIG9yZyAiLAogICAgICAgICAgICAibXoiOiAiIGFjIGNvIGVkdSBnb3Ygb3JnICIsCiAgICAgICAgICAgICJuYSI6ICIgY28gY29tICIsCiAgICAgICAgICAgICJueiI6ICIgYWMgY28gY3JpIGdlZWsgZ2VuIGdvdnQgaGVhbHRoIGl3aSBtYW9yaSBtaWwgbmV0IG9yZyBwYXJsaWFtZW50IHNjaG9vbCAiLAogICAgICAgICAgICAicGEiOiAiIGFibyBhYyBjb20gZWR1IGdvYiBpbmcgbWVkIG5ldCBub20gb3JnIHNsZCAiLAogICAgICAgICAgICAicHQiOiAiIGNvbSBlZHUgZ292IGludCBuZXQgbm9tZSBvcmcgcHVibCAiLAogICAgICAgICAgICAicHkiOiAiIGNvbSBlZHUgZ292IG1pbCBuZXQgb3JnICIsCiAgICAgICAgICAgICJxYSI6ICIgY29tIGVkdSBnb3YgbWlsIG5ldCBvcmcgIiwKICAgICAgICAgICAgInJlIjogIiBhc3NvIGNvbSBub20gIiwKICAgICAgICAgICAgInJ1IjogIiBhYyBhZHlnZXlhIGFsdGFpIGFtdXIgYXJraGFuZ2Vsc2sgYXN0cmFraGFuIGJhc2hraXJpYSBiZWxnb3JvZCBiaXIgYnJ5YW5zayBidXJ5YXRpYSBjYmcgY2hlbCBjaGVseWFiaW5zayBjaGl0YSBjaHVrb3RrYSBjaHV2YXNoaWEgY29tIGRhZ2VzdGFuIGUtYnVyZyBlZHUgZ292IGdyb3pueSBpbnQgaXJrdXRzayBpdmFub3ZvIGl6aGV2c2sgamFyIGpvc2hrYXItb2xhIGthbG15a2lhIGthbHVnYSBrYW1jaGF0a2Ega2FyZWxpYSBrYXphbiBrY2hyIGtlbWVyb3ZvIGtoYWJhcm92c2sga2hha2Fzc2lhIGtodiBraXJvdiBrb2VuaWcga29taSBrb3N0cm9tYSBrcmFub3lhcnNrIGt1YmFuIGt1cmdhbiBrdXJzayBsaXBldHNrIG1hZ2FkYW4gbWFyaSBtYXJpLWVsIG1hcmluZSBtaWwgbW9yZG92aWEgbW9zcmVnIG1zayBtdXJtYW5zayBuYWxjaGlrIG5ldCBubm92IG5vdiBub3Zvc2liaXJzayBuc2sgb21zayBvcmVuYnVyZyBvcmcgb3J5b2wgcGVuemEgcGVybSBwcCBwc2tvdiBwdHogcm5kIHJ5YXphbiBzYWtoYWxpbiBzYW1hcmEgc2FyYXRvdiBzaW1iaXJzayBzbW9sZW5zayBzcGIgc3RhdnJvcG9sIHN0diBzdXJndXQgdGFtYm92IHRhdGFyc3RhbiB0b20gdG9tc2sgdHNhcml0c3luIHRzayB0dWxhIHR1dmEgdHZlciB0eXVtZW4gdWRtIHVkbXVydGlhIHVsYW4tdWRlIHZsYWRpa2F2a2F6IHZsYWRpbWlyIHZsYWRpdm9zdG9rIHZvbGdvZ3JhZCB2b2xvZ2RhIHZvcm9uZXpoIHZybiB2eWF0a2EgeWFrdXRpYSB5YW1hbCB5ZWthdGVyaW5idXJnIHl1emhuby1zYWtoYWxpbnNrICIsCiAgICAgICAgICAgICJydyI6ICIgYWMgY28gY29tIGVkdSBnb3V2IGdvdiBpbnQgbWlsIG5ldCAiLAogICAgICAgICAgICAic2EiOiAiIGNvbSBlZHUgZ292IG1lZCBuZXQgb3JnIHB1YiBzY2ggIiwKICAgICAgICAgICAgInNkIjogIiBjb20gZWR1IGdvdiBpbmZvIG1lZCBuZXQgb3JnIHR2ICIsCiAgICAgICAgICAgICJzZSI6ICIgYSBhYyBiIGJkIGMgZCBlIGYgZyBoIGkgayBsIG0gbiBvIG9yZyBwIHBhcnRpIHBwIHByZXNzIHIgcyB0IHRtIHUgdyB4IHkgeiAiLAogICAgICAgICAgICAic2ciOiAiIGNvbSBlZHUgZ292IGlkbiBuZXQgb3JnIHBlciAiLAogICAgICAgICAgICAic24iOiAiIGFydCBjb20gZWR1IGdvdXYgb3JnIHBlcnNvIHVuaXYgIiwKICAgICAgICAgICAgInN5IjogIiBjb20gZWR1IGdvdiBtaWwgbmV0IG5ld3Mgb3JnICIsCiAgICAgICAgICAgICJ0aCI6ICIgYWMgY28gZ28gaW4gbWkgbmV0IG9yICIsCiAgICAgICAgICAgICJ0aiI6ICIgYWMgYml6IGNvIGNvbSBlZHUgZ28gZ292IGluZm8gaW50IG1pbCBuYW1lIG5ldCBuaWMgb3JnIHRlc3Qgd2ViICIsCiAgICAgICAgICAgICJ0biI6ICIgYWdyaW5ldCBjb20gZGVmZW5zZSBlZHVuZXQgZW5zIGZpbiBnb3YgaW5kIGluZm8gaW50bCBtaW5jb20gbmF0IG5ldCBvcmcgcGVyc28gcm5ydCBybnMgcm51IHRvdXJpc20gIiwKICAgICAgICAgICAgInR6IjogIiBhYyBjbyBnbyBuZSBvciAiLAogICAgICAgICAgICAidWEiOiAiIGJpeiBjaGVya2Fzc3kgY2hlcm5pZ292IGNoZXJub3Z0c3kgY2sgY24gY28gY29tIGNyaW1lYSBjdiBkbiBkbmVwcm9wZXRyb3ZzayBkb25ldHNrIGRwIGVkdSBnb3YgaWYgaW4gaXZhbm8tZnJhbmtpdnNrIGtoIGtoYXJrb3Yga2hlcnNvbiBraG1lbG5pdHNraXkga2lldiBraXJvdm9ncmFkIGttIGtyIGtzIGt2IGxnIGx1Z2Fuc2sgbHV0c2sgbHZpdiBtZSBtayBuZXQgbmlrb2xhZXYgb2Qgb2Rlc3NhIG9yZyBwbCBwb2x0YXZhIHBwIHJvdm5vIHJ2IHNlYmFzdG9wb2wgc3VteSB0ZSB0ZXJub3BpbCB1emhnb3JvZCB2aW5uaWNhIHZuIHphcG9yaXpoemhlIHpoaXRvbWlyIHpwIHp0ICIsCiAgICAgICAgICAgICJ1ZyI6ICIgYWMgY28gZ28gbmUgb3Igb3JnIHNjICIsCiAgICAgICAgICAgICJ1ayI6ICIgYWMgYmwgYnJpdGlzaC1saWJyYXJ5IGNvIGN5bSBnb3YgZ292dCBpY25ldCBqZXQgbGVhIGx0ZCBtZSBtaWwgbW9kIG5hdGlvbmFsLWxpYnJhcnktc2NvdGxhbmQgbmVsIG5ldCBuaHMgbmljIG5scyBvcmcgb3JnbiBwYXJsaWFtZW50IHBsYyBwb2xpY2Ugc2NoIHNjb3Qgc29jICIsCiAgICAgICAgICAgICJ1cyI6ICIgZG5pIGZlZCBpc2Ega2lkcyBuc24gIiwKICAgICAgICAgICAgInV5IjogIiBjb20gZWR1IGd1YiBtaWwgbmV0IG9yZyAiLAogICAgICAgICAgICAidmUiOiAiIGNvIGNvbSBlZHUgZ29iIGluZm8gbWlsIG5ldCBvcmcgd2ViICIsCiAgICAgICAgICAgICJ2aSI6ICIgY28gY29tIGsxMiBuZXQgb3JnICIsCiAgICAgICAgICAgICJ2biI6ICIgYWMgYml6IGNvbSBlZHUgZ292IGhlYWx0aCBpbmZvIGludCBuYW1lIG5ldCBvcmcgcHJvICIsCiAgICAgICAgICAgICJ5ZSI6ICIgY28gY29tIGdvdiBsdGQgbWUgbmV0IG9yZyBwbGMgIiwKICAgICAgICAgICAgInl1IjogIiBhYyBjbyBlZHUgZ292IG9yZyAiLAogICAgICAgICAgICAiemEiOiAiIGFjIGFncmljIGFsdCBib3Vyc2UgY2l0eSBjbyBjeWJlcm5ldCBkYiBlZHUgZ292IGdyb25kYXIgaWFjY2VzcyBpbXQgaW5jYSBsYW5kZXNpZ24gbGF3IG1pbCBuZXQgbmdvIG5pcyBub20gb2xpdmV0dGkgb3JnIHBpeCBzY2hvb2wgdG0gd2ViICIsCiAgICAgICAgICAgICJ6bSI6ICIgYWMgY28gY29tIGVkdSBnb3YgbmV0IG9yZyBzY2ggIiwKICAgICAgICAgICAgLy8gaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ2VudHJhbE5pYyNTZWNvbmQtbGV2ZWxfZG9tYWlucwogICAgICAgICAgICAiY29tIjogImFyIGJyIGNuIGRlIGV1IGdiIGdyIGh1IGpwbiBrciBubyBxYyBydSBzYSBzZSB1ayB1cyB1eSB6YSAiLAogICAgICAgICAgICAibmV0IjogImdiIGpwIHNlIHVrICIsCiAgICAgICAgICAgICJvcmciOiAiYWUiLAogICAgICAgICAgICAiZGUiOiAiY29tICIKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBnb3JoaWxsIDIwMTMtMTAtMjU6IFVzaW5nIGluZGV4T2YoKSBpbnN0ZWFkIFJlZ2V4cCgpLiBTaWduaWZpY2FudCBib29zdAogICAgICAgICAgLy8gaW4gYm90aCBwZXJmb3JtYW5jZSBhbmQgbWVtb3J5IGZvb3RwcmludC4gTm8gaW5pdGlhbGl6YXRpb24gcmVxdWlyZWQuCiAgICAgICAgICAvLyBodHRwOi8vanNwZXJmLmNvbS91cmktanMtc2xkLXJlZ2V4LXZzLWJpbmFyeS1zZWFyY2gvNAogICAgICAgICAgLy8gRm9sbG93aW5nIG1ldGhvZHMgdXNlIGxhc3RJbmRleE9mKCkgcmF0aGVyIHRoYW4gYXJyYXkuc3BsaXQoKSBpbiBvcmRlcgogICAgICAgICAgLy8gdG8gYXZvaWQgYW55IG1lbW9yeSBhbGxvY2F0aW9ucy4KICAgICAgICAgIGhhczogZnVuY3Rpb24oZG9tYWluKSB7CiAgICAgICAgICAgIHZhciB0bGRPZmZzZXQgPSBkb21haW4ubGFzdEluZGV4T2YoIi4iKTsKICAgICAgICAgICAgaWYgKHRsZE9mZnNldCA8PSAwIHx8IHRsZE9mZnNldCA+PSBkb21haW4ubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2xkT2Zmc2V0ID0gZG9tYWluLmxhc3RJbmRleE9mKCIuIiwgdGxkT2Zmc2V0IC0gMSk7CiAgICAgICAgICAgIGlmIChzbGRPZmZzZXQgPD0gMCB8fCBzbGRPZmZzZXQgPj0gdGxkT2Zmc2V0IC0gMSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2xkTGlzdCA9IFNMRC5saXN0W2RvbWFpbi5zbGljZSh0bGRPZmZzZXQgKyAxKV07CiAgICAgICAgICAgIGlmICghc2xkTGlzdCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2xkTGlzdC5pbmRleE9mKCIgIiArIGRvbWFpbi5zbGljZShzbGRPZmZzZXQgKyAxLCB0bGRPZmZzZXQpICsgIiAiKSA+PSAwOwogICAgICAgICAgfSwKICAgICAgICAgIGlzOiBmdW5jdGlvbihkb21haW4pIHsKICAgICAgICAgICAgdmFyIHRsZE9mZnNldCA9IGRvbWFpbi5sYXN0SW5kZXhPZigiLiIpOwogICAgICAgICAgICBpZiAodGxkT2Zmc2V0IDw9IDAgfHwgdGxkT2Zmc2V0ID49IGRvbWFpbi5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzbGRPZmZzZXQgPSBkb21haW4ubGFzdEluZGV4T2YoIi4iLCB0bGRPZmZzZXQgLSAxKTsKICAgICAgICAgICAgaWYgKHNsZE9mZnNldCA+PSAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzbGRMaXN0ID0gU0xELmxpc3RbZG9tYWluLnNsaWNlKHRsZE9mZnNldCArIDEpXTsKICAgICAgICAgICAgaWYgKCFzbGRMaXN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzbGRMaXN0LmluZGV4T2YoIiAiICsgZG9tYWluLnNsaWNlKDAsIHRsZE9mZnNldCkgKyAiICIpID49IDA7CiAgICAgICAgICB9LAogICAgICAgICAgZ2V0OiBmdW5jdGlvbihkb21haW4pIHsKICAgICAgICAgICAgdmFyIHRsZE9mZnNldCA9IGRvbWFpbi5sYXN0SW5kZXhPZigiLiIpOwogICAgICAgICAgICBpZiAodGxkT2Zmc2V0IDw9IDAgfHwgdGxkT2Zmc2V0ID49IGRvbWFpbi5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNsZE9mZnNldCA9IGRvbWFpbi5sYXN0SW5kZXhPZigiLiIsIHRsZE9mZnNldCAtIDEpOwogICAgICAgICAgICBpZiAoc2xkT2Zmc2V0IDw9IDAgfHwgc2xkT2Zmc2V0ID49IHRsZE9mZnNldCAtIDEpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2xkTGlzdCA9IFNMRC5saXN0W2RvbWFpbi5zbGljZSh0bGRPZmZzZXQgKyAxKV07CiAgICAgICAgICAgIGlmICghc2xkTGlzdCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzbGRMaXN0LmluZGV4T2YoIiAiICsgZG9tYWluLnNsaWNlKHNsZE9mZnNldCArIDEsIHRsZE9mZnNldCkgKyAiICIpIDwgMCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkb21haW4uc2xpY2Uoc2xkT2Zmc2V0ICsgMSk7CiAgICAgICAgICB9LAogICAgICAgICAgbm9Db25mbGljdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChyb290LlNlY29uZExldmVsRG9tYWlucyA9PT0gdGhpcykgewogICAgICAgICAgICAgIHJvb3QuU2Vjb25kTGV2ZWxEb21haW5zID0gX1NlY29uZExldmVsRG9tYWluczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJldHVybiBTTEQ7CiAgICAgIH0pOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvdXJpanMvc3JjL1VSSS5qcwogIHZhciByZXF1aXJlX1VSSSA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy91cmlqcy9zcmMvVVJJLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgIC8qIQogICAgICAgKiBVUkkuanMgLSBNdXRhdGluZyBVUkxzCiAgICAgICAqCiAgICAgICAqIFZlcnNpb246IDEuMTkuMTEKICAgICAgICoKICAgICAgICogQXV0aG9yOiBSb2RuZXkgUmVobQogICAgICAgKiBXZWI6IGh0dHA6Ly9tZWRpYWxpemUuZ2l0aHViLmlvL1VSSS5qcy8KICAgICAgICoKICAgICAgICogTGljZW5zZWQgdW5kZXIKICAgICAgICogICBNSVQgTGljZW5zZSBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlCiAgICAgICAqCiAgICAgICAqLwogICAgICAoZnVuY3Rpb24ocm9vdCwgZmFjdG9yeSkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIG1vZHVsZSA9PT0gIm9iamVjdCIgJiYgbW9kdWxlLmV4cG9ydHMpIHsKICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyZXF1aXJlX3B1bnljb2RlKCksIHJlcXVpcmVfSVB2NigpLCByZXF1aXJlX1NlY29uZExldmVsRG9tYWlucygpKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgICAgZGVmaW5lKFsiLi9wdW55Y29kZSIsICIuL0lQdjYiLCAiLi9TZWNvbmRMZXZlbERvbWFpbnMiXSwgZmFjdG9yeSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJvb3QuVVJJID0gZmFjdG9yeShyb290LnB1bnljb2RlLCByb290LklQdjYsIHJvb3QuU2Vjb25kTGV2ZWxEb21haW5zLCByb290KTsKICAgICAgICB9CiAgICAgIH0pKGV4cG9ydHMyLCBmdW5jdGlvbihwdW55Y29kZSwgSVB2NiwgU0xELCByb290KSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBfVVJJID0gcm9vdCAmJiByb290LlVSSTsKICAgICAgICBmdW5jdGlvbiBVUkkodXJsLCBiYXNlKSB7CiAgICAgICAgICB2YXIgX3VybFN1cHBsaWVkID0gYXJndW1lbnRzLmxlbmd0aCA+PSAxOwogICAgICAgICAgdmFyIF9iYXNlU3VwcGxpZWQgPSBhcmd1bWVudHMubGVuZ3RoID49IDI7CiAgICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgVVJJKSkgewogICAgICAgICAgICBpZiAoX3VybFN1cHBsaWVkKSB7CiAgICAgICAgICAgICAgaWYgKF9iYXNlU3VwcGxpZWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVVJJKHVybCwgYmFzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBuZXcgVVJJKHVybCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBVUkkoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh1cmwgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAoX3VybFN1cHBsaWVkKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigidW5kZWZpbmVkIGlzIG5vdCBhIHZhbGlkIGFyZ3VtZW50IGZvciBVUkkiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGxvY2F0aW9uICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIHVybCA9IGxvY2F0aW9uLmhyZWYgKyAiIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cmwgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHVybCA9PT0gbnVsbCkgewogICAgICAgICAgICBpZiAoX3VybFN1cHBsaWVkKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigibnVsbCBpcyBub3QgYSB2YWxpZCBhcmd1bWVudCBmb3IgVVJJIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuaHJlZih1cmwpOwogICAgICAgICAgaWYgKGJhc2UgIT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5hYnNvbHV0ZVRvKGJhc2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSW50ZWdlcih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuIC9eWzAtOV0rJC8udGVzdCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIFVSSS52ZXJzaW9uID0gIjEuMTkuMTEiOwogICAgICAgIHZhciBwID0gVVJJLnByb3RvdHlwZTsKICAgICAgICB2YXIgaGFzT3duID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgICAgICBmdW5jdGlvbiBlc2NhcGVSZWdFeChzdHJpbmcpIHsKICAgICAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZSgvKFsuKis/Xj0hOiR7fSgpfFtcXVwvXFxdKS9nLCAiXFwkMSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUeXBlKHZhbHVlKSB7CiAgICAgICAgICBpZiAodmFsdWUgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gIlVuZGVmaW5lZCI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gU3RyaW5nKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkpLnNsaWNlKDgsIC0xKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBcnJheShvYmopIHsKICAgICAgICAgIHJldHVybiBnZXRUeXBlKG9iaikgPT09ICJBcnJheSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbHRlckFycmF5VmFsdWVzKGRhdGEsIHZhbHVlKSB7CiAgICAgICAgICB2YXIgbG9va3VwID0ge307CiAgICAgICAgICB2YXIgaSwgbGVuZ3RoOwogICAgICAgICAgaWYgKGdldFR5cGUodmFsdWUpID09PSAiUmVnRXhwIikgewogICAgICAgICAgICBsb29rdXAgPSBudWxsOwogICAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSB2YWx1ZS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGxvb2t1cFt2YWx1ZVtpXV0gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsb29rdXBbdmFsdWVdID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IGRhdGEubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIF9tYXRjaCA9IGxvb2t1cCAmJiBsb29rdXBbZGF0YVtpXV0gIT09IHZvaWQgMCB8fCAhbG9va3VwICYmIHZhbHVlLnRlc3QoZGF0YVtpXSk7CiAgICAgICAgICAgIGlmIChfbWF0Y2gpIHsKICAgICAgICAgICAgICBkYXRhLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcnJheUNvbnRhaW5zKGxpc3QsIHZhbHVlKSB7CiAgICAgICAgICB2YXIgaSwgbGVuZ3RoOwogICAgICAgICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IHZhbHVlLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKCFhcnJheUNvbnRhaW5zKGxpc3QsIHZhbHVlW2ldKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBfdHlwZSA9IGdldFR5cGUodmFsdWUpOwogICAgICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0gbGlzdC5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoX3R5cGUgPT09ICJSZWdFeHAiKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBsaXN0W2ldID09PSAic3RyaW5nIiAmJiBsaXN0W2ldLm1hdGNoKHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGxpc3RbaV0gPT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXJyYXlzRXF1YWwob25lLCB0d28pIHsKICAgICAgICAgIGlmICghaXNBcnJheShvbmUpIHx8ICFpc0FycmF5KHR3bykpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG9uZS5sZW5ndGggIT09IHR3by5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgb25lLnNvcnQoKTsKICAgICAgICAgIHR3by5zb3J0KCk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG9uZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgaWYgKG9uZVtpXSAhPT0gdHdvW2ldKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJpbVNsYXNoZXModGV4dCkgewogICAgICAgICAgdmFyIHRyaW1fZXhwcmVzc2lvbiA9IC9eXC8rfFwvKyQvZzsKICAgICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UodHJpbV9leHByZXNzaW9uLCAiIik7CiAgICAgICAgfQogICAgICAgIFVSSS5fcGFydHMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHByb3RvY29sOiBudWxsLAogICAgICAgICAgICB1c2VybmFtZTogbnVsbCwKICAgICAgICAgICAgcGFzc3dvcmQ6IG51bGwsCiAgICAgICAgICAgIGhvc3RuYW1lOiBudWxsLAogICAgICAgICAgICB1cm46IG51bGwsCiAgICAgICAgICAgIHBvcnQ6IG51bGwsCiAgICAgICAgICAgIHBhdGg6IG51bGwsCiAgICAgICAgICAgIHF1ZXJ5OiBudWxsLAogICAgICAgICAgICBmcmFnbWVudDogbnVsbCwKICAgICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICAgcHJldmVudEludmFsaWRIb3N0bmFtZTogVVJJLnByZXZlbnRJbnZhbGlkSG9zdG5hbWUsCiAgICAgICAgICAgIGR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVyczogVVJJLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycywKICAgICAgICAgICAgZXNjYXBlUXVlcnlTcGFjZTogVVJJLmVzY2FwZVF1ZXJ5U3BhY2UKICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBVUkkucHJldmVudEludmFsaWRIb3N0bmFtZSA9IGZhbHNlOwogICAgICAgIFVSSS5kdXBsaWNhdGVRdWVyeVBhcmFtZXRlcnMgPSBmYWxzZTsKICAgICAgICBVUkkuZXNjYXBlUXVlcnlTcGFjZSA9IHRydWU7CiAgICAgICAgVVJJLnByb3RvY29sX2V4cHJlc3Npb24gPSAvXlthLXpdW2EtejAtOS4rLV0qJC9pOwogICAgICAgIFVSSS5pZG5fZXhwcmVzc2lvbiA9IC9bXmEtejAtOVwuXy1dL2k7CiAgICAgICAgVVJJLnB1bnljb2RlX2V4cHJlc3Npb24gPSAvKHhuLS0pL2k7CiAgICAgICAgVVJJLmlwNF9leHByZXNzaW9uID0gL15cZHsxLDN9XC5cZHsxLDN9XC5cZHsxLDN9XC5cZHsxLDN9JC87CiAgICAgICAgVVJJLmlwNl9leHByZXNzaW9uID0gL15ccyooKChbMC05QS1GYS1mXXsxLDR9Oil7N30oWzAtOUEtRmEtZl17MSw0fXw6KSl8KChbMC05QS1GYS1mXXsxLDR9Oil7Nn0oOlswLTlBLUZhLWZdezEsNH18KCgyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKShcLigyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKSl7M30pfDopKXwoKFswLTlBLUZhLWZdezEsNH06KXs1fSgoKDpbMC05QS1GYS1mXXsxLDR9KXsxLDJ9KXw6KCgyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKShcLigyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKSl7M30pfDopKXwoKFswLTlBLUZhLWZdezEsNH06KXs0fSgoKDpbMC05QS1GYS1mXXsxLDR9KXsxLDN9KXwoKDpbMC05QS1GYS1mXXsxLDR9KT86KCgyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKShcLigyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKSl7M30pKXw6KSl8KChbMC05QS1GYS1mXXsxLDR9Oil7M30oKCg6WzAtOUEtRmEtZl17MSw0fSl7MSw0fSl8KCg6WzAtOUEtRmEtZl17MSw0fSl7MCwyfTooKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKFwuKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKXszfSkpfDopKXwoKFswLTlBLUZhLWZdezEsNH06KXsyfSgoKDpbMC05QS1GYS1mXXsxLDR9KXsxLDV9KXwoKDpbMC05QS1GYS1mXXsxLDR9KXswLDN9OigoMjVbMC01XXwyWzAtNF1cZHwxXGRcZHxbMS05XT9cZCkoXC4oMjVbMC01XXwyWzAtNF1cZHwxXGRcZHxbMS05XT9cZCkpezN9KSl8OikpfCgoWzAtOUEtRmEtZl17MSw0fTopezF9KCgoOlswLTlBLUZhLWZdezEsNH0pezEsNn0pfCgoOlswLTlBLUZhLWZdezEsNH0pezAsNH06KCgyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKShcLigyNVswLTVdfDJbMC00XVxkfDFcZFxkfFsxLTldP1xkKSl7M30pKXw6KSl8KDooKCg6WzAtOUEtRmEtZl17MSw0fSl7MSw3fSl8KCg6WzAtOUEtRmEtZl17MSw0fSl7MCw1fTooKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKFwuKDI1WzAtNV18MlswLTRdXGR8MVxkXGR8WzEtOV0/XGQpKXszfSkpfDopKSkoJS4rKT9ccyokLzsKICAgICAgICBVUkkuZmluZF91cmlfZXhwcmVzc2lvbiA9IC9cYigoPzpbYS16XVtcdy1dKzooPzpcL3sxLDN9fFthLXowLTklXSl8d3d3XGR7MCwzfVsuXXxbYS16MC05LlwtXStbLl1bYS16XXsyLDR9XC8pKD86W15ccygpPD5dK3xcKChbXlxzKCk8Pl0rfChcKFteXHMoKTw+XStcKSkpKlwpKSsoPzpcKChbXlxzKCk8Pl0rfChcKFteXHMoKTw+XStcKSkpKlwpfFteXHNgISgpXFtcXXt9OzonIi4sPD4/wqvCu+KAnOKAneKAmOKAmV0pKS9pZzsKICAgICAgICBVUkkuZmluZFVyaSA9IHsKICAgICAgICAgIC8vIHZhbGlkICJzY2hlbWU6Ly8iIG9yICJ3d3cuIgogICAgICAgICAgc3RhcnQ6IC9cYig/OihbYS16XVthLXowLTkuKy1dKjpcL1wvKXx3d3dcLikvZ2ksCiAgICAgICAgICAvLyBldmVyeXRoaW5nIHVwIHRvIHRoZSBuZXh0IHdoaXRlc3BhY2UKICAgICAgICAgIGVuZDogL1tcc1xyXG5dfCQvLAogICAgICAgICAgLy8gdHJpbSB0cmFpbGluZyBwdW5jdHVhdGlvbiBjYXB0dXJlZCBieSBlbmQgUmVnRXhwCiAgICAgICAgICB0cmltOiAvW2AhKClcW1xde307OiciLiw8Pj/Cq8K74oCc4oCd4oCe4oCY4oCZXSskLywKICAgICAgICAgIC8vIGJhbGFuY2VkIHBhcmVucyBpbmNsdXNpb24gKCksIFtdLCB7fSwgPD4KICAgICAgICAgIHBhcmVuczogLyhcKFteXCldKlwpfFxbW15cXV0qXF18XHtbXn1dKlx9fDxbXj5dKj4pL2cKICAgICAgICB9OwogICAgICAgIFVSSS5sZWFkaW5nX3doaXRlc3BhY2VfZXhwcmVzc2lvbiA9IC9eW1x4MDAtXHgyMFx1MDBhMFx1MTY4MFx1MjAwMC1cdTIwMGFcdTIwMjhcdTIwMjlcdTIwMmZcdTIwNWZcdTMwMDBcdWZlZmZdKy87CiAgICAgICAgVVJJLmFzY2lpX3RhYl93aGl0ZXNwYWNlID0gL1tcdTAwMDlcdTAwMEFcdTAwMERdKy9nOwogICAgICAgIFVSSS5kZWZhdWx0UG9ydHMgPSB7CiAgICAgICAgICBodHRwOiAiODAiLAogICAgICAgICAgaHR0cHM6ICI0NDMiLAogICAgICAgICAgZnRwOiAiMjEiLAogICAgICAgICAgZ29waGVyOiAiNzAiLAogICAgICAgICAgd3M6ICI4MCIsCiAgICAgICAgICB3c3M6ICI0NDMiCiAgICAgICAgfTsKICAgICAgICBVUkkuaG9zdFByb3RvY29scyA9IFsKICAgICAgICAgICJodHRwIiwKICAgICAgICAgICJodHRwcyIKICAgICAgICBdOwogICAgICAgIFVSSS5pbnZhbGlkX2hvc3RuYW1lX2NoYXJhY3RlcnMgPSAvW15hLXpBLVowLTlcLlwtOl9dLzsKICAgICAgICBVUkkuZG9tQXR0cmlidXRlcyA9IHsKICAgICAgICAgICJhIjogImhyZWYiLAogICAgICAgICAgImJsb2NrcXVvdGUiOiAiY2l0ZSIsCiAgICAgICAgICAibGluayI6ICJocmVmIiwKICAgICAgICAgICJiYXNlIjogImhyZWYiLAogICAgICAgICAgInNjcmlwdCI6ICJzcmMiLAogICAgICAgICAgImZvcm0iOiAiYWN0aW9uIiwKICAgICAgICAgICJpbWciOiAic3JjIiwKICAgICAgICAgICJhcmVhIjogImhyZWYiLAogICAgICAgICAgImlmcmFtZSI6ICJzcmMiLAogICAgICAgICAgImVtYmVkIjogInNyYyIsCiAgICAgICAgICAic291cmNlIjogInNyYyIsCiAgICAgICAgICAidHJhY2siOiAic3JjIiwKICAgICAgICAgICJpbnB1dCI6ICJzcmMiLAogICAgICAgICAgLy8gYnV0IG9ubHkgaWYgdHlwZT0iaW1hZ2UiCiAgICAgICAgICAiYXVkaW8iOiAic3JjIiwKICAgICAgICAgICJ2aWRlbyI6ICJzcmMiCiAgICAgICAgfTsKICAgICAgICBVUkkuZ2V0RG9tQXR0cmlidXRlID0gZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgaWYgKCFub2RlIHx8ICFub2RlLm5vZGVOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBpZiAobm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgbm9kZS50eXBlICE9PSAiaW1hZ2UiKSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gVVJJLmRvbUF0dHJpYnV0ZXNbbm9kZU5hbWVdOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZXNjYXBlRm9yRHVtYkZpcmVmb3gzNih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuIGVzY2FwZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0cmljdEVuY29kZVVSSUNvbXBvbmVudChzdHJpbmcpIHsKICAgICAgICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5nKS5yZXBsYWNlKC9bIScoKSpdL2csIGVzY2FwZUZvckR1bWJGaXJlZm94MzYpLnJlcGxhY2UoL1wqL2csICIlMkEiKTsKICAgICAgICB9CiAgICAgICAgVVJJLmVuY29kZSA9IHN0cmljdEVuY29kZVVSSUNvbXBvbmVudDsKICAgICAgICBVUkkuZGVjb2RlID0gZGVjb2RlVVJJQ29tcG9uZW50OwogICAgICAgIFVSSS5pc284ODU5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBVUkkuZW5jb2RlID0gZXNjYXBlOwogICAgICAgICAgVVJJLmRlY29kZSA9IHVuZXNjYXBlOwogICAgICAgIH07CiAgICAgICAgVVJJLnVuaWNvZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIFVSSS5lbmNvZGUgPSBzdHJpY3RFbmNvZGVVUklDb21wb25lbnQ7CiAgICAgICAgICBVUkkuZGVjb2RlID0gZGVjb2RlVVJJQ29tcG9uZW50OwogICAgICAgIH07CiAgICAgICAgVVJJLmNoYXJhY3RlcnMgPSB7CiAgICAgICAgICBwYXRobmFtZTogewogICAgICAgICAgICBlbmNvZGU6IHsKICAgICAgICAgICAgICAvLyBSRkMzOTg2IDIuMTogRm9yIGNvbnNpc3RlbmN5LCBVUkkgcHJvZHVjZXJzIGFuZCBub3JtYWxpemVycyBzaG91bGQKICAgICAgICAgICAgICAvLyB1c2UgdXBwZXJjYXNlIGhleGFkZWNpbWFsIGRpZ2l0cyBmb3IgYWxsIHBlcmNlbnQtZW5jb2RpbmdzLgogICAgICAgICAgICAgIGV4cHJlc3Npb246IC8lKDI0fDI2fDJCfDJDfDNCfDNEfDNBfDQwKS9pZywKICAgICAgICAgICAgICBtYXA6IHsKICAgICAgICAgICAgICAgIC8vIC0uX34hJygpKgogICAgICAgICAgICAgICAgIiUyNCI6ICIkIiwKICAgICAgICAgICAgICAgICIlMjYiOiAiJiIsCiAgICAgICAgICAgICAgICAiJTJCIjogIisiLAogICAgICAgICAgICAgICAgIiUyQyI6ICIsIiwKICAgICAgICAgICAgICAgICIlM0IiOiAiOyIsCiAgICAgICAgICAgICAgICAiJTNEIjogIj0iLAogICAgICAgICAgICAgICAgIiUzQSI6ICI6IiwKICAgICAgICAgICAgICAgICIlNDAiOiAiQCIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlY29kZTogewogICAgICAgICAgICAgIGV4cHJlc3Npb246IC9bXC9cPyNdL2csCiAgICAgICAgICAgICAgbWFwOiB7CiAgICAgICAgICAgICAgICAiLyI6ICIlMkYiLAogICAgICAgICAgICAgICAgIj8iOiAiJTNGIiwKICAgICAgICAgICAgICAgICIjIjogIiUyMyIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICByZXNlcnZlZDogewogICAgICAgICAgICBlbmNvZGU6IHsKICAgICAgICAgICAgICAvLyBSRkMzOTg2IDIuMTogRm9yIGNvbnNpc3RlbmN5LCBVUkkgcHJvZHVjZXJzIGFuZCBub3JtYWxpemVycyBzaG91bGQKICAgICAgICAgICAgICAvLyB1c2UgdXBwZXJjYXNlIGhleGFkZWNpbWFsIGRpZ2l0cyBmb3IgYWxsIHBlcmNlbnQtZW5jb2RpbmdzLgogICAgICAgICAgICAgIGV4cHJlc3Npb246IC8lKDIxfDIzfDI0fDI2fDI3fDI4fDI5fDJBfDJCfDJDfDJGfDNBfDNCfDNEfDNGfDQwfDVCfDVEKS9pZywKICAgICAgICAgICAgICBtYXA6IHsKICAgICAgICAgICAgICAgIC8vIGdlbi1kZWxpbXMKICAgICAgICAgICAgICAgICIlM0EiOiAiOiIsCiAgICAgICAgICAgICAgICAiJTJGIjogIi8iLAogICAgICAgICAgICAgICAgIiUzRiI6ICI/IiwKICAgICAgICAgICAgICAgICIlMjMiOiAiIyIsCiAgICAgICAgICAgICAgICAiJTVCIjogIlsiLAogICAgICAgICAgICAgICAgIiU1RCI6ICJdIiwKICAgICAgICAgICAgICAgICIlNDAiOiAiQCIsCiAgICAgICAgICAgICAgICAvLyBzdWItZGVsaW1zCiAgICAgICAgICAgICAgICAiJTIxIjogIiEiLAogICAgICAgICAgICAgICAgIiUyNCI6ICIkIiwKICAgICAgICAgICAgICAgICIlMjYiOiAiJiIsCiAgICAgICAgICAgICAgICAiJTI3IjogIiciLAogICAgICAgICAgICAgICAgIiUyOCI6ICIoIiwKICAgICAgICAgICAgICAgICIlMjkiOiAiKSIsCiAgICAgICAgICAgICAgICAiJTJBIjogIioiLAogICAgICAgICAgICAgICAgIiUyQiI6ICIrIiwKICAgICAgICAgICAgICAgICIlMkMiOiAiLCIsCiAgICAgICAgICAgICAgICAiJTNCIjogIjsiLAogICAgICAgICAgICAgICAgIiUzRCI6ICI9IgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIHVybnBhdGg6IHsKICAgICAgICAgICAgLy8gVGhlIGNoYXJhY3RlcnMgdW5kZXIgYGVuY29kZWAgYXJlIHRoZSBjaGFyYWN0ZXJzIGNhbGxlZCBvdXQgYnkgUkZDIDIxNDEgYXMgYmVpbmcgYWNjZXB0YWJsZQogICAgICAgICAgICAvLyBmb3IgdXNhZ2UgaW4gYSBVUk4uIFJGQzIxNDEgYWxzbyBjYWxscyBvdXQgIi0iLCAiLiIsIGFuZCAiXyIgYXMgYWNjZXB0YWJsZSBjaGFyYWN0ZXJzLCBidXQKICAgICAgICAgICAgLy8gdGhlc2UgYXJlbid0IGVuY29kZWQgYnkgZW5jb2RlVVJJQ29tcG9uZW50LCBzbyB3ZSBkb24ndCBoYXZlIHRvIGNhbGwgdGhlbSBvdXQgaGVyZS4gQWxzbwogICAgICAgICAgICAvLyBub3RlIHRoYXQgdGhlIGNvbG9uIGNoYXJhY3RlciBpcyBub3QgZmVhdHVyZWQgaW4gdGhlIGVuY29kaW5nIG1hcDsgdGhpcyBpcyBiZWNhdXNlIFVSSS5qcwogICAgICAgICAgICAvLyBnaXZlcyB0aGUgY29sb25zIGluIFVSTnMgc2VtYW50aWMgbWVhbmluZyBhcyB0aGUgZGVsaW1pdGVycyBvZiBwYXRoIHNlZ2VtZW50cywgYW5kIHNvIGl0CiAgICAgICAgICAgIC8vIHNob3VsZCBub3QgYXBwZWFyIHVuZW5jb2RlZCBpbiBhIHNlZ21lbnQgaXRzZWxmLgogICAgICAgICAgICAvLyBTZWUgYWxzbyB0aGUgbm90ZSBhYm92ZSBhYm91dCBSRkMzOTg2IGFuZCBjYXBpdGFsYWxpemVkIGhleCBkaWdpdHMuCiAgICAgICAgICAgIGVuY29kZTogewogICAgICAgICAgICAgIGV4cHJlc3Npb246IC8lKDIxfDI0fDI3fDI4fDI5fDJBfDJCfDJDfDNCfDNEfDQwKS9pZywKICAgICAgICAgICAgICBtYXA6IHsKICAgICAgICAgICAgICAgICIlMjEiOiAiISIsCiAgICAgICAgICAgICAgICAiJTI0IjogIiQiLAogICAgICAgICAgICAgICAgIiUyNyI6ICInIiwKICAgICAgICAgICAgICAgICIlMjgiOiAiKCIsCiAgICAgICAgICAgICAgICAiJTI5IjogIikiLAogICAgICAgICAgICAgICAgIiUyQSI6ICIqIiwKICAgICAgICAgICAgICAgICIlMkIiOiAiKyIsCiAgICAgICAgICAgICAgICAiJTJDIjogIiwiLAogICAgICAgICAgICAgICAgIiUzQiI6ICI7IiwKICAgICAgICAgICAgICAgICIlM0QiOiAiPSIsCiAgICAgICAgICAgICAgICAiJTQwIjogIkAiCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAvLyBUaGVzZSBjaGFyYWN0ZXJzIGFyZSB0aGUgY2hhcmFjdGVycyBjYWxsZWQgb3V0IGJ5IFJGQzIxNDEgYXMgInJlc2VydmVkIiBjaGFyYWN0ZXJzIHRoYXQKICAgICAgICAgICAgLy8gc2hvdWxkIG5ldmVyIGFwcGVhciBpbiBhIFVSTiwgcGx1cyB0aGUgY29sb24gY2hhcmFjdGVyIChzZWUgbm90ZSBhYm92ZSkuCiAgICAgICAgICAgIGRlY29kZTogewogICAgICAgICAgICAgIGV4cHJlc3Npb246IC9bXC9cPyM6XS9nLAogICAgICAgICAgICAgIG1hcDogewogICAgICAgICAgICAgICAgIi8iOiAiJTJGIiwKICAgICAgICAgICAgICAgICI/IjogIiUzRiIsCiAgICAgICAgICAgICAgICAiIyI6ICIlMjMiLAogICAgICAgICAgICAgICAgIjoiOiAiJTNBIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgVVJJLmVuY29kZVF1ZXJ5ID0gZnVuY3Rpb24oc3RyaW5nLCBlc2NhcGVRdWVyeVNwYWNlKSB7CiAgICAgICAgICB2YXIgZXNjYXBlZCA9IFVSSS5lbmNvZGUoc3RyaW5nICsgIiIpOwogICAgICAgICAgaWYgKGVzY2FwZVF1ZXJ5U3BhY2UgPT09IHZvaWQgMCkgewogICAgICAgICAgICBlc2NhcGVRdWVyeVNwYWNlID0gVVJJLmVzY2FwZVF1ZXJ5U3BhY2U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXNjYXBlUXVlcnlTcGFjZSA/IGVzY2FwZWQucmVwbGFjZSgvJTIwL2csICIrIikgOiBlc2NhcGVkOwogICAgICAgIH07CiAgICAgICAgVVJJLmRlY29kZVF1ZXJ5ID0gZnVuY3Rpb24oc3RyaW5nLCBlc2NhcGVRdWVyeVNwYWNlKSB7CiAgICAgICAgICBzdHJpbmcgKz0gIiI7CiAgICAgICAgICBpZiAoZXNjYXBlUXVlcnlTcGFjZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGVzY2FwZVF1ZXJ5U3BhY2UgPSBVUkkuZXNjYXBlUXVlcnlTcGFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBVUkkuZGVjb2RlKGVzY2FwZVF1ZXJ5U3BhY2UgPyBzdHJpbmcucmVwbGFjZSgvXCsvZywgIiUyMCIpIDogc3RyaW5nKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBfcGFydHMgPSB7ICJlbmNvZGUiOiAiZW5jb2RlIiwgImRlY29kZSI6ICJkZWNvZGUiIH07CiAgICAgICAgdmFyIF9wYXJ0OwogICAgICAgIHZhciBnZW5lcmF0ZUFjY2Vzc29yID0gZnVuY3Rpb24oX2dyb3VwLCBfcGFydDIpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gVVJJW19wYXJ0Ml0oc3RyaW5nICsgIiIpLnJlcGxhY2UoVVJJLmNoYXJhY3RlcnNbX2dyb3VwXVtfcGFydDJdLmV4cHJlc3Npb24sIGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBVUkkuY2hhcmFjdGVyc1tfZ3JvdXBdW19wYXJ0Ml0ubWFwW2NdOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIGZvciAoX3BhcnQgaW4gX3BhcnRzKSB7CiAgICAgICAgICBVUklbX3BhcnQgKyAiUGF0aFNlZ21lbnQiXSA9IGdlbmVyYXRlQWNjZXNzb3IoInBhdGhuYW1lIiwgX3BhcnRzW19wYXJ0XSk7CiAgICAgICAgICBVUklbX3BhcnQgKyAiVXJuUGF0aFNlZ21lbnQiXSA9IGdlbmVyYXRlQWNjZXNzb3IoInVybnBhdGgiLCBfcGFydHNbX3BhcnRdKTsKICAgICAgICB9CiAgICAgICAgdmFyIGdlbmVyYXRlU2VnbWVudGVkUGF0aEZ1bmN0aW9uID0gZnVuY3Rpb24oX3NlcCwgX2NvZGluZ0Z1bmNOYW1lLCBfaW5uZXJDb2RpbmdGdW5jTmFtZSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICB2YXIgYWN0dWFsQ29kaW5nRnVuYzsKICAgICAgICAgICAgaWYgKCFfaW5uZXJDb2RpbmdGdW5jTmFtZSkgewogICAgICAgICAgICAgIGFjdHVhbENvZGluZ0Z1bmMgPSBVUklbX2NvZGluZ0Z1bmNOYW1lXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhY3R1YWxDb2RpbmdGdW5jID0gZnVuY3Rpb24oc3RyaW5nMikgewogICAgICAgICAgICAgICAgcmV0dXJuIFVSSVtfY29kaW5nRnVuY05hbWVdKFVSSVtfaW5uZXJDb2RpbmdGdW5jTmFtZV0oc3RyaW5nMikpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNlZ21lbnRzID0gKHN0cmluZyArICIiKS5zcGxpdChfc2VwKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IHNlZ21lbnRzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgc2VnbWVudHNbaV0gPSBhY3R1YWxDb2RpbmdGdW5jKHNlZ21lbnRzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2VnbWVudHMuam9pbihfc2VwKTsKICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICBVUkkuZGVjb2RlUGF0aCA9IGdlbmVyYXRlU2VnbWVudGVkUGF0aEZ1bmN0aW9uKCIvIiwgImRlY29kZVBhdGhTZWdtZW50Iik7CiAgICAgICAgVVJJLmRlY29kZVVyblBhdGggPSBnZW5lcmF0ZVNlZ21lbnRlZFBhdGhGdW5jdGlvbigiOiIsICJkZWNvZGVVcm5QYXRoU2VnbWVudCIpOwogICAgICAgIFVSSS5yZWNvZGVQYXRoID0gZ2VuZXJhdGVTZWdtZW50ZWRQYXRoRnVuY3Rpb24oIi8iLCAiZW5jb2RlUGF0aFNlZ21lbnQiLCAiZGVjb2RlIik7CiAgICAgICAgVVJJLnJlY29kZVVyblBhdGggPSBnZW5lcmF0ZVNlZ21lbnRlZFBhdGhGdW5jdGlvbigiOiIsICJlbmNvZGVVcm5QYXRoU2VnbWVudCIsICJkZWNvZGUiKTsKICAgICAgICBVUkkuZW5jb2RlUmVzZXJ2ZWQgPSBnZW5lcmF0ZUFjY2Vzc29yKCJyZXNlcnZlZCIsICJlbmNvZGUiKTsKICAgICAgICBVUkkucGFyc2UgPSBmdW5jdGlvbihzdHJpbmcsIHBhcnRzKSB7CiAgICAgICAgICB2YXIgcG9zOwogICAgICAgICAgaWYgKCFwYXJ0cykgewogICAgICAgICAgICBwYXJ0cyA9IHsKICAgICAgICAgICAgICBwcmV2ZW50SW52YWxpZEhvc3RuYW1lOiBVUkkucHJldmVudEludmFsaWRIb3N0bmFtZQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UoVVJJLmxlYWRpbmdfd2hpdGVzcGFjZV9leHByZXNzaW9uLCAiIik7CiAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZShVUkkuYXNjaWlfdGFiX3doaXRlc3BhY2UsICIiKTsKICAgICAgICAgIHBvcyA9IHN0cmluZy5pbmRleE9mKCIjIik7CiAgICAgICAgICBpZiAocG9zID4gLTEpIHsKICAgICAgICAgICAgcGFydHMuZnJhZ21lbnQgPSBzdHJpbmcuc3Vic3RyaW5nKHBvcyArIDEpIHx8IG51bGw7CiAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5zdWJzdHJpbmcoMCwgcG9zKTsKICAgICAgICAgIH0KICAgICAgICAgIHBvcyA9IHN0cmluZy5pbmRleE9mKCI/Iik7CiAgICAgICAgICBpZiAocG9zID4gLTEpIHsKICAgICAgICAgICAgcGFydHMucXVlcnkgPSBzdHJpbmcuc3Vic3RyaW5nKHBvcyArIDEpIHx8IG51bGw7CiAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5zdWJzdHJpbmcoMCwgcG9zKTsKICAgICAgICAgIH0KICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9eKGh0dHBzP3xmdHB8d3NzPyk/OitbL1xcXSovaSwgIiQxOi8vIik7CiAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZSgvXlsvXFxdezIsfS9pLCAiLy8iKTsKICAgICAgICAgIGlmIChzdHJpbmcuc3Vic3RyaW5nKDAsIDIpID09PSAiLy8iKSB7CiAgICAgICAgICAgIHBhcnRzLnByb3RvY29sID0gbnVsbDsKICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnN1YnN0cmluZygyKTsKICAgICAgICAgICAgc3RyaW5nID0gVVJJLnBhcnNlQXV0aG9yaXR5KHN0cmluZywgcGFydHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcG9zID0gc3RyaW5nLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgaWYgKHBvcyA+IC0xKSB7CiAgICAgICAgICAgICAgcGFydHMucHJvdG9jb2wgPSBzdHJpbmcuc3Vic3RyaW5nKDAsIHBvcykgfHwgbnVsbDsKICAgICAgICAgICAgICBpZiAocGFydHMucHJvdG9jb2wgJiYgIXBhcnRzLnByb3RvY29sLm1hdGNoKFVSSS5wcm90b2NvbF9leHByZXNzaW9uKSkgewogICAgICAgICAgICAgICAgcGFydHMucHJvdG9jb2wgPSB2b2lkIDA7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJpbmcuc3Vic3RyaW5nKHBvcyArIDEsIHBvcyArIDMpLnJlcGxhY2UoL1xcL2csICIvIikgPT09ICIvLyIpIHsKICAgICAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5zdWJzdHJpbmcocG9zICsgMyk7CiAgICAgICAgICAgICAgICBzdHJpbmcgPSBVUkkucGFyc2VBdXRob3JpdHkoc3RyaW5nLCBwYXJ0cyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5zdWJzdHJpbmcocG9zICsgMSk7CiAgICAgICAgICAgICAgICBwYXJ0cy51cm4gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcGFydHMucGF0aCA9IHN0cmluZzsKICAgICAgICAgIHJldHVybiBwYXJ0czsKICAgICAgICB9OwogICAgICAgIFVSSS5wYXJzZUhvc3QgPSBmdW5jdGlvbihzdHJpbmcsIHBhcnRzKSB7CiAgICAgICAgICBpZiAoIXN0cmluZykgewogICAgICAgICAgICBzdHJpbmcgPSAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9cXC9nLCAiLyIpOwogICAgICAgICAgdmFyIHBvcyA9IHN0cmluZy5pbmRleE9mKCIvIik7CiAgICAgICAgICB2YXIgYnJhY2tldFBvczsKICAgICAgICAgIHZhciB0OwogICAgICAgICAgaWYgKHBvcyA9PT0gLTEpIHsKICAgICAgICAgICAgcG9zID0gc3RyaW5nLmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdHJpbmcuY2hhckF0KDApID09PSAiWyIpIHsKICAgICAgICAgICAgYnJhY2tldFBvcyA9IHN0cmluZy5pbmRleE9mKCJdIik7CiAgICAgICAgICAgIHBhcnRzLmhvc3RuYW1lID0gc3RyaW5nLnN1YnN0cmluZygxLCBicmFja2V0UG9zKSB8fCBudWxsOwogICAgICAgICAgICBwYXJ0cy5wb3J0ID0gc3RyaW5nLnN1YnN0cmluZyhicmFja2V0UG9zICsgMiwgcG9zKSB8fCBudWxsOwogICAgICAgICAgICBpZiAocGFydHMucG9ydCA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgcGFydHMucG9ydCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBmaXJzdENvbG9uID0gc3RyaW5nLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgdmFyIGZpcnN0U2xhc2ggPSBzdHJpbmcuaW5kZXhPZigiLyIpOwogICAgICAgICAgICB2YXIgbmV4dENvbG9uID0gc3RyaW5nLmluZGV4T2YoIjoiLCBmaXJzdENvbG9uICsgMSk7CiAgICAgICAgICAgIGlmIChuZXh0Q29sb24gIT09IC0xICYmIChmaXJzdFNsYXNoID09PSAtMSB8fCBuZXh0Q29sb24gPCBmaXJzdFNsYXNoKSkgewogICAgICAgICAgICAgIHBhcnRzLmhvc3RuYW1lID0gc3RyaW5nLnN1YnN0cmluZygwLCBwb3MpIHx8IG51bGw7CiAgICAgICAgICAgICAgcGFydHMucG9ydCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdCA9IHN0cmluZy5zdWJzdHJpbmcoMCwgcG9zKS5zcGxpdCgiOiIpOwogICAgICAgICAgICAgIHBhcnRzLmhvc3RuYW1lID0gdFswXSB8fCBudWxsOwogICAgICAgICAgICAgIHBhcnRzLnBvcnQgPSB0WzFdIHx8IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXJ0cy5ob3N0bmFtZSAmJiBzdHJpbmcuc3Vic3RyaW5nKHBvcykuY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgcG9zKys7CiAgICAgICAgICAgIHN0cmluZyA9ICIvIiArIHN0cmluZzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXJ0cy5wcmV2ZW50SW52YWxpZEhvc3RuYW1lKSB7CiAgICAgICAgICAgIFVSSS5lbnN1cmVWYWxpZEhvc3RuYW1lKHBhcnRzLmhvc3RuYW1lLCBwYXJ0cy5wcm90b2NvbCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGFydHMucG9ydCkgewogICAgICAgICAgICBVUkkuZW5zdXJlVmFsaWRQb3J0KHBhcnRzLnBvcnQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN0cmluZy5zdWJzdHJpbmcocG9zKSB8fCAiLyI7CiAgICAgICAgfTsKICAgICAgICBVUkkucGFyc2VBdXRob3JpdHkgPSBmdW5jdGlvbihzdHJpbmcsIHBhcnRzKSB7CiAgICAgICAgICBzdHJpbmcgPSBVUkkucGFyc2VVc2VyaW5mbyhzdHJpbmcsIHBhcnRzKTsKICAgICAgICAgIHJldHVybiBVUkkucGFyc2VIb3N0KHN0cmluZywgcGFydHMpOwogICAgICAgIH07CiAgICAgICAgVVJJLnBhcnNlVXNlcmluZm8gPSBmdW5jdGlvbihzdHJpbmcsIHBhcnRzKSB7CiAgICAgICAgICB2YXIgX3N0cmluZyA9IHN0cmluZzsKICAgICAgICAgIHZhciBmaXJzdEJhY2tTbGFzaCA9IHN0cmluZy5pbmRleE9mKCJcXCIpOwogICAgICAgICAgaWYgKGZpcnN0QmFja1NsYXNoICE9PSAtMSkgewogICAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZSgvXFwvZywgIi8iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdFNsYXNoID0gc3RyaW5nLmluZGV4T2YoIi8iKTsKICAgICAgICAgIHZhciBwb3MgPSBzdHJpbmcubGFzdEluZGV4T2YoIkAiLCBmaXJzdFNsYXNoID4gLTEgPyBmaXJzdFNsYXNoIDogc3RyaW5nLmxlbmd0aCAtIDEpOwogICAgICAgICAgdmFyIHQ7CiAgICAgICAgICBpZiAocG9zID4gLTEgJiYgKGZpcnN0U2xhc2ggPT09IC0xIHx8IHBvcyA8IGZpcnN0U2xhc2gpKSB7CiAgICAgICAgICAgIHQgPSBzdHJpbmcuc3Vic3RyaW5nKDAsIHBvcykuc3BsaXQoIjoiKTsKICAgICAgICAgICAgcGFydHMudXNlcm5hbWUgPSB0WzBdID8gVVJJLmRlY29kZSh0WzBdKSA6IG51bGw7CiAgICAgICAgICAgIHQuc2hpZnQoKTsKICAgICAgICAgICAgcGFydHMucGFzc3dvcmQgPSB0WzBdID8gVVJJLmRlY29kZSh0LmpvaW4oIjoiKSkgOiBudWxsOwogICAgICAgICAgICBzdHJpbmcgPSBfc3RyaW5nLnN1YnN0cmluZyhwb3MgKyAxKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhcnRzLnVzZXJuYW1lID0gbnVsbDsKICAgICAgICAgICAgcGFydHMucGFzc3dvcmQgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9OwogICAgICAgIFVSSS5wYXJzZVF1ZXJ5ID0gZnVuY3Rpb24oc3RyaW5nLCBlc2NhcGVRdWVyeVNwYWNlKSB7CiAgICAgICAgICBpZiAoIXN0cmluZykgewogICAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgICB9CiAgICAgICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZSgvJisvZywgIiYiKS5yZXBsYWNlKC9eXD8qJip8JiskL2csICIiKTsKICAgICAgICAgIGlmICghc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiB7fTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpdGVtcyA9IHt9OwogICAgICAgICAgdmFyIHNwbGl0cyA9IHN0cmluZy5zcGxpdCgiJiIpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IHNwbGl0cy5sZW5ndGg7CiAgICAgICAgICB2YXIgdjMsIG5hbWUsIHZhbHVlOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICB2MyA9IHNwbGl0c1tpXS5zcGxpdCgiPSIpOwogICAgICAgICAgICBuYW1lID0gVVJJLmRlY29kZVF1ZXJ5KHYzLnNoaWZ0KCksIGVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgICB2YWx1ZSA9IHYzLmxlbmd0aCA/IFVSSS5kZWNvZGVRdWVyeSh2My5qb2luKCI9IiksIGVzY2FwZVF1ZXJ5U3BhY2UpIDogbnVsbDsKICAgICAgICAgICAgaWYgKG5hbWUgPT09ICJfX3Byb3RvX18iKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzT3duLmNhbGwoaXRlbXMsIG5hbWUpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVtc1tuYW1lXSA9PT0gInN0cmluZyIgfHwgaXRlbXNbbmFtZV0gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGl0ZW1zW25hbWVdID0gW2l0ZW1zW25hbWVdXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaXRlbXNbbmFtZV0ucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaXRlbXNbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGl0ZW1zOwogICAgICAgIH07CiAgICAgICAgVVJJLmJ1aWxkID0gZnVuY3Rpb24ocGFydHMpIHsKICAgICAgICAgIHZhciB0ID0gIiI7CiAgICAgICAgICB2YXIgcmVxdWlyZUFic29sdXRlUGF0aCA9IGZhbHNlOwogICAgICAgICAgaWYgKHBhcnRzLnByb3RvY29sKSB7CiAgICAgICAgICAgIHQgKz0gcGFydHMucHJvdG9jb2wgKyAiOiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXBhcnRzLnVybiAmJiAodCB8fCBwYXJ0cy5ob3N0bmFtZSkpIHsKICAgICAgICAgICAgdCArPSAiLy8iOwogICAgICAgICAgICByZXF1aXJlQWJzb2x1dGVQYXRoID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHQgKz0gVVJJLmJ1aWxkQXV0aG9yaXR5KHBhcnRzKSB8fCAiIjsKICAgICAgICAgIGlmICh0eXBlb2YgcGFydHMucGF0aCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWYgKHBhcnRzLnBhdGguY2hhckF0KDApICE9PSAiLyIgJiYgcmVxdWlyZUFic29sdXRlUGF0aCkgewogICAgICAgICAgICAgIHQgKz0gIi8iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHQgKz0gcGFydHMucGF0aDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgcGFydHMucXVlcnkgPT09ICJzdHJpbmciICYmIHBhcnRzLnF1ZXJ5KSB7CiAgICAgICAgICAgIHQgKz0gIj8iICsgcGFydHMucXVlcnk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHBhcnRzLmZyYWdtZW50ID09PSAic3RyaW5nIiAmJiBwYXJ0cy5mcmFnbWVudCkgewogICAgICAgICAgICB0ICs9ICIjIiArIHBhcnRzLmZyYWdtZW50OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHQ7CiAgICAgICAgfTsKICAgICAgICBVUkkuYnVpbGRIb3N0ID0gZnVuY3Rpb24ocGFydHMpIHsKICAgICAgICAgIHZhciB0ID0gIiI7CiAgICAgICAgICBpZiAoIXBhcnRzLmhvc3RuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0gZWxzZSBpZiAoVVJJLmlwNl9leHByZXNzaW9uLnRlc3QocGFydHMuaG9zdG5hbWUpKSB7CiAgICAgICAgICAgIHQgKz0gIlsiICsgcGFydHMuaG9zdG5hbWUgKyAiXSI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0ICs9IHBhcnRzLmhvc3RuYW1lOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcnRzLnBvcnQpIHsKICAgICAgICAgICAgdCArPSAiOiIgKyBwYXJ0cy5wb3J0OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHQ7CiAgICAgICAgfTsKICAgICAgICBVUkkuYnVpbGRBdXRob3JpdHkgPSBmdW5jdGlvbihwYXJ0cykgewogICAgICAgICAgcmV0dXJuIFVSSS5idWlsZFVzZXJpbmZvKHBhcnRzKSArIFVSSS5idWlsZEhvc3QocGFydHMpOwogICAgICAgIH07CiAgICAgICAgVVJJLmJ1aWxkVXNlcmluZm8gPSBmdW5jdGlvbihwYXJ0cykgewogICAgICAgICAgdmFyIHQgPSAiIjsKICAgICAgICAgIGlmIChwYXJ0cy51c2VybmFtZSkgewogICAgICAgICAgICB0ICs9IFVSSS5lbmNvZGUocGFydHMudXNlcm5hbWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcnRzLnBhc3N3b3JkKSB7CiAgICAgICAgICAgIHQgKz0gIjoiICsgVVJJLmVuY29kZShwYXJ0cy5wYXNzd29yZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodCkgewogICAgICAgICAgICB0ICs9ICJAIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0OwogICAgICAgIH07CiAgICAgICAgVVJJLmJ1aWxkUXVlcnkgPSBmdW5jdGlvbihkYXRhLCBkdXBsaWNhdGVRdWVyeVBhcmFtZXRlcnMsIGVzY2FwZVF1ZXJ5U3BhY2UpIHsKICAgICAgICAgIHZhciB0ID0gIiI7CiAgICAgICAgICB2YXIgdW5pcXVlLCBrZXksIGksIGxlbmd0aDsKICAgICAgICAgIGZvciAoa2V5IGluIGRhdGEpIHsKICAgICAgICAgICAgaWYgKGtleSA9PT0gIl9fcHJvdG9fXyIpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNPd24uY2FsbChkYXRhLCBrZXkpKSB7CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoZGF0YVtrZXldKSkgewogICAgICAgICAgICAgICAgdW5pcXVlID0ge307CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBkYXRhW2tleV0ubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKGRhdGFba2V5XVtpXSAhPT0gdm9pZCAwICYmIHVuaXF1ZVtkYXRhW2tleV1baV0gKyAiIl0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgIHQgKz0gIiYiICsgVVJJLmJ1aWxkUXVlcnlQYXJhbWV0ZXIoa2V5LCBkYXRhW2tleV1baV0sIGVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgICAgICAgICAgIGlmIChkdXBsaWNhdGVRdWVyeVBhcmFtZXRlcnMgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgIHVuaXF1ZVtkYXRhW2tleV1baV0gKyAiIl0gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YVtrZXldICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHQgKz0gIiYiICsgVVJJLmJ1aWxkUXVlcnlQYXJhbWV0ZXIoa2V5LCBkYXRhW2tleV0sIGVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHQuc3Vic3RyaW5nKDEpOwogICAgICAgIH07CiAgICAgICAgVVJJLmJ1aWxkUXVlcnlQYXJhbWV0ZXIgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSwgZXNjYXBlUXVlcnlTcGFjZSkgewogICAgICAgICAgcmV0dXJuIFVSSS5lbmNvZGVRdWVyeShuYW1lLCBlc2NhcGVRdWVyeVNwYWNlKSArICh2YWx1ZSAhPT0gbnVsbCA/ICI9IiArIFVSSS5lbmNvZGVRdWVyeSh2YWx1ZSwgZXNjYXBlUXVlcnlTcGFjZSkgOiAiIik7CiAgICAgICAgfTsKICAgICAgICBVUkkuYWRkUXVlcnkgPSBmdW5jdGlvbihkYXRhLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgaWYgKHR5cGVvZiBuYW1lID09PSAib2JqZWN0IikgewogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChuYW1lLCBrZXkpKSB7CiAgICAgICAgICAgICAgICBVUkkuYWRkUXVlcnkoZGF0YSwga2V5LCBuYW1lW2tleV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWYgKGRhdGFbbmFtZV0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGRhdGFbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGFbbmFtZV0gPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZGF0YVtuYW1lXSA9IFtkYXRhW25hbWVdXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgdmFsdWUgPSBbdmFsdWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRhdGFbbmFtZV0gPSAoZGF0YVtuYW1lXSB8fCBbXSkuY29uY2F0KHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVSSS5hZGRRdWVyeSgpIGFjY2VwdHMgYW4gb2JqZWN0LCBzdHJpbmcgYXMgdGhlIG5hbWUgcGFyYW1ldGVyIik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBVUkkuc2V0UXVlcnkgPSBmdW5jdGlvbihkYXRhLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgaWYgKHR5cGVvZiBuYW1lID09PSAib2JqZWN0IikgewogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChuYW1lLCBrZXkpKSB7CiAgICAgICAgICAgICAgICBVUkkuc2V0UXVlcnkoZGF0YSwga2V5LCBuYW1lW2tleV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgZGF0YVtuYW1lXSA9IHZhbHVlID09PSB2b2lkIDAgPyBudWxsIDogdmFsdWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJVUkkuc2V0UXVlcnkoKSBhY2NlcHRzIGFuIG9iamVjdCwgc3RyaW5nIGFzIHRoZSBuYW1lIHBhcmFtZXRlciIpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgVVJJLnJlbW92ZVF1ZXJ5ID0gZnVuY3Rpb24oZGF0YSwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgIHZhciBpLCBsZW5ndGgsIGtleTsKICAgICAgICAgIGlmIChpc0FycmF5KG5hbWUpKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IG5hbWUubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBkYXRhW25hbWVbaV1dID0gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGdldFR5cGUobmFtZSkgPT09ICJSZWdFeHAiKSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIGRhdGEpIHsKICAgICAgICAgICAgICBpZiAobmFtZS50ZXN0KGtleSkpIHsKICAgICAgICAgICAgICAgIGRhdGFba2V5XSA9IHZvaWQgMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5hbWUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGZvciAoa2V5IGluIG5hbWUpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwobmFtZSwga2V5KSkgewogICAgICAgICAgICAgICAgVVJJLnJlbW92ZVF1ZXJ5KGRhdGEsIGtleSwgbmFtZVtrZXldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5hbWUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKGdldFR5cGUodmFsdWUpID09PSAiUmVnRXhwIikgewogICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGRhdGFbbmFtZV0pICYmIHZhbHVlLnRlc3QoZGF0YVtuYW1lXSkpIHsKICAgICAgICAgICAgICAgICAgZGF0YVtuYW1lXSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRhdGFbbmFtZV0gPSBmaWx0ZXJBcnJheVZhbHVlcyhkYXRhW25hbWVdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhW25hbWVdID09PSBTdHJpbmcodmFsdWUpICYmICghaXNBcnJheSh2YWx1ZSkgfHwgdmFsdWUubGVuZ3RoID09PSAxKSkgewogICAgICAgICAgICAgICAgZGF0YVtuYW1lXSA9IHZvaWQgMDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkoZGF0YVtuYW1lXSkpIHsKICAgICAgICAgICAgICAgIGRhdGFbbmFtZV0gPSBmaWx0ZXJBcnJheVZhbHVlcyhkYXRhW25hbWVdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRhdGFbbmFtZV0gPSB2b2lkIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVSSS5yZW1vdmVRdWVyeSgpIGFjY2VwdHMgYW4gb2JqZWN0LCBzdHJpbmcsIFJlZ0V4cCBhcyB0aGUgZmlyc3QgcGFyYW1ldGVyIik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBVUkkuaGFzUXVlcnkgPSBmdW5jdGlvbihkYXRhLCBuYW1lLCB2YWx1ZSwgd2l0aGluQXJyYXkpIHsKICAgICAgICAgIHN3aXRjaCAoZ2V0VHlwZShuYW1lKSkgewogICAgICAgICAgICBjYXNlICJTdHJpbmciOgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJSZWdFeHAiOgogICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBkYXRhKSB7CiAgICAgICAgICAgICAgICBpZiAoaGFzT3duLmNhbGwoZGF0YSwga2V5KSkgewogICAgICAgICAgICAgICAgICBpZiAobmFtZS50ZXN0KGtleSkgJiYgKHZhbHVlID09PSB2b2lkIDAgfHwgVVJJLmhhc1F1ZXJ5KGRhdGEsIGtleSwgdmFsdWUpKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgY2FzZSAiT2JqZWN0IjoKICAgICAgICAgICAgICBmb3IgKHZhciBfa2V5IGluIG5hbWUpIHsKICAgICAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChuYW1lLCBfa2V5KSkgewogICAgICAgICAgICAgICAgICBpZiAoIVVSSS5oYXNRdWVyeShkYXRhLCBfa2V5LCBuYW1lW19rZXldKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJVUkkuaGFzUXVlcnkoKSBhY2NlcHRzIGEgc3RyaW5nLCByZWd1bGFyIGV4cHJlc3Npb24gb3Igb2JqZWN0IGFzIHRoZSBuYW1lIHBhcmFtZXRlciIpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoIChnZXRUeXBlKHZhbHVlKSkgewogICAgICAgICAgICBjYXNlICJVbmRlZmluZWQiOgogICAgICAgICAgICAgIHJldHVybiBuYW1lIGluIGRhdGE7CiAgICAgICAgICAgIGNhc2UgIkJvb2xlYW4iOgogICAgICAgICAgICAgIHZhciBfYm9vbHkgPSBCb29sZWFuKGlzQXJyYXkoZGF0YVtuYW1lXSkgPyBkYXRhW25hbWVdLmxlbmd0aCA6IGRhdGFbbmFtZV0pOwogICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gX2Jvb2x5OwogICAgICAgICAgICBjYXNlICJGdW5jdGlvbiI6CiAgICAgICAgICAgICAgcmV0dXJuICEhdmFsdWUoZGF0YVtuYW1lXSwgbmFtZSwgZGF0YSk7CiAgICAgICAgICAgIGNhc2UgIkFycmF5IjoKICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoZGF0YVtuYW1lXSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG9wID0gd2l0aGluQXJyYXkgPyBhcnJheUNvbnRhaW5zIDogYXJyYXlzRXF1YWw7CiAgICAgICAgICAgICAgcmV0dXJuIG9wKGRhdGFbbmFtZV0sIHZhbHVlKTsKICAgICAgICAgICAgY2FzZSAiUmVnRXhwIjoKICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoZGF0YVtuYW1lXSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBCb29sZWFuKGRhdGFbbmFtZV0gJiYgZGF0YVtuYW1lXS5tYXRjaCh2YWx1ZSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIXdpdGhpbkFycmF5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBhcnJheUNvbnRhaW5zKGRhdGFbbmFtZV0sIHZhbHVlKTsKICAgICAgICAgICAgY2FzZSAiTnVtYmVyIjoKICAgICAgICAgICAgICB2YWx1ZSA9IFN0cmluZyh2YWx1ZSk7CiAgICAgICAgICAgIGNhc2UgIlN0cmluZyI6CiAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGRhdGFbbmFtZV0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YVtuYW1lXSA9PT0gdmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghd2l0aGluQXJyYXkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGFycmF5Q29udGFpbnMoZGF0YVtuYW1lXSwgdmFsdWUpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVSSS5oYXNRdWVyeSgpIGFjY2VwdHMgdW5kZWZpbmVkLCBib29sZWFuLCBzdHJpbmcsIG51bWJlciwgUmVnRXhwLCBGdW5jdGlvbiBhcyB0aGUgdmFsdWUgcGFyYW1ldGVyIik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBVUkkuam9pblBhdGhzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgaW5wdXQgPSBbXTsKICAgICAgICAgIHZhciBzZWdtZW50cyA9IFtdOwogICAgICAgICAgdmFyIG5vbkVtcHR5U2VnbWVudHMgPSAwOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHVybCA9IG5ldyBVUkkoYXJndW1lbnRzW2ldKTsKICAgICAgICAgICAgaW5wdXQucHVzaCh1cmwpOwogICAgICAgICAgICB2YXIgX3NlZ21lbnRzID0gdXJsLnNlZ21lbnQoKTsKICAgICAgICAgICAgZm9yICh2YXIgcyA9IDA7IHMgPCBfc2VnbWVudHMubGVuZ3RoOyBzKyspIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIF9zZWdtZW50c1tzXSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHNlZ21lbnRzLnB1c2goX3NlZ21lbnRzW3NdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKF9zZWdtZW50c1tzXSkgewogICAgICAgICAgICAgICAgbm9uRW1wdHlTZWdtZW50cysrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFzZWdtZW50cy5sZW5ndGggfHwgIW5vbkVtcHR5U2VnbWVudHMpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBVUkkoIiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVyaSA9IG5ldyBVUkkoIiIpLnNlZ21lbnQoc2VnbWVudHMpOwogICAgICAgICAgaWYgKGlucHV0WzBdLnBhdGgoKSA9PT0gIiIgfHwgaW5wdXRbMF0ucGF0aCgpLnNsaWNlKDAsIDEpID09PSAiLyIpIHsKICAgICAgICAgICAgdXJpLnBhdGgoIi8iICsgdXJpLnBhdGgoKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXJpLm5vcm1hbGl6ZSgpOwogICAgICAgIH07CiAgICAgICAgVVJJLmNvbW1vblBhdGggPSBmdW5jdGlvbihvbmUsIHR3bykgewogICAgICAgICAgdmFyIGxlbmd0aCA9IE1hdGgubWluKG9uZS5sZW5ndGgsIHR3by5sZW5ndGgpOwogICAgICAgICAgdmFyIHBvczsKICAgICAgICAgIGZvciAocG9zID0gMDsgcG9zIDwgbGVuZ3RoOyBwb3MrKykgewogICAgICAgICAgICBpZiAob25lLmNoYXJBdChwb3MpICE9PSB0d28uY2hhckF0KHBvcykpIHsKICAgICAgICAgICAgICBwb3MtLTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHBvcyA8IDEpIHsKICAgICAgICAgICAgcmV0dXJuIG9uZS5jaGFyQXQoMCkgPT09IHR3by5jaGFyQXQoMCkgJiYgb25lLmNoYXJBdCgwKSA9PT0gIi8iID8gIi8iIDogIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob25lLmNoYXJBdChwb3MpICE9PSAiLyIgfHwgdHdvLmNoYXJBdChwb3MpICE9PSAiLyIpIHsKICAgICAgICAgICAgcG9zID0gb25lLnN1YnN0cmluZygwLCBwb3MpLmxhc3RJbmRleE9mKCIvIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gb25lLnN1YnN0cmluZygwLCBwb3MgKyAxKTsKICAgICAgICB9OwogICAgICAgIFVSSS53aXRoaW5TdHJpbmcgPSBmdW5jdGlvbihzdHJpbmcsIGNhbGxiYWNrLCBvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICAgICAgdmFyIF9zdGFydCA9IG9wdGlvbnMuc3RhcnQgfHwgVVJJLmZpbmRVcmkuc3RhcnQ7CiAgICAgICAgICB2YXIgX2VuZCA9IG9wdGlvbnMuZW5kIHx8IFVSSS5maW5kVXJpLmVuZDsKICAgICAgICAgIHZhciBfdHJpbSA9IG9wdGlvbnMudHJpbSB8fCBVUkkuZmluZFVyaS50cmltOwogICAgICAgICAgdmFyIF9wYXJlbnMgPSBvcHRpb25zLnBhcmVucyB8fCBVUkkuZmluZFVyaS5wYXJlbnM7CiAgICAgICAgICB2YXIgX2F0dHJpYnV0ZU9wZW4gPSAvW2EtejAtOS1dPVsiJ10/JC9pOwogICAgICAgICAgX3N0YXJ0Lmxhc3RJbmRleCA9IDA7CiAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBfc3RhcnQuZXhlYyhzdHJpbmcpOwogICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHN0YXJ0ID0gbWF0Y2guaW5kZXg7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmlnbm9yZUh0bWwpIHsKICAgICAgICAgICAgICB2YXIgYXR0cmlidXRlT3BlbiA9IHN0cmluZy5zbGljZShNYXRoLm1heChzdGFydCAtIDMsIDApLCBzdGFydCk7CiAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU9wZW4gJiYgX2F0dHJpYnV0ZU9wZW4udGVzdChhdHRyaWJ1dGVPcGVuKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbmQgPSBzdGFydCArIHN0cmluZy5zbGljZShzdGFydCkuc2VhcmNoKF9lbmQpOwogICAgICAgICAgICB2YXIgc2xpY2UgPSBzdHJpbmcuc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICAgICAgICAgIHZhciBwYXJlbnNFbmQgPSAtMTsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICB2YXIgcGFyZW5zTWF0Y2ggPSBfcGFyZW5zLmV4ZWMoc2xpY2UpOwogICAgICAgICAgICAgIGlmICghcGFyZW5zTWF0Y2gpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcGFyZW5zTWF0Y2hFbmQgPSBwYXJlbnNNYXRjaC5pbmRleCArIHBhcmVuc01hdGNoWzBdLmxlbmd0aDsKICAgICAgICAgICAgICBwYXJlbnNFbmQgPSBNYXRoLm1heChwYXJlbnNFbmQsIHBhcmVuc01hdGNoRW5kKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGFyZW5zRW5kID4gLTEpIHsKICAgICAgICAgICAgICBzbGljZSA9IHNsaWNlLnNsaWNlKDAsIHBhcmVuc0VuZCkgKyBzbGljZS5zbGljZShwYXJlbnNFbmQpLnJlcGxhY2UoX3RyaW0sICIiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzbGljZSA9IHNsaWNlLnJlcGxhY2UoX3RyaW0sICIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2xpY2UubGVuZ3RoIDw9IG1hdGNoWzBdLmxlbmd0aCkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zLmlnbm9yZSAmJiBvcHRpb25zLmlnbm9yZS50ZXN0KHNsaWNlKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0ICsgc2xpY2UubGVuZ3RoOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gY2FsbGJhY2soc2xpY2UsIHN0YXJ0LCBlbmQsIHN0cmluZyk7CiAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIF9zdGFydC5sYXN0SW5kZXggPSBlbmQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ID0gU3RyaW5nKHJlc3VsdCk7CiAgICAgICAgICAgIHN0cmluZyA9IHN0cmluZy5zbGljZSgwLCBzdGFydCkgKyByZXN1bHQgKyBzdHJpbmcuc2xpY2UoZW5kKTsKICAgICAgICAgICAgX3N0YXJ0Lmxhc3RJbmRleCA9IHN0YXJ0ICsgcmVzdWx0Lmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIF9zdGFydC5sYXN0SW5kZXggPSAwOwogICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9OwogICAgICAgIFVSSS5lbnN1cmVWYWxpZEhvc3RuYW1lID0gZnVuY3Rpb24odjMsIHByb3RvY29sKSB7CiAgICAgICAgICB2YXIgaGFzSG9zdG5hbWUgPSAhIXYzOwogICAgICAgICAgdmFyIGhhc1Byb3RvY29sID0gISFwcm90b2NvbDsKICAgICAgICAgIHZhciByZWplY3RFbXB0eUhvc3RuYW1lID0gZmFsc2U7CiAgICAgICAgICBpZiAoaGFzUHJvdG9jb2wpIHsKICAgICAgICAgICAgcmVqZWN0RW1wdHlIb3N0bmFtZSA9IGFycmF5Q29udGFpbnMoVVJJLmhvc3RQcm90b2NvbHMsIHByb3RvY29sKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZWplY3RFbXB0eUhvc3RuYW1lICYmICFoYXNIb3N0bmFtZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJIb3N0bmFtZSBjYW5ub3QgYmUgZW1wdHksIGlmIHByb3RvY29sIGlzICIgKyBwcm90b2NvbCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHYzICYmIHYzLm1hdGNoKFVSSS5pbnZhbGlkX2hvc3RuYW1lX2NoYXJhY3RlcnMpKSB7CiAgICAgICAgICAgIGlmICghcHVueWNvZGUpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdIb3N0bmFtZSAiJyArIHYzICsgJyIgY29udGFpbnMgY2hhcmFjdGVycyBvdGhlciB0aGFuIFtBLVowLTkuLTpfXSBhbmQgUHVueWNvZGUuanMgaXMgbm90IGF2YWlsYWJsZScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwdW55Y29kZS50b0FTQ0lJKHYzKS5tYXRjaChVUkkuaW52YWxpZF9ob3N0bmFtZV9jaGFyYWN0ZXJzKSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0hvc3RuYW1lICInICsgdjMgKyAnIiBjb250YWlucyBjaGFyYWN0ZXJzIG90aGVyIHRoYW4gW0EtWjAtOS4tOl9dJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIFVSSS5lbnN1cmVWYWxpZFBvcnQgPSBmdW5jdGlvbih2MykgewogICAgICAgICAgaWYgKCF2MykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcG9ydCA9IE51bWJlcih2Myk7CiAgICAgICAgICBpZiAoaXNJbnRlZ2VyKHBvcnQpICYmIHBvcnQgPiAwICYmIHBvcnQgPCA2NTUzNikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdQb3J0ICInICsgdjMgKyAnIiBpcyBub3QgYSB2YWxpZCBwb3J0Jyk7CiAgICAgICAgfTsKICAgICAgICBVUkkubm9Db25mbGljdCA9IGZ1bmN0aW9uKHJlbW92ZUFsbCkgewogICAgICAgICAgaWYgKHJlbW92ZUFsbCkgewogICAgICAgICAgICB2YXIgdW5jb25mbGljdGVkID0gewogICAgICAgICAgICAgIFVSSTogdGhpcy5ub0NvbmZsaWN0KCkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHJvb3QuVVJJVGVtcGxhdGUgJiYgdHlwZW9mIHJvb3QuVVJJVGVtcGxhdGUubm9Db25mbGljdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHVuY29uZmxpY3RlZC5VUklUZW1wbGF0ZSA9IHJvb3QuVVJJVGVtcGxhdGUubm9Db25mbGljdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyb290LklQdjYgJiYgdHlwZW9mIHJvb3QuSVB2Ni5ub0NvbmZsaWN0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdW5jb25mbGljdGVkLklQdjYgPSByb290LklQdjYubm9Db25mbGljdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyb290LlNlY29uZExldmVsRG9tYWlucyAmJiB0eXBlb2Ygcm9vdC5TZWNvbmRMZXZlbERvbWFpbnMubm9Db25mbGljdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHVuY29uZmxpY3RlZC5TZWNvbmRMZXZlbERvbWFpbnMgPSByb290LlNlY29uZExldmVsRG9tYWlucy5ub0NvbmZsaWN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHVuY29uZmxpY3RlZDsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdC5VUkkgPT09IHRoaXMpIHsKICAgICAgICAgICAgcm9vdC5VUkkgPSBfVVJJOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLmJ1aWxkID0gZnVuY3Rpb24oZGVmZXJCdWlsZCkgewogICAgICAgICAgaWYgKGRlZmVyQnVpbGQgPT09IHRydWUpIHsKICAgICAgICAgICAgdGhpcy5fZGVmZXJyZWRfYnVpbGQgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIGlmIChkZWZlckJ1aWxkID09PSB2b2lkIDAgfHwgdGhpcy5fZGVmZXJyZWRfYnVpbGQpIHsKICAgICAgICAgICAgdGhpcy5fc3RyaW5nID0gVVJJLmJ1aWxkKHRoaXMuX3BhcnRzKTsKICAgICAgICAgICAgdGhpcy5fZGVmZXJyZWRfYnVpbGQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcC5jbG9uZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIG5ldyBVUkkodGhpcyk7CiAgICAgICAgfTsKICAgICAgICBwLnZhbHVlT2YgPSBwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5idWlsZChmYWxzZSkuX3N0cmluZzsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoX3BhcnQyKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnRzW19wYXJ0Ml0gfHwgIiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5fcGFydHNbX3BhcnQyXSA9IHYzIHx8IG51bGw7CiAgICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZW5lcmF0ZVByZWZpeEFjY2Vzc29yKF9wYXJ0MiwgX2tleSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJ0c1tfcGFydDJdIHx8ICIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICh2MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdjMgPSB2MyArICIiOwogICAgICAgICAgICAgICAgaWYgKHYzLmNoYXJBdCgwKSA9PT0gX2tleSkgewogICAgICAgICAgICAgICAgICB2MyA9IHYzLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5fcGFydHNbX3BhcnQyXSA9IHYzOwogICAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcC5wcm90b2NvbCA9IGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoInByb3RvY29sIik7CiAgICAgICAgcC51c2VybmFtZSA9IGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoInVzZXJuYW1lIik7CiAgICAgICAgcC5wYXNzd29yZCA9IGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoInBhc3N3b3JkIik7CiAgICAgICAgcC5ob3N0bmFtZSA9IGdlbmVyYXRlU2ltcGxlQWNjZXNzb3IoImhvc3RuYW1lIik7CiAgICAgICAgcC5wb3J0ID0gZ2VuZXJhdGVTaW1wbGVBY2Nlc3NvcigicG9ydCIpOwogICAgICAgIHAucXVlcnkgPSBnZW5lcmF0ZVByZWZpeEFjY2Vzc29yKCJxdWVyeSIsICI/Iik7CiAgICAgICAgcC5mcmFnbWVudCA9IGdlbmVyYXRlUHJlZml4QWNjZXNzb3IoImZyYWdtZW50IiwgIiMiKTsKICAgICAgICBwLnNlYXJjaCA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgdmFyIHQgPSB0aGlzLnF1ZXJ5KHYzLCBidWlsZCk7CiAgICAgICAgICByZXR1cm4gdHlwZW9mIHQgPT09ICJzdHJpbmciICYmIHQubGVuZ3RoID8gIj8iICsgdCA6IHQ7CiAgICAgICAgfTsKICAgICAgICBwLmhhc2ggPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIHZhciB0ID0gdGhpcy5mcmFnbWVudCh2MywgYnVpbGQpOwogICAgICAgICAgcmV0dXJuIHR5cGVvZiB0ID09PSAic3RyaW5nIiAmJiB0Lmxlbmd0aCA/ICIjIiArIHQgOiB0OwogICAgICAgIH07CiAgICAgICAgcC5wYXRobmFtZSA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHYzID09PSB2b2lkIDAgfHwgdjMgPT09IHRydWUpIHsKICAgICAgICAgICAgdmFyIHJlcyA9IHRoaXMuX3BhcnRzLnBhdGggfHwgKHRoaXMuX3BhcnRzLmhvc3RuYW1lID8gIi8iIDogIiIpOwogICAgICAgICAgICByZXR1cm4gdjMgPyAodGhpcy5fcGFydHMudXJuID8gVVJJLmRlY29kZVVyblBhdGggOiBVUkkuZGVjb2RlUGF0aCkocmVzKSA6IHJlczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5wYXRoID0gdjMgPyBVUkkucmVjb2RlVXJuUGF0aCh2MykgOiAiIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5wYXRoID0gdjMgPyBVUkkucmVjb2RlUGF0aCh2MykgOiAiLyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAucGF0aCA9IHAucGF0aG5hbWU7CiAgICAgICAgcC5ocmVmID0gZnVuY3Rpb24oaHJlZiwgYnVpbGQpIHsKICAgICAgICAgIHZhciBrZXk7CiAgICAgICAgICBpZiAoaHJlZiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRvU3RyaW5nKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9zdHJpbmcgPSAiIjsKICAgICAgICAgIHRoaXMuX3BhcnRzID0gVVJJLl9wYXJ0cygpOwogICAgICAgICAgdmFyIF9VUkkyID0gaHJlZiBpbnN0YW5jZW9mIFVSSTsKICAgICAgICAgIHZhciBfb2JqZWN0ID0gdHlwZW9mIGhyZWYgPT09ICJvYmplY3QiICYmIChocmVmLmhvc3RuYW1lIHx8IGhyZWYucGF0aCB8fCBocmVmLnBhdGhuYW1lKTsKICAgICAgICAgIGlmIChocmVmLm5vZGVOYW1lKSB7CiAgICAgICAgICAgIHZhciBhdHRyaWJ1dGUgPSBVUkkuZ2V0RG9tQXR0cmlidXRlKGhyZWYpOwogICAgICAgICAgICBocmVmID0gaHJlZlthdHRyaWJ1dGVdIHx8ICIiOwogICAgICAgICAgICBfb2JqZWN0ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIV9VUkkyICYmIF9vYmplY3QgJiYgaHJlZi5wYXRobmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGhyZWYgPSBocmVmLnRvU3RyaW5nKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGhyZWYgPT09ICJzdHJpbmciIHx8IGhyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsKICAgICAgICAgICAgdGhpcy5fcGFydHMgPSBVUkkucGFyc2UoU3RyaW5nKGhyZWYpLCB0aGlzLl9wYXJ0cyk7CiAgICAgICAgICB9IGVsc2UgaWYgKF9VUkkyIHx8IF9vYmplY3QpIHsKICAgICAgICAgICAgdmFyIHNyYyA9IF9VUkkyID8gaHJlZi5fcGFydHMgOiBocmVmOwogICAgICAgICAgICBmb3IgKGtleSBpbiBzcmMpIHsKICAgICAgICAgICAgICBpZiAoa2V5ID09PSAicXVlcnkiKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKHRoaXMuX3BhcnRzLCBrZXkpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9wYXJ0c1trZXldID0gc3JjW2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzcmMucXVlcnkpIHsKICAgICAgICAgICAgICB0aGlzLnF1ZXJ5KHNyYy5xdWVyeSwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJpbnZhbGlkIGlucHV0Iik7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuaXMgPSBmdW5jdGlvbih3aGF0KSB7CiAgICAgICAgICB2YXIgaXAgPSBmYWxzZTsKICAgICAgICAgIHZhciBpcDQgPSBmYWxzZTsKICAgICAgICAgIHZhciBpcDYgPSBmYWxzZTsKICAgICAgICAgIHZhciBuYW1lID0gZmFsc2U7CiAgICAgICAgICB2YXIgc2xkID0gZmFsc2U7CiAgICAgICAgICB2YXIgaWRuID0gZmFsc2U7CiAgICAgICAgICB2YXIgcHVueWNvZGUyID0gZmFsc2U7CiAgICAgICAgICB2YXIgcmVsYXRpdmUgPSAhdGhpcy5fcGFydHMudXJuOwogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLmhvc3RuYW1lKSB7CiAgICAgICAgICAgIHJlbGF0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIGlwNCA9IFVSSS5pcDRfZXhwcmVzc2lvbi50ZXN0KHRoaXMuX3BhcnRzLmhvc3RuYW1lKTsKICAgICAgICAgICAgaXA2ID0gVVJJLmlwNl9leHByZXNzaW9uLnRlc3QodGhpcy5fcGFydHMuaG9zdG5hbWUpOwogICAgICAgICAgICBpcCA9IGlwNCB8fCBpcDY7CiAgICAgICAgICAgIG5hbWUgPSAhaXA7CiAgICAgICAgICAgIHNsZCA9IG5hbWUgJiYgU0xEICYmIFNMRC5oYXModGhpcy5fcGFydHMuaG9zdG5hbWUpOwogICAgICAgICAgICBpZG4gPSBuYW1lICYmIFVSSS5pZG5fZXhwcmVzc2lvbi50ZXN0KHRoaXMuX3BhcnRzLmhvc3RuYW1lKTsKICAgICAgICAgICAgcHVueWNvZGUyID0gbmFtZSAmJiBVUkkucHVueWNvZGVfZXhwcmVzc2lvbi50ZXN0KHRoaXMuX3BhcnRzLmhvc3RuYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAod2hhdC50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgIGNhc2UgInJlbGF0aXZlIjoKICAgICAgICAgICAgICByZXR1cm4gcmVsYXRpdmU7CiAgICAgICAgICAgIGNhc2UgImFic29sdXRlIjoKICAgICAgICAgICAgICByZXR1cm4gIXJlbGF0aXZlOwogICAgICAgICAgICBjYXNlICJkb21haW4iOgogICAgICAgICAgICBjYXNlICJuYW1lIjoKICAgICAgICAgICAgICByZXR1cm4gbmFtZTsKICAgICAgICAgICAgY2FzZSAic2xkIjoKICAgICAgICAgICAgICByZXR1cm4gc2xkOwogICAgICAgICAgICBjYXNlICJpcCI6CiAgICAgICAgICAgICAgcmV0dXJuIGlwOwogICAgICAgICAgICBjYXNlICJpcDQiOgogICAgICAgICAgICBjYXNlICJpcHY0IjoKICAgICAgICAgICAgY2FzZSAiaW5ldDQiOgogICAgICAgICAgICAgIHJldHVybiBpcDQ7CiAgICAgICAgICAgIGNhc2UgImlwNiI6CiAgICAgICAgICAgIGNhc2UgImlwdjYiOgogICAgICAgICAgICBjYXNlICJpbmV0NiI6CiAgICAgICAgICAgICAgcmV0dXJuIGlwNjsKICAgICAgICAgICAgY2FzZSAiaWRuIjoKICAgICAgICAgICAgICByZXR1cm4gaWRuOwogICAgICAgICAgICBjYXNlICJ1cmwiOgogICAgICAgICAgICAgIHJldHVybiAhdGhpcy5fcGFydHMudXJuOwogICAgICAgICAgICBjYXNlICJ1cm4iOgogICAgICAgICAgICAgIHJldHVybiAhIXRoaXMuX3BhcnRzLnVybjsKICAgICAgICAgICAgY2FzZSAicHVueWNvZGUiOgogICAgICAgICAgICAgIHJldHVybiBwdW55Y29kZTI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIHZhciBfcHJvdG9jb2wgPSBwLnByb3RvY29sOwogICAgICAgIHZhciBfcG9ydCA9IHAucG9ydDsKICAgICAgICB2YXIgX2hvc3RuYW1lID0gcC5ob3N0bmFtZTsKICAgICAgICBwLnByb3RvY29sID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodjMpIHsKICAgICAgICAgICAgdjMgPSB2My5yZXBsYWNlKC86KFwvXC8pPyQvLCAiIik7CiAgICAgICAgICAgIGlmICghdjMubWF0Y2goVVJJLnByb3RvY29sX2V4cHJlc3Npb24pKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignUHJvdG9jb2wgIicgKyB2MyArIGAiIGNvbnRhaW5zIGNoYXJhY3RlcnMgb3RoZXIgdGhhbiBbQS1aMC05ListXSBvciBkb2Vzbid0IHN0YXJ0IHdpdGggW0EtWl1gKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIF9wcm90b2NvbC5jYWxsKHRoaXMsIHYzLCBidWlsZCk7CiAgICAgICAgfTsKICAgICAgICBwLnNjaGVtZSA9IHAucHJvdG9jb2w7CiAgICAgICAgcC5wb3J0ID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHYzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHYzID09PSAwKSB7CiAgICAgICAgICAgICAgdjMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2MykgewogICAgICAgICAgICAgIHYzICs9ICIiOwogICAgICAgICAgICAgIGlmICh2My5jaGFyQXQoMCkgPT09ICI6IikgewogICAgICAgICAgICAgICAgdjMgPSB2My5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIFVSSS5lbnN1cmVWYWxpZFBvcnQodjMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gX3BvcnQuY2FsbCh0aGlzLCB2MywgYnVpbGQpOwogICAgICAgIH07CiAgICAgICAgcC5ob3N0bmFtZSA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhciB4ID0geyBwcmV2ZW50SW52YWxpZEhvc3RuYW1lOiB0aGlzLl9wYXJ0cy5wcmV2ZW50SW52YWxpZEhvc3RuYW1lIH07CiAgICAgICAgICAgIHZhciByZXMgPSBVUkkucGFyc2VIb3N0KHYzLCB4KTsKICAgICAgICAgICAgaWYgKHJlcyAhPT0gIi8iKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignSG9zdG5hbWUgIicgKyB2MyArICciIGNvbnRhaW5zIGNoYXJhY3RlcnMgb3RoZXIgdGhhbiBbQS1aMC05Li1dJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdjMgPSB4Lmhvc3RuYW1lOwogICAgICAgICAgICBpZiAodGhpcy5fcGFydHMucHJldmVudEludmFsaWRIb3N0bmFtZSkgewogICAgICAgICAgICAgIFVSSS5lbnN1cmVWYWxpZEhvc3RuYW1lKHYzLCB0aGlzLl9wYXJ0cy5wcm90b2NvbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBfaG9zdG5hbWUuY2FsbCh0aGlzLCB2MywgYnVpbGQpOwogICAgICAgIH07CiAgICAgICAgcC5vcmlnaW4gPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSB0aGlzLnByb3RvY29sKCk7CiAgICAgICAgICAgIHZhciBhdXRob3JpdHkgPSB0aGlzLmF1dGhvcml0eSgpOwogICAgICAgICAgICBpZiAoIWF1dGhvcml0eSkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKHByb3RvY29sID8gcHJvdG9jb2wgKyAiOi8vIiA6ICIiKSArIHRoaXMuYXV0aG9yaXR5KCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgb3JpZ2luID0gVVJJKHYzKTsKICAgICAgICAgICAgdGhpcy5wcm90b2NvbChvcmlnaW4ucHJvdG9jb2woKSkuYXV0aG9yaXR5KG9yaWdpbi5hdXRob3JpdHkoKSkuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLmhvc3QgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFydHMuaG9zdG5hbWUgPyBVUkkuYnVpbGRIb3N0KHRoaXMuX3BhcnRzKSA6ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJlcyA9IFVSSS5wYXJzZUhvc3QodjMsIHRoaXMuX3BhcnRzKTsKICAgICAgICAgICAgaWYgKHJlcyAhPT0gIi8iKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignSG9zdG5hbWUgIicgKyB2MyArICciIGNvbnRhaW5zIGNoYXJhY3RlcnMgb3RoZXIgdGhhbiBbQS1aMC05Li1dJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAuYXV0aG9yaXR5ID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHYzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnRzLmhvc3RuYW1lID8gVVJJLmJ1aWxkQXV0aG9yaXR5KHRoaXMuX3BhcnRzKSA6ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJlcyA9IFVSSS5wYXJzZUF1dGhvcml0eSh2MywgdGhpcy5fcGFydHMpOwogICAgICAgICAgICBpZiAocmVzICE9PSAiLyIpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdIb3N0bmFtZSAiJyArIHYzICsgJyIgY29udGFpbnMgY2hhcmFjdGVycyBvdGhlciB0aGFuIFtBLVowLTkuLV0nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcC51c2VyaW5mbyA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhciB0ID0gVVJJLmJ1aWxkVXNlcmluZm8odGhpcy5fcGFydHMpOwogICAgICAgICAgICByZXR1cm4gdCA/IHQuc3Vic3RyaW5nKDAsIHQubGVuZ3RoIC0gMSkgOiB0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHYzW3YzLmxlbmd0aCAtIDFdICE9PSAiQCIpIHsKICAgICAgICAgICAgICB2MyArPSAiQCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgVVJJLnBhcnNlVXNlcmluZm8odjMsIHRoaXMuX3BhcnRzKTsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHAucmVzb3VyY2UgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIHZhciBwYXJ0czsKICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhdGgoKSArIHRoaXMuc2VhcmNoKCkgKyB0aGlzLmhhc2goKTsKICAgICAgICAgIH0KICAgICAgICAgIHBhcnRzID0gVVJJLnBhcnNlKHYzKTsKICAgICAgICAgIHRoaXMuX3BhcnRzLnBhdGggPSBwYXJ0cy5wYXRoOwogICAgICAgICAgdGhpcy5fcGFydHMucXVlcnkgPSBwYXJ0cy5xdWVyeTsKICAgICAgICAgIHRoaXMuX3BhcnRzLmZyYWdtZW50ID0gcGFydHMuZnJhZ21lbnQ7CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuc3ViZG9tYWluID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHYzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKCF0aGlzLl9wYXJ0cy5ob3N0bmFtZSB8fCB0aGlzLmlzKCJJUCIpKSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbmQgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5sZW5ndGggLSB0aGlzLmRvbWFpbigpLmxlbmd0aCAtIDE7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5zdWJzdHJpbmcoMCwgZW5kKSB8fCAiIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBlID0gdGhpcy5fcGFydHMuaG9zdG5hbWUubGVuZ3RoIC0gdGhpcy5kb21haW4oKS5sZW5ndGg7CiAgICAgICAgICAgIHZhciBzdWIgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5zdWJzdHJpbmcoMCwgZSk7CiAgICAgICAgICAgIHZhciByZXBsYWNlID0gbmV3IFJlZ0V4cCgiXiIgKyBlc2NhcGVSZWdFeChzdWIpKTsKICAgICAgICAgICAgaWYgKHYzICYmIHYzLmNoYXJBdCh2My5sZW5ndGggLSAxKSAhPT0gIi4iKSB7CiAgICAgICAgICAgICAgdjMgKz0gIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2My5pbmRleE9mKCI6IikgIT09IC0xKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiRG9tYWlucyBjYW5ub3QgY29udGFpbiBjb2xvbnMiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodjMpIHsKICAgICAgICAgICAgICBVUkkuZW5zdXJlVmFsaWRIb3N0bmFtZSh2MywgdGhpcy5fcGFydHMucHJvdG9jb2wpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3BhcnRzLmhvc3RuYW1lID0gdGhpcy5fcGFydHMuaG9zdG5hbWUucmVwbGFjZShyZXBsYWNlLCB2Myk7CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLmRvbWFpbiA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdjMgPT09ICJib29sZWFuIikgewogICAgICAgICAgICBidWlsZCA9IHYzOwogICAgICAgICAgICB2MyA9IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5fcGFydHMuaG9zdG5hbWUgfHwgdGhpcy5pcygiSVAiKSkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdCA9IHRoaXMuX3BhcnRzLmhvc3RuYW1lLm1hdGNoKC9cLi9nKTsKICAgICAgICAgICAgaWYgKHQgJiYgdC5sZW5ndGggPCAyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnRzLmhvc3RuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbmQgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5sZW5ndGggLSB0aGlzLnRsZChidWlsZCkubGVuZ3RoIC0gMTsKICAgICAgICAgICAgZW5kID0gdGhpcy5fcGFydHMuaG9zdG5hbWUubGFzdEluZGV4T2YoIi4iLCBlbmQgLSAxKSArIDE7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5zdWJzdHJpbmcoZW5kKSB8fCAiIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICghdjMpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJjYW5ub3Qgc2V0IGRvbWFpbiBlbXB0eSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2My5pbmRleE9mKCI6IikgIT09IC0xKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiRG9tYWlucyBjYW5ub3QgY29udGFpbiBjb2xvbnMiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBVUkkuZW5zdXJlVmFsaWRIb3N0bmFtZSh2MywgdGhpcy5fcGFydHMucHJvdG9jb2wpOwogICAgICAgICAgICBpZiAoIXRoaXMuX3BhcnRzLmhvc3RuYW1lIHx8IHRoaXMuaXMoIklQIikpIHsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5ob3N0bmFtZSA9IHYzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByZXBsYWNlID0gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeCh0aGlzLmRvbWFpbigpKSArICIkIik7CiAgICAgICAgICAgICAgdGhpcy5fcGFydHMuaG9zdG5hbWUgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5yZXBsYWNlKHJlcGxhY2UsIHYzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcC50bGQgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHYzID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgYnVpbGQgPSB2MzsKICAgICAgICAgICAgdjMgPSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAoIXRoaXMuX3BhcnRzLmhvc3RuYW1lIHx8IHRoaXMuaXMoIklQIikpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBvcyA9IHRoaXMuX3BhcnRzLmhvc3RuYW1lLmxhc3RJbmRleE9mKCIuIik7CiAgICAgICAgICAgIHZhciB0bGQgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5zdWJzdHJpbmcocG9zICsgMSk7CiAgICAgICAgICAgIGlmIChidWlsZCAhPT0gdHJ1ZSAmJiBTTEQgJiYgU0xELmxpc3RbdGxkLnRvTG93ZXJDYXNlKCldKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFNMRC5nZXQodGhpcy5fcGFydHMuaG9zdG5hbWUpIHx8IHRsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGxkOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJlcGxhY2U7CiAgICAgICAgICAgIGlmICghdjMpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJjYW5ub3Qgc2V0IFRMRCBlbXB0eSIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHYzLm1hdGNoKC9bXmEtekEtWjAtOS1dLykpIHsKICAgICAgICAgICAgICBpZiAoU0xEICYmIFNMRC5pcyh2MykpIHsKICAgICAgICAgICAgICAgIHJlcGxhY2UgPSBuZXcgUmVnRXhwKGVzY2FwZVJlZ0V4KHRoaXMudGxkKCkpICsgIiQiKTsKICAgICAgICAgICAgICAgIHRoaXMuX3BhcnRzLmhvc3RuYW1lID0gdGhpcy5fcGFydHMuaG9zdG5hbWUucmVwbGFjZShyZXBsYWNlLCB2Myk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1RMRCAiJyArIHYzICsgJyIgY29udGFpbnMgY2hhcmFjdGVycyBvdGhlciB0aGFuIFtBLVowLTldJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLl9wYXJ0cy5ob3N0bmFtZSB8fCB0aGlzLmlzKCJJUCIpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCJjYW5ub3Qgc2V0IFRMRCBvbiBub24tZG9tYWluIGhvc3QiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXBsYWNlID0gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeCh0aGlzLnRsZCgpKSArICIkIik7CiAgICAgICAgICAgICAgdGhpcy5fcGFydHMuaG9zdG5hbWUgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS5yZXBsYWNlKHJlcGxhY2UsIHYzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcC5kaXJlY3RvcnkgPSBmdW5jdGlvbih2MywgYnVpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy51cm4pIHsKICAgICAgICAgICAgcmV0dXJuIHYzID09PSB2b2lkIDAgPyAiIiA6IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCB8fCB2MyA9PT0gdHJ1ZSkgewogICAgICAgICAgICBpZiAoIXRoaXMuX3BhcnRzLnBhdGggJiYgIXRoaXMuX3BhcnRzLmhvc3RuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy5wYXRoID09PSAiLyIpIHsKICAgICAgICAgICAgICByZXR1cm4gIi8iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbmQgPSB0aGlzLl9wYXJ0cy5wYXRoLmxlbmd0aCAtIHRoaXMuZmlsZW5hbWUoKS5sZW5ndGggLSAxOwogICAgICAgICAgICB2YXIgcmVzID0gdGhpcy5fcGFydHMucGF0aC5zdWJzdHJpbmcoMCwgZW5kKSB8fCAodGhpcy5fcGFydHMuaG9zdG5hbWUgPyAiLyIgOiAiIik7CiAgICAgICAgICAgIHJldHVybiB2MyA/IFVSSS5kZWNvZGVQYXRoKHJlcykgOiByZXM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZSA9IHRoaXMuX3BhcnRzLnBhdGgubGVuZ3RoIC0gdGhpcy5maWxlbmFtZSgpLmxlbmd0aDsKICAgICAgICAgICAgdmFyIGRpcmVjdG9yeSA9IHRoaXMuX3BhcnRzLnBhdGguc3Vic3RyaW5nKDAsIGUpOwogICAgICAgICAgICB2YXIgcmVwbGFjZSA9IG5ldyBSZWdFeHAoIl4iICsgZXNjYXBlUmVnRXgoZGlyZWN0b3J5KSk7CiAgICAgICAgICAgIGlmICghdGhpcy5pcygicmVsYXRpdmUiKSkgewogICAgICAgICAgICAgIGlmICghdjMpIHsKICAgICAgICAgICAgICAgIHYzID0gIi8iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodjMuY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgICAgIHYzID0gIi8iICsgdjM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2MyAmJiB2My5jaGFyQXQodjMubGVuZ3RoIC0gMSkgIT09ICIvIikgewogICAgICAgICAgICAgIHYzICs9ICIvIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2MyA9IFVSSS5yZWNvZGVQYXRoKHYzKTsKICAgICAgICAgICAgdGhpcy5fcGFydHMucGF0aCA9IHRoaXMuX3BhcnRzLnBhdGgucmVwbGFjZShyZXBsYWNlLCB2Myk7CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLmZpbGVuYW1lID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB2MyA9PT0gdm9pZCAwID8gIiIgOiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB2MyAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLl9wYXJ0cy5wYXRoIHx8IHRoaXMuX3BhcnRzLnBhdGggPT09ICIvIikgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcG9zID0gdGhpcy5fcGFydHMucGF0aC5sYXN0SW5kZXhPZigiLyIpOwogICAgICAgICAgICB2YXIgcmVzID0gdGhpcy5fcGFydHMucGF0aC5zdWJzdHJpbmcocG9zICsgMSk7CiAgICAgICAgICAgIHJldHVybiB2MyA/IFVSSS5kZWNvZGVQYXRoU2VnbWVudChyZXMpIDogcmVzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG11dGF0ZWREaXJlY3RvcnkgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHYzLmNoYXJBdCgwKSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgdjMgPSB2My5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHYzLm1hdGNoKC9cLj9cLy8pKSB7CiAgICAgICAgICAgICAgbXV0YXRlZERpcmVjdG9yeSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlcGxhY2UgPSBuZXcgUmVnRXhwKGVzY2FwZVJlZ0V4KHRoaXMuZmlsZW5hbWUoKSkgKyAiJCIpOwogICAgICAgICAgICB2MyA9IFVSSS5yZWNvZGVQYXRoKHYzKTsKICAgICAgICAgICAgdGhpcy5fcGFydHMucGF0aCA9IHRoaXMuX3BhcnRzLnBhdGgucmVwbGFjZShyZXBsYWNlLCB2Myk7CiAgICAgICAgICAgIGlmIChtdXRhdGVkRGlyZWN0b3J5KSB7CiAgICAgICAgICAgICAgdGhpcy5ub3JtYWxpemVQYXRoKGJ1aWxkKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLnN1ZmZpeCA9IGZ1bmN0aW9uKHYzLCBidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLnVybikgewogICAgICAgICAgICByZXR1cm4gdjMgPT09IHZvaWQgMCA/ICIiIDogdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2MyA9PT0gdm9pZCAwIHx8IHYzID09PSB0cnVlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5fcGFydHMucGF0aCB8fCB0aGlzLl9wYXJ0cy5wYXRoID09PSAiLyIpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpbGVuYW1lID0gdGhpcy5maWxlbmFtZSgpOwogICAgICAgICAgICB2YXIgcG9zID0gZmlsZW5hbWUubGFzdEluZGV4T2YoIi4iKTsKICAgICAgICAgICAgdmFyIHMsIHJlczsKICAgICAgICAgICAgaWYgKHBvcyA9PT0gLTEpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcyA9IGZpbGVuYW1lLnN1YnN0cmluZyhwb3MgKyAxKTsKICAgICAgICAgICAgcmVzID0gL15bYS16MC05JV0rJC9pLnRlc3QocykgPyBzIDogIiI7CiAgICAgICAgICAgIHJldHVybiB2MyA/IFVSSS5kZWNvZGVQYXRoU2VnbWVudChyZXMpIDogcmVzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHYzLmNoYXJBdCgwKSA9PT0gIi4iKSB7CiAgICAgICAgICAgICAgdjMgPSB2My5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHN1ZmZpeCA9IHRoaXMuc3VmZml4KCk7CiAgICAgICAgICAgIHZhciByZXBsYWNlOwogICAgICAgICAgICBpZiAoIXN1ZmZpeCkgewogICAgICAgICAgICAgIGlmICghdjMpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5wYXRoICs9ICIuIiArIFVSSS5yZWNvZGVQYXRoKHYzKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghdjMpIHsKICAgICAgICAgICAgICByZXBsYWNlID0gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeCgiLiIgKyBzdWZmaXgpICsgIiQiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXBsYWNlID0gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeChzdWZmaXgpICsgIiQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVwbGFjZSkgewogICAgICAgICAgICAgIHYzID0gVVJJLnJlY29kZVBhdGgodjMpOwogICAgICAgICAgICAgIHRoaXMuX3BhcnRzLnBhdGggPSB0aGlzLl9wYXJ0cy5wYXRoLnJlcGxhY2UocmVwbGFjZSwgdjMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLnNlZ21lbnQgPSBmdW5jdGlvbihzZWdtZW50LCB2MywgYnVpbGQpIHsKICAgICAgICAgIHZhciBzZXBhcmF0b3IgPSB0aGlzLl9wYXJ0cy51cm4gPyAiOiIgOiAiLyI7CiAgICAgICAgICB2YXIgcGF0aCA9IHRoaXMucGF0aCgpOwogICAgICAgICAgdmFyIGFic29sdXRlID0gcGF0aC5zdWJzdHJpbmcoMCwgMSkgPT09ICIvIjsKICAgICAgICAgIHZhciBzZWdtZW50cyA9IHBhdGguc3BsaXQoc2VwYXJhdG9yKTsKICAgICAgICAgIGlmIChzZWdtZW50ICE9PSB2b2lkIDAgJiYgdHlwZW9mIHNlZ21lbnQgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIGJ1aWxkID0gdjM7CiAgICAgICAgICAgIHYzID0gc2VnbWVudDsKICAgICAgICAgICAgc2VnbWVudCA9IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzZWdtZW50ICE9PSB2b2lkIDAgJiYgdHlwZW9mIHNlZ21lbnQgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQmFkIHNlZ21lbnQgIicgKyBzZWdtZW50ICsgJyIsIG11c3QgYmUgMC1iYXNlZCBpbnRlZ2VyJyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYWJzb2x1dGUpIHsKICAgICAgICAgICAgc2VnbWVudHMuc2hpZnQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzZWdtZW50IDwgMCkgewogICAgICAgICAgICBzZWdtZW50ID0gTWF0aC5tYXgoc2VnbWVudHMubGVuZ3RoICsgc2VnbWVudCwgMCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gc2VnbWVudCA9PT0gdm9pZCAwID8gc2VnbWVudHMgOiBzZWdtZW50c1tzZWdtZW50XTsKICAgICAgICAgIH0gZWxzZSBpZiAoc2VnbWVudCA9PT0gbnVsbCB8fCBzZWdtZW50c1tzZWdtZW50XSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChpc0FycmF5KHYzKSkgewogICAgICAgICAgICAgIHNlZ21lbnRzID0gW107CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB2My5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICghdjNbaV0ubGVuZ3RoICYmICghc2VnbWVudHMubGVuZ3RoIHx8ICFzZWdtZW50c1tzZWdtZW50cy5sZW5ndGggLSAxXS5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHNlZ21lbnRzLmxlbmd0aCAmJiAhc2VnbWVudHNbc2VnbWVudHMubGVuZ3RoIC0gMV0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHNlZ21lbnRzLnBvcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaCh0cmltU2xhc2hlcyh2M1tpXSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh2MyB8fCB0eXBlb2YgdjMgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgdjMgPSB0cmltU2xhc2hlcyh2Myk7CiAgICAgICAgICAgICAgaWYgKHNlZ21lbnRzW3NlZ21lbnRzLmxlbmd0aCAtIDFdID09PSAiIikgewogICAgICAgICAgICAgICAgc2VnbWVudHNbc2VnbWVudHMubGVuZ3RoIC0gMV0gPSB2MzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaCh2Myk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodjMpIHsKICAgICAgICAgICAgICBzZWdtZW50c1tzZWdtZW50XSA9IHRyaW1TbGFzaGVzKHYzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZWdtZW50cy5zcGxpY2Uoc2VnbWVudCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChhYnNvbHV0ZSkgewogICAgICAgICAgICBzZWdtZW50cy51bnNoaWZ0KCIiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzLnBhdGgoc2VnbWVudHMuam9pbihzZXBhcmF0b3IpLCBidWlsZCk7CiAgICAgICAgfTsKICAgICAgICBwLnNlZ21lbnRDb2RlZCA9IGZ1bmN0aW9uKHNlZ21lbnQsIHYzLCBidWlsZCkgewogICAgICAgICAgdmFyIHNlZ21lbnRzLCBpLCBsOwogICAgICAgICAgaWYgKHR5cGVvZiBzZWdtZW50ICE9PSAibnVtYmVyIikgewogICAgICAgICAgICBidWlsZCA9IHYzOwogICAgICAgICAgICB2MyA9IHNlZ21lbnQ7CiAgICAgICAgICAgIHNlZ21lbnQgPSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjMgPT09IHZvaWQgMCkgewogICAgICAgICAgICBzZWdtZW50cyA9IHRoaXMuc2VnbWVudChzZWdtZW50LCB2MywgYnVpbGQpOwogICAgICAgICAgICBpZiAoIWlzQXJyYXkoc2VnbWVudHMpKSB7CiAgICAgICAgICAgICAgc2VnbWVudHMgPSBzZWdtZW50cyAhPT0gdm9pZCAwID8gVVJJLmRlY29kZShzZWdtZW50cykgOiB2b2lkIDA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHNlZ21lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgc2VnbWVudHNbaV0gPSBVUkkuZGVjb2RlKHNlZ21lbnRzW2ldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlZ21lbnRzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0FycmF5KHYzKSkgewogICAgICAgICAgICB2MyA9IHR5cGVvZiB2MyA9PT0gInN0cmluZyIgfHwgdjMgaW5zdGFuY2VvZiBTdHJpbmcgPyBVUkkuZW5jb2RlKHYzKSA6IHYzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IHYzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgIHYzW2ldID0gVVJJLmVuY29kZSh2M1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzLnNlZ21lbnQoc2VnbWVudCwgdjMsIGJ1aWxkKTsKICAgICAgICB9OwogICAgICAgIHZhciBxID0gcC5xdWVyeTsKICAgICAgICBwLnF1ZXJ5ID0gZnVuY3Rpb24odjMsIGJ1aWxkKSB7CiAgICAgICAgICBpZiAodjMgPT09IHRydWUpIHsKICAgICAgICAgICAgcmV0dXJuIFVSSS5wYXJzZVF1ZXJ5KHRoaXMuX3BhcnRzLnF1ZXJ5LCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHYzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBkYXRhID0gVVJJLnBhcnNlUXVlcnkodGhpcy5fcGFydHMucXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gdjMuY2FsbCh0aGlzLCBkYXRhKTsKICAgICAgICAgICAgdGhpcy5fcGFydHMucXVlcnkgPSBVUkkuYnVpbGRRdWVyeShyZXN1bHQgfHwgZGF0YSwgdGhpcy5fcGFydHMuZHVwbGljYXRlUXVlcnlQYXJhbWV0ZXJzLCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0gZWxzZSBpZiAodjMgIT09IHZvaWQgMCAmJiB0eXBlb2YgdjMgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHRoaXMuX3BhcnRzLnF1ZXJ5ID0gVVJJLmJ1aWxkUXVlcnkodjMsIHRoaXMuX3BhcnRzLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycywgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICAgIHRoaXMuYnVpbGQoIWJ1aWxkKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gcS5jYWxsKHRoaXMsIHYzLCBidWlsZCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBwLnNldFF1ZXJ5ID0gZnVuY3Rpb24obmFtZSwgdmFsdWUsIGJ1aWxkKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IFVSSS5wYXJzZVF1ZXJ5KHRoaXMuX3BhcnRzLnF1ZXJ5LCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgfHwgbmFtZSBpbnN0YW5jZW9mIFN0cmluZykgewogICAgICAgICAgICBkYXRhW25hbWVdID0gdmFsdWUgIT09IHZvaWQgMCA/IHZhbHVlIDogbnVsbDsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5hbWUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKG5hbWUsIGtleSkpIHsKICAgICAgICAgICAgICAgIGRhdGFba2V5XSA9IG5hbWVba2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlVSSS5hZGRRdWVyeSgpIGFjY2VwdHMgYW4gb2JqZWN0LCBzdHJpbmcgYXMgdGhlIG5hbWUgcGFyYW1ldGVyIik7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9wYXJ0cy5xdWVyeSA9IFVSSS5idWlsZFF1ZXJ5KGRhdGEsIHRoaXMuX3BhcnRzLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycywgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGJ1aWxkID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuYWRkUXVlcnkgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSwgYnVpbGQpIHsKICAgICAgICAgIHZhciBkYXRhID0gVVJJLnBhcnNlUXVlcnkodGhpcy5fcGFydHMucXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgVVJJLmFkZFF1ZXJ5KGRhdGEsIG5hbWUsIHZhbHVlID09PSB2b2lkIDAgPyBudWxsIDogdmFsdWUpOwogICAgICAgICAgdGhpcy5fcGFydHMucXVlcnkgPSBVUkkuYnVpbGRRdWVyeShkYXRhLCB0aGlzLl9wYXJ0cy5kdXBsaWNhdGVRdWVyeVBhcmFtZXRlcnMsIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgaWYgKHR5cGVvZiBuYW1lICE9PSAic3RyaW5nIikgewogICAgICAgICAgICBidWlsZCA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLnJlbW92ZVF1ZXJ5ID0gZnVuY3Rpb24obmFtZSwgdmFsdWUsIGJ1aWxkKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IFVSSS5wYXJzZVF1ZXJ5KHRoaXMuX3BhcnRzLnF1ZXJ5LCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKTsKICAgICAgICAgIFVSSS5yZW1vdmVRdWVyeShkYXRhLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICB0aGlzLl9wYXJ0cy5xdWVyeSA9IFVSSS5idWlsZFF1ZXJ5KGRhdGEsIHRoaXMuX3BhcnRzLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycywgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGJ1aWxkID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuaGFzUXVlcnkgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSwgd2l0aGluQXJyYXkpIHsKICAgICAgICAgIHZhciBkYXRhID0gVVJJLnBhcnNlUXVlcnkodGhpcy5fcGFydHMucXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgcmV0dXJuIFVSSS5oYXNRdWVyeShkYXRhLCBuYW1lLCB2YWx1ZSwgd2l0aGluQXJyYXkpOwogICAgICAgIH07CiAgICAgICAgcC5zZXRTZWFyY2ggPSBwLnNldFF1ZXJ5OwogICAgICAgIHAuYWRkU2VhcmNoID0gcC5hZGRRdWVyeTsKICAgICAgICBwLnJlbW92ZVNlYXJjaCA9IHAucmVtb3ZlUXVlcnk7CiAgICAgICAgcC5oYXNTZWFyY2ggPSBwLmhhc1F1ZXJ5OwogICAgICAgIHAubm9ybWFsaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZVByb3RvY29sKGZhbHNlKS5ub3JtYWxpemVQYXRoKGZhbHNlKS5ub3JtYWxpemVRdWVyeShmYWxzZSkubm9ybWFsaXplRnJhZ21lbnQoZmFsc2UpLmJ1aWxkKCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVQcm90b2NvbChmYWxzZSkubm9ybWFsaXplSG9zdG5hbWUoZmFsc2UpLm5vcm1hbGl6ZVBvcnQoZmFsc2UpLm5vcm1hbGl6ZVBhdGgoZmFsc2UpLm5vcm1hbGl6ZVF1ZXJ5KGZhbHNlKS5ub3JtYWxpemVGcmFnbWVudChmYWxzZSkuYnVpbGQoKTsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplUHJvdG9jb2wgPSBmdW5jdGlvbihidWlsZCkgewogICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9wYXJ0cy5wcm90b2NvbCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdGhpcy5fcGFydHMucHJvdG9jb2wgPSB0aGlzLl9wYXJ0cy5wcm90b2NvbC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplSG9zdG5hbWUgPSBmdW5jdGlvbihidWlsZCkgewogICAgICAgICAgaWYgKHRoaXMuX3BhcnRzLmhvc3RuYW1lKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzKCJJRE4iKSAmJiBwdW55Y29kZSkgewogICAgICAgICAgICAgIHRoaXMuX3BhcnRzLmhvc3RuYW1lID0gcHVueWNvZGUudG9BU0NJSSh0aGlzLl9wYXJ0cy5ob3N0bmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pcygiSVB2NiIpICYmIElQdjYpIHsKICAgICAgICAgICAgICB0aGlzLl9wYXJ0cy5ob3N0bmFtZSA9IElQdjYuYmVzdCh0aGlzLl9wYXJ0cy5ob3N0bmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fcGFydHMuaG9zdG5hbWUgPSB0aGlzLl9wYXJ0cy5ob3N0bmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplUG9ydCA9IGZ1bmN0aW9uKGJ1aWxkKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuX3BhcnRzLnByb3RvY29sID09PSAic3RyaW5nIiAmJiB0aGlzLl9wYXJ0cy5wb3J0ID09PSBVUkkuZGVmYXVsdFBvcnRzW3RoaXMuX3BhcnRzLnByb3RvY29sXSkgewogICAgICAgICAgICB0aGlzLl9wYXJ0cy5wb3J0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLm5vcm1hbGl6ZVBhdGggPSBmdW5jdGlvbihidWlsZCkgewogICAgICAgICAgdmFyIF9wYXRoID0gdGhpcy5fcGFydHMucGF0aDsKICAgICAgICAgIGlmICghX3BhdGgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHRoaXMuX3BhcnRzLnBhdGggPSBVUkkucmVjb2RlVXJuUGF0aCh0aGlzLl9wYXJ0cy5wYXRoKTsKICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy5wYXRoID09PSAiLyIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBfcGF0aCA9IFVSSS5yZWNvZGVQYXRoKF9wYXRoKTsKICAgICAgICAgIHZhciBfd2FzX3JlbGF0aXZlOwogICAgICAgICAgdmFyIF9sZWFkaW5nUGFyZW50cyA9ICIiOwogICAgICAgICAgdmFyIF9wYXJlbnQsIF9wb3M7CiAgICAgICAgICBpZiAoX3BhdGguY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgX3dhc19yZWxhdGl2ZSA9IHRydWU7CiAgICAgICAgICAgIF9wYXRoID0gIi8iICsgX3BhdGg7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoX3BhdGguc2xpY2UoLTMpID09PSAiLy4uIiB8fCBfcGF0aC5zbGljZSgtMikgPT09ICIvLiIpIHsKICAgICAgICAgICAgX3BhdGggKz0gIi8iOwogICAgICAgICAgfQogICAgICAgICAgX3BhdGggPSBfcGF0aC5yZXBsYWNlKC8oXC8oXC5cLykrKXwoXC9cLiQpL2csICIvIikucmVwbGFjZSgvXC97Mix9L2csICIvIik7CiAgICAgICAgICBpZiAoX3dhc19yZWxhdGl2ZSkgewogICAgICAgICAgICBfbGVhZGluZ1BhcmVudHMgPSBfcGF0aC5zdWJzdHJpbmcoMSkubWF0Y2goL14oXC5cLlwvKSsvKSB8fCAiIjsKICAgICAgICAgICAgaWYgKF9sZWFkaW5nUGFyZW50cykgewogICAgICAgICAgICAgIF9sZWFkaW5nUGFyZW50cyA9IF9sZWFkaW5nUGFyZW50c1swXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgX3BhcmVudCA9IF9wYXRoLnNlYXJjaCgvXC9cLlwuKFwvfCQpLyk7CiAgICAgICAgICAgIGlmIChfcGFyZW50ID09PSAtMSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgaWYgKF9wYXJlbnQgPT09IDApIHsKICAgICAgICAgICAgICBfcGF0aCA9IF9wYXRoLnN1YnN0cmluZygzKTsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBfcG9zID0gX3BhdGguc3Vic3RyaW5nKDAsIF9wYXJlbnQpLmxhc3RJbmRleE9mKCIvIik7CiAgICAgICAgICAgIGlmIChfcG9zID09PSAtMSkgewogICAgICAgICAgICAgIF9wb3MgPSBfcGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIF9wYXRoID0gX3BhdGguc3Vic3RyaW5nKDAsIF9wb3MpICsgX3BhdGguc3Vic3RyaW5nKF9wYXJlbnQgKyAzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChfd2FzX3JlbGF0aXZlICYmIHRoaXMuaXMoInJlbGF0aXZlIikpIHsKICAgICAgICAgICAgX3BhdGggPSBfbGVhZGluZ1BhcmVudHMgKyBfcGF0aC5zdWJzdHJpbmcoMSk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9wYXJ0cy5wYXRoID0gX3BhdGg7CiAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplUGF0aG5hbWUgPSBwLm5vcm1hbGl6ZVBhdGg7CiAgICAgICAgcC5ub3JtYWxpemVRdWVyeSA9IGZ1bmN0aW9uKGJ1aWxkKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuX3BhcnRzLnF1ZXJ5ID09PSAic3RyaW5nIikgewogICAgICAgICAgICBpZiAoIXRoaXMuX3BhcnRzLnF1ZXJ5Lmxlbmd0aCkgewogICAgICAgICAgICAgIHRoaXMuX3BhcnRzLnF1ZXJ5ID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLnF1ZXJ5KFVSSS5wYXJzZVF1ZXJ5KHRoaXMuX3BhcnRzLnF1ZXJ5LCB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5idWlsZCghYnVpbGQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLm5vcm1hbGl6ZUZyYWdtZW50ID0gZnVuY3Rpb24oYnVpbGQpIHsKICAgICAgICAgIGlmICghdGhpcy5fcGFydHMuZnJhZ21lbnQpIHsKICAgICAgICAgICAgdGhpcy5fcGFydHMuZnJhZ21lbnQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmJ1aWxkKCFidWlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAubm9ybWFsaXplU2VhcmNoID0gcC5ub3JtYWxpemVRdWVyeTsKICAgICAgICBwLm5vcm1hbGl6ZUhhc2ggPSBwLm5vcm1hbGl6ZUZyYWdtZW50OwogICAgICAgIHAuaXNvODg1OSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGUgPSBVUkkuZW5jb2RlOwogICAgICAgICAgdmFyIGQgPSBVUkkuZGVjb2RlOwogICAgICAgICAgVVJJLmVuY29kZSA9IGVzY2FwZTsKICAgICAgICAgIFVSSS5kZWNvZGUgPSBkZWNvZGVVUklDb21wb25lbnQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLm5vcm1hbGl6ZSgpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgVVJJLmVuY29kZSA9IGU7CiAgICAgICAgICAgIFVSSS5kZWNvZGUgPSBkOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLnVuaWNvZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBlID0gVVJJLmVuY29kZTsKICAgICAgICAgIHZhciBkID0gVVJJLmRlY29kZTsKICAgICAgICAgIFVSSS5lbmNvZGUgPSBzdHJpY3RFbmNvZGVVUklDb21wb25lbnQ7CiAgICAgICAgICBVUkkuZGVjb2RlID0gdW5lc2NhcGU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLm5vcm1hbGl6ZSgpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgVVJJLmVuY29kZSA9IGU7CiAgICAgICAgICAgIFVSSS5kZWNvZGUgPSBkOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfTsKICAgICAgICBwLnJlYWRhYmxlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdXJpID0gdGhpcy5jbG9uZSgpOwogICAgICAgICAgdXJpLnVzZXJuYW1lKCIiKS5wYXNzd29yZCgiIikubm9ybWFsaXplKCk7CiAgICAgICAgICB2YXIgdCA9ICIiOwogICAgICAgICAgaWYgKHVyaS5fcGFydHMucHJvdG9jb2wpIHsKICAgICAgICAgICAgdCArPSB1cmkuX3BhcnRzLnByb3RvY29sICsgIjovLyI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodXJpLl9wYXJ0cy5ob3N0bmFtZSkgewogICAgICAgICAgICBpZiAodXJpLmlzKCJwdW55Y29kZSIpICYmIHB1bnljb2RlKSB7CiAgICAgICAgICAgICAgdCArPSBwdW55Y29kZS50b1VuaWNvZGUodXJpLl9wYXJ0cy5ob3N0bmFtZSk7CiAgICAgICAgICAgICAgaWYgKHVyaS5fcGFydHMucG9ydCkgewogICAgICAgICAgICAgICAgdCArPSAiOiIgKyB1cmkuX3BhcnRzLnBvcnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHQgKz0gdXJpLmhvc3QoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHVyaS5fcGFydHMuaG9zdG5hbWUgJiYgdXJpLl9wYXJ0cy5wYXRoICYmIHVyaS5fcGFydHMucGF0aC5jaGFyQXQoMCkgIT09ICIvIikgewogICAgICAgICAgICB0ICs9ICIvIjsKICAgICAgICAgIH0KICAgICAgICAgIHQgKz0gdXJpLnBhdGgodHJ1ZSk7CiAgICAgICAgICBpZiAodXJpLl9wYXJ0cy5xdWVyeSkgewogICAgICAgICAgICB2YXIgcTMgPSAiIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIHFwID0gdXJpLl9wYXJ0cy5xdWVyeS5zcGxpdCgiJiIpLCBsID0gcXAubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGt2ID0gKHFwW2ldIHx8ICIiKS5zcGxpdCgiPSIpOwogICAgICAgICAgICAgIHEzICs9ICImIiArIFVSSS5kZWNvZGVRdWVyeShrdlswXSwgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSkucmVwbGFjZSgvJi9nLCAiJTI2Iik7CiAgICAgICAgICAgICAgaWYgKGt2WzFdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHEzICs9ICI9IiArIFVSSS5kZWNvZGVRdWVyeShrdlsxXSwgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSkucmVwbGFjZSgvJi9nLCAiJTI2Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHQgKz0gIj8iICsgcTMuc3Vic3RyaW5nKDEpOwogICAgICAgICAgfQogICAgICAgICAgdCArPSBVUkkuZGVjb2RlUXVlcnkodXJpLmhhc2goKSwgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gdDsKICAgICAgICB9OwogICAgICAgIHAuYWJzb2x1dGVUbyA9IGZ1bmN0aW9uKGJhc2UpIHsKICAgICAgICAgIHZhciByZXNvbHZlZCA9IHRoaXMuY2xvbmUoKTsKICAgICAgICAgIHZhciBwcm9wZXJ0aWVzID0gWyJwcm90b2NvbCIsICJ1c2VybmFtZSIsICJwYXNzd29yZCIsICJob3N0bmFtZSIsICJwb3J0Il07CiAgICAgICAgICB2YXIgYmFzZWRpciwgaSwgcDI7CiAgICAgICAgICBpZiAodGhpcy5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVVJOcyBkbyBub3QgaGF2ZSBhbnkgZ2VuZXJhbGx5IGRlZmluZWQgaGllcmFyY2hpY2FsIGNvbXBvbmVudHMiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghKGJhc2UgaW5zdGFuY2VvZiBVUkkpKSB7CiAgICAgICAgICAgIGJhc2UgPSBuZXcgVVJJKGJhc2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlc29sdmVkLl9wYXJ0cy5wcm90b2NvbCkgewogICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNvbHZlZC5fcGFydHMucHJvdG9jb2wgPSBiYXNlLl9wYXJ0cy5wcm90b2NvbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLl9wYXJ0cy5ob3N0bmFtZSkgewogICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGkgPSAwOyBwMiA9IHByb3BlcnRpZXNbaV07IGkrKykgewogICAgICAgICAgICByZXNvbHZlZC5fcGFydHNbcDJdID0gYmFzZS5fcGFydHNbcDJdOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFyZXNvbHZlZC5fcGFydHMucGF0aCkgewogICAgICAgICAgICByZXNvbHZlZC5fcGFydHMucGF0aCA9IGJhc2UuX3BhcnRzLnBhdGg7CiAgICAgICAgICAgIGlmICghcmVzb2x2ZWQuX3BhcnRzLnF1ZXJ5KSB7CiAgICAgICAgICAgICAgcmVzb2x2ZWQuX3BhcnRzLnF1ZXJ5ID0gYmFzZS5fcGFydHMucXVlcnk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlZC5fcGFydHMucGF0aC5zdWJzdHJpbmcoLTIpID09PSAiLi4iKSB7CiAgICAgICAgICAgICAgcmVzb2x2ZWQuX3BhcnRzLnBhdGggKz0gIi8iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXNvbHZlZC5wYXRoKCkuY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgICBiYXNlZGlyID0gYmFzZS5kaXJlY3RvcnkoKTsKICAgICAgICAgICAgICBiYXNlZGlyID0gYmFzZWRpciA/IGJhc2VkaXIgOiBiYXNlLnBhdGgoKS5pbmRleE9mKCIvIikgPT09IDAgPyAiLyIgOiAiIjsKICAgICAgICAgICAgICByZXNvbHZlZC5fcGFydHMucGF0aCA9IChiYXNlZGlyID8gYmFzZWRpciArICIvIiA6ICIiKSArIHJlc29sdmVkLl9wYXJ0cy5wYXRoOwogICAgICAgICAgICAgIHJlc29sdmVkLm5vcm1hbGl6ZVBhdGgoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVzb2x2ZWQuYnVpbGQoKTsKICAgICAgICAgIHJldHVybiByZXNvbHZlZDsKICAgICAgICB9OwogICAgICAgIHAucmVsYXRpdmVUbyA9IGZ1bmN0aW9uKGJhc2UpIHsKICAgICAgICAgIHZhciByZWxhdGl2ZSA9IHRoaXMuY2xvbmUoKS5ub3JtYWxpemUoKTsKICAgICAgICAgIHZhciByZWxhdGl2ZVBhcnRzLCBiYXNlUGFydHMsIGNvbW1vbiwgcmVsYXRpdmVQYXRoLCBiYXNlUGF0aDsKICAgICAgICAgIGlmIChyZWxhdGl2ZS5fcGFydHMudXJuKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVVJOcyBkbyBub3QgaGF2ZSBhbnkgZ2VuZXJhbGx5IGRlZmluZWQgaGllcmFyY2hpY2FsIGNvbXBvbmVudHMiKTsKICAgICAgICAgIH0KICAgICAgICAgIGJhc2UgPSBuZXcgVVJJKGJhc2UpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgcmVsYXRpdmVQYXJ0cyA9IHJlbGF0aXZlLl9wYXJ0czsKICAgICAgICAgIGJhc2VQYXJ0cyA9IGJhc2UuX3BhcnRzOwogICAgICAgICAgcmVsYXRpdmVQYXRoID0gcmVsYXRpdmUucGF0aCgpOwogICAgICAgICAgYmFzZVBhdGggPSBiYXNlLnBhdGgoKTsKICAgICAgICAgIGlmIChyZWxhdGl2ZVBhdGguY2hhckF0KDApICE9PSAiLyIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVUkkgaXMgYWxyZWFkeSByZWxhdGl2ZSIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJhc2VQYXRoLmNoYXJBdCgwKSAhPT0gIi8iKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGNhbGN1bGF0ZSBhIFVSSSByZWxhdGl2ZSB0byBhbm90aGVyIHJlbGF0aXZlIFVSSSIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlbGF0aXZlUGFydHMucHJvdG9jb2wgPT09IGJhc2VQYXJ0cy5wcm90b2NvbCkgewogICAgICAgICAgICByZWxhdGl2ZVBhcnRzLnByb3RvY29sID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZWxhdGl2ZVBhcnRzLnVzZXJuYW1lICE9PSBiYXNlUGFydHMudXNlcm5hbWUgfHwgcmVsYXRpdmVQYXJ0cy5wYXNzd29yZCAhPT0gYmFzZVBhcnRzLnBhc3N3b3JkKSB7CiAgICAgICAgICAgIHJldHVybiByZWxhdGl2ZS5idWlsZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlbGF0aXZlUGFydHMucHJvdG9jb2wgIT09IG51bGwgfHwgcmVsYXRpdmVQYXJ0cy51c2VybmFtZSAhPT0gbnVsbCB8fCByZWxhdGl2ZVBhcnRzLnBhc3N3b3JkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiByZWxhdGl2ZS5idWlsZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlbGF0aXZlUGFydHMuaG9zdG5hbWUgPT09IGJhc2VQYXJ0cy5ob3N0bmFtZSAmJiByZWxhdGl2ZVBhcnRzLnBvcnQgPT09IGJhc2VQYXJ0cy5wb3J0KSB7CiAgICAgICAgICAgIHJlbGF0aXZlUGFydHMuaG9zdG5hbWUgPSBudWxsOwogICAgICAgICAgICByZWxhdGl2ZVBhcnRzLnBvcnQgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHJlbGF0aXZlLmJ1aWxkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVsYXRpdmVQYXRoID09PSBiYXNlUGF0aCkgewogICAgICAgICAgICByZWxhdGl2ZVBhcnRzLnBhdGggPSAiIjsKICAgICAgICAgICAgcmV0dXJuIHJlbGF0aXZlLmJ1aWxkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb21tb24gPSBVUkkuY29tbW9uUGF0aChyZWxhdGl2ZVBhdGgsIGJhc2VQYXRoKTsKICAgICAgICAgIGlmICghY29tbW9uKSB7CiAgICAgICAgICAgIHJldHVybiByZWxhdGl2ZS5idWlsZCgpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBhcmVudHMgPSBiYXNlUGFydHMucGF0aC5zdWJzdHJpbmcoY29tbW9uLmxlbmd0aCkucmVwbGFjZSgvW15cL10qJC8sICIiKS5yZXBsYWNlKC8uKj9cLy9nLCAiLi4vIik7CiAgICAgICAgICByZWxhdGl2ZVBhcnRzLnBhdGggPSBwYXJlbnRzICsgcmVsYXRpdmVQYXJ0cy5wYXRoLnN1YnN0cmluZyhjb21tb24ubGVuZ3RoKSB8fCAiLi8iOwogICAgICAgICAgcmV0dXJuIHJlbGF0aXZlLmJ1aWxkKCk7CiAgICAgICAgfTsKICAgICAgICBwLmVxdWFscyA9IGZ1bmN0aW9uKHVyaSkgewogICAgICAgICAgdmFyIG9uZSA9IHRoaXMuY2xvbmUoKTsKICAgICAgICAgIHZhciB0d28gPSBuZXcgVVJJKHVyaSk7CiAgICAgICAgICB2YXIgb25lX21hcCA9IHt9OwogICAgICAgICAgdmFyIHR3b19tYXAgPSB7fTsKICAgICAgICAgIHZhciBjaGVja2VkID0ge307CiAgICAgICAgICB2YXIgb25lX3F1ZXJ5LCB0d29fcXVlcnksIGtleTsKICAgICAgICAgIG9uZS5ub3JtYWxpemUoKTsKICAgICAgICAgIHR3by5ub3JtYWxpemUoKTsKICAgICAgICAgIGlmIChvbmUudG9TdHJpbmcoKSA9PT0gdHdvLnRvU3RyaW5nKCkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBvbmVfcXVlcnkgPSBvbmUucXVlcnkoKTsKICAgICAgICAgIHR3b19xdWVyeSA9IHR3by5xdWVyeSgpOwogICAgICAgICAgb25lLnF1ZXJ5KCIiKTsKICAgICAgICAgIHR3by5xdWVyeSgiIik7CiAgICAgICAgICBpZiAob25lLnRvU3RyaW5nKCkgIT09IHR3by50b1N0cmluZygpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChvbmVfcXVlcnkubGVuZ3RoICE9PSB0d29fcXVlcnkubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIG9uZV9tYXAgPSBVUkkucGFyc2VRdWVyeShvbmVfcXVlcnksIHRoaXMuX3BhcnRzLmVzY2FwZVF1ZXJ5U3BhY2UpOwogICAgICAgICAgdHdvX21hcCA9IFVSSS5wYXJzZVF1ZXJ5KHR3b19xdWVyeSwgdGhpcy5fcGFydHMuZXNjYXBlUXVlcnlTcGFjZSk7CiAgICAgICAgICBmb3IgKGtleSBpbiBvbmVfbWFwKSB7CiAgICAgICAgICAgIGlmIChoYXNPd24uY2FsbChvbmVfbWFwLCBrZXkpKSB7CiAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KG9uZV9tYXBba2V5XSkpIHsKICAgICAgICAgICAgICAgIGlmIChvbmVfbWFwW2tleV0gIT09IHR3b19tYXBba2V5XSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghYXJyYXlzRXF1YWwob25lX21hcFtrZXldLCB0d29fbWFwW2tleV0pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoZWNrZWRba2V5XSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAoa2V5IGluIHR3b19tYXApIHsKICAgICAgICAgICAgaWYgKGhhc093bi5jYWxsKHR3b19tYXAsIGtleSkpIHsKICAgICAgICAgICAgICBpZiAoIWNoZWNrZWRba2V5XSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfTsKICAgICAgICBwLnByZXZlbnRJbnZhbGlkSG9zdG5hbWUgPSBmdW5jdGlvbih2MykgewogICAgICAgICAgdGhpcy5fcGFydHMucHJldmVudEludmFsaWRIb3N0bmFtZSA9ICEhdjM7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuZHVwbGljYXRlUXVlcnlQYXJhbWV0ZXJzID0gZnVuY3Rpb24odjMpIHsKICAgICAgICAgIHRoaXMuX3BhcnRzLmR1cGxpY2F0ZVF1ZXJ5UGFyYW1ldGVycyA9ICEhdjM7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICAgIHAuZXNjYXBlUXVlcnlTcGFjZSA9IGZ1bmN0aW9uKHYzKSB7CiAgICAgICAgICB0aGlzLl9wYXJ0cy5lc2NhcGVRdWVyeVNwYWNlID0gISF2MzsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIFVSSTsKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9hcHBlbmRGb3J3YXJkU2xhc2guanMKICBmdW5jdGlvbiBhcHBlbmRGb3J3YXJkU2xhc2godXJsKSB7CiAgICBpZiAodXJsLmxlbmd0aCA9PT0gMCB8fCB1cmxbdXJsLmxlbmd0aCAtIDFdICE9PSAiLyIpIHsKICAgICAgdXJsID0gYCR7dXJsfS9gOwogICAgfQogICAgcmV0dXJuIHVybDsKICB9CiAgdmFyIGFwcGVuZEZvcndhcmRTbGFzaF9kZWZhdWx0OwogIHZhciBpbml0X2FwcGVuZEZvcndhcmRTbGFzaCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYXBwZW5kRm9yd2FyZFNsYXNoLmpzIigpIHsKICAgICAgYXBwZW5kRm9yd2FyZFNsYXNoX2RlZmF1bHQgPSBhcHBlbmRGb3J3YXJkU2xhc2g7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9jbG9uZS5qcwogIGZ1bmN0aW9uIGNsb25lKG9iamVjdCwgZGVlcCkgewogICAgaWYgKG9iamVjdCA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqZWN0ICE9PSAib2JqZWN0IikgewogICAgICByZXR1cm4gb2JqZWN0OwogICAgfQogICAgZGVlcCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGRlZXAsIGZhbHNlKTsKICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBvYmplY3QuY29uc3RydWN0b3IoKTsKICAgIGZvciAoY29uc3QgcHJvcGVydHlOYW1lIGluIG9iamVjdCkgewogICAgICBpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KHByb3BlcnR5TmFtZSkpIHsKICAgICAgICBsZXQgdmFsdWUgPSBvYmplY3RbcHJvcGVydHlOYW1lXTsKICAgICAgICBpZiAoZGVlcCkgewogICAgICAgICAgdmFsdWUgPSBjbG9uZSh2YWx1ZSwgZGVlcCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBjbG9uZV9kZWZhdWx0OwogIHZhciBpbml0X2Nsb25lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9jbG9uZS5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGNsb25lX2RlZmF1bHQgPSBjbG9uZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2NvbWJpbmUuanMKICBmdW5jdGlvbiBjb21iaW5lKG9iamVjdDEsIG9iamVjdDIsIGRlZXApIHsKICAgIGRlZXAgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChkZWVwLCBmYWxzZSk7CiAgICBjb25zdCByZXN1bHQgPSB7fTsKICAgIGNvbnN0IG9iamVjdDFEZWZpbmVkID0gZGVmaW5lZF9kZWZhdWx0KG9iamVjdDEpOwogICAgY29uc3Qgb2JqZWN0MkRlZmluZWQgPSBkZWZpbmVkX2RlZmF1bHQob2JqZWN0Mik7CiAgICBsZXQgcHJvcGVydHk7CiAgICBsZXQgb2JqZWN0MVZhbHVlOwogICAgbGV0IG9iamVjdDJWYWx1ZTsKICAgIGlmIChvYmplY3QxRGVmaW5lZCkgewogICAgICBmb3IgKHByb3BlcnR5IGluIG9iamVjdDEpIHsKICAgICAgICBpZiAob2JqZWN0MS5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIHsKICAgICAgICAgIG9iamVjdDFWYWx1ZSA9IG9iamVjdDFbcHJvcGVydHldOwogICAgICAgICAgaWYgKG9iamVjdDJEZWZpbmVkICYmIGRlZXAgJiYgdHlwZW9mIG9iamVjdDFWYWx1ZSA9PT0gIm9iamVjdCIgJiYgb2JqZWN0Mi5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpIHsKICAgICAgICAgICAgb2JqZWN0MlZhbHVlID0gb2JqZWN0Mltwcm9wZXJ0eV07CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0MlZhbHVlID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJlc3VsdFtwcm9wZXJ0eV0gPSBjb21iaW5lKG9iamVjdDFWYWx1ZSwgb2JqZWN0MlZhbHVlLCBkZWVwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN1bHRbcHJvcGVydHldID0gb2JqZWN0MVZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHRbcHJvcGVydHldID0gb2JqZWN0MVZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKG9iamVjdDJEZWZpbmVkKSB7CiAgICAgIGZvciAocHJvcGVydHkgaW4gb2JqZWN0MikgewogICAgICAgIGlmIChvYmplY3QyLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiAhcmVzdWx0Lmhhc093blByb3BlcnR5KHByb3BlcnR5KSkgewogICAgICAgICAgb2JqZWN0MlZhbHVlID0gb2JqZWN0Mltwcm9wZXJ0eV07CiAgICAgICAgICByZXN1bHRbcHJvcGVydHldID0gb2JqZWN0MlZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIGNvbWJpbmVfZGVmYXVsdDsKICB2YXIgaW5pdF9jb21iaW5lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9jb21iaW5lLmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGNvbWJpbmVfZGVmYXVsdCA9IGNvbWJpbmU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9kZWZlci5qcwogIGZ1bmN0aW9uIGRlZmVyKCkgewogICAgbGV0IHJlc29sdmU7CiAgICBsZXQgcmVqZWN0OwogICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlcywgcmVqKSB7CiAgICAgIHJlc29sdmUgPSByZXM7CiAgICAgIHJlamVjdCA9IHJlajsKICAgIH0pOwogICAgcmV0dXJuIHsKICAgICAgcmVzb2x2ZSwKICAgICAgcmVqZWN0LAogICAgICBwcm9taXNlCiAgICB9OwogIH0KICB2YXIgZGVmZXJfZGVmYXVsdDsKICB2YXIgaW5pdF9kZWZlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVmZXIuanMiKCkgewogICAgICBkZWZlcl9kZWZhdWx0ID0gZGVmZXI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9nZXRBYnNvbHV0ZVVyaS5qcwogIGZ1bmN0aW9uIGdldEFic29sdXRlVXJpKHJlbGF0aXZlLCBiYXNlKSB7CiAgICBsZXQgZG9jdW1lbnRPYmplY3Q7CiAgICBpZiAodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIikgewogICAgICBkb2N1bWVudE9iamVjdCA9IGRvY3VtZW50OwogICAgfQogICAgcmV0dXJuIGdldEFic29sdXRlVXJpLl9pbXBsZW1lbnRhdGlvbihyZWxhdGl2ZSwgYmFzZSwgZG9jdW1lbnRPYmplY3QpOwogIH0KICB2YXIgaW1wb3J0X3VyaWpzLCBnZXRBYnNvbHV0ZVVyaV9kZWZhdWx0OwogIHZhciBpbml0X2dldEFic29sdXRlVXJpID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9nZXRBYnNvbHV0ZVVyaS5qcyIoKSB7CiAgICAgIGltcG9ydF91cmlqcyA9IF9fdG9FU00ocmVxdWlyZV9VUkkoKSwgMSk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGdldEFic29sdXRlVXJpLl9pbXBsZW1lbnRhdGlvbiA9IGZ1bmN0aW9uKHJlbGF0aXZlLCBiYXNlLCBkb2N1bWVudE9iamVjdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlbGF0aXZlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJlbGF0aXZlIHVyaSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYmFzZSkpIHsKICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnRPYmplY3QgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiByZWxhdGl2ZTsKICAgICAgICAgIH0KICAgICAgICAgIGJhc2UgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChkb2N1bWVudE9iamVjdC5iYXNlVVJJLCBkb2N1bWVudE9iamVjdC5sb2NhdGlvbi5ocmVmKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVsYXRpdmVVcmkgPSBuZXcgaW1wb3J0X3VyaWpzLmRlZmF1bHQocmVsYXRpdmUpOwogICAgICAgIGlmIChyZWxhdGl2ZVVyaS5zY2hlbWUoKSAhPT0gIiIpIHsKICAgICAgICAgIHJldHVybiByZWxhdGl2ZVVyaS50b1N0cmluZygpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVsYXRpdmVVcmkuYWJzb2x1dGVUbyhiYXNlKS50b1N0cmluZygpOwogICAgICB9OwogICAgICBnZXRBYnNvbHV0ZVVyaV9kZWZhdWx0ID0gZ2V0QWJzb2x1dGVVcmk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9nZXRCYXNlVXJpLmpzCiAgZnVuY3Rpb24gZ2V0QmFzZVVyaSh1cmksIGluY2x1ZGVRdWVyeSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodXJpKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidXJpIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgbGV0IGJhc2VQYXRoID0gIiI7CiAgICBjb25zdCBpID0gdXJpLmxhc3RJbmRleE9mKCIvIik7CiAgICBpZiAoaSAhPT0gLTEpIHsKICAgICAgYmFzZVBhdGggPSB1cmkuc3Vic3RyaW5nKDAsIGkgKyAxKTsKICAgIH0KICAgIGlmICghaW5jbHVkZVF1ZXJ5KSB7CiAgICAgIHJldHVybiBiYXNlUGF0aDsKICAgIH0KICAgIHVyaSA9IG5ldyBpbXBvcnRfdXJpanMyLmRlZmF1bHQodXJpKTsKICAgIGlmICh1cmkucXVlcnkoKS5sZW5ndGggIT09IDApIHsKICAgICAgYmFzZVBhdGggKz0gYD8ke3VyaS5xdWVyeSgpfWA7CiAgICB9CiAgICBpZiAodXJpLmZyYWdtZW50KCkubGVuZ3RoICE9PSAwKSB7CiAgICAgIGJhc2VQYXRoICs9IGAjJHt1cmkuZnJhZ21lbnQoKX1gOwogICAgfQogICAgcmV0dXJuIGJhc2VQYXRoOwogIH0KICB2YXIgaW1wb3J0X3VyaWpzMiwgZ2V0QmFzZVVyaV9kZWZhdWx0OwogIHZhciBpbml0X2dldEJhc2VVcmkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEJhc2VVcmkuanMiKCkgewogICAgICBpbXBvcnRfdXJpanMyID0gX190b0VTTShyZXF1aXJlX1VSSSgpLCAxKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgZ2V0QmFzZVVyaV9kZWZhdWx0ID0gZ2V0QmFzZVVyaTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEV4dGVuc2lvbkZyb21VcmkuanMKICBmdW5jdGlvbiBnZXRFeHRlbnNpb25Gcm9tVXJpKHVyaSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodXJpKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidXJpIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgY29uc3QgdXJpT2JqZWN0ID0gbmV3IGltcG9ydF91cmlqczMuZGVmYXVsdCh1cmkpOwogICAgdXJpT2JqZWN0Lm5vcm1hbGl6ZSgpOwogICAgbGV0IHBhdGggPSB1cmlPYmplY3QucGF0aCgpOwogICAgbGV0IGluZGV4ID0gcGF0aC5sYXN0SW5kZXhPZigiLyIpOwogICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICBwYXRoID0gcGF0aC5zdWJzdHIoaW5kZXggKyAxKTsKICAgIH0KICAgIGluZGV4ID0gcGF0aC5sYXN0SW5kZXhPZigiLiIpOwogICAgaWYgKGluZGV4ID09PSAtMSkgewogICAgICBwYXRoID0gIiI7CiAgICB9IGVsc2UgewogICAgICBwYXRoID0gcGF0aC5zdWJzdHIoaW5kZXggKyAxKTsKICAgIH0KICAgIHJldHVybiBwYXRoOwogIH0KICB2YXIgaW1wb3J0X3VyaWpzMywgZ2V0RXh0ZW5zaW9uRnJvbVVyaV9kZWZhdWx0OwogIHZhciBpbml0X2dldEV4dGVuc2lvbkZyb21VcmkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEV4dGVuc2lvbkZyb21VcmkuanMiKCkgewogICAgICBpbXBvcnRfdXJpanMzID0gX190b0VTTShyZXF1aXJlX1VSSSgpLCAxKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgZ2V0RXh0ZW5zaW9uRnJvbVVyaV9kZWZhdWx0ID0gZ2V0RXh0ZW5zaW9uRnJvbVVyaTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2dldEltYWdlUGl4ZWxzLmpzCiAgZnVuY3Rpb24gZ2V0SW1hZ2VQaXhlbHMoaW1hZ2UsIHdpZHRoLCBoZWlnaHQpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHdpZHRoKSkgewogICAgICB3aWR0aCA9IGltYWdlLndpZHRoOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaGVpZ2h0KSkgewogICAgICBoZWlnaHQgPSBpbWFnZS5oZWlnaHQ7CiAgICB9CiAgICBsZXQgY29udGV4dDJEc0J5SGVpZ2h0ID0gY29udGV4dDJEc0J5V2lkdGhBbmRIZWlnaHRbd2lkdGhdOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29udGV4dDJEc0J5SGVpZ2h0KSkgewogICAgICBjb250ZXh0MkRzQnlIZWlnaHQgPSB7fTsKICAgICAgY29udGV4dDJEc0J5V2lkdGhBbmRIZWlnaHRbd2lkdGhdID0gY29udGV4dDJEc0J5SGVpZ2h0OwogICAgfQogICAgbGV0IGNvbnRleHQyZCA9IGNvbnRleHQyRHNCeUhlaWdodFtoZWlnaHRdOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29udGV4dDJkKSkgewogICAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgY2FudmFzLndpZHRoID0gd2lkdGg7CiAgICAgIGNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgIGNvbnRleHQyZCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIsIHsgd2lsbFJlYWRGcmVxdWVudGx5OiB0cnVlIH0pOwogICAgICBjb250ZXh0MmQuZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gImNvcHkiOwogICAgICBjb250ZXh0MkRzQnlIZWlnaHRbaGVpZ2h0XSA9IGNvbnRleHQyZDsKICAgIH0KICAgIGNvbnRleHQyZC5kcmF3SW1hZ2UoaW1hZ2UsIDAsIDAsIHdpZHRoLCBoZWlnaHQpOwogICAgcmV0dXJuIGNvbnRleHQyZC5nZXRJbWFnZURhdGEoMCwgMCwgd2lkdGgsIGhlaWdodCkuZGF0YTsKICB9CiAgdmFyIGNvbnRleHQyRHNCeVdpZHRoQW5kSGVpZ2h0LCBnZXRJbWFnZVBpeGVsc19kZWZhdWx0OwogIHZhciBpbml0X2dldEltYWdlUGl4ZWxzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9nZXRJbWFnZVBpeGVscy5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBjb250ZXh0MkRzQnlXaWR0aEFuZEhlaWdodCA9IHt9OwogICAgICBnZXRJbWFnZVBpeGVsc19kZWZhdWx0ID0gZ2V0SW1hZ2VQaXhlbHM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9pc0Jsb2JVcmkuanMKICBmdW5jdGlvbiBpc0Jsb2JVcmkodXJpKSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5zdHJpbmcoInVyaSIsIHVyaSk7CiAgICByZXR1cm4gYmxvYlVyaVJlZ2V4LnRlc3QodXJpKTsKICB9CiAgdmFyIGJsb2JVcmlSZWdleCwgaXNCbG9iVXJpX2RlZmF1bHQ7CiAgdmFyIGluaXRfaXNCbG9iVXJpID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9pc0Jsb2JVcmkuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGJsb2JVcmlSZWdleCA9IC9eYmxvYjovaTsKICAgICAgaXNCbG9iVXJpX2RlZmF1bHQgPSBpc0Jsb2JVcmk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9pc0Nyb3NzT3JpZ2luVXJsLmpzCiAgZnVuY3Rpb24gaXNDcm9zc09yaWdpblVybCh1cmwpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGEpKSB7CiAgICAgIGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICB9CiAgICBhLmhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZjsKICAgIGNvbnN0IGhvc3QgPSBhLmhvc3Q7CiAgICBjb25zdCBwcm90b2NvbCA9IGEucHJvdG9jb2w7CiAgICBhLmhyZWYgPSB1cmw7CiAgICBhLmhyZWYgPSBhLmhyZWY7CiAgICByZXR1cm4gcHJvdG9jb2wgIT09IGEucHJvdG9jb2wgfHwgaG9zdCAhPT0gYS5ob3N0OwogIH0KICB2YXIgYSwgaXNDcm9zc09yaWdpblVybF9kZWZhdWx0OwogIHZhciBpbml0X2lzQ3Jvc3NPcmlnaW5VcmwgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzQ3Jvc3NPcmlnaW5VcmwuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaXNDcm9zc09yaWdpblVybF9kZWZhdWx0ID0gaXNDcm9zc09yaWdpblVybDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzRGF0YVVyaS5qcwogIGZ1bmN0aW9uIGlzRGF0YVVyaSh1cmkpIHsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLnN0cmluZygidXJpIiwgdXJpKTsKICAgIHJldHVybiBkYXRhVXJpUmVnZXgudGVzdCh1cmkpOwogIH0KICB2YXIgZGF0YVVyaVJlZ2V4LCBpc0RhdGFVcmlfZGVmYXVsdDsKICB2YXIgaW5pdF9pc0RhdGFVcmkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzRGF0YVVyaS5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgZGF0YVVyaVJlZ2V4ID0gL15kYXRhOi9pOwogICAgICBpc0RhdGFVcmlfZGVmYXVsdCA9IGlzRGF0YVVyaTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2xvYWRBbmRFeGVjdXRlU2NyaXB0LmpzCiAgZnVuY3Rpb24gbG9hZEFuZEV4ZWN1dGVTY3JpcHQodXJsKSB7CiAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgIHNjcmlwdC5hc3luYyA9IHRydWU7CiAgICBzY3JpcHQuc3JjID0gdXJsOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgaWYgKHdpbmRvdy5jcm9zc09yaWdpbklzb2xhdGVkKSB7CiAgICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgiY3Jvc3NvcmlnaW4iLCAiYW5vbnltb3VzIik7CiAgICAgIH0KICAgICAgY29uc3QgaGVhZCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF07CiAgICAgIHNjcmlwdC5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICBzY3JpcHQub25sb2FkID0gdm9pZCAwOwogICAgICAgIGhlYWQucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgICByZXNvbHZlKCk7CiAgICAgIH07CiAgICAgIHNjcmlwdC5vbmVycm9yID0gZnVuY3Rpb24oZSkgewogICAgICAgIHJlamVjdChlKTsKICAgICAgfTsKICAgICAgaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwogICAgfSk7CiAgfQogIHZhciBsb2FkQW5kRXhlY3V0ZVNjcmlwdF9kZWZhdWx0OwogIHZhciBpbml0X2xvYWRBbmRFeGVjdXRlU2NyaXB0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9sb2FkQW5kRXhlY3V0ZVNjcmlwdC5qcyIoKSB7CiAgICAgIGxvYWRBbmRFeGVjdXRlU2NyaXB0X2RlZmF1bHQgPSBsb2FkQW5kRXhlY3V0ZVNjcmlwdDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL29iamVjdFRvUXVlcnkuanMKICBmdW5jdGlvbiBvYmplY3RUb1F1ZXJ5KG9iaikgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob2JqKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib2JqIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgbGV0IHJlc3VsdCA9ICIiOwogICAgZm9yIChjb25zdCBwcm9wTmFtZSBpbiBvYmopIHsKICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICBjb25zdCB2YWx1ZSA9IG9ialtwcm9wTmFtZV07CiAgICAgICAgY29uc3QgcGFydCA9IGAke2VuY29kZVVSSUNvbXBvbmVudChwcm9wTmFtZSl9PWA7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gdmFsdWUubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICAgICAgcmVzdWx0ICs9IGAke3BhcnQgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWVbaV0pfSZgOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQgKz0gYCR7cGFydCArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSl9JmA7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXN1bHQgPSByZXN1bHQuc2xpY2UoMCwgLTEpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIG9iamVjdFRvUXVlcnlfZGVmYXVsdDsKICB2YXIgaW5pdF9vYmplY3RUb1F1ZXJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9vYmplY3RUb1F1ZXJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgb2JqZWN0VG9RdWVyeV9kZWZhdWx0ID0gb2JqZWN0VG9RdWVyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL3F1ZXJ5VG9PYmplY3QuanMKICBmdW5jdGlvbiBxdWVyeVRvT2JqZWN0KHF1ZXJ5U3RyaW5nKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChxdWVyeVN0cmluZykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInF1ZXJ5U3RyaW5nIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgY29uc3QgcmVzdWx0ID0ge307CiAgICBpZiAocXVlcnlTdHJpbmcgPT09ICIiKSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBjb25zdCBwYXJ0cyA9IHF1ZXJ5U3RyaW5nLnJlcGxhY2UoL1wrL2csICIlMjAiKS5zcGxpdCgvWyY7XS8pOwogICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHBhcnRzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGNvbnN0IHN1YnBhcnRzID0gcGFydHNbaV0uc3BsaXQoIj0iKTsKICAgICAgY29uc3QgbmFtZSA9IGRlY29kZVVSSUNvbXBvbmVudChzdWJwYXJ0c1swXSk7CiAgICAgIGxldCB2YWx1ZSA9IHN1YnBhcnRzWzFdOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgIHZhbHVlID0gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWx1ZSA9ICIiOwogICAgICB9CiAgICAgIGNvbnN0IHJlc3VsdFZhbHVlID0gcmVzdWx0W25hbWVdOwogICAgICBpZiAodHlwZW9mIHJlc3VsdFZhbHVlID09PSAic3RyaW5nIikgewogICAgICAgIHJlc3VsdFtuYW1lXSA9IFtyZXN1bHRWYWx1ZSwgdmFsdWVdOwogICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0VmFsdWUpKSB7CiAgICAgICAgcmVzdWx0VmFsdWUucHVzaCh2YWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W25hbWVdID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBxdWVyeVRvT2JqZWN0X2RlZmF1bHQ7CiAgdmFyIGluaXRfcXVlcnlUb09iamVjdCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvcXVlcnlUb09iamVjdC5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIHF1ZXJ5VG9PYmplY3RfZGVmYXVsdCA9IHF1ZXJ5VG9PYmplY3Q7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXF1ZXN0U3RhdGUuanMKICB2YXIgUmVxdWVzdFN0YXRlLCBSZXF1ZXN0U3RhdGVfZGVmYXVsdDsKICB2YXIgaW5pdF9SZXF1ZXN0U3RhdGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3RTdGF0ZS5qcyIoKSB7CiAgICAgIFJlcXVlc3RTdGF0ZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBJbml0aWFsIHVuaXNzdWVkIHN0YXRlLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBVTklTU1VFRDogMCwKICAgICAgICAvKioKICAgICAgICAgKiBJc3N1ZWQgYnV0IG5vdCB5ZXQgYWN0aXZlLiBXaWxsIGJlY29tZSBhY3RpdmUgd2hlbiBvcGVuIHNsb3RzIGFyZSBhdmFpbGFibGUuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIElTU1VFRDogMSwKICAgICAgICAvKioKICAgICAgICAgKiBBY3R1YWwgaHR0cCByZXF1ZXN0IGhhcyBiZWVuIHNlbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEFDVElWRTogMiwKICAgICAgICAvKioKICAgICAgICAgKiBSZXF1ZXN0IGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJFQ0VJVkVEOiAzLAogICAgICAgIC8qKgogICAgICAgICAqIFJlcXVlc3Qgd2FzIGNhbmNlbGxlZCwgZWl0aGVyIGV4cGxpY2l0bHkgb3IgYXV0b21hdGljYWxseSBiZWNhdXNlIG9mIGxvdyBwcmlvcml0eS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgQ0FOQ0VMTEVEOiA0LAogICAgICAgIC8qKgogICAgICAgICAqIFJlcXVlc3QgZmFpbGVkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBGQUlMRUQ6IDUKICAgICAgfTsKICAgICAgUmVxdWVzdFN0YXRlX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKFJlcXVlc3RTdGF0ZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXF1ZXN0VHlwZS5qcwogIHZhciBSZXF1ZXN0VHlwZSwgUmVxdWVzdFR5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9SZXF1ZXN0VHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVxdWVzdFR5cGUuanMiKCkgewogICAgICBSZXF1ZXN0VHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBUZXJyYWluIHJlcXVlc3QuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFRFUlJBSU46IDAsCiAgICAgICAgLyoqCiAgICAgICAgICogSW1hZ2VyeSByZXF1ZXN0LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBJTUFHRVJZOiAxLAogICAgICAgIC8qKgogICAgICAgICAqIDNEIFRpbGVzIHJlcXVlc3QuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFRJTEVTM0Q6IDIsCiAgICAgICAgLyoqCiAgICAgICAgICogT3RoZXIgcmVxdWVzdC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgT1RIRVI6IDMKICAgICAgfTsKICAgICAgUmVxdWVzdFR5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoUmVxdWVzdFR5cGUpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVxdWVzdC5qcwogIGZ1bmN0aW9uIFJlcXVlc3Qob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCB0aHJvdHRsZUJ5U2VydmVyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy50aHJvdHRsZUJ5U2VydmVyLCBmYWxzZSk7CiAgICBjb25zdCB0aHJvdHRsZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudGhyb3R0bGUsIGZhbHNlKTsKICAgIHRoaXMudXJsID0gb3B0aW9ucy51cmw7CiAgICB0aGlzLnJlcXVlc3RGdW5jdGlvbiA9IG9wdGlvbnMucmVxdWVzdEZ1bmN0aW9uOwogICAgdGhpcy5jYW5jZWxGdW5jdGlvbiA9IG9wdGlvbnMuY2FuY2VsRnVuY3Rpb247CiAgICB0aGlzLnByaW9yaXR5RnVuY3Rpb24gPSBvcHRpb25zLnByaW9yaXR5RnVuY3Rpb247CiAgICB0aGlzLnByaW9yaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5wcmlvcml0eSwgMCk7CiAgICB0aGlzLnRocm90dGxlID0gdGhyb3R0bGU7CiAgICB0aGlzLnRocm90dGxlQnlTZXJ2ZXIgPSB0aHJvdHRsZUJ5U2VydmVyOwogICAgdGhpcy50eXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy50eXBlLCBSZXF1ZXN0VHlwZV9kZWZhdWx0Lk9USEVSKTsKICAgIHRoaXMuc2VydmVyS2V5ID0gb3B0aW9ucy5zZXJ2ZXJLZXk7CiAgICB0aGlzLnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQ7CiAgICB0aGlzLmRlZmVycmVkID0gdm9pZCAwOwogICAgdGhpcy5jYW5jZWxsZWQgPSBmYWxzZTsKICB9CiAgdmFyIFJlcXVlc3RfZGVmYXVsdDsKICB2YXIgaW5pdF9SZXF1ZXN0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXF1ZXN0LmpzIigpIHsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfUmVxdWVzdFN0YXRlKCk7CiAgICAgIGluaXRfUmVxdWVzdFR5cGUoKTsKICAgICAgUmVxdWVzdC5wcm90b3R5cGUuY2FuY2VsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5jYW5jZWxsZWQgPSB0cnVlOwogICAgICB9OwogICAgICBSZXF1ZXN0LnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVxdWVzdCh0aGlzKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnVybCA9IHRoaXMudXJsOwogICAgICAgIHJlc3VsdC5yZXF1ZXN0RnVuY3Rpb24gPSB0aGlzLnJlcXVlc3RGdW5jdGlvbjsKICAgICAgICByZXN1bHQuY2FuY2VsRnVuY3Rpb24gPSB0aGlzLmNhbmNlbEZ1bmN0aW9uOwogICAgICAgIHJlc3VsdC5wcmlvcml0eUZ1bmN0aW9uID0gdGhpcy5wcmlvcml0eUZ1bmN0aW9uOwogICAgICAgIHJlc3VsdC5wcmlvcml0eSA9IHRoaXMucHJpb3JpdHk7CiAgICAgICAgcmVzdWx0LnRocm90dGxlID0gdGhpcy50aHJvdHRsZTsKICAgICAgICByZXN1bHQudGhyb3R0bGVCeVNlcnZlciA9IHRoaXMudGhyb3R0bGVCeVNlcnZlcjsKICAgICAgICByZXN1bHQudHlwZSA9IHRoaXMudHlwZTsKICAgICAgICByZXN1bHQuc2VydmVyS2V5ID0gdGhpcy5zZXJ2ZXJLZXk7CiAgICAgICAgcmVzdWx0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQ7CiAgICAgICAgcmVzdWx0LmRlZmVycmVkID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5jYW5jZWxsZWQgPSBmYWxzZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZXF1ZXN0X2RlZmF1bHQgPSBSZXF1ZXN0OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvcGFyc2VSZXNwb25zZUhlYWRlcnMuanMKICBmdW5jdGlvbiBwYXJzZVJlc3BvbnNlSGVhZGVycyhoZWFkZXJTdHJpbmcpIHsKICAgIGNvbnN0IGhlYWRlcnMgPSB7fTsKICAgIGlmICghaGVhZGVyU3RyaW5nKSB7CiAgICAgIHJldHVybiBoZWFkZXJzOwogICAgfQogICAgY29uc3QgaGVhZGVyUGFpcnMgPSBoZWFkZXJTdHJpbmcuc3BsaXQoIlxyXG4iKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGVhZGVyUGFpcnMubGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgaGVhZGVyUGFpciA9IGhlYWRlclBhaXJzW2ldOwogICAgICBjb25zdCBpbmRleCA9IGhlYWRlclBhaXIuaW5kZXhPZigiOiAiKTsKICAgICAgaWYgKGluZGV4ID4gMCkgewogICAgICAgIGNvbnN0IGtleSA9IGhlYWRlclBhaXIuc3Vic3RyaW5nKDAsIGluZGV4KTsKICAgICAgICBjb25zdCB2YWwgPSBoZWFkZXJQYWlyLnN1YnN0cmluZyhpbmRleCArIDIpOwogICAgICAgIGhlYWRlcnNba2V5XSA9IHZhbDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGhlYWRlcnM7CiAgfQogIHZhciBwYXJzZVJlc3BvbnNlSGVhZGVyc19kZWZhdWx0OwogIHZhciBpbml0X3BhcnNlUmVzcG9uc2VIZWFkZXJzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9wYXJzZVJlc3BvbnNlSGVhZGVycy5qcyIoKSB7CiAgICAgIHBhcnNlUmVzcG9uc2VIZWFkZXJzX2RlZmF1bHQgPSBwYXJzZVJlc3BvbnNlSGVhZGVyczsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3RFcnJvckV2ZW50LmpzCiAgZnVuY3Rpb24gUmVxdWVzdEVycm9yRXZlbnQoc3RhdHVzQ29kZSwgcmVzcG9uc2UsIHJlc3BvbnNlSGVhZGVycykgewogICAgdGhpcy5zdGF0dXNDb2RlID0gc3RhdHVzQ29kZTsKICAgIHRoaXMucmVzcG9uc2UgPSByZXNwb25zZTsKICAgIHRoaXMucmVzcG9uc2VIZWFkZXJzID0gcmVzcG9uc2VIZWFkZXJzOwogICAgaWYgKHR5cGVvZiB0aGlzLnJlc3BvbnNlSGVhZGVycyA9PT0gInN0cmluZyIpIHsKICAgICAgdGhpcy5yZXNwb25zZUhlYWRlcnMgPSBwYXJzZVJlc3BvbnNlSGVhZGVyc19kZWZhdWx0KHRoaXMucmVzcG9uc2VIZWFkZXJzKTsKICAgIH0KICB9CiAgdmFyIFJlcXVlc3RFcnJvckV2ZW50X2RlZmF1bHQ7CiAgdmFyIGluaXRfUmVxdWVzdEVycm9yRXZlbnQgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3RFcnJvckV2ZW50LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfcGFyc2VSZXNwb25zZUhlYWRlcnMoKTsKICAgICAgUmVxdWVzdEVycm9yRXZlbnQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbGV0IHN0ciA9ICJSZXF1ZXN0IGhhcyBmYWlsZWQuIjsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRoaXMuc3RhdHVzQ29kZSkpIHsKICAgICAgICAgIHN0ciArPSBgIFN0YXR1cyBDb2RlOiAke3RoaXMuc3RhdHVzQ29kZX1gOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgICB9OwogICAgICBSZXF1ZXN0RXJyb3JFdmVudF9kZWZhdWx0ID0gUmVxdWVzdEVycm9yRXZlbnQ7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FdmVudC5qcwogIGZ1bmN0aW9uIEV2ZW50KCkgewogICAgdGhpcy5fbGlzdGVuZXJzID0gW107CiAgICB0aGlzLl9zY29wZXMgPSBbXTsKICAgIHRoaXMuX3RvUmVtb3ZlID0gW107CiAgICB0aGlzLl9pbnNpZGVSYWlzZUV2ZW50ID0gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIGNvbXBhcmVOdW1iZXIoYTMsIGIpIHsKICAgIHJldHVybiBiIC0gYTM7CiAgfQogIHZhciBFdmVudF9kZWZhdWx0OwogIHZhciBpbml0X0V2ZW50ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FdmVudC5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEV2ZW50LnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2YgbGlzdGVuZXJzIGN1cnJlbnRseSBzdWJzY3JpYmVkIHRvIHRoZSBldmVudC4KICAgICAgICAgKiBAbWVtYmVyb2YgRXZlbnQucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBudW1iZXJPZkxpc3RlbmVyczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xpc3RlbmVycy5sZW5ndGggLSB0aGlzLl90b1JlbW92ZS5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgRXZlbnQucHJvdG90eXBlLmFkZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbihsaXN0ZW5lciwgc2NvcGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5mdW5jKCJsaXN0ZW5lciIsIGxpc3RlbmVyKTsKICAgICAgICB0aGlzLl9saXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CiAgICAgICAgdGhpcy5fc2NvcGVzLnB1c2goc2NvcGUpOwogICAgICAgIGNvbnN0IGV2ZW50ID0gdGhpczsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICBldmVudC5yZW1vdmVFdmVudExpc3RlbmVyKGxpc3RlbmVyLCBzY29wZSk7CiAgICAgICAgfTsKICAgICAgfTsKICAgICAgRXZlbnQucHJvdG90eXBlLnJlbW92ZUV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbihsaXN0ZW5lciwgc2NvcGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5mdW5jKCJsaXN0ZW5lciIsIGxpc3RlbmVyKTsKICAgICAgICBjb25zdCBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnM7CiAgICAgICAgY29uc3Qgc2NvcGVzID0gdGhpcy5fc2NvcGVzOwogICAgICAgIGxldCBpbmRleCA9IC0xOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdGVuZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAobGlzdGVuZXJzW2ldID09PSBsaXN0ZW5lciAmJiBzY29wZXNbaV0gPT09IHNjb3BlKSB7CiAgICAgICAgICAgIGluZGV4ID0gaTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICAgIGlmICh0aGlzLl9pbnNpZGVSYWlzZUV2ZW50KSB7CiAgICAgICAgICAgIHRoaXMuX3RvUmVtb3ZlLnB1c2goaW5kZXgpOwogICAgICAgICAgICBsaXN0ZW5lcnNbaW5kZXhdID0gdm9pZCAwOwogICAgICAgICAgICBzY29wZXNbaW5kZXhdID0gdm9pZCAwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgIHNjb3Blcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgICAgRXZlbnQucHJvdG90eXBlLnJhaXNlRXZlbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl9pbnNpZGVSYWlzZUV2ZW50ID0gdHJ1ZTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnM7CiAgICAgICAgY29uc3Qgc2NvcGVzID0gdGhpcy5fc2NvcGVzOwogICAgICAgIGxldCBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgbGlzdGVuZXIgPSBsaXN0ZW5lcnNbaV07CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGxpc3RlbmVyKSkgewogICAgICAgICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkoc2NvcGVzW2ldLCBhcmd1bWVudHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB0b1JlbW92ZSA9IHRoaXMuX3RvUmVtb3ZlOwogICAgICAgIGxlbmd0aCA9IHRvUmVtb3ZlLmxlbmd0aDsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgdG9SZW1vdmUuc29ydChjb21wYXJlTnVtYmVyKTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCBpbmRleCA9IHRvUmVtb3ZlW2ldOwogICAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgc2NvcGVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICB9CiAgICAgICAgICB0b1JlbW92ZS5sZW5ndGggPSAwOwogICAgICAgIH0KICAgICAgICB0aGlzLl9pbnNpZGVSYWlzZUV2ZW50ID0gZmFsc2U7CiAgICAgIH07CiAgICAgIEV2ZW50X2RlZmF1bHQgPSBFdmVudDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0hlYXAuanMKICBmdW5jdGlvbiBIZWFwKG9wdGlvbnMpIHsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucyIsIG9wdGlvbnMpOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLmNvbXBhcmF0b3IiLCBvcHRpb25zLmNvbXBhcmF0b3IpOwogICAgdGhpcy5fY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKICAgIHRoaXMuX2FycmF5ID0gW107CiAgICB0aGlzLl9sZW5ndGggPSAwOwogICAgdGhpcy5fbWF4aW11bUxlbmd0aCA9IHZvaWQgMDsKICB9CiAgZnVuY3Rpb24gc3dhcChhcnJheSwgYTMsIGIpIHsKICAgIGNvbnN0IHRlbXAgPSBhcnJheVthM107CiAgICBhcnJheVthM10gPSBhcnJheVtiXTsKICAgIGFycmF5W2JdID0gdGVtcDsKICB9CiAgdmFyIEhlYXBfZGVmYXVsdDsKICB2YXIgaW5pdF9IZWFwID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9IZWFwLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoSGVhcC5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBsZW5ndGggb2YgdGhlIGhlYXAuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgSGVhcC5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgbGVuZ3RoOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgaW50ZXJuYWwgYXJyYXkuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgSGVhcC5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBpbnRlcm5hbEFycmF5OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fYXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIGFuZCBzZXRzIHRoZSBtYXhpbXVtIGxlbmd0aCBvZiB0aGUgaGVhcC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBIZWFwLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKi8KICAgICAgICBtYXhpbXVtTGVuZ3RoOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbWF4aW11bUxlbmd0aDsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJtYXhpbXVtTGVuZ3RoIiwgdmFsdWUsIDApOwogICAgICAgICAgICBjb25zdCBvcmlnaW5hbExlbmd0aCA9IHRoaXMuX2xlbmd0aDsKICAgICAgICAgICAgaWYgKHZhbHVlIDwgb3JpZ2luYWxMZW5ndGgpIHsKICAgICAgICAgICAgICBjb25zdCBhcnJheSA9IHRoaXMuX2FycmF5OwogICAgICAgICAgICAgIGZvciAobGV0IGkgPSB2YWx1ZTsgaSA8IG9yaWdpbmFsTGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIGFycmF5W2ldID0gdm9pZCAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9sZW5ndGggPSB2YWx1ZTsKICAgICAgICAgICAgICBhcnJheS5sZW5ndGggPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9tYXhpbXVtTGVuZ3RoID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgY29tcGFyYXRvciB0byB1c2UgZm9yIHRoZSBoZWFwLiBJZiBjb21wYXJhdG9yKGEsIGIpIGlzIGxlc3MgdGhhbiAwLCBzb3J0IGEgdG8gYSBsb3dlciBpbmRleCB0aGFuIGIsIG90aGVyd2lzZSBzb3J0IHRvIGEgaGlnaGVyIGluZGV4LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIEhlYXAucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7SGVhcC5Db21wYXJhdG9yQ2FsbGJhY2t9CiAgICAgICAgICovCiAgICAgICAgY29tcGFyYXRvcjogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NvbXBhcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgSGVhcC5wcm90b3R5cGUucmVzZXJ2ZSA9IGZ1bmN0aW9uKGxlbmd0aCkgewogICAgICAgIGxlbmd0aCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGxlbmd0aCwgdGhpcy5fbGVuZ3RoKTsKICAgICAgICB0aGlzLl9hcnJheS5sZW5ndGggPSBsZW5ndGg7CiAgICAgIH07CiAgICAgIEhlYXAucHJvdG90eXBlLmhlYXBpZnkgPSBmdW5jdGlvbihpbmRleCkgewogICAgICAgIGluZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaW5kZXgsIDApOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuX2xlbmd0aDsKICAgICAgICBjb25zdCBjb21wYXJhdG9yID0gdGhpcy5fY29tcGFyYXRvcjsKICAgICAgICBjb25zdCBhcnJheSA9IHRoaXMuX2FycmF5OwogICAgICAgIGxldCBjYW5kaWRhdGUgPSAtMTsKICAgICAgICBsZXQgaW5zZXJ0aW5nID0gdHJ1ZTsKICAgICAgICB3aGlsZSAoaW5zZXJ0aW5nKSB7CiAgICAgICAgICBjb25zdCByaWdodCA9IDIgKiAoaW5kZXggKyAxKTsKICAgICAgICAgIGNvbnN0IGxlZnQgPSByaWdodCAtIDE7CiAgICAgICAgICBpZiAobGVmdCA8IGxlbmd0aCAmJiBjb21wYXJhdG9yKGFycmF5W2xlZnRdLCBhcnJheVtpbmRleF0pIDwgMCkgewogICAgICAgICAgICBjYW5kaWRhdGUgPSBsZWZ0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2FuZGlkYXRlID0gaW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmlnaHQgPCBsZW5ndGggJiYgY29tcGFyYXRvcihhcnJheVtyaWdodF0sIGFycmF5W2NhbmRpZGF0ZV0pIDwgMCkgewogICAgICAgICAgICBjYW5kaWRhdGUgPSByaWdodDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjYW5kaWRhdGUgIT09IGluZGV4KSB7CiAgICAgICAgICAgIHN3YXAoYXJyYXksIGNhbmRpZGF0ZSwgaW5kZXgpOwogICAgICAgICAgICBpbmRleCA9IGNhbmRpZGF0ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluc2VydGluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgSGVhcC5wcm90b3R5cGUucmVzb3J0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gdGhpcy5fbGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSBNYXRoLmNlaWwobGVuZ3RoIC8gMik7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICB0aGlzLmhlYXBpZnkoaSk7CiAgICAgICAgfQogICAgICB9OwogICAgICBIZWFwLnByb3RvdHlwZS5pbnNlcnQgPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJlbGVtZW50IiwgZWxlbWVudCk7CiAgICAgICAgY29uc3QgYXJyYXkgPSB0aGlzLl9hcnJheTsKICAgICAgICBjb25zdCBjb21wYXJhdG9yID0gdGhpcy5fY29tcGFyYXRvcjsKICAgICAgICBjb25zdCBtYXhpbXVtTGVuZ3RoID0gdGhpcy5fbWF4aW11bUxlbmd0aDsKICAgICAgICBsZXQgaW5kZXggPSB0aGlzLl9sZW5ndGgrKzsKICAgICAgICBpZiAoaW5kZXggPCBhcnJheS5sZW5ndGgpIHsKICAgICAgICAgIGFycmF5W2luZGV4XSA9IGVsZW1lbnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFycmF5LnB1c2goZWxlbWVudCk7CiAgICAgICAgfQogICAgICAgIHdoaWxlIChpbmRleCAhPT0gMCkgewogICAgICAgICAgY29uc3QgcGFyZW50ID0gTWF0aC5mbG9vcigoaW5kZXggLSAxKSAvIDIpOwogICAgICAgICAgaWYgKGNvbXBhcmF0b3IoYXJyYXlbaW5kZXhdLCBhcnJheVtwYXJlbnRdKSA8IDApIHsKICAgICAgICAgICAgc3dhcChhcnJheSwgaW5kZXgsIHBhcmVudCk7CiAgICAgICAgICAgIGluZGV4ID0gcGFyZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCByZW1vdmVkRWxlbWVudDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1heGltdW1MZW5ndGgpICYmIHRoaXMuX2xlbmd0aCA+IG1heGltdW1MZW5ndGgpIHsKICAgICAgICAgIHJlbW92ZWRFbGVtZW50ID0gYXJyYXlbbWF4aW11bUxlbmd0aF07CiAgICAgICAgICB0aGlzLl9sZW5ndGggPSBtYXhpbXVtTGVuZ3RoOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVtb3ZlZEVsZW1lbnQ7CiAgICAgIH07CiAgICAgIEhlYXAucHJvdG90eXBlLnBvcCA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgaW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChpbmRleCwgMCk7CiAgICAgICAgaWYgKHRoaXMuX2xlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuKCJpbmRleCIsIGluZGV4LCB0aGlzLl9sZW5ndGgpOwogICAgICAgIGNvbnN0IGFycmF5ID0gdGhpcy5fYXJyYXk7CiAgICAgICAgY29uc3Qgcm9vdCA9IGFycmF5W2luZGV4XTsKICAgICAgICBzd2FwKGFycmF5LCBpbmRleCwgLS10aGlzLl9sZW5ndGgpOwogICAgICAgIHRoaXMuaGVhcGlmeShpbmRleCk7CiAgICAgICAgYXJyYXlbdGhpcy5fbGVuZ3RoXSA9IHZvaWQgMDsKICAgICAgICByZXR1cm4gcm9vdDsKICAgICAgfTsKICAgICAgSGVhcF9kZWZhdWx0ID0gSGVhcDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlcXVlc3RTY2hlZHVsZXIuanMKICBmdW5jdGlvbiBzb3J0UmVxdWVzdHMoYTMsIGIpIHsKICAgIHJldHVybiBhMy5wcmlvcml0eSAtIGIucHJpb3JpdHk7CiAgfQogIGZ1bmN0aW9uIFJlcXVlc3RTY2hlZHVsZXIoKSB7CiAgfQogIGZ1bmN0aW9uIHVwZGF0ZVByaW9yaXR5KHJlcXVlc3QpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVxdWVzdC5wcmlvcml0eUZ1bmN0aW9uKSkgewogICAgICByZXF1ZXN0LnByaW9yaXR5ID0gcmVxdWVzdC5wcmlvcml0eUZ1bmN0aW9uKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGlzc3VlUmVxdWVzdChyZXF1ZXN0KSB7CiAgICBpZiAocmVxdWVzdC5zdGF0ZSA9PT0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQpIHsKICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LklTU1VFRDsKICAgICAgcmVxdWVzdC5kZWZlcnJlZCA9IGRlZmVyX2RlZmF1bHQoKTsKICAgIH0KICAgIHJldHVybiByZXF1ZXN0LmRlZmVycmVkLnByb21pc2U7CiAgfQogIGZ1bmN0aW9uIGdldFJlcXVlc3RSZWNlaXZlZEZ1bmN0aW9uKHJlcXVlc3QpIHsKICAgIHJldHVybiBmdW5jdGlvbihyZXN1bHRzKSB7CiAgICAgIGlmIChyZXF1ZXN0LnN0YXRlID09PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5DQU5DRUxMRUQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgZGVmZXJyZWQgPSByZXF1ZXN0LmRlZmVycmVkOwogICAgICAtLXN0YXRpc3RpY3MubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0czsKICAgICAgLS1udW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbcmVxdWVzdC5zZXJ2ZXJLZXldOwogICAgICByZXF1ZXN0Q29tcGxldGVkRXZlbnQucmFpc2VFdmVudCgpOwogICAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuUkVDRUlWRUQ7CiAgICAgIHJlcXVlc3QuZGVmZXJyZWQgPSB2b2lkIDA7CiAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzdWx0cyk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBnZXRSZXF1ZXN0RmFpbGVkRnVuY3Rpb24ocmVxdWVzdCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgIGlmIChyZXF1ZXN0LnN0YXRlID09PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5DQU5DRUxMRUQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgKytzdGF0aXN0aWNzLm51bWJlck9mRmFpbGVkUmVxdWVzdHM7CiAgICAgIC0tc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzOwogICAgICAtLW51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlcltyZXF1ZXN0LnNlcnZlcktleV07CiAgICAgIHJlcXVlc3RDb21wbGV0ZWRFdmVudC5yYWlzZUV2ZW50KGVycm9yKTsKICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LkZBSUxFRDsKICAgICAgcmVxdWVzdC5kZWZlcnJlZC5yZWplY3QoZXJyb3IpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gc3RhcnRSZXF1ZXN0KHJlcXVlc3QpIHsKICAgIGNvbnN0IHByb21pc2UgPSBpc3N1ZVJlcXVlc3QocmVxdWVzdCk7CiAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuQUNUSVZFOwogICAgYWN0aXZlUmVxdWVzdHMucHVzaChyZXF1ZXN0KTsKICAgICsrc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzOwogICAgKytzdGF0aXN0aWNzLm51bWJlck9mQWN0aXZlUmVxdWVzdHNFdmVyOwogICAgKytudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbcmVxdWVzdC5zZXJ2ZXJLZXldOwogICAgcmVxdWVzdC5yZXF1ZXN0RnVuY3Rpb24oKS50aGVuKGdldFJlcXVlc3RSZWNlaXZlZEZ1bmN0aW9uKHJlcXVlc3QpKS5jYXRjaChnZXRSZXF1ZXN0RmFpbGVkRnVuY3Rpb24ocmVxdWVzdCkpOwogICAgcmV0dXJuIHByb21pc2U7CiAgfQogIGZ1bmN0aW9uIGNhbmNlbFJlcXVlc3QocmVxdWVzdCkgewogICAgY29uc3QgYWN0aXZlID0gcmVxdWVzdC5zdGF0ZSA9PT0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuQUNUSVZFOwogICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LkNBTkNFTExFRDsKICAgICsrc3RhdGlzdGljcy5udW1iZXJPZkNhbmNlbGxlZFJlcXVlc3RzOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXF1ZXN0LmRlZmVycmVkKSkgewogICAgICBjb25zdCBkZWZlcnJlZCA9IHJlcXVlc3QuZGVmZXJyZWQ7CiAgICAgIHJlcXVlc3QuZGVmZXJyZWQgPSB2b2lkIDA7CiAgICAgIGRlZmVycmVkLnJlamVjdCgpOwogICAgfQogICAgaWYgKGFjdGl2ZSkgewogICAgICAtLXN0YXRpc3RpY3MubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0czsKICAgICAgLS1udW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbcmVxdWVzdC5zZXJ2ZXJLZXldOwogICAgICArK3N0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRBY3RpdmVSZXF1ZXN0czsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVxdWVzdC5jYW5jZWxGdW5jdGlvbikpIHsKICAgICAgcmVxdWVzdC5jYW5jZWxGdW5jdGlvbigpOwogICAgfQogIH0KICBmdW5jdGlvbiB1cGRhdGVTdGF0aXN0aWNzKCkgewogICAgaWYgKCFSZXF1ZXN0U2NoZWR1bGVyLmRlYnVnU2hvd1N0YXRpc3RpY3MpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHN0YXRpc3RpY3MubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0cyA9PT0gMCAmJiBzdGF0aXN0aWNzLmxhc3ROdW1iZXJPZkFjdGl2ZVJlcXVlc3RzID4gMCkgewogICAgICBpZiAoc3RhdGlzdGljcy5udW1iZXJPZkF0dGVtcHRlZFJlcXVlc3RzID4gMCkgewogICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgYE51bWJlciBvZiBhdHRlbXB0ZWQgcmVxdWVzdHM6ICR7c3RhdGlzdGljcy5udW1iZXJPZkF0dGVtcHRlZFJlcXVlc3RzfWAKICAgICAgICApOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZBdHRlbXB0ZWRSZXF1ZXN0cyA9IDA7CiAgICAgIH0KICAgICAgaWYgKHN0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRSZXF1ZXN0cyA+IDApIHsKICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgIGBOdW1iZXIgb2YgY2FuY2VsbGVkIHJlcXVlc3RzOiAke3N0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRSZXF1ZXN0c31gCiAgICAgICAgKTsKICAgICAgICBzdGF0aXN0aWNzLm51bWJlck9mQ2FuY2VsbGVkUmVxdWVzdHMgPSAwOwogICAgICB9CiAgICAgIGlmIChzdGF0aXN0aWNzLm51bWJlck9mQ2FuY2VsbGVkQWN0aXZlUmVxdWVzdHMgPiAwKSB7CiAgICAgICAgY29uc29sZS5sb2coCiAgICAgICAgICBgTnVtYmVyIG9mIGNhbmNlbGxlZCBhY3RpdmUgcmVxdWVzdHM6ICR7c3RhdGlzdGljcy5udW1iZXJPZkNhbmNlbGxlZEFjdGl2ZVJlcXVlc3RzfWAKICAgICAgICApOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZDYW5jZWxsZWRBY3RpdmVSZXF1ZXN0cyA9IDA7CiAgICAgIH0KICAgICAgaWYgKHN0YXRpc3RpY3MubnVtYmVyT2ZGYWlsZWRSZXF1ZXN0cyA+IDApIHsKICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgIGBOdW1iZXIgb2YgZmFpbGVkIHJlcXVlc3RzOiAke3N0YXRpc3RpY3MubnVtYmVyT2ZGYWlsZWRSZXF1ZXN0c31gCiAgICAgICAgKTsKICAgICAgICBzdGF0aXN0aWNzLm51bWJlck9mRmFpbGVkUmVxdWVzdHMgPSAwOwogICAgICB9CiAgICB9CiAgICBzdGF0aXN0aWNzLmxhc3ROdW1iZXJPZkFjdGl2ZVJlcXVlc3RzID0gc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzOwogIH0KICB2YXIgaW1wb3J0X3VyaWpzNCwgc3RhdGlzdGljcywgcHJpb3JpdHlIZWFwTGVuZ3RoLCByZXF1ZXN0SGVhcCwgYWN0aXZlUmVxdWVzdHMsIG51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlciwgcGFnZVVyaSwgcmVxdWVzdENvbXBsZXRlZEV2ZW50LCBSZXF1ZXN0U2NoZWR1bGVyX2RlZmF1bHQ7CiAgdmFyIGluaXRfUmVxdWVzdFNjaGVkdWxlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVxdWVzdFNjaGVkdWxlci5qcyIoKSB7CiAgICAgIGltcG9ydF91cmlqczQgPSBfX3RvRVNNKHJlcXVpcmVfVVJJKCksIDEpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmZXIoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRXZlbnQoKTsKICAgICAgaW5pdF9IZWFwKCk7CiAgICAgIGluaXRfaXNCbG9iVXJpKCk7CiAgICAgIGluaXRfaXNEYXRhVXJpKCk7CiAgICAgIGluaXRfUmVxdWVzdFN0YXRlKCk7CiAgICAgIHN0YXRpc3RpY3MgPSB7CiAgICAgICAgbnVtYmVyT2ZBdHRlbXB0ZWRSZXF1ZXN0czogMCwKICAgICAgICBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzOiAwLAogICAgICAgIG51bWJlck9mQ2FuY2VsbGVkUmVxdWVzdHM6IDAsCiAgICAgICAgbnVtYmVyT2ZDYW5jZWxsZWRBY3RpdmVSZXF1ZXN0czogMCwKICAgICAgICBudW1iZXJPZkZhaWxlZFJlcXVlc3RzOiAwLAogICAgICAgIG51bWJlck9mQWN0aXZlUmVxdWVzdHNFdmVyOiAwLAogICAgICAgIGxhc3ROdW1iZXJPZkFjdGl2ZVJlcXVlc3RzOiAwCiAgICAgIH07CiAgICAgIHByaW9yaXR5SGVhcExlbmd0aCA9IDIwOwogICAgICByZXF1ZXN0SGVhcCA9IG5ldyBIZWFwX2RlZmF1bHQoewogICAgICAgIGNvbXBhcmF0b3I6IHNvcnRSZXF1ZXN0cwogICAgICB9KTsKICAgICAgcmVxdWVzdEhlYXAubWF4aW11bUxlbmd0aCA9IHByaW9yaXR5SGVhcExlbmd0aDsKICAgICAgcmVxdWVzdEhlYXAucmVzZXJ2ZShwcmlvcml0eUhlYXBMZW5ndGgpOwogICAgICBhY3RpdmVSZXF1ZXN0cyA9IFtdOwogICAgICBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXIgPSB7fTsKICAgICAgcGFnZVVyaSA9IHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgPyBuZXcgaW1wb3J0X3VyaWpzNC5kZWZhdWx0KGRvY3VtZW50LmxvY2F0aW9uLmhyZWYpIDogbmV3IGltcG9ydF91cmlqczQuZGVmYXVsdCgpOwogICAgICByZXF1ZXN0Q29tcGxldGVkRXZlbnQgPSBuZXcgRXZlbnRfZGVmYXVsdCgpOwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLm1heGltdW1SZXF1ZXN0cyA9IDUwOwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLm1heGltdW1SZXF1ZXN0c1BlclNlcnZlciA9IDE4OwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLnJlcXVlc3RzQnlTZXJ2ZXIgPSB7fTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci50aHJvdHRsZVJlcXVlc3RzID0gdHJ1ZTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci5kZWJ1Z1Nob3dTdGF0aXN0aWNzID0gZmFsc2U7CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIucmVxdWVzdENvbXBsZXRlZEV2ZW50ID0gcmVxdWVzdENvbXBsZXRlZEV2ZW50OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhSZXF1ZXN0U2NoZWR1bGVyLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgc3RhdGlzdGljcyB1c2VkIGJ5IHRoZSByZXF1ZXN0IHNjaGVkdWxlci4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBSZXF1ZXN0U2NoZWR1bGVyCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7b2JqZWN0fQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgc3RhdGlzdGljczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHN0YXRpc3RpY3M7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgbWF4aW11bSBzaXplIG9mIHRoZSBwcmlvcml0eSBoZWFwLiBUaGlzIGxpbWl0cyB0aGUgbnVtYmVyIG9mIHJlcXVlc3RzIHRoYXQgYXJlIHNvcnRlZCBieSBwcmlvcml0eS4gT25seSBhcHBsaWVzIHRvIHJlcXVlc3RzIHRoYXQgYXJlIG5vdCB5ZXQgYWN0aXZlLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlcXVlc3RTY2hlZHVsZXIKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGRlZmF1bHQgMjAKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHByaW9yaXR5SGVhcExlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHByaW9yaXR5SGVhcExlbmd0aDsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSA8IHByaW9yaXR5SGVhcExlbmd0aCkgewogICAgICAgICAgICAgIHdoaWxlIChyZXF1ZXN0SGVhcC5sZW5ndGggPiB2YWx1ZSkgewogICAgICAgICAgICAgICAgY29uc3QgcmVxdWVzdCA9IHJlcXVlc3RIZWFwLnBvcCgpOwogICAgICAgICAgICAgICAgY2FuY2VsUmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJpb3JpdHlIZWFwTGVuZ3RoID0gdmFsdWU7CiAgICAgICAgICAgIHJlcXVlc3RIZWFwLm1heGltdW1MZW5ndGggPSB2YWx1ZTsKICAgICAgICAgICAgcmVxdWVzdEhlYXAucmVzZXJ2ZSh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci5zZXJ2ZXJIYXNPcGVuU2xvdHMgPSBmdW5jdGlvbihzZXJ2ZXJLZXksIGRlc2lyZWRSZXF1ZXN0cykgewogICAgICAgIGRlc2lyZWRSZXF1ZXN0cyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGRlc2lyZWRSZXF1ZXN0cywgMSk7CiAgICAgICAgY29uc3QgbWF4UmVxdWVzdHMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIFJlcXVlc3RTY2hlZHVsZXIucmVxdWVzdHNCeVNlcnZlcltzZXJ2ZXJLZXldLAogICAgICAgICAgUmVxdWVzdFNjaGVkdWxlci5tYXhpbXVtUmVxdWVzdHNQZXJTZXJ2ZXIKICAgICAgICApOwogICAgICAgIGNvbnN0IGhhc09wZW5TbG90c1NlcnZlciA9IG51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlcltzZXJ2ZXJLZXldICsgZGVzaXJlZFJlcXVlc3RzIDw9IG1heFJlcXVlc3RzOwogICAgICAgIHJldHVybiBoYXNPcGVuU2xvdHNTZXJ2ZXI7CiAgICAgIH07CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIuaGVhcEhhc09wZW5TbG90cyA9IGZ1bmN0aW9uKGRlc2lyZWRSZXF1ZXN0cykgewogICAgICAgIGNvbnN0IGhhc09wZW5TbG90c0hlYXAgPSByZXF1ZXN0SGVhcC5sZW5ndGggKyBkZXNpcmVkUmVxdWVzdHMgPD0gcHJpb3JpdHlIZWFwTGVuZ3RoOwogICAgICAgIHJldHVybiBoYXNPcGVuU2xvdHNIZWFwOwogICAgICB9OwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLnVwZGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGxldCBpOwogICAgICAgIGxldCByZXF1ZXN0OwogICAgICAgIGxldCByZW1vdmVDb3VudCA9IDA7CiAgICAgICAgY29uc3QgYWN0aXZlTGVuZ3RoID0gYWN0aXZlUmVxdWVzdHMubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBhY3RpdmVMZW5ndGg7ICsraSkgewogICAgICAgICAgcmVxdWVzdCA9IGFjdGl2ZVJlcXVlc3RzW2ldOwogICAgICAgICAgaWYgKHJlcXVlc3QuY2FuY2VsbGVkKSB7CiAgICAgICAgICAgIGNhbmNlbFJlcXVlc3QocmVxdWVzdCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVxdWVzdC5zdGF0ZSAhPT0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuQUNUSVZFKSB7CiAgICAgICAgICAgICsrcmVtb3ZlQ291bnQ7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlbW92ZUNvdW50ID4gMCkgewogICAgICAgICAgICBhY3RpdmVSZXF1ZXN0c1tpIC0gcmVtb3ZlQ291bnRdID0gcmVxdWVzdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYWN0aXZlUmVxdWVzdHMubGVuZ3RoIC09IHJlbW92ZUNvdW50OwogICAgICAgIGNvbnN0IGlzc3VlZFJlcXVlc3RzID0gcmVxdWVzdEhlYXAuaW50ZXJuYWxBcnJheTsKICAgICAgICBjb25zdCBpc3N1ZWRMZW5ndGggPSByZXF1ZXN0SGVhcC5sZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGlzc3VlZExlbmd0aDsgKytpKSB7CiAgICAgICAgICB1cGRhdGVQcmlvcml0eShpc3N1ZWRSZXF1ZXN0c1tpXSk7CiAgICAgICAgfQogICAgICAgIHJlcXVlc3RIZWFwLnJlc29ydCgpOwogICAgICAgIGNvbnN0IG9wZW5TbG90cyA9IE1hdGgubWF4KAogICAgICAgICAgUmVxdWVzdFNjaGVkdWxlci5tYXhpbXVtUmVxdWVzdHMgLSBhY3RpdmVSZXF1ZXN0cy5sZW5ndGgsCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICBsZXQgZmlsbGVkU2xvdHMgPSAwOwogICAgICAgIHdoaWxlIChmaWxsZWRTbG90cyA8IG9wZW5TbG90cyAmJiByZXF1ZXN0SGVhcC5sZW5ndGggPiAwKSB7CiAgICAgICAgICByZXF1ZXN0ID0gcmVxdWVzdEhlYXAucG9wKCk7CiAgICAgICAgICBpZiAocmVxdWVzdC5jYW5jZWxsZWQpIHsKICAgICAgICAgICAgY2FuY2VsUmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVxdWVzdC50aHJvdHRsZUJ5U2VydmVyICYmICFSZXF1ZXN0U2NoZWR1bGVyLnNlcnZlckhhc09wZW5TbG90cyhyZXF1ZXN0LnNlcnZlcktleSkpIHsKICAgICAgICAgICAgY2FuY2VsUmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBzdGFydFJlcXVlc3QocmVxdWVzdCk7CiAgICAgICAgICArK2ZpbGxlZFNsb3RzOwogICAgICAgIH0KICAgICAgICB1cGRhdGVTdGF0aXN0aWNzKCk7CiAgICAgIH07CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIuZ2V0U2VydmVyS2V5ID0gZnVuY3Rpb24odXJsKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yuc3RyaW5nKCJ1cmwiLCB1cmwpOwogICAgICAgIGxldCB1cmkgPSBuZXcgaW1wb3J0X3VyaWpzNC5kZWZhdWx0KHVybCk7CiAgICAgICAgaWYgKHVyaS5zY2hlbWUoKSA9PT0gIiIpIHsKICAgICAgICAgIHVyaSA9IHVyaS5hYnNvbHV0ZVRvKHBhZ2VVcmkpOwogICAgICAgICAgdXJpLm5vcm1hbGl6ZSgpOwogICAgICAgIH0KICAgICAgICBsZXQgc2VydmVyS2V5ID0gdXJpLmF1dGhvcml0eSgpOwogICAgICAgIGlmICghLzovLnRlc3Qoc2VydmVyS2V5KSkgewogICAgICAgICAgc2VydmVyS2V5ID0gYCR7c2VydmVyS2V5fToke3VyaS5zY2hlbWUoKSA9PT0gImh0dHBzIiA/ICI0NDMiIDogIjgwIn1gOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbc2VydmVyS2V5XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChsZW5ndGgpKSB7CiAgICAgICAgICBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXJbc2VydmVyS2V5XSA9IDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZXJ2ZXJLZXk7CiAgICAgIH07CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIucmVxdWVzdCA9IGZ1bmN0aW9uKHJlcXVlc3QpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlcXVlc3QiLCByZXF1ZXN0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5zdHJpbmcoInJlcXVlc3QudXJsIiwgcmVxdWVzdC51cmwpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLmZ1bmMoInJlcXVlc3QucmVxdWVzdEZ1bmN0aW9uIiwgcmVxdWVzdC5yZXF1ZXN0RnVuY3Rpb24pOwogICAgICAgIGlmIChpc0RhdGFVcmlfZGVmYXVsdChyZXF1ZXN0LnVybCkgfHwgaXNCbG9iVXJpX2RlZmF1bHQocmVxdWVzdC51cmwpKSB7CiAgICAgICAgICByZXF1ZXN0Q29tcGxldGVkRXZlbnQucmFpc2VFdmVudCgpOwogICAgICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LlJFQ0VJVkVEOwogICAgICAgICAgcmV0dXJuIHJlcXVlc3QucmVxdWVzdEZ1bmN0aW9uKCk7CiAgICAgICAgfQogICAgICAgICsrc3RhdGlzdGljcy5udW1iZXJPZkF0dGVtcHRlZFJlcXVlc3RzOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlcXVlc3Quc2VydmVyS2V5KSkgewogICAgICAgICAgcmVxdWVzdC5zZXJ2ZXJLZXkgPSBSZXF1ZXN0U2NoZWR1bGVyLmdldFNlcnZlcktleShyZXF1ZXN0LnVybCk7CiAgICAgICAgfQogICAgICAgIGlmIChSZXF1ZXN0U2NoZWR1bGVyLnRocm90dGxlUmVxdWVzdHMgJiYgcmVxdWVzdC50aHJvdHRsZUJ5U2VydmVyICYmICFSZXF1ZXN0U2NoZWR1bGVyLnNlcnZlckhhc09wZW5TbG90cyhyZXF1ZXN0LnNlcnZlcktleSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghUmVxdWVzdFNjaGVkdWxlci50aHJvdHRsZVJlcXVlc3RzIHx8ICFyZXF1ZXN0LnRocm90dGxlKSB7CiAgICAgICAgICByZXR1cm4gc3RhcnRSZXF1ZXN0KHJlcXVlc3QpOwogICAgICAgIH0KICAgICAgICBpZiAoYWN0aXZlUmVxdWVzdHMubGVuZ3RoID49IFJlcXVlc3RTY2hlZHVsZXIubWF4aW11bVJlcXVlc3RzKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICB1cGRhdGVQcmlvcml0eShyZXF1ZXN0KTsKICAgICAgICBjb25zdCByZW1vdmVkUmVxdWVzdCA9IHJlcXVlc3RIZWFwLmluc2VydChyZXF1ZXN0KTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlbW92ZWRSZXF1ZXN0KSkgewogICAgICAgICAgaWYgKHJlbW92ZWRSZXF1ZXN0ID09PSByZXF1ZXN0KSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBjYW5jZWxSZXF1ZXN0KHJlbW92ZWRSZXF1ZXN0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlzc3VlUmVxdWVzdChyZXF1ZXN0KTsKICAgICAgfTsKICAgICAgUmVxdWVzdFNjaGVkdWxlci5jbGVhckZvclNwZWNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgd2hpbGUgKHJlcXVlc3RIZWFwLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IHJlcXVlc3QgPSByZXF1ZXN0SGVhcC5wb3AoKTsKICAgICAgICAgIGNhbmNlbFJlcXVlc3QocmVxdWVzdCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGFjdGl2ZVJlcXVlc3RzLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjYW5jZWxSZXF1ZXN0KGFjdGl2ZVJlcXVlc3RzW2ldKTsKICAgICAgICB9CiAgICAgICAgYWN0aXZlUmVxdWVzdHMubGVuZ3RoID0gMDsKICAgICAgICBudW1iZXJPZkFjdGl2ZVJlcXVlc3RzQnlTZXJ2ZXIgPSB7fTsKICAgICAgICBzdGF0aXN0aWNzLm51bWJlck9mQXR0ZW1wdGVkUmVxdWVzdHMgPSAwOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0cyA9IDA7CiAgICAgICAgc3RhdGlzdGljcy5udW1iZXJPZkNhbmNlbGxlZFJlcXVlc3RzID0gMDsKICAgICAgICBzdGF0aXN0aWNzLm51bWJlck9mQ2FuY2VsbGVkQWN0aXZlUmVxdWVzdHMgPSAwOwogICAgICAgIHN0YXRpc3RpY3MubnVtYmVyT2ZGYWlsZWRSZXF1ZXN0cyA9IDA7CiAgICAgICAgc3RhdGlzdGljcy5udW1iZXJPZkFjdGl2ZVJlcXVlc3RzRXZlciA9IDA7CiAgICAgICAgc3RhdGlzdGljcy5sYXN0TnVtYmVyT2ZBY3RpdmVSZXF1ZXN0cyA9IDA7CiAgICAgIH07CiAgICAgIFJlcXVlc3RTY2hlZHVsZXIubnVtYmVyT2ZBY3RpdmVSZXF1ZXN0c0J5U2VydmVyID0gZnVuY3Rpb24oc2VydmVyS2V5KSB7CiAgICAgICAgcmV0dXJuIG51bWJlck9mQWN0aXZlUmVxdWVzdHNCeVNlcnZlcltzZXJ2ZXJLZXldOwogICAgICB9OwogICAgICBSZXF1ZXN0U2NoZWR1bGVyLnJlcXVlc3RIZWFwID0gcmVxdWVzdEhlYXA7CiAgICAgIFJlcXVlc3RTY2hlZHVsZXJfZGVmYXVsdCA9IFJlcXVlc3RTY2hlZHVsZXI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9UcnVzdGVkU2VydmVycy5qcwogIGZ1bmN0aW9uIGdldEF1dGhvcml0eSh1cmwpIHsKICAgIGNvbnN0IHVyaSA9IG5ldyBpbXBvcnRfdXJpanM1LmRlZmF1bHQodXJsKTsKICAgIHVyaS5ub3JtYWxpemUoKTsKICAgIGxldCBhdXRob3JpdHkgPSB1cmkuYXV0aG9yaXR5KCk7CiAgICBpZiAoYXV0aG9yaXR5Lmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgdXJpLmF1dGhvcml0eShhdXRob3JpdHkpOwogICAgaWYgKGF1dGhvcml0eS5pbmRleE9mKCJAIikgIT09IC0xKSB7CiAgICAgIGNvbnN0IHBhcnRzID0gYXV0aG9yaXR5LnNwbGl0KCJAIik7CiAgICAgIGF1dGhvcml0eSA9IHBhcnRzWzFdOwogICAgfQogICAgaWYgKGF1dGhvcml0eS5pbmRleE9mKCI6IikgPT09IC0xKSB7CiAgICAgIGxldCBzY2hlbWUgPSB1cmkuc2NoZW1lKCk7CiAgICAgIGlmIChzY2hlbWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgc2NoZW1lID0gd2luZG93LmxvY2F0aW9uLnByb3RvY29sOwogICAgICAgIHNjaGVtZSA9IHNjaGVtZS5zdWJzdHJpbmcoMCwgc2NoZW1lLmxlbmd0aCAtIDEpOwogICAgICB9CiAgICAgIGlmIChzY2hlbWUgPT09ICJodHRwIikgewogICAgICAgIGF1dGhvcml0eSArPSAiOjgwIjsKICAgICAgfSBlbHNlIGlmIChzY2hlbWUgPT09ICJodHRwcyIpIHsKICAgICAgICBhdXRob3JpdHkgKz0gIjo0NDMiOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBhdXRob3JpdHk7CiAgfQogIHZhciBpbXBvcnRfdXJpanM1LCBUcnVzdGVkU2VydmVycywgX3NlcnZlcnMsIFRydXN0ZWRTZXJ2ZXJzX2RlZmF1bHQ7CiAgdmFyIGluaXRfVHJ1c3RlZFNlcnZlcnMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RydXN0ZWRTZXJ2ZXJzLmpzIigpIHsKICAgICAgaW1wb3J0X3VyaWpzNSA9IF9fdG9FU00ocmVxdWlyZV9VUkkoKSwgMSk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIFRydXN0ZWRTZXJ2ZXJzID0ge307CiAgICAgIF9zZXJ2ZXJzID0ge307CiAgICAgIFRydXN0ZWRTZXJ2ZXJzLmFkZCA9IGZ1bmN0aW9uKGhvc3QsIHBvcnQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChob3N0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImhvc3QgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvcnQpIHx8IHBvcnQgPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBvcnQgaXMgcmVxdWlyZWQgdG8gYmUgZ3JlYXRlciB0aGFuIDAuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF1dGhvcml0eSA9IGAke2hvc3QudG9Mb3dlckNhc2UoKX06JHtwb3J0fWA7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoX3NlcnZlcnNbYXV0aG9yaXR5XSkpIHsKICAgICAgICAgIF9zZXJ2ZXJzW2F1dGhvcml0eV0gPSB0cnVlOwogICAgICAgIH0KICAgICAgfTsKICAgICAgVHJ1c3RlZFNlcnZlcnMucmVtb3ZlID0gZnVuY3Rpb24oaG9zdCwgcG9ydCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhvc3QpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaG9zdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9ydCkgfHwgcG9ydCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicG9ydCBpcyByZXF1aXJlZCB0byBiZSBncmVhdGVyIHRoYW4gMC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXV0aG9yaXR5ID0gYCR7aG9zdC50b0xvd2VyQ2FzZSgpfToke3BvcnR9YDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KF9zZXJ2ZXJzW2F1dGhvcml0eV0pKSB7CiAgICAgICAgICBkZWxldGUgX3NlcnZlcnNbYXV0aG9yaXR5XTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFRydXN0ZWRTZXJ2ZXJzLmNvbnRhaW5zID0gZnVuY3Rpb24odXJsKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodXJsKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInVybCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXV0aG9yaXR5ID0gZ2V0QXV0aG9yaXR5KHVybCk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChhdXRob3JpdHkpICYmIGRlZmluZWRfZGVmYXVsdChfc2VydmVyc1thdXRob3JpdHldKSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgICAgVHJ1c3RlZFNlcnZlcnMuY2xlYXIgPSBmdW5jdGlvbigpIHsKICAgICAgICBfc2VydmVycyA9IHt9OwogICAgICB9OwogICAgICBUcnVzdGVkU2VydmVyc19kZWZhdWx0ID0gVHJ1c3RlZFNlcnZlcnM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZXNvdXJjZS5qcwogIGZ1bmN0aW9uIFJlc291cmNlKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIikgewogICAgICBvcHRpb25zID0gewogICAgICAgIHVybDogb3B0aW9ucwogICAgICB9OwogICAgfQogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yuc3RyaW5nKCJvcHRpb25zLnVybCIsIG9wdGlvbnMudXJsKTsKICAgIHRoaXMuX3VybCA9IHZvaWQgMDsKICAgIHRoaXMuX3RlbXBsYXRlVmFsdWVzID0gZGVmYXVsdENsb25lKG9wdGlvbnMudGVtcGxhdGVWYWx1ZXMsIHt9KTsKICAgIHRoaXMuX3F1ZXJ5UGFyYW1ldGVycyA9IGRlZmF1bHRDbG9uZShvcHRpb25zLnF1ZXJ5UGFyYW1ldGVycywge30pOwogICAgdGhpcy5oZWFkZXJzID0gZGVmYXVsdENsb25lKG9wdGlvbnMuaGVhZGVycywge30pOwogICAgdGhpcy5yZXF1ZXN0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yZXF1ZXN0LCBuZXcgUmVxdWVzdF9kZWZhdWx0KCkpOwogICAgdGhpcy5wcm94eSA9IG9wdGlvbnMucHJveHk7CiAgICB0aGlzLnJldHJ5Q2FsbGJhY2sgPSBvcHRpb25zLnJldHJ5Q2FsbGJhY2s7CiAgICB0aGlzLnJldHJ5QXR0ZW1wdHMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJldHJ5QXR0ZW1wdHMsIDApOwogICAgdGhpcy5fcmV0cnlDb3VudCA9IDA7CiAgICBjb25zdCBwYXJzZVVybCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucGFyc2VVcmwsIHRydWUpOwogICAgaWYgKHBhcnNlVXJsKSB7CiAgICAgIHRoaXMucGFyc2VVcmwob3B0aW9ucy51cmwsIHRydWUsIHRydWUpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fdXJsID0gb3B0aW9ucy51cmw7CiAgICB9CiAgICB0aGlzLl9jcmVkaXRzID0gb3B0aW9ucy5jcmVkaXRzOwogIH0KICBmdW5jdGlvbiBkZWZhdWx0Q2xvbmUodmFsdWUsIGRlZmF1bHRWYWx1ZTIpIHsKICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQodmFsdWUpID8gY2xvbmVfZGVmYXVsdCh2YWx1ZSkgOiBkZWZhdWx0VmFsdWUyOwogIH0KICBmdW5jdGlvbiBwYXJzZVF1ZXJ5U3RyaW5nKHF1ZXJ5U3RyaW5nKSB7CiAgICBpZiAocXVlcnlTdHJpbmcubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB7fTsKICAgIH0KICAgIGlmIChxdWVyeVN0cmluZy5pbmRleE9mKCI9IikgPT09IC0xKSB7CiAgICAgIHJldHVybiB7IFtxdWVyeVN0cmluZ106IHZvaWQgMCB9OwogICAgfQogICAgcmV0dXJuIHF1ZXJ5VG9PYmplY3RfZGVmYXVsdChxdWVyeVN0cmluZyk7CiAgfQogIGZ1bmN0aW9uIGNvbWJpbmVRdWVyeVBhcmFtZXRlcnMocTEyLCBxMjIsIHByZXNlcnZlUXVlcnlQYXJhbWV0ZXJzKSB7CiAgICBpZiAoIXByZXNlcnZlUXVlcnlQYXJhbWV0ZXJzKSB7CiAgICAgIHJldHVybiBjb21iaW5lX2RlZmF1bHQocTEyLCBxMjIpOwogICAgfQogICAgY29uc3QgcmVzdWx0ID0gY2xvbmVfZGVmYXVsdChxMTIsIHRydWUpOwogICAgZm9yIChjb25zdCBwYXJhbSBpbiBxMjIpIHsKICAgICAgaWYgKHEyMi5oYXNPd25Qcm9wZXJ0eShwYXJhbSkpIHsKICAgICAgICBsZXQgdmFsdWUgPSByZXN1bHRbcGFyYW1dOwogICAgICAgIGNvbnN0IHEyVmFsdWUgPSBxMjJbcGFyYW1dOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgIHZhbHVlID0gcmVzdWx0W3BhcmFtXSA9IFt2YWx1ZV07CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHRbcGFyYW1dID0gdmFsdWUuY29uY2F0KHEyVmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHRbcGFyYW1dID0gQXJyYXkuaXNBcnJheShxMlZhbHVlKSA/IHEyVmFsdWUuc2xpY2UoKSA6IHEyVmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBzdHJpbmdpZnlRdWVyeShxdWVyeU9iamVjdCkgewogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHF1ZXJ5T2JqZWN0KTsKICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gIiI7CiAgICB9CiAgICBpZiAoa2V5cy5sZW5ndGggPT09IDEgJiYgIWRlZmluZWRfZGVmYXVsdChxdWVyeU9iamVjdFtrZXlzWzBdXSkpIHsKICAgICAgcmV0dXJuIGA/JHtrZXlzWzBdfWA7CiAgICB9CiAgICByZXR1cm4gYD8ke29iamVjdFRvUXVlcnlfZGVmYXVsdChxdWVyeU9iamVjdCl9YDsKICB9CiAgZnVuY3Rpb24gZmV0Y2hJbWFnZShvcHRpb25zKSB7CiAgICBjb25zdCByZXNvdXJjZSA9IG9wdGlvbnMucmVzb3VyY2U7CiAgICBjb25zdCBmbGlwWSA9IG9wdGlvbnMuZmxpcFk7CiAgICBjb25zdCBza2lwQ29sb3JTcGFjZUNvbnZlcnNpb24gPSBvcHRpb25zLnNraXBDb2xvclNwYWNlQ29udmVyc2lvbjsKICAgIGNvbnN0IHByZWZlckltYWdlQml0bWFwID0gb3B0aW9ucy5wcmVmZXJJbWFnZUJpdG1hcDsKICAgIGNvbnN0IHJlcXVlc3QgPSByZXNvdXJjZS5yZXF1ZXN0OwogICAgcmVxdWVzdC51cmwgPSByZXNvdXJjZS51cmw7CiAgICByZXF1ZXN0LnJlcXVlc3RGdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICBsZXQgY3Jvc3NPcmlnaW4gPSBmYWxzZTsKICAgICAgaWYgKCFyZXNvdXJjZS5pc0RhdGFVcmkgJiYgIXJlc291cmNlLmlzQmxvYlVyaSkgewogICAgICAgIGNyb3NzT3JpZ2luID0gcmVzb3VyY2UuaXNDcm9zc09yaWdpblVybDsKICAgICAgfQogICAgICBjb25zdCBkZWZlcnJlZCA9IGRlZmVyX2RlZmF1bHQoKTsKICAgICAgUmVzb3VyY2UuX0ltcGxlbWVudGF0aW9ucy5jcmVhdGVJbWFnZSgKICAgICAgICByZXF1ZXN0LAogICAgICAgIGNyb3NzT3JpZ2luLAogICAgICAgIGRlZmVycmVkLAogICAgICAgIGZsaXBZLAogICAgICAgIHNraXBDb2xvclNwYWNlQ29udmVyc2lvbiwKICAgICAgICBwcmVmZXJJbWFnZUJpdG1hcAogICAgICApOwogICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICAgIH07CiAgICBjb25zdCBwcm9taXNlID0gUmVxdWVzdFNjaGVkdWxlcl9kZWZhdWx0LnJlcXVlc3QocmVxdWVzdCk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcm9taXNlKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICByZXR1cm4gcHJvbWlzZS5jYXRjaChmdW5jdGlvbihlKSB7CiAgICAgIGlmIChyZXF1ZXN0LnN0YXRlICE9PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5GQUlMRUQpIHsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc291cmNlLnJldHJ5T25FcnJvcihlKS50aGVuKGZ1bmN0aW9uKHJldHJ5KSB7CiAgICAgICAgaWYgKHJldHJ5KSB7CiAgICAgICAgICByZXF1ZXN0LnN0YXRlID0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuVU5JU1NVRUQ7CiAgICAgICAgICByZXF1ZXN0LmRlZmVycmVkID0gdm9pZCAwOwogICAgICAgICAgcmV0dXJuIGZldGNoSW1hZ2UoewogICAgICAgICAgICByZXNvdXJjZSwKICAgICAgICAgICAgZmxpcFksCiAgICAgICAgICAgIHNraXBDb2xvclNwYWNlQ29udmVyc2lvbiwKICAgICAgICAgICAgcHJlZmVySW1hZ2VCaXRtYXAKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSk7CiAgICAgIH0pOwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGZldGNoSnNvbnAocmVzb3VyY2UsIGNhbGxiYWNrUGFyYW1ldGVyTmFtZSwgZnVuY3Rpb25OYW1lKSB7CiAgICBjb25zdCBjYWxsYmFja1F1ZXJ5ID0ge307CiAgICBjYWxsYmFja1F1ZXJ5W2NhbGxiYWNrUGFyYW1ldGVyTmFtZV0gPSBmdW5jdGlvbk5hbWU7CiAgICByZXNvdXJjZS5zZXRRdWVyeVBhcmFtZXRlcnMoY2FsbGJhY2tRdWVyeSk7CiAgICBjb25zdCByZXF1ZXN0ID0gcmVzb3VyY2UucmVxdWVzdDsKICAgIGNvbnN0IHVybCA9IHJlc291cmNlLnVybDsKICAgIHJlcXVlc3QudXJsID0gdXJsOwogICAgcmVxdWVzdC5yZXF1ZXN0RnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgY29uc3QgZGVmZXJyZWQgPSBkZWZlcl9kZWZhdWx0KCk7CiAgICAgIHdpbmRvd1tmdW5jdGlvbk5hbWVdID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgIGRlZmVycmVkLnJlc29sdmUoZGF0YSk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGRlbGV0ZSB3aW5kb3dbZnVuY3Rpb25OYW1lXTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB3aW5kb3dbZnVuY3Rpb25OYW1lXSA9IHZvaWQgMDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMubG9hZEFuZEV4ZWN1dGVTY3JpcHQodXJsLCBmdW5jdGlvbk5hbWUsIGRlZmVycmVkKTsKICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAgICB9OwogICAgY29uc3QgcHJvbWlzZSA9IFJlcXVlc3RTY2hlZHVsZXJfZGVmYXVsdC5yZXF1ZXN0KHJlcXVlc3QpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocHJvbWlzZSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcmV0dXJuIHByb21pc2UuY2F0Y2goZnVuY3Rpb24oZSkgewogICAgICBpZiAocmVxdWVzdC5zdGF0ZSAhPT0gUmVxdWVzdFN0YXRlX2RlZmF1bHQuRkFJTEVEKSB7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGUpOwogICAgICB9CiAgICAgIHJldHVybiByZXNvdXJjZS5yZXRyeU9uRXJyb3IoZSkudGhlbihmdW5jdGlvbihyZXRyeSkgewogICAgICAgIGlmIChyZXRyeSkgewogICAgICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LlVOSVNTVUVEOwogICAgICAgICAgcmVxdWVzdC5kZWZlcnJlZCA9IHZvaWQgMDsKICAgICAgICAgIHJldHVybiBmZXRjaEpzb25wKHJlc291cmNlLCBjYWxsYmFja1BhcmFtZXRlck5hbWUsIGZ1bmN0aW9uTmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlKTsKICAgICAgfSk7CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gY2hlY2tBbmRSZXNldFJlcXVlc3QocmVxdWVzdCkgewogICAgaWYgKHJlcXVlc3Quc3RhdGUgPT09IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LklTU1VFRCB8fCByZXF1ZXN0LnN0YXRlID09PSBSZXF1ZXN0U3RhdGVfZGVmYXVsdC5BQ1RJVkUpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJUaGUgUmVzb3VyY2UgaXMgYWxyZWFkeSBiZWluZyBmZXRjaGVkLiIpOwogICAgfQogICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LlVOSVNTVUVEOwogICAgcmVxdWVzdC5kZWZlcnJlZCA9IHZvaWQgMDsKICB9CiAgZnVuY3Rpb24gZGVjb2RlRGF0YVVyaVRleHQoaXNCYXNlNjQsIGRhdGEpIHsKICAgIGNvbnN0IHJlc3VsdCA9IGRlY29kZVVSSUNvbXBvbmVudChkYXRhKTsKICAgIGlmIChpc0Jhc2U2NCkgewogICAgICByZXR1cm4gYXRvYihyZXN1bHQpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gZGVjb2RlRGF0YVVyaUFycmF5QnVmZmVyKGlzQmFzZTY0LCBkYXRhKSB7CiAgICBjb25zdCBieXRlU3RyaW5nID0gZGVjb2RlRGF0YVVyaVRleHQoaXNCYXNlNjQsIGRhdGEpOwogICAgY29uc3QgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKGJ5dGVTdHJpbmcubGVuZ3RoKTsKICAgIGNvbnN0IHZpZXcgPSBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBieXRlU3RyaW5nLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZpZXdbaV0gPSBieXRlU3RyaW5nLmNoYXJDb2RlQXQoaSk7CiAgICB9CiAgICByZXR1cm4gYnVmZmVyOwogIH0KICBmdW5jdGlvbiBkZWNvZGVEYXRhVXJpKGRhdGFVcmlSZWdleFJlc3VsdCwgcmVzcG9uc2VUeXBlKSB7CiAgICByZXNwb25zZVR5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChyZXNwb25zZVR5cGUsICIiKTsKICAgIGNvbnN0IG1pbWVUeXBlID0gZGF0YVVyaVJlZ2V4UmVzdWx0WzFdOwogICAgY29uc3QgaXNCYXNlNjQgPSAhIWRhdGFVcmlSZWdleFJlc3VsdFsyXTsKICAgIGNvbnN0IGRhdGEgPSBkYXRhVXJpUmVnZXhSZXN1bHRbM107CiAgICBsZXQgYnVmZmVyOwogICAgbGV0IHBhcnNlcjsKICAgIHN3aXRjaCAocmVzcG9uc2VUeXBlKSB7CiAgICAgIGNhc2UgIiI6CiAgICAgIGNhc2UgInRleHQiOgogICAgICAgIHJldHVybiBkZWNvZGVEYXRhVXJpVGV4dChpc0Jhc2U2NCwgZGF0YSk7CiAgICAgIGNhc2UgImFycmF5YnVmZmVyIjoKICAgICAgICByZXR1cm4gZGVjb2RlRGF0YVVyaUFycmF5QnVmZmVyKGlzQmFzZTY0LCBkYXRhKTsKICAgICAgY2FzZSAiYmxvYiI6CiAgICAgICAgYnVmZmVyID0gZGVjb2RlRGF0YVVyaUFycmF5QnVmZmVyKGlzQmFzZTY0LCBkYXRhKTsKICAgICAgICByZXR1cm4gbmV3IEJsb2IoW2J1ZmZlcl0sIHsKICAgICAgICAgIHR5cGU6IG1pbWVUeXBlCiAgICAgICAgfSk7CiAgICAgIGNhc2UgImRvY3VtZW50IjoKICAgICAgICBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7CiAgICAgICAgcmV0dXJuIHBhcnNlci5wYXJzZUZyb21TdHJpbmcoCiAgICAgICAgICBkZWNvZGVEYXRhVXJpVGV4dChpc0Jhc2U2NCwgZGF0YSksCiAgICAgICAgICBtaW1lVHlwZQogICAgICAgICk7CiAgICAgIGNhc2UgImpzb24iOgogICAgICAgIHJldHVybiBKU09OLnBhcnNlKGRlY29kZURhdGFVcmlUZXh0KGlzQmFzZTY0LCBkYXRhKSk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoYFVuaGFuZGxlZCByZXNwb25zZVR5cGU6ICR7cmVzcG9uc2VUeXBlfWApOwogICAgfQogIH0KICBmdW5jdGlvbiBsb2FkV2l0aEh0dHBSZXF1ZXN0KHVybCwgcmVzcG9uc2VUeXBlLCBtZXRob2QsIGRhdGEsIGhlYWRlcnMsIGRlZmVycmVkLCBvdmVycmlkZU1pbWVUeXBlKSB7CiAgICBmZXRjaCh1cmwsIHsKICAgICAgbWV0aG9kLAogICAgICBoZWFkZXJzCiAgICB9KS50aGVuKGFzeW5jIChyZXNwb25zZSkgPT4gewogICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7CiAgICAgICAgY29uc3QgcmVzcG9uc2VIZWFkZXJzID0ge307CiAgICAgICAgcmVzcG9uc2UuaGVhZGVycy5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiB7CiAgICAgICAgICByZXNwb25zZUhlYWRlcnNba2V5XSA9IHZhbHVlOwogICAgICAgIH0pOwogICAgICAgIGRlZmVycmVkLnJlamVjdCgKICAgICAgICAgIG5ldyBSZXF1ZXN0RXJyb3JFdmVudF9kZWZhdWx0KHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UsIHJlc3BvbnNlSGVhZGVycykKICAgICAgICApOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzd2l0Y2ggKHJlc3BvbnNlVHlwZSkgewogICAgICAgIGNhc2UgInRleHQiOgogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXNwb25zZS50ZXh0KCkpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAianNvbiI6CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlc3BvbnNlLmpzb24oKSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShuZXcgVWludDhBcnJheShhd2FpdCByZXNwb25zZS5hcnJheUJ1ZmZlcigpKS5idWZmZXIpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0pLmNhdGNoKCgpID0+IHsKICAgICAgZGVmZXJyZWQucmVqZWN0KG5ldyBSZXF1ZXN0RXJyb3JFdmVudF9kZWZhdWx0KCkpOwogICAgfSk7CiAgfQogIHZhciBpbXBvcnRfdXJpanM2LCB4aHJCbG9iU3VwcG9ydGVkLCBzdXBwb3J0c0ltYWdlQml0bWFwT3B0aW9uc1Byb21pc2UsIGRhdGFVcmlSZWdleDIsIG5vWE1MSHR0cFJlcXVlc3QsIFJlc291cmNlX2RlZmF1bHQ7CiAgdmFyIGluaXRfUmVzb3VyY2UgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1Jlc291cmNlLmpzIigpIHsKICAgICAgaW1wb3J0X3VyaWpzNiA9IF9fdG9FU00ocmVxdWlyZV9VUkkoKSwgMSk7CiAgICAgIGluaXRfYXBwZW5kRm9yd2FyZFNsYXNoKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9jbG9uZSgpOwogICAgICBpbml0X2NvbWJpbmUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZlcigpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X2dldEFic29sdXRlVXJpKCk7CiAgICAgIGluaXRfZ2V0QmFzZVVyaSgpOwogICAgICBpbml0X2dldEV4dGVuc2lvbkZyb21VcmkoKTsKICAgICAgaW5pdF9nZXRJbWFnZVBpeGVscygpOwogICAgICBpbml0X2lzQmxvYlVyaSgpOwogICAgICBpbml0X2lzQ3Jvc3NPcmlnaW5VcmwoKTsKICAgICAgaW5pdF9pc0RhdGFVcmkoKTsKICAgICAgaW5pdF9sb2FkQW5kRXhlY3V0ZVNjcmlwdCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9vYmplY3RUb1F1ZXJ5KCk7CiAgICAgIGluaXRfcXVlcnlUb09iamVjdCgpOwogICAgICBpbml0X1JlcXVlc3QoKTsKICAgICAgaW5pdF9SZXF1ZXN0RXJyb3JFdmVudCgpOwogICAgICBpbml0X1JlcXVlc3RTY2hlZHVsZXIoKTsKICAgICAgaW5pdF9SZXF1ZXN0U3RhdGUoKTsKICAgICAgaW5pdF9SdW50aW1lRXJyb3IoKTsKICAgICAgaW5pdF9UcnVzdGVkU2VydmVycygpOwogICAgICB4aHJCbG9iU3VwcG9ydGVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnN0IHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgeGhyLm9wZW4oIkdFVCIsICIjIiwgdHJ1ZSk7CiAgICAgICAgICB4aHIucmVzcG9uc2VUeXBlID0gImJsb2IiOwogICAgICAgICAgcmV0dXJuIHhoci5yZXNwb25zZVR5cGUgPT09ICJibG9iIjsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9KCk7CiAgICAgIFJlc291cmNlLmNyZWF0ZUlmTmVlZGVkID0gZnVuY3Rpb24ocmVzb3VyY2UpIHsKICAgICAgICBpZiAocmVzb3VyY2UgaW5zdGFuY2VvZiBSZXNvdXJjZSkgewogICAgICAgICAgcmV0dXJuIHJlc291cmNlLmdldERlcml2ZWRSZXNvdXJjZSh7CiAgICAgICAgICAgIHJlcXVlc3Q6IHJlc291cmNlLnJlcXVlc3QKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIHJlc291cmNlICE9PSAic3RyaW5nIikgewogICAgICAgICAgcmV0dXJuIHJlc291cmNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IFJlc291cmNlKHsKICAgICAgICAgIHVybDogcmVzb3VyY2UKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2Uuc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnMgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN1cHBvcnRzSW1hZ2VCaXRtYXBPcHRpb25zUHJvbWlzZSkpIHsKICAgICAgICAgIHJldHVybiBzdXBwb3J0c0ltYWdlQml0bWFwT3B0aW9uc1Byb21pc2U7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgY3JlYXRlSW1hZ2VCaXRtYXAgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHN1cHBvcnRzSW1hZ2VCaXRtYXBPcHRpb25zUHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZShmYWxzZSk7CiAgICAgICAgICByZXR1cm4gc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnNQcm9taXNlOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbWFnZURhdGFVcmkgPSAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBRUFBQUFCQ0FJQUFBQ1FkMVBlQUFBQUJHZEJUVUVBQUU0ZzNyRWlEZ0FBQUNCalNGSk5BQUI2SmdBQWdJUUFBUG9BQUFDQTZBQUFkVEFBQU9wZ0FBQTZtQUFBRjNDY3VsRThBQUFBREVsRVFWUUkxMk5nNkdBQUFBRVVBSW5nRTNaaUFBQUFBRWxGVGtTdVFtQ0MiOwogICAgICAgIHN1cHBvcnRzSW1hZ2VCaXRtYXBPcHRpb25zUHJvbWlzZSA9IFJlc291cmNlLmZldGNoQmxvYih7CiAgICAgICAgICB1cmw6IGltYWdlRGF0YVVyaQogICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oYmxvYikgewogICAgICAgICAgY29uc3QgaW1hZ2VCaXRtYXBPcHRpb25zID0gewogICAgICAgICAgICBpbWFnZU9yaWVudGF0aW9uOiAiZmxpcFkiLAogICAgICAgICAgICAvLyBkZWZhdWx0IGlzICJub25lIgogICAgICAgICAgICBwcmVtdWx0aXBseUFscGhhOiAibm9uZSIsCiAgICAgICAgICAgIC8vIGRlZmF1bHQgaXMgImRlZmF1bHQiCiAgICAgICAgICAgIGNvbG9yU3BhY2VDb252ZXJzaW9uOiAibm9uZSIKICAgICAgICAgICAgLy8gZGVmYXVsdCBpcyAiZGVmYXVsdCIKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoWwogICAgICAgICAgICBjcmVhdGVJbWFnZUJpdG1hcChibG9iLCBpbWFnZUJpdG1hcE9wdGlvbnMpLAogICAgICAgICAgICBjcmVhdGVJbWFnZUJpdG1hcChibG9iKQogICAgICAgICAgXSk7CiAgICAgICAgfSkudGhlbihmdW5jdGlvbihpbWFnZUJpdG1hcHMpIHsKICAgICAgICAgIGNvbnN0IGNvbG9yV2l0aE9wdGlvbnMgPSBnZXRJbWFnZVBpeGVsc19kZWZhdWx0KGltYWdlQml0bWFwc1swXSk7CiAgICAgICAgICBjb25zdCBjb2xvcldpdGhEZWZhdWx0cyA9IGdldEltYWdlUGl4ZWxzX2RlZmF1bHQoaW1hZ2VCaXRtYXBzWzFdKTsKICAgICAgICAgIHJldHVybiBjb2xvcldpdGhPcHRpb25zWzFdICE9PSBjb2xvcldpdGhEZWZhdWx0c1sxXTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnNQcm9taXNlOwogICAgICB9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhSZXNvdXJjZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgdHJ1ZSBpZiBibG9icyBhcmUgc3VwcG9ydGVkLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlc291cmNlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICoKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBpc0Jsb2JTdXBwb3J0ZWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB4aHJCbG9iU3VwcG9ydGVkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFJlc291cmNlLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFF1ZXJ5IHBhcmFtZXRlcnMgYXBwZW5kZWQgdG8gdGhlIHVybC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBSZXNvdXJjZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7b2JqZWN0fQogICAgICAgICAqCiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgcXVlcnlQYXJhbWV0ZXJzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcXVlcnlQYXJhbWV0ZXJzOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGtleS92YWx1ZSBwYWlycyB1c2VkIHRvIHJlcGxhY2UgdGVtcGxhdGUgcGFyYW1ldGVycyBpbiB0aGUgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlc291cmNlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAgICAgICoKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICB0ZW1wbGF0ZVZhbHVlczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RlbXBsYXRlVmFsdWVzOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIHVybCB0byB0aGUgcmVzb3VyY2Ugd2l0aCB0ZW1wbGF0ZSB2YWx1ZXMgcmVwbGFjZWQsIHF1ZXJ5IHN0cmluZyBhcHBlbmRlZCBhbmQgZW5jb2RlZCBieSBwcm94eSBpZiBvbmUgd2FzIHNldC4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJvZiBSZXNvdXJjZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHVybDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VXJsQ29tcG9uZW50KHRydWUsIHRydWUpOwogICAgICAgICAgfSwKICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5wYXJzZVVybCh2YWx1ZSwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBmaWxlIGV4dGVuc2lvbiBvZiB0aGUgcmVzb3VyY2UuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUmVzb3VyY2UucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKgogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGV4dGVuc2lvbjogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEV4dGVuc2lvbkZyb21VcmlfZGVmYXVsdCh0aGlzLl91cmwpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVHJ1ZSBpZiB0aGUgUmVzb3VyY2UgcmVmZXJzIHRvIGEgZGF0YSBVUkkuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUmVzb3VyY2UucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNEYXRhVXJpOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gaXNEYXRhVXJpX2RlZmF1bHQodGhpcy5fdXJsKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRydWUgaWYgdGhlIFJlc291cmNlIHJlZmVycyB0byBhIGJsb2IgVVJJLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlc291cmNlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtib29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzQmxvYlVyaTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGlzQmxvYlVyaV9kZWZhdWx0KHRoaXMuX3VybCk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBSZXNvdXJjZSByZWZlcnMgdG8gYSBjcm9zcyBvcmlnaW4gVVJMLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIFJlc291cmNlLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtib29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzQ3Jvc3NPcmlnaW5Vcmw6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBpc0Nyb3NzT3JpZ2luVXJsX2RlZmF1bHQodGhpcy5fdXJsKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRydWUgaWYgdGhlIFJlc291cmNlIGhhcyByZXF1ZXN0IGhlYWRlcnMuIFRoaXMgaXMgZXF1aXZhbGVudCB0byBjaGVja2luZyBpZiB0aGUgaGVhZGVycyBwcm9wZXJ0eSBoYXMgYW55IGtleXMuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUmVzb3VyY2UucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaGFzSGVhZGVyczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuaGVhZGVycykubGVuZ3RoID4gMDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGNyZWRpdHMgcmVxdWlyZWQgZm9yIGF0dHJpYnV0aW9uIG9mIGFuIGFzc2V0LgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgY3JlZGl0czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NyZWRpdHM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VXJsQ29tcG9uZW50KHRydWUsIHRydWUpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUucGFyc2VVcmwgPSBmdW5jdGlvbih1cmwsIG1lcmdlLCBwcmVzZXJ2ZVF1ZXJ5LCBiYXNlVXJsKSB7CiAgICAgICAgbGV0IHVyaSA9IG5ldyBpbXBvcnRfdXJpanM2LmRlZmF1bHQodXJsKTsKICAgICAgICBjb25zdCBxdWVyeSA9IHBhcnNlUXVlcnlTdHJpbmcodXJpLnF1ZXJ5KCkpOwogICAgICAgIHRoaXMuX3F1ZXJ5UGFyYW1ldGVycyA9IG1lcmdlID8gY29tYmluZVF1ZXJ5UGFyYW1ldGVycyhxdWVyeSwgdGhpcy5xdWVyeVBhcmFtZXRlcnMsIHByZXNlcnZlUXVlcnkpIDogcXVlcnk7CiAgICAgICAgdXJpLnNlYXJjaCgiIik7CiAgICAgICAgdXJpLmZyYWdtZW50KCIiKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJhc2VVcmwpICYmIHVyaS5zY2hlbWUoKSA9PT0gIiIpIHsKICAgICAgICAgIHVyaSA9IHVyaS5hYnNvbHV0ZVRvKGdldEFic29sdXRlVXJpX2RlZmF1bHQoYmFzZVVybCkpOwogICAgICAgIH0KICAgICAgICB0aGlzLl91cmwgPSB1cmkudG9TdHJpbmcoKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmdldFVybENvbXBvbmVudCA9IGZ1bmN0aW9uKHF1ZXJ5LCBwcm94eSkgewogICAgICAgIGlmICh0aGlzLmlzRGF0YVVyaSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3VybDsKICAgICAgICB9CiAgICAgICAgbGV0IHVybCA9IHRoaXMuX3VybDsKICAgICAgICBpZiAocXVlcnkpIHsKICAgICAgICAgIHVybCA9IGAke3VybH0ke3N0cmluZ2lmeVF1ZXJ5KHRoaXMucXVlcnlQYXJhbWV0ZXJzKX1gOwogICAgICAgIH0KICAgICAgICB1cmwgPSB1cmwucmVwbGFjZSgvJTdCL2csICJ7IikucmVwbGFjZSgvJTdEL2csICJ9Iik7CiAgICAgICAgY29uc3QgdGVtcGxhdGVWYWx1ZXMgPSB0aGlzLl90ZW1wbGF0ZVZhbHVlczsKICAgICAgICBpZiAoT2JqZWN0LmtleXModGVtcGxhdGVWYWx1ZXMpLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKC97KC4qPyl9L2csIGZ1bmN0aW9uKG1hdGNoLCBrZXkpIHsKICAgICAgICAgICAgY29uc3QgcmVwbGFjZW1lbnQgPSB0ZW1wbGF0ZVZhbHVlc1trZXldOwogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlcGxhY2VtZW50KSkgewogICAgICAgICAgICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQocmVwbGFjZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAocHJveHkgJiYgZGVmaW5lZF9kZWZhdWx0KHRoaXMucHJveHkpKSB7CiAgICAgICAgICB1cmwgPSB0aGlzLnByb3h5LmdldFVSTCh1cmwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdXJsOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuc2V0UXVlcnlQYXJhbWV0ZXJzID0gZnVuY3Rpb24ocGFyYW1zLCB1c2VBc0RlZmF1bHQpIHsKICAgICAgICBpZiAodXNlQXNEZWZhdWx0KSB7CiAgICAgICAgICB0aGlzLl9xdWVyeVBhcmFtZXRlcnMgPSBjb21iaW5lUXVlcnlQYXJhbWV0ZXJzKAogICAgICAgICAgICB0aGlzLl9xdWVyeVBhcmFtZXRlcnMsCiAgICAgICAgICAgIHBhcmFtcywKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX3F1ZXJ5UGFyYW1ldGVycyA9IGNvbWJpbmVRdWVyeVBhcmFtZXRlcnMoCiAgICAgICAgICAgIHBhcmFtcywKICAgICAgICAgICAgdGhpcy5fcXVlcnlQYXJhbWV0ZXJzLAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5hcHBlbmRRdWVyeVBhcmFtZXRlcnMgPSBmdW5jdGlvbihwYXJhbXMpIHsKICAgICAgICB0aGlzLl9xdWVyeVBhcmFtZXRlcnMgPSBjb21iaW5lUXVlcnlQYXJhbWV0ZXJzKAogICAgICAgICAgcGFyYW1zLAogICAgICAgICAgdGhpcy5fcXVlcnlQYXJhbWV0ZXJzLAogICAgICAgICAgdHJ1ZQogICAgICAgICk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5zZXRUZW1wbGF0ZVZhbHVlcyA9IGZ1bmN0aW9uKHRlbXBsYXRlLCB1c2VBc0RlZmF1bHQpIHsKICAgICAgICBpZiAodXNlQXNEZWZhdWx0KSB7CiAgICAgICAgICB0aGlzLl90ZW1wbGF0ZVZhbHVlcyA9IGNvbWJpbmVfZGVmYXVsdCh0aGlzLl90ZW1wbGF0ZVZhbHVlcywgdGVtcGxhdGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl90ZW1wbGF0ZVZhbHVlcyA9IGNvbWJpbmVfZGVmYXVsdCh0ZW1wbGF0ZSwgdGhpcy5fdGVtcGxhdGVWYWx1ZXMpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmdldERlcml2ZWRSZXNvdXJjZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IHRoaXMuY2xvbmUoKTsKICAgICAgICByZXNvdXJjZS5fcmV0cnlDb3VudCA9IDA7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLnVybCkpIHsKICAgICAgICAgIGNvbnN0IHByZXNlcnZlUXVlcnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnByZXNlcnZlUXVlcnlQYXJhbWV0ZXJzLCBmYWxzZSk7CiAgICAgICAgICByZXNvdXJjZS5wYXJzZVVybChvcHRpb25zLnVybCwgdHJ1ZSwgcHJlc2VydmVRdWVyeSwgdGhpcy5fdXJsKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLnF1ZXJ5UGFyYW1ldGVycykpIHsKICAgICAgICAgIHJlc291cmNlLl9xdWVyeVBhcmFtZXRlcnMgPSBjb21iaW5lX2RlZmF1bHQoCiAgICAgICAgICAgIG9wdGlvbnMucXVlcnlQYXJhbWV0ZXJzLAogICAgICAgICAgICByZXNvdXJjZS5xdWVyeVBhcmFtZXRlcnMKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy50ZW1wbGF0ZVZhbHVlcykpIHsKICAgICAgICAgIHJlc291cmNlLl90ZW1wbGF0ZVZhbHVlcyA9IGNvbWJpbmVfZGVmYXVsdCgKICAgICAgICAgICAgb3B0aW9ucy50ZW1wbGF0ZVZhbHVlcywKICAgICAgICAgICAgcmVzb3VyY2UudGVtcGxhdGVWYWx1ZXMKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5oZWFkZXJzKSkgewogICAgICAgICAgcmVzb3VyY2UuaGVhZGVycyA9IGNvbWJpbmVfZGVmYXVsdChvcHRpb25zLmhlYWRlcnMsIHJlc291cmNlLmhlYWRlcnMpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMucHJveHkpKSB7CiAgICAgICAgICByZXNvdXJjZS5wcm94eSA9IG9wdGlvbnMucHJveHk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5yZXF1ZXN0KSkgewogICAgICAgICAgcmVzb3VyY2UucmVxdWVzdCA9IG9wdGlvbnMucmVxdWVzdDsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLnJldHJ5Q2FsbGJhY2spKSB7CiAgICAgICAgICByZXNvdXJjZS5yZXRyeUNhbGxiYWNrID0gb3B0aW9ucy5yZXRyeUNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMucmV0cnlBdHRlbXB0cykpIHsKICAgICAgICAgIHJlc291cmNlLnJldHJ5QXR0ZW1wdHMgPSBvcHRpb25zLnJldHJ5QXR0ZW1wdHM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXNvdXJjZTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLnJldHJ5T25FcnJvciA9IGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgY29uc3QgcmV0cnlDYWxsYmFjayA9IHRoaXMucmV0cnlDYWxsYmFjazsKICAgICAgICBpZiAodHlwZW9mIHJldHJ5Q2FsbGJhY2sgIT09ICJmdW5jdGlvbiIgfHwgdGhpcy5fcmV0cnlDb3VudCA+PSB0aGlzLnJldHJ5QXR0ZW1wdHMpIHsKICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoZmFsc2UpOwogICAgICAgIH0KICAgICAgICBjb25zdCB0aGF0ID0gdGhpczsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJldHJ5Q2FsbGJhY2sodGhpcywgZXJyb3IpKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgKyt0aGF0Ll9yZXRyeUNvdW50OwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZXNvdXJjZSh7CiAgICAgICAgICAgIHVybDogdGhpcy5fdXJsLAogICAgICAgICAgICBxdWVyeVBhcmFtZXRlcnM6IHRoaXMucXVlcnlQYXJhbWV0ZXJzLAogICAgICAgICAgICB0ZW1wbGF0ZVZhbHVlczogdGhpcy50ZW1wbGF0ZVZhbHVlcywKICAgICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgICBwcm94eTogdGhpcy5wcm94eSwKICAgICAgICAgICAgcmV0cnlDYWxsYmFjazogdGhpcy5yZXRyeUNhbGxiYWNrLAogICAgICAgICAgICByZXRyeUF0dGVtcHRzOiB0aGlzLnJldHJ5QXR0ZW1wdHMsCiAgICAgICAgICAgIHJlcXVlc3Q6IHRoaXMucmVxdWVzdC5jbG9uZSgpLAogICAgICAgICAgICBwYXJzZVVybDogZmFsc2UsCiAgICAgICAgICAgIGNyZWRpdHM6IGRlZmluZWRfZGVmYXVsdCh0aGlzLmNyZWRpdHMpID8gdGhpcy5jcmVkaXRzLnNsaWNlKCkgOiB2b2lkIDAKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3VybCA9IHRoaXMuX3VybDsKICAgICAgICByZXN1bHQuX3F1ZXJ5UGFyYW1ldGVycyA9IGNsb25lX2RlZmF1bHQodGhpcy5fcXVlcnlQYXJhbWV0ZXJzKTsKICAgICAgICByZXN1bHQuX3RlbXBsYXRlVmFsdWVzID0gY2xvbmVfZGVmYXVsdCh0aGlzLl90ZW1wbGF0ZVZhbHVlcyk7CiAgICAgICAgcmVzdWx0LmhlYWRlcnMgPSBjbG9uZV9kZWZhdWx0KHRoaXMuaGVhZGVycyk7CiAgICAgICAgcmVzdWx0LnByb3h5ID0gdGhpcy5wcm94eTsKICAgICAgICByZXN1bHQucmV0cnlDYWxsYmFjayA9IHRoaXMucmV0cnlDYWxsYmFjazsKICAgICAgICByZXN1bHQucmV0cnlBdHRlbXB0cyA9IHRoaXMucmV0cnlBdHRlbXB0czsKICAgICAgICByZXN1bHQuX3JldHJ5Q291bnQgPSAwOwogICAgICAgIHJlc3VsdC5yZXF1ZXN0ID0gdGhpcy5yZXF1ZXN0LmNsb25lKCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmdldEJhc2VVcmkgPSBmdW5jdGlvbihpbmNsdWRlUXVlcnkpIHsKICAgICAgICByZXR1cm4gZ2V0QmFzZVVyaV9kZWZhdWx0KHRoaXMuZ2V0VXJsQ29tcG9uZW50KGluY2x1ZGVRdWVyeSksIGluY2x1ZGVRdWVyeSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5hcHBlbmRGb3J3YXJkU2xhc2ggPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl91cmwgPSBhcHBlbmRGb3J3YXJkU2xhc2hfZGVmYXVsdCh0aGlzLl91cmwpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZmV0Y2hBcnJheUJ1ZmZlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmZldGNoKHsKICAgICAgICAgIHJlc3BvbnNlVHlwZTogImFycmF5YnVmZmVyIgogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5mZXRjaEFycmF5QnVmZmVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5mZXRjaEFycmF5QnVmZmVyKCk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaEJsb2IgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5mZXRjaCh7CiAgICAgICAgICByZXNwb25zZVR5cGU6ICJibG9iIgogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5mZXRjaEJsb2IgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmZldGNoQmxvYigpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZmV0Y2hJbWFnZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCBwcmVmZXJJbWFnZUJpdG1hcCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucHJlZmVySW1hZ2VCaXRtYXAsIGZhbHNlKTsKICAgICAgICBjb25zdCBwcmVmZXJCbG9iID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5wcmVmZXJCbG9iLCBmYWxzZSk7CiAgICAgICAgY29uc3QgZmxpcFkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmZsaXBZLCBmYWxzZSk7CiAgICAgICAgY29uc3Qgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBvcHRpb25zLnNraXBDb2xvclNwYWNlQ29udmVyc2lvbiwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBjaGVja0FuZFJlc2V0UmVxdWVzdCh0aGlzLnJlcXVlc3QpOwogICAgICAgIGlmICgheGhyQmxvYlN1cHBvcnRlZCB8fCB0aGlzLmlzRGF0YVVyaSB8fCB0aGlzLmlzQmxvYlVyaSB8fCAhdGhpcy5oYXNIZWFkZXJzICYmICFwcmVmZXJCbG9iKSB7CiAgICAgICAgICByZXR1cm4gZmV0Y2hJbWFnZSh7CiAgICAgICAgICAgIHJlc291cmNlOiB0aGlzLAogICAgICAgICAgICBmbGlwWSwKICAgICAgICAgICAgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uLAogICAgICAgICAgICBwcmVmZXJJbWFnZUJpdG1hcAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJsb2JQcm9taXNlID0gdGhpcy5mZXRjaEJsb2IoKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChibG9iUHJvbWlzZSkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgbGV0IHN1cHBvcnRzSW1hZ2VCaXRtYXA7CiAgICAgICAgbGV0IHVzZUltYWdlQml0bWFwOwogICAgICAgIGxldCBnZW5lcmF0ZWRCbG9iUmVzb3VyY2U7CiAgICAgICAgbGV0IGdlbmVyYXRlZEJsb2I7CiAgICAgICAgcmV0dXJuIFJlc291cmNlLnN1cHBvcnRzSW1hZ2VCaXRtYXBPcHRpb25zKCkudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICAgIHN1cHBvcnRzSW1hZ2VCaXRtYXAgPSByZXN1bHQ7CiAgICAgICAgICB1c2VJbWFnZUJpdG1hcCA9IHN1cHBvcnRzSW1hZ2VCaXRtYXAgJiYgcHJlZmVySW1hZ2VCaXRtYXA7CiAgICAgICAgICByZXR1cm4gYmxvYlByb21pc2U7CiAgICAgICAgfSkudGhlbihmdW5jdGlvbihibG9iKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChibG9iKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBnZW5lcmF0ZWRCbG9iID0gYmxvYjsKICAgICAgICAgIGlmICh1c2VJbWFnZUJpdG1hcCkgewogICAgICAgICAgICByZXR1cm4gUmVzb3VyY2UuY3JlYXRlSW1hZ2VCaXRtYXBGcm9tQmxvYihibG9iLCB7CiAgICAgICAgICAgICAgZmxpcFksCiAgICAgICAgICAgICAgcHJlbXVsdGlwbHlBbHBoYTogZmFsc2UsCiAgICAgICAgICAgICAgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgYmxvYlVybCA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgICAgICAgZ2VuZXJhdGVkQmxvYlJlc291cmNlID0gbmV3IFJlc291cmNlKHsKICAgICAgICAgICAgdXJsOiBibG9iVXJsCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBmZXRjaEltYWdlKHsKICAgICAgICAgICAgcmVzb3VyY2U6IGdlbmVyYXRlZEJsb2JSZXNvdXJjZSwKICAgICAgICAgICAgZmxpcFksCiAgICAgICAgICAgIHNraXBDb2xvclNwYWNlQ29udmVyc2lvbiwKICAgICAgICAgICAgcHJlZmVySW1hZ2VCaXRtYXA6IGZhbHNlCiAgICAgICAgICB9KTsKICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKGltYWdlKSB7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbWFnZSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaW1hZ2UuYmxvYiA9IGdlbmVyYXRlZEJsb2I7CiAgICAgICAgICBpZiAodXNlSW1hZ2VCaXRtYXApIHsKICAgICAgICAgICAgcmV0dXJuIGltYWdlOwogICAgICAgICAgfQogICAgICAgICAgd2luZG93LlVSTC5yZXZva2VPYmplY3RVUkwoZ2VuZXJhdGVkQmxvYlJlc291cmNlLnVybCk7CiAgICAgICAgICByZXR1cm4gaW1hZ2U7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VuZXJhdGVkQmxvYlJlc291cmNlKSkgewogICAgICAgICAgICB3aW5kb3cuVVJMLnJldm9rZU9iamVjdFVSTChnZW5lcmF0ZWRCbG9iUmVzb3VyY2UudXJsKTsKICAgICAgICAgIH0KICAgICAgICAgIGVycm9yLmJsb2IgPSBnZW5lcmF0ZWRCbG9iOwogICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2hJbWFnZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2UuZmV0Y2hJbWFnZSh7CiAgICAgICAgICBmbGlwWTogb3B0aW9ucy5mbGlwWSwKICAgICAgICAgIHNraXBDb2xvclNwYWNlQ29udmVyc2lvbjogb3B0aW9ucy5za2lwQ29sb3JTcGFjZUNvbnZlcnNpb24sCiAgICAgICAgICBwcmVmZXJCbG9iOiBvcHRpb25zLnByZWZlckJsb2IsCiAgICAgICAgICBwcmVmZXJJbWFnZUJpdG1hcDogb3B0aW9ucy5wcmVmZXJJbWFnZUJpdG1hcAogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZmV0Y2hUZXh0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZmV0Y2goewogICAgICAgICAgcmVzcG9uc2VUeXBlOiAidGV4dCIKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2hUZXh0ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5mZXRjaFRleHQoKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmZldGNoSnNvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IHByb21pc2UgPSB0aGlzLmZldGNoKHsKICAgICAgICAgIHJlc3BvbnNlVHlwZTogInRleHQiLAogICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICBBY2NlcHQ6ICJhcHBsaWNhdGlvbi9qc29uLCovKjtxPTAuMDEiCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocHJvbWlzZSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLmZldGNoSnNvbiA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2UuZmV0Y2hKc29uKCk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaFhNTCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmZldGNoKHsKICAgICAgICAgIHJlc3BvbnNlVHlwZTogImRvY3VtZW50IiwKICAgICAgICAgIG92ZXJyaWRlTWltZVR5cGU6ICJ0ZXh0L3htbCIKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2hYTUwgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmZldGNoWE1MKCk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaEpzb25wID0gZnVuY3Rpb24oY2FsbGJhY2tQYXJhbWV0ZXJOYW1lKSB7CiAgICAgICAgY2FsbGJhY2tQYXJhbWV0ZXJOYW1lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY2FsbGJhY2tQYXJhbWV0ZXJOYW1lLCAiY2FsbGJhY2siKTsKICAgICAgICBjaGVja0FuZFJlc2V0UmVxdWVzdCh0aGlzLnJlcXVlc3QpOwogICAgICAgIGxldCBmdW5jdGlvbk5hbWU7CiAgICAgICAgZG8gewogICAgICAgICAgZnVuY3Rpb25OYW1lID0gYGxvYWRKc29ucCR7TWF0aF9kZWZhdWx0Lm5leHRSYW5kb21OdW1iZXIoKS50b1N0cmluZygpLnN1YnN0cmluZygyLCA4KX1gOwogICAgICAgIH0gd2hpbGUgKGRlZmluZWRfZGVmYXVsdCh3aW5kb3dbZnVuY3Rpb25OYW1lXSkpOwogICAgICAgIHJldHVybiBmZXRjaEpzb25wKHRoaXMsIGNhbGxiYWNrUGFyYW1ldGVyTmFtZSwgZnVuY3Rpb25OYW1lKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2hKc29ucCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBSZXNvdXJjZShvcHRpb25zKTsKICAgICAgICByZXR1cm4gcmVzb3VyY2UuZmV0Y2hKc29ucChvcHRpb25zLmNhbGxiYWNrUGFyYW1ldGVyTmFtZSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5fbWFrZVJlcXVlc3QgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSB0aGlzOwogICAgICAgIGNoZWNrQW5kUmVzZXRSZXF1ZXN0KHJlc291cmNlLnJlcXVlc3QpOwogICAgICAgIGNvbnN0IHJlcXVlc3QgPSByZXNvdXJjZS5yZXF1ZXN0OwogICAgICAgIGNvbnN0IHVybCA9IHJlc291cmNlLnVybDsKICAgICAgICByZXF1ZXN0LnVybCA9IHVybDsKICAgICAgICByZXF1ZXN0LnJlcXVlc3RGdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgY29uc3QgcmVzcG9uc2VUeXBlID0gb3B0aW9ucy5yZXNwb25zZVR5cGU7CiAgICAgICAgICBjb25zdCBoZWFkZXJzID0gY29tYmluZV9kZWZhdWx0KG9wdGlvbnMuaGVhZGVycywgcmVzb3VyY2UuaGVhZGVycyk7CiAgICAgICAgICBjb25zdCBvdmVycmlkZU1pbWVUeXBlID0gb3B0aW9ucy5vdmVycmlkZU1pbWVUeXBlOwogICAgICAgICAgY29uc3QgbWV0aG9kID0gb3B0aW9ucy5tZXRob2Q7CiAgICAgICAgICBjb25zdCBkYXRhID0gb3B0aW9ucy5kYXRhOwogICAgICAgICAgY29uc3QgZGVmZXJyZWQgPSBkZWZlcl9kZWZhdWx0KCk7CiAgICAgICAgICBjb25zdCB4aHIgPSBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmxvYWRXaXRoWGhyKAogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIHJlc3BvbnNlVHlwZSwKICAgICAgICAgICAgbWV0aG9kLAogICAgICAgICAgICBkYXRhLAogICAgICAgICAgICBoZWFkZXJzLAogICAgICAgICAgICBkZWZlcnJlZCwKICAgICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZQogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoeGhyKSAmJiBkZWZpbmVkX2RlZmF1bHQoeGhyLmFib3J0KSkgewogICAgICAgICAgICByZXF1ZXN0LmNhbmNlbEZ1bmN0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgeGhyLmFib3J0KCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IHByb21pc2UgPSBSZXF1ZXN0U2NoZWR1bGVyX2RlZmF1bHQucmVxdWVzdChyZXF1ZXN0KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwcm9taXNlKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgIHJlcXVlc3QuY2FuY2VsRnVuY3Rpb24gPSB2b2lkIDA7CiAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlKSB7CiAgICAgICAgICByZXF1ZXN0LmNhbmNlbEZ1bmN0aW9uID0gdm9pZCAwOwogICAgICAgICAgaWYgKHJlcXVlc3Quc3RhdGUgIT09IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LkZBSUxFRCkgewogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzb3VyY2UucmV0cnlPbkVycm9yKGUpLnRoZW4oZnVuY3Rpb24ocmV0cnkpIHsKICAgICAgICAgICAgaWYgKHJldHJ5KSB7CiAgICAgICAgICAgICAgcmVxdWVzdC5zdGF0ZSA9IFJlcXVlc3RTdGF0ZV9kZWZhdWx0LlVOSVNTVUVEOwogICAgICAgICAgICAgIHJlcXVlc3QuZGVmZXJyZWQgPSB2b2lkIDA7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc291cmNlLmZldGNoKG9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9OwogICAgICBkYXRhVXJpUmVnZXgyID0gL15kYXRhOiguKj8pKDtiYXNlNjQpPywoLiopJC87CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5mZXRjaCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdENsb25lKG9wdGlvbnMsIHt9KTsKICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICJHRVQiOwogICAgICAgIHJldHVybiB0aGlzLl9tYWtlUmVxdWVzdChvcHRpb25zKTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuZmV0Y2ggPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmZldGNoKHsKICAgICAgICAgIC8vIE1ha2UgY29weSBvZiBqdXN0IHRoZSBuZWVkZWQgZmllbGRzIGJlY2F1c2UgaGVhZGVycyBjYW4gYmUgcGFzc2VkIHRvIGJvdGggdGhlIGNvbnN0cnVjdG9yIGFuZCB0byBmZXRjaAogICAgICAgICAgcmVzcG9uc2VUeXBlOiBvcHRpb25zLnJlc3BvbnNlVHlwZSwKICAgICAgICAgIG92ZXJyaWRlTWltZVR5cGU6IG9wdGlvbnMub3ZlcnJpZGVNaW1lVHlwZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUuZGVsZXRlID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0Q2xvbmUob3B0aW9ucywge30pOwogICAgICAgIG9wdGlvbnMubWV0aG9kID0gIkRFTEVURSI7CiAgICAgICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5kZWxldGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLmRlbGV0ZSh7CiAgICAgICAgICAvLyBNYWtlIGNvcHkgb2YganVzdCB0aGUgbmVlZGVkIGZpZWxkcyBiZWNhdXNlIGhlYWRlcnMgY2FuIGJlIHBhc3NlZCB0byBib3RoIHRoZSBjb25zdHJ1Y3RvciBhbmQgdG8gZmV0Y2gKICAgICAgICAgIHJlc3BvbnNlVHlwZTogb3B0aW9ucy5yZXNwb25zZVR5cGUsCiAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBvcHRpb25zLm92ZXJyaWRlTWltZVR5cGUsCiAgICAgICAgICBkYXRhOiBvcHRpb25zLmRhdGEKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLmhlYWQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRDbG9uZShvcHRpb25zLCB7fSk7CiAgICAgICAgb3B0aW9ucy5tZXRob2QgPSAiSEVBRCI7CiAgICAgICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5oZWFkID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5oZWFkKHsKICAgICAgICAgIC8vIE1ha2UgY29weSBvZiBqdXN0IHRoZSBuZWVkZWQgZmllbGRzIGJlY2F1c2UgaGVhZGVycyBjYW4gYmUgcGFzc2VkIHRvIGJvdGggdGhlIGNvbnN0cnVjdG9yIGFuZCB0byBmZXRjaAogICAgICAgICAgcmVzcG9uc2VUeXBlOiBvcHRpb25zLnJlc3BvbnNlVHlwZSwKICAgICAgICAgIG92ZXJyaWRlTWltZVR5cGU6IG9wdGlvbnMub3ZlcnJpZGVNaW1lVHlwZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wcm90b3R5cGUub3B0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdENsb25lKG9wdGlvbnMsIHt9KTsKICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICJPUFRJT05TIjsKICAgICAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3Qob3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLm9wdGlvbnMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLm9wdGlvbnMoewogICAgICAgICAgLy8gTWFrZSBjb3B5IG9mIGp1c3QgdGhlIG5lZWRlZCBmaWVsZHMgYmVjYXVzZSBoZWFkZXJzIGNhbiBiZSBwYXNzZWQgdG8gYm90aCB0aGUgY29uc3RydWN0b3IgYW5kIHRvIGZldGNoCiAgICAgICAgICByZXNwb25zZVR5cGU6IG9wdGlvbnMucmVzcG9uc2VUeXBlLAogICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogb3B0aW9ucy5vdmVycmlkZU1pbWVUeXBlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5wb3N0ID0gZnVuY3Rpb24oZGF0YSwgb3B0aW9ucykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGF0YSIsIGRhdGEpOwogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0Q2xvbmUob3B0aW9ucywge30pOwogICAgICAgIG9wdGlvbnMubWV0aG9kID0gIlBPU1QiOwogICAgICAgIG9wdGlvbnMuZGF0YSA9IGRhdGE7CiAgICAgICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wb3N0ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5wb3N0KG9wdGlvbnMuZGF0YSwgewogICAgICAgICAgLy8gTWFrZSBjb3B5IG9mIGp1c3QgdGhlIG5lZWRlZCBmaWVsZHMgYmVjYXVzZSBoZWFkZXJzIGNhbiBiZSBwYXNzZWQgdG8gYm90aCB0aGUgY29uc3RydWN0b3IgYW5kIHRvIHBvc3QKICAgICAgICAgIHJlc3BvbnNlVHlwZTogb3B0aW9ucy5yZXNwb25zZVR5cGUsCiAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBvcHRpb25zLm92ZXJyaWRlTWltZVR5cGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UucHJvdG90eXBlLnB1dCA9IGZ1bmN0aW9uKGRhdGEsIG9wdGlvbnMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRhdGEiLCBkYXRhKTsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdENsb25lKG9wdGlvbnMsIHt9KTsKICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICJQVVQiOwogICAgICAgIG9wdGlvbnMuZGF0YSA9IGRhdGE7CiAgICAgICAgcmV0dXJuIHRoaXMuX21ha2VSZXF1ZXN0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBSZXNvdXJjZS5wdXQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcmVzb3VyY2UgPSBuZXcgUmVzb3VyY2Uob3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHJlc291cmNlLnB1dChvcHRpb25zLmRhdGEsIHsKICAgICAgICAgIC8vIE1ha2UgY29weSBvZiBqdXN0IHRoZSBuZWVkZWQgZmllbGRzIGJlY2F1c2UgaGVhZGVycyBjYW4gYmUgcGFzc2VkIHRvIGJvdGggdGhlIGNvbnN0cnVjdG9yIGFuZCB0byBwb3N0CiAgICAgICAgICByZXNwb25zZVR5cGU6IG9wdGlvbnMucmVzcG9uc2VUeXBlLAogICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogb3B0aW9ucy5vdmVycmlkZU1pbWVUeXBlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnByb3RvdHlwZS5wYXRjaCA9IGZ1bmN0aW9uKGRhdGEsIG9wdGlvbnMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRhdGEiLCBkYXRhKTsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdENsb25lKG9wdGlvbnMsIHt9KTsKICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICJQQVRDSCI7CiAgICAgICAgb3B0aW9ucy5kYXRhID0gZGF0YTsKICAgICAgICByZXR1cm4gdGhpcy5fbWFrZVJlcXVlc3Qob3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLnBhdGNoID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGNvbnN0IHJlc291cmNlID0gbmV3IFJlc291cmNlKG9wdGlvbnMpOwogICAgICAgIHJldHVybiByZXNvdXJjZS5wYXRjaChvcHRpb25zLmRhdGEsIHsKICAgICAgICAgIC8vIE1ha2UgY29weSBvZiBqdXN0IHRoZSBuZWVkZWQgZmllbGRzIGJlY2F1c2UgaGVhZGVycyBjYW4gYmUgcGFzc2VkIHRvIGJvdGggdGhlIGNvbnN0cnVjdG9yIGFuZCB0byBwb3N0CiAgICAgICAgICByZXNwb25zZVR5cGU6IG9wdGlvbnMucmVzcG9uc2VUeXBlLAogICAgICAgICAgb3ZlcnJpZGVNaW1lVHlwZTogb3B0aW9ucy5vdmVycmlkZU1pbWVUeXBlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMgPSB7fTsKICAgICAgUmVzb3VyY2UuX0ltcGxlbWVudGF0aW9ucy5sb2FkSW1hZ2VFbGVtZW50ID0gZnVuY3Rpb24odXJsLCBjcm9zc09yaWdpbiwgZGVmZXJyZWQpIHsKICAgICAgICBjb25zdCBpbWFnZSA9IG5ldyBJbWFnZSgpOwogICAgICAgIGltYWdlLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKGltYWdlLm5hdHVyYWxXaWR0aCA9PT0gMCAmJiBpbWFnZS5uYXR1cmFsSGVpZ2h0ID09PSAwICYmIGltYWdlLndpZHRoID09PSAwICYmIGltYWdlLmhlaWdodCA9PT0gMCkgewogICAgICAgICAgICBpbWFnZS53aWR0aCA9IDMwMDsKICAgICAgICAgICAgaW1hZ2UuaGVpZ2h0ID0gMTUwOwogICAgICAgICAgfQogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShpbWFnZSk7CiAgICAgICAgfTsKICAgICAgICBpbWFnZS5vbmVycm9yID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpOwogICAgICAgIH07CiAgICAgICAgaWYgKGNyb3NzT3JpZ2luKSB7CiAgICAgICAgICBpZiAoVHJ1c3RlZFNlcnZlcnNfZGVmYXVsdC5jb250YWlucyh1cmwpKSB7CiAgICAgICAgICAgIGltYWdlLmNyb3NzT3JpZ2luID0gInVzZS1jcmVkZW50aWFscyI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpbWFnZS5jcm9zc09yaWdpbiA9ICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpbWFnZS5zcmMgPSB1cmw7CiAgICAgIH07CiAgICAgIFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMuY3JlYXRlSW1hZ2UgPSBmdW5jdGlvbihyZXF1ZXN0LCBjcm9zc09yaWdpbiwgZGVmZXJyZWQsIGZsaXBZLCBza2lwQ29sb3JTcGFjZUNvbnZlcnNpb24sIHByZWZlckltYWdlQml0bWFwKSB7CiAgICAgICAgY29uc3QgdXJsID0gcmVxdWVzdC51cmw7CiAgICAgICAgUmVzb3VyY2Uuc3VwcG9ydHNJbWFnZUJpdG1hcE9wdGlvbnMoKS50aGVuKGZ1bmN0aW9uKHN1cHBvcnRzSW1hZ2VCaXRtYXApIHsKICAgICAgICAgIGlmICghKHN1cHBvcnRzSW1hZ2VCaXRtYXAgJiYgcHJlZmVySW1hZ2VCaXRtYXApKSB7CiAgICAgICAgICAgIFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMubG9hZEltYWdlRWxlbWVudCh1cmwsIGNyb3NzT3JpZ2luLCBkZWZlcnJlZCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3BvbnNlVHlwZSA9ICJibG9iIjsKICAgICAgICAgIGNvbnN0IG1ldGhvZCA9ICJHRVQiOwogICAgICAgICAgY29uc3QgeGhyRGVmZXJyZWQgPSBkZWZlcl9kZWZhdWx0KCk7CiAgICAgICAgICBjb25zdCB4aHIgPSBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmxvYWRXaXRoWGhyKAogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIHJlc3BvbnNlVHlwZSwKICAgICAgICAgICAgbWV0aG9kLAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgeGhyRGVmZXJyZWQsCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgdm9pZCAwLAogICAgICAgICAgICB2b2lkIDAKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHhocikgJiYgZGVmaW5lZF9kZWZhdWx0KHhoci5hYm9ydCkpIHsKICAgICAgICAgICAgcmVxdWVzdC5jYW5jZWxGdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHhoci5hYm9ydCgpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHhockRlZmVycmVkLnByb21pc2UudGhlbihmdW5jdGlvbihibG9iKSB7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJsb2IpKSB7CiAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KAogICAgICAgICAgICAgICAgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAgICAgICBgU3VjY2Vzc2Z1bGx5IHJldHJpZXZlZCAke3VybH0gYnV0IGl0IGNvbnRhaW5lZCBubyBjb250ZW50LmAKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gUmVzb3VyY2UuY3JlYXRlSW1hZ2VCaXRtYXBGcm9tQmxvYihibG9iLCB7CiAgICAgICAgICAgICAgZmxpcFksCiAgICAgICAgICAgICAgcHJlbXVsdGlwbHlBbHBoYTogZmFsc2UsCiAgICAgICAgICAgICAgc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSkudGhlbihmdW5jdGlvbihpbWFnZSkgewogICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGltYWdlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuY3JlYXRlSW1hZ2VCaXRtYXBGcm9tQmxvYiA9IGZ1bmN0aW9uKGJsb2IsIG9wdGlvbnMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMiLCBvcHRpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5ib29sKCJvcHRpb25zLmZsaXBZIiwgb3B0aW9ucy5mbGlwWSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YuYm9vbCgib3B0aW9ucy5wcmVtdWx0aXBseUFscGhhIiwgb3B0aW9ucy5wcmVtdWx0aXBseUFscGhhKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5ib29sKAogICAgICAgICAgIm9wdGlvbnMuc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uIiwKICAgICAgICAgIG9wdGlvbnMuc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gY3JlYXRlSW1hZ2VCaXRtYXAoYmxvYiwgewogICAgICAgICAgaW1hZ2VPcmllbnRhdGlvbjogb3B0aW9ucy5mbGlwWSA/ICJmbGlwWSIgOiAibm9uZSIsCiAgICAgICAgICBwcmVtdWx0aXBseUFscGhhOiBvcHRpb25zLnByZW11bHRpcGx5QWxwaGEgPyAicHJlbXVsdGlwbHkiIDogIm5vbmUiLAogICAgICAgICAgY29sb3JTcGFjZUNvbnZlcnNpb246IG9wdGlvbnMuc2tpcENvbG9yU3BhY2VDb252ZXJzaW9uID8gIm5vbmUiIDogImRlZmF1bHQiCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIG5vWE1MSHR0cFJlcXVlc3QgPSB0eXBlb2YgWE1MSHR0cFJlcXVlc3QgPT09ICJ1bmRlZmluZWQiOwogICAgICBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmxvYWRXaXRoWGhyID0gZnVuY3Rpb24odXJsLCByZXNwb25zZVR5cGUsIG1ldGhvZCwgZGF0YSwgaGVhZGVycywgZGVmZXJyZWQsIG92ZXJyaWRlTWltZVR5cGUpIHsKICAgICAgICBjb25zdCBkYXRhVXJpUmVnZXhSZXN1bHQgPSBkYXRhVXJpUmVnZXgyLmV4ZWModXJsKTsKICAgICAgICBpZiAoZGF0YVVyaVJlZ2V4UmVzdWx0ICE9PSBudWxsKSB7CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGRlY29kZURhdGFVcmkoZGF0YVVyaVJlZ2V4UmVzdWx0LCByZXNwb25zZVR5cGUpKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKG5vWE1MSHR0cFJlcXVlc3QpIHsKICAgICAgICAgIGxvYWRXaXRoSHR0cFJlcXVlc3QoCiAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgcmVzcG9uc2VUeXBlLAogICAgICAgICAgICBtZXRob2QsCiAgICAgICAgICAgIGRhdGEsCiAgICAgICAgICAgIGhlYWRlcnMsCiAgICAgICAgICAgIGRlZmVycmVkLAogICAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlCiAgICAgICAgICApOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICBpZiAoVHJ1c3RlZFNlcnZlcnNfZGVmYXVsdC5jb250YWlucyh1cmwpKSB7CiAgICAgICAgICB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgeGhyLm9wZW4obWV0aG9kLCB1cmwsIHRydWUpOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3ZlcnJpZGVNaW1lVHlwZSkgJiYgZGVmaW5lZF9kZWZhdWx0KHhoci5vdmVycmlkZU1pbWVUeXBlKSkgewogICAgICAgICAgeGhyLm92ZXJyaWRlTWltZVR5cGUob3ZlcnJpZGVNaW1lVHlwZSk7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaGVhZGVycykpIHsKICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIGhlYWRlcnMpIHsKICAgICAgICAgICAgaWYgKGhlYWRlcnMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgaGVhZGVyc1trZXldKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlc3BvbnNlVHlwZSkpIHsKICAgICAgICAgIHhoci5yZXNwb25zZVR5cGUgPSByZXNwb25zZVR5cGU7CiAgICAgICAgfQogICAgICAgIGxldCBsb2NhbEZpbGUgPSBmYWxzZTsKICAgICAgICBpZiAodHlwZW9mIHVybCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgIGxvY2FsRmlsZSA9IHVybC5pbmRleE9mKCJmaWxlOi8vIikgPT09IDAgfHwgdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LmxvY2F0aW9uLm9yaWdpbiA9PT0gImZpbGU6Ly8iOwogICAgICAgIH0KICAgICAgICB4aHIub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoKHhoci5zdGF0dXMgPCAyMDAgfHwgeGhyLnN0YXR1cyA+PSAzMDApICYmICEobG9jYWxGaWxlICYmIHhoci5zdGF0dXMgPT09IDApKSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdCgKICAgICAgICAgICAgICBuZXcgUmVxdWVzdEVycm9yRXZlbnRfZGVmYXVsdCgKICAgICAgICAgICAgICAgIHhoci5zdGF0dXMsCiAgICAgICAgICAgICAgICB4aHIucmVzcG9uc2UsCiAgICAgICAgICAgICAgICB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkKICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0geGhyLnJlc3BvbnNlOwogICAgICAgICAgY29uc3QgYnJvd3NlclJlc3BvbnNlVHlwZSA9IHhoci5yZXNwb25zZVR5cGU7CiAgICAgICAgICBpZiAobWV0aG9kID09PSAiSEVBRCIgfHwgbWV0aG9kID09PSAiT1BUSU9OUyIpIHsKICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VIZWFkZXJTdHJpbmcgPSB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CiAgICAgICAgICAgIGNvbnN0IHNwbGl0SGVhZGVycyA9IHJlc3BvbnNlSGVhZGVyU3RyaW5nLnRyaW0oKS5zcGxpdCgvW1xyXG5dKy8pOwogICAgICAgICAgICBjb25zdCByZXNwb25zZUhlYWRlcnMgPSB7fTsKICAgICAgICAgICAgc3BsaXRIZWFkZXJzLmZvckVhY2goZnVuY3Rpb24obGluZSkgewogICAgICAgICAgICAgIGNvbnN0IHBhcnRzID0gbGluZS5zcGxpdCgiOiAiKTsKICAgICAgICAgICAgICBjb25zdCBoZWFkZXIgPSBwYXJ0cy5zaGlmdCgpOwogICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVyc1toZWFkZXJdID0gcGFydHMuam9pbigiOiAiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzcG9uc2VIZWFkZXJzKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwNCkgewogICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHZvaWQgMCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRlZmluZWRfZGVmYXVsdChyZXNwb25zZSkgJiYgKCFkZWZpbmVkX2RlZmF1bHQocmVzcG9uc2VUeXBlKSB8fCBicm93c2VyUmVzcG9uc2VUeXBlID09PSByZXNwb25zZVR5cGUpKSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzcG9uc2UpOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZVR5cGUgPT09ICJqc29uIiAmJiB0eXBlb2YgcmVzcG9uc2UgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShKU09OLnBhcnNlKHJlc3BvbnNlKSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoKGJyb3dzZXJSZXNwb25zZVR5cGUgPT09ICIiIHx8IGJyb3dzZXJSZXNwb25zZVR5cGUgPT09ICJkb2N1bWVudCIpICYmIGRlZmluZWRfZGVmYXVsdCh4aHIucmVzcG9uc2VYTUwpICYmIHhoci5yZXNwb25zZVhNTC5oYXNDaGlsZE5vZGVzKCkpIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSh4aHIucmVzcG9uc2VYTUwpOwogICAgICAgICAgfSBlbHNlIGlmICgoYnJvd3NlclJlc3BvbnNlVHlwZSA9PT0gIiIgfHwgYnJvd3NlclJlc3BvbnNlVHlwZSA9PT0gInRleHQiKSAmJiBkZWZpbmVkX2RlZmF1bHQoeGhyLnJlc3BvbnNlVGV4dCkpIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSh4aHIucmVzcG9uc2VUZXh0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdCgKICAgICAgICAgICAgICBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgWE1MSHR0cFJlcXVlc3QgcmVzcG9uc2UgdHlwZS4iKQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgeGhyLm9uZXJyb3IgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICBkZWZlcnJlZC5yZWplY3QobmV3IFJlcXVlc3RFcnJvckV2ZW50X2RlZmF1bHQoKSk7CiAgICAgICAgfTsKICAgICAgICB4aHIuc2VuZChkYXRhKTsKICAgICAgICByZXR1cm4geGhyOwogICAgICB9OwogICAgICBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmxvYWRBbmRFeGVjdXRlU2NyaXB0ID0gZnVuY3Rpb24odXJsLCBmdW5jdGlvbk5hbWUsIGRlZmVycmVkKSB7CiAgICAgICAgcmV0dXJuIGxvYWRBbmRFeGVjdXRlU2NyaXB0X2RlZmF1bHQodXJsLCBmdW5jdGlvbk5hbWUpLmNhdGNoKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgUmVzb3VyY2UuX0RlZmF1bHRJbXBsZW1lbnRhdGlvbnMgPSB7fTsKICAgICAgUmVzb3VyY2UuX0RlZmF1bHRJbXBsZW1lbnRhdGlvbnMuY3JlYXRlSW1hZ2UgPSBSZXNvdXJjZS5fSW1wbGVtZW50YXRpb25zLmNyZWF0ZUltYWdlOwogICAgICBSZXNvdXJjZS5fRGVmYXVsdEltcGxlbWVudGF0aW9ucy5sb2FkV2l0aFhociA9IFJlc291cmNlLl9JbXBsZW1lbnRhdGlvbnMubG9hZFdpdGhYaHI7CiAgICAgIFJlc291cmNlLl9EZWZhdWx0SW1wbGVtZW50YXRpb25zLmxvYWRBbmRFeGVjdXRlU2NyaXB0ID0gUmVzb3VyY2UuX0ltcGxlbWVudGF0aW9ucy5sb2FkQW5kRXhlY3V0ZVNjcmlwdDsKICAgICAgUmVzb3VyY2UuREVGQVVMVCA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IFJlc291cmNlKHsKICAgICAgICAgIHVybDogdHlwZW9mIGRvY3VtZW50ID09PSAidW5kZWZpbmVkIiA/ICIiIDogZG9jdW1lbnQubG9jYXRpb24uaHJlZi5zcGxpdCgiPyIpWzBdCiAgICAgICAgfSkKICAgICAgKTsKICAgICAgUmVzb3VyY2VfZGVmYXVsdCA9IFJlc291cmNlOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMuanMKICBmdW5jdGlvbiBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycyhvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMuX2RhdGVzID0gdm9pZCAwOwogICAgdGhpcy5fc2FtcGxlcyA9IHZvaWQgMDsKICAgIHRoaXMuX2RhdGVDb2x1bW4gPSAtMTsKICAgIHRoaXMuX3hQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbiA9IC0xOwogICAgdGhpcy5feVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uID0gLTE7CiAgICB0aGlzLl91dDFNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSAtMTsKICAgIHRoaXMuX3hDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbiA9IC0xOwogICAgdGhpcy5feUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uID0gLTE7CiAgICB0aGlzLl90YWlNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSAtMTsKICAgIHRoaXMuX2NvbHVtbkNvdW50ID0gMDsKICAgIHRoaXMuX2xhc3RJbmRleCA9IC0xOwogICAgdGhpcy5fYWRkTmV3TGVhcFNlY29uZHMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmFkZE5ld0xlYXBTZWNvbmRzLCB0cnVlKTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5kYXRhKSkgewogICAgICBvbkRhdGFSZWFkeSh0aGlzLCBvcHRpb25zLmRhdGEpOwogICAgfSBlbHNlIHsKICAgICAgb25EYXRhUmVhZHkodGhpcywgewogICAgICAgIGNvbHVtbk5hbWVzOiBbCiAgICAgICAgICAiZGF0ZUlzbzg2MDEiLAogICAgICAgICAgIm1vZGlmaWVkSnVsaWFuRGF0ZVV0YyIsCiAgICAgICAgICAieFBvbGVXYW5kZXJSYWRpYW5zIiwKICAgICAgICAgICJ5UG9sZVdhbmRlclJhZGlhbnMiLAogICAgICAgICAgInV0MU1pbnVzVXRjU2Vjb25kcyIsCiAgICAgICAgICAibGVuZ3RoT2ZEYXlDb3JyZWN0aW9uU2Vjb25kcyIsCiAgICAgICAgICAieENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zIiwKICAgICAgICAgICJ5Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnMiLAogICAgICAgICAgInRhaU1pbnVzVXRjU2Vjb25kcyIKICAgICAgICBdLAogICAgICAgIHNhbXBsZXM6IFtdCiAgICAgIH0pOwogICAgfQogIH0KICBmdW5jdGlvbiBjb21wYXJlTGVhcFNlY29uZERhdGVzMihsZWFwU2Vjb25kLCBkYXRlVG9GaW5kKSB7CiAgICByZXR1cm4gSnVsaWFuRGF0ZV9kZWZhdWx0LmNvbXBhcmUobGVhcFNlY29uZC5qdWxpYW5EYXRlLCBkYXRlVG9GaW5kKTsKICB9CiAgZnVuY3Rpb24gb25EYXRhUmVhZHkoZW9wLCBlb3BEYXRhKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlb3BEYXRhLmNvbHVtbk5hbWVzKSkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgIkVycm9yIGluIGxvYWRlZCBFT1AgZGF0YTogVGhlIGNvbHVtbk5hbWVzIHByb3BlcnR5IGlzIHJlcXVpcmVkLiIKICAgICAgKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVvcERhdGEuc2FtcGxlcykpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KAogICAgICAgICJFcnJvciBpbiBsb2FkZWQgRU9QIGRhdGE6IFRoZSBzYW1wbGVzIHByb3BlcnR5IGlzIHJlcXVpcmVkLiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGRhdGVDb2x1bW4gPSBlb3BEYXRhLmNvbHVtbk5hbWVzLmluZGV4T2YoIm1vZGlmaWVkSnVsaWFuRGF0ZVV0YyIpOwogICAgY29uc3QgeFBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uID0gZW9wRGF0YS5jb2x1bW5OYW1lcy5pbmRleE9mKAogICAgICAieFBvbGVXYW5kZXJSYWRpYW5zIgogICAgKTsKICAgIGNvbnN0IHlQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbiA9IGVvcERhdGEuY29sdW1uTmFtZXMuaW5kZXhPZigKICAgICAgInlQb2xlV2FuZGVyUmFkaWFucyIKICAgICk7CiAgICBjb25zdCB1dDFNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSBlb3BEYXRhLmNvbHVtbk5hbWVzLmluZGV4T2YoCiAgICAgICJ1dDFNaW51c1V0Y1NlY29uZHMiCiAgICApOwogICAgY29uc3QgeENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uID0gZW9wRGF0YS5jb2x1bW5OYW1lcy5pbmRleE9mKAogICAgICAieENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zIgogICAgKTsKICAgIGNvbnN0IHlDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbiA9IGVvcERhdGEuY29sdW1uTmFtZXMuaW5kZXhPZigKICAgICAgInlDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFucyIKICAgICk7CiAgICBjb25zdCB0YWlNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSBlb3BEYXRhLmNvbHVtbk5hbWVzLmluZGV4T2YoCiAgICAgICJ0YWlNaW51c1V0Y1NlY29uZHMiCiAgICApOwogICAgaWYgKGRhdGVDb2x1bW4gPCAwIHx8IHhQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbiA8IDAgfHwgeVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uIDwgMCB8fCB1dDFNaW51c1V0Y1NlY29uZHNDb2x1bW4gPCAwIHx8IHhDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbiA8IDAgfHwgeUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uIDwgMCB8fCB0YWlNaW51c1V0Y1NlY29uZHNDb2x1bW4gPCAwKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAiRXJyb3IgaW4gbG9hZGVkIEVPUCBkYXRhOiBUaGUgY29sdW1uTmFtZXMgcHJvcGVydHkgbXVzdCBpbmNsdWRlIG1vZGlmaWVkSnVsaWFuRGF0ZVV0YywgeFBvbGVXYW5kZXJSYWRpYW5zLCB5UG9sZVdhbmRlclJhZGlhbnMsIHV0MU1pbnVzVXRjU2Vjb25kcywgeENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zLCB5Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnMsIGFuZCB0YWlNaW51c1V0Y1NlY29uZHMgY29sdW1ucyIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IHNhbXBsZXMgPSBlb3AuX3NhbXBsZXMgPSBlb3BEYXRhLnNhbXBsZXM7CiAgICBjb25zdCBkYXRlcyA9IGVvcC5fZGF0ZXMgPSBbXTsKICAgIGVvcC5fZGF0ZUNvbHVtbiA9IGRhdGVDb2x1bW47CiAgICBlb3AuX3hQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbiA9IHhQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbjsKICAgIGVvcC5feVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uID0geVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uOwogICAgZW9wLl91dDFNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSB1dDFNaW51c1V0Y1NlY29uZHNDb2x1bW47CiAgICBlb3AuX3hDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbiA9IHhDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbjsKICAgIGVvcC5feUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uID0geUNlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uOwogICAgZW9wLl90YWlNaW51c1V0Y1NlY29uZHNDb2x1bW4gPSB0YWlNaW51c1V0Y1NlY29uZHNDb2x1bW47CiAgICBlb3AuX2NvbHVtbkNvdW50ID0gZW9wRGF0YS5jb2x1bW5OYW1lcy5sZW5ndGg7CiAgICBlb3AuX2xhc3RJbmRleCA9IHZvaWQgMDsKICAgIGxldCBsYXN0VGFpTWludXNVdGM7CiAgICBjb25zdCBhZGROZXdMZWFwU2Vjb25kcyA9IGVvcC5fYWRkTmV3TGVhcFNlY29uZHM7CiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gc2FtcGxlcy5sZW5ndGg7IGkgPCBsZW47IGkgKz0gZW9wLl9jb2x1bW5Db3VudCkgewogICAgICBjb25zdCBtamQgPSBzYW1wbGVzW2kgKyBkYXRlQ29sdW1uXTsKICAgICAgY29uc3QgdGFpTWludXNVdGMgPSBzYW1wbGVzW2kgKyB0YWlNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogICAgICBjb25zdCBkYXkgPSBtamQgKyBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuTU9ESUZJRURfSlVMSUFOX0RBVEVfRElGRkVSRU5DRTsKICAgICAgY29uc3QgZGF0ZSA9IG5ldyBKdWxpYW5EYXRlX2RlZmF1bHQoZGF5LCB0YWlNaW51c1V0YywgVGltZVN0YW5kYXJkX2RlZmF1bHQuVEFJKTsKICAgICAgZGF0ZXMucHVzaChkYXRlKTsKICAgICAgaWYgKGFkZE5ld0xlYXBTZWNvbmRzKSB7CiAgICAgICAgaWYgKHRhaU1pbnVzVXRjICE9PSBsYXN0VGFpTWludXNVdGMgJiYgZGVmaW5lZF9kZWZhdWx0KGxhc3RUYWlNaW51c1V0YykpIHsKICAgICAgICAgIGNvbnN0IGxlYXBTZWNvbmRzID0gSnVsaWFuRGF0ZV9kZWZhdWx0LmxlYXBTZWNvbmRzOwogICAgICAgICAgY29uc3QgbGVhcFNlY29uZEluZGV4ID0gYmluYXJ5U2VhcmNoX2RlZmF1bHQoCiAgICAgICAgICAgIGxlYXBTZWNvbmRzLAogICAgICAgICAgICBkYXRlLAogICAgICAgICAgICBjb21wYXJlTGVhcFNlY29uZERhdGVzMgogICAgICAgICAgKTsKICAgICAgICAgIGlmIChsZWFwU2Vjb25kSW5kZXggPCAwKSB7CiAgICAgICAgICAgIGNvbnN0IGxlYXBTZWNvbmQgPSBuZXcgTGVhcFNlY29uZF9kZWZhdWx0KGRhdGUsIHRhaU1pbnVzVXRjKTsKICAgICAgICAgICAgbGVhcFNlY29uZHMuc3BsaWNlKH5sZWFwU2Vjb25kSW5kZXgsIDAsIGxlYXBTZWNvbmQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsYXN0VGFpTWludXNVdGMgPSB0YWlNaW51c1V0YzsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBmaWxsUmVzdWx0RnJvbUluZGV4KGVvcCwgc2FtcGxlcywgaW5kZXgsIGNvbHVtbkNvdW50LCByZXN1bHQpIHsKICAgIGNvbnN0IHN0YXJ0ID0gaW5kZXggKiBjb2x1bW5Db3VudDsKICAgIHJlc3VsdC54UG9sZVdhbmRlciA9IHNhbXBsZXNbc3RhcnQgKyBlb3AuX3hQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbl07CiAgICByZXN1bHQueVBvbGVXYW5kZXIgPSBzYW1wbGVzW3N0YXJ0ICsgZW9wLl95UG9sZVdhbmRlclJhZGlhbnNDb2x1bW5dOwogICAgcmVzdWx0LnhQb2xlT2Zmc2V0ID0gc2FtcGxlc1tzdGFydCArIGVvcC5feENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uXTsKICAgIHJlc3VsdC55UG9sZU9mZnNldCA9IHNhbXBsZXNbc3RhcnQgKyBlb3AuX3lDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbl07CiAgICByZXN1bHQudXQxTWludXNVdGMgPSBzYW1wbGVzW3N0YXJ0ICsgZW9wLl91dDFNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogIH0KICBmdW5jdGlvbiBsaW5lYXJJbnRlcnAoZHgsIHkxLCB5MikgewogICAgcmV0dXJuIHkxICsgZHggKiAoeTIgLSB5MSk7CiAgfQogIGZ1bmN0aW9uIGludGVycG9sYXRlKGVvcCwgZGF0ZXMsIHNhbXBsZXMsIGRhdGUsIGJlZm9yZSwgYWZ0ZXIsIHJlc3VsdCkgewogICAgY29uc3QgY29sdW1uQ291bnQgPSBlb3AuX2NvbHVtbkNvdW50OwogICAgaWYgKGFmdGVyID4gZGF0ZXMubGVuZ3RoIC0gMSkgewogICAgICByZXN1bHQueFBvbGVXYW5kZXIgPSAwOwogICAgICByZXN1bHQueVBvbGVXYW5kZXIgPSAwOwogICAgICByZXN1bHQueFBvbGVPZmZzZXQgPSAwOwogICAgICByZXN1bHQueVBvbGVPZmZzZXQgPSAwOwogICAgICByZXN1bHQudXQxTWludXNVdGMgPSAwOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgY29uc3QgYmVmb3JlRGF0ZSA9IGRhdGVzW2JlZm9yZV07CiAgICBjb25zdCBhZnRlckRhdGUgPSBkYXRlc1thZnRlcl07CiAgICBpZiAoYmVmb3JlRGF0ZS5lcXVhbHMoYWZ0ZXJEYXRlKSB8fCBkYXRlLmVxdWFscyhiZWZvcmVEYXRlKSkgewogICAgICBmaWxsUmVzdWx0RnJvbUluZGV4KGVvcCwgc2FtcGxlcywgYmVmb3JlLCBjb2x1bW5Db3VudCwgcmVzdWx0KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0gZWxzZSBpZiAoZGF0ZS5lcXVhbHMoYWZ0ZXJEYXRlKSkgewogICAgICBmaWxsUmVzdWx0RnJvbUluZGV4KGVvcCwgc2FtcGxlcywgYWZ0ZXIsIGNvbHVtbkNvdW50LCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgY29uc3QgZmFjdG9yID0gSnVsaWFuRGF0ZV9kZWZhdWx0LnNlY29uZHNEaWZmZXJlbmNlKGRhdGUsIGJlZm9yZURhdGUpIC8gSnVsaWFuRGF0ZV9kZWZhdWx0LnNlY29uZHNEaWZmZXJlbmNlKGFmdGVyRGF0ZSwgYmVmb3JlRGF0ZSk7CiAgICBjb25zdCBzdGFydEJlZm9yZSA9IGJlZm9yZSAqIGNvbHVtbkNvdW50OwogICAgY29uc3Qgc3RhcnRBZnRlciA9IGFmdGVyICogY29sdW1uQ291bnQ7CiAgICBsZXQgYmVmb3JlVXQxTWludXNVdGMgPSBzYW1wbGVzW3N0YXJ0QmVmb3JlICsgZW9wLl91dDFNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogICAgbGV0IGFmdGVyVXQxTWludXNVdGMgPSBzYW1wbGVzW3N0YXJ0QWZ0ZXIgKyBlb3AuX3V0MU1pbnVzVXRjU2Vjb25kc0NvbHVtbl07CiAgICBjb25zdCBvZmZzZXREaWZmZXJlbmNlID0gYWZ0ZXJVdDFNaW51c1V0YyAtIGJlZm9yZVV0MU1pbnVzVXRjOwogICAgaWYgKG9mZnNldERpZmZlcmVuY2UgPiAwLjUgfHwgb2Zmc2V0RGlmZmVyZW5jZSA8IC0wLjUpIHsKICAgICAgY29uc3QgYmVmb3JlVGFpTWludXNVdGMgPSBzYW1wbGVzW3N0YXJ0QmVmb3JlICsgZW9wLl90YWlNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogICAgICBjb25zdCBhZnRlclRhaU1pbnVzVXRjID0gc2FtcGxlc1tzdGFydEFmdGVyICsgZW9wLl90YWlNaW51c1V0Y1NlY29uZHNDb2x1bW5dOwogICAgICBpZiAoYmVmb3JlVGFpTWludXNVdGMgIT09IGFmdGVyVGFpTWludXNVdGMpIHsKICAgICAgICBpZiAoYWZ0ZXJEYXRlLmVxdWFscyhkYXRlKSkgewogICAgICAgICAgYmVmb3JlVXQxTWludXNVdGMgPSBhZnRlclV0MU1pbnVzVXRjOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhZnRlclV0MU1pbnVzVXRjIC09IGFmdGVyVGFpTWludXNVdGMgLSBiZWZvcmVUYWlNaW51c1V0YzsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJlc3VsdC54UG9sZVdhbmRlciA9IGxpbmVhckludGVycCgKICAgICAgZmFjdG9yLAogICAgICBzYW1wbGVzW3N0YXJ0QmVmb3JlICsgZW9wLl94UG9sZVdhbmRlclJhZGlhbnNDb2x1bW5dLAogICAgICBzYW1wbGVzW3N0YXJ0QWZ0ZXIgKyBlb3AuX3hQb2xlV2FuZGVyUmFkaWFuc0NvbHVtbl0KICAgICk7CiAgICByZXN1bHQueVBvbGVXYW5kZXIgPSBsaW5lYXJJbnRlcnAoCiAgICAgIGZhY3RvciwKICAgICAgc2FtcGxlc1tzdGFydEJlZm9yZSArIGVvcC5feVBvbGVXYW5kZXJSYWRpYW5zQ29sdW1uXSwKICAgICAgc2FtcGxlc1tzdGFydEFmdGVyICsgZW9wLl95UG9sZVdhbmRlclJhZGlhbnNDb2x1bW5dCiAgICApOwogICAgcmVzdWx0LnhQb2xlT2Zmc2V0ID0gbGluZWFySW50ZXJwKAogICAgICBmYWN0b3IsCiAgICAgIHNhbXBsZXNbc3RhcnRCZWZvcmUgKyBlb3AuX3hDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbl0sCiAgICAgIHNhbXBsZXNbc3RhcnRBZnRlciArIGVvcC5feENlbGVzdGlhbFBvbGVPZmZzZXRSYWRpYW5zQ29sdW1uXQogICAgKTsKICAgIHJlc3VsdC55UG9sZU9mZnNldCA9IGxpbmVhckludGVycCgKICAgICAgZmFjdG9yLAogICAgICBzYW1wbGVzW3N0YXJ0QmVmb3JlICsgZW9wLl95Q2VsZXN0aWFsUG9sZU9mZnNldFJhZGlhbnNDb2x1bW5dLAogICAgICBzYW1wbGVzW3N0YXJ0QWZ0ZXIgKyBlb3AuX3lDZWxlc3RpYWxQb2xlT2Zmc2V0UmFkaWFuc0NvbHVtbl0KICAgICk7CiAgICByZXN1bHQudXQxTWludXNVdGMgPSBsaW5lYXJJbnRlcnAoCiAgICAgIGZhY3RvciwKICAgICAgYmVmb3JlVXQxTWludXNVdGMsCiAgICAgIGFmdGVyVXQxTWludXNVdGMKICAgICk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB2YXIgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNfZGVmYXVsdDsKICB2YXIgaW5pdF9FYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMuanMiKCkgewogICAgICBpbml0X2JpbmFyeVNlYXJjaCgpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlKCk7CiAgICAgIGluaXRfSnVsaWFuRGF0ZSgpOwogICAgICBpbml0X0xlYXBTZWNvbmQoKTsKICAgICAgaW5pdF9SZXNvdXJjZSgpOwogICAgICBpbml0X1J1bnRpbWVFcnJvcigpOwogICAgICBpbml0X1RpbWVDb25zdGFudHMoKTsKICAgICAgaW5pdF9UaW1lU3RhbmRhcmQoKTsKICAgICAgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMuZnJvbVVybCA9IGFzeW5jIGZ1bmN0aW9uKHVybCwgb3B0aW9ucykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidXJsIiwgdXJsKTsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCByZXNvdXJjZSA9IFJlc291cmNlX2RlZmF1bHQuY3JlYXRlSWZOZWVkZWQodXJsKTsKICAgICAgICBsZXQgZW9wRGF0YTsKICAgICAgICB0cnkgewogICAgICAgICAgZW9wRGF0YSA9IGF3YWl0IHJlc291cmNlLmZldGNoSnNvbigpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYEFuIGVycm9yIG9jY3VycmVkIHdoaWxlIHJldHJpZXZpbmcgdGhlIEVPUCBkYXRhIGZyb20gdGhlIFVSTCAke3Jlc291cmNlLnVybH0uYAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycyh7CiAgICAgICAgICBhZGROZXdMZWFwU2Vjb25kczogb3B0aW9ucy5hZGROZXdMZWFwU2Vjb25kcywKICAgICAgICAgIGRhdGE6IGVvcERhdGEKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnMuTk9ORSA9IE9iamVjdC5mcmVlemUoewogICAgICAgIGNvbXB1dGU6IGZ1bmN0aW9uKGRhdGUsIHJlc3VsdCkgewogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgICByZXN1bHQgPSBuZXcgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGVfZGVmYXVsdCgwLCAwLCAwLCAwLCAwKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdC54UG9sZVdhbmRlciA9IDA7CiAgICAgICAgICAgIHJlc3VsdC55UG9sZVdhbmRlciA9IDA7CiAgICAgICAgICAgIHJlc3VsdC54UG9sZU9mZnNldCA9IDA7CiAgICAgICAgICAgIHJlc3VsdC55UG9sZU9mZnNldCA9IDA7CiAgICAgICAgICAgIHJlc3VsdC51dDFNaW51c1V0YyA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIEVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzLnByb3RvdHlwZS5jb21wdXRlID0gZnVuY3Rpb24oZGF0ZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fc2FtcGxlcykpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc1NhbXBsZV9kZWZhdWx0KDAsIDAsIDAsIDAsIDApOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fc2FtcGxlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJlc3VsdC54UG9sZVdhbmRlciA9IDA7CiAgICAgICAgICByZXN1bHQueVBvbGVXYW5kZXIgPSAwOwogICAgICAgICAgcmVzdWx0LnhQb2xlT2Zmc2V0ID0gMDsKICAgICAgICAgIHJlc3VsdC55UG9sZU9mZnNldCA9IDA7CiAgICAgICAgICByZXN1bHQudXQxTWludXNVdGMgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGF0ZXMgPSB0aGlzLl9kYXRlczsKICAgICAgICBjb25zdCBsYXN0SW5kZXggPSB0aGlzLl9sYXN0SW5kZXg7CiAgICAgICAgbGV0IGJlZm9yZSA9IDA7CiAgICAgICAgbGV0IGFmdGVyID0gMDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGxhc3RJbmRleCkpIHsKICAgICAgICAgIGNvbnN0IHByZXZpb3VzSW5kZXhEYXRlID0gZGF0ZXNbbGFzdEluZGV4XTsKICAgICAgICAgIGNvbnN0IG5leHRJbmRleERhdGUgPSBkYXRlc1tsYXN0SW5kZXggKyAxXTsKICAgICAgICAgIGNvbnN0IGlzQWZ0ZXJQcmV2aW91cyA9IEp1bGlhbkRhdGVfZGVmYXVsdC5sZXNzVGhhbk9yRXF1YWxzKAogICAgICAgICAgICBwcmV2aW91c0luZGV4RGF0ZSwKICAgICAgICAgICAgZGF0ZQogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IGlzQWZ0ZXJMYXN0U2FtcGxlID0gIWRlZmluZWRfZGVmYXVsdChuZXh0SW5kZXhEYXRlKTsKICAgICAgICAgIGNvbnN0IGlzQmVmb3JlTmV4dCA9IGlzQWZ0ZXJMYXN0U2FtcGxlIHx8IEp1bGlhbkRhdGVfZGVmYXVsdC5ncmVhdGVyVGhhbk9yRXF1YWxzKG5leHRJbmRleERhdGUsIGRhdGUpOwogICAgICAgICAgaWYgKGlzQWZ0ZXJQcmV2aW91cyAmJiBpc0JlZm9yZU5leHQpIHsKICAgICAgICAgICAgYmVmb3JlID0gbGFzdEluZGV4OwogICAgICAgICAgICBpZiAoIWlzQWZ0ZXJMYXN0U2FtcGxlICYmIG5leHRJbmRleERhdGUuZXF1YWxzKGRhdGUpKSB7CiAgICAgICAgICAgICAgKytiZWZvcmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWZ0ZXIgPSBiZWZvcmUgKyAxOwogICAgICAgICAgICBpbnRlcnBvbGF0ZSh0aGlzLCBkYXRlcywgdGhpcy5fc2FtcGxlcywgZGF0ZSwgYmVmb3JlLCBhZnRlciwgcmVzdWx0KTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IGluZGV4ID0gYmluYXJ5U2VhcmNoX2RlZmF1bHQoZGF0ZXMsIGRhdGUsIEp1bGlhbkRhdGVfZGVmYXVsdC5jb21wYXJlLCB0aGlzLl9kYXRlQ29sdW1uKTsKICAgICAgICBpZiAoaW5kZXggPj0gMCkgewogICAgICAgICAgaWYgKGluZGV4IDwgZGF0ZXMubGVuZ3RoIC0gMSAmJiBkYXRlc1tpbmRleCArIDFdLmVxdWFscyhkYXRlKSkgewogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgfQogICAgICAgICAgYmVmb3JlID0gaW5kZXg7CiAgICAgICAgICBhZnRlciA9IGluZGV4OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhZnRlciA9IH5pbmRleDsKICAgICAgICAgIGJlZm9yZSA9IGFmdGVyIC0gMTsKICAgICAgICAgIGlmIChiZWZvcmUgPCAwKSB7CiAgICAgICAgICAgIGJlZm9yZSA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuX2xhc3RJbmRleCA9IGJlZm9yZTsKICAgICAgICBpbnRlcnBvbGF0ZSh0aGlzLCBkYXRlcywgdGhpcy5fc2FtcGxlcywgZGF0ZSwgYmVmb3JlLCBhZnRlciwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVyc19kZWZhdWx0ID0gRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9IZWFkaW5nUGl0Y2hSb2xsLmpzCiAgZnVuY3Rpb24gSGVhZGluZ1BpdGNoUm9sbChoZWFkaW5nLCBwaXRjaCwgcm9sbCkgewogICAgdGhpcy5oZWFkaW5nID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaGVhZGluZywgMCk7CiAgICB0aGlzLnBpdGNoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocGl0Y2gsIDApOwogICAgdGhpcy5yb2xsID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocm9sbCwgMCk7CiAgfQogIHZhciBIZWFkaW5nUGl0Y2hSb2xsX2RlZmF1bHQ7CiAgdmFyIGluaXRfSGVhZGluZ1BpdGNoUm9sbCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVhZGluZ1BpdGNoUm9sbC5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLmZyb21RdWF0ZXJuaW9uID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocXVhdGVybmlvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJxdWF0ZXJuaW9uIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBIZWFkaW5nUGl0Y2hSb2xsKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRlc3QgPSAyICogKHF1YXRlcm5pb24udyAqIHF1YXRlcm5pb24ueSAtIHF1YXRlcm5pb24ueiAqIHF1YXRlcm5pb24ueCk7CiAgICAgICAgY29uc3QgZGVub21pbmF0b3JSb2xsID0gMSAtIDIgKiAocXVhdGVybmlvbi54ICogcXVhdGVybmlvbi54ICsgcXVhdGVybmlvbi55ICogcXVhdGVybmlvbi55KTsKICAgICAgICBjb25zdCBudW1lcmF0b3JSb2xsID0gMiAqIChxdWF0ZXJuaW9uLncgKiBxdWF0ZXJuaW9uLnggKyBxdWF0ZXJuaW9uLnkgKiBxdWF0ZXJuaW9uLnopOwogICAgICAgIGNvbnN0IGRlbm9taW5hdG9ySGVhZGluZyA9IDEgLSAyICogKHF1YXRlcm5pb24ueSAqIHF1YXRlcm5pb24ueSArIHF1YXRlcm5pb24ueiAqIHF1YXRlcm5pb24ueik7CiAgICAgICAgY29uc3QgbnVtZXJhdG9ySGVhZGluZyA9IDIgKiAocXVhdGVybmlvbi53ICogcXVhdGVybmlvbi56ICsgcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi55KTsKICAgICAgICByZXN1bHQuaGVhZGluZyA9IC1NYXRoLmF0YW4yKG51bWVyYXRvckhlYWRpbmcsIGRlbm9taW5hdG9ySGVhZGluZyk7CiAgICAgICAgcmVzdWx0LnJvbGwgPSBNYXRoLmF0YW4yKG51bWVyYXRvclJvbGwsIGRlbm9taW5hdG9yUm9sbCk7CiAgICAgICAgcmVzdWx0LnBpdGNoID0gLU1hdGhfZGVmYXVsdC5hc2luQ2xhbXBlZCh0ZXN0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLmZyb21EZWdyZWVzID0gZnVuY3Rpb24oaGVhZGluZywgcGl0Y2gsIHJvbGwsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhlYWRpbmcpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaGVhZGluZyBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwaXRjaCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwaXRjaCBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyb2xsKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJvbGwgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEhlYWRpbmdQaXRjaFJvbGwoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmhlYWRpbmcgPSBoZWFkaW5nICogTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRTsKICAgICAgICByZXN1bHQucGl0Y2ggPSBwaXRjaCAqIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUU7CiAgICAgICAgcmVzdWx0LnJvbGwgPSByb2xsICogTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLmNsb25lID0gZnVuY3Rpb24oaGVhZGluZ1BpdGNoUm9sbCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaGVhZGluZ1BpdGNoUm9sbCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgSGVhZGluZ1BpdGNoUm9sbCgKICAgICAgICAgICAgaGVhZGluZ1BpdGNoUm9sbC5oZWFkaW5nLAogICAgICAgICAgICBoZWFkaW5nUGl0Y2hSb2xsLnBpdGNoLAogICAgICAgICAgICBoZWFkaW5nUGl0Y2hSb2xsLnJvbGwKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5oZWFkaW5nID0gaGVhZGluZ1BpdGNoUm9sbC5oZWFkaW5nOwogICAgICAgIHJlc3VsdC5waXRjaCA9IGhlYWRpbmdQaXRjaFJvbGwucGl0Y2g7CiAgICAgICAgcmVzdWx0LnJvbGwgPSBoZWFkaW5nUGl0Y2hSb2xsLnJvbGw7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSGVhZGluZ1BpdGNoUm9sbC5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LmhlYWRpbmcgPT09IHJpZ2h0LmhlYWRpbmcgJiYgbGVmdC5waXRjaCA9PT0gcmlnaHQucGl0Y2ggJiYgbGVmdC5yb2xsID09PSByaWdodC5yb2xsOwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LmhlYWRpbmcsCiAgICAgICAgICByaWdodC5oZWFkaW5nLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGxlZnQucGl0Y2gsCiAgICAgICAgICByaWdodC5waXRjaCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBsZWZ0LnJvbGwsCiAgICAgICAgICByaWdodC5yb2xsLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgSGVhZGluZ1BpdGNoUm9sbC5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXR1cm4gSGVhZGluZ1BpdGNoUm9sbC5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihyaWdodCkgewogICAgICAgIHJldHVybiBIZWFkaW5nUGl0Y2hSb2xsLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIEhlYWRpbmdQaXRjaFJvbGwucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihyaWdodCwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gSGVhZGluZ1BpdGNoUm9sbC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcywKICAgICAgICAgIHJpZ2h0LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgSGVhZGluZ1BpdGNoUm9sbC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYCgke3RoaXMuaGVhZGluZ30sICR7dGhpcy5waXRjaH0sICR7dGhpcy5yb2xsfSlgOwogICAgICB9OwogICAgICBIZWFkaW5nUGl0Y2hSb2xsX2RlZmF1bHQgPSBIZWFkaW5nUGl0Y2hSb2xsOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYnVpbGRNb2R1bGVVcmwuanMKICBmdW5jdGlvbiBnZXRCYXNlVXJsRnJvbUNlc2l1bVNjcmlwdCgpIHsKICAgIGNvbnN0IHNjcmlwdHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgic2NyaXB0Iik7CiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gc2NyaXB0cy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICBjb25zdCBzcmMgPSBzY3JpcHRzW2ldLmdldEF0dHJpYnV0ZSgic3JjIik7CiAgICAgIGNvbnN0IHJlc3VsdCA9IGNlc2l1bVNjcmlwdFJlZ2V4LmV4ZWMoc3JjKTsKICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiByZXN1bHRbMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGZ1bmN0aW9uIHRyeU1ha2VBYnNvbHV0ZSh1cmwpIHsKICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHJldHVybiB1cmw7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhMikpIHsKICAgICAgYTIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICB9CiAgICBhMi5ocmVmID0gdXJsOwogICAgcmV0dXJuIGEyLmhyZWY7CiAgfQogIGZ1bmN0aW9uIGdldENlc2l1bUJhc2VVcmwoKSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJhc2VSZXNvdXJjZSkpIHsKICAgICAgcmV0dXJuIGJhc2VSZXNvdXJjZTsKICAgIH0KICAgIGxldCBiYXNlVXJsU3RyaW5nOwogICAgaWYgKHR5cGVvZiBDRVNJVU1fQkFTRV9VUkwgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIGJhc2VVcmxTdHJpbmcgPSBDRVNJVU1fQkFTRV9VUkw7CiAgICB9IGVsc2UgaWYgKGRlZmluZWRfZGVmYXVsdChpbXBvcnRfbWV0YT8udXJsKSkgewogICAgICBiYXNlVXJsU3RyaW5nID0gZ2V0QWJzb2x1dGVVcmlfZGVmYXVsdCgiLiIsIGltcG9ydF9tZXRhLnVybCk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJvYmplY3QiICYmIGRlZmluZWRfZGVmYXVsdChkZWZpbmUuYW1kKSAmJiAhZGVmaW5lLmFtZC50b1VybFVuZGVmaW5lZCAmJiBkZWZpbmVkX2RlZmF1bHQoX19yZXF1aXJlLnRvVXJsKSkgewogICAgICBiYXNlVXJsU3RyaW5nID0gZ2V0QWJzb2x1dGVVcmlfZGVmYXVsdCgKICAgICAgICAiLi4iLAogICAgICAgIGJ1aWxkTW9kdWxlVXJsKCJDb3JlL2J1aWxkTW9kdWxlVXJsLmpzIikKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIGJhc2VVcmxTdHJpbmcgPSBnZXRCYXNlVXJsRnJvbUNlc2l1bVNjcmlwdCgpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYmFzZVVybFN0cmluZykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIlVuYWJsZSB0byBkZXRlcm1pbmUgQ2VzaXVtIGJhc2UgVVJMIGF1dG9tYXRpY2FsbHksIHRyeSBkZWZpbmluZyBhIGdsb2JhbCB2YXJpYWJsZSBjYWxsZWQgQ0VTSVVNX0JBU0VfVVJMLiIKICAgICAgKTsKICAgIH0KICAgIGJhc2VSZXNvdXJjZSA9IG5ldyBSZXNvdXJjZV9kZWZhdWx0KHsKICAgICAgdXJsOiB0cnlNYWtlQWJzb2x1dGUoYmFzZVVybFN0cmluZykKICAgIH0pOwogICAgYmFzZVJlc291cmNlLmFwcGVuZEZvcndhcmRTbGFzaCgpOwogICAgcmV0dXJuIGJhc2VSZXNvdXJjZTsKICB9CiAgZnVuY3Rpb24gYnVpbGRNb2R1bGVVcmxGcm9tUmVxdWlyZVRvVXJsKG1vZHVsZUlEKSB7CiAgICByZXR1cm4gdHJ5TWFrZUFic29sdXRlKF9fcmVxdWlyZS50b1VybChgLi4vJHttb2R1bGVJRH1gKSk7CiAgfQogIGZ1bmN0aW9uIGJ1aWxkTW9kdWxlVXJsRnJvbUJhc2VVcmwobW9kdWxlSUQpIHsKICAgIGNvbnN0IHJlc291cmNlID0gZ2V0Q2VzaXVtQmFzZVVybCgpLmdldERlcml2ZWRSZXNvdXJjZSh7CiAgICAgIHVybDogbW9kdWxlSUQKICAgIH0pOwogICAgcmV0dXJuIHJlc291cmNlLnVybDsKICB9CiAgZnVuY3Rpb24gYnVpbGRNb2R1bGVVcmwocmVsYXRpdmVVcmwpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGltcGxlbWVudGF0aW9uKSkgewogICAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gIm9iamVjdCIgJiYgZGVmaW5lZF9kZWZhdWx0KGRlZmluZS5hbWQpICYmICFkZWZpbmUuYW1kLnRvVXJsVW5kZWZpbmVkICYmIGRlZmluZWRfZGVmYXVsdChfX3JlcXVpcmUudG9VcmwpKSB7CiAgICAgICAgaW1wbGVtZW50YXRpb24gPSBidWlsZE1vZHVsZVVybEZyb21SZXF1aXJlVG9Vcmw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW1wbGVtZW50YXRpb24gPSBidWlsZE1vZHVsZVVybEZyb21CYXNlVXJsOwogICAgICB9CiAgICB9CiAgICBjb25zdCB1cmwgPSBpbXBsZW1lbnRhdGlvbihyZWxhdGl2ZVVybCk7CiAgICByZXR1cm4gdXJsOwogIH0KICB2YXIgaW1wb3J0X21ldGEsIGNlc2l1bVNjcmlwdFJlZ2V4LCBhMiwgYmFzZVJlc291cmNlLCBpbXBsZW1lbnRhdGlvbiwgYnVpbGRNb2R1bGVVcmxfZGVmYXVsdDsKICB2YXIgaW5pdF9idWlsZE1vZHVsZVVybCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYnVpbGRNb2R1bGVVcmwuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X2dldEFic29sdXRlVXJpKCk7CiAgICAgIGluaXRfUmVzb3VyY2UoKTsKICAgICAgaW1wb3J0X21ldGEgPSB7fTsKICAgICAgY2VzaXVtU2NyaXB0UmVnZXggPSAvKCg/Oi4qXC8pfF4pQ2VzaXVtXC5qcyg/Olw/fFwjfCQpLzsKICAgICAgYnVpbGRNb2R1bGVVcmwuX2Nlc2l1bVNjcmlwdFJlZ2V4ID0gY2VzaXVtU2NyaXB0UmVnZXg7CiAgICAgIGJ1aWxkTW9kdWxlVXJsLl9idWlsZE1vZHVsZVVybEZyb21CYXNlVXJsID0gYnVpbGRNb2R1bGVVcmxGcm9tQmFzZVVybDsKICAgICAgYnVpbGRNb2R1bGVVcmwuX2NsZWFyQmFzZVJlc291cmNlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgYmFzZVJlc291cmNlID0gdm9pZCAwOwogICAgICB9OwogICAgICBidWlsZE1vZHVsZVVybC5zZXRCYXNlVXJsID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBiYXNlUmVzb3VyY2UgPSBSZXNvdXJjZV9kZWZhdWx0LkRFRkFVTFQuZ2V0RGVyaXZlZFJlc291cmNlKHsKICAgICAgICAgIHVybDogdmFsdWUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgYnVpbGRNb2R1bGVVcmwuZ2V0Q2VzaXVtQmFzZVVybCA9IGdldENlc2l1bUJhc2VVcmw7CiAgICAgIGJ1aWxkTW9kdWxlVXJsX2RlZmF1bHQgPSBidWlsZE1vZHVsZVVybDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0lhdTIwMDZYeXNTYW1wbGUuanMKICBmdW5jdGlvbiBJYXUyMDA2WHlzU2FtcGxlKHgsIHksIHMpIHsKICAgIHRoaXMueCA9IHg7CiAgICB0aGlzLnkgPSB5OwogICAgdGhpcy5zID0gczsKICB9CiAgdmFyIElhdTIwMDZYeXNTYW1wbGVfZGVmYXVsdDsKICB2YXIgaW5pdF9JYXUyMDA2WHlzU2FtcGxlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JYXUyMDA2WHlzU2FtcGxlLmpzIigpIHsKICAgICAgSWF1MjAwNlh5c1NhbXBsZV9kZWZhdWx0ID0gSWF1MjAwNlh5c1NhbXBsZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0lhdTIwMDZYeXNEYXRhLmpzCiAgZnVuY3Rpb24gSWF1MjAwNlh5c0RhdGEob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICB0aGlzLl94eXNGaWxlVXJsVGVtcGxhdGUgPSBSZXNvdXJjZV9kZWZhdWx0LmNyZWF0ZUlmTmVlZGVkKAogICAgICBvcHRpb25zLnh5c0ZpbGVVcmxUZW1wbGF0ZQogICAgKTsKICAgIHRoaXMuX2ludGVycG9sYXRpb25PcmRlciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaW50ZXJwb2xhdGlvbk9yZGVyLCA5KTsKICAgIHRoaXMuX3NhbXBsZVplcm9KdWxpYW5FcGhlbWVyaXNEYXRlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuc2FtcGxlWmVyb0p1bGlhbkVwaGVtZXJpc0RhdGUsCiAgICAgIDI0NDIzOTY1ZS0xCiAgICApOwogICAgdGhpcy5fc2FtcGxlWmVyb0RhdGVUVCA9IG5ldyBKdWxpYW5EYXRlX2RlZmF1bHQoCiAgICAgIHRoaXMuX3NhbXBsZVplcm9KdWxpYW5FcGhlbWVyaXNEYXRlLAogICAgICAwLAogICAgICBUaW1lU3RhbmRhcmRfZGVmYXVsdC5UQUkKICAgICk7CiAgICB0aGlzLl9zdGVwU2l6ZURheXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN0ZXBTaXplRGF5cywgMSk7CiAgICB0aGlzLl9zYW1wbGVzUGVyWHlzRmlsZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc2FtcGxlc1Blclh5c0ZpbGUsIDFlMyk7CiAgICB0aGlzLl90b3RhbFNhbXBsZXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnRvdGFsU2FtcGxlcywgMjc0MjYpOwogICAgdGhpcy5fc2FtcGxlcyA9IG5ldyBBcnJheSh0aGlzLl90b3RhbFNhbXBsZXMgKiAzKTsKICAgIHRoaXMuX2NodW5rRG93bmxvYWRzSW5Qcm9ncmVzcyA9IFtdOwogICAgY29uc3Qgb3JkZXIgPSB0aGlzLl9pbnRlcnBvbGF0aW9uT3JkZXI7CiAgICBjb25zdCBkZW5vbSA9IHRoaXMuX2Rlbm9taW5hdG9ycyA9IG5ldyBBcnJheShvcmRlciArIDEpOwogICAgY29uc3QgeFRhYmxlID0gdGhpcy5feFRhYmxlID0gbmV3IEFycmF5KG9yZGVyICsgMSk7CiAgICBjb25zdCBzdGVwTiA9IE1hdGgucG93KHRoaXMuX3N0ZXBTaXplRGF5cywgb3JkZXIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gb3JkZXI7ICsraSkgewogICAgICBkZW5vbVtpXSA9IHN0ZXBOOwogICAgICB4VGFibGVbaV0gPSBpICogdGhpcy5fc3RlcFNpemVEYXlzOwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8PSBvcmRlcjsgKytqKSB7CiAgICAgICAgaWYgKGogIT09IGkpIHsKICAgICAgICAgIGRlbm9tW2ldICo9IGkgLSBqOwogICAgICAgIH0KICAgICAgfQogICAgICBkZW5vbVtpXSA9IDEgLyBkZW5vbVtpXTsKICAgIH0KICAgIHRoaXMuX3dvcmsgPSBuZXcgQXJyYXkob3JkZXIgKyAxKTsKICAgIHRoaXMuX2NvZWYgPSBuZXcgQXJyYXkob3JkZXIgKyAxKTsKICB9CiAgZnVuY3Rpb24gZ2V0RGF5c1NpbmNlRXBvY2goeHlzLCBkYXlUVCwgc2Vjb25kVFQpIHsKICAgIGNvbnN0IGRhdGVUVCA9IGp1bGlhbkRhdGVTY3JhdGNoOwogICAgZGF0ZVRULmRheU51bWJlciA9IGRheVRUOwogICAgZGF0ZVRULnNlY29uZHNPZkRheSA9IHNlY29uZFRUOwogICAgcmV0dXJuIEp1bGlhbkRhdGVfZGVmYXVsdC5kYXlzRGlmZmVyZW5jZShkYXRlVFQsIHh5cy5fc2FtcGxlWmVyb0RhdGVUVCk7CiAgfQogIGZ1bmN0aW9uIHJlcXVlc3RYeXNDaHVuayh4eXNEYXRhLCBjaHVua0luZGV4KSB7CiAgICBpZiAoeHlzRGF0YS5fY2h1bmtEb3dubG9hZHNJblByb2dyZXNzW2NodW5rSW5kZXhdKSB7CiAgICAgIHJldHVybiB4eXNEYXRhLl9jaHVua0Rvd25sb2Fkc0luUHJvZ3Jlc3NbY2h1bmtJbmRleF07CiAgICB9CiAgICBsZXQgY2h1bmtVcmw7CiAgICBjb25zdCB4eXNGaWxlVXJsVGVtcGxhdGUgPSB4eXNEYXRhLl94eXNGaWxlVXJsVGVtcGxhdGU7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHh5c0ZpbGVVcmxUZW1wbGF0ZSkpIHsKICAgICAgY2h1bmtVcmwgPSB4eXNGaWxlVXJsVGVtcGxhdGUuZ2V0RGVyaXZlZFJlc291cmNlKHsKICAgICAgICB0ZW1wbGF0ZVZhbHVlczogewogICAgICAgICAgMDogY2h1bmtJbmRleAogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBjaHVua1VybCA9IG5ldyBSZXNvdXJjZV9kZWZhdWx0KHsKICAgICAgICB1cmw6IGJ1aWxkTW9kdWxlVXJsX2RlZmF1bHQoYEFzc2V0cy9JQVUyMDA2X1hZUy9JQVUyMDA2X1hZU18ke2NodW5rSW5kZXh9Lmpzb25gKQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IHByb21pc2UgPSBjaHVua1VybC5mZXRjaEpzb24oKS50aGVuKGZ1bmN0aW9uKGNodW5rKSB7CiAgICAgIHh5c0RhdGEuX2NodW5rRG93bmxvYWRzSW5Qcm9ncmVzc1tjaHVua0luZGV4XSA9IGZhbHNlOwogICAgICBjb25zdCBzYW1wbGVzID0geHlzRGF0YS5fc2FtcGxlczsKICAgICAgY29uc3QgbmV3U2FtcGxlcyA9IGNodW5rLnNhbXBsZXM7CiAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBjaHVua0luZGV4ICogeHlzRGF0YS5fc2FtcGxlc1Blclh5c0ZpbGUgKiAzOwogICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gbmV3U2FtcGxlcy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgIHNhbXBsZXNbc3RhcnRJbmRleCArIGldID0gbmV3U2FtcGxlc1tpXTsKICAgICAgfQogICAgfSk7CiAgICB4eXNEYXRhLl9jaHVua0Rvd25sb2Fkc0luUHJvZ3Jlc3NbY2h1bmtJbmRleF0gPSBwcm9taXNlOwogICAgcmV0dXJuIHByb21pc2U7CiAgfQogIHZhciBqdWxpYW5EYXRlU2NyYXRjaCwgSWF1MjAwNlh5c0RhdGFfZGVmYXVsdDsKICB2YXIgaW5pdF9JYXUyMDA2WHlzRGF0YSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSWF1MjAwNlh5c0RhdGEuanMiKCkgewogICAgICBpbml0X2J1aWxkTW9kdWxlVXJsKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0lhdTIwMDZYeXNTYW1wbGUoKTsKICAgICAgaW5pdF9KdWxpYW5EYXRlKCk7CiAgICAgIGluaXRfUmVzb3VyY2UoKTsKICAgICAgaW5pdF9UaW1lU3RhbmRhcmQoKTsKICAgICAganVsaWFuRGF0ZVNjcmF0Y2ggPSBuZXcgSnVsaWFuRGF0ZV9kZWZhdWx0KDAsIDAsIFRpbWVTdGFuZGFyZF9kZWZhdWx0LlRBSSk7CiAgICAgIElhdTIwMDZYeXNEYXRhLnByb3RvdHlwZS5wcmVsb2FkID0gZnVuY3Rpb24oc3RhcnREYXlUVCwgc3RhcnRTZWNvbmRUVCwgc3RvcERheVRULCBzdG9wU2Vjb25kVFQpIHsKICAgICAgICBjb25zdCBzdGFydERheXNTaW5jZUVwb2NoID0gZ2V0RGF5c1NpbmNlRXBvY2goCiAgICAgICAgICB0aGlzLAogICAgICAgICAgc3RhcnREYXlUVCwKICAgICAgICAgIHN0YXJ0U2Vjb25kVFQKICAgICAgICApOwogICAgICAgIGNvbnN0IHN0b3BEYXlzU2luY2VFcG9jaCA9IGdldERheXNTaW5jZUVwb2NoKHRoaXMsIHN0b3BEYXlUVCwgc3RvcFNlY29uZFRUKTsKICAgICAgICBsZXQgc3RhcnRJbmRleCA9IHN0YXJ0RGF5c1NpbmNlRXBvY2ggLyB0aGlzLl9zdGVwU2l6ZURheXMgLSB0aGlzLl9pbnRlcnBvbGF0aW9uT3JkZXIgLyAyIHwgMDsKICAgICAgICBpZiAoc3RhcnRJbmRleCA8IDApIHsKICAgICAgICAgIHN0YXJ0SW5kZXggPSAwOwogICAgICAgIH0KICAgICAgICBsZXQgc3RvcEluZGV4ID0gc3RvcERheXNTaW5jZUVwb2NoIC8gdGhpcy5fc3RlcFNpemVEYXlzIC0gdGhpcy5faW50ZXJwb2xhdGlvbk9yZGVyIC8gMiB8IDAgKyB0aGlzLl9pbnRlcnBvbGF0aW9uT3JkZXI7CiAgICAgICAgaWYgKHN0b3BJbmRleCA+PSB0aGlzLl90b3RhbFNhbXBsZXMpIHsKICAgICAgICAgIHN0b3BJbmRleCA9IHRoaXMuX3RvdGFsU2FtcGxlcyAtIDE7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN0YXJ0Q2h1bmsgPSBzdGFydEluZGV4IC8gdGhpcy5fc2FtcGxlc1Blclh5c0ZpbGUgfCAwOwogICAgICAgIGNvbnN0IHN0b3BDaHVuayA9IHN0b3BJbmRleCAvIHRoaXMuX3NhbXBsZXNQZXJYeXNGaWxlIHwgMDsKICAgICAgICBjb25zdCBwcm9taXNlcyA9IFtdOwogICAgICAgIGZvciAobGV0IGkgPSBzdGFydENodW5rOyBpIDw9IHN0b3BDaHVuazsgKytpKSB7CiAgICAgICAgICBwcm9taXNlcy5wdXNoKHJlcXVlc3RYeXNDaHVuayh0aGlzLCBpKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcyk7CiAgICAgIH07CiAgICAgIElhdTIwMDZYeXNEYXRhLnByb3RvdHlwZS5jb21wdXRlWHlzUmFkaWFucyA9IGZ1bmN0aW9uKGRheVRULCBzZWNvbmRUVCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgZGF5c1NpbmNlRXBvY2ggPSBnZXREYXlzU2luY2VFcG9jaCh0aGlzLCBkYXlUVCwgc2Vjb25kVFQpOwogICAgICAgIGlmIChkYXlzU2luY2VFcG9jaCA8IDApIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNlbnRlckluZGV4ID0gZGF5c1NpbmNlRXBvY2ggLyB0aGlzLl9zdGVwU2l6ZURheXMgfCAwOwogICAgICAgIGlmIChjZW50ZXJJbmRleCA+PSB0aGlzLl90b3RhbFNhbXBsZXMpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRlZ3JlZSA9IHRoaXMuX2ludGVycG9sYXRpb25PcmRlcjsKICAgICAgICBsZXQgZmlyc3RJbmRleCA9IGNlbnRlckluZGV4IC0gKGRlZ3JlZSAvIDIgfCAwKTsKICAgICAgICBpZiAoZmlyc3RJbmRleCA8IDApIHsKICAgICAgICAgIGZpcnN0SW5kZXggPSAwOwogICAgICAgIH0KICAgICAgICBsZXQgbGFzdEluZGV4ID0gZmlyc3RJbmRleCArIGRlZ3JlZTsKICAgICAgICBpZiAobGFzdEluZGV4ID49IHRoaXMuX3RvdGFsU2FtcGxlcykgewogICAgICAgICAgbGFzdEluZGV4ID0gdGhpcy5fdG90YWxTYW1wbGVzIC0gMTsKICAgICAgICAgIGZpcnN0SW5kZXggPSBsYXN0SW5kZXggLSBkZWdyZWU7CiAgICAgICAgICBpZiAoZmlyc3RJbmRleCA8IDApIHsKICAgICAgICAgICAgZmlyc3RJbmRleCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCBpc0RhdGFNaXNzaW5nID0gZmFsc2U7CiAgICAgICAgY29uc3Qgc2FtcGxlcyA9IHRoaXMuX3NhbXBsZXM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc2FtcGxlc1tmaXJzdEluZGV4ICogM10pKSB7CiAgICAgICAgICByZXF1ZXN0WHlzQ2h1bmsodGhpcywgZmlyc3RJbmRleCAvIHRoaXMuX3NhbXBsZXNQZXJYeXNGaWxlIHwgMCk7CiAgICAgICAgICBpc0RhdGFNaXNzaW5nID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc2FtcGxlc1tsYXN0SW5kZXggKiAzXSkpIHsKICAgICAgICAgIHJlcXVlc3RYeXNDaHVuayh0aGlzLCBsYXN0SW5kZXggLyB0aGlzLl9zYW1wbGVzUGVyWHlzRmlsZSB8IDApOwogICAgICAgICAgaXNEYXRhTWlzc2luZyA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChpc0RhdGFNaXNzaW5nKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgSWF1MjAwNlh5c1NhbXBsZV9kZWZhdWx0KDAsIDAsIDApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQueCA9IDA7CiAgICAgICAgICByZXN1bHQueSA9IDA7CiAgICAgICAgICByZXN1bHQucyA9IDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHggPSBkYXlzU2luY2VFcG9jaCAtIGZpcnN0SW5kZXggKiB0aGlzLl9zdGVwU2l6ZURheXM7CiAgICAgICAgY29uc3Qgd29yayA9IHRoaXMuX3dvcms7CiAgICAgICAgY29uc3QgZGVub20gPSB0aGlzLl9kZW5vbWluYXRvcnM7CiAgICAgICAgY29uc3QgY29lZiA9IHRoaXMuX2NvZWY7CiAgICAgICAgY29uc3QgeFRhYmxlID0gdGhpcy5feFRhYmxlOwogICAgICAgIGxldCBpLCBqOwogICAgICAgIGZvciAoaSA9IDA7IGkgPD0gZGVncmVlOyArK2kpIHsKICAgICAgICAgIHdvcmtbaV0gPSB4IC0geFRhYmxlW2ldOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAwOyBpIDw9IGRlZ3JlZTsgKytpKSB7CiAgICAgICAgICBjb2VmW2ldID0gMTsKICAgICAgICAgIGZvciAoaiA9IDA7IGogPD0gZGVncmVlOyArK2opIHsKICAgICAgICAgICAgaWYgKGogIT09IGkpIHsKICAgICAgICAgICAgICBjb2VmW2ldICo9IHdvcmtbal07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNvZWZbaV0gKj0gZGVub21baV07CiAgICAgICAgICBsZXQgc2FtcGxlSW5kZXggPSAoZmlyc3RJbmRleCArIGkpICogMzsKICAgICAgICAgIHJlc3VsdC54ICs9IGNvZWZbaV0gKiBzYW1wbGVzW3NhbXBsZUluZGV4KytdOwogICAgICAgICAgcmVzdWx0LnkgKz0gY29lZltpXSAqIHNhbXBsZXNbc2FtcGxlSW5kZXgrK107CiAgICAgICAgICByZXN1bHQucyArPSBjb2VmW2ldICogc2FtcGxlc1tzYW1wbGVJbmRleF07CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIElhdTIwMDZYeXNEYXRhX2RlZmF1bHQgPSBJYXUyMDA2WHlzRGF0YTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0Z1bGxzY3JlZW4uanMKICB2YXIgX3N1cHBvcnRzRnVsbHNjcmVlbiwgX25hbWVzLCBGdWxsc2NyZWVuLCBGdWxsc2NyZWVuX2RlZmF1bHQ7CiAgdmFyIGluaXRfRnVsbHNjcmVlbiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRnVsbHNjcmVlbi5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBfbmFtZXMgPSB7CiAgICAgICAgcmVxdWVzdEZ1bGxzY3JlZW46IHZvaWQgMCwKICAgICAgICBleGl0RnVsbHNjcmVlbjogdm9pZCAwLAogICAgICAgIGZ1bGxzY3JlZW5FbmFibGVkOiB2b2lkIDAsCiAgICAgICAgZnVsbHNjcmVlbkVsZW1lbnQ6IHZvaWQgMCwKICAgICAgICBmdWxsc2NyZWVuY2hhbmdlOiB2b2lkIDAsCiAgICAgICAgZnVsbHNjcmVlbmVycm9yOiB2b2lkIDAKICAgICAgfTsKICAgICAgRnVsbHNjcmVlbiA9IHt9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhGdWxsc2NyZWVuLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGVsZW1lbnQgdGhhdCBpcyBjdXJyZW50bHkgZnVsbHNjcmVlbiwgaWYgYW55LiAgVG8gc2ltcGx5IGNoZWNrIGlmIHRoZQogICAgICAgICAqIGJyb3dzZXIgaXMgaW4gZnVsbHNjcmVlbiBtb2RlIG9yIG5vdCwgdXNlIHtAbGluayBGdWxsc2NyZWVuI2Z1bGxzY3JlZW59LgogICAgICAgICAqIEBtZW1iZXJvZiBGdWxsc2NyZWVuCiAgICAgICAgICogQHR5cGUge29iamVjdH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbGVtZW50OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIUZ1bGxzY3JlZW4uc3VwcG9ydHNGdWxsc2NyZWVuKCkpIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudFtfbmFtZXMuZnVsbHNjcmVlbkVsZW1lbnRdOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG5hbWUgb2YgdGhlIGV2ZW50IG9uIHRoZSBkb2N1bWVudCB0aGF0IGlzIGZpcmVkIHdoZW4gZnVsbHNjcmVlbiBpcwogICAgICAgICAqIGVudGVyZWQgb3IgZXhpdGVkLiAgVGhpcyBldmVudCBuYW1lIGlzIGludGVuZGVkIGZvciB1c2Ugd2l0aCBhZGRFdmVudExpc3RlbmVyLgogICAgICAgICAqIEluIHlvdXIgZXZlbnQgaGFuZGxlciwgdG8gZGV0ZXJtaW5lIGlmIHRoZSBicm93c2VyIGlzIGluIGZ1bGxzY3JlZW4gbW9kZSBvciBub3QsCiAgICAgICAgICogdXNlIHtAbGluayBGdWxsc2NyZWVuI2Z1bGxzY3JlZW59LgogICAgICAgICAqIEBtZW1iZXJvZiBGdWxsc2NyZWVuCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBjaGFuZ2VFdmVudE5hbWU6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghRnVsbHNjcmVlbi5zdXBwb3J0c0Z1bGxzY3JlZW4oKSkgewogICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIF9uYW1lcy5mdWxsc2NyZWVuY2hhbmdlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG5hbWUgb2YgdGhlIGV2ZW50IHRoYXQgaXMgZmlyZWQgd2hlbiBhIGZ1bGxzY3JlZW4gZXJyb3IKICAgICAgICAgKiBvY2N1cnMuICBUaGlzIGV2ZW50IG5hbWUgaXMgaW50ZW5kZWQgZm9yIHVzZSB3aXRoIGFkZEV2ZW50TGlzdGVuZXIuCiAgICAgICAgICogQG1lbWJlcm9mIEZ1bGxzY3JlZW4KICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGVycm9yRXZlbnROYW1lOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIUZ1bGxzY3JlZW4uc3VwcG9ydHNGdWxsc2NyZWVuKCkpIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBfbmFtZXMuZnVsbHNjcmVlbmVycm9yOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogRGV0ZXJtaW5lIHdoZXRoZXIgdGhlIGJyb3dzZXIgd2lsbCBhbGxvdyBhbiBlbGVtZW50IHRvIGJlIG1hZGUgZnVsbHNjcmVlbiwgb3Igbm90LgogICAgICAgICAqIEZvciBleGFtcGxlLCBieSBkZWZhdWx0LCBpZnJhbWVzIGNhbm5vdCBnbyBmdWxsc2NyZWVuIHVubGVzcyB0aGUgY29udGFpbmluZyBwYWdlCiAgICAgICAgICogYWRkcyBhbiAiYWxsb3dmdWxsc2NyZWVuIiBhdHRyaWJ1dGUgKG9yIHByZWZpeGVkIGVxdWl2YWxlbnQpLgogICAgICAgICAqIEBtZW1iZXJvZiBGdWxsc2NyZWVuCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgZW5hYmxlZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFGdWxsc2NyZWVuLnN1cHBvcnRzRnVsbHNjcmVlbigpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZG9jdW1lbnRbX25hbWVzLmZ1bGxzY3JlZW5FbmFibGVkXTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIERldGVybWluZXMgaWYgdGhlIGJyb3dzZXIgaXMgY3VycmVudGx5IGluIGZ1bGxzY3JlZW4gbW9kZS4KICAgICAgICAgKiBAbWVtYmVyb2YgRnVsbHNjcmVlbgogICAgICAgICAqIEB0eXBlIHtib29sZWFufQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGZ1bGxzY3JlZW46IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghRnVsbHNjcmVlbi5zdXBwb3J0c0Z1bGxzY3JlZW4oKSkgewogICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIEZ1bGxzY3JlZW4uZWxlbWVudCAhPT0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBGdWxsc2NyZWVuLnN1cHBvcnRzRnVsbHNjcmVlbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoX3N1cHBvcnRzRnVsbHNjcmVlbikpIHsKICAgICAgICAgIHJldHVybiBfc3VwcG9ydHNGdWxsc2NyZWVuOwogICAgICAgIH0KICAgICAgICBfc3VwcG9ydHNGdWxsc2NyZWVuID0gZmFsc2U7CiAgICAgICAgY29uc3QgYm9keSA9IGRvY3VtZW50LmJvZHk7CiAgICAgICAgaWYgKHR5cGVvZiBib2R5LnJlcXVlc3RGdWxsc2NyZWVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfbmFtZXMucmVxdWVzdEZ1bGxzY3JlZW4gPSAicmVxdWVzdEZ1bGxzY3JlZW4iOwogICAgICAgICAgX25hbWVzLmV4aXRGdWxsc2NyZWVuID0gImV4aXRGdWxsc2NyZWVuIjsKICAgICAgICAgIF9uYW1lcy5mdWxsc2NyZWVuRW5hYmxlZCA9ICJmdWxsc2NyZWVuRW5hYmxlZCI7CiAgICAgICAgICBfbmFtZXMuZnVsbHNjcmVlbkVsZW1lbnQgPSAiZnVsbHNjcmVlbkVsZW1lbnQiOwogICAgICAgICAgX25hbWVzLmZ1bGxzY3JlZW5jaGFuZ2UgPSAiZnVsbHNjcmVlbmNoYW5nZSI7CiAgICAgICAgICBfbmFtZXMuZnVsbHNjcmVlbmVycm9yID0gImZ1bGxzY3JlZW5lcnJvciI7CiAgICAgICAgICBfc3VwcG9ydHNGdWxsc2NyZWVuID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiBfc3VwcG9ydHNGdWxsc2NyZWVuOwogICAgICAgIH0KICAgICAgICBjb25zdCBwcmVmaXhlcyA9IFsid2Via2l0IiwgIm1veiIsICJvIiwgIm1zIiwgImtodG1sIl07CiAgICAgICAgbGV0IG5hbWU7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHByZWZpeGVzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgICBjb25zdCBwcmVmaXggPSBwcmVmaXhlc1tpXTsKICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9UmVxdWVzdEZ1bGxzY3JlZW5gOwogICAgICAgICAgaWYgKHR5cGVvZiBib2R5W25hbWVdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIF9uYW1lcy5yZXF1ZXN0RnVsbHNjcmVlbiA9IG5hbWU7CiAgICAgICAgICAgIF9zdXBwb3J0c0Z1bGxzY3JlZW4gPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmFtZSA9IGAke3ByZWZpeH1SZXF1ZXN0RnVsbFNjcmVlbmA7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYm9keVtuYW1lXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIF9uYW1lcy5yZXF1ZXN0RnVsbHNjcmVlbiA9IG5hbWU7CiAgICAgICAgICAgICAgX3N1cHBvcnRzRnVsbHNjcmVlbiA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9RXhpdEZ1bGxzY3JlZW5gOwogICAgICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudFtuYW1lXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBfbmFtZXMuZXhpdEZ1bGxzY3JlZW4gPSBuYW1lOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmFtZSA9IGAke3ByZWZpeH1DYW5jZWxGdWxsU2NyZWVuYDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudFtuYW1lXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIF9uYW1lcy5leGl0RnVsbHNjcmVlbiA9IG5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9RnVsbHNjcmVlbkVuYWJsZWRgOwogICAgICAgICAgaWYgKGRvY3VtZW50W25hbWVdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgX25hbWVzLmZ1bGxzY3JlZW5FbmFibGVkID0gbmFtZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9RnVsbFNjcmVlbkVuYWJsZWRgOwogICAgICAgICAgICBpZiAoZG9jdW1lbnRbbmFtZV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIF9uYW1lcy5mdWxsc2NyZWVuRW5hYmxlZCA9IG5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9RnVsbHNjcmVlbkVsZW1lbnRgOwogICAgICAgICAgaWYgKGRvY3VtZW50W25hbWVdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgX25hbWVzLmZ1bGxzY3JlZW5FbGVtZW50ID0gbmFtZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9RnVsbFNjcmVlbkVsZW1lbnRgOwogICAgICAgICAgICBpZiAoZG9jdW1lbnRbbmFtZV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIF9uYW1lcy5mdWxsc2NyZWVuRWxlbWVudCA9IG5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5hbWUgPSBgJHtwcmVmaXh9ZnVsbHNjcmVlbmNoYW5nZWA7CiAgICAgICAgICBpZiAoZG9jdW1lbnRbYG9uJHtuYW1lfWBdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHByZWZpeCA9PT0gIm1zIikgewogICAgICAgICAgICAgIG5hbWUgPSAiTVNGdWxsc2NyZWVuQ2hhbmdlIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBfbmFtZXMuZnVsbHNjcmVlbmNoYW5nZSA9IG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICBuYW1lID0gYCR7cHJlZml4fWZ1bGxzY3JlZW5lcnJvcmA7CiAgICAgICAgICBpZiAoZG9jdW1lbnRbYG9uJHtuYW1lfWBdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHByZWZpeCA9PT0gIm1zIikgewogICAgICAgICAgICAgIG5hbWUgPSAiTVNGdWxsc2NyZWVuRXJyb3IiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIF9uYW1lcy5mdWxsc2NyZWVuZXJyb3IgPSBuYW1lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gX3N1cHBvcnRzRnVsbHNjcmVlbjsKICAgICAgfTsKICAgICAgRnVsbHNjcmVlbi5yZXF1ZXN0RnVsbHNjcmVlbiA9IGZ1bmN0aW9uKGVsZW1lbnQsIHZyRGV2aWNlKSB7CiAgICAgICAgaWYgKCFGdWxsc2NyZWVuLnN1cHBvcnRzRnVsbHNjcmVlbigpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGVsZW1lbnRbX25hbWVzLnJlcXVlc3RGdWxsc2NyZWVuXSh7IHZyRGlzcGxheTogdnJEZXZpY2UgfSk7CiAgICAgIH07CiAgICAgIEZ1bGxzY3JlZW4uZXhpdEZ1bGxzY3JlZW4gPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIUZ1bGxzY3JlZW4uc3VwcG9ydHNGdWxsc2NyZWVuKCkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgZG9jdW1lbnRbX25hbWVzLmV4aXRGdWxsc2NyZWVuXSgpOwogICAgICB9OwogICAgICBGdWxsc2NyZWVuLl9uYW1lcyA9IF9uYW1lczsKICAgICAgRnVsbHNjcmVlbl9kZWZhdWx0ID0gRnVsbHNjcmVlbjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ZlYXR1cmVEZXRlY3Rpb24uanMKICBmdW5jdGlvbiBleHRyYWN0VmVyc2lvbih2ZXJzaW9uU3RyaW5nKSB7CiAgICBjb25zdCBwYXJ0cyA9IHZlcnNpb25TdHJpbmcuc3BsaXQoIi4iKTsKICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBwYXJ0cy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICBwYXJ0c1tpXSA9IHBhcnNlSW50KHBhcnRzW2ldLCAxMCk7CiAgICB9CiAgICByZXR1cm4gcGFydHM7CiAgfQogIGZ1bmN0aW9uIGlzQ2hyb21lKCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaXNDaHJvbWVSZXN1bHQpKSB7CiAgICAgIGlzQ2hyb21lUmVzdWx0ID0gZmFsc2U7CiAgICAgIGlmICghaXNFZGdlKCkpIHsKICAgICAgICBjb25zdCBmaWVsZHMgPSAvIENocm9tZVwvKFtcLjAtOV0rKS8uZXhlYyh0aGVOYXZpZ2F0b3IudXNlckFnZW50KTsKICAgICAgICBpZiAoZmllbGRzICE9PSBudWxsKSB7CiAgICAgICAgICBpc0Nocm9tZVJlc3VsdCA9IHRydWU7CiAgICAgICAgICBjaHJvbWVWZXJzaW9uUmVzdWx0ID0gZXh0cmFjdFZlcnNpb24oZmllbGRzWzFdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpc0Nocm9tZVJlc3VsdDsKICB9CiAgZnVuY3Rpb24gY2hyb21lVmVyc2lvbigpIHsKICAgIHJldHVybiBpc0Nocm9tZSgpICYmIGNocm9tZVZlcnNpb25SZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGlzU2FmYXJpKCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaXNTYWZhcmlSZXN1bHQpKSB7CiAgICAgIGlzU2FmYXJpUmVzdWx0ID0gZmFsc2U7CiAgICAgIGlmICghaXNDaHJvbWUoKSAmJiAhaXNFZGdlKCkgJiYgLyBTYWZhcmlcL1tcLjAtOV0rLy50ZXN0KHRoZU5hdmlnYXRvci51c2VyQWdlbnQpKSB7CiAgICAgICAgY29uc3QgZmllbGRzID0gLyBWZXJzaW9uXC8oW1wuMC05XSspLy5leGVjKHRoZU5hdmlnYXRvci51c2VyQWdlbnQpOwogICAgICAgIGlmIChmaWVsZHMgIT09IG51bGwpIHsKICAgICAgICAgIGlzU2FmYXJpUmVzdWx0ID0gdHJ1ZTsKICAgICAgICAgIHNhZmFyaVZlcnNpb25SZXN1bHQgPSBleHRyYWN0VmVyc2lvbihmaWVsZHNbMV0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGlzU2FmYXJpUmVzdWx0OwogIH0KICBmdW5jdGlvbiBzYWZhcmlWZXJzaW9uKCkgewogICAgcmV0dXJuIGlzU2FmYXJpKCkgJiYgc2FmYXJpVmVyc2lvblJlc3VsdDsKICB9CiAgZnVuY3Rpb24gaXNXZWJraXQoKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpc1dlYmtpdFJlc3VsdCkpIHsKICAgICAgaXNXZWJraXRSZXN1bHQgPSBmYWxzZTsKICAgICAgY29uc3QgZmllbGRzID0gLyBBcHBsZVdlYktpdFwvKFtcLjAtOV0rKShcKz8pLy5leGVjKHRoZU5hdmlnYXRvci51c2VyQWdlbnQpOwogICAgICBpZiAoZmllbGRzICE9PSBudWxsKSB7CiAgICAgICAgaXNXZWJraXRSZXN1bHQgPSB0cnVlOwogICAgICAgIHdlYmtpdFZlcnNpb25SZXN1bHQgPSBleHRyYWN0VmVyc2lvbihmaWVsZHNbMV0pOwogICAgICAgIHdlYmtpdFZlcnNpb25SZXN1bHQuaXNOaWdodGx5ID0gISFmaWVsZHNbMl07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpc1dlYmtpdFJlc3VsdDsKICB9CiAgZnVuY3Rpb24gd2Via2l0VmVyc2lvbigpIHsKICAgIHJldHVybiBpc1dlYmtpdCgpICYmIHdlYmtpdFZlcnNpb25SZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGlzSW50ZXJuZXRFeHBsb3JlcigpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlzSW50ZXJuZXRFeHBsb3JlclJlc3VsdCkpIHsKICAgICAgaXNJbnRlcm5ldEV4cGxvcmVyUmVzdWx0ID0gZmFsc2U7CiAgICAgIGxldCBmaWVsZHM7CiAgICAgIGlmICh0aGVOYXZpZ2F0b3IuYXBwTmFtZSA9PT0gIk1pY3Jvc29mdCBJbnRlcm5ldCBFeHBsb3JlciIpIHsKICAgICAgICBmaWVsZHMgPSAvTVNJRSAoWzAtOV17MSx9W1wuMC05XXswLH0pLy5leGVjKHRoZU5hdmlnYXRvci51c2VyQWdlbnQpOwogICAgICAgIGlmIChmaWVsZHMgIT09IG51bGwpIHsKICAgICAgICAgIGlzSW50ZXJuZXRFeHBsb3JlclJlc3VsdCA9IHRydWU7CiAgICAgICAgICBpbnRlcm5ldEV4cGxvcmVyVmVyc2lvblJlc3VsdCA9IGV4dHJhY3RWZXJzaW9uKGZpZWxkc1sxXSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHRoZU5hdmlnYXRvci5hcHBOYW1lID09PSAiTmV0c2NhcGUiKSB7CiAgICAgICAgZmllbGRzID0gL1RyaWRlbnRcLy4qcnY6KFswLTldezEsfVtcLjAtOV17MCx9KS8uZXhlYygKICAgICAgICAgIHRoZU5hdmlnYXRvci51c2VyQWdlbnQKICAgICAgICApOwogICAgICAgIGlmIChmaWVsZHMgIT09IG51bGwpIHsKICAgICAgICAgIGlzSW50ZXJuZXRFeHBsb3JlclJlc3VsdCA9IHRydWU7CiAgICAgICAgICBpbnRlcm5ldEV4cGxvcmVyVmVyc2lvblJlc3VsdCA9IGV4dHJhY3RWZXJzaW9uKGZpZWxkc1sxXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gaXNJbnRlcm5ldEV4cGxvcmVyUmVzdWx0OwogIH0KICBmdW5jdGlvbiBpbnRlcm5ldEV4cGxvcmVyVmVyc2lvbigpIHsKICAgIHJldHVybiBpc0ludGVybmV0RXhwbG9yZXIoKSAmJiBpbnRlcm5ldEV4cGxvcmVyVmVyc2lvblJlc3VsdDsKICB9CiAgZnVuY3Rpb24gaXNFZGdlKCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaXNFZGdlUmVzdWx0KSkgewogICAgICBpc0VkZ2VSZXN1bHQgPSBmYWxzZTsKICAgICAgY29uc3QgZmllbGRzID0gLyBFZGdcLyhbXC4wLTldKykvLmV4ZWModGhlTmF2aWdhdG9yLnVzZXJBZ2VudCk7CiAgICAgIGlmIChmaWVsZHMgIT09IG51bGwpIHsKICAgICAgICBpc0VkZ2VSZXN1bHQgPSB0cnVlOwogICAgICAgIGVkZ2VWZXJzaW9uUmVzdWx0ID0gZXh0cmFjdFZlcnNpb24oZmllbGRzWzFdKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGlzRWRnZVJlc3VsdDsKICB9CiAgZnVuY3Rpb24gZWRnZVZlcnNpb24oKSB7CiAgICByZXR1cm4gaXNFZGdlKCkgJiYgZWRnZVZlcnNpb25SZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGlzRmlyZWZveCgpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlzRmlyZWZveFJlc3VsdCkpIHsKICAgICAgaXNGaXJlZm94UmVzdWx0ID0gZmFsc2U7CiAgICAgIGNvbnN0IGZpZWxkcyA9IC9GaXJlZm94XC8oW1wuMC05XSspLy5leGVjKHRoZU5hdmlnYXRvci51c2VyQWdlbnQpOwogICAgICBpZiAoZmllbGRzICE9PSBudWxsKSB7CiAgICAgICAgaXNGaXJlZm94UmVzdWx0ID0gdHJ1ZTsKICAgICAgICBmaXJlZm94VmVyc2lvblJlc3VsdCA9IGV4dHJhY3RWZXJzaW9uKGZpZWxkc1sxXSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpc0ZpcmVmb3hSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGlzV2luZG93cygpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlzV2luZG93c1Jlc3VsdCkpIHsKICAgICAgaXNXaW5kb3dzUmVzdWx0ID0gL1dpbmRvd3MvaS50ZXN0KHRoZU5hdmlnYXRvci5hcHBWZXJzaW9uKTsKICAgIH0KICAgIHJldHVybiBpc1dpbmRvd3NSZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGlzSVBhZE9ySU9TKCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaXNJUGFkT3JJT1NSZXN1bHQpKSB7CiAgICAgIGlzSVBhZE9ySU9TUmVzdWx0ID0gbmF2aWdhdG9yLnBsYXRmb3JtID09PSAiaVBob25lIiB8fCBuYXZpZ2F0b3IucGxhdGZvcm0gPT09ICJpUG9kIiB8fCBuYXZpZ2F0b3IucGxhdGZvcm0gPT09ICJpUGFkIjsKICAgIH0KICAgIHJldHVybiBpc0lQYWRPcklPU1Jlc3VsdDsKICB9CiAgZnVuY3Rpb24gZmlyZWZveFZlcnNpb24oKSB7CiAgICByZXR1cm4gaXNGaXJlZm94KCkgJiYgZmlyZWZveFZlcnNpb25SZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIHN1cHBvcnRzUG9pbnRlckV2ZW50cygpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhhc1BvaW50ZXJFdmVudHMpKSB7CiAgICAgIGhhc1BvaW50ZXJFdmVudHMgPSAhaXNGaXJlZm94KCkgJiYgdHlwZW9mIFBvaW50ZXJFdmVudCAhPT0gInVuZGVmaW5lZCIgJiYgKCFkZWZpbmVkX2RlZmF1bHQodGhlTmF2aWdhdG9yLnBvaW50ZXJFbmFibGVkKSB8fCB0aGVOYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQpOwogICAgfQogICAgcmV0dXJuIGhhc1BvaW50ZXJFdmVudHM7CiAgfQogIGZ1bmN0aW9uIHN1cHBvcnRzSW1hZ2VSZW5kZXJpbmdQaXhlbGF0ZWQoKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzdXBwb3J0c0ltYWdlUmVuZGVyaW5nUGl4ZWxhdGVkUmVzdWx0KSkgewogICAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgY2FudmFzLnNldEF0dHJpYnV0ZSgKICAgICAgICAic3R5bGUiLAogICAgICAgICJpbWFnZS1yZW5kZXJpbmc6IC1tb3otY3Jpc3AtZWRnZXM7aW1hZ2UtcmVuZGVyaW5nOiBwaXhlbGF0ZWQ7IgogICAgICApOwogICAgICBjb25zdCB0bXAyID0gY2FudmFzLnN0eWxlLmltYWdlUmVuZGVyaW5nOwogICAgICBzdXBwb3J0c0ltYWdlUmVuZGVyaW5nUGl4ZWxhdGVkUmVzdWx0ID0gZGVmaW5lZF9kZWZhdWx0KHRtcDIpICYmIHRtcDIgIT09ICIiOwogICAgICBpZiAoc3VwcG9ydHNJbWFnZVJlbmRlcmluZ1BpeGVsYXRlZFJlc3VsdCkgewogICAgICAgIGltYWdlUmVuZGVyaW5nVmFsdWVSZXN1bHQgPSB0bXAyOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gc3VwcG9ydHNJbWFnZVJlbmRlcmluZ1BpeGVsYXRlZFJlc3VsdDsKICB9CiAgZnVuY3Rpb24gaW1hZ2VSZW5kZXJpbmdWYWx1ZSgpIHsKICAgIHJldHVybiBzdXBwb3J0c0ltYWdlUmVuZGVyaW5nUGl4ZWxhdGVkKCkgPyBpbWFnZVJlbmRlcmluZ1ZhbHVlUmVzdWx0IDogdm9pZCAwOwogIH0KICBmdW5jdGlvbiBzdXBwb3J0c1dlYlAoKSB7CiAgICBpZiAoIXN1cHBvcnRzV2ViUC5pbml0aWFsaXplZCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAiWW91IG11c3QgY2FsbCBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzV2ViUC5pbml0aWFsaXplIGFuZCB3YWl0IGZvciB0aGUgcHJvbWlzZSB0byByZXNvbHZlIGJlZm9yZSBjYWxsaW5nIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNXZWJQIgogICAgICApOwogICAgfQogICAgcmV0dXJuIHN1cHBvcnRzV2ViUC5fcmVzdWx0OwogIH0KICB2YXIgdGhlTmF2aWdhdG9yLCBpc0Nocm9tZVJlc3VsdCwgY2hyb21lVmVyc2lvblJlc3VsdCwgaXNTYWZhcmlSZXN1bHQsIHNhZmFyaVZlcnNpb25SZXN1bHQsIGlzV2Via2l0UmVzdWx0LCB3ZWJraXRWZXJzaW9uUmVzdWx0LCBpc0ludGVybmV0RXhwbG9yZXJSZXN1bHQsIGludGVybmV0RXhwbG9yZXJWZXJzaW9uUmVzdWx0LCBpc0VkZ2VSZXN1bHQsIGVkZ2VWZXJzaW9uUmVzdWx0LCBpc0ZpcmVmb3hSZXN1bHQsIGZpcmVmb3hWZXJzaW9uUmVzdWx0LCBpc1dpbmRvd3NSZXN1bHQsIGlzSVBhZE9ySU9TUmVzdWx0LCBoYXNQb2ludGVyRXZlbnRzLCBpbWFnZVJlbmRlcmluZ1ZhbHVlUmVzdWx0LCBzdXBwb3J0c0ltYWdlUmVuZGVyaW5nUGl4ZWxhdGVkUmVzdWx0LCB0eXBlZEFycmF5VHlwZXMsIEZlYXR1cmVEZXRlY3Rpb24sIEZlYXR1cmVEZXRlY3Rpb25fZGVmYXVsdDsKICB2YXIgaW5pdF9GZWF0dXJlRGV0ZWN0aW9uID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9GZWF0dXJlRGV0ZWN0aW9uLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0Z1bGxzY3JlZW4oKTsKICAgICAgaWYgKHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgdGhlTmF2aWdhdG9yID0gbmF2aWdhdG9yOwogICAgICB9IGVsc2UgewogICAgICAgIHRoZU5hdmlnYXRvciA9IHt9OwogICAgICB9CiAgICAgIHN1cHBvcnRzV2ViUC5fcHJvbWlzZSA9IHZvaWQgMDsKICAgICAgc3VwcG9ydHNXZWJQLl9yZXN1bHQgPSB2b2lkIDA7CiAgICAgIHN1cHBvcnRzV2ViUC5pbml0aWFsaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChzdXBwb3J0c1dlYlAuX3Byb21pc2UpKSB7CiAgICAgICAgICByZXR1cm4gc3VwcG9ydHNXZWJQLl9wcm9taXNlOwogICAgICAgIH0KICAgICAgICBzdXBwb3J0c1dlYlAuX3Byb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgY29uc3QgaW1hZ2UgPSBuZXcgSW1hZ2UoKTsKICAgICAgICAgIGltYWdlLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzdXBwb3J0c1dlYlAuX3Jlc3VsdCA9IGltYWdlLndpZHRoID4gMCAmJiBpbWFnZS5oZWlnaHQgPiAwOwogICAgICAgICAgICByZXNvbHZlKHN1cHBvcnRzV2ViUC5fcmVzdWx0KTsKICAgICAgICAgIH07CiAgICAgICAgICBpbWFnZS5vbmVycm9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHN1cHBvcnRzV2ViUC5fcmVzdWx0ID0gZmFsc2U7CiAgICAgICAgICAgIHJlc29sdmUoc3VwcG9ydHNXZWJQLl9yZXN1bHQpOwogICAgICAgICAgfTsKICAgICAgICAgIGltYWdlLnNyYyA9ICJkYXRhOmltYWdlL3dlYnA7YmFzZTY0LFVrbEdSaUlBQUFCWFJVSlFWbEE0SUJZQUFBQXdBUUNkQVNvQkFBRUFEc0QrSmFRQUEzQUFBQUFBIjsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gc3VwcG9ydHNXZWJQLl9wcm9taXNlOwogICAgICB9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhzdXBwb3J0c1dlYlAsIHsKICAgICAgICBpbml0aWFsaXplZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmluZWRfZGVmYXVsdChzdXBwb3J0c1dlYlAuX3Jlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdHlwZWRBcnJheVR5cGVzID0gW107CiAgICAgIGlmICh0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgdHlwZWRBcnJheVR5cGVzLnB1c2goCiAgICAgICAgICBJbnQ4QXJyYXksCiAgICAgICAgICBVaW50OEFycmF5LAogICAgICAgICAgSW50MTZBcnJheSwKICAgICAgICAgIFVpbnQxNkFycmF5LAogICAgICAgICAgSW50MzJBcnJheSwKICAgICAgICAgIFVpbnQzMkFycmF5LAogICAgICAgICAgRmxvYXQzMkFycmF5LAogICAgICAgICAgRmxvYXQ2NEFycmF5CiAgICAgICAgKTsKICAgICAgICBpZiAodHlwZW9mIFVpbnQ4Q2xhbXBlZEFycmF5ICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgdHlwZWRBcnJheVR5cGVzLnB1c2goVWludDhDbGFtcGVkQXJyYXkpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIFVpbnQ4Q2xhbXBlZEFycmF5ICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgdHlwZWRBcnJheVR5cGVzLnB1c2goVWludDhDbGFtcGVkQXJyYXkpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIEJpZ0ludDY0QXJyYXkgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICB0eXBlZEFycmF5VHlwZXMucHVzaChCaWdJbnQ2NEFycmF5KTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBCaWdVaW50NjRBcnJheSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHR5cGVkQXJyYXlUeXBlcy5wdXNoKEJpZ1VpbnQ2NEFycmF5KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgRmVhdHVyZURldGVjdGlvbiA9IHsKICAgICAgICBpc0Nocm9tZSwKICAgICAgICBjaHJvbWVWZXJzaW9uLAogICAgICAgIGlzU2FmYXJpLAogICAgICAgIHNhZmFyaVZlcnNpb24sCiAgICAgICAgaXNXZWJraXQsCiAgICAgICAgd2Via2l0VmVyc2lvbiwKICAgICAgICBpc0ludGVybmV0RXhwbG9yZXIsCiAgICAgICAgaW50ZXJuZXRFeHBsb3JlclZlcnNpb24sCiAgICAgICAgaXNFZGdlLAogICAgICAgIGVkZ2VWZXJzaW9uLAogICAgICAgIGlzRmlyZWZveCwKICAgICAgICBmaXJlZm94VmVyc2lvbiwKICAgICAgICBpc1dpbmRvd3MsCiAgICAgICAgaXNJUGFkT3JJT1MsCiAgICAgICAgaGFyZHdhcmVDb25jdXJyZW5jeTogZGVmYXVsdFZhbHVlX2RlZmF1bHQodGhlTmF2aWdhdG9yLmhhcmR3YXJlQ29uY3VycmVuY3ksIDMpLAogICAgICAgIHN1cHBvcnRzUG9pbnRlckV2ZW50cywKICAgICAgICBzdXBwb3J0c0ltYWdlUmVuZGVyaW5nUGl4ZWxhdGVkLAogICAgICAgIHN1cHBvcnRzV2ViUCwKICAgICAgICBpbWFnZVJlbmRlcmluZ1ZhbHVlLAogICAgICAgIHR5cGVkQXJyYXlUeXBlcwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzQmFzaXMgPSBmdW5jdGlvbihzY2VuZSkgewogICAgICAgIHJldHVybiBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzV2ViQXNzZW1ibHkoKSAmJiBzY2VuZS5jb250ZXh0LnN1cHBvcnRzQmFzaXM7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNGdWxsc2NyZWVuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIEZ1bGxzY3JlZW5fZGVmYXVsdC5zdXBwb3J0c0Z1bGxzY3JlZW4oKTsKICAgICAgfTsKICAgICAgRmVhdHVyZURldGVjdGlvbi5zdXBwb3J0c1R5cGVkQXJyYXlzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gInVuZGVmaW5lZCI7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNCaWdJbnQ2NEFycmF5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBCaWdJbnQ2NEFycmF5ICE9PSAidW5kZWZpbmVkIjsKICAgICAgfTsKICAgICAgRmVhdHVyZURldGVjdGlvbi5zdXBwb3J0c0JpZ1VpbnQ2NEFycmF5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBCaWdVaW50NjRBcnJheSAhPT0gInVuZGVmaW5lZCI7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNCaWdJbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIEJpZ0ludCAhPT0gInVuZGVmaW5lZCI7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNXZWJXb3JrZXJzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiBXb3JrZXIgIT09ICJ1bmRlZmluZWQiOwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uLnN1cHBvcnRzV2ViQXNzZW1ibHkgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIFdlYkFzc2VtYmx5ICE9PSAidW5kZWZpbmVkIjsKICAgICAgfTsKICAgICAgRmVhdHVyZURldGVjdGlvbi5zdXBwb3J0c1dlYmdsMiA9IGZ1bmN0aW9uKHNjZW5lKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJzY2VuZSIsIHNjZW5lKTsKICAgICAgICByZXR1cm4gc2NlbmUuY29udGV4dC53ZWJnbDI7CiAgICAgIH07CiAgICAgIEZlYXR1cmVEZXRlY3Rpb24uc3VwcG9ydHNFc21XZWJXb3JrZXJzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICFpc0ZpcmVmb3goKSB8fCBwYXJzZUludChmaXJlZm94VmVyc2lvblJlc3VsdCkgPj0gMTE0OwogICAgICB9OwogICAgICBGZWF0dXJlRGV0ZWN0aW9uX2RlZmF1bHQgPSBGZWF0dXJlRGV0ZWN0aW9uOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUXVhdGVybmlvbi5qcwogIGZ1bmN0aW9uIFF1YXRlcm5pb24oeCwgeSwgeiwgdykgewogICAgdGhpcy54ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeCwgMCk7CiAgICB0aGlzLnkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh5LCAwKTsKICAgIHRoaXMueiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogICAgdGhpcy53ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodywgMCk7CiAgfQogIHZhciBmcm9tQXhpc0FuZ2xlU2NyYXRjaCwgZnJvbVJvdGF0aW9uTWF0cml4TmV4dCwgZnJvbVJvdGF0aW9uTWF0cml4UXVhdCwgc2NyYXRjaEhQUlF1YXRlcm5pb24sIHNjcmF0Y2hIZWFkaW5nUXVhdGVybmlvbiwgc2NyYXRjaFBpdGNoUXVhdGVybmlvbiwgc2NyYXRjaFJvbGxRdWF0ZXJuaW9uLCBzYW1wbGVkUXVhdGVybmlvbkF4aXMsIHNhbXBsZWRRdWF0ZXJuaW9uUm90YXRpb24sIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24sIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjAsIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjBDb25qdWdhdGUsIGxlcnBTY3JhdGNoNCwgc2xlcnBFbmROZWdhdGVkLCBzbGVycFNjYWxlZFAsIHNsZXJwU2NhbGVkUiwgc3F1YWRTY3JhdGNoQ2FydGVzaWFuMCwgc3F1YWRTY3JhdGNoQ2FydGVzaWFuMSwgc3F1YWRTY3JhdGNoUXVhdGVybmlvbjAsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24xLCBmYXN0U2xlcnBTY3JhdGNoUXVhdGVybmlvbiwgb3BtdSwgdSwgdiwgYlQsIGJELCBRdWF0ZXJuaW9uX2RlZmF1bHQ7CiAgdmFyIGluaXRfUXVhdGVybmlvbiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUXVhdGVybmlvbi5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0ZlYXR1cmVEZXRlY3Rpb24oKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBmcm9tQXhpc0FuZ2xlU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUXVhdGVybmlvbi5mcm9tQXhpc0FuZ2xlID0gZnVuY3Rpb24oYXhpcywgYW5nbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiYXhpcyIsIGF4aXMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiYW5nbGUiLCBhbmdsZSk7CiAgICAgICAgY29uc3QgaGFsZkFuZ2xlID0gYW5nbGUgLyAyOwogICAgICAgIGNvbnN0IHMgPSBNYXRoLnNpbihoYWxmQW5nbGUpOwogICAgICAgIGZyb21BeGlzQW5nbGVTY3JhdGNoID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShheGlzLCBmcm9tQXhpc0FuZ2xlU2NyYXRjaCk7CiAgICAgICAgY29uc3QgeCA9IGZyb21BeGlzQW5nbGVTY3JhdGNoLnggKiBzOwogICAgICAgIGNvbnN0IHkgPSBmcm9tQXhpc0FuZ2xlU2NyYXRjaC55ICogczsKICAgICAgICBjb25zdCB6ID0gZnJvbUF4aXNBbmdsZVNjcmF0Y2gueiAqIHM7CiAgICAgICAgY29uc3QgdyA9IE1hdGguY29zKGhhbGZBbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBRdWF0ZXJuaW9uKHgsIHksIHosIHcpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgZnJvbVJvdGF0aW9uTWF0cml4TmV4dCA9IFsxLCAyLCAwXTsKICAgICAgZnJvbVJvdGF0aW9uTWF0cml4UXVhdCA9IG5ldyBBcnJheSgzKTsKICAgICAgUXVhdGVybmlvbi5mcm9tUm90YXRpb25NYXRyaXggPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBsZXQgcm9vdDsKICAgICAgICBsZXQgeDsKICAgICAgICBsZXQgeTsKICAgICAgICBsZXQgejsKICAgICAgICBsZXQgdzsKICAgICAgICBjb25zdCBtMDAgPSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LkNPTFVNTjBST1cwXTsKICAgICAgICBjb25zdCBtMTEgPSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LkNPTFVNTjFST1cxXTsKICAgICAgICBjb25zdCBtMjIgPSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cyXTsKICAgICAgICBjb25zdCB0cmFjZSA9IG0wMCArIG0xMSArIG0yMjsKICAgICAgICBpZiAodHJhY2UgPiAwKSB7CiAgICAgICAgICByb290ID0gTWF0aC5zcXJ0KHRyYWNlICsgMSk7CiAgICAgICAgICB3ID0gMC41ICogcm9vdDsKICAgICAgICAgIHJvb3QgPSAwLjUgLyByb290OwogICAgICAgICAgeCA9IChtYXRyaXhbTWF0cml4M19kZWZhdWx0LkNPTFVNTjFST1cyXSAtIG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMlJPVzFdKSAqIHJvb3Q7CiAgICAgICAgICB5ID0gKG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMlJPVzBdIC0gbWF0cml4W01hdHJpeDNfZGVmYXVsdC5DT0xVTU4wUk9XMl0pICogcm9vdDsKICAgICAgICAgIHogPSAobWF0cml4W01hdHJpeDNfZGVmYXVsdC5DT0xVTU4wUk9XMV0gLSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LkNPTFVNTjFST1cwXSkgKiByb290OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBuZXh0ID0gZnJvbVJvdGF0aW9uTWF0cml4TmV4dDsKICAgICAgICAgIGxldCBpID0gMDsKICAgICAgICAgIGlmIChtMTEgPiBtMDApIHsKICAgICAgICAgICAgaSA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobTIyID4gbTAwICYmIG0yMiA+IG0xMSkgewogICAgICAgICAgICBpID0gMjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGogPSBuZXh0W2ldOwogICAgICAgICAgY29uc3QgayA9IG5leHRbal07CiAgICAgICAgICByb290ID0gTWF0aC5zcXJ0KAogICAgICAgICAgICBtYXRyaXhbTWF0cml4M19kZWZhdWx0LmdldEVsZW1lbnRJbmRleChpLCBpKV0gLSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LmdldEVsZW1lbnRJbmRleChqLCBqKV0gLSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LmdldEVsZW1lbnRJbmRleChrLCBrKV0gKyAxCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcXVhdCA9IGZyb21Sb3RhdGlvbk1hdHJpeFF1YXQ7CiAgICAgICAgICBxdWF0W2ldID0gMC41ICogcm9vdDsKICAgICAgICAgIHJvb3QgPSAwLjUgLyByb290OwogICAgICAgICAgdyA9IChtYXRyaXhbTWF0cml4M19kZWZhdWx0LmdldEVsZW1lbnRJbmRleChrLCBqKV0gLSBtYXRyaXhbTWF0cml4M19kZWZhdWx0LmdldEVsZW1lbnRJbmRleChqLCBrKV0pICogcm9vdDsKICAgICAgICAgIHF1YXRbal0gPSAobWF0cml4W01hdHJpeDNfZGVmYXVsdC5nZXRFbGVtZW50SW5kZXgoaiwgaSldICsgbWF0cml4W01hdHJpeDNfZGVmYXVsdC5nZXRFbGVtZW50SW5kZXgoaSwgaildKSAqIHJvb3Q7CiAgICAgICAgICBxdWF0W2tdID0gKG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuZ2V0RWxlbWVudEluZGV4KGssIGkpXSArIG1hdHJpeFtNYXRyaXgzX2RlZmF1bHQuZ2V0RWxlbWVudEluZGV4KGksIGspXSkgKiByb290OwogICAgICAgICAgeCA9IC1xdWF0WzBdOwogICAgICAgICAgeSA9IC1xdWF0WzFdOwogICAgICAgICAgeiA9IC1xdWF0WzJdOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFF1YXRlcm5pb24oeCwgeSwgeiwgdyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJlc3VsdC53ID0gdzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoSFBSUXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIHNjcmF0Y2hIZWFkaW5nUXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIHNjcmF0Y2hQaXRjaFF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBzY3JhdGNoUm9sbFF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBRdWF0ZXJuaW9uLmZyb21IZWFkaW5nUGl0Y2hSb2xsID0gZnVuY3Rpb24oaGVhZGluZ1BpdGNoUm9sbCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJoZWFkaW5nUGl0Y2hSb2xsIiwgaGVhZGluZ1BpdGNoUm9sbCk7CiAgICAgICAgc2NyYXRjaFJvbGxRdWF0ZXJuaW9uID0gUXVhdGVybmlvbi5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWCwKICAgICAgICAgIGhlYWRpbmdQaXRjaFJvbGwucm9sbCwKICAgICAgICAgIHNjcmF0Y2hIUFJRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoUGl0Y2hRdWF0ZXJuaW9uID0gUXVhdGVybmlvbi5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWSwKICAgICAgICAgIC1oZWFkaW5nUGl0Y2hSb2xsLnBpdGNoLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgICByZXN1bHQgPSBRdWF0ZXJuaW9uLm11bHRpcGx5KAogICAgICAgICAgc2NyYXRjaFBpdGNoUXVhdGVybmlvbiwKICAgICAgICAgIHNjcmF0Y2hSb2xsUXVhdGVybmlvbiwKICAgICAgICAgIHNjcmF0Y2hQaXRjaFF1YXRlcm5pb24KICAgICAgICApOwogICAgICAgIHNjcmF0Y2hIZWFkaW5nUXVhdGVybmlvbiA9IFF1YXRlcm5pb24uZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osCiAgICAgICAgICAtaGVhZGluZ1BpdGNoUm9sbC5oZWFkaW5nLAogICAgICAgICAgc2NyYXRjaEhQUlF1YXRlcm5pb24KICAgICAgICApOwogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLm11bHRpcGx5KHNjcmF0Y2hIZWFkaW5nUXVhdGVybmlvbiwgcmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBzYW1wbGVkUXVhdGVybmlvbkF4aXMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uUm90YXRpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBzYW1wbGVkUXVhdGVybmlvblF1YXRlcm5pb24wID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgc2FtcGxlZFF1YXRlcm5pb25RdWF0ZXJuaW9uMENvbmp1Z2F0ZSA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIFF1YXRlcm5pb24ucGFja2VkTGVuZ3RoID0gNDsKICAgICAgUXVhdGVybmlvbi5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuejsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLnc7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIHJlc3VsdC55ID0gYXJyYXlbc3RhcnRpbmdJbmRleCArIDFdOwogICAgICAgIHJlc3VsdC56ID0gYXJyYXlbc3RhcnRpbmdJbmRleCArIDJdOwogICAgICAgIHJlc3VsdC53ID0gYXJyYXlbc3RhcnRpbmdJbmRleCArIDNdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ucGFja2VkSW50ZXJwb2xhdGlvbkxlbmd0aCA9IDM7CiAgICAgIFF1YXRlcm5pb24uY29udmVydFBhY2tlZEFycmF5Rm9ySW50ZXJwb2xhdGlvbiA9IGZ1bmN0aW9uKHBhY2tlZEFycmF5LCBzdGFydGluZ0luZGV4LCBsYXN0SW5kZXgsIHJlc3VsdCkgewogICAgICAgIFF1YXRlcm5pb24udW5wYWNrKAogICAgICAgICAgcGFja2VkQXJyYXksCiAgICAgICAgICBsYXN0SW5kZXggKiA0LAogICAgICAgICAgc2FtcGxlZFF1YXRlcm5pb25RdWF0ZXJuaW9uMENvbmp1Z2F0ZQogICAgICAgICk7CiAgICAgICAgUXVhdGVybmlvbi5jb25qdWdhdGUoCiAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblF1YXRlcm5pb24wQ29uanVnYXRlLAogICAgICAgICAgc2FtcGxlZFF1YXRlcm5pb25RdWF0ZXJuaW9uMENvbmp1Z2F0ZQogICAgICAgICk7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IGxhc3RJbmRleCAtIHN0YXJ0aW5nSW5kZXggKyAxOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGkgKiAzOwogICAgICAgICAgUXVhdGVybmlvbi51bnBhY2soCiAgICAgICAgICAgIHBhY2tlZEFycmF5LAogICAgICAgICAgICAoc3RhcnRpbmdJbmRleCArIGkpICogNCwKICAgICAgICAgICAgc2FtcGxlZFF1YXRlcm5pb25UZW1wUXVhdGVybmlvbgogICAgICAgICAgKTsKICAgICAgICAgIFF1YXRlcm5pb24ubXVsdGlwbHkoCiAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24sCiAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjBDb25qdWdhdGUsCiAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24KICAgICAgICAgICk7CiAgICAgICAgICBpZiAoc2FtcGxlZFF1YXRlcm5pb25UZW1wUXVhdGVybmlvbi53IDwgMCkgewogICAgICAgICAgICBRdWF0ZXJuaW9uLm5lZ2F0ZSgKICAgICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uLAogICAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24KICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIFF1YXRlcm5pb24uY29tcHV0ZUF4aXMoCiAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24sCiAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uQXhpcwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IGFuZ2xlID0gUXVhdGVybmlvbi5jb21wdXRlQW5nbGUoc2FtcGxlZFF1YXRlcm5pb25UZW1wUXVhdGVybmlvbik7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0W29mZnNldF0gPSBzYW1wbGVkUXVhdGVybmlvbkF4aXMueCAqIGFuZ2xlOwogICAgICAgICAgcmVzdWx0W29mZnNldCArIDFdID0gc2FtcGxlZFF1YXRlcm5pb25BeGlzLnkgKiBhbmdsZTsKICAgICAgICAgIHJlc3VsdFtvZmZzZXQgKyAyXSA9IHNhbXBsZWRRdWF0ZXJuaW9uQXhpcy56ICogYW5nbGU7CiAgICAgICAgfQogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLnVucGFja0ludGVycG9sYXRpb25SZXN1bHQgPSBmdW5jdGlvbihhcnJheSwgc291cmNlQXJyYXksIGZpcnN0SW5kZXgsIGxhc3RJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShhcnJheSwgMCwgc2FtcGxlZFF1YXRlcm5pb25Sb3RhdGlvbik7CiAgICAgICAgY29uc3QgbWFnbml0dWRlID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShzYW1wbGVkUXVhdGVybmlvblJvdGF0aW9uKTsKICAgICAgICBRdWF0ZXJuaW9uLnVucGFjayhzb3VyY2VBcnJheSwgbGFzdEluZGV4ICogNCwgc2FtcGxlZFF1YXRlcm5pb25RdWF0ZXJuaW9uMCk7CiAgICAgICAgaWYgKG1hZ25pdHVkZSA9PT0gMCkgewogICAgICAgICAgUXVhdGVybmlvbi5jbG9uZShRdWF0ZXJuaW9uLklERU5USVRZLCBzYW1wbGVkUXVhdGVybmlvblRlbXBRdWF0ZXJuaW9uKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgUXVhdGVybmlvbi5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgICBzYW1wbGVkUXVhdGVybmlvblJvdGF0aW9uLAogICAgICAgICAgICBtYWduaXR1ZGUsCiAgICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uVGVtcFF1YXRlcm5pb24KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLm11bHRpcGx5KAogICAgICAgICAgc2FtcGxlZFF1YXRlcm5pb25UZW1wUXVhdGVybmlvbiwKICAgICAgICAgIHNhbXBsZWRRdWF0ZXJuaW9uUXVhdGVybmlvbjAsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmNsb25lID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocXVhdGVybmlvbikpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUXVhdGVybmlvbigKICAgICAgICAgICAgcXVhdGVybmlvbi54LAogICAgICAgICAgICBxdWF0ZXJuaW9uLnksCiAgICAgICAgICAgIHF1YXRlcm5pb24ueiwKICAgICAgICAgICAgcXVhdGVybmlvbi53CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IHF1YXRlcm5pb24ueDsKICAgICAgICByZXN1bHQueSA9IHF1YXRlcm5pb24ueTsKICAgICAgICByZXN1bHQueiA9IHF1YXRlcm5pb24uejsKICAgICAgICByZXN1bHQudyA9IHF1YXRlcm5pb24udzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmNvbmp1Z2F0ZSA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicXVhdGVybmlvbiIsIHF1YXRlcm5pb24pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQueCA9IC1xdWF0ZXJuaW9uLng7CiAgICAgICAgcmVzdWx0LnkgPSAtcXVhdGVybmlvbi55OwogICAgICAgIHJlc3VsdC56ID0gLXF1YXRlcm5pb24uejsKICAgICAgICByZXN1bHQudyA9IHF1YXRlcm5pb24udzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLm1hZ25pdHVkZVNxdWFyZWQgPSBmdW5jdGlvbihxdWF0ZXJuaW9uKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxdWF0ZXJuaW9uIiwgcXVhdGVybmlvbik7CiAgICAgICAgcmV0dXJuIHF1YXRlcm5pb24ueCAqIHF1YXRlcm5pb24ueCArIHF1YXRlcm5pb24ueSAqIHF1YXRlcm5pb24ueSArIHF1YXRlcm5pb24ueiAqIHF1YXRlcm5pb24ueiArIHF1YXRlcm5pb24udyAqIHF1YXRlcm5pb24udzsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5tYWduaXR1ZGUgPSBmdW5jdGlvbihxdWF0ZXJuaW9uKSB7CiAgICAgICAgcmV0dXJuIE1hdGguc3FydChRdWF0ZXJuaW9uLm1hZ25pdHVkZVNxdWFyZWQocXVhdGVybmlvbikpOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBpbnZlcnNlTWFnbml0dWRlID0gMSAvIFF1YXRlcm5pb24ubWFnbml0dWRlKHF1YXRlcm5pb24pOwogICAgICAgIGNvbnN0IHggPSBxdWF0ZXJuaW9uLnggKiBpbnZlcnNlTWFnbml0dWRlOwogICAgICAgIGNvbnN0IHkgPSBxdWF0ZXJuaW9uLnkgKiBpbnZlcnNlTWFnbml0dWRlOwogICAgICAgIGNvbnN0IHogPSBxdWF0ZXJuaW9uLnogKiBpbnZlcnNlTWFnbml0dWRlOwogICAgICAgIGNvbnN0IHcgPSBxdWF0ZXJuaW9uLncgKiBpbnZlcnNlTWFnbml0dWRlOwogICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICByZXN1bHQueSA9IHk7CiAgICAgICAgcmVzdWx0LnogPSB6OwogICAgICAgIHJlc3VsdC53ID0gdzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmludmVyc2UgPSBmdW5jdGlvbihxdWF0ZXJuaW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgbWFnbml0dWRlU3F1YXJlZCA9IFF1YXRlcm5pb24ubWFnbml0dWRlU3F1YXJlZChxdWF0ZXJuaW9uKTsKICAgICAgICByZXN1bHQgPSBRdWF0ZXJuaW9uLmNvbmp1Z2F0ZShxdWF0ZXJuaW9uLCByZXN1bHQpOwogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLm11bHRpcGx5QnlTY2FsYXIocmVzdWx0LCAxIC8gbWFnbml0dWRlU3F1YXJlZCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5hZGQgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBsZWZ0LnggKyByaWdodC54OwogICAgICAgIHJlc3VsdC55ID0gbGVmdC55ICsgcmlnaHQueTsKICAgICAgICByZXN1bHQueiA9IGxlZnQueiArIHJpZ2h0Lno7CiAgICAgICAgcmVzdWx0LncgPSBsZWZ0LncgKyByaWdodC53OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24uc3VidHJhY3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBsZWZ0LnggLSByaWdodC54OwogICAgICAgIHJlc3VsdC55ID0gbGVmdC55IC0gcmlnaHQueTsKICAgICAgICByZXN1bHQueiA9IGxlZnQueiAtIHJpZ2h0Lno7CiAgICAgICAgcmVzdWx0LncgPSBsZWZ0LncgLSByaWdodC53OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ubmVnYXRlID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxdWF0ZXJuaW9uIiwgcXVhdGVybmlvbik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gLXF1YXRlcm5pb24ueDsKICAgICAgICByZXN1bHQueSA9IC1xdWF0ZXJuaW9uLnk7CiAgICAgICAgcmVzdWx0LnogPSAtcXVhdGVybmlvbi56OwogICAgICAgIHJlc3VsdC53ID0gLXF1YXRlcm5pb24udzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmRvdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICByZXR1cm4gbGVmdC54ICogcmlnaHQueCArIGxlZnQueSAqIHJpZ2h0LnkgKyBsZWZ0LnogKiByaWdodC56ICsgbGVmdC53ICogcmlnaHQudzsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5tdWx0aXBseSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBsZWZ0WCA9IGxlZnQueDsKICAgICAgICBjb25zdCBsZWZ0WSA9IGxlZnQueTsKICAgICAgICBjb25zdCBsZWZ0WiA9IGxlZnQuejsKICAgICAgICBjb25zdCBsZWZ0VyA9IGxlZnQudzsKICAgICAgICBjb25zdCByaWdodFggPSByaWdodC54OwogICAgICAgIGNvbnN0IHJpZ2h0WSA9IHJpZ2h0Lnk7CiAgICAgICAgY29uc3QgcmlnaHRaID0gcmlnaHQuejsKICAgICAgICBjb25zdCByaWdodFcgPSByaWdodC53OwogICAgICAgIGNvbnN0IHggPSBsZWZ0VyAqIHJpZ2h0WCArIGxlZnRYICogcmlnaHRXICsgbGVmdFkgKiByaWdodFogLSBsZWZ0WiAqIHJpZ2h0WTsKICAgICAgICBjb25zdCB5ID0gbGVmdFcgKiByaWdodFkgLSBsZWZ0WCAqIHJpZ2h0WiArIGxlZnRZICogcmlnaHRXICsgbGVmdFogKiByaWdodFg7CiAgICAgICAgY29uc3QgeiA9IGxlZnRXICogcmlnaHRaICsgbGVmdFggKiByaWdodFkgLSBsZWZ0WSAqIHJpZ2h0WCArIGxlZnRaICogcmlnaHRXOwogICAgICAgIGNvbnN0IHcgPSBsZWZ0VyAqIHJpZ2h0VyAtIGxlZnRYICogcmlnaHRYIC0gbGVmdFkgKiByaWdodFkgLSBsZWZ0WiAqIHJpZ2h0WjsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXN1bHQudyA9IHc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyID0gZnVuY3Rpb24ocXVhdGVybmlvbiwgc2NhbGFyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInF1YXRlcm5pb24iLCBxdWF0ZXJuaW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInNjYWxhciIsIHNjYWxhcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gcXVhdGVybmlvbi54ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC55ID0gcXVhdGVybmlvbi55ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC56ID0gcXVhdGVybmlvbi56ICogc2NhbGFyOwogICAgICAgIHJlc3VsdC53ID0gcXVhdGVybmlvbi53ICogc2NhbGFyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24uZGl2aWRlQnlTY2FsYXIgPSBmdW5jdGlvbihxdWF0ZXJuaW9uLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicXVhdGVybmlvbiIsIHF1YXRlcm5pb24pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGFyIiwgc2NhbGFyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnggPSBxdWF0ZXJuaW9uLnggLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnkgPSBxdWF0ZXJuaW9uLnkgLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LnogPSBxdWF0ZXJuaW9uLnogLyBzY2FsYXI7CiAgICAgICAgcmVzdWx0LncgPSBxdWF0ZXJuaW9uLncgLyBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5jb21wdXRlQXhpcyA9IGZ1bmN0aW9uKHF1YXRlcm5pb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicXVhdGVybmlvbiIsIHF1YXRlcm5pb24pOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB3ID0gcXVhdGVybmlvbi53OwogICAgICAgIGlmIChNYXRoLmFicyh3IC0gMSkgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjYgfHwgTWF0aC5hYnModyArIDEpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgICByZXN1bHQueCA9IDE7CiAgICAgICAgICByZXN1bHQueSA9IHJlc3VsdC56ID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNjYWxhciA9IDEgLyBNYXRoLnNxcnQoMSAtIHcgKiB3KTsKICAgICAgICByZXN1bHQueCA9IHF1YXRlcm5pb24ueCAqIHNjYWxhcjsKICAgICAgICByZXN1bHQueSA9IHF1YXRlcm5pb24ueSAqIHNjYWxhcjsKICAgICAgICByZXN1bHQueiA9IHF1YXRlcm5pb24ueiAqIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmNvbXB1dGVBbmdsZSA9IGZ1bmN0aW9uKHF1YXRlcm5pb24pIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInF1YXRlcm5pb24iLCBxdWF0ZXJuaW9uKTsKICAgICAgICBpZiAoTWF0aC5hYnMocXVhdGVybmlvbi53IC0gMSkgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjYpIHsKICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMiAqIE1hdGguYWNvcyhxdWF0ZXJuaW9uLncpOwogICAgICB9OwogICAgICBsZXJwU2NyYXRjaDQgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBRdWF0ZXJuaW9uLmxlcnAgPSBmdW5jdGlvbihzdGFydCwgZW5kLCB0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN0YXJ0Iiwgc3RhcnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZW5kIiwgZW5kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInQiLCB0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgbGVycFNjcmF0Y2g0ID0gUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyKGVuZCwgdCwgbGVycFNjcmF0Y2g0KTsKICAgICAgICByZXN1bHQgPSBRdWF0ZXJuaW9uLm11bHRpcGx5QnlTY2FsYXIoc3RhcnQsIDEgLSB0LCByZXN1bHQpOwogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLmFkZChsZXJwU2NyYXRjaDQsIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2xlcnBFbmROZWdhdGVkID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgc2xlcnBTY2FsZWRQID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgc2xlcnBTY2FsZWRSID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgUXVhdGVybmlvbi5zbGVycCA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3RhcnQiLCBzdGFydCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbmQiLCBlbmQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidCIsIHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBsZXQgZG90ID0gUXVhdGVybmlvbi5kb3Qoc3RhcnQsIGVuZCk7CiAgICAgICAgbGV0IHIgPSBlbmQ7CiAgICAgICAgaWYgKGRvdCA8IDApIHsKICAgICAgICAgIGRvdCA9IC1kb3Q7CiAgICAgICAgICByID0gc2xlcnBFbmROZWdhdGVkID0gUXVhdGVybmlvbi5uZWdhdGUoZW5kLCBzbGVycEVuZE5lZ2F0ZWQpOwogICAgICAgIH0KICAgICAgICBpZiAoMSAtIGRvdCA8IE1hdGhfZGVmYXVsdC5FUFNJTE9ONikgewogICAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24ubGVycChzdGFydCwgciwgdCwgcmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdGhldGEgPSBNYXRoLmFjb3MoZG90KTsKICAgICAgICBzbGVycFNjYWxlZFAgPSBRdWF0ZXJuaW9uLm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICBzdGFydCwKICAgICAgICAgIE1hdGguc2luKCgxIC0gdCkgKiB0aGV0YSksCiAgICAgICAgICBzbGVycFNjYWxlZFAKICAgICAgICApOwogICAgICAgIHNsZXJwU2NhbGVkUiA9IFF1YXRlcm5pb24ubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgIHIsCiAgICAgICAgICBNYXRoLnNpbih0ICogdGhldGEpLAogICAgICAgICAgc2xlcnBTY2FsZWRSCiAgICAgICAgKTsKICAgICAgICByZXN1bHQgPSBRdWF0ZXJuaW9uLmFkZChzbGVycFNjYWxlZFAsIHNsZXJwU2NhbGVkUiwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyKHJlc3VsdCwgMSAvIE1hdGguc2luKHRoZXRhKSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5sb2cgPSBmdW5jdGlvbihxdWF0ZXJuaW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInF1YXRlcm5pb24iLCBxdWF0ZXJuaW9uKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdGhldGEgPSBNYXRoX2RlZmF1bHQuYWNvc0NsYW1wZWQocXVhdGVybmlvbi53KTsKICAgICAgICBsZXQgdGhldGFPdmVyU2luVGhldGEgPSAwOwogICAgICAgIGlmICh0aGV0YSAhPT0gMCkgewogICAgICAgICAgdGhldGFPdmVyU2luVGhldGEgPSB0aGV0YSAvIE1hdGguc2luKHRoZXRhKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHF1YXRlcm5pb24sIHRoZXRhT3ZlclNpblRoZXRhLCByZXN1bHQpOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmV4cCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgdGhldGEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGNhcnRlc2lhbjExKTsKICAgICAgICBsZXQgc2luVGhldGFPdmVyVGhldGEgPSAwOwogICAgICAgIGlmICh0aGV0YSAhPT0gMCkgewogICAgICAgICAgc2luVGhldGFPdmVyVGhldGEgPSBNYXRoLnNpbih0aGV0YSkgLyB0aGV0YTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBjYXJ0ZXNpYW4xMS54ICogc2luVGhldGFPdmVyVGhldGE7CiAgICAgICAgcmVzdWx0LnkgPSBjYXJ0ZXNpYW4xMS55ICogc2luVGhldGFPdmVyVGhldGE7CiAgICAgICAgcmVzdWx0LnogPSBjYXJ0ZXNpYW4xMS56ICogc2luVGhldGFPdmVyVGhldGE7CiAgICAgICAgcmVzdWx0LncgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc3F1YWRTY3JhdGNoQ2FydGVzaWFuMCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3F1YWRTY3JhdGNoQ2FydGVzaWFuMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3F1YWRTY3JhdGNoUXVhdGVybmlvbjAgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMSA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIFF1YXRlcm5pb24uY29tcHV0ZUlubmVyUXVhZHJhbmdsZSA9IGZ1bmN0aW9uKHEwLCBxMTIsIHEyMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxMCIsIHEwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInExIiwgcTEyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInEyIiwgcTIyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgcUludiA9IFF1YXRlcm5pb24uY29uanVnYXRlKHExMiwgc3F1YWRTY3JhdGNoUXVhdGVybmlvbjApOwogICAgICAgIFF1YXRlcm5pb24ubXVsdGlwbHkocUludiwgcTIyLCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMSk7CiAgICAgICAgY29uc3QgY2FydDAgPSBRdWF0ZXJuaW9uLmxvZyhzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMSwgc3F1YWRTY3JhdGNoQ2FydGVzaWFuMCk7CiAgICAgICAgUXVhdGVybmlvbi5tdWx0aXBseShxSW52LCBxMCwgc3F1YWRTY3JhdGNoUXVhdGVybmlvbjEpOwogICAgICAgIGNvbnN0IGNhcnQxID0gUXVhdGVybmlvbi5sb2coc3F1YWRTY3JhdGNoUXVhdGVybmlvbjEsIHNxdWFkU2NyYXRjaENhcnRlc2lhbjEpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2FydDAsIGNhcnQxLCBjYXJ0MCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoY2FydDAsIDAuMjUsIGNhcnQwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGNhcnQwLCBjYXJ0MCk7CiAgICAgICAgUXVhdGVybmlvbi5leHAoY2FydDAsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24wKTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5tdWx0aXBseShxMTIsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24wLCByZXN1bHQpOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLnNxdWFkID0gZnVuY3Rpb24ocTAsIHExMiwgczAsIHMxLCB0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInEwIiwgcTApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicTEiLCBxMTIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiczAiLCBzMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzMSIsIHMxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInQiLCB0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc2xlcnAwID0gUXVhdGVybmlvbi5zbGVycChxMCwgcTEyLCB0LCBzcXVhZFNjcmF0Y2hRdWF0ZXJuaW9uMCk7CiAgICAgICAgY29uc3Qgc2xlcnAxID0gUXVhdGVybmlvbi5zbGVycChzMCwgczEsIHQsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24xKTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5zbGVycChzbGVycDAsIHNsZXJwMSwgMiAqIHQgKiAoMSAtIHQpLCByZXN1bHQpOwogICAgICB9OwogICAgICBmYXN0U2xlcnBTY3JhdGNoUXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIG9wbXUgPSAxLjkwMTEwNzQ1MzUxNzMwMDM7CiAgICAgIHUgPSBGZWF0dXJlRGV0ZWN0aW9uX2RlZmF1bHQuc3VwcG9ydHNUeXBlZEFycmF5cygpID8gbmV3IEZsb2F0MzJBcnJheSg4KSA6IFtdOwogICAgICB2ID0gRmVhdHVyZURldGVjdGlvbl9kZWZhdWx0LnN1cHBvcnRzVHlwZWRBcnJheXMoKSA/IG5ldyBGbG9hdDMyQXJyYXkoOCkgOiBbXTsKICAgICAgYlQgPSBGZWF0dXJlRGV0ZWN0aW9uX2RlZmF1bHQuc3VwcG9ydHNUeXBlZEFycmF5cygpID8gbmV3IEZsb2F0MzJBcnJheSg4KSA6IFtdOwogICAgICBiRCA9IEZlYXR1cmVEZXRlY3Rpb25fZGVmYXVsdC5zdXBwb3J0c1R5cGVkQXJyYXlzKCkgPyBuZXcgRmxvYXQzMkFycmF5KDgpIDogW107CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNzsgKytpKSB7CiAgICAgICAgY29uc3QgcyA9IGkgKyAxOwogICAgICAgIGNvbnN0IHQgPSAyICogcyArIDE7CiAgICAgICAgdVtpXSA9IDEgLyAocyAqIHQpOwogICAgICAgIHZbaV0gPSBzIC8gdDsKICAgICAgfQogICAgICB1WzddID0gb3BtdSAvICg4ICogMTcpOwogICAgICB2WzddID0gb3BtdSAqIDggLyAxNzsKICAgICAgUXVhdGVybmlvbi5mYXN0U2xlcnAgPSBmdW5jdGlvbihzdGFydCwgZW5kLCB0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN0YXJ0Iiwgc3RhcnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZW5kIiwgZW5kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInQiLCB0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgbGV0IHggPSBRdWF0ZXJuaW9uLmRvdChzdGFydCwgZW5kKTsKICAgICAgICBsZXQgc2lnbjI7CiAgICAgICAgaWYgKHggPj0gMCkgewogICAgICAgICAgc2lnbjIgPSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzaWduMiA9IC0xOwogICAgICAgICAgeCA9IC14OwogICAgICAgIH0KICAgICAgICBjb25zdCB4bTEgPSB4IC0gMTsKICAgICAgICBjb25zdCBkID0gMSAtIHQ7CiAgICAgICAgY29uc3Qgc3FyVCA9IHQgKiB0OwogICAgICAgIGNvbnN0IHNxckQgPSBkICogZDsKICAgICAgICBmb3IgKGxldCBpID0gNzsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgIGJUW2ldID0gKHVbaV0gKiBzcXJUIC0gdltpXSkgKiB4bTE7CiAgICAgICAgICBiRFtpXSA9ICh1W2ldICogc3FyRCAtIHZbaV0pICogeG0xOwogICAgICAgIH0KICAgICAgICBjb25zdCBjVCA9IHNpZ24yICogdCAqICgxICsgYlRbMF0gKiAoMSArIGJUWzFdICogKDEgKyBiVFsyXSAqICgxICsgYlRbM10gKiAoMSArIGJUWzRdICogKDEgKyBiVFs1XSAqICgxICsgYlRbNl0gKiAoMSArIGJUWzddKSkpKSkpKSk7CiAgICAgICAgY29uc3QgY0QgPSBkICogKDEgKyBiRFswXSAqICgxICsgYkRbMV0gKiAoMSArIGJEWzJdICogKDEgKyBiRFszXSAqICgxICsgYkRbNF0gKiAoMSArIGJEWzVdICogKDEgKyBiRFs2XSAqICgxICsgYkRbN10pKSkpKSkpKTsKICAgICAgICBjb25zdCB0ZW1wID0gUXVhdGVybmlvbi5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgc3RhcnQsCiAgICAgICAgICBjRCwKICAgICAgICAgIGZhc3RTbGVycFNjcmF0Y2hRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICBRdWF0ZXJuaW9uLm11bHRpcGx5QnlTY2FsYXIoZW5kLCBjVCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5hZGQodGVtcCwgcmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLmZhc3RTcXVhZCA9IGZ1bmN0aW9uKHEwLCBxMTIsIHMwLCBzMSwgdCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJxMCIsIHEwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInExIiwgcTEyKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInMwIiwgczApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiczEiLCBzMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0IiwgdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHNsZXJwMCA9IFF1YXRlcm5pb24uZmFzdFNsZXJwKHEwLCBxMTIsIHQsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24wKTsKICAgICAgICBjb25zdCBzbGVycDEgPSBRdWF0ZXJuaW9uLmZhc3RTbGVycChzMCwgczEsIHQsIHNxdWFkU2NyYXRjaFF1YXRlcm5pb24xKTsKICAgICAgICByZXR1cm4gUXVhdGVybmlvbi5mYXN0U2xlcnAoc2xlcnAwLCBzbGVycDEsIDIgKiB0ICogKDEgLSB0KSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LnggPT09IHJpZ2h0LnggJiYgbGVmdC55ID09PSByaWdodC55ICYmIGxlZnQueiA9PT0gcmlnaHQueiAmJiBsZWZ0LncgPT09IHJpZ2h0Lnc7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24uZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgZXBzaWxvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVwc2lsb24sIDApOwogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoLmFicyhsZWZ0LnggLSByaWdodC54KSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnQueSAtIHJpZ2h0LnkpIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC56IC0gcmlnaHQueikgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0LncgLSByaWdodC53KSA8PSBlcHNpbG9uOwogICAgICB9OwogICAgICBRdWF0ZXJuaW9uLlpFUk8gPSBPYmplY3QuZnJlZXplKG5ldyBRdWF0ZXJuaW9uKDAsIDAsIDAsIDApKTsKICAgICAgUXVhdGVybmlvbi5JREVOVElUWSA9IE9iamVjdC5mcmVlemUobmV3IFF1YXRlcm5pb24oMCwgMCwgMCwgMSkpOwogICAgICBRdWF0ZXJuaW9uLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uLmNsb25lKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24uZXF1YWxzKHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgUXVhdGVybmlvbi5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKHJpZ2h0LCBlcHNpbG9uKSB7CiAgICAgICAgcmV0dXJuIFF1YXRlcm5pb24uZXF1YWxzRXBzaWxvbih0aGlzLCByaWdodCwgZXBzaWxvbik7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb24ucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGAoJHt0aGlzLnh9LCAke3RoaXMueX0sICR7dGhpcy56fSwgJHt0aGlzLnd9KWA7CiAgICAgIH07CiAgICAgIFF1YXRlcm5pb25fZGVmYXVsdCA9IFF1YXRlcm5pb247CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9UcmFuc2Zvcm1zLmpzCiAgdmFyIFRyYW5zZm9ybXMsIHZlY3RvclByb2R1Y3RMb2NhbEZyYW1lLCBkZWdlbmVyYXRlUG9zaXRpb25Mb2NhbEZyYW1lLCBsb2NhbEZyYW1lVG9GaXhlZEZyYW1lQ2FjaGUsIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4sIHNjcmF0Y2hGaXJzdENhcnRlc2lhbiwgc2NyYXRjaFNlY29uZENhcnRlc2lhbiwgc2NyYXRjaFRoaXJkQ2FydGVzaWFuLCBzY3JhdGNoSFBSUXVhdGVybmlvbjIsIHNjcmF0Y2hTY2FsZSwgc2NyYXRjaEhQUk1hdHJpeDQsIHNjcmF0Y2hFTlVNYXRyaXg0LCBzY3JhdGNoSFBSTWF0cml4Mywgbm9TY2FsZSwgaHByQ2VudGVyU2NyYXRjaCwgZmZTY3JhdGNoLCBocHJUcmFuc2Zvcm1TY3JhdGNoLCBocHJSb3RhdGlvblNjcmF0Y2gsIGhwclF1YXRlcm5pb25TY3JhdGNoLCBnbXN0Q29uc3RhbnQwLCBnbXN0Q29uc3RhbnQxLCBnbXN0Q29uc3RhbnQyLCBnbXN0Q29uc3RhbnQzLCByYXRlQ29lZiwgd2dzODRXUlByZWNlc3NpbmcsIHR3b1BpT3ZlclNlY29uZHNJbkRheSwgZGF0ZUluVXRjLCB0dE1pbnVzVGFpLCBqMjAwMHR0RGF5cywgeHlzU2NyYXRjaCwgZW9wU2NyYXRjaCwgcm90YXRpb24xU2NyYXRjaCwgcm90YXRpb24yU2NyYXRjaCwgcG9pbnRUb1dpbmRvd0Nvb3JkaW5hdGVzVGVtcCwgbm9ybWFsU2NyYXRjaCwgcmlnaHRTY3JhdGNoLCB1cFNjcmF0Y2gsIHN3aXp6bGVNYXRyaXgsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMsIHNjcmF0Y2hDYXJ0ZXNpYW4zUHJvamVjdGlvbiwgc2NyYXRjaENlbnRlciwgc2NyYXRjaFJvdGF0aW9uLCBzY3JhdGNoRnJvbUVOVSwgc2NyYXRjaFRvRU5VLCBUcmFuc2Zvcm1zX2RlZmF1bHQ7CiAgdmFyIGluaXRfVHJhbnNmb3JtcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVHJhbnNmb3Jtcy5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FYXJ0aE9yaWVudGF0aW9uUGFyYW1ldGVycygpOwogICAgICBpbml0X0VhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzU2FtcGxlKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfSGVhZGluZ1BpdGNoUm9sbCgpOwogICAgICBpbml0X0lhdTIwMDZYeXNEYXRhKCk7CiAgICAgIGluaXRfSWF1MjAwNlh5c1NhbXBsZSgpOwogICAgICBpbml0X0p1bGlhbkRhdGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfVGltZUNvbnN0YW50cygpOwogICAgICBUcmFuc2Zvcm1zID0ge307CiAgICAgIHZlY3RvclByb2R1Y3RMb2NhbEZyYW1lID0gewogICAgICAgIHVwOiB7CiAgICAgICAgICBzb3V0aDogImVhc3QiLAogICAgICAgICAgbm9ydGg6ICJ3ZXN0IiwKICAgICAgICAgIHdlc3Q6ICJzb3V0aCIsCiAgICAgICAgICBlYXN0OiAibm9ydGgiCiAgICAgICAgfSwKICAgICAgICBkb3duOiB7CiAgICAgICAgICBzb3V0aDogIndlc3QiLAogICAgICAgICAgbm9ydGg6ICJlYXN0IiwKICAgICAgICAgIHdlc3Q6ICJub3J0aCIsCiAgICAgICAgICBlYXN0OiAic291dGgiCiAgICAgICAgfSwKICAgICAgICBzb3V0aDogewogICAgICAgICAgdXA6ICJ3ZXN0IiwKICAgICAgICAgIGRvd246ICJlYXN0IiwKICAgICAgICAgIHdlc3Q6ICJkb3duIiwKICAgICAgICAgIGVhc3Q6ICJ1cCIKICAgICAgICB9LAogICAgICAgIG5vcnRoOiB7CiAgICAgICAgICB1cDogImVhc3QiLAogICAgICAgICAgZG93bjogIndlc3QiLAogICAgICAgICAgd2VzdDogInVwIiwKICAgICAgICAgIGVhc3Q6ICJkb3duIgogICAgICAgIH0sCiAgICAgICAgd2VzdDogewogICAgICAgICAgdXA6ICJub3J0aCIsCiAgICAgICAgICBkb3duOiAic291dGgiLAogICAgICAgICAgbm9ydGg6ICJkb3duIiwKICAgICAgICAgIHNvdXRoOiAidXAiCiAgICAgICAgfSwKICAgICAgICBlYXN0OiB7CiAgICAgICAgICB1cDogInNvdXRoIiwKICAgICAgICAgIGRvd246ICJub3J0aCIsCiAgICAgICAgICBub3J0aDogInVwIiwKICAgICAgICAgIHNvdXRoOiAiZG93biIKICAgICAgICB9CiAgICAgIH07CiAgICAgIGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWUgPSB7CiAgICAgICAgbm9ydGg6IFstMSwgMCwgMF0sCiAgICAgICAgZWFzdDogWzAsIDEsIDBdLAogICAgICAgIHVwOiBbMCwgMCwgMV0sCiAgICAgICAgc291dGg6IFsxLCAwLCAwXSwKICAgICAgICB3ZXN0OiBbMCwgLTEsIDBdLAogICAgICAgIGRvd246IFswLCAwLCAtMV0KICAgICAgfTsKICAgICAgbG9jYWxGcmFtZVRvRml4ZWRGcmFtZUNhY2hlID0ge307CiAgICAgIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4gPSB7CiAgICAgICAgZWFzdDogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIG5vcnRoOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgdXA6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICB3ZXN0OiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgc291dGg6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICBkb3duOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkKICAgICAgfTsKICAgICAgc2NyYXRjaEZpcnN0Q2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMubG9jYWxGcmFtZVRvRml4ZWRGcmFtZUdlbmVyYXRvciA9IGZ1bmN0aW9uKGZpcnN0QXhpcywgc2Vjb25kQXhpcykgewogICAgICAgIGlmICghdmVjdG9yUHJvZHVjdExvY2FsRnJhbWUuaGFzT3duUHJvcGVydHkoZmlyc3RBeGlzKSB8fCAhdmVjdG9yUHJvZHVjdExvY2FsRnJhbWVbZmlyc3RBeGlzXS5oYXNPd25Qcm9wZXJ0eShzZWNvbmRBeGlzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJmaXJzdEF4aXMgYW5kIHNlY29uZEF4aXMgbXVzdCBiZSBlYXN0LCBub3J0aCwgdXAsIHdlc3QsIHNvdXRoIG9yIGRvd24uIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdGhpcmRBeGlzID0gdmVjdG9yUHJvZHVjdExvY2FsRnJhbWVbZmlyc3RBeGlzXVtzZWNvbmRBeGlzXTsKICAgICAgICBsZXQgcmVzdWx0YXQ7CiAgICAgICAgY29uc3QgaGFzaEF4aXMgPSBmaXJzdEF4aXMgKyBzZWNvbmRBeGlzOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobG9jYWxGcmFtZVRvRml4ZWRGcmFtZUNhY2hlW2hhc2hBeGlzXSkpIHsKICAgICAgICAgIHJlc3VsdGF0ID0gbG9jYWxGcmFtZVRvRml4ZWRGcmFtZUNhY2hlW2hhc2hBeGlzXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0YXQgPSBmdW5jdGlvbihvcmlnaW4sIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9yaWdpbikpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3JpZ2luIGlzIHJlcXVpcmVkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc05hTihvcmlnaW4ueCkgfHwgaXNOYU4ob3JpZ2luLnkpIHx8IGlzTmFOKG9yaWdpbi56KSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcmlnaW4gaGFzIGEgTmFOIGNvbXBvbmVudCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgICAgICByZXN1bHQgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKG9yaWdpbiwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSB7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgICAgIGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWVbZmlyc3RBeGlzXSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgICAgICBkZWdlbmVyYXRlUG9zaXRpb25Mb2NhbEZyYW1lW3NlY29uZEF4aXNdLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgICAgICBkZWdlbmVyYXRlUG9zaXRpb25Mb2NhbEZyYW1lW3RoaXJkQXhpc10sCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgc2NyYXRjaFRoaXJkQ2FydGVzaWFuCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihvcmlnaW4ueCwgMCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24ob3JpZ2luLnksIDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSB7CiAgICAgICAgICAgICAgY29uc3Qgc2lnbjIgPSBNYXRoX2RlZmF1bHQuc2lnbihvcmlnaW4ueik7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgICAgIGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWVbZmlyc3RBeGlzXSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChmaXJzdEF4aXMgIT09ICJlYXN0IiAmJiBmaXJzdEF4aXMgIT09ICJ3ZXN0IikgewogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hGaXJzdENhcnRlc2lhbiwKICAgICAgICAgICAgICAgICAgc2lnbjIsCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hGaXJzdENhcnRlc2lhbgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgICAgIGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWVbc2Vjb25kQXhpc10sCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgc2NyYXRjaFNlY29uZENhcnRlc2lhbgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKHNlY29uZEF4aXMgIT09ICJlYXN0IiAmJiBzZWNvbmRBeGlzICE9PSAid2VzdCIpIHsKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICAgICAgICBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuLAogICAgICAgICAgICAgICAgICBzaWduMiwKICAgICAgICAgICAgICAgICAgc2NyYXRjaFNlY29uZENhcnRlc2lhbgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgICAgIGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWVbdGhpcmRBeGlzXSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICh0aGlyZEF4aXMgIT09ICJlYXN0IiAmJiB0aGlyZEF4aXMgIT09ICJ3ZXN0IikgewogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hUaGlyZENhcnRlc2lhbiwKICAgICAgICAgICAgICAgICAgc2lnbjIsCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hUaGlyZENhcnRlc2lhbgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgICAgICAgZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChvcmlnaW4sIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4udXApOwogICAgICAgICAgICAgIGNvbnN0IHVwID0gc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi51cDsKICAgICAgICAgICAgICBjb25zdCBlYXN0ID0gc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi5lYXN0OwogICAgICAgICAgICAgIGVhc3QueCA9IC1vcmlnaW4ueTsKICAgICAgICAgICAgICBlYXN0LnkgPSBvcmlnaW4ueDsKICAgICAgICAgICAgICBlYXN0LnogPSAwOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZWFzdCwgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi5lYXN0KTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModXAsIGVhc3QsIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4ubm9ydGgpOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICAgICAgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi51cCwKICAgICAgICAgICAgICAgIC0xLAogICAgICAgICAgICAgICAgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi5kb3duCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4uZWFzdCwKICAgICAgICAgICAgICAgIC0xLAogICAgICAgICAgICAgICAgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi53ZXN0CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4ubm9ydGgsCiAgICAgICAgICAgICAgICAtMSwKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4uc291dGgKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHNjcmF0Y2hGaXJzdENhcnRlc2lhbiA9IHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW5bZmlyc3RBeGlzXTsKICAgICAgICAgICAgICBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuID0gc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbltzZWNvbmRBeGlzXTsKICAgICAgICAgICAgICBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4gPSBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuW3RoaXJkQXhpc107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0WzBdID0gc2NyYXRjaEZpcnN0Q2FydGVzaWFuLng7CiAgICAgICAgICAgIHJlc3VsdFsxXSA9IHNjcmF0Y2hGaXJzdENhcnRlc2lhbi55OwogICAgICAgICAgICByZXN1bHRbMl0gPSBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4uejsKICAgICAgICAgICAgcmVzdWx0WzNdID0gMDsKICAgICAgICAgICAgcmVzdWx0WzRdID0gc2NyYXRjaFNlY29uZENhcnRlc2lhbi54OwogICAgICAgICAgICByZXN1bHRbNV0gPSBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuLnk7CiAgICAgICAgICAgIHJlc3VsdFs2XSA9IHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4uejsKICAgICAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICAgICAgcmVzdWx0WzhdID0gc2NyYXRjaFRoaXJkQ2FydGVzaWFuLng7CiAgICAgICAgICAgIHJlc3VsdFs5XSA9IHNjcmF0Y2hUaGlyZENhcnRlc2lhbi55OwogICAgICAgICAgICByZXN1bHRbMTBdID0gc2NyYXRjaFRoaXJkQ2FydGVzaWFuLno7CiAgICAgICAgICAgIHJlc3VsdFsxMV0gPSAwOwogICAgICAgICAgICByZXN1bHRbMTJdID0gb3JpZ2luLng7CiAgICAgICAgICAgIHJlc3VsdFsxM10gPSBvcmlnaW4ueTsKICAgICAgICAgICAgcmVzdWx0WzE0XSA9IG9yaWdpbi56OwogICAgICAgICAgICByZXN1bHRbMTVdID0gMTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH07CiAgICAgICAgICBsb2NhbEZyYW1lVG9GaXhlZEZyYW1lQ2FjaGVbaGFzaEF4aXNdID0gcmVzdWx0YXQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHRhdDsKICAgICAgfTsKICAgICAgVHJhbnNmb3Jtcy5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZSA9IFRyYW5zZm9ybXMubG9jYWxGcmFtZVRvRml4ZWRGcmFtZUdlbmVyYXRvcigKICAgICAgICAiZWFzdCIsCiAgICAgICAgIm5vcnRoIgogICAgICApOwogICAgICBUcmFuc2Zvcm1zLm5vcnRoRWFzdERvd25Ub0ZpeGVkRnJhbWUgPSBUcmFuc2Zvcm1zLmxvY2FsRnJhbWVUb0ZpeGVkRnJhbWVHZW5lcmF0b3IoCiAgICAgICAgIm5vcnRoIiwKICAgICAgICAiZWFzdCIKICAgICAgKTsKICAgICAgVHJhbnNmb3Jtcy5ub3J0aFVwRWFzdFRvRml4ZWRGcmFtZSA9IFRyYW5zZm9ybXMubG9jYWxGcmFtZVRvRml4ZWRGcmFtZUdlbmVyYXRvcigKICAgICAgICAibm9ydGgiLAogICAgICAgICJ1cCIKICAgICAgKTsKICAgICAgVHJhbnNmb3Jtcy5ub3J0aFdlc3RVcFRvRml4ZWRGcmFtZSA9IFRyYW5zZm9ybXMubG9jYWxGcmFtZVRvRml4ZWRGcmFtZUdlbmVyYXRvcigKICAgICAgICAibm9ydGgiLAogICAgICAgICJ3ZXN0IgogICAgICApOwogICAgICBzY3JhdGNoSFBSUXVhdGVybmlvbjIgPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hTY2FsZSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMSwgMSwgMSk7CiAgICAgIHNjcmF0Y2hIUFJNYXRyaXg0ID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBUcmFuc2Zvcm1zLmhlYWRpbmdQaXRjaFJvbGxUb0ZpeGVkRnJhbWUgPSBmdW5jdGlvbihvcmlnaW4sIGhlYWRpbmdQaXRjaFJvbGwsIGVsbGlwc29pZCwgZml4ZWRGcmFtZVRyYW5zZm9ybSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJIZWFkaW5nUGl0Y2hSb2xsIiwgaGVhZGluZ1BpdGNoUm9sbCk7CiAgICAgICAgZml4ZWRGcmFtZVRyYW5zZm9ybSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgZml4ZWRGcmFtZVRyYW5zZm9ybSwKICAgICAgICAgIFRyYW5zZm9ybXMuZWFzdE5vcnRoVXBUb0ZpeGVkRnJhbWUKICAgICAgICApOwogICAgICAgIGNvbnN0IGhwclF1YXRlcm5pb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUhlYWRpbmdQaXRjaFJvbGwoCiAgICAgICAgICBoZWFkaW5nUGl0Y2hSb2xsLAogICAgICAgICAgc2NyYXRjaEhQUlF1YXRlcm5pb24yCiAgICAgICAgKTsKICAgICAgICBjb25zdCBocHJNYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQuZnJvbVRyYW5zbGF0aW9uUXVhdGVybmlvblJvdGF0aW9uU2NhbGUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywKICAgICAgICAgIGhwclF1YXRlcm5pb24sCiAgICAgICAgICBzY3JhdGNoU2NhbGUsCiAgICAgICAgICBzY3JhdGNoSFBSTWF0cml4NAogICAgICAgICk7CiAgICAgICAgcmVzdWx0ID0gZml4ZWRGcmFtZVRyYW5zZm9ybShvcmlnaW4sIGVsbGlwc29pZCwgcmVzdWx0KTsKICAgICAgICByZXR1cm4gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5KHJlc3VsdCwgaHByTWF0cml4LCByZXN1bHQpOwogICAgICB9OwogICAgICBzY3JhdGNoRU5VTWF0cml4NCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEhQUk1hdHJpeDMgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIFRyYW5zZm9ybXMuaGVhZGluZ1BpdGNoUm9sbFF1YXRlcm5pb24gPSBmdW5jdGlvbihvcmlnaW4sIGhlYWRpbmdQaXRjaFJvbGwsIGVsbGlwc29pZCwgZml4ZWRGcmFtZVRyYW5zZm9ybSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJIZWFkaW5nUGl0Y2hSb2xsIiwgaGVhZGluZ1BpdGNoUm9sbCk7CiAgICAgICAgY29uc3QgdHJhbnNmb3JtMiA9IFRyYW5zZm9ybXMuaGVhZGluZ1BpdGNoUm9sbFRvRml4ZWRGcmFtZSgKICAgICAgICAgIG9yaWdpbiwKICAgICAgICAgIGhlYWRpbmdQaXRjaFJvbGwsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBmaXhlZEZyYW1lVHJhbnNmb3JtLAogICAgICAgICAgc2NyYXRjaEVOVU1hdHJpeDQKICAgICAgICApOwogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gTWF0cml4NF9kZWZhdWx0LmdldE1hdHJpeDModHJhbnNmb3JtMiwgc2NyYXRjaEhQUk1hdHJpeDMpOwogICAgICAgIHJldHVybiBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbVJvdGF0aW9uTWF0cml4KHJvdGF0aW9uLCByZXN1bHQpOwogICAgICB9OwogICAgICBub1NjYWxlID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgxLCAxLCAxKTsKICAgICAgaHByQ2VudGVyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZmZTY3JhdGNoID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBocHJUcmFuc2Zvcm1TY3JhdGNoID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBocHJSb3RhdGlvblNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIGhwclF1YXRlcm5pb25TY3JhdGNoID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBUcmFuc2Zvcm1zLmZpeGVkRnJhbWVUb0hlYWRpbmdQaXRjaFJvbGwgPSBmdW5jdGlvbih0cmFuc2Zvcm0yLCBlbGxpcHNvaWQsIGZpeGVkRnJhbWVUcmFuc2Zvcm0sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidHJhbnNmb3JtIiwgdHJhbnNmb3JtMik7CiAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgZml4ZWRGcmFtZVRyYW5zZm9ybSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgZml4ZWRGcmFtZVRyYW5zZm9ybSwKICAgICAgICAgIFRyYW5zZm9ybXMuZWFzdE5vcnRoVXBUb0ZpeGVkRnJhbWUKICAgICAgICApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBIZWFkaW5nUGl0Y2hSb2xsX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2VudGVyID0gTWF0cml4NF9kZWZhdWx0LmdldFRyYW5zbGF0aW9uKHRyYW5zZm9ybTIsIGhwckNlbnRlclNjcmF0Y2gpOwogICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGNlbnRlciwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKSB7CiAgICAgICAgICByZXN1bHQuaGVhZGluZyA9IDA7CiAgICAgICAgICByZXN1bHQucGl0Y2ggPSAwOwogICAgICAgICAgcmVzdWx0LnJvbGwgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgbGV0IHRvRml4ZWRGcmFtZSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oCiAgICAgICAgICBmaXhlZEZyYW1lVHJhbnNmb3JtKGNlbnRlciwgZWxsaXBzb2lkLCBmZlNjcmF0Y2gpLAogICAgICAgICAgZmZTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBsZXQgdHJhbnNmb3JtQ29weSA9IE1hdHJpeDRfZGVmYXVsdC5zZXRTY2FsZSh0cmFuc2Zvcm0yLCBub1NjYWxlLCBocHJUcmFuc2Zvcm1TY3JhdGNoKTsKICAgICAgICB0cmFuc2Zvcm1Db3B5ID0gTWF0cml4NF9kZWZhdWx0LnNldFRyYW5zbGF0aW9uKAogICAgICAgICAgdHJhbnNmb3JtQ29weSwKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAgICAgdHJhbnNmb3JtQ29weQogICAgICAgICk7CiAgICAgICAgdG9GaXhlZEZyYW1lID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5KHRvRml4ZWRGcmFtZSwgdHJhbnNmb3JtQ29weSwgdG9GaXhlZEZyYW1lKTsKICAgICAgICBsZXQgcXVhdGVybmlvblJvdGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21Sb3RhdGlvbk1hdHJpeCgKICAgICAgICAgIE1hdHJpeDRfZGVmYXVsdC5nZXRNYXRyaXgzKHRvRml4ZWRGcmFtZSwgaHByUm90YXRpb25TY3JhdGNoKSwKICAgICAgICAgIGhwclF1YXRlcm5pb25TY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBxdWF0ZXJuaW9uUm90YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgcXVhdGVybmlvblJvdGF0aW9uLAogICAgICAgICAgcXVhdGVybmlvblJvdGF0aW9uCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gSGVhZGluZ1BpdGNoUm9sbF9kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKHF1YXRlcm5pb25Sb3RhdGlvbiwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgZ21zdENvbnN0YW50MCA9IDYgKiAzNjAwICsgNDEgKiA2MCArIDUwLjU0ODQxOwogICAgICBnbXN0Q29uc3RhbnQxID0gODY0MDE4NDgxMjg2NmUtNjsKICAgICAgZ21zdENvbnN0YW50MiA9IDAuMDkzMTA0OwogICAgICBnbXN0Q29uc3RhbnQzID0gLTYyZS03OwogICAgICByYXRlQ29lZiA9IDExNzcyNzU4Mzg0NjY4ZS0zMjsKICAgICAgd2dzODRXUlByZWNlc3NpbmcgPSA3MjkyMTE1ODU1M2UtMTU7CiAgICAgIHR3b1BpT3ZlclNlY29uZHNJbkRheSA9IE1hdGhfZGVmYXVsdC5UV09fUEkgLyA4NjQwMDsKICAgICAgZGF0ZUluVXRjID0gbmV3IEp1bGlhbkRhdGVfZGVmYXVsdCgpOwogICAgICBUcmFuc2Zvcm1zLmNvbXB1dGVUZW1lVG9Qc2V1ZG9GaXhlZE1hdHJpeCA9IGZ1bmN0aW9uKGRhdGUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgZGF0ZUluVXRjID0gSnVsaWFuRGF0ZV9kZWZhdWx0LmFkZFNlY29uZHMoCiAgICAgICAgICBkYXRlLAogICAgICAgICAgLUp1bGlhbkRhdGVfZGVmYXVsdC5jb21wdXRlVGFpTWludXNVdGMoZGF0ZSksCiAgICAgICAgICBkYXRlSW5VdGMKICAgICAgICApOwogICAgICAgIGNvbnN0IHV0Y0RheU51bWJlciA9IGRhdGVJblV0Yy5kYXlOdW1iZXI7CiAgICAgICAgY29uc3QgdXRjU2Vjb25kc0ludG9EYXkgPSBkYXRlSW5VdGMuc2Vjb25kc09mRGF5OwogICAgICAgIGxldCB0OwogICAgICAgIGNvbnN0IGRpZmZEYXlzID0gdXRjRGF5TnVtYmVyIC0gMjQ1MTU0NTsKICAgICAgICBpZiAodXRjU2Vjb25kc0ludG9EYXkgPj0gNDMyMDApIHsKICAgICAgICAgIHQgPSAoZGlmZkRheXMgKyAwLjUpIC8gVGltZUNvbnN0YW50c19kZWZhdWx0LkRBWVNfUEVSX0pVTElBTl9DRU5UVVJZOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0ID0gKGRpZmZEYXlzIC0gMC41KSAvIFRpbWVDb25zdGFudHNfZGVmYXVsdC5EQVlTX1BFUl9KVUxJQU5fQ0VOVFVSWTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ21zdDAgPSBnbXN0Q29uc3RhbnQwICsgdCAqIChnbXN0Q29uc3RhbnQxICsgdCAqIChnbXN0Q29uc3RhbnQyICsgdCAqIGdtc3RDb25zdGFudDMpKTsKICAgICAgICBjb25zdCBhbmdsZSA9IGdtc3QwICogdHdvUGlPdmVyU2Vjb25kc0luRGF5ICUgTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICBjb25zdCByYXRpbyA9IHdnczg0V1JQcmVjZXNzaW5nICsgcmF0ZUNvZWYgKiAodXRjRGF5TnVtYmVyIC0gMjQ1MTU0NTVlLTEpOwogICAgICAgIGNvbnN0IHNlY29uZHNTaW5jZU1pZG5pZ2h0ID0gKHV0Y1NlY29uZHNJbnRvRGF5ICsgVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWSAqIDAuNSkgJSBUaW1lQ29uc3RhbnRzX2RlZmF1bHQuU0VDT05EU19QRVJfREFZOwogICAgICAgIGNvbnN0IGdoYSA9IGFuZ2xlICsgcmF0aW8gKiBzZWNvbmRzU2luY2VNaWRuaWdodDsKICAgICAgICBjb25zdCBjb3NHaGEgPSBNYXRoLmNvcyhnaGEpOwogICAgICAgIGNvbnN0IHNpbkdoYSA9IE1hdGguc2luKGdoYSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgzX2RlZmF1bHQoCiAgICAgICAgICAgIGNvc0doYSwKICAgICAgICAgICAgc2luR2hhLAogICAgICAgICAgICAwLAogICAgICAgICAgICAtc2luR2hhLAogICAgICAgICAgICBjb3NHaGEsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIDEKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IGNvc0doYTsKICAgICAgICByZXN1bHRbMV0gPSAtc2luR2hhOwogICAgICAgIHJlc3VsdFsyXSA9IDA7CiAgICAgICAgcmVzdWx0WzNdID0gc2luR2hhOwogICAgICAgIHJlc3VsdFs0XSA9IGNvc0doYTsKICAgICAgICByZXN1bHRbNV0gPSAwOwogICAgICAgIHJlc3VsdFs2XSA9IDA7CiAgICAgICAgcmVzdWx0WzddID0gMDsKICAgICAgICByZXN1bHRbOF0gPSAxOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFRyYW5zZm9ybXMuaWF1MjAwNlh5c0RhdGEgPSBuZXcgSWF1MjAwNlh5c0RhdGFfZGVmYXVsdCgpOwogICAgICBUcmFuc2Zvcm1zLmVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzID0gRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNfZGVmYXVsdC5OT05FOwogICAgICB0dE1pbnVzVGFpID0gMzIuMTg0OwogICAgICBqMjAwMHR0RGF5cyA9IDI0NTE1NDU7CiAgICAgIFRyYW5zZm9ybXMucHJlbG9hZEljcmZGaXhlZCA9IGZ1bmN0aW9uKHRpbWVJbnRlcnZhbCkgewogICAgICAgIGNvbnN0IHN0YXJ0RGF5VFQgPSB0aW1lSW50ZXJ2YWwuc3RhcnQuZGF5TnVtYmVyOwogICAgICAgIGNvbnN0IHN0YXJ0U2Vjb25kVFQgPSB0aW1lSW50ZXJ2YWwuc3RhcnQuc2Vjb25kc09mRGF5ICsgdHRNaW51c1RhaTsKICAgICAgICBjb25zdCBzdG9wRGF5VFQgPSB0aW1lSW50ZXJ2YWwuc3RvcC5kYXlOdW1iZXI7CiAgICAgICAgY29uc3Qgc3RvcFNlY29uZFRUID0gdGltZUludGVydmFsLnN0b3Auc2Vjb25kc09mRGF5ICsgdHRNaW51c1RhaTsKICAgICAgICByZXR1cm4gVHJhbnNmb3Jtcy5pYXUyMDA2WHlzRGF0YS5wcmVsb2FkKAogICAgICAgICAgc3RhcnREYXlUVCwKICAgICAgICAgIHN0YXJ0U2Vjb25kVFQsCiAgICAgICAgICBzdG9wRGF5VFQsCiAgICAgICAgICBzdG9wU2Vjb25kVFQKICAgICAgICApOwogICAgICB9OwogICAgICBUcmFuc2Zvcm1zLmNvbXB1dGVJY3JmVG9GaXhlZE1hdHJpeCA9IGZ1bmN0aW9uKGRhdGUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBmaXhlZFRvSWNyZk10eCA9IFRyYW5zZm9ybXMuY29tcHV0ZUZpeGVkVG9JY3JmTWF0cml4KGRhdGUsIHJlc3VsdCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZml4ZWRUb0ljcmZNdHgpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gTWF0cml4M19kZWZhdWx0LnRyYW5zcG9zZShmaXhlZFRvSWNyZk10eCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgeHlzU2NyYXRjaCA9IG5ldyBJYXUyMDA2WHlzU2FtcGxlX2RlZmF1bHQoMCwgMCwgMCk7CiAgICAgIGVvcFNjcmF0Y2ggPSBuZXcgRWFydGhPcmllbnRhdGlvblBhcmFtZXRlcnNTYW1wbGVfZGVmYXVsdCgKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMAogICAgICApOwogICAgICByb3RhdGlvbjFTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICByb3RhdGlvbjJTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBUcmFuc2Zvcm1zLmNvbXB1dGVGaXhlZFRvSWNyZk1hdHJpeCA9IGZ1bmN0aW9uKGRhdGUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRhdGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZGF0ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBlb3AgPSBUcmFuc2Zvcm1zLmVhcnRoT3JpZW50YXRpb25QYXJhbWV0ZXJzLmNvbXB1dGUoZGF0ZSwgZW9wU2NyYXRjaCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZW9wKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGF5VFQgPSBkYXRlLmRheU51bWJlcjsKICAgICAgICBjb25zdCBzZWNvbmRUVCA9IGRhdGUuc2Vjb25kc09mRGF5ICsgdHRNaW51c1RhaTsKICAgICAgICBjb25zdCB4eXMgPSBUcmFuc2Zvcm1zLmlhdTIwMDZYeXNEYXRhLmNvbXB1dGVYeXNSYWRpYW5zKAogICAgICAgICAgZGF5VFQsCiAgICAgICAgICBzZWNvbmRUVCwKICAgICAgICAgIHh5c1NjcmF0Y2gKICAgICAgICApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHh5cykpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHggPSB4eXMueCArIGVvcC54UG9sZU9mZnNldDsKICAgICAgICBjb25zdCB5ID0geHlzLnkgKyBlb3AueVBvbGVPZmZzZXQ7CiAgICAgICAgY29uc3QgYTMgPSAxIC8gKDEgKyBNYXRoLnNxcnQoMSAtIHggKiB4IC0geSAqIHkpKTsKICAgICAgICBjb25zdCByb3RhdGlvbjEgPSByb3RhdGlvbjFTY3JhdGNoOwogICAgICAgIHJvdGF0aW9uMVswXSA9IDEgLSBhMyAqIHggKiB4OwogICAgICAgIHJvdGF0aW9uMVszXSA9IC1hMyAqIHggKiB5OwogICAgICAgIHJvdGF0aW9uMVs2XSA9IHg7CiAgICAgICAgcm90YXRpb24xWzFdID0gLWEzICogeCAqIHk7CiAgICAgICAgcm90YXRpb24xWzRdID0gMSAtIGEzICogeSAqIHk7CiAgICAgICAgcm90YXRpb24xWzddID0geTsKICAgICAgICByb3RhdGlvbjFbMl0gPSAteDsKICAgICAgICByb3RhdGlvbjFbNV0gPSAteTsKICAgICAgICByb3RhdGlvbjFbOF0gPSAxIC0gYTMgKiAoeCAqIHggKyB5ICogeSk7CiAgICAgICAgY29uc3Qgcm90YXRpb24yID0gTWF0cml4M19kZWZhdWx0LmZyb21Sb3RhdGlvblooLXh5cy5zLCByb3RhdGlvbjJTY3JhdGNoKTsKICAgICAgICBjb25zdCBtYXRyaXhRID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5KHJvdGF0aW9uMSwgcm90YXRpb24yLCByb3RhdGlvbjFTY3JhdGNoKTsKICAgICAgICBjb25zdCBkYXRlVXQxZGF5ID0gZGF0ZS5kYXlOdW1iZXI7CiAgICAgICAgY29uc3QgZGF0ZVV0MXNlYyA9IGRhdGUuc2Vjb25kc09mRGF5IC0gSnVsaWFuRGF0ZV9kZWZhdWx0LmNvbXB1dGVUYWlNaW51c1V0YyhkYXRlKSArIGVvcC51dDFNaW51c1V0YzsKICAgICAgICBjb25zdCBkYXlzU2luY2VKMjAwMCA9IGRhdGVVdDFkYXkgLSAyNDUxNTQ1OwogICAgICAgIGNvbnN0IGZyYWN0aW9uT2ZEYXkgPSBkYXRlVXQxc2VjIC8gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWTsKICAgICAgICBsZXQgZXJhID0gMC43NzkwNTcyNzMyNjQgKyBmcmFjdGlvbk9mRGF5ICsgMC4wMDI3Mzc4MTE5MTEzNTQ0OCAqIChkYXlzU2luY2VKMjAwMCArIGZyYWN0aW9uT2ZEYXkpOwogICAgICAgIGVyYSA9IGVyYSAlIDEgKiBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIGNvbnN0IGVhcnRoUm90YXRpb24gPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVJvdGF0aW9uWihlcmEsIHJvdGF0aW9uMlNjcmF0Y2gpOwogICAgICAgIGNvbnN0IHBmVG9JY3JmID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5KG1hdHJpeFEsIGVhcnRoUm90YXRpb24sIHJvdGF0aW9uMVNjcmF0Y2gpOwogICAgICAgIGNvbnN0IGNvc3hwID0gTWF0aC5jb3MoZW9wLnhQb2xlV2FuZGVyKTsKICAgICAgICBjb25zdCBjb3N5cCA9IE1hdGguY29zKGVvcC55UG9sZVdhbmRlcik7CiAgICAgICAgY29uc3Qgc2lueHAgPSBNYXRoLnNpbihlb3AueFBvbGVXYW5kZXIpOwogICAgICAgIGNvbnN0IHNpbnlwID0gTWF0aC5zaW4oZW9wLnlQb2xlV2FuZGVyKTsKICAgICAgICBsZXQgdHR0ID0gZGF5VFQgLSBqMjAwMHR0RGF5cyArIHNlY29uZFRUIC8gVGltZUNvbnN0YW50c19kZWZhdWx0LlNFQ09ORFNfUEVSX0RBWTsKICAgICAgICB0dHQgLz0gMzY1MjU7CiAgICAgICAgY29uc3Qgc3AgPSAtNDdlLTYgKiB0dHQgKiBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFIC8gMzYwMDsKICAgICAgICBjb25zdCBjb3NzcCA9IE1hdGguY29zKHNwKTsKICAgICAgICBjb25zdCBzaW5zcCA9IE1hdGguc2luKHNwKTsKICAgICAgICBjb25zdCBmVG9QZk10eCA9IHJvdGF0aW9uMlNjcmF0Y2g7CiAgICAgICAgZlRvUGZNdHhbMF0gPSBjb3N4cCAqIGNvc3NwOwogICAgICAgIGZUb1BmTXR4WzFdID0gY29zeHAgKiBzaW5zcDsKICAgICAgICBmVG9QZk10eFsyXSA9IHNpbnhwOwogICAgICAgIGZUb1BmTXR4WzNdID0gLWNvc3lwICogc2luc3AgKyBzaW55cCAqIHNpbnhwICogY29zc3A7CiAgICAgICAgZlRvUGZNdHhbNF0gPSBjb3N5cCAqIGNvc3NwICsgc2lueXAgKiBzaW54cCAqIHNpbnNwOwogICAgICAgIGZUb1BmTXR4WzVdID0gLXNpbnlwICogY29zeHA7CiAgICAgICAgZlRvUGZNdHhbNl0gPSAtc2lueXAgKiBzaW5zcCAtIGNvc3lwICogc2lueHAgKiBjb3NzcDsKICAgICAgICBmVG9QZk10eFs3XSA9IHNpbnlwICogY29zc3AgLSBjb3N5cCAqIHNpbnhwICogc2luc3A7CiAgICAgICAgZlRvUGZNdHhbOF0gPSBjb3N5cCAqIGNvc3hwOwogICAgICAgIHJldHVybiBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHkocGZUb0ljcmYsIGZUb1BmTXR4LCByZXN1bHQpOwogICAgICB9OwogICAgICBwb2ludFRvV2luZG93Q29vcmRpbmF0ZXNUZW1wID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICBUcmFuc2Zvcm1zLnBvaW50VG9XaW5kb3dDb29yZGluYXRlcyA9IGZ1bmN0aW9uKG1vZGVsVmlld1Byb2plY3Rpb25NYXRyaXgsIHZpZXdwb3J0VHJhbnNmb3JtYXRpb24sIHBvaW50LCByZXN1bHQpIHsKICAgICAgICByZXN1bHQgPSBUcmFuc2Zvcm1zLnBvaW50VG9HTFdpbmRvd0Nvb3JkaW5hdGVzKAogICAgICAgICAgbW9kZWxWaWV3UHJvamVjdGlvbk1hdHJpeCwKICAgICAgICAgIHZpZXdwb3J0VHJhbnNmb3JtYXRpb24sCiAgICAgICAgICBwb2ludCwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgICAgcmVzdWx0LnkgPSAyICogdmlld3BvcnRUcmFuc2Zvcm1hdGlvbls1XSAtIHJlc3VsdC55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFRyYW5zZm9ybXMucG9pbnRUb0dMV2luZG93Q29vcmRpbmF0ZXMgPSBmdW5jdGlvbihtb2RlbFZpZXdQcm9qZWN0aW9uTWF0cml4LCB2aWV3cG9ydFRyYW5zZm9ybWF0aW9uLCBwb2ludCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobW9kZWxWaWV3UHJvamVjdGlvbk1hdHJpeCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJtb2RlbFZpZXdQcm9qZWN0aW9uTWF0cml4IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2aWV3cG9ydFRyYW5zZm9ybWF0aW9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZpZXdwb3J0VHJhbnNmb3JtYXRpb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvaW50KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBvaW50IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRtcDIgPSBwb2ludFRvV2luZG93Q29vcmRpbmF0ZXNUZW1wOwogICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgICAgbW9kZWxWaWV3UHJvamVjdGlvbk1hdHJpeCwKICAgICAgICAgIENhcnRlc2lhbjRfZGVmYXVsdC5mcm9tRWxlbWVudHMocG9pbnQueCwgcG9pbnQueSwgcG9pbnQueiwgMSwgdG1wMiksCiAgICAgICAgICB0bXAyCiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW40X2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcih0bXAyLCAxIC8gdG1wMi53LCB0bXAyKTsKICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih2aWV3cG9ydFRyYW5zZm9ybWF0aW9uLCB0bXAyLCB0bXAyKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21DYXJ0ZXNpYW40KHRtcDIsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIG5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHJpZ2h0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdXBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBUcmFuc2Zvcm1zLnJvdGF0aW9uTWF0cml4RnJvbVBvc2l0aW9uVmVsb2NpdHkgPSBmdW5jdGlvbihwb3NpdGlvbiwgdmVsb2NpdHksIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicG9zaXRpb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZlbG9jaXR5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZlbG9jaXR5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBub3JtYWwyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCkuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBub3JtYWxTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBsZXQgcmlnaHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModmVsb2NpdHksIG5vcm1hbDIsIHJpZ2h0U2NyYXRjaCk7CiAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHJpZ2h0LCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgTWF0aF9kZWZhdWx0LkVQU0lMT042KSkgewogICAgICAgICAgcmlnaHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWCwgcmlnaHQpOwogICAgICAgIH0KICAgICAgICBjb25zdCB1cCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhyaWdodCwgdmVsb2NpdHksIHVwU2NyYXRjaCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh1cCwgdXApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh2ZWxvY2l0eSwgdXAsIHJpZ2h0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHJpZ2h0LCByaWdodCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyaWdodCwgcmlnaHQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gdmVsb2NpdHkueDsKICAgICAgICByZXN1bHRbMV0gPSB2ZWxvY2l0eS55OwogICAgICAgIHJlc3VsdFsyXSA9IHZlbG9jaXR5Lno7CiAgICAgICAgcmVzdWx0WzNdID0gcmlnaHQueDsKICAgICAgICByZXN1bHRbNF0gPSByaWdodC55OwogICAgICAgIHJlc3VsdFs1XSA9IHJpZ2h0Lno7CiAgICAgICAgcmVzdWx0WzZdID0gdXAueDsKICAgICAgICByZXN1bHRbN10gPSB1cC55OwogICAgICAgIHJlc3VsdFs4XSA9IHVwLno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc3dpenpsZU1hdHJpeCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDEsCiAgICAgICAgMCwKICAgICAgICAxLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMSwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMQogICAgICApOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUHJvamVjdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFJvdGF0aW9uID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRnJvbUVOVSA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFRvRU5VID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBUcmFuc2Zvcm1zLmJhc2lzVG8yRCA9IGZ1bmN0aW9uKHByb2plY3Rpb24sIG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocHJvamVjdGlvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwcm9qZWN0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtYXRyaXgpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibWF0cml4IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVzdWx0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBydGNDZW50ZXIgPSBNYXRyaXg0X2RlZmF1bHQuZ2V0VHJhbnNsYXRpb24obWF0cml4LCBzY3JhdGNoQ2VudGVyKTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBwcm9qZWN0aW9uLmVsbGlwc29pZDsKICAgICAgICBsZXQgcHJvamVjdGVkUG9zaXRpb247CiAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMocnRjQ2VudGVyLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpIHsKICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywKICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQcm9qZWN0aW9uCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBjYXJ0b2dyYXBoaWMyID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgICBydGNDZW50ZXIsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMKICAgICAgICAgICk7CiAgICAgICAgICBwcm9qZWN0ZWRQb3NpdGlvbiA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgICAgICAgY2FydG9ncmFwaGljMiwKICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQcm9qZWN0aW9uCiAgICAgICAgICApOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21FbGVtZW50cygKICAgICAgICAgICAgcHJvamVjdGVkUG9zaXRpb24ueiwKICAgICAgICAgICAgcHJvamVjdGVkUG9zaXRpb24ueCwKICAgICAgICAgICAgcHJvamVjdGVkUG9zaXRpb24ueSwKICAgICAgICAgICAgcHJvamVjdGVkUG9zaXRpb24KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZyb21FTlUgPSBUcmFuc2Zvcm1zLmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lKAogICAgICAgICAgcnRjQ2VudGVyLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc2NyYXRjaEZyb21FTlUKICAgICAgICApOwogICAgICAgIGNvbnN0IHRvRU5VID0gTWF0cml4NF9kZWZhdWx0LmludmVyc2VUcmFuc2Zvcm1hdGlvbihmcm9tRU5VLCBzY3JhdGNoVG9FTlUpOwogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gTWF0cml4NF9kZWZhdWx0LmdldE1hdHJpeDMobWF0cml4LCBzY3JhdGNoUm90YXRpb24pOwogICAgICAgIGNvbnN0IGxvY2FsID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlNYXRyaXgzKHRvRU5VLCByb3RhdGlvbiwgcmVzdWx0KTsKICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHkoc3dpenpsZU1hdHJpeCwgbG9jYWwsIHJlc3VsdCk7CiAgICAgICAgTWF0cml4NF9kZWZhdWx0LnNldFRyYW5zbGF0aW9uKHJlc3VsdCwgcHJvamVjdGVkUG9zaXRpb24sIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgVHJhbnNmb3Jtcy53Z3M4NFRvMkRNb2RlbE1hdHJpeCA9IGZ1bmN0aW9uKHByb2plY3Rpb24sIGNlbnRlciwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocHJvamVjdGlvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwcm9qZWN0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjZW50ZXIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2VudGVyIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVzdWx0IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBwcm9qZWN0aW9uLmVsbGlwc29pZDsKICAgICAgICBjb25zdCBmcm9tRU5VID0gVHJhbnNmb3Jtcy5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZSgKICAgICAgICAgIGNlbnRlciwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2hGcm9tRU5VCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0b0VOVSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oZnJvbUVOVSwgc2NyYXRjaFRvRU5VKTsKICAgICAgICBjb25zdCBjYXJ0b2dyYXBoaWMyID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgY2VudGVyLAogICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYwogICAgICAgICk7CiAgICAgICAgY29uc3QgcHJvamVjdGVkUG9zaXRpb24gPSBwcm9qZWN0aW9uLnByb2plY3QoCiAgICAgICAgICBjYXJ0b2dyYXBoaWMyLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQcm9qZWN0aW9uCiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKAogICAgICAgICAgcHJvamVjdGVkUG9zaXRpb24ueiwKICAgICAgICAgIHByb2plY3RlZFBvc2l0aW9uLngsCiAgICAgICAgICBwcm9qZWN0ZWRQb3NpdGlvbi55LAogICAgICAgICAgcHJvamVjdGVkUG9zaXRpb24KICAgICAgICApOwogICAgICAgIGNvbnN0IHRyYW5zbGF0aW9uMiA9IE1hdHJpeDRfZGVmYXVsdC5mcm9tVHJhbnNsYXRpb24oCiAgICAgICAgICBwcm9qZWN0ZWRQb3NpdGlvbiwKICAgICAgICAgIHNjcmF0Y2hGcm9tRU5VCiAgICAgICAgKTsKICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHkoc3dpenpsZU1hdHJpeCwgdG9FTlUsIHJlc3VsdCk7CiAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5KHRyYW5zbGF0aW9uMiwgcmVzdWx0LCByZXN1bHQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFRyYW5zZm9ybXNfZGVmYXVsdCA9IFRyYW5zZm9ybXM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZWN0YW5nbGUuanMKICBmdW5jdGlvbiBSZWN0YW5nbGUod2VzdCwgc291dGgsIGVhc3QsIG5vcnRoKSB7CiAgICB0aGlzLndlc3QgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh3ZXN0LCAwKTsKICAgIHRoaXMuc291dGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzb3V0aCwgMCk7CiAgICB0aGlzLmVhc3QgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlYXN0LCAwKTsKICAgIHRoaXMubm9ydGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChub3J0aCwgMCk7CiAgfQogIHZhciBmcm9tQm91bmRpbmdTcGhlcmVNYXRyaXhTY3JhdGNoLCBmcm9tQm91bmRpbmdTcGhlcmVFYXN0U2NyYXRjaCwgZnJvbUJvdW5kaW5nU3BoZXJlTm9ydGhTY3JhdGNoLCBmcm9tQm91bmRpbmdTcGhlcmVXZXN0U2NyYXRjaCwgZnJvbUJvdW5kaW5nU3BoZXJlU291dGhTY3JhdGNoLCBmcm9tQm91bmRpbmdTcGhlcmVQb3NpdGlvbnNTY3JhdGNoLCBzdWJzYW1wbGVMbGFTY3JhdGNoLCBSZWN0YW5nbGVfZGVmYXVsdDsKICB2YXIgaW5pdF9SZWN0YW5nbGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlY3RhbmdsZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9UcmFuc2Zvcm1zKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhSZWN0YW5nbGUucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgd2lkdGggb2YgdGhlIHJlY3RhbmdsZSBpbiByYWRpYW5zLgogICAgICAgICAqIEBtZW1iZXJvZiBSZWN0YW5nbGUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICB3aWR0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIFJlY3RhbmdsZS5jb21wdXRlV2lkdGgodGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBoZWlnaHQgb2YgdGhlIHJlY3RhbmdsZSBpbiByYWRpYW5zLgogICAgICAgICAqIEBtZW1iZXJvZiBSZWN0YW5nbGUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBoZWlnaHQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBSZWN0YW5nbGUuY29tcHV0ZUhlaWdodCh0aGlzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBSZWN0YW5nbGUucGFja2VkTGVuZ3RoID0gNDsKICAgICAgUmVjdGFuZ2xlLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS53ZXN0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5zb3V0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuZWFzdDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLm5vcnRoOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuc291dGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5lYXN0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQubm9ydGggPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuY29tcHV0ZVdpZHRoID0gZnVuY3Rpb24ocmVjdGFuZ2xlKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGxldCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIGlmIChlYXN0IDwgd2VzdCkgewogICAgICAgICAgZWFzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZWFzdCAtIHdlc3Q7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5jb21wdXRlSGVpZ2h0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIHJldHVybiByZWN0YW5nbGUubm9ydGggLSByZWN0YW5nbGUuc291dGg7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5mcm9tRGVncmVlcyA9IGZ1bmN0aW9uKHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCwgcmVzdWx0KSB7CiAgICAgICAgd2VzdCA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoZGVmYXVsdFZhbHVlX2RlZmF1bHQod2VzdCwgMCkpOwogICAgICAgIHNvdXRoID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhkZWZhdWx0VmFsdWVfZGVmYXVsdChzb3V0aCwgMCkpOwogICAgICAgIGVhc3QgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVhc3QsIDApKTsKICAgICAgICBub3J0aCA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoZGVmYXVsdFZhbHVlX2RlZmF1bHQobm9ydGgsIDApKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFJlY3RhbmdsZSh3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IHdlc3Q7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gc291dGg7CiAgICAgICAgcmVzdWx0LmVhc3QgPSBlYXN0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IG5vcnRoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5mcm9tUmFkaWFucyA9IGZ1bmN0aW9uKHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGUod2VzdCwgc291dGgsIGVhc3QsIG5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh3ZXN0LCAwKTsKICAgICAgICByZXN1bHQuc291dGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzb3V0aCwgMCk7CiAgICAgICAgcmVzdWx0LmVhc3QgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlYXN0LCAwKTsKICAgICAgICByZXN1bHQubm9ydGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChub3J0aCwgMCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLmZyb21DYXJ0b2dyYXBoaWNBcnJheSA9IGZ1bmN0aW9uKGNhcnRvZ3JhcGhpY3MsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydG9ncmFwaGljcyIsIGNhcnRvZ3JhcGhpY3MpOwogICAgICAgIGxldCB3ZXN0ID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgZWFzdCA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCB3ZXN0T3ZlcklETCA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IGVhc3RPdmVySURMID0gLU51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IHNvdXRoID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgbm9ydGggPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gY2FydG9ncmFwaGljcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBjYXJ0b2dyYXBoaWNzW2ldOwogICAgICAgICAgd2VzdCA9IE1hdGgubWluKHdlc3QsIHBvc2l0aW9uLmxvbmdpdHVkZSk7CiAgICAgICAgICBlYXN0ID0gTWF0aC5tYXgoZWFzdCwgcG9zaXRpb24ubG9uZ2l0dWRlKTsKICAgICAgICAgIHNvdXRoID0gTWF0aC5taW4oc291dGgsIHBvc2l0aW9uLmxhdGl0dWRlKTsKICAgICAgICAgIG5vcnRoID0gTWF0aC5tYXgobm9ydGgsIHBvc2l0aW9uLmxhdGl0dWRlKTsKICAgICAgICAgIGNvbnN0IGxvbkFkanVzdGVkID0gcG9zaXRpb24ubG9uZ2l0dWRlID49IDAgPyBwb3NpdGlvbi5sb25naXR1ZGUgOiBwb3NpdGlvbi5sb25naXR1ZGUgKyBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgd2VzdE92ZXJJREwgPSBNYXRoLm1pbih3ZXN0T3ZlcklETCwgbG9uQWRqdXN0ZWQpOwogICAgICAgICAgZWFzdE92ZXJJREwgPSBNYXRoLm1heChlYXN0T3ZlcklETCwgbG9uQWRqdXN0ZWQpOwogICAgICAgIH0KICAgICAgICBpZiAoZWFzdCAtIHdlc3QgPiBlYXN0T3ZlcklETCAtIHdlc3RPdmVySURMKSB7CiAgICAgICAgICB3ZXN0ID0gd2VzdE92ZXJJREw7CiAgICAgICAgICBlYXN0ID0gZWFzdE92ZXJJREw7CiAgICAgICAgICBpZiAoZWFzdCA+IE1hdGhfZGVmYXVsdC5QSSkgewogICAgICAgICAgICBlYXN0ID0gZWFzdCAtIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod2VzdCA+IE1hdGhfZGVmYXVsdC5QSSkgewogICAgICAgICAgICB3ZXN0ID0gd2VzdCAtIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlKHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gd2VzdDsKICAgICAgICByZXN1bHQuc291dGggPSBzb3V0aDsKICAgICAgICByZXN1bHQuZWFzdCA9IGVhc3Q7CiAgICAgICAgcmVzdWx0Lm5vcnRoID0gbm9ydGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLmZyb21DYXJ0ZXNpYW5BcnJheSA9IGZ1bmN0aW9uKGNhcnRlc2lhbnMsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW5zIiwgY2FydGVzaWFucyk7CiAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgbGV0IHdlc3QgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCBlYXN0ID0gLU51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IHdlc3RPdmVySURMID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgZWFzdE92ZXJJREwgPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgc291dGggPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCBub3J0aCA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBjYXJ0ZXNpYW5zLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwb3NpdGlvbiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhjYXJ0ZXNpYW5zW2ldKTsKICAgICAgICAgIHdlc3QgPSBNYXRoLm1pbih3ZXN0LCBwb3NpdGlvbi5sb25naXR1ZGUpOwogICAgICAgICAgZWFzdCA9IE1hdGgubWF4KGVhc3QsIHBvc2l0aW9uLmxvbmdpdHVkZSk7CiAgICAgICAgICBzb3V0aCA9IE1hdGgubWluKHNvdXRoLCBwb3NpdGlvbi5sYXRpdHVkZSk7CiAgICAgICAgICBub3J0aCA9IE1hdGgubWF4KG5vcnRoLCBwb3NpdGlvbi5sYXRpdHVkZSk7CiAgICAgICAgICBjb25zdCBsb25BZGp1c3RlZCA9IHBvc2l0aW9uLmxvbmdpdHVkZSA+PSAwID8gcG9zaXRpb24ubG9uZ2l0dWRlIDogcG9zaXRpb24ubG9uZ2l0dWRlICsgTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIHdlc3RPdmVySURMID0gTWF0aC5taW4od2VzdE92ZXJJREwsIGxvbkFkanVzdGVkKTsKICAgICAgICAgIGVhc3RPdmVySURMID0gTWF0aC5tYXgoZWFzdE92ZXJJREwsIGxvbkFkanVzdGVkKTsKICAgICAgICB9CiAgICAgICAgaWYgKGVhc3QgLSB3ZXN0ID4gZWFzdE92ZXJJREwgLSB3ZXN0T3ZlcklETCkgewogICAgICAgICAgd2VzdCA9IHdlc3RPdmVySURMOwogICAgICAgICAgZWFzdCA9IGVhc3RPdmVySURMOwogICAgICAgICAgaWYgKGVhc3QgPiBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICAgICAgZWFzdCA9IGVhc3QgLSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdlc3QgPiBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgICAgICAgd2VzdCA9IHdlc3QgLSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFJlY3RhbmdsZSh3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IHdlc3Q7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gc291dGg7CiAgICAgICAgcmVzdWx0LmVhc3QgPSBlYXN0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IG5vcnRoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGZyb21Cb3VuZGluZ1NwaGVyZU1hdHJpeFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Cb3VuZGluZ1NwaGVyZUVhc3RTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tQm91bmRpbmdTcGhlcmVOb3J0aFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Cb3VuZGluZ1NwaGVyZVdlc3RTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tQm91bmRpbmdTcGhlcmVTb3V0aFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Cb3VuZGluZ1NwaGVyZVBvc2l0aW9uc1NjcmF0Y2ggPSBuZXcgQXJyYXkoNSk7CiAgICAgIGZvciAobGV0IG4gPSAwOyBuIDwgZnJvbUJvdW5kaW5nU3BoZXJlUG9zaXRpb25zU2NyYXRjaC5sZW5ndGg7ICsrbikgewogICAgICAgIGZyb21Cb3VuZGluZ1NwaGVyZVBvc2l0aW9uc1NjcmF0Y2hbbl0gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIH0KICAgICAgUmVjdGFuZ2xlLmZyb21Cb3VuZGluZ1NwaGVyZSA9IGZ1bmN0aW9uKGJvdW5kaW5nU3BoZXJlLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiYm91bmRpbmdTcGhlcmUiLCBib3VuZGluZ1NwaGVyZSk7CiAgICAgICAgY29uc3QgY2VudGVyID0gYm91bmRpbmdTcGhlcmUuY2VudGVyOwogICAgICAgIGNvbnN0IHJhZGl1cyA9IGJvdW5kaW5nU3BoZXJlLnJhZGl1czsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpKSB7CiAgICAgICAgICBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFJlY3RhbmdsZSgpOwogICAgICAgIH0KICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhjZW50ZXIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICAgICAgUmVjdGFuZ2xlLmNsb25lKFJlY3RhbmdsZS5NQVhfVkFMVUUsIHJlc3VsdCk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjb25zdCBmcm9tRU5VID0gVHJhbnNmb3Jtc19kZWZhdWx0LmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lKAogICAgICAgICAgY2VudGVyLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgZnJvbUJvdW5kaW5nU3BoZXJlTWF0cml4U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgZWFzdCA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnRBc1ZlY3RvcigKICAgICAgICAgIGZyb21FTlUsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLAogICAgICAgICAgZnJvbUJvdW5kaW5nU3BoZXJlRWFzdFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZWFzdCwgZWFzdCk7CiAgICAgICAgY29uc3Qgbm9ydGggPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50QXNWZWN0b3IoCiAgICAgICAgICBmcm9tRU5VLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWSwKICAgICAgICAgIGZyb21Cb3VuZGluZ1NwaGVyZU5vcnRoU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3J0aCwgbm9ydGgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG5vcnRoLCByYWRpdXMsIG5vcnRoKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihlYXN0LCByYWRpdXMsIGVhc3QpOwogICAgICAgIGNvbnN0IHNvdXRoID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShub3J0aCwgZnJvbUJvdW5kaW5nU3BoZXJlU291dGhTY3JhdGNoKTsKICAgICAgICBjb25zdCB3ZXN0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShlYXN0LCBmcm9tQm91bmRpbmdTcGhlcmVXZXN0U2NyYXRjaCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gZnJvbUJvdW5kaW5nU3BoZXJlUG9zaXRpb25zU2NyYXRjaDsKICAgICAgICBsZXQgY29ybmVyID0gcG9zaXRpb25zWzBdOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2VudGVyLCBub3J0aCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbMV07CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIHdlc3QsIGNvcm5lcik7CiAgICAgICAgY29ybmVyID0gcG9zaXRpb25zWzJdOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2VudGVyLCBzb3V0aCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbM107CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIGVhc3QsIGNvcm5lcik7CiAgICAgICAgcG9zaXRpb25zWzRdID0gY2VudGVyOwogICAgICAgIHJldHVybiBSZWN0YW5nbGUuZnJvbUNhcnRlc2lhbkFycmF5KHBvc2l0aW9ucywgZWxsaXBzb2lkLCByZXN1bHQpOwogICAgICB9OwogICAgICBSZWN0YW5nbGUuY2xvbmUgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlKAogICAgICAgICAgICByZWN0YW5nbGUud2VzdCwKICAgICAgICAgICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgICAgICAgICByZWN0YW5nbGUuZWFzdCwKICAgICAgICAgICAgcmVjdGFuZ2xlLm5vcnRoCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICByZXN1bHQuZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICBhYnNvbHV0ZUVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChhYnNvbHV0ZUVwc2lsb24sIDApOwogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBNYXRoLmFicyhsZWZ0Lndlc3QgLSByaWdodC53ZXN0KSA8PSBhYnNvbHV0ZUVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC5zb3V0aCAtIHJpZ2h0LnNvdXRoKSA8PSBhYnNvbHV0ZUVwc2lsb24gJiYgTWF0aC5hYnMobGVmdC5lYXN0IC0gcmlnaHQuZWFzdCkgPD0gYWJzb2x1dGVFcHNpbG9uICYmIE1hdGguYWJzKGxlZnQubm9ydGggLSByaWdodC5ub3J0aCkgPD0gYWJzb2x1dGVFcHNpbG9uOwogICAgICB9OwogICAgICBSZWN0YW5nbGUucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIFJlY3RhbmdsZS5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBSZWN0YW5nbGUucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIFJlY3RhbmdsZS5lcXVhbHModGhpcywgb3RoZXIpOwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdC53ZXN0ID09PSByaWdodC53ZXN0ICYmIGxlZnQuc291dGggPT09IHJpZ2h0LnNvdXRoICYmIGxlZnQuZWFzdCA9PT0gcmlnaHQuZWFzdCAmJiBsZWZ0Lm5vcnRoID09PSByaWdodC5ub3J0aDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ob3RoZXIsIGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gUmVjdGFuZ2xlLmVxdWFsc0Vwc2lsb24odGhpcywgb3RoZXIsIGVwc2lsb24pOwogICAgICB9OwogICAgICBSZWN0YW5nbGUudmFsaWRhdGUgPSBmdW5jdGlvbihyZWN0YW5nbGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgY29uc3Qgbm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoCiAgICAgICAgICAibm9ydGgiLAogICAgICAgICAgbm9ydGgsCiAgICAgICAgICAtTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPCiAgICAgICAgKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygibm9ydGgiLCBub3J0aCwgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPKTsKICAgICAgICBjb25zdCBzb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygKICAgICAgICAgICJzb3V0aCIsCiAgICAgICAgICBzb3V0aCwKICAgICAgICAgIC1NYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08KICAgICAgICApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJzb3V0aCIsIHNvdXRoLCBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08pOwogICAgICAgIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygid2VzdCIsIHdlc3QsIC1NYXRoLlBJKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygid2VzdCIsIHdlc3QsIE1hdGguUEkpOwogICAgICAgIGNvbnN0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZWFzdCIsIGVhc3QsIC1NYXRoLlBJKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiZWFzdCIsIGVhc3QsIE1hdGguUEkpOwogICAgICB9OwogICAgICBSZWN0YW5nbGUuc291dGh3ZXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChyZWN0YW5nbGUud2VzdCwgcmVjdGFuZ2xlLnNvdXRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUubm9ydGh3ZXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChyZWN0YW5nbGUud2VzdCwgcmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUubm9ydGhlYXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChyZWN0YW5nbGUuZWFzdCwgcmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuc291dGhlYXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChyZWN0YW5nbGUuZWFzdCwgcmVjdGFuZ2xlLnNvdXRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuY2VudGVyID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgbGV0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgICAgICBjb25zdCB3ZXN0ID0gcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgaWYgKGVhc3QgPCB3ZXN0KSB7CiAgICAgICAgICBlYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaSgod2VzdCArIGVhc3QpICogMC41KTsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IChyZWN0YW5nbGUuc291dGggKyByZWN0YW5nbGUubm9ydGgpICogMC41OwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQobG9uZ2l0dWRlLCBsYXRpdHVkZSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgb3RoZXJSZWN0YW5nbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm90aGVyUmVjdGFuZ2xlIiwgb3RoZXJSZWN0YW5nbGUpOwogICAgICAgIGxldCByZWN0YW5nbGVFYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgbGV0IHJlY3RhbmdsZVdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICBsZXQgb3RoZXJSZWN0YW5nbGVFYXN0ID0gb3RoZXJSZWN0YW5nbGUuZWFzdDsKICAgICAgICBsZXQgb3RoZXJSZWN0YW5nbGVXZXN0ID0gb3RoZXJSZWN0YW5nbGUud2VzdDsKICAgICAgICBpZiAocmVjdGFuZ2xlRWFzdCA8IHJlY3RhbmdsZVdlc3QgJiYgb3RoZXJSZWN0YW5nbGVFYXN0ID4gMCkgewogICAgICAgICAgcmVjdGFuZ2xlRWFzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0gZWxzZSBpZiAob3RoZXJSZWN0YW5nbGVFYXN0IDwgb3RoZXJSZWN0YW5nbGVXZXN0ICYmIHJlY3RhbmdsZUVhc3QgPiAwKSB7CiAgICAgICAgICBvdGhlclJlY3RhbmdsZUVhc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlY3RhbmdsZUVhc3QgPCByZWN0YW5nbGVXZXN0ICYmIG90aGVyUmVjdGFuZ2xlV2VzdCA8IDApIHsKICAgICAgICAgIG90aGVyUmVjdGFuZ2xlV2VzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0gZWxzZSBpZiAob3RoZXJSZWN0YW5nbGVFYXN0IDwgb3RoZXJSZWN0YW5nbGVXZXN0ICYmIHJlY3RhbmdsZVdlc3QgPCAwKSB7CiAgICAgICAgICByZWN0YW5nbGVXZXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHdlc3QgPSBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoCiAgICAgICAgICBNYXRoLm1heChyZWN0YW5nbGVXZXN0LCBvdGhlclJlY3RhbmdsZVdlc3QpCiAgICAgICAgKTsKICAgICAgICBjb25zdCBlYXN0ID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKAogICAgICAgICAgTWF0aC5taW4ocmVjdGFuZ2xlRWFzdCwgb3RoZXJSZWN0YW5nbGVFYXN0KQogICAgICAgICk7CiAgICAgICAgaWYgKChyZWN0YW5nbGUud2VzdCA8IHJlY3RhbmdsZS5lYXN0IHx8IG90aGVyUmVjdGFuZ2xlLndlc3QgPCBvdGhlclJlY3RhbmdsZS5lYXN0KSAmJiBlYXN0IDw9IHdlc3QpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNvdXRoID0gTWF0aC5tYXgocmVjdGFuZ2xlLnNvdXRoLCBvdGhlclJlY3RhbmdsZS5zb3V0aCk7CiAgICAgICAgY29uc3Qgbm9ydGggPSBNYXRoLm1pbihyZWN0YW5nbGUubm9ydGgsIG90aGVyUmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgICBpZiAoc291dGggPj0gbm9ydGgpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlKHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gd2VzdDsKICAgICAgICByZXN1bHQuc291dGggPSBzb3V0aDsKICAgICAgICByZXN1bHQuZWFzdCA9IGVhc3Q7CiAgICAgICAgcmVzdWx0Lm5vcnRoID0gbm9ydGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlLnNpbXBsZUludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgb3RoZXJSZWN0YW5nbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm90aGVyUmVjdGFuZ2xlIiwgb3RoZXJSZWN0YW5nbGUpOwogICAgICAgIGNvbnN0IHdlc3QgPSBNYXRoLm1heChyZWN0YW5nbGUud2VzdCwgb3RoZXJSZWN0YW5nbGUud2VzdCk7CiAgICAgICAgY29uc3Qgc291dGggPSBNYXRoLm1heChyZWN0YW5nbGUuc291dGgsIG90aGVyUmVjdGFuZ2xlLnNvdXRoKTsKICAgICAgICBjb25zdCBlYXN0ID0gTWF0aC5taW4ocmVjdGFuZ2xlLmVhc3QsIG90aGVyUmVjdGFuZ2xlLmVhc3QpOwogICAgICAgIGNvbnN0IG5vcnRoID0gTWF0aC5taW4ocmVjdGFuZ2xlLm5vcnRoLCBvdGhlclJlY3RhbmdsZS5ub3J0aCk7CiAgICAgICAgaWYgKHNvdXRoID49IG5vcnRoIHx8IHdlc3QgPj0gZWFzdCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGUod2VzdCwgc291dGgsIGVhc3QsIG5vcnRoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IHNvdXRoOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZWFzdDsKICAgICAgICByZXN1bHQubm9ydGggPSBub3J0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUudW5pb24gPSBmdW5jdGlvbihyZWN0YW5nbGUsIG90aGVyUmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvdGhlclJlY3RhbmdsZSIsIG90aGVyUmVjdGFuZ2xlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIGxldCByZWN0YW5nbGVFYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgbGV0IHJlY3RhbmdsZVdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICBsZXQgb3RoZXJSZWN0YW5nbGVFYXN0ID0gb3RoZXJSZWN0YW5nbGUuZWFzdDsKICAgICAgICBsZXQgb3RoZXJSZWN0YW5nbGVXZXN0ID0gb3RoZXJSZWN0YW5nbGUud2VzdDsKICAgICAgICBpZiAocmVjdGFuZ2xlRWFzdCA8IHJlY3RhbmdsZVdlc3QgJiYgb3RoZXJSZWN0YW5nbGVFYXN0ID4gMCkgewogICAgICAgICAgcmVjdGFuZ2xlRWFzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0gZWxzZSBpZiAob3RoZXJSZWN0YW5nbGVFYXN0IDwgb3RoZXJSZWN0YW5nbGVXZXN0ICYmIHJlY3RhbmdsZUVhc3QgPiAwKSB7CiAgICAgICAgICBvdGhlclJlY3RhbmdsZUVhc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlY3RhbmdsZUVhc3QgPCByZWN0YW5nbGVXZXN0ICYmIG90aGVyUmVjdGFuZ2xlV2VzdCA8IDApIHsKICAgICAgICAgIG90aGVyUmVjdGFuZ2xlV2VzdCArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgIH0gZWxzZSBpZiAob3RoZXJSZWN0YW5nbGVFYXN0IDwgb3RoZXJSZWN0YW5nbGVXZXN0ICYmIHJlY3RhbmdsZVdlc3QgPCAwKSB7CiAgICAgICAgICByZWN0YW5nbGVXZXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHdlc3QgPSBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoCiAgICAgICAgICBNYXRoLm1pbihyZWN0YW5nbGVXZXN0LCBvdGhlclJlY3RhbmdsZVdlc3QpCiAgICAgICAgKTsKICAgICAgICBjb25zdCBlYXN0ID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKAogICAgICAgICAgTWF0aC5tYXgocmVjdGFuZ2xlRWFzdCwgb3RoZXJSZWN0YW5nbGVFYXN0KQogICAgICAgICk7CiAgICAgICAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogICAgICAgIHJlc3VsdC5zb3V0aCA9IE1hdGgubWluKHJlY3RhbmdsZS5zb3V0aCwgb3RoZXJSZWN0YW5nbGUuc291dGgpOwogICAgICAgIHJlc3VsdC5lYXN0ID0gZWFzdDsKICAgICAgICByZXN1bHQubm9ydGggPSBNYXRoLm1heChyZWN0YW5nbGUubm9ydGgsIG90aGVyUmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBSZWN0YW5nbGUuZXhwYW5kID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBjYXJ0b2dyYXBoaWMyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJjYXJ0b2dyYXBoaWMiLCBjYXJ0b2dyYXBoaWMyKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gTWF0aC5taW4ocmVjdGFuZ2xlLndlc3QsIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlKTsKICAgICAgICByZXN1bHQuc291dGggPSBNYXRoLm1pbihyZWN0YW5nbGUuc291dGgsIGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUpOwogICAgICAgIHJlc3VsdC5lYXN0ID0gTWF0aC5tYXgocmVjdGFuZ2xlLmVhc3QsIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlKTsKICAgICAgICByZXN1bHQubm9ydGggPSBNYXRoLm1heChyZWN0YW5nbGUubm9ydGgsIGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5jb250YWlucyA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgY2FydG9ncmFwaGljMikgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRvZ3JhcGhpYyIsIGNhcnRvZ3JhcGhpYzIpOwogICAgICAgIGxldCBsb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZTsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGU7CiAgICAgICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIGxldCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgaWYgKGVhc3QgPCB3ZXN0KSB7CiAgICAgICAgICBlYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICBpZiAobG9uZ2l0dWRlIDwgMCkgewogICAgICAgICAgICBsb25naXR1ZGUgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIChsb25naXR1ZGUgPiB3ZXN0IHx8IE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGxvbmdpdHVkZSwgd2VzdCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkpICYmIChsb25naXR1ZGUgPCBlYXN0IHx8IE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGxvbmdpdHVkZSwgZWFzdCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkpICYmIGxhdGl0dWRlID49IHJlY3RhbmdsZS5zb3V0aCAmJiBsYXRpdHVkZSA8PSByZWN0YW5nbGUubm9ydGg7CiAgICAgIH07CiAgICAgIHN1YnNhbXBsZUxsYVNjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgUmVjdGFuZ2xlLnN1YnNhbXBsZSA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgZWxsaXBzb2lkLCBzdXJmYWNlSGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgc3VyZmFjZUhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN1cmZhY2VIZWlnaHQsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgIH0KICAgICAgICBsZXQgbGVuZ3RoID0gMDsKICAgICAgICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgICBjb25zdCBzb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICBjb25zdCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgICAgIGNvbnN0IGxsYSA9IHN1YnNhbXBsZUxsYVNjcmF0Y2g7CiAgICAgICAgbGxhLmhlaWdodCA9IHN1cmZhY2VIZWlnaHQ7CiAgICAgICAgbGxhLmxvbmdpdHVkZSA9IHdlc3Q7CiAgICAgICAgbGxhLmxhdGl0dWRlID0gbm9ydGg7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgbGxhLmxvbmdpdHVkZSA9IGVhc3Q7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgbGxhLmxhdGl0dWRlID0gc291dGg7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgbGxhLmxvbmdpdHVkZSA9IHdlc3Q7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4obGxhLCByZXN1bHRbbGVuZ3RoXSk7CiAgICAgICAgbGVuZ3RoKys7CiAgICAgICAgaWYgKG5vcnRoIDwgMCkgewogICAgICAgICAgbGxhLmxhdGl0dWRlID0gbm9ydGg7CiAgICAgICAgfSBlbHNlIGlmIChzb3V0aCA+IDApIHsKICAgICAgICAgIGxsYS5sYXRpdHVkZSA9IHNvdXRoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsbGEubGF0aXR1ZGUgPSAwOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IDg7ICsraSkgewogICAgICAgICAgbGxhLmxvbmdpdHVkZSA9IC1NYXRoLlBJICsgaSAqIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICAgIGlmIChSZWN0YW5nbGUuY29udGFpbnMocmVjdGFuZ2xlLCBsbGEpKSB7CiAgICAgICAgICAgIHJlc3VsdFtsZW5ndGhdID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGxsYSwgcmVzdWx0W2xlbmd0aF0pOwogICAgICAgICAgICBsZW5ndGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGxsYS5sYXRpdHVkZSA9PT0gMCkgewogICAgICAgICAgbGxhLmxvbmdpdHVkZSA9IHdlc3Q7CiAgICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihsbGEsIHJlc3VsdFtsZW5ndGhdKTsKICAgICAgICAgIGxlbmd0aCsrOwogICAgICAgICAgbGxhLmxvbmdpdHVkZSA9IGVhc3Q7CiAgICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihsbGEsIHJlc3VsdFtsZW5ndGhdKTsKICAgICAgICAgIGxlbmd0aCsrOwogICAgICAgIH0KICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5zdWJzZWN0aW9uID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCB3ZXN0TGVycCwgc291dGhMZXJwLCBlYXN0TGVycCwgbm9ydGhMZXJwLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIndlc3RMZXJwIiwgd2VzdExlcnAsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJ3ZXN0TGVycCIsIHdlc3RMZXJwLCAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygic291dGhMZXJwIiwgc291dGhMZXJwLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygic291dGhMZXJwIiwgc291dGhMZXJwLCAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiZWFzdExlcnAiLCBlYXN0TGVycCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImVhc3RMZXJwIiwgZWFzdExlcnAsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJub3J0aExlcnAiLCBub3J0aExlcnAsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJub3J0aExlcnAiLCBub3J0aExlcnAsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJ3ZXN0TGVycCIsIHdlc3RMZXJwLCBlYXN0TGVycCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoInNvdXRoTGVycCIsIHNvdXRoTGVycCwgbm9ydGhMZXJwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIGlmIChyZWN0YW5nbGUud2VzdCA8PSByZWN0YW5nbGUuZWFzdCkgewogICAgICAgICAgY29uc3Qgd2lkdGggPSByZWN0YW5nbGUuZWFzdCAtIHJlY3RhbmdsZS53ZXN0OwogICAgICAgICAgcmVzdWx0Lndlc3QgPSByZWN0YW5nbGUud2VzdCArIHdlc3RMZXJwICogd2lkdGg7CiAgICAgICAgICByZXN1bHQuZWFzdCA9IHJlY3RhbmdsZS53ZXN0ICsgZWFzdExlcnAgKiB3aWR0aDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3Qgd2lkdGggPSBNYXRoX2RlZmF1bHQuVFdPX1BJICsgcmVjdGFuZ2xlLmVhc3QgLSByZWN0YW5nbGUud2VzdDsKICAgICAgICAgIHJlc3VsdC53ZXN0ID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKHJlY3RhbmdsZS53ZXN0ICsgd2VzdExlcnAgKiB3aWR0aCk7CiAgICAgICAgICByZXN1bHQuZWFzdCA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShyZWN0YW5nbGUud2VzdCArIGVhc3RMZXJwICogd2lkdGgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBoZWlnaHQgPSByZWN0YW5nbGUubm9ydGggLSByZWN0YW5nbGUuc291dGg7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoICsgc291dGhMZXJwICogaGVpZ2h0OwogICAgICAgIHJlc3VsdC5ub3J0aCA9IHJlY3RhbmdsZS5zb3V0aCArIG5vcnRoTGVycCAqIGhlaWdodDsKICAgICAgICBpZiAod2VzdExlcnAgPT09IDEpIHsKICAgICAgICAgIHJlc3VsdC53ZXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgfQogICAgICAgIGlmIChlYXN0TGVycCA9PT0gMSkgewogICAgICAgICAgcmVzdWx0LmVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgICAgICB9CiAgICAgICAgaWYgKHNvdXRoTGVycCA9PT0gMSkgewogICAgICAgICAgcmVzdWx0LnNvdXRoID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgICAgIH0KICAgICAgICBpZiAobm9ydGhMZXJwID09PSAxKSB7CiAgICAgICAgICByZXN1bHQubm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZS5NQVhfVkFMVUUgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBSZWN0YW5nbGUoCiAgICAgICAgICAtTWF0aC5QSSwKICAgICAgICAgIC1NYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08sCiAgICAgICAgICBNYXRoLlBJLAogICAgICAgICAgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPCiAgICAgICAgKQogICAgICApOwogICAgICBSZWN0YW5nbGVfZGVmYXVsdCA9IFJlY3RhbmdsZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0JvdW5kaW5nU3BoZXJlLmpzCiAgZnVuY3Rpb24gQm91bmRpbmdTcGhlcmUoY2VudGVyLCByYWRpdXMpIHsKICAgIHRoaXMuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNlbnRlciwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKTsKICAgIHRoaXMucmFkaXVzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocmFkaXVzLCAwKTsKICB9CiAgdmFyIGZyb21Qb2ludHNYTWluLCBmcm9tUG9pbnRzWU1pbiwgZnJvbVBvaW50c1pNaW4sIGZyb21Qb2ludHNYTWF4LCBmcm9tUG9pbnRzWU1heCwgZnJvbVBvaW50c1pNYXgsIGZyb21Qb2ludHNDdXJyZW50UG9zLCBmcm9tUG9pbnRzU2NyYXRjaCwgZnJvbVBvaW50c1JpdHRlckNlbnRlciwgZnJvbVBvaW50c01pbkJveFB0LCBmcm9tUG9pbnRzTWF4Qm94UHQsIGZyb21Qb2ludHNOYWl2ZUNlbnRlclNjcmF0Y2gsIHZvbHVtZUNvbnN0YW50LCBkZWZhdWx0UHJvamVjdGlvbiwgZnJvbVJlY3RhbmdsZTJETG93ZXJMZWZ0LCBmcm9tUmVjdGFuZ2xlMkRVcHBlclJpZ2h0LCBmcm9tUmVjdGFuZ2xlMkRTb3V0aHdlc3QsIGZyb21SZWN0YW5nbGUyRE5vcnRoZWFzdCwgZnJvbVJlY3RhbmdsZTNEU2NyYXRjaCwgZnJvbUJvdW5kaW5nU3BoZXJlc1NjcmF0Y2gsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFUsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFYsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFcsIHNjcmF0Y2hGcm9tVHJhbnNmb3JtYXRpb25DZW50ZXIsIHNjcmF0Y2hGcm9tVHJhbnNmb3JtYXRpb25TY2FsZSwgdW5pb25TY3JhdGNoLCB1bmlvblNjcmF0Y2hDZW50ZXIsIGV4cGFuZFNjcmF0Y2gsIGRpc3RhbmNlU3F1YXJlZFRvU2NyYXRjaCwgc2NyYXRjaENhcnRlc2lhbjMsIHByb2plY3RUbzJETm9ybWFsU2NyYXRjaCwgcHJvamVjdFRvMkRFYXN0U2NyYXRjaCwgcHJvamVjdFRvMkROb3J0aFNjcmF0Y2gsIHByb2plY3RUbzJEV2VzdFNjcmF0Y2gsIHByb2plY3RUbzJEU291dGhTY3JhdGNoLCBwcm9qZWN0VG8yRENhcnRvZ3JhcGhpY1NjcmF0Y2gsIHByb2plY3RUbzJEUG9zaXRpb25zU2NyYXRjaCwgcHJvamVjdFRvMkRQcm9qZWN0aW9uLCBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0OwogIHZhciBpbml0X0JvdW5kaW5nU3BoZXJlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Cb3VuZGluZ1NwaGVyZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0KCk7CiAgICAgIGluaXRfSW50ZXJ2YWwoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgZnJvbVBvaW50c1hNaW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNZTWluID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzWk1pbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbVBvaW50c1hNYXggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNZTWF4ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzWk1heCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbVBvaW50c0N1cnJlbnRQb3MgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzUml0dGVyQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUG9pbnRzTWluQm94UHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZyb21Qb2ludHNNYXhCb3hQdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJvbVBvaW50c05haXZlQ2VudGVyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdm9sdW1lQ29uc3RhbnQgPSA0IC8gMyAqIE1hdGhfZGVmYXVsdC5QSTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbVBvaW50cyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGN1cnJlbnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb25zWzBdLCBmcm9tUG9pbnRzQ3VycmVudFBvcyk7CiAgICAgICAgY29uc3QgeE1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1pbik7CiAgICAgICAgY29uc3QgeU1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1pbik7CiAgICAgICAgY29uc3Qgek1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1pbik7CiAgICAgICAgY29uc3QgeE1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1heCk7CiAgICAgICAgY29uc3QgeU1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1heCk7CiAgICAgICAgY29uc3Qgek1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1heCk7CiAgICAgICAgY29uc3QgbnVtUG9zaXRpb25zID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbnVtUG9zaXRpb25zOyBpKyspIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbaV0sIGN1cnJlbnRQb3MpOwogICAgICAgICAgY29uc3QgeCA9IGN1cnJlbnRQb3MueDsKICAgICAgICAgIGNvbnN0IHkgPSBjdXJyZW50UG9zLnk7CiAgICAgICAgICBjb25zdCB6ID0gY3VycmVudFBvcy56OwogICAgICAgICAgaWYgKHggPCB4TWluLngpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHhNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHggPiB4TWF4LngpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHhNYXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHkgPCB5TWluLnkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHlNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHkgPiB5TWF4LnkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHlNYXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHogPCB6TWluLnopIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHpNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHogPiB6TWF4LnopIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHpNYXgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB4U3BhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHhNYXgsIHhNaW4sIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgY29uc3QgeVNwYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh5TWF4LCB5TWluLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGNvbnN0IHpTcGFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qoek1heCwgek1pbiwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBsZXQgZGlhbWV0ZXIxID0geE1pbjsKICAgICAgICBsZXQgZGlhbWV0ZXIyID0geE1heDsKICAgICAgICBsZXQgbWF4U3BhbiA9IHhTcGFuOwogICAgICAgIGlmICh5U3BhbiA+IG1heFNwYW4pIHsKICAgICAgICAgIG1heFNwYW4gPSB5U3BhbjsKICAgICAgICAgIGRpYW1ldGVyMSA9IHlNaW47CiAgICAgICAgICBkaWFtZXRlcjIgPSB5TWF4OwogICAgICAgIH0KICAgICAgICBpZiAoelNwYW4gPiBtYXhTcGFuKSB7CiAgICAgICAgICBtYXhTcGFuID0gelNwYW47CiAgICAgICAgICBkaWFtZXRlcjEgPSB6TWluOwogICAgICAgICAgZGlhbWV0ZXIyID0gek1heDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgcml0dGVyQ2VudGVyID0gZnJvbVBvaW50c1JpdHRlckNlbnRlcjsKICAgICAgICByaXR0ZXJDZW50ZXIueCA9IChkaWFtZXRlcjEueCArIGRpYW1ldGVyMi54KSAqIDAuNTsKICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChkaWFtZXRlcjEueSArIGRpYW1ldGVyMi55KSAqIDAuNTsKICAgICAgICByaXR0ZXJDZW50ZXIueiA9IChkaWFtZXRlcjEueiArIGRpYW1ldGVyMi56KSAqIDAuNTsKICAgICAgICBsZXQgcmFkaXVzU3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGRpYW1ldGVyMiwgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGxldCByaXR0ZXJSYWRpdXMgPSBNYXRoLnNxcnQocmFkaXVzU3F1YXJlZCk7CiAgICAgICAgY29uc3QgbWluQm94UHQgPSBmcm9tUG9pbnRzTWluQm94UHQ7CiAgICAgICAgbWluQm94UHQueCA9IHhNaW4ueDsKICAgICAgICBtaW5Cb3hQdC55ID0geU1pbi55OwogICAgICAgIG1pbkJveFB0LnogPSB6TWluLno7CiAgICAgICAgY29uc3QgbWF4Qm94UHQgPSBmcm9tUG9pbnRzTWF4Qm94UHQ7CiAgICAgICAgbWF4Qm94UHQueCA9IHhNYXgueDsKICAgICAgICBtYXhCb3hQdC55ID0geU1heC55OwogICAgICAgIG1heEJveFB0LnogPSB6TWF4Lno7CiAgICAgICAgY29uc3QgbmFpdmVDZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQoCiAgICAgICAgICBtaW5Cb3hQdCwKICAgICAgICAgIG1heEJveFB0LAogICAgICAgICAgZnJvbVBvaW50c05haXZlQ2VudGVyU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgbGV0IG5haXZlUmFkaXVzID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUG9zaXRpb25zOyBpKyspIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbaV0sIGN1cnJlbnRQb3MpOwogICAgICAgICAgY29uc3QgciA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjdXJyZW50UG9zLCBuYWl2ZUNlbnRlciwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHIgPiBuYWl2ZVJhZGl1cykgewogICAgICAgICAgICBuYWl2ZVJhZGl1cyA9IHI7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBvbGRDZW50ZXJUb1BvaW50U3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY3VycmVudFBvcywgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICAgICk7CiAgICAgICAgICBpZiAob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQgPiByYWRpdXNTcXVhcmVkKSB7CiAgICAgICAgICAgIGNvbnN0IG9sZENlbnRlclRvUG9pbnQgPSBNYXRoLnNxcnQob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQpOwogICAgICAgICAgICByaXR0ZXJSYWRpdXMgPSAocml0dGVyUmFkaXVzICsgb2xkQ2VudGVyVG9Qb2ludCkgKiAwLjU7CiAgICAgICAgICAgIHJhZGl1c1NxdWFyZWQgPSByaXR0ZXJSYWRpdXMgKiByaXR0ZXJSYWRpdXM7CiAgICAgICAgICAgIGNvbnN0IG9sZFRvTmV3ID0gb2xkQ2VudGVyVG9Qb2ludCAtIHJpdHRlclJhZGl1czsKICAgICAgICAgICAgcml0dGVyQ2VudGVyLnggPSAocml0dGVyUmFkaXVzICogcml0dGVyQ2VudGVyLnggKyBvbGRUb05ldyAqIGN1cnJlbnRQb3MueCkgLyBvbGRDZW50ZXJUb1BvaW50OwogICAgICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChyaXR0ZXJSYWRpdXMgKiByaXR0ZXJDZW50ZXIueSArIG9sZFRvTmV3ICogY3VycmVudFBvcy55KSAvIG9sZENlbnRlclRvUG9pbnQ7CiAgICAgICAgICAgIHJpdHRlckNlbnRlci56ID0gKHJpdHRlclJhZGl1cyAqIHJpdHRlckNlbnRlci56ICsgb2xkVG9OZXcgKiBjdXJyZW50UG9zLnopIC8gb2xkQ2VudGVyVG9Qb2ludDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJpdHRlclJhZGl1cyA8IG5haXZlUmFkaXVzKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocml0dGVyQ2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSByaXR0ZXJSYWRpdXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShuYWl2ZUNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gbmFpdmVSYWRpdXM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGRlZmF1bHRQcm9qZWN0aW9uID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoKTsKICAgICAgZnJvbVJlY3RhbmdsZTJETG93ZXJMZWZ0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUmVjdGFuZ2xlMkRVcHBlclJpZ2h0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tUmVjdGFuZ2xlMkRTb3V0aHdlc3QgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgZnJvbVJlY3RhbmdsZTJETm9ydGhlYXN0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21SZWN0YW5nbGUyRCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcHJvamVjdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmZyb21SZWN0YW5nbGVXaXRoSGVpZ2h0czJEKAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgcHJvamVjdGlvbiwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbVJlY3RhbmdsZVdpdGhIZWlnaHRzMkQgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHByb2plY3Rpb24sIG1pbmltdW1IZWlnaHQsIG1heGltdW1IZWlnaHQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcHJvamVjdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHByb2plY3Rpb24sIGRlZmF1bHRQcm9qZWN0aW9uKTsKICAgICAgICBSZWN0YW5nbGVfZGVmYXVsdC5zb3V0aHdlc3QocmVjdGFuZ2xlLCBmcm9tUmVjdGFuZ2xlMkRTb3V0aHdlc3QpOwogICAgICAgIGZyb21SZWN0YW5nbGUyRFNvdXRod2VzdC5oZWlnaHQgPSBtaW5pbXVtSGVpZ2h0OwogICAgICAgIFJlY3RhbmdsZV9kZWZhdWx0Lm5vcnRoZWFzdChyZWN0YW5nbGUsIGZyb21SZWN0YW5nbGUyRE5vcnRoZWFzdCk7CiAgICAgICAgZnJvbVJlY3RhbmdsZTJETm9ydGhlYXN0LmhlaWdodCA9IG1heGltdW1IZWlnaHQ7CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJEU291dGh3ZXN0LAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJETG93ZXJMZWZ0CiAgICAgICAgKTsKICAgICAgICBjb25zdCB1cHBlclJpZ2h0ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJETm9ydGhlYXN0LAogICAgICAgICAgZnJvbVJlY3RhbmdsZTJEVXBwZXJSaWdodAogICAgICAgICk7CiAgICAgICAgY29uc3Qgd2lkdGggPSB1cHBlclJpZ2h0LnggLSBsb3dlckxlZnQueDsKICAgICAgICBjb25zdCBoZWlnaHQgPSB1cHBlclJpZ2h0LnkgLSBsb3dlckxlZnQueTsKICAgICAgICBjb25zdCBlbGV2YXRpb24gPSB1cHBlclJpZ2h0LnogLSBsb3dlckxlZnQuejsKICAgICAgICByZXN1bHQucmFkaXVzID0gTWF0aC5zcXJ0KHdpZHRoICogd2lkdGggKyBoZWlnaHQgKiBoZWlnaHQgKyBlbGV2YXRpb24gKiBlbGV2YXRpb24pICogMC41OwogICAgICAgIGNvbnN0IGNlbnRlciA9IHJlc3VsdC5jZW50ZXI7CiAgICAgICAgY2VudGVyLnggPSBsb3dlckxlZnQueCArIHdpZHRoICogMC41OwogICAgICAgIGNlbnRlci55ID0gbG93ZXJMZWZ0LnkgKyBoZWlnaHQgKiAwLjU7CiAgICAgICAgY2VudGVyLnogPSBsb3dlckxlZnQueiArIGVsZXZhdGlvbiAqIDAuNTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBmcm9tUmVjdGFuZ2xlM0RTY3JhdGNoID0gW107CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21SZWN0YW5nbGUzRCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgZWxsaXBzb2lkLCBzdXJmYWNlSGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICBzdXJmYWNlSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3VyZmFjZUhlaWdodCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJlc3VsdC5jZW50ZXIpOwogICAgICAgICAgcmVzdWx0LnJhZGl1cyA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBSZWN0YW5nbGVfZGVmYXVsdC5zdWJzYW1wbGUoCiAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzdXJmYWNlSGVpZ2h0LAogICAgICAgICAgZnJvbVJlY3RhbmdsZTNEU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmZyb21Qb2ludHMocG9zaXRpb25zLCByZXN1bHQpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5mcm9tVmVydGljZXMgPSBmdW5jdGlvbihwb3NpdGlvbnMsIGNlbnRlciwgc3RyaWRlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY2VudGVyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY2VudGVyLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTyk7CiAgICAgICAgc3RyaWRlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RyaWRlLCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygic3RyaWRlIiwgc3RyaWRlLCAzKTsKICAgICAgICBjb25zdCBjdXJyZW50UG9zID0gZnJvbVBvaW50c0N1cnJlbnRQb3M7CiAgICAgICAgY3VycmVudFBvcy54ID0gcG9zaXRpb25zWzBdICsgY2VudGVyLng7CiAgICAgICAgY3VycmVudFBvcy55ID0gcG9zaXRpb25zWzFdICsgY2VudGVyLnk7CiAgICAgICAgY3VycmVudFBvcy56ID0gcG9zaXRpb25zWzJdICsgY2VudGVyLno7CiAgICAgICAgY29uc3QgeE1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1pbik7CiAgICAgICAgY29uc3QgeU1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1pbik7CiAgICAgICAgY29uc3Qgek1pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1pbik7CiAgICAgICAgY29uc3QgeE1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWE1heCk7CiAgICAgICAgY29uc3QgeU1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWU1heCk7CiAgICAgICAgY29uc3Qgek1heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjdXJyZW50UG9zLCBmcm9tUG9pbnRzWk1heCk7CiAgICAgICAgY29uc3QgbnVtRWxlbWVudHMgPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1FbGVtZW50czsgaSArPSBzdHJpZGUpIHsKICAgICAgICAgIGNvbnN0IHggPSBwb3NpdGlvbnNbaV0gKyBjZW50ZXIueDsKICAgICAgICAgIGNvbnN0IHkgPSBwb3NpdGlvbnNbaSArIDFdICsgY2VudGVyLnk7CiAgICAgICAgICBjb25zdCB6ID0gcG9zaXRpb25zW2kgKyAyXSArIGNlbnRlci56OwogICAgICAgICAgY3VycmVudFBvcy54ID0geDsKICAgICAgICAgIGN1cnJlbnRQb3MueSA9IHk7CiAgICAgICAgICBjdXJyZW50UG9zLnogPSB6OwogICAgICAgICAgaWYgKHggPCB4TWluLngpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHhNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHggPiB4TWF4LngpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHhNYXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHkgPCB5TWluLnkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHlNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHkgPiB5TWF4LnkpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHlNYXgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHogPCB6TWluLnopIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHpNaW4pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHogPiB6TWF4LnopIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGN1cnJlbnRQb3MsIHpNYXgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB4U3BhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHhNYXgsIHhNaW4sIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgY29uc3QgeVNwYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh5TWF4LCB5TWluLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGNvbnN0IHpTcGFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qoek1heCwgek1pbiwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBsZXQgZGlhbWV0ZXIxID0geE1pbjsKICAgICAgICBsZXQgZGlhbWV0ZXIyID0geE1heDsKICAgICAgICBsZXQgbWF4U3BhbiA9IHhTcGFuOwogICAgICAgIGlmICh5U3BhbiA+IG1heFNwYW4pIHsKICAgICAgICAgIG1heFNwYW4gPSB5U3BhbjsKICAgICAgICAgIGRpYW1ldGVyMSA9IHlNaW47CiAgICAgICAgICBkaWFtZXRlcjIgPSB5TWF4OwogICAgICAgIH0KICAgICAgICBpZiAoelNwYW4gPiBtYXhTcGFuKSB7CiAgICAgICAgICBtYXhTcGFuID0gelNwYW47CiAgICAgICAgICBkaWFtZXRlcjEgPSB6TWluOwogICAgICAgICAgZGlhbWV0ZXIyID0gek1heDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgcml0dGVyQ2VudGVyID0gZnJvbVBvaW50c1JpdHRlckNlbnRlcjsKICAgICAgICByaXR0ZXJDZW50ZXIueCA9IChkaWFtZXRlcjEueCArIGRpYW1ldGVyMi54KSAqIDAuNTsKICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChkaWFtZXRlcjEueSArIGRpYW1ldGVyMi55KSAqIDAuNTsKICAgICAgICByaXR0ZXJDZW50ZXIueiA9IChkaWFtZXRlcjEueiArIGRpYW1ldGVyMi56KSAqIDAuNTsKICAgICAgICBsZXQgcmFkaXVzU3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGRpYW1ldGVyMiwgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGxldCByaXR0ZXJSYWRpdXMgPSBNYXRoLnNxcnQocmFkaXVzU3F1YXJlZCk7CiAgICAgICAgY29uc3QgbWluQm94UHQgPSBmcm9tUG9pbnRzTWluQm94UHQ7CiAgICAgICAgbWluQm94UHQueCA9IHhNaW4ueDsKICAgICAgICBtaW5Cb3hQdC55ID0geU1pbi55OwogICAgICAgIG1pbkJveFB0LnogPSB6TWluLno7CiAgICAgICAgY29uc3QgbWF4Qm94UHQgPSBmcm9tUG9pbnRzTWF4Qm94UHQ7CiAgICAgICAgbWF4Qm94UHQueCA9IHhNYXgueDsKICAgICAgICBtYXhCb3hQdC55ID0geU1heC55OwogICAgICAgIG1heEJveFB0LnogPSB6TWF4Lno7CiAgICAgICAgY29uc3QgbmFpdmVDZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQoCiAgICAgICAgICBtaW5Cb3hQdCwKICAgICAgICAgIG1heEJveFB0LAogICAgICAgICAgZnJvbVBvaW50c05haXZlQ2VudGVyU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgbGV0IG5haXZlUmFkaXVzID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtRWxlbWVudHM7IGkgKz0gc3RyaWRlKSB7CiAgICAgICAgICBjdXJyZW50UG9zLnggPSBwb3NpdGlvbnNbaV0gKyBjZW50ZXIueDsKICAgICAgICAgIGN1cnJlbnRQb3MueSA9IHBvc2l0aW9uc1tpICsgMV0gKyBjZW50ZXIueTsKICAgICAgICAgIGN1cnJlbnRQb3MueiA9IHBvc2l0aW9uc1tpICsgMl0gKyBjZW50ZXIuejsKICAgICAgICAgIGNvbnN0IHIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY3VycmVudFBvcywgbmFpdmVDZW50ZXIsIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICAgKTsKICAgICAgICAgIGlmIChyID4gbmFpdmVSYWRpdXMpIHsKICAgICAgICAgICAgbmFpdmVSYWRpdXMgPSByOwogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgb2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGN1cnJlbnRQb3MsIHJpdHRlckNlbnRlciwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKG9sZENlbnRlclRvUG9pbnRTcXVhcmVkID4gcmFkaXVzU3F1YXJlZCkgewogICAgICAgICAgICBjb25zdCBvbGRDZW50ZXJUb1BvaW50ID0gTWF0aC5zcXJ0KG9sZENlbnRlclRvUG9pbnRTcXVhcmVkKTsKICAgICAgICAgICAgcml0dGVyUmFkaXVzID0gKHJpdHRlclJhZGl1cyArIG9sZENlbnRlclRvUG9pbnQpICogMC41OwogICAgICAgICAgICByYWRpdXNTcXVhcmVkID0gcml0dGVyUmFkaXVzICogcml0dGVyUmFkaXVzOwogICAgICAgICAgICBjb25zdCBvbGRUb05ldyA9IG9sZENlbnRlclRvUG9pbnQgLSByaXR0ZXJSYWRpdXM7CiAgICAgICAgICAgIHJpdHRlckNlbnRlci54ID0gKHJpdHRlclJhZGl1cyAqIHJpdHRlckNlbnRlci54ICsgb2xkVG9OZXcgKiBjdXJyZW50UG9zLngpIC8gb2xkQ2VudGVyVG9Qb2ludDsKICAgICAgICAgICAgcml0dGVyQ2VudGVyLnkgPSAocml0dGVyUmFkaXVzICogcml0dGVyQ2VudGVyLnkgKyBvbGRUb05ldyAqIGN1cnJlbnRQb3MueSkgLyBvbGRDZW50ZXJUb1BvaW50OwogICAgICAgICAgICByaXR0ZXJDZW50ZXIueiA9IChyaXR0ZXJSYWRpdXMgKiByaXR0ZXJDZW50ZXIueiArIG9sZFRvTmV3ICogY3VycmVudFBvcy56KSAvIG9sZENlbnRlclRvUG9pbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChyaXR0ZXJSYWRpdXMgPCBuYWl2ZVJhZGl1cykgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJpdHRlckNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gcml0dGVyUmFkaXVzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobmFpdmVDZW50ZXIsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgICAgcmVzdWx0LnJhZGl1cyA9IG5haXZlUmFkaXVzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5mcm9tRW5jb2RlZENhcnRlc2lhblZlcnRpY2VzID0gZnVuY3Rpb24ocG9zaXRpb25zSGlnaCwgcG9zaXRpb25zTG93LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zSGlnaCkgfHwgIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnNMb3cpIHx8IHBvc2l0aW9uc0hpZ2gubGVuZ3RoICE9PSBwb3NpdGlvbnNMb3cubGVuZ3RoIHx8IHBvc2l0aW9uc0hpZ2gubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgY3VycmVudFBvcyA9IGZyb21Qb2ludHNDdXJyZW50UG9zOwogICAgICAgIGN1cnJlbnRQb3MueCA9IHBvc2l0aW9uc0hpZ2hbMF0gKyBwb3NpdGlvbnNMb3dbMF07CiAgICAgICAgY3VycmVudFBvcy55ID0gcG9zaXRpb25zSGlnaFsxXSArIHBvc2l0aW9uc0xvd1sxXTsKICAgICAgICBjdXJyZW50UG9zLnogPSBwb3NpdGlvbnNIaWdoWzJdICsgcG9zaXRpb25zTG93WzJdOwogICAgICAgIGNvbnN0IHhNaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1hNaW4pOwogICAgICAgIGNvbnN0IHlNaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1lNaW4pOwogICAgICAgIGNvbnN0IHpNaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1pNaW4pOwogICAgICAgIGNvbnN0IHhNYXggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1hNYXgpOwogICAgICAgIGNvbnN0IHlNYXggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1lNYXgpOwogICAgICAgIGNvbnN0IHpNYXggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgZnJvbVBvaW50c1pNYXgpOwogICAgICAgIGNvbnN0IG51bUVsZW1lbnRzID0gcG9zaXRpb25zSGlnaC5sZW5ndGg7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bUVsZW1lbnRzOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IHggPSBwb3NpdGlvbnNIaWdoW2ldICsgcG9zaXRpb25zTG93W2ldOwogICAgICAgICAgY29uc3QgeSA9IHBvc2l0aW9uc0hpZ2hbaSArIDFdICsgcG9zaXRpb25zTG93W2kgKyAxXTsKICAgICAgICAgIGNvbnN0IHogPSBwb3NpdGlvbnNIaWdoW2kgKyAyXSArIHBvc2l0aW9uc0xvd1tpICsgMl07CiAgICAgICAgICBjdXJyZW50UG9zLnggPSB4OwogICAgICAgICAgY3VycmVudFBvcy55ID0geTsKICAgICAgICAgIGN1cnJlbnRQb3MueiA9IHo7CiAgICAgICAgICBpZiAoeCA8IHhNaW4ueCkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeE1pbik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeCA+IHhNYXgueCkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeE1heCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeSA8IHlNaW4ueSkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeU1pbik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeSA+IHlNYXgueSkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgeU1heCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeiA8IHpNaW4ueikgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgek1pbik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoeiA+IHpNYXgueikgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY3VycmVudFBvcywgek1heCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHhTcGFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoeE1heCwgeE1pbiwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgKTsKICAgICAgICBjb25zdCB5U3BhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHlNYXgsIHlNaW4sIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgY29uc3QgelNwYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh6TWF4LCB6TWluLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGxldCBkaWFtZXRlcjEgPSB4TWluOwogICAgICAgIGxldCBkaWFtZXRlcjIgPSB4TWF4OwogICAgICAgIGxldCBtYXhTcGFuID0geFNwYW47CiAgICAgICAgaWYgKHlTcGFuID4gbWF4U3BhbikgewogICAgICAgICAgbWF4U3BhbiA9IHlTcGFuOwogICAgICAgICAgZGlhbWV0ZXIxID0geU1pbjsKICAgICAgICAgIGRpYW1ldGVyMiA9IHlNYXg7CiAgICAgICAgfQogICAgICAgIGlmICh6U3BhbiA+IG1heFNwYW4pIHsKICAgICAgICAgIG1heFNwYW4gPSB6U3BhbjsKICAgICAgICAgIGRpYW1ldGVyMSA9IHpNaW47CiAgICAgICAgICBkaWFtZXRlcjIgPSB6TWF4OwogICAgICAgIH0KICAgICAgICBjb25zdCByaXR0ZXJDZW50ZXIgPSBmcm9tUG9pbnRzUml0dGVyQ2VudGVyOwogICAgICAgIHJpdHRlckNlbnRlci54ID0gKGRpYW1ldGVyMS54ICsgZGlhbWV0ZXIyLngpICogMC41OwogICAgICAgIHJpdHRlckNlbnRlci55ID0gKGRpYW1ldGVyMS55ICsgZGlhbWV0ZXIyLnkpICogMC41OwogICAgICAgIHJpdHRlckNlbnRlci56ID0gKGRpYW1ldGVyMS56ICsgZGlhbWV0ZXIyLnopICogMC41OwogICAgICAgIGxldCByYWRpdXNTcXVhcmVkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoZGlhbWV0ZXIyLCByaXR0ZXJDZW50ZXIsIGZyb21Qb2ludHNTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgbGV0IHJpdHRlclJhZGl1cyA9IE1hdGguc3FydChyYWRpdXNTcXVhcmVkKTsKICAgICAgICBjb25zdCBtaW5Cb3hQdCA9IGZyb21Qb2ludHNNaW5Cb3hQdDsKICAgICAgICBtaW5Cb3hQdC54ID0geE1pbi54OwogICAgICAgIG1pbkJveFB0LnkgPSB5TWluLnk7CiAgICAgICAgbWluQm94UHQueiA9IHpNaW4uejsKICAgICAgICBjb25zdCBtYXhCb3hQdCA9IGZyb21Qb2ludHNNYXhCb3hQdDsKICAgICAgICBtYXhCb3hQdC54ID0geE1heC54OwogICAgICAgIG1heEJveFB0LnkgPSB5TWF4Lnk7CiAgICAgICAgbWF4Qm94UHQueiA9IHpNYXguejsKICAgICAgICBjb25zdCBuYWl2ZUNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5taWRwb2ludCgKICAgICAgICAgIG1pbkJveFB0LAogICAgICAgICAgbWF4Qm94UHQsCiAgICAgICAgICBmcm9tUG9pbnRzTmFpdmVDZW50ZXJTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBsZXQgbmFpdmVSYWRpdXMgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1FbGVtZW50czsgaSArPSAzKSB7CiAgICAgICAgICBjdXJyZW50UG9zLnggPSBwb3NpdGlvbnNIaWdoW2ldICsgcG9zaXRpb25zTG93W2ldOwogICAgICAgICAgY3VycmVudFBvcy55ID0gcG9zaXRpb25zSGlnaFtpICsgMV0gKyBwb3NpdGlvbnNMb3dbaSArIDFdOwogICAgICAgICAgY3VycmVudFBvcy56ID0gcG9zaXRpb25zSGlnaFtpICsgMl0gKyBwb3NpdGlvbnNMb3dbaSArIDJdOwogICAgICAgICAgY29uc3QgciA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjdXJyZW50UG9zLCBuYWl2ZUNlbnRlciwgZnJvbVBvaW50c1NjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHIgPiBuYWl2ZVJhZGl1cykgewogICAgICAgICAgICBuYWl2ZVJhZGl1cyA9IHI7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBvbGRDZW50ZXJUb1BvaW50U3F1YXJlZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY3VycmVudFBvcywgcml0dGVyQ2VudGVyLCBmcm9tUG9pbnRzU2NyYXRjaCkKICAgICAgICAgICk7CiAgICAgICAgICBpZiAob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQgPiByYWRpdXNTcXVhcmVkKSB7CiAgICAgICAgICAgIGNvbnN0IG9sZENlbnRlclRvUG9pbnQgPSBNYXRoLnNxcnQob2xkQ2VudGVyVG9Qb2ludFNxdWFyZWQpOwogICAgICAgICAgICByaXR0ZXJSYWRpdXMgPSAocml0dGVyUmFkaXVzICsgb2xkQ2VudGVyVG9Qb2ludCkgKiAwLjU7CiAgICAgICAgICAgIHJhZGl1c1NxdWFyZWQgPSByaXR0ZXJSYWRpdXMgKiByaXR0ZXJSYWRpdXM7CiAgICAgICAgICAgIGNvbnN0IG9sZFRvTmV3ID0gb2xkQ2VudGVyVG9Qb2ludCAtIHJpdHRlclJhZGl1czsKICAgICAgICAgICAgcml0dGVyQ2VudGVyLnggPSAocml0dGVyUmFkaXVzICogcml0dGVyQ2VudGVyLnggKyBvbGRUb05ldyAqIGN1cnJlbnRQb3MueCkgLyBvbGRDZW50ZXJUb1BvaW50OwogICAgICAgICAgICByaXR0ZXJDZW50ZXIueSA9IChyaXR0ZXJSYWRpdXMgKiByaXR0ZXJDZW50ZXIueSArIG9sZFRvTmV3ICogY3VycmVudFBvcy55KSAvIG9sZENlbnRlclRvUG9pbnQ7CiAgICAgICAgICAgIHJpdHRlckNlbnRlci56ID0gKHJpdHRlclJhZGl1cyAqIHJpdHRlckNlbnRlci56ICsgb2xkVG9OZXcgKiBjdXJyZW50UG9zLnopIC8gb2xkQ2VudGVyVG9Qb2ludDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJpdHRlclJhZGl1cyA8IG5haXZlUmFkaXVzKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocml0dGVyQ2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSByaXR0ZXJSYWRpdXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShuYWl2ZUNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gbmFpdmVSYWRpdXM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLmZyb21Db3JuZXJQb2ludHMgPSBmdW5jdGlvbihjb3JuZXIsIG9wcG9zaXRlQ29ybmVyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNvcm5lciIsIGNvcm5lcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHBvc2l0ZUNvcm5lciIsIG9wcG9zaXRlQ29ybmVyKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1pZHBvaW50KGNvcm5lciwgb3Bwb3NpdGVDb3JuZXIsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIHJlc3VsdC5yYWRpdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGlzdGFuY2UoY2VudGVyLCBvcHBvc2l0ZUNvcm5lcik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbUVsbGlwc29pZCA9IGZ1bmN0aW9uKGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJlbGxpcHNvaWQiLCBlbGxpcHNvaWQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIHJlc3VsdC5yYWRpdXMgPSBlbGxpcHNvaWQubWF4aW11bVJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBmcm9tQm91bmRpbmdTcGhlcmVzU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQm91bmRpbmdTcGhlcmUuZnJvbUJvdW5kaW5nU3BoZXJlcyA9IGZ1bmN0aW9uKGJvdW5kaW5nU3BoZXJlcywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJvdW5kaW5nU3BoZXJlcykgfHwgYm91bmRpbmdTcGhlcmVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXN1bHQucmFkaXVzID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGJvdW5kaW5nU3BoZXJlcy5sZW5ndGg7CiAgICAgICAgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmNsb25lKGJvdW5kaW5nU3BoZXJlc1swXSwgcmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgaWYgKGxlbmd0aCA9PT0gMikgewogICAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLnVuaW9uKGJvdW5kaW5nU3BoZXJlc1swXSwgYm91bmRpbmdTcGhlcmVzWzFdLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBbXTsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHBvc2l0aW9ucy5wdXNoKGJvdW5kaW5nU3BoZXJlc1tpXS5jZW50ZXIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBCb3VuZGluZ1NwaGVyZS5mcm9tUG9pbnRzKHBvc2l0aW9ucywgcmVzdWx0KTsKICAgICAgICBjb25zdCBjZW50ZXIgPSByZXN1bHQuY2VudGVyOwogICAgICAgIGxldCByYWRpdXMgPSByZXN1bHQucmFkaXVzOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgdG1wMiA9IGJvdW5kaW5nU3BoZXJlc1tpXTsKICAgICAgICAgIHJhZGl1cyA9IE1hdGgubWF4KAogICAgICAgICAgICByYWRpdXMsCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kaXN0YW5jZShjZW50ZXIsIHRtcDIuY2VudGVyLCBmcm9tQm91bmRpbmdTcGhlcmVzU2NyYXRjaCkgKyB0bXAyLnJhZGl1cwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IHJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hVID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hWID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hXID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1NwaGVyZS5mcm9tT3JpZW50ZWRCb3VuZGluZ0JveCA9IGZ1bmN0aW9uKG9yaWVudGVkQm91bmRpbmdCb3gsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3JpZW50ZWRCb3VuZGluZ0JveCIsIG9yaWVudGVkQm91bmRpbmdCb3gpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBoYWxmQXhlcyA9IG9yaWVudGVkQm91bmRpbmdCb3guaGFsZkF4ZXM7CiAgICAgICAgY29uc3QgdTMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAwLCBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hVKTsKICAgICAgICBjb25zdCB2MyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIGZyb21PcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaFYpOwogICAgICAgIGNvbnN0IHcgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAyLCBmcm9tT3JpZW50ZWRCb3VuZGluZ0JveFNjcmF0Y2hXKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHUzLCB2MywgdTMpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodTMsIHcsIHUzKTsKICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG9yaWVudGVkQm91bmRpbmdCb3guY2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICByZXN1bHQucmFkaXVzID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh1Myk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEZyb21UcmFuc2Zvcm1hdGlvbkNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEZyb21UcmFuc2Zvcm1hdGlvblNjYWxlID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1NwaGVyZS5mcm9tVHJhbnNmb3JtYXRpb24gPSBmdW5jdGlvbih0cmFuc2Zvcm1hdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2Zvcm1hdGlvbiIsIHRyYW5zZm9ybWF0aW9uKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2VudGVyID0gTWF0cml4NF9kZWZhdWx0LmdldFRyYW5zbGF0aW9uKAogICAgICAgICAgdHJhbnNmb3JtYXRpb24sCiAgICAgICAgICBzY3JhdGNoRnJvbVRyYW5zZm9ybWF0aW9uQ2VudGVyCiAgICAgICAgKTsKICAgICAgICBjb25zdCBzY2FsZSA9IE1hdHJpeDRfZGVmYXVsdC5nZXRTY2FsZSgKICAgICAgICAgIHRyYW5zZm9ybWF0aW9uLAogICAgICAgICAgc2NyYXRjaEZyb21UcmFuc2Zvcm1hdGlvblNjYWxlCiAgICAgICAgKTsKICAgICAgICBjb25zdCByYWRpdXMgPSAwLjUgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHNjYWxlKTsKICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IHJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5jbG9uZSA9IGZ1bmN0aW9uKHNwaGVyZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc3BoZXJlKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBCb3VuZGluZ1NwaGVyZShzcGhlcmUuY2VudGVyLCBzcGhlcmUucmFkaXVzKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShzcGhlcmUuY2VudGVyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICByZXN1bHQucmFkaXVzID0gc3BoZXJlLnJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5wYWNrZWRMZW5ndGggPSA0OwogICAgICBCb3VuZGluZ1NwaGVyZS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBjZW50ZXIgPSB2YWx1ZS5jZW50ZXI7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGNlbnRlci54OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBjZW50ZXIueTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gY2VudGVyLno7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5yYWRpdXM7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNlbnRlciA9IHJlc3VsdC5jZW50ZXI7CiAgICAgICAgY2VudGVyLnggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNlbnRlci55ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjZW50ZXIueiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHVuaW9uU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdW5pb25TY3JhdGNoQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1NwaGVyZS51bmlvbiA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBCb3VuZGluZ1NwaGVyZSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZWZ0Q2VudGVyID0gbGVmdC5jZW50ZXI7CiAgICAgICAgY29uc3QgbGVmdFJhZGl1cyA9IGxlZnQucmFkaXVzOwogICAgICAgIGNvbnN0IHJpZ2h0Q2VudGVyID0gcmlnaHQuY2VudGVyOwogICAgICAgIGNvbnN0IHJpZ2h0UmFkaXVzID0gcmlnaHQucmFkaXVzOwogICAgICAgIGNvbnN0IHRvUmlnaHRDZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICByaWdodENlbnRlciwKICAgICAgICAgIGxlZnRDZW50ZXIsCiAgICAgICAgICB1bmlvblNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGNlbnRlclNlcGFyYXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHRvUmlnaHRDZW50ZXIpOwogICAgICAgIGlmIChsZWZ0UmFkaXVzID49IGNlbnRlclNlcGFyYXRpb24gKyByaWdodFJhZGl1cykgewogICAgICAgICAgbGVmdC5jbG9uZShyZXN1bHQpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgaWYgKHJpZ2h0UmFkaXVzID49IGNlbnRlclNlcGFyYXRpb24gKyBsZWZ0UmFkaXVzKSB7CiAgICAgICAgICByaWdodC5jbG9uZShyZXN1bHQpOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgaGFsZkRpc3RhbmNlQmV0d2VlblRhbmdlbnRQb2ludHMgPSAobGVmdFJhZGl1cyArIGNlbnRlclNlcGFyYXRpb24gKyByaWdodFJhZGl1cykgKiAwLjU7CiAgICAgICAgY29uc3QgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICB0b1JpZ2h0Q2VudGVyLAogICAgICAgICAgKC1sZWZ0UmFkaXVzICsgaGFsZkRpc3RhbmNlQmV0d2VlblRhbmdlbnRQb2ludHMpIC8gY2VudGVyU2VwYXJhdGlvbiwKICAgICAgICAgIHVuaW9uU2NyYXRjaENlbnRlcgogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIGxlZnRDZW50ZXIsIGNlbnRlcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmVzdWx0LnJhZGl1cyA9IGhhbGZEaXN0YW5jZUJldHdlZW5UYW5nZW50UG9pbnRzOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIGV4cGFuZFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEJvdW5kaW5nU3BoZXJlLmV4cGFuZCA9IGZ1bmN0aW9uKHNwaGVyZSwgcG9pbnQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3BoZXJlIiwgc3BoZXJlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBvaW50IiwgcG9pbnQpOwogICAgICAgIHJlc3VsdCA9IEJvdW5kaW5nU3BoZXJlLmNsb25lKHNwaGVyZSwgcmVzdWx0KTsKICAgICAgICBjb25zdCByYWRpdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvaW50LCByZXN1bHQuY2VudGVyLCBleHBhbmRTY3JhdGNoKQogICAgICAgICk7CiAgICAgICAgaWYgKHJhZGl1cyA+IHJlc3VsdC5yYWRpdXMpIHsKICAgICAgICAgIHJlc3VsdC5yYWRpdXMgPSByYWRpdXM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLmludGVyc2VjdFBsYW5lID0gZnVuY3Rpb24oc3BoZXJlLCBwbGFuZSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3BoZXJlIiwgc3BoZXJlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBsYW5lIiwgcGxhbmUpOwogICAgICAgIGNvbnN0IGNlbnRlciA9IHNwaGVyZS5jZW50ZXI7CiAgICAgICAgY29uc3QgcmFkaXVzID0gc3BoZXJlLnJhZGl1czsKICAgICAgICBjb25zdCBub3JtYWwyID0gcGxhbmUubm9ybWFsOwogICAgICAgIGNvbnN0IGRpc3RhbmNlVG9QbGFuZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgY2VudGVyKSArIHBsYW5lLmRpc3RhbmNlOwogICAgICAgIGlmIChkaXN0YW5jZVRvUGxhbmUgPCAtcmFkaXVzKSB7CiAgICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuT1VUU0lERTsKICAgICAgICB9IGVsc2UgaWYgKGRpc3RhbmNlVG9QbGFuZSA8IHJhZGl1cykgewogICAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0LklOVEVSU0VDVElORzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0LklOU0lERTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUudHJhbnNmb3JtID0gZnVuY3Rpb24oc3BoZXJlLCB0cmFuc2Zvcm0yLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInNwaGVyZSIsIHNwaGVyZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2Zvcm0iLCB0cmFuc2Zvcm0yKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdTcGhlcmUoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LmNlbnRlciA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQoCiAgICAgICAgICB0cmFuc2Zvcm0yLAogICAgICAgICAgc3BoZXJlLmNlbnRlciwKICAgICAgICAgIHJlc3VsdC5jZW50ZXIKICAgICAgICApOwogICAgICAgIHJlc3VsdC5yYWRpdXMgPSBNYXRyaXg0X2RlZmF1bHQuZ2V0TWF4aW11bVNjYWxlKHRyYW5zZm9ybTIpICogc3BoZXJlLnJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBkaXN0YW5jZVNxdWFyZWRUb1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEJvdW5kaW5nU3BoZXJlLmRpc3RhbmNlU3F1YXJlZFRvID0gZnVuY3Rpb24oc3BoZXJlLCBjYXJ0ZXNpYW4xMSkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3BoZXJlIiwgc3BoZXJlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBjb25zdCBkaWZmID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgc3BoZXJlLmNlbnRlciwKICAgICAgICAgIGNhcnRlc2lhbjExLAogICAgICAgICAgZGlzdGFuY2VTcXVhcmVkVG9TY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBkaXN0YW5jZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoZGlmZikgLSBzcGhlcmUucmFkaXVzOwogICAgICAgIGlmIChkaXN0YW5jZSA8PSAwKSB7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRpc3RhbmNlICogZGlzdGFuY2U7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLnRyYW5zZm9ybVdpdGhvdXRTY2FsZSA9IGZ1bmN0aW9uKHNwaGVyZSwgdHJhbnNmb3JtMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzcGhlcmUiLCBzcGhlcmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidHJhbnNmb3JtIiwgdHJhbnNmb3JtMik7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nU3BoZXJlKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KAogICAgICAgICAgdHJhbnNmb3JtMiwKICAgICAgICAgIHNwaGVyZS5jZW50ZXIsCiAgICAgICAgICByZXN1bHQuY2VudGVyCiAgICAgICAgKTsKICAgICAgICByZXN1bHQucmFkaXVzID0gc3BoZXJlLnJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydGVzaWFuMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQm91bmRpbmdTcGhlcmUuY29tcHV0ZVBsYW5lRGlzdGFuY2VzID0gZnVuY3Rpb24oc3BoZXJlLCBwb3NpdGlvbiwgZGlyZWN0aW9uMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzcGhlcmUiLCBzcGhlcmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicG9zaXRpb24iLCBwb3NpdGlvbik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkaXJlY3Rpb24iLCBkaXJlY3Rpb24yKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgSW50ZXJ2YWxfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCB0b0NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIHNwaGVyZS5jZW50ZXIsCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zCiAgICAgICAgKTsKICAgICAgICBjb25zdCBtYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHRvQ2VudGVyKTsKICAgICAgICByZXN1bHQuc3RhcnQgPSBtYWcgLSBzcGhlcmUucmFkaXVzOwogICAgICAgIHJlc3VsdC5zdG9wID0gbWFnICsgc3BoZXJlLnJhZGl1czsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBwcm9qZWN0VG8yRE5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHByb2plY3RUbzJERWFzdFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHByb2plY3RUbzJETm9ydGhTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwcm9qZWN0VG8yRFdlc3RTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwcm9qZWN0VG8yRFNvdXRoU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcHJvamVjdFRvMkRDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHByb2plY3RUbzJEUG9zaXRpb25zU2NyYXRjaCA9IG5ldyBBcnJheSg4KTsKICAgICAgZm9yIChsZXQgbiA9IDA7IG4gPCA4OyArK24pIHsKICAgICAgICBwcm9qZWN0VG8yRFBvc2l0aW9uc1NjcmF0Y2hbbl0gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIH0KICAgICAgcHJvamVjdFRvMkRQcm9qZWN0aW9uID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoKTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvamVjdFRvMkQgPSBmdW5jdGlvbihzcGhlcmUsIHByb2plY3Rpb24sIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgic3BoZXJlIiwgc3BoZXJlKTsKICAgICAgICBwcm9qZWN0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocHJvamVjdGlvbiwgcHJvamVjdFRvMkRQcm9qZWN0aW9uKTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBwcm9qZWN0aW9uLmVsbGlwc29pZDsKICAgICAgICBsZXQgY2VudGVyID0gc3BoZXJlLmNlbnRlcjsKICAgICAgICBjb25zdCByYWRpdXMgPSBzcGhlcmUucmFkaXVzOwogICAgICAgIGxldCBub3JtYWwyOwogICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGNlbnRlciwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKSB7CiAgICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsIHByb2plY3RUbzJETm9ybWFsU2NyYXRjaCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGNlbnRlciwgcHJvamVjdFRvMkROb3JtYWxTY3JhdGNoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWFzdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osCiAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgcHJvamVjdFRvMkRFYXN0U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShlYXN0LCBlYXN0KTsKICAgICAgICBjb25zdCBub3J0aCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCBlYXN0LCBwcm9qZWN0VG8yRE5vcnRoU2NyYXRjaCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3J0aCwgbm9ydGgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG5vcm1hbDIsIHJhZGl1cywgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobm9ydGgsIHJhZGl1cywgbm9ydGgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGVhc3QsIHJhZGl1cywgZWFzdCk7CiAgICAgICAgY29uc3Qgc291dGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG5vcnRoLCBwcm9qZWN0VG8yRFNvdXRoU2NyYXRjaCk7CiAgICAgICAgY29uc3Qgd2VzdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoZWFzdCwgcHJvamVjdFRvMkRXZXN0U2NyYXRjaCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gcHJvamVjdFRvMkRQb3NpdGlvbnNTY3JhdGNoOwogICAgICAgIGxldCBjb3JuZXIgPSBwb3NpdGlvbnNbMF07CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBub3J0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgZWFzdCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbMV07CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBub3J0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgd2VzdCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbMl07CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBzb3V0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgd2VzdCwgY29ybmVyKTsKICAgICAgICBjb3JuZXIgPSBwb3NpdGlvbnNbM107CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChub3JtYWwyLCBzb3V0aCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgZWFzdCwgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s0XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIG5vcnRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCBlYXN0LCBjb3JuZXIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s1XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIG5vcnRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3ZXN0LCBjb3JuZXIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s2XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIHNvdXRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3ZXN0LCBjb3JuZXIpOwogICAgICAgIGNvcm5lciA9IHBvc2l0aW9uc1s3XTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5vcm1hbDIsIHNvdXRoLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCBlYXN0LCBjb3JuZXIpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNlbnRlciwgcG9zaXRpb24sIHBvc2l0aW9uKTsKICAgICAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBwcm9qZWN0VG8yRENhcnRvZ3JhcGhpY1NjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBwcm9qZWN0aW9uLnByb2plY3QoY2FydG9ncmFwaGljMiwgcG9zaXRpb24pOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBCb3VuZGluZ1NwaGVyZS5mcm9tUG9pbnRzKHBvc2l0aW9ucywgcmVzdWx0KTsKICAgICAgICBjZW50ZXIgPSByZXN1bHQuY2VudGVyOwogICAgICAgIGNvbnN0IHggPSBjZW50ZXIueDsKICAgICAgICBjb25zdCB5ID0gY2VudGVyLnk7CiAgICAgICAgY29uc3QgeiA9IGNlbnRlci56OwogICAgICAgIGNlbnRlci54ID0gejsKICAgICAgICBjZW50ZXIueSA9IHg7CiAgICAgICAgY2VudGVyLnogPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLmlzT2NjbHVkZWQgPSBmdW5jdGlvbihzcGhlcmUsIG9jY2x1ZGVyKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzcGhlcmUiLCBzcGhlcmUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib2NjbHVkZXIiLCBvY2NsdWRlcik7CiAgICAgICAgcmV0dXJuICFvY2NsdWRlci5pc0JvdW5kaW5nU3BoZXJlVmlzaWJsZShzcGhlcmUpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGxlZnQuY2VudGVyLCByaWdodC5jZW50ZXIpICYmIGxlZnQucmFkaXVzID09PSByaWdodC5yYWRpdXM7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLnByb3RvdHlwZS5pbnRlcnNlY3RQbGFuZSA9IGZ1bmN0aW9uKHBsYW5lKSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmludGVyc2VjdFBsYW5lKHRoaXMsIHBsYW5lKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvdG90eXBlLmRpc3RhbmNlU3F1YXJlZFRvID0gZnVuY3Rpb24oY2FydGVzaWFuMTEpIHsKICAgICAgICByZXR1cm4gQm91bmRpbmdTcGhlcmUuZGlzdGFuY2VTcXVhcmVkVG8odGhpcywgY2FydGVzaWFuMTEpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5wcm90b3R5cGUuY29tcHV0ZVBsYW5lRGlzdGFuY2VzID0gZnVuY3Rpb24ocG9zaXRpb24sIGRpcmVjdGlvbjIsIHJlc3VsdCkgewogICAgICAgIHJldHVybiBCb3VuZGluZ1NwaGVyZS5jb21wdXRlUGxhbmVEaXN0YW5jZXMoCiAgICAgICAgICB0aGlzLAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBkaXJlY3Rpb24yLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvdG90eXBlLmlzT2NjbHVkZWQgPSBmdW5jdGlvbihvY2NsdWRlcikgewogICAgICAgIHJldHVybiBCb3VuZGluZ1NwaGVyZS5pc09jY2x1ZGVkKHRoaXMsIG9jY2x1ZGVyKTsKICAgICAgfTsKICAgICAgQm91bmRpbmdTcGhlcmUucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nU3BoZXJlLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nU3BoZXJlLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBCb3VuZGluZ1NwaGVyZS5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZS5wcm90b3R5cGUudm9sdW1lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgcmFkaXVzID0gdGhpcy5yYWRpdXM7CiAgICAgICAgcmV0dXJuIHZvbHVtZUNvbnN0YW50ICogcmFkaXVzICogcmFkaXVzICogcmFkaXVzOwogICAgICB9OwogICAgICBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0ID0gQm91bmRpbmdTcGhlcmU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9XZWJHTENvbnN0YW50cy5qcwogIHZhciBXZWJHTENvbnN0YW50cywgV2ViR0xDb25zdGFudHNfZGVmYXVsdDsKICB2YXIgaW5pdF9XZWJHTENvbnN0YW50cyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2ViR0xDb25zdGFudHMuanMiKCkgewogICAgICBXZWJHTENvbnN0YW50cyA9IHsKICAgICAgICBERVBUSF9CVUZGRVJfQklUOiAyNTYsCiAgICAgICAgU1RFTkNJTF9CVUZGRVJfQklUOiAxMDI0LAogICAgICAgIENPTE9SX0JVRkZFUl9CSVQ6IDE2Mzg0LAogICAgICAgIFBPSU5UUzogMCwKICAgICAgICBMSU5FUzogMSwKICAgICAgICBMSU5FX0xPT1A6IDIsCiAgICAgICAgTElORV9TVFJJUDogMywKICAgICAgICBUUklBTkdMRVM6IDQsCiAgICAgICAgVFJJQU5HTEVfU1RSSVA6IDUsCiAgICAgICAgVFJJQU5HTEVfRkFOOiA2LAogICAgICAgIFpFUk86IDAsCiAgICAgICAgT05FOiAxLAogICAgICAgIFNSQ19DT0xPUjogNzY4LAogICAgICAgIE9ORV9NSU5VU19TUkNfQ09MT1I6IDc2OSwKICAgICAgICBTUkNfQUxQSEE6IDc3MCwKICAgICAgICBPTkVfTUlOVVNfU1JDX0FMUEhBOiA3NzEsCiAgICAgICAgRFNUX0FMUEhBOiA3NzIsCiAgICAgICAgT05FX01JTlVTX0RTVF9BTFBIQTogNzczLAogICAgICAgIERTVF9DT0xPUjogNzc0LAogICAgICAgIE9ORV9NSU5VU19EU1RfQ09MT1I6IDc3NSwKICAgICAgICBTUkNfQUxQSEFfU0FUVVJBVEU6IDc3NiwKICAgICAgICBGVU5DX0FERDogMzI3NzQsCiAgICAgICAgQkxFTkRfRVFVQVRJT046IDMyNzc3LAogICAgICAgIEJMRU5EX0VRVUFUSU9OX1JHQjogMzI3NzcsCiAgICAgICAgLy8gc2FtZSBhcyBCTEVORF9FUVVBVElPTgogICAgICAgIEJMRU5EX0VRVUFUSU9OX0FMUEhBOiAzNDg3NywKICAgICAgICBGVU5DX1NVQlRSQUNUOiAzMjc3OCwKICAgICAgICBGVU5DX1JFVkVSU0VfU1VCVFJBQ1Q6IDMyNzc5LAogICAgICAgIEJMRU5EX0RTVF9SR0I6IDMyOTY4LAogICAgICAgIEJMRU5EX1NSQ19SR0I6IDMyOTY5LAogICAgICAgIEJMRU5EX0RTVF9BTFBIQTogMzI5NzAsCiAgICAgICAgQkxFTkRfU1JDX0FMUEhBOiAzMjk3MSwKICAgICAgICBDT05TVEFOVF9DT0xPUjogMzI3NjksCiAgICAgICAgT05FX01JTlVTX0NPTlNUQU5UX0NPTE9SOiAzMjc3MCwKICAgICAgICBDT05TVEFOVF9BTFBIQTogMzI3NzEsCiAgICAgICAgT05FX01JTlVTX0NPTlNUQU5UX0FMUEhBOiAzMjc3MiwKICAgICAgICBCTEVORF9DT0xPUjogMzI3NzMsCiAgICAgICAgQVJSQVlfQlVGRkVSOiAzNDk2MiwKICAgICAgICBFTEVNRU5UX0FSUkFZX0JVRkZFUjogMzQ5NjMsCiAgICAgICAgQVJSQVlfQlVGRkVSX0JJTkRJTkc6IDM0OTY0LAogICAgICAgIEVMRU1FTlRfQVJSQVlfQlVGRkVSX0JJTkRJTkc6IDM0OTY1LAogICAgICAgIFNUUkVBTV9EUkFXOiAzNTA0MCwKICAgICAgICBTVEFUSUNfRFJBVzogMzUwNDQsCiAgICAgICAgRFlOQU1JQ19EUkFXOiAzNTA0OCwKICAgICAgICBCVUZGRVJfU0laRTogMzQ2NjAsCiAgICAgICAgQlVGRkVSX1VTQUdFOiAzNDY2MSwKICAgICAgICBDVVJSRU5UX1ZFUlRFWF9BVFRSSUI6IDM0MzQyLAogICAgICAgIEZST05UOiAxMDI4LAogICAgICAgIEJBQ0s6IDEwMjksCiAgICAgICAgRlJPTlRfQU5EX0JBQ0s6IDEwMzIsCiAgICAgICAgQ1VMTF9GQUNFOiAyODg0LAogICAgICAgIEJMRU5EOiAzMDQyLAogICAgICAgIERJVEhFUjogMzAyNCwKICAgICAgICBTVEVOQ0lMX1RFU1Q6IDI5NjAsCiAgICAgICAgREVQVEhfVEVTVDogMjkyOSwKICAgICAgICBTQ0lTU09SX1RFU1Q6IDMwODksCiAgICAgICAgUE9MWUdPTl9PRkZTRVRfRklMTDogMzI4MjMsCiAgICAgICAgU0FNUExFX0FMUEhBX1RPX0NPVkVSQUdFOiAzMjkyNiwKICAgICAgICBTQU1QTEVfQ09WRVJBR0U6IDMyOTI4LAogICAgICAgIE5PX0VSUk9SOiAwLAogICAgICAgIElOVkFMSURfRU5VTTogMTI4MCwKICAgICAgICBJTlZBTElEX1ZBTFVFOiAxMjgxLAogICAgICAgIElOVkFMSURfT1BFUkFUSU9OOiAxMjgyLAogICAgICAgIE9VVF9PRl9NRU1PUlk6IDEyODUsCiAgICAgICAgQ1c6IDIzMDQsCiAgICAgICAgQ0NXOiAyMzA1LAogICAgICAgIExJTkVfV0lEVEg6IDI4NDksCiAgICAgICAgQUxJQVNFRF9QT0lOVF9TSVpFX1JBTkdFOiAzMzkwMSwKICAgICAgICBBTElBU0VEX0xJTkVfV0lEVEhfUkFOR0U6IDMzOTAyLAogICAgICAgIENVTExfRkFDRV9NT0RFOiAyODg1LAogICAgICAgIEZST05UX0ZBQ0U6IDI4ODYsCiAgICAgICAgREVQVEhfUkFOR0U6IDI5MjgsCiAgICAgICAgREVQVEhfV1JJVEVNQVNLOiAyOTMwLAogICAgICAgIERFUFRIX0NMRUFSX1ZBTFVFOiAyOTMxLAogICAgICAgIERFUFRIX0ZVTkM6IDI5MzIsCiAgICAgICAgU1RFTkNJTF9DTEVBUl9WQUxVRTogMjk2MSwKICAgICAgICBTVEVOQ0lMX0ZVTkM6IDI5NjIsCiAgICAgICAgU1RFTkNJTF9GQUlMOiAyOTY0LAogICAgICAgIFNURU5DSUxfUEFTU19ERVBUSF9GQUlMOiAyOTY1LAogICAgICAgIFNURU5DSUxfUEFTU19ERVBUSF9QQVNTOiAyOTY2LAogICAgICAgIFNURU5DSUxfUkVGOiAyOTY3LAogICAgICAgIFNURU5DSUxfVkFMVUVfTUFTSzogMjk2MywKICAgICAgICBTVEVOQ0lMX1dSSVRFTUFTSzogMjk2OCwKICAgICAgICBTVEVOQ0lMX0JBQ0tfRlVOQzogMzQ4MTYsCiAgICAgICAgU1RFTkNJTF9CQUNLX0ZBSUw6IDM0ODE3LAogICAgICAgIFNURU5DSUxfQkFDS19QQVNTX0RFUFRIX0ZBSUw6IDM0ODE4LAogICAgICAgIFNURU5DSUxfQkFDS19QQVNTX0RFUFRIX1BBU1M6IDM0ODE5LAogICAgICAgIFNURU5DSUxfQkFDS19SRUY6IDM2MDAzLAogICAgICAgIFNURU5DSUxfQkFDS19WQUxVRV9NQVNLOiAzNjAwNCwKICAgICAgICBTVEVOQ0lMX0JBQ0tfV1JJVEVNQVNLOiAzNjAwNSwKICAgICAgICBWSUVXUE9SVDogMjk3OCwKICAgICAgICBTQ0lTU09SX0JPWDogMzA4OCwKICAgICAgICBDT0xPUl9DTEVBUl9WQUxVRTogMzEwNiwKICAgICAgICBDT0xPUl9XUklURU1BU0s6IDMxMDcsCiAgICAgICAgVU5QQUNLX0FMSUdOTUVOVDogMzMxNywKICAgICAgICBQQUNLX0FMSUdOTUVOVDogMzMzMywKICAgICAgICBNQVhfVEVYVFVSRV9TSVpFOiAzMzc5LAogICAgICAgIE1BWF9WSUVXUE9SVF9ESU1TOiAzMzg2LAogICAgICAgIFNVQlBJWEVMX0JJVFM6IDM0MDgsCiAgICAgICAgUkVEX0JJVFM6IDM0MTAsCiAgICAgICAgR1JFRU5fQklUUzogMzQxMSwKICAgICAgICBCTFVFX0JJVFM6IDM0MTIsCiAgICAgICAgQUxQSEFfQklUUzogMzQxMywKICAgICAgICBERVBUSF9CSVRTOiAzNDE0LAogICAgICAgIFNURU5DSUxfQklUUzogMzQxNSwKICAgICAgICBQT0xZR09OX09GRlNFVF9VTklUUzogMTA3NTIsCiAgICAgICAgUE9MWUdPTl9PRkZTRVRfRkFDVE9SOiAzMjgyNCwKICAgICAgICBURVhUVVJFX0JJTkRJTkdfMkQ6IDMyODczLAogICAgICAgIFNBTVBMRV9CVUZGRVJTOiAzMjkzNiwKICAgICAgICBTQU1QTEVTOiAzMjkzNywKICAgICAgICBTQU1QTEVfQ09WRVJBR0VfVkFMVUU6IDMyOTM4LAogICAgICAgIFNBTVBMRV9DT1ZFUkFHRV9JTlZFUlQ6IDMyOTM5LAogICAgICAgIENPTVBSRVNTRURfVEVYVFVSRV9GT1JNQVRTOiAzNDQ2NywKICAgICAgICBET05UX0NBUkU6IDQzNTIsCiAgICAgICAgRkFTVEVTVDogNDM1MywKICAgICAgICBOSUNFU1Q6IDQzNTQsCiAgICAgICAgR0VORVJBVEVfTUlQTUFQX0hJTlQ6IDMzMTcwLAogICAgICAgIEJZVEU6IDUxMjAsCiAgICAgICAgVU5TSUdORURfQllURTogNTEyMSwKICAgICAgICBTSE9SVDogNTEyMiwKICAgICAgICBVTlNJR05FRF9TSE9SVDogNTEyMywKICAgICAgICBJTlQ6IDUxMjQsCiAgICAgICAgVU5TSUdORURfSU5UOiA1MTI1LAogICAgICAgIEZMT0FUOiA1MTI2LAogICAgICAgIERFUFRIX0NPTVBPTkVOVDogNjQwMiwKICAgICAgICBBTFBIQTogNjQwNiwKICAgICAgICBSR0I6IDY0MDcsCiAgICAgICAgUkdCQTogNjQwOCwKICAgICAgICBMVU1JTkFOQ0U6IDY0MDksCiAgICAgICAgTFVNSU5BTkNFX0FMUEhBOiA2NDEwLAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzRfNF80XzQ6IDMyODE5LAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzVfNV81XzE6IDMyODIwLAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzVfNl81OiAzMzYzNSwKICAgICAgICBGUkFHTUVOVF9TSEFERVI6IDM1NjMyLAogICAgICAgIFZFUlRFWF9TSEFERVI6IDM1NjMzLAogICAgICAgIE1BWF9WRVJURVhfQVRUUklCUzogMzQ5MjEsCiAgICAgICAgTUFYX1ZFUlRFWF9VTklGT1JNX1ZFQ1RPUlM6IDM2MzQ3LAogICAgICAgIE1BWF9WQVJZSU5HX1ZFQ1RPUlM6IDM2MzQ4LAogICAgICAgIE1BWF9DT01CSU5FRF9URVhUVVJFX0lNQUdFX1VOSVRTOiAzNTY2MSwKICAgICAgICBNQVhfVkVSVEVYX1RFWFRVUkVfSU1BR0VfVU5JVFM6IDM1NjYwLAogICAgICAgIE1BWF9URVhUVVJFX0lNQUdFX1VOSVRTOiAzNDkzMCwKICAgICAgICBNQVhfRlJBR01FTlRfVU5JRk9STV9WRUNUT1JTOiAzNjM0OSwKICAgICAgICBTSEFERVJfVFlQRTogMzU2NjMsCiAgICAgICAgREVMRVRFX1NUQVRVUzogMzU3MTIsCiAgICAgICAgTElOS19TVEFUVVM6IDM1NzE0LAogICAgICAgIFZBTElEQVRFX1NUQVRVUzogMzU3MTUsCiAgICAgICAgQVRUQUNIRURfU0hBREVSUzogMzU3MTcsCiAgICAgICAgQUNUSVZFX1VOSUZPUk1TOiAzNTcxOCwKICAgICAgICBBQ1RJVkVfQVRUUklCVVRFUzogMzU3MjEsCiAgICAgICAgU0hBRElOR19MQU5HVUFHRV9WRVJTSU9OOiAzNTcyNCwKICAgICAgICBDVVJSRU5UX1BST0dSQU06IDM1NzI1LAogICAgICAgIE5FVkVSOiA1MTIsCiAgICAgICAgTEVTUzogNTEzLAogICAgICAgIEVRVUFMOiA1MTQsCiAgICAgICAgTEVRVUFMOiA1MTUsCiAgICAgICAgR1JFQVRFUjogNTE2LAogICAgICAgIE5PVEVRVUFMOiA1MTcsCiAgICAgICAgR0VRVUFMOiA1MTgsCiAgICAgICAgQUxXQVlTOiA1MTksCiAgICAgICAgS0VFUDogNzY4MCwKICAgICAgICBSRVBMQUNFOiA3NjgxLAogICAgICAgIElOQ1I6IDc2ODIsCiAgICAgICAgREVDUjogNzY4MywKICAgICAgICBJTlZFUlQ6IDUzODYsCiAgICAgICAgSU5DUl9XUkFQOiAzNDA1NSwKICAgICAgICBERUNSX1dSQVA6IDM0MDU2LAogICAgICAgIFZFTkRPUjogNzkzNiwKICAgICAgICBSRU5ERVJFUjogNzkzNywKICAgICAgICBWRVJTSU9OOiA3OTM4LAogICAgICAgIE5FQVJFU1Q6IDk3MjgsCiAgICAgICAgTElORUFSOiA5NzI5LAogICAgICAgIE5FQVJFU1RfTUlQTUFQX05FQVJFU1Q6IDk5ODQsCiAgICAgICAgTElORUFSX01JUE1BUF9ORUFSRVNUOiA5OTg1LAogICAgICAgIE5FQVJFU1RfTUlQTUFQX0xJTkVBUjogOTk4NiwKICAgICAgICBMSU5FQVJfTUlQTUFQX0xJTkVBUjogOTk4NywKICAgICAgICBURVhUVVJFX01BR19GSUxURVI6IDEwMjQwLAogICAgICAgIFRFWFRVUkVfTUlOX0ZJTFRFUjogMTAyNDEsCiAgICAgICAgVEVYVFVSRV9XUkFQX1M6IDEwMjQyLAogICAgICAgIFRFWFRVUkVfV1JBUF9UOiAxMDI0MywKICAgICAgICBURVhUVVJFXzJEOiAzNTUzLAogICAgICAgIFRFWFRVUkU6IDU4OTAsCiAgICAgICAgVEVYVFVSRV9DVUJFX01BUDogMzQwNjcsCiAgICAgICAgVEVYVFVSRV9CSU5ESU5HX0NVQkVfTUFQOiAzNDA2OCwKICAgICAgICBURVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1g6IDM0MDY5LAogICAgICAgIFRFWFRVUkVfQ1VCRV9NQVBfTkVHQVRJVkVfWDogMzQwNzAsCiAgICAgICAgVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9ZOiAzNDA3MSwKICAgICAgICBURVhUVVJFX0NVQkVfTUFQX05FR0FUSVZFX1k6IDM0MDcyLAogICAgICAgIFRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWjogMzQwNzMsCiAgICAgICAgVEVYVFVSRV9DVUJFX01BUF9ORUdBVElWRV9aOiAzNDA3NCwKICAgICAgICBNQVhfQ1VCRV9NQVBfVEVYVFVSRV9TSVpFOiAzNDA3NiwKICAgICAgICBURVhUVVJFMDogMzM5ODQsCiAgICAgICAgVEVYVFVSRTE6IDMzOTg1LAogICAgICAgIFRFWFRVUkUyOiAzMzk4NiwKICAgICAgICBURVhUVVJFMzogMzM5ODcsCiAgICAgICAgVEVYVFVSRTQ6IDMzOTg4LAogICAgICAgIFRFWFRVUkU1OiAzMzk4OSwKICAgICAgICBURVhUVVJFNjogMzM5OTAsCiAgICAgICAgVEVYVFVSRTc6IDMzOTkxLAogICAgICAgIFRFWFRVUkU4OiAzMzk5MiwKICAgICAgICBURVhUVVJFOTogMzM5OTMsCiAgICAgICAgVEVYVFVSRTEwOiAzMzk5NCwKICAgICAgICBURVhUVVJFMTE6IDMzOTk1LAogICAgICAgIFRFWFRVUkUxMjogMzM5OTYsCiAgICAgICAgVEVYVFVSRTEzOiAzMzk5NywKICAgICAgICBURVhUVVJFMTQ6IDMzOTk4LAogICAgICAgIFRFWFRVUkUxNTogMzM5OTksCiAgICAgICAgVEVYVFVSRTE2OiAzNGUzLAogICAgICAgIFRFWFRVUkUxNzogMzQwMDEsCiAgICAgICAgVEVYVFVSRTE4OiAzNDAwMiwKICAgICAgICBURVhUVVJFMTk6IDM0MDAzLAogICAgICAgIFRFWFRVUkUyMDogMzQwMDQsCiAgICAgICAgVEVYVFVSRTIxOiAzNDAwNSwKICAgICAgICBURVhUVVJFMjI6IDM0MDA2LAogICAgICAgIFRFWFRVUkUyMzogMzQwMDcsCiAgICAgICAgVEVYVFVSRTI0OiAzNDAwOCwKICAgICAgICBURVhUVVJFMjU6IDM0MDA5LAogICAgICAgIFRFWFRVUkUyNjogMzQwMTAsCiAgICAgICAgVEVYVFVSRTI3OiAzNDAxMSwKICAgICAgICBURVhUVVJFMjg6IDM0MDEyLAogICAgICAgIFRFWFRVUkUyOTogMzQwMTMsCiAgICAgICAgVEVYVFVSRTMwOiAzNDAxNCwKICAgICAgICBURVhUVVJFMzE6IDM0MDE1LAogICAgICAgIEFDVElWRV9URVhUVVJFOiAzNDAxNiwKICAgICAgICBSRVBFQVQ6IDEwNDk3LAogICAgICAgIENMQU1QX1RPX0VER0U6IDMzMDcxLAogICAgICAgIE1JUlJPUkVEX1JFUEVBVDogMzM2NDgsCiAgICAgICAgRkxPQVRfVkVDMjogMzU2NjQsCiAgICAgICAgRkxPQVRfVkVDMzogMzU2NjUsCiAgICAgICAgRkxPQVRfVkVDNDogMzU2NjYsCiAgICAgICAgSU5UX1ZFQzI6IDM1NjY3LAogICAgICAgIElOVF9WRUMzOiAzNTY2OCwKICAgICAgICBJTlRfVkVDNDogMzU2NjksCiAgICAgICAgQk9PTDogMzU2NzAsCiAgICAgICAgQk9PTF9WRUMyOiAzNTY3MSwKICAgICAgICBCT09MX1ZFQzM6IDM1NjcyLAogICAgICAgIEJPT0xfVkVDNDogMzU2NzMsCiAgICAgICAgRkxPQVRfTUFUMjogMzU2NzQsCiAgICAgICAgRkxPQVRfTUFUMzogMzU2NzUsCiAgICAgICAgRkxPQVRfTUFUNDogMzU2NzYsCiAgICAgICAgU0FNUExFUl8yRDogMzU2NzgsCiAgICAgICAgU0FNUExFUl9DVUJFOiAzNTY4MCwKICAgICAgICBWRVJURVhfQVRUUklCX0FSUkFZX0VOQUJMRUQ6IDM0MzM4LAogICAgICAgIFZFUlRFWF9BVFRSSUJfQVJSQVlfU0laRTogMzQzMzksCiAgICAgICAgVkVSVEVYX0FUVFJJQl9BUlJBWV9TVFJJREU6IDM0MzQwLAogICAgICAgIFZFUlRFWF9BVFRSSUJfQVJSQVlfVFlQRTogMzQzNDEsCiAgICAgICAgVkVSVEVYX0FUVFJJQl9BUlJBWV9OT1JNQUxJWkVEOiAzNDkyMiwKICAgICAgICBWRVJURVhfQVRUUklCX0FSUkFZX1BPSU5URVI6IDM0MzczLAogICAgICAgIFZFUlRFWF9BVFRSSUJfQVJSQVlfQlVGRkVSX0JJTkRJTkc6IDM0OTc1LAogICAgICAgIElNUExFTUVOVEFUSU9OX0NPTE9SX1JFQURfVFlQRTogMzU3MzgsCiAgICAgICAgSU1QTEVNRU5UQVRJT05fQ09MT1JfUkVBRF9GT1JNQVQ6IDM1NzM5LAogICAgICAgIENPTVBJTEVfU1RBVFVTOiAzNTcxMywKICAgICAgICBMT1dfRkxPQVQ6IDM2MzM2LAogICAgICAgIE1FRElVTV9GTE9BVDogMzYzMzcsCiAgICAgICAgSElHSF9GTE9BVDogMzYzMzgsCiAgICAgICAgTE9XX0lOVDogMzYzMzksCiAgICAgICAgTUVESVVNX0lOVDogMzYzNDAsCiAgICAgICAgSElHSF9JTlQ6IDM2MzQxLAogICAgICAgIEZSQU1FQlVGRkVSOiAzNjE2MCwKICAgICAgICBSRU5ERVJCVUZGRVI6IDM2MTYxLAogICAgICAgIFJHQkE0OiAzMjg1NCwKICAgICAgICBSR0I1X0ExOiAzMjg1NSwKICAgICAgICBSR0I1NjU6IDM2MTk0LAogICAgICAgIERFUFRIX0NPTVBPTkVOVDE2OiAzMzE4OSwKICAgICAgICBTVEVOQ0lMX0lOREVYOiA2NDAxLAogICAgICAgIFNURU5DSUxfSU5ERVg4OiAzNjE2OCwKICAgICAgICBERVBUSF9TVEVOQ0lMOiAzNDA0MSwKICAgICAgICBSRU5ERVJCVUZGRVJfV0lEVEg6IDM2MTYyLAogICAgICAgIFJFTkRFUkJVRkZFUl9IRUlHSFQ6IDM2MTYzLAogICAgICAgIFJFTkRFUkJVRkZFUl9JTlRFUk5BTF9GT1JNQVQ6IDM2MTY0LAogICAgICAgIFJFTkRFUkJVRkZFUl9SRURfU0laRTogMzYxNzYsCiAgICAgICAgUkVOREVSQlVGRkVSX0dSRUVOX1NJWkU6IDM2MTc3LAogICAgICAgIFJFTkRFUkJVRkZFUl9CTFVFX1NJWkU6IDM2MTc4LAogICAgICAgIFJFTkRFUkJVRkZFUl9BTFBIQV9TSVpFOiAzNjE3OSwKICAgICAgICBSRU5ERVJCVUZGRVJfREVQVEhfU0laRTogMzYxODAsCiAgICAgICAgUkVOREVSQlVGRkVSX1NURU5DSUxfU0laRTogMzYxODEsCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9PQkpFQ1RfVFlQRTogMzYwNDgsCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9PQkpFQ1RfTkFNRTogMzYwNDksCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9URVhUVVJFX0xFVkVMOiAzNjA1MCwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX1RFWFRVUkVfQ1VCRV9NQVBfRkFDRTogMzYwNTEsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDA6IDM2MDY0LAogICAgICAgIERFUFRIX0FUVEFDSE1FTlQ6IDM2MDk2LAogICAgICAgIFNURU5DSUxfQVRUQUNITUVOVDogMzYxMjgsCiAgICAgICAgREVQVEhfU1RFTkNJTF9BVFRBQ0hNRU5UOiAzMzMwNiwKICAgICAgICBOT05FOiAwLAogICAgICAgIEZSQU1FQlVGRkVSX0NPTVBMRVRFOiAzNjA1MywKICAgICAgICBGUkFNRUJVRkZFUl9JTkNPTVBMRVRFX0FUVEFDSE1FTlQ6IDM2MDU0LAogICAgICAgIEZSQU1FQlVGRkVSX0lOQ09NUExFVEVfTUlTU0lOR19BVFRBQ0hNRU5UOiAzNjA1NSwKICAgICAgICBGUkFNRUJVRkZFUl9JTkNPTVBMRVRFX0RJTUVOU0lPTlM6IDM2MDU3LAogICAgICAgIEZSQU1FQlVGRkVSX1VOU1VQUE9SVEVEOiAzNjA2MSwKICAgICAgICBGUkFNRUJVRkZFUl9CSU5ESU5HOiAzNjAwNiwKICAgICAgICBSRU5ERVJCVUZGRVJfQklORElORzogMzYwMDcsCiAgICAgICAgTUFYX1JFTkRFUkJVRkZFUl9TSVpFOiAzNDAyNCwKICAgICAgICBJTlZBTElEX0ZSQU1FQlVGRkVSX09QRVJBVElPTjogMTI4NiwKICAgICAgICBVTlBBQ0tfRkxJUF9ZX1dFQkdMOiAzNzQ0MCwKICAgICAgICBVTlBBQ0tfUFJFTVVMVElQTFlfQUxQSEFfV0VCR0w6IDM3NDQxLAogICAgICAgIENPTlRFWFRfTE9TVF9XRUJHTDogMzc0NDIsCiAgICAgICAgVU5QQUNLX0NPTE9SU1BBQ0VfQ09OVkVSU0lPTl9XRUJHTDogMzc0NDMsCiAgICAgICAgQlJPV1NFUl9ERUZBVUxUX1dFQkdMOiAzNzQ0NCwKICAgICAgICAvLyBXRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfczN0YwogICAgICAgIENPTVBSRVNTRURfUkdCX1MzVENfRFhUMV9FWFQ6IDMzNzc2LAogICAgICAgIENPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDFfRVhUOiAzMzc3NywKICAgICAgICBDT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQzX0VYVDogMzM3NzgsCiAgICAgICAgQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUNV9FWFQ6IDMzNzc5LAogICAgICAgIC8vIFdFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9wdnJ0YwogICAgICAgIENPTVBSRVNTRURfUkdCX1BWUlRDXzRCUFBWMV9JTUc6IDM1ODQwLAogICAgICAgIENPTVBSRVNTRURfUkdCX1BWUlRDXzJCUFBWMV9JTUc6IDM1ODQxLAogICAgICAgIENPTVBSRVNTRURfUkdCQV9QVlJUQ180QlBQVjFfSU1HOiAzNTg0MiwKICAgICAgICBDT01QUkVTU0VEX1JHQkFfUFZSVENfMkJQUFYxX0lNRzogMzU4NDMsCiAgICAgICAgLy8gV0VCR0xfY29tcHJlc3NlZF90ZXh0dXJlX2FzdGMKICAgICAgICBDT01QUkVTU0VEX1JHQkFfQVNUQ180eDRfV0VCR0w6IDM3ODA4LAogICAgICAgIC8vIFdFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9ldGMxCiAgICAgICAgQ09NUFJFU1NFRF9SR0JfRVRDMV9XRUJHTDogMzYxOTYsCiAgICAgICAgLy8gRVhUX3RleHR1cmVfY29tcHJlc3Npb25fYnB0YwogICAgICAgIENPTVBSRVNTRURfUkdCQV9CUFRDX1VOT1JNOiAzNjQ5MiwKICAgICAgICAvLyBFWFRfY29sb3JfYnVmZmVyX2hhbGZfZmxvYXQKICAgICAgICBIQUxGX0ZMT0FUX09FUzogMzYxOTMsCiAgICAgICAgLy8gRGVza3RvcCBPcGVuR0wKICAgICAgICBET1VCTEU6IDUxMzAsCiAgICAgICAgLy8gV2ViR0wgMgogICAgICAgIFJFQURfQlVGRkVSOiAzMDc0LAogICAgICAgIFVOUEFDS19ST1dfTEVOR1RIOiAzMzE0LAogICAgICAgIFVOUEFDS19TS0lQX1JPV1M6IDMzMTUsCiAgICAgICAgVU5QQUNLX1NLSVBfUElYRUxTOiAzMzE2LAogICAgICAgIFBBQ0tfUk9XX0xFTkdUSDogMzMzMCwKICAgICAgICBQQUNLX1NLSVBfUk9XUzogMzMzMSwKICAgICAgICBQQUNLX1NLSVBfUElYRUxTOiAzMzMyLAogICAgICAgIENPTE9SOiA2MTQ0LAogICAgICAgIERFUFRIOiA2MTQ1LAogICAgICAgIFNURU5DSUw6IDYxNDYsCiAgICAgICAgUkVEOiA2NDAzLAogICAgICAgIFJHQjg6IDMyODQ5LAogICAgICAgIFJHQkE4OiAzMjg1NiwKICAgICAgICBSR0IxMF9BMjogMzI4NTcsCiAgICAgICAgVEVYVFVSRV9CSU5ESU5HXzNEOiAzMjg3NCwKICAgICAgICBVTlBBQ0tfU0tJUF9JTUFHRVM6IDMyODc3LAogICAgICAgIFVOUEFDS19JTUFHRV9IRUlHSFQ6IDMyODc4LAogICAgICAgIFRFWFRVUkVfM0Q6IDMyODc5LAogICAgICAgIFRFWFRVUkVfV1JBUF9SOiAzMjg4MiwKICAgICAgICBNQVhfM0RfVEVYVFVSRV9TSVpFOiAzMjg4MywKICAgICAgICBVTlNJR05FRF9JTlRfMl8xMF8xMF8xMF9SRVY6IDMzNjQwLAogICAgICAgIE1BWF9FTEVNRU5UU19WRVJUSUNFUzogMzNlMywKICAgICAgICBNQVhfRUxFTUVOVFNfSU5ESUNFUzogMzMwMDEsCiAgICAgICAgVEVYVFVSRV9NSU5fTE9EOiAzMzA4MiwKICAgICAgICBURVhUVVJFX01BWF9MT0Q6IDMzMDgzLAogICAgICAgIFRFWFRVUkVfQkFTRV9MRVZFTDogMzMwODQsCiAgICAgICAgVEVYVFVSRV9NQVhfTEVWRUw6IDMzMDg1LAogICAgICAgIE1JTjogMzI3NzUsCiAgICAgICAgTUFYOiAzMjc3NiwKICAgICAgICBERVBUSF9DT01QT05FTlQyNDogMzMxOTAsCiAgICAgICAgTUFYX1RFWFRVUkVfTE9EX0JJQVM6IDM0MDQ1LAogICAgICAgIFRFWFRVUkVfQ09NUEFSRV9NT0RFOiAzNDg5MiwKICAgICAgICBURVhUVVJFX0NPTVBBUkVfRlVOQzogMzQ4OTMsCiAgICAgICAgQ1VSUkVOVF9RVUVSWTogMzQ5MTcsCiAgICAgICAgUVVFUllfUkVTVUxUOiAzNDkxOCwKICAgICAgICBRVUVSWV9SRVNVTFRfQVZBSUxBQkxFOiAzNDkxOSwKICAgICAgICBTVFJFQU1fUkVBRDogMzUwNDEsCiAgICAgICAgU1RSRUFNX0NPUFk6IDM1MDQyLAogICAgICAgIFNUQVRJQ19SRUFEOiAzNTA0NSwKICAgICAgICBTVEFUSUNfQ09QWTogMzUwNDYsCiAgICAgICAgRFlOQU1JQ19SRUFEOiAzNTA0OSwKICAgICAgICBEWU5BTUlDX0NPUFk6IDM1MDUwLAogICAgICAgIE1BWF9EUkFXX0JVRkZFUlM6IDM0ODUyLAogICAgICAgIERSQVdfQlVGRkVSMDogMzQ4NTMsCiAgICAgICAgRFJBV19CVUZGRVIxOiAzNDg1NCwKICAgICAgICBEUkFXX0JVRkZFUjI6IDM0ODU1LAogICAgICAgIERSQVdfQlVGRkVSMzogMzQ4NTYsCiAgICAgICAgRFJBV19CVUZGRVI0OiAzNDg1NywKICAgICAgICBEUkFXX0JVRkZFUjU6IDM0ODU4LAogICAgICAgIERSQVdfQlVGRkVSNjogMzQ4NTksCiAgICAgICAgRFJBV19CVUZGRVI3OiAzNDg2MCwKICAgICAgICBEUkFXX0JVRkZFUjg6IDM0ODYxLAogICAgICAgIERSQVdfQlVGRkVSOTogMzQ4NjIsCiAgICAgICAgRFJBV19CVUZGRVIxMDogMzQ4NjMsCiAgICAgICAgRFJBV19CVUZGRVIxMTogMzQ4NjQsCiAgICAgICAgRFJBV19CVUZGRVIxMjogMzQ4NjUsCiAgICAgICAgRFJBV19CVUZGRVIxMzogMzQ4NjYsCiAgICAgICAgRFJBV19CVUZGRVIxNDogMzQ4NjcsCiAgICAgICAgRFJBV19CVUZGRVIxNTogMzQ4NjgsCiAgICAgICAgTUFYX0ZSQUdNRU5UX1VOSUZPUk1fQ09NUE9ORU5UUzogMzU2NTcsCiAgICAgICAgTUFYX1ZFUlRFWF9VTklGT1JNX0NPTVBPTkVOVFM6IDM1NjU4LAogICAgICAgIFNBTVBMRVJfM0Q6IDM1Njc5LAogICAgICAgIFNBTVBMRVJfMkRfU0hBRE9XOiAzNTY4MiwKICAgICAgICBGUkFHTUVOVF9TSEFERVJfREVSSVZBVElWRV9ISU5UOiAzNTcyMywKICAgICAgICBQSVhFTF9QQUNLX0JVRkZFUjogMzUwNTEsCiAgICAgICAgUElYRUxfVU5QQUNLX0JVRkZFUjogMzUwNTIsCiAgICAgICAgUElYRUxfUEFDS19CVUZGRVJfQklORElORzogMzUwNTMsCiAgICAgICAgUElYRUxfVU5QQUNLX0JVRkZFUl9CSU5ESU5HOiAzNTA1NSwKICAgICAgICBGTE9BVF9NQVQyeDM6IDM1Njg1LAogICAgICAgIEZMT0FUX01BVDJ4NDogMzU2ODYsCiAgICAgICAgRkxPQVRfTUFUM3gyOiAzNTY4NywKICAgICAgICBGTE9BVF9NQVQzeDQ6IDM1Njg4LAogICAgICAgIEZMT0FUX01BVDR4MjogMzU2ODksCiAgICAgICAgRkxPQVRfTUFUNHgzOiAzNTY5MCwKICAgICAgICBTUkdCOiAzNTkwNCwKICAgICAgICBTUkdCODogMzU5MDUsCiAgICAgICAgU1JHQjhfQUxQSEE4OiAzNTkwNywKICAgICAgICBDT01QQVJFX1JFRl9UT19URVhUVVJFOiAzNDg5NCwKICAgICAgICBSR0JBMzJGOiAzNDgzNiwKICAgICAgICBSR0IzMkY6IDM0ODM3LAogICAgICAgIFJHQkExNkY6IDM0ODQyLAogICAgICAgIFJHQjE2RjogMzQ4NDMsCiAgICAgICAgVkVSVEVYX0FUVFJJQl9BUlJBWV9JTlRFR0VSOiAzNTA2OSwKICAgICAgICBNQVhfQVJSQVlfVEVYVFVSRV9MQVlFUlM6IDM1MDcxLAogICAgICAgIE1JTl9QUk9HUkFNX1RFWEVMX09GRlNFVDogMzUwNzYsCiAgICAgICAgTUFYX1BST0dSQU1fVEVYRUxfT0ZGU0VUOiAzNTA3NywKICAgICAgICBNQVhfVkFSWUlOR19DT01QT05FTlRTOiAzNTY1OSwKICAgICAgICBURVhUVVJFXzJEX0FSUkFZOiAzNTg2NiwKICAgICAgICBURVhUVVJFX0JJTkRJTkdfMkRfQVJSQVk6IDM1ODY5LAogICAgICAgIFIxMUZfRzExRl9CMTBGOiAzNTg5OCwKICAgICAgICBVTlNJR05FRF9JTlRfMTBGXzExRl8xMUZfUkVWOiAzNTg5OSwKICAgICAgICBSR0I5X0U1OiAzNTkwMSwKICAgICAgICBVTlNJR05FRF9JTlRfNV85XzlfOV9SRVY6IDM1OTAyLAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDS19CVUZGRVJfTU9ERTogMzU5NjcsCiAgICAgICAgTUFYX1RSQU5TRk9STV9GRUVEQkFDS19TRVBBUkFURV9DT01QT05FTlRTOiAzNTk2OCwKICAgICAgICBUUkFOU0ZPUk1fRkVFREJBQ0tfVkFSWUlOR1M6IDM1OTcxLAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDS19CVUZGRVJfU1RBUlQ6IDM1OTcyLAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDS19CVUZGRVJfU0laRTogMzU5NzMsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX1BSSU1JVElWRVNfV1JJVFRFTjogMzU5NzYsCiAgICAgICAgUkFTVEVSSVpFUl9ESVNDQVJEOiAzNTk3NywKICAgICAgICBNQVhfVFJBTlNGT1JNX0ZFRURCQUNLX0lOVEVSTEVBVkVEX0NPTVBPTkVOVFM6IDM1OTc4LAogICAgICAgIE1BWF9UUkFOU0ZPUk1fRkVFREJBQ0tfU0VQQVJBVEVfQVRUUklCUzogMzU5NzksCiAgICAgICAgSU5URVJMRUFWRURfQVRUUklCUzogMzU5ODAsCiAgICAgICAgU0VQQVJBVEVfQVRUUklCUzogMzU5ODEsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0JVRkZFUjogMzU5ODIsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0JVRkZFUl9CSU5ESU5HOiAzNTk4MywKICAgICAgICBSR0JBMzJVSTogMzYyMDgsCiAgICAgICAgUkdCMzJVSTogMzYyMDksCiAgICAgICAgUkdCQTE2VUk6IDM2MjE0LAogICAgICAgIFJHQjE2VUk6IDM2MjE1LAogICAgICAgIFJHQkE4VUk6IDM2MjIwLAogICAgICAgIFJHQjhVSTogMzYyMjEsCiAgICAgICAgUkdCQTMySTogMzYyMjYsCiAgICAgICAgUkdCMzJJOiAzNjIyNywKICAgICAgICBSR0JBMTZJOiAzNjIzMiwKICAgICAgICBSR0IxNkk6IDM2MjMzLAogICAgICAgIFJHQkE4STogMzYyMzgsCiAgICAgICAgUkdCOEk6IDM2MjM5LAogICAgICAgIFJFRF9JTlRFR0VSOiAzNjI0NCwKICAgICAgICBSR0JfSU5URUdFUjogMzYyNDgsCiAgICAgICAgUkdCQV9JTlRFR0VSOiAzNjI0OSwKICAgICAgICBTQU1QTEVSXzJEX0FSUkFZOiAzNjI4OSwKICAgICAgICBTQU1QTEVSXzJEX0FSUkFZX1NIQURPVzogMzYyOTIsCiAgICAgICAgU0FNUExFUl9DVUJFX1NIQURPVzogMzYyOTMsCiAgICAgICAgVU5TSUdORURfSU5UX1ZFQzI6IDM2Mjk0LAogICAgICAgIFVOU0lHTkVEX0lOVF9WRUMzOiAzNjI5NSwKICAgICAgICBVTlNJR05FRF9JTlRfVkVDNDogMzYyOTYsCiAgICAgICAgSU5UX1NBTVBMRVJfMkQ6IDM2Mjk4LAogICAgICAgIElOVF9TQU1QTEVSXzNEOiAzNjI5OSwKICAgICAgICBJTlRfU0FNUExFUl9DVUJFOiAzNjMwMCwKICAgICAgICBJTlRfU0FNUExFUl8yRF9BUlJBWTogMzYzMDMsCiAgICAgICAgVU5TSUdORURfSU5UX1NBTVBMRVJfMkQ6IDM2MzA2LAogICAgICAgIFVOU0lHTkVEX0lOVF9TQU1QTEVSXzNEOiAzNjMwNywKICAgICAgICBVTlNJR05FRF9JTlRfU0FNUExFUl9DVUJFOiAzNjMwOCwKICAgICAgICBVTlNJR05FRF9JTlRfU0FNUExFUl8yRF9BUlJBWTogMzYzMTEsCiAgICAgICAgREVQVEhfQ09NUE9ORU5UMzJGOiAzNjAxMiwKICAgICAgICBERVBUSDMyRl9TVEVOQ0lMODogMzYwMTMsCiAgICAgICAgRkxPQVRfMzJfVU5TSUdORURfSU5UXzI0XzhfUkVWOiAzNjI2OSwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0NPTE9SX0VOQ09ESU5HOiAzMzI5NiwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0NPTVBPTkVOVF9UWVBFOiAzMzI5NywKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX1JFRF9TSVpFOiAzMzI5OCwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0dSRUVOX1NJWkU6IDMzMjk5LAogICAgICAgIEZSQU1FQlVGRkVSX0FUVEFDSE1FTlRfQkxVRV9TSVpFOiAzMzMwMCwKICAgICAgICBGUkFNRUJVRkZFUl9BVFRBQ0hNRU5UX0FMUEhBX1NJWkU6IDMzMzAxLAogICAgICAgIEZSQU1FQlVGRkVSX0FUVEFDSE1FTlRfREVQVEhfU0laRTogMzMzMDIsCiAgICAgICAgRlJBTUVCVUZGRVJfQVRUQUNITUVOVF9TVEVOQ0lMX1NJWkU6IDMzMzAzLAogICAgICAgIEZSQU1FQlVGRkVSX0RFRkFVTFQ6IDMzMzA0LAogICAgICAgIFVOU0lHTkVEX0lOVF8yNF84OiAzNDA0MiwKICAgICAgICBERVBUSDI0X1NURU5DSUw4OiAzNTA1NiwKICAgICAgICBVTlNJR05FRF9OT1JNQUxJWkVEOiAzNTg2MywKICAgICAgICBEUkFXX0ZSQU1FQlVGRkVSX0JJTkRJTkc6IDM2MDA2LAogICAgICAgIC8vIFNhbWUgYXMgRlJBTUVCVUZGRVJfQklORElORwogICAgICAgIFJFQURfRlJBTUVCVUZGRVI6IDM2MDA4LAogICAgICAgIERSQVdfRlJBTUVCVUZGRVI6IDM2MDA5LAogICAgICAgIFJFQURfRlJBTUVCVUZGRVJfQklORElORzogMzYwMTAsCiAgICAgICAgUkVOREVSQlVGRkVSX1NBTVBMRVM6IDM2MDExLAogICAgICAgIEZSQU1FQlVGRkVSX0FUVEFDSE1FTlRfVEVYVFVSRV9MQVlFUjogMzYwNTIsCiAgICAgICAgTUFYX0NPTE9SX0FUVEFDSE1FTlRTOiAzNjA2MywKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UMTogMzYwNjUsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDI6IDM2MDY2LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQzOiAzNjA2NywKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UNDogMzYwNjgsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDU6IDM2MDY5LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQ2OiAzNjA3MCwKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UNzogMzYwNzEsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDg6IDM2MDcyLAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQ5OiAzNjA3MywKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UMTA6IDM2MDc0LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQxMTogMzYwNzUsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDEyOiAzNjA3NiwKICAgICAgICBDT0xPUl9BVFRBQ0hNRU5UMTM6IDM2MDc3LAogICAgICAgIENPTE9SX0FUVEFDSE1FTlQxNDogMzYwNzgsCiAgICAgICAgQ09MT1JfQVRUQUNITUVOVDE1OiAzNjA3OSwKICAgICAgICBGUkFNRUJVRkZFUl9JTkNPTVBMRVRFX01VTFRJU0FNUExFOiAzNjE4MiwKICAgICAgICBNQVhfU0FNUExFUzogMzYxODMsCiAgICAgICAgSEFMRl9GTE9BVDogNTEzMSwKICAgICAgICBSRzogMzMzMTksCiAgICAgICAgUkdfSU5URUdFUjogMzMzMjAsCiAgICAgICAgUjg6IDMzMzIxLAogICAgICAgIFJHODogMzMzMjMsCiAgICAgICAgUjE2RjogMzMzMjUsCiAgICAgICAgUjMyRjogMzMzMjYsCiAgICAgICAgUkcxNkY6IDMzMzI3LAogICAgICAgIFJHMzJGOiAzMzMyOCwKICAgICAgICBSOEk6IDMzMzI5LAogICAgICAgIFI4VUk6IDMzMzMwLAogICAgICAgIFIxNkk6IDMzMzMxLAogICAgICAgIFIxNlVJOiAzMzMzMiwKICAgICAgICBSMzJJOiAzMzMzMywKICAgICAgICBSMzJVSTogMzMzMzQsCiAgICAgICAgUkc4STogMzMzMzUsCiAgICAgICAgUkc4VUk6IDMzMzM2LAogICAgICAgIFJHMTZJOiAzMzMzNywKICAgICAgICBSRzE2VUk6IDMzMzM4LAogICAgICAgIFJHMzJJOiAzMzMzOSwKICAgICAgICBSRzMyVUk6IDMzMzQwLAogICAgICAgIFZFUlRFWF9BUlJBWV9CSU5ESU5HOiAzNDIyOSwKICAgICAgICBSOF9TTk9STTogMzY3NTYsCiAgICAgICAgUkc4X1NOT1JNOiAzNjc1NywKICAgICAgICBSR0I4X1NOT1JNOiAzNjc1OCwKICAgICAgICBSR0JBOF9TTk9STTogMzY3NTksCiAgICAgICAgU0lHTkVEX05PUk1BTElaRUQ6IDM2NzY0LAogICAgICAgIENPUFlfUkVBRF9CVUZGRVI6IDM2NjYyLAogICAgICAgIENPUFlfV1JJVEVfQlVGRkVSOiAzNjY2MywKICAgICAgICBDT1BZX1JFQURfQlVGRkVSX0JJTkRJTkc6IDM2NjYyLAogICAgICAgIC8vIFNhbWUgYXMgQ09QWV9SRUFEX0JVRkZFUgogICAgICAgIENPUFlfV1JJVEVfQlVGRkVSX0JJTkRJTkc6IDM2NjYzLAogICAgICAgIC8vIFNhbWUgYXMgQ09QWV9XUklURV9CVUZGRVIKICAgICAgICBVTklGT1JNX0JVRkZFUjogMzUzNDUsCiAgICAgICAgVU5JRk9STV9CVUZGRVJfQklORElORzogMzUzNjgsCiAgICAgICAgVU5JRk9STV9CVUZGRVJfU1RBUlQ6IDM1MzY5LAogICAgICAgIFVOSUZPUk1fQlVGRkVSX1NJWkU6IDM1MzcwLAogICAgICAgIE1BWF9WRVJURVhfVU5JRk9STV9CTE9DS1M6IDM1MzcxLAogICAgICAgIE1BWF9GUkFHTUVOVF9VTklGT1JNX0JMT0NLUzogMzUzNzMsCiAgICAgICAgTUFYX0NPTUJJTkVEX1VOSUZPUk1fQkxPQ0tTOiAzNTM3NCwKICAgICAgICBNQVhfVU5JRk9STV9CVUZGRVJfQklORElOR1M6IDM1Mzc1LAogICAgICAgIE1BWF9VTklGT1JNX0JMT0NLX1NJWkU6IDM1Mzc2LAogICAgICAgIE1BWF9DT01CSU5FRF9WRVJURVhfVU5JRk9STV9DT01QT05FTlRTOiAzNTM3NywKICAgICAgICBNQVhfQ09NQklORURfRlJBR01FTlRfVU5JRk9STV9DT01QT05FTlRTOiAzNTM3OSwKICAgICAgICBVTklGT1JNX0JVRkZFUl9PRkZTRVRfQUxJR05NRU5UOiAzNTM4MCwKICAgICAgICBBQ1RJVkVfVU5JRk9STV9CTE9DS1M6IDM1MzgyLAogICAgICAgIFVOSUZPUk1fVFlQRTogMzUzODMsCiAgICAgICAgVU5JRk9STV9TSVpFOiAzNTM4NCwKICAgICAgICBVTklGT1JNX0JMT0NLX0lOREVYOiAzNTM4NiwKICAgICAgICBVTklGT1JNX09GRlNFVDogMzUzODcsCiAgICAgICAgVU5JRk9STV9BUlJBWV9TVFJJREU6IDM1Mzg4LAogICAgICAgIFVOSUZPUk1fTUFUUklYX1NUUklERTogMzUzODksCiAgICAgICAgVU5JRk9STV9JU19ST1dfTUFKT1I6IDM1MzkwLAogICAgICAgIFVOSUZPUk1fQkxPQ0tfQklORElORzogMzUzOTEsCiAgICAgICAgVU5JRk9STV9CTE9DS19EQVRBX1NJWkU6IDM1MzkyLAogICAgICAgIFVOSUZPUk1fQkxPQ0tfQUNUSVZFX1VOSUZPUk1TOiAzNTM5NCwKICAgICAgICBVTklGT1JNX0JMT0NLX0FDVElWRV9VTklGT1JNX0lORElDRVM6IDM1Mzk1LAogICAgICAgIFVOSUZPUk1fQkxPQ0tfUkVGRVJFTkNFRF9CWV9WRVJURVhfU0hBREVSOiAzNTM5NiwKICAgICAgICBVTklGT1JNX0JMT0NLX1JFRkVSRU5DRURfQllfRlJBR01FTlRfU0hBREVSOiAzNTM5OCwKICAgICAgICBJTlZBTElEX0lOREVYOiA0Mjk0OTY3Mjk1LAogICAgICAgIE1BWF9WRVJURVhfT1VUUFVUX0NPTVBPTkVOVFM6IDM3MTU0LAogICAgICAgIE1BWF9GUkFHTUVOVF9JTlBVVF9DT01QT05FTlRTOiAzNzE1NywKICAgICAgICBNQVhfU0VSVkVSX1dBSVRfVElNRU9VVDogMzcxMzcsCiAgICAgICAgT0JKRUNUX1RZUEU6IDM3MTM4LAogICAgICAgIFNZTkNfQ09ORElUSU9OOiAzNzEzOSwKICAgICAgICBTWU5DX1NUQVRVUzogMzcxNDAsCiAgICAgICAgU1lOQ19GTEFHUzogMzcxNDEsCiAgICAgICAgU1lOQ19GRU5DRTogMzcxNDIsCiAgICAgICAgU1lOQ19HUFVfQ09NTUFORFNfQ09NUExFVEU6IDM3MTQzLAogICAgICAgIFVOU0lHTkFMRUQ6IDM3MTQ0LAogICAgICAgIFNJR05BTEVEOiAzNzE0NSwKICAgICAgICBBTFJFQURZX1NJR05BTEVEOiAzNzE0NiwKICAgICAgICBUSU1FT1VUX0VYUElSRUQ6IDM3MTQ3LAogICAgICAgIENPTkRJVElPTl9TQVRJU0ZJRUQ6IDM3MTQ4LAogICAgICAgIFdBSVRfRkFJTEVEOiAzNzE0OSwKICAgICAgICBTWU5DX0ZMVVNIX0NPTU1BTkRTX0JJVDogMSwKICAgICAgICBWRVJURVhfQVRUUklCX0FSUkFZX0RJVklTT1I6IDM1MDcwLAogICAgICAgIEFOWV9TQU1QTEVTX1BBU1NFRDogMzU4ODcsCiAgICAgICAgQU5ZX1NBTVBMRVNfUEFTU0VEX0NPTlNFUlZBVElWRTogMzYyMDIsCiAgICAgICAgU0FNUExFUl9CSU5ESU5HOiAzNTA5NywKICAgICAgICBSR0IxMF9BMlVJOiAzNjk3NSwKICAgICAgICBJTlRfMl8xMF8xMF8xMF9SRVY6IDM2MjU1LAogICAgICAgIFRSQU5TRk9STV9GRUVEQkFDSzogMzYzODYsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX1BBVVNFRDogMzYzODcsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0FDVElWRTogMzYzODgsCiAgICAgICAgVFJBTlNGT1JNX0ZFRURCQUNLX0JJTkRJTkc6IDM2Mzg5LAogICAgICAgIENPTVBSRVNTRURfUjExX0VBQzogMzc0ODgsCiAgICAgICAgQ09NUFJFU1NFRF9TSUdORURfUjExX0VBQzogMzc0ODksCiAgICAgICAgQ09NUFJFU1NFRF9SRzExX0VBQzogMzc0OTAsCiAgICAgICAgQ09NUFJFU1NFRF9TSUdORURfUkcxMV9FQUM6IDM3NDkxLAogICAgICAgIENPTVBSRVNTRURfUkdCOF9FVEMyOiAzNzQ5MiwKICAgICAgICBDT01QUkVTU0VEX1NSR0I4X0VUQzI6IDM3NDkzLAogICAgICAgIENPTVBSRVNTRURfUkdCOF9QVU5DSFRIUk9VR0hfQUxQSEExX0VUQzI6IDM3NDk0LAogICAgICAgIENPTVBSRVNTRURfU1JHQjhfUFVOQ0hUSFJPVUdIX0FMUEhBMV9FVEMyOiAzNzQ5NSwKICAgICAgICBDT01QUkVTU0VEX1JHQkE4X0VUQzJfRUFDOiAzNzQ5NiwKICAgICAgICBDT01QUkVTU0VEX1NSR0I4X0FMUEhBOF9FVEMyX0VBQzogMzc0OTcsCiAgICAgICAgVEVYVFVSRV9JTU1VVEFCTEVfRk9STUFUOiAzNzE2NywKICAgICAgICBNQVhfRUxFTUVOVF9JTkRFWDogMzYyMDMsCiAgICAgICAgVEVYVFVSRV9JTU1VVEFCTEVfTEVWRUxTOiAzMzUwMywKICAgICAgICAvLyBFeHRlbnNpb25zCiAgICAgICAgTUFYX1RFWFRVUkVfTUFYX0FOSVNPVFJPUFlfRVhUOiAzNDA0NwogICAgICB9OwogICAgICBXZWJHTENvbnN0YW50c19kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShXZWJHTENvbnN0YW50cyk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db21wb25lbnREYXRhdHlwZS5qcwogIHZhciBDb21wb25lbnREYXRhdHlwZSwgQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9Db21wb25lbnREYXRhdHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29tcG9uZW50RGF0YXR5cGUuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X1dlYkdMQ29uc3RhbnRzKCk7CiAgICAgIENvbXBvbmVudERhdGF0eXBlID0gewogICAgICAgIC8qKgogICAgICAgICAqIDgtYml0IHNpZ25lZCBieXRlIGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+Z2wuQllURTwvY29kZT4gYW5kIHRoZSB0eXBlCiAgICAgICAgICogb2YgYW4gZWxlbWVudCBpbiA8Y29kZT5JbnQ4QXJyYXk8L2NvZGU+LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBCWVRFOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkJZVEUsCiAgICAgICAgLyoqCiAgICAgICAgICogOC1iaXQgdW5zaWduZWQgYnl0ZSBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPlVOU0lHTkVEX0JZVEU8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+VWludDhBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFVOU0lHTkVEX0JZVEU6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAvKioKICAgICAgICAgKiAxNi1iaXQgc2lnbmVkIHNob3J0IGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+U0hPUlQ8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+SW50MTZBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFNIT1JUOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlNIT1JULAogICAgICAgIC8qKgogICAgICAgICAqIDE2LWJpdCB1bnNpZ25lZCBzaG9ydCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPlVOU0lHTkVEX1NIT1JUPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPlVpbnQxNkFycmF5PC9jb2RlPi4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVU5TSUdORURfU0hPUlQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfU0hPUlQsCiAgICAgICAgLyoqCiAgICAgICAgICogMzItYml0IHNpZ25lZCBpbnQgY29ycmVzcG9uZGluZyB0byA8Y29kZT5JTlQ8L2NvZGU+IGFuZCB0aGUgdHlwZQogICAgICAgICAqIG9mIGFuIGVsZW1lbnQgaW4gPGNvZGU+SW50MzJBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyT2YgQ29tcG9uZW50RGF0YXR5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgSU5UOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LklOVCwKICAgICAgICAvKioKICAgICAgICAgKiAzMi1iaXQgdW5zaWduZWQgaW50IGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+VU5TSUdORURfSU5UPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPlVpbnQzMkFycmF5PC9jb2RlPi4KICAgICAgICAgKgogICAgICAgICAqIEBtZW1iZXJPZiBDb21wb25lbnREYXRhdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBVTlNJR05FRF9JTlQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfSU5ULAogICAgICAgIC8qKgogICAgICAgICAqIDMyLWJpdCBmbG9hdGluZy1wb2ludCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPkZMT0FUPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPkZsb2F0MzJBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEZMT0FUOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkZMT0FULAogICAgICAgIC8qKgogICAgICAgICAqIDY0LWJpdCBmbG9hdGluZy1wb2ludCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPmdsLkRPVUJMRTwvY29kZT4gKGluIERlc2t0b3AgT3BlbkdMOwogICAgICAgICAqIHRoaXMgaXMgbm90IHN1cHBvcnRlZCBpbiBXZWJHTCwgYW5kIGlzIGVtdWxhdGVkIGluIENlc2l1bSB2aWEge0BsaW5rIEdlb21ldHJ5UGlwZWxpbmUuZW5jb2RlQXR0cmlidXRlfSkKICAgICAgICAgKiBhbmQgdGhlIHR5cGUgb2YgYW4gZWxlbWVudCBpbiA8Y29kZT5GbG9hdDY0QXJyYXk8L2NvZGU+LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlck9mIENvbXBvbmVudERhdGF0eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqIEBkZWZhdWx0IDB4MTQwQQogICAgICAgICAqLwogICAgICAgIERPVUJMRTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5ET1VCTEUKICAgICAgfTsKICAgICAgQ29tcG9uZW50RGF0YXR5cGUuZ2V0U2l6ZUluQnl0ZXMgPSBmdW5jdGlvbihjb21wb25lbnREYXRhdHlwZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNvbXBvbmVudERhdGF0eXBlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBzd2l0Y2ggKGNvbXBvbmVudERhdGF0eXBlKSB7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkJZVEU6CiAgICAgICAgICAgIHJldHVybiBJbnQ4QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0JZVEU6CiAgICAgICAgICAgIHJldHVybiBVaW50OEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5TSE9SVDoKICAgICAgICAgICAgcmV0dXJuIEludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgICByZXR1cm4gVWludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLklOVDoKICAgICAgICAgICAgcmV0dXJuIEludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0lOVDoKICAgICAgICAgICAgcmV0dXJuIFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5GTE9BVDoKICAgICAgICAgICAgcmV0dXJuIEZsb2F0MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuRE9VQkxFOgogICAgICAgICAgICByZXR1cm4gRmxvYXQ2NEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNvbXBvbmVudERhdGF0eXBlIGlzIG5vdCBhIHZhbGlkIHZhbHVlLiIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ29tcG9uZW50RGF0YXR5cGUuZnJvbVR5cGVkQXJyYXkgPSBmdW5jdGlvbihhcnJheSkgewogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIEludDhBcnJheSkgewogICAgICAgICAgcmV0dXJuIENvbXBvbmVudERhdGF0eXBlLkJZVEU7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHsKICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9CWVRFOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBJbnQxNkFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuU0hPUlQ7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIFVpbnQxNkFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfU0hPUlQ7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIEludDMyQXJyYXkpIHsKICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5JTlQ7CiAgICAgICAgfQogICAgICAgIGlmIChhcnJheSBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfSU5UOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXkpIHsKICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5GTE9BVDsKICAgICAgICB9CiAgICAgICAgaWYgKGFycmF5IGluc3RhbmNlb2YgRmxvYXQ2NEFycmF5KSB7CiAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuRE9VQkxFOwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJhcnJheSBtdXN0IGJlIGFuIEludDhBcnJheSwgVWludDhBcnJheSwgSW50MTZBcnJheSwgVWludDE2QXJyYXksIEludDMyQXJyYXksIFVpbnQzMkFycmF5LCBGbG9hdDMyQXJyYXksIG9yIEZsb2F0NjRBcnJheS4iCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgQ29tcG9uZW50RGF0YXR5cGUudmFsaWRhdGUgPSBmdW5jdGlvbihjb21wb25lbnREYXRhdHlwZSkgewogICAgICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQoY29tcG9uZW50RGF0YXR5cGUpICYmIChjb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGUuQllURSB8fCBjb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfQllURSB8fCBjb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGUuU0hPUlQgfHwgY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUIHx8IGNvbXBvbmVudERhdGF0eXBlID09PSBDb21wb25lbnREYXRhdHlwZS5JTlQgfHwgY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0lOVCB8fCBjb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGUuRkxPQVQgfHwgY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlLkRPVUJMRSk7CiAgICAgIH07CiAgICAgIENvbXBvbmVudERhdGF0eXBlLmNyZWF0ZVR5cGVkQXJyYXkgPSBmdW5jdGlvbihjb21wb25lbnREYXRhdHlwZSwgdmFsdWVzT3JMZW5ndGgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb21wb25lbnREYXRhdHlwZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjb21wb25lbnREYXRhdHlwZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWVzT3JMZW5ndGgpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWVzT3JMZW5ndGggaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoY29tcG9uZW50RGF0YXR5cGUpIHsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuQllURToKICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnQ4QXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9CWVRFOgogICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5TSE9SVDoKICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnQxNkFycmF5KHZhbHVlc09yTGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfU0hPUlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgVWludDE2QXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5JTlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgSW50MzJBcnJheSh2YWx1ZXNPckxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX0lOVDoKICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50MzJBcnJheSh2YWx1ZXNPckxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkZMT0FUOgogICAgICAgICAgICByZXR1cm4gbmV3IEZsb2F0MzJBcnJheSh2YWx1ZXNPckxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkRPVUJMRToKICAgICAgICAgICAgcmV0dXJuIG5ldyBGbG9hdDY0QXJyYXkodmFsdWVzT3JMZW5ndGgpOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNvbXBvbmVudERhdGF0eXBlIGlzIG5vdCBhIHZhbGlkIHZhbHVlLiIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQ29tcG9uZW50RGF0YXR5cGUuY3JlYXRlQXJyYXlCdWZmZXJWaWV3ID0gZnVuY3Rpb24oY29tcG9uZW50RGF0YXR5cGUsIGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29tcG9uZW50RGF0YXR5cGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY29tcG9uZW50RGF0YXR5cGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJ1ZmZlcikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJidWZmZXIgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGJ5dGVPZmZzZXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChieXRlT2Zmc2V0LCAwKTsKICAgICAgICBsZW5ndGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIGxlbmd0aCwKICAgICAgICAgIChidWZmZXIuYnl0ZUxlbmd0aCAtIGJ5dGVPZmZzZXQpIC8gQ29tcG9uZW50RGF0YXR5cGUuZ2V0U2l6ZUluQnl0ZXMoY29tcG9uZW50RGF0YXR5cGUpCiAgICAgICAgKTsKICAgICAgICBzd2l0Y2ggKGNvbXBvbmVudERhdGF0eXBlKSB7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLkJZVEU6CiAgICAgICAgICAgIHJldHVybiBuZXcgSW50OEFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfQllURToKICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuU0hPUlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgSW50MTZBcnJheShidWZmZXIsIGJ5dGVPZmZzZXQsIGxlbmd0aCk7CiAgICAgICAgICBjYXNlIENvbXBvbmVudERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOgogICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQxNkFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGUuSU5UOgogICAgICAgICAgICByZXR1cm4gbmV3IEludDMyQXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9JTlQ6CiAgICAgICAgICAgIHJldHVybiBuZXcgVWludDMyQXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5GTE9BVDoKICAgICAgICAgICAgcmV0dXJuIG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyLCBieXRlT2Zmc2V0LCBsZW5ndGgpOwogICAgICAgICAgY2FzZSBDb21wb25lbnREYXRhdHlwZS5ET1VCTEU6CiAgICAgICAgICAgIHJldHVybiBuZXcgRmxvYXQ2NEFycmF5KGJ1ZmZlciwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjb21wb25lbnREYXRhdHlwZSBpcyBub3QgYSB2YWxpZCB2YWx1ZS4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIENvbXBvbmVudERhdGF0eXBlLmZyb21OYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgY2FzZSAiQllURSI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5CWVRFOwogICAgICAgICAgY2FzZSAiVU5TSUdORURfQllURSI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9CWVRFOwogICAgICAgICAgY2FzZSAiU0hPUlQiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuU0hPUlQ7CiAgICAgICAgICBjYXNlICJVTlNJR05FRF9TSE9SVCI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5VTlNJR05FRF9TSE9SVDsKICAgICAgICAgIGNhc2UgIklOVCI6CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZS5JTlQ7CiAgICAgICAgICBjYXNlICJVTlNJR05FRF9JTlQiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuVU5TSUdORURfSU5UOwogICAgICAgICAgY2FzZSAiRkxPQVQiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuRkxPQVQ7CiAgICAgICAgICBjYXNlICJET1VCTEUiOgogICAgICAgICAgICByZXR1cm4gQ29tcG9uZW50RGF0YXR5cGUuRE9VQkxFOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm5hbWUgaXMgbm90IGEgdmFsaWQgdmFsdWUuIik7CiAgICAgICAgfQogICAgICB9OwogICAgICBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShDb21wb25lbnREYXRhdHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeVR5cGUuanMKICB2YXIgR2VvbWV0cnlUeXBlLCBHZW9tZXRyeVR5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9HZW9tZXRyeVR5cGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5VHlwZS5qcyIoKSB7CiAgICAgIEdlb21ldHJ5VHlwZSA9IHsKICAgICAgICBOT05FOiAwLAogICAgICAgIFRSSUFOR0xFUzogMSwKICAgICAgICBMSU5FUzogMiwKICAgICAgICBQT0xZTElORVM6IDMKICAgICAgfTsKICAgICAgR2VvbWV0cnlUeXBlX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKEdlb21ldHJ5VHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9NYXRyaXgyLmpzCiAgZnVuY3Rpb24gTWF0cml4Mihjb2x1bW4wUm93MCwgY29sdW1uMVJvdzAsIGNvbHVtbjBSb3cxLCBjb2x1bW4xUm93MSkgewogICAgdGhpc1swXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjBSb3cwLCAwKTsKICAgIHRoaXNbMV0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChjb2x1bW4wUm93MSwgMCk7CiAgICB0aGlzWzJdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY29sdW1uMVJvdzAsIDApOwogICAgdGhpc1szXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGNvbHVtbjFSb3cxLCAwKTsKICB9CiAgdmFyIHNjYWxlU2NyYXRjaDEzLCBzY2FsZVNjcmF0Y2gyMywgc2NyYXRjaENvbHVtbjMsIHNjYWxlU2NyYXRjaDMzLCBzY2FsZVNjcmF0Y2g0Mywgc2NhbGVTY3JhdGNoNTMsIE1hdHJpeDJfZGVmYXVsdDsKICB2YXIgaW5pdF9NYXRyaXgyID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9NYXRyaXgyLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgTWF0cml4Mi5wYWNrZWRMZW5ndGggPSA0OwogICAgICBNYXRyaXgyLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVswXTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWVbMV07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlWzJdOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZVszXTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIE1hdHJpeDIudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXgyKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0WzFdID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHRbMl0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdFszXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5wYWNrQXJyYXkgPSBmdW5jdGlvbihhcnJheSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgY29uc3QgcmVzdWx0TGVuZ3RoID0gbGVuZ3RoICogNDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkocmVzdWx0TGVuZ3RoKTsKICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdCkgJiYgcmVzdWx0Lmxlbmd0aCAhPT0gcmVzdWx0TGVuZ3RoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIklmIHJlc3VsdCBpcyBhIHR5cGVkIGFycmF5LCBpdCBtdXN0IGhhdmUgZXhhY3RseSBhcnJheS5sZW5ndGggKiA0IGVsZW1lbnRzIgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdC5sZW5ndGggIT09IHJlc3VsdExlbmd0aCkgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IHJlc3VsdExlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgTWF0cml4Mi5wYWNrKGFycmF5W2ldLCByZXN1bHQsIGkgKiA0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi51bnBhY2tBcnJheSA9IGZ1bmN0aW9uKGFycmF5LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJhcnJheS5sZW5ndGgiLCBhcnJheS5sZW5ndGgsIDQpOwogICAgICAgIGlmIChhcnJheS5sZW5ndGggJSA0ICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0LiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCAvIDQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXN1bHQubGVuZ3RoID0gbGVuZ3RoIC8gNDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gNCkgewogICAgICAgICAgY29uc3QgaW5kZXggPSBpIC8gNDsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBNYXRyaXgyLnVucGFjayhhcnJheSwgaSwgcmVzdWx0W2luZGV4XSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuY2xvbmUgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG1hdHJpeCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4MihtYXRyaXhbMF0sIG1hdHJpeFsyXSwgbWF0cml4WzFdLCBtYXRyaXhbM10pOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5mcm9tQXJyYXkgPSBNYXRyaXgyLnVucGFjazsKICAgICAgTWF0cml4Mi5mcm9tQ29sdW1uTWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIHJldHVybiBNYXRyaXgyLmNsb25lKHZhbHVlcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4Mi5mcm9tUm93TWFqb3JBcnJheSA9IGZ1bmN0aW9uKHZhbHVlcywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZXMiLCB2YWx1ZXMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4Mih2YWx1ZXNbMF0sIHZhbHVlc1sxXSwgdmFsdWVzWzJdLCB2YWx1ZXNbM10pOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSB2YWx1ZXNbMF07CiAgICAgICAgcmVzdWx0WzFdID0gdmFsdWVzWzJdOwogICAgICAgIHJlc3VsdFsyXSA9IHZhbHVlc1sxXTsKICAgICAgICByZXN1bHRbM10gPSB2YWx1ZXNbM107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5mcm9tU2NhbGUgPSBmdW5jdGlvbihzY2FsZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1hdHJpeDIoc2NhbGUueCwgMCwgMCwgc2NhbGUueSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzFdID0gMDsKICAgICAgICByZXN1bHRbMl0gPSAwOwogICAgICAgIHJlc3VsdFszXSA9IHNjYWxlLnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5mcm9tVW5pZm9ybVNjYWxlID0gZnVuY3Rpb24oc2NhbGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigic2NhbGUiLCBzY2FsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXgyKHNjYWxlLCAwLCAwLCBzY2FsZSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHNjYWxlOwogICAgICAgIHJlc3VsdFsxXSA9IDA7CiAgICAgICAgcmVzdWx0WzJdID0gMDsKICAgICAgICByZXN1bHRbM10gPSBzY2FsZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLmZyb21Sb3RhdGlvbiA9IGZ1bmN0aW9uKGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoImFuZ2xlIiwgYW5nbGUpOwogICAgICAgIGNvbnN0IGNvc0FuZ2xlID0gTWF0aC5jb3MoYW5nbGUpOwogICAgICAgIGNvbnN0IHNpbkFuZ2xlID0gTWF0aC5zaW4oYW5nbGUpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgTWF0cml4Mihjb3NBbmdsZSwgLXNpbkFuZ2xlLCBzaW5BbmdsZSwgY29zQW5nbGUpOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBjb3NBbmdsZTsKICAgICAgICByZXN1bHRbMV0gPSBzaW5BbmdsZTsKICAgICAgICByZXN1bHRbMl0gPSAtc2luQW5nbGU7CiAgICAgICAgcmVzdWx0WzNdID0gY29zQW5nbGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi50b0FycmF5ID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIFttYXRyaXhbMF0sIG1hdHJpeFsxXSwgbWF0cml4WzJdLCBtYXRyaXhbM11dOwogICAgICAgIH0KICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF07CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5nZXRFbGVtZW50SW5kZXggPSBmdW5jdGlvbihjb2x1bW4sIHJvdykgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJyb3ciLCByb3csIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJyb3ciLCByb3csIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJjb2x1bW4iLCBjb2x1bW4sIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJjb2x1bW4iLCBjb2x1bW4sIDEpOwogICAgICAgIHJldHVybiBjb2x1bW4gKiAyICsgcm93OwogICAgICB9OwogICAgICBNYXRyaXgyLmdldENvbHVtbiA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzdGFydEluZGV4ID0gaW5kZXggKiAyOwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbc3RhcnRJbmRleF07CiAgICAgICAgY29uc3QgeSA9IG1hdHJpeFtzdGFydEluZGV4ICsgMV07CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLnNldENvbHVtbiA9IGZ1bmN0aW9uKG1hdHJpeCwgaW5kZXgsIGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAxKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0ID0gTWF0cml4Mi5jbG9uZShtYXRyaXgsIHJlc3VsdCk7CiAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogMjsKICAgICAgICByZXN1bHRbc3RhcnRJbmRleF0gPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdFtzdGFydEluZGV4ICsgMV0gPSBjYXJ0ZXNpYW4xMS55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuZ2V0Um93ID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRleCIsIGluZGV4LCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHggPSBtYXRyaXhbaW5kZXhdOwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbaW5kZXggKyAyXTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuc2V0Um93ID0gZnVuY3Rpb24obWF0cml4LCBpbmRleCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoImluZGV4IiwgaW5kZXgsIDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQgPSBNYXRyaXgyLmNsb25lKG1hdHJpeCwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbaW5kZXhdID0gY2FydGVzaWFuMTEueDsKICAgICAgICByZXN1bHRbaW5kZXggKyAyXSA9IGNhcnRlc2lhbjExLnk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NhbGVTY3JhdGNoMTMgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIE1hdHJpeDIuc2V0U2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZXhpc3RpbmdTY2FsZSA9IE1hdHJpeDIuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gxMyk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ggPSBzY2FsZS54IC8gZXhpc3RpbmdTY2FsZS54OwogICAgICAgIGNvbnN0IHNjYWxlUmF0aW9ZID0gc2NhbGUueSAvIGV4aXN0aW5nU2NhbGUueTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gKiBzY2FsZVJhdGlvWDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsZVJhdGlvWDsKICAgICAgICByZXN1bHRbMl0gPSBtYXRyaXhbMl0gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gKiBzY2FsZVJhdGlvWTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gyMyA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgTWF0cml4Mi5zZXRVbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgZXhpc3RpbmdTY2FsZSA9IE1hdHJpeDIuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2gyMyk7CiAgICAgICAgY29uc3Qgc2NhbGVSYXRpb1ggPSBzY2FsZSAvIGV4aXN0aW5nU2NhbGUueDsKICAgICAgICBjb25zdCBzY2FsZVJhdGlvWSA9IHNjYWxlIC8gZXhpc3RpbmdTY2FsZS55OwogICAgICAgIHJlc3VsdFswXSA9IG1hdHJpeFswXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAqIHNjYWxlUmF0aW9YOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJlc3VsdFszXSA9IG1hdHJpeFszXSAqIHNjYWxlUmF0aW9ZOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDb2x1bW4zID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBNYXRyaXgyLmdldFNjYWxlID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC54ID0gQ2FydGVzaWFuMl9kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMobWF0cml4WzBdLCBtYXRyaXhbMV0sIHNjcmF0Y2hDb2x1bW4zKQogICAgICAgICk7CiAgICAgICAgcmVzdWx0LnkgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQubWFnbml0dWRlKAogICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21FbGVtZW50cyhtYXRyaXhbMl0sIG1hdHJpeFszXSwgc2NyYXRjaENvbHVtbjMpCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY2FsZVNjcmF0Y2gzMyA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgTWF0cml4Mi5nZXRNYXhpbXVtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgpIHsKICAgICAgICBNYXRyaXgyLmdldFNjYWxlKG1hdHJpeCwgc2NhbGVTY3JhdGNoMzMpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yX2RlZmF1bHQubWF4aW11bUNvbXBvbmVudChzY2FsZVNjcmF0Y2gzMyk7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDQzID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBNYXRyaXgyLnNldFJvdGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCByb3RhdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBzY2FsZSA9IE1hdHJpeDIuZ2V0U2NhbGUobWF0cml4LCBzY2FsZVNjcmF0Y2g0Myk7CiAgICAgICAgcmVzdWx0WzBdID0gcm90YXRpb25bMF0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFsxXSA9IHJvdGF0aW9uWzFdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMl0gPSByb3RhdGlvblsyXSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzNdID0gcm90YXRpb25bM10gKiBzY2FsZS55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjYWxlU2NyYXRjaDUzID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBNYXRyaXgyLmdldFJvdGF0aW9uID0gZnVuY3Rpb24obWF0cml4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHNjYWxlID0gTWF0cml4Mi5nZXRTY2FsZShtYXRyaXgsIHNjYWxlU2NyYXRjaDUzKTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gLyBzY2FsZS54OwogICAgICAgIHJlc3VsdFsxXSA9IG1hdHJpeFsxXSAvIHNjYWxlLng7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdIC8gc2NhbGUueTsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gLyBzY2FsZS55OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIubXVsdGlwbHkgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzAgPSBsZWZ0WzBdICogcmlnaHRbMF0gKyBsZWZ0WzJdICogcmlnaHRbMV07CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzAgPSBsZWZ0WzBdICogcmlnaHRbMl0gKyBsZWZ0WzJdICogcmlnaHRbM107CiAgICAgICAgY29uc3QgY29sdW1uMFJvdzEgPSBsZWZ0WzFdICogcmlnaHRbMF0gKyBsZWZ0WzNdICogcmlnaHRbMV07CiAgICAgICAgY29uc3QgY29sdW1uMVJvdzEgPSBsZWZ0WzFdICogcmlnaHRbMl0gKyBsZWZ0WzNdICogcmlnaHRbM107CiAgICAgICAgcmVzdWx0WzBdID0gY29sdW1uMFJvdzA7CiAgICAgICAgcmVzdWx0WzFdID0gY29sdW1uMFJvdzE7CiAgICAgICAgcmVzdWx0WzJdID0gY29sdW1uMVJvdzA7CiAgICAgICAgcmVzdWx0WzNdID0gY29sdW1uMVJvdzE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5hZGQgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbGVmdFswXSArIHJpZ2h0WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IGxlZnRbMV0gKyByaWdodFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBsZWZ0WzJdICsgcmlnaHRbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbGVmdFszXSArIHJpZ2h0WzNdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuc3VidHJhY3QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbGVmdFswXSAtIHJpZ2h0WzBdOwogICAgICAgIHJlc3VsdFsxXSA9IGxlZnRbMV0gLSByaWdodFsxXTsKICAgICAgICByZXN1bHRbMl0gPSBsZWZ0WzJdIC0gcmlnaHRbMl07CiAgICAgICAgcmVzdWx0WzNdID0gbGVmdFszXSAtIHJpZ2h0WzNdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIubXVsdGlwbHlCeVZlY3RvciA9IGZ1bmN0aW9uKG1hdHJpeCwgY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgY29uc3QgeCA9IG1hdHJpeFswXSAqIGNhcnRlc2lhbjExLnggKyBtYXRyaXhbMl0gKiBjYXJ0ZXNpYW4xMS55OwogICAgICAgIGNvbnN0IHkgPSBtYXRyaXhbMV0gKiBjYXJ0ZXNpYW4xMS54ICsgbWF0cml4WzNdICogY2FydGVzaWFuMTEueTsKICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIubXVsdGlwbHlCeVNjYWxhciA9IGZ1bmN0aW9uKG1hdHJpeCwgc2NhbGFyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBtYXRyaXhbMF0gKiBzY2FsYXI7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGFyOwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxhcjsKICAgICAgICByZXN1bHRbM10gPSBtYXRyaXhbM10gKiBzY2FsYXI7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5tdWx0aXBseUJ5U2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGUueDsKICAgICAgICByZXN1bHRbMV0gPSBtYXRyaXhbMV0gKiBzY2FsZS54OwogICAgICAgIHJlc3VsdFsyXSA9IG1hdHJpeFsyXSAqIHNjYWxlLnk7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGUueTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLm11bHRpcGx5QnlVbmlmb3JtU2NhbGUgPSBmdW5jdGlvbihtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1hdHJpeCIsIG1hdHJpeCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsZSIsIHNjYWxlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gbWF0cml4WzBdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzFdID0gbWF0cml4WzFdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzJdID0gbWF0cml4WzJdICogc2NhbGU7CiAgICAgICAgcmVzdWx0WzNdID0gbWF0cml4WzNdICogc2NhbGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgTWF0cml4Mi5uZWdhdGUgPSBmdW5jdGlvbihtYXRyaXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWF0cml4IiwgbWF0cml4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0WzBdID0gLW1hdHJpeFswXTsKICAgICAgICByZXN1bHRbMV0gPSAtbWF0cml4WzFdOwogICAgICAgIHJlc3VsdFsyXSA9IC1tYXRyaXhbMl07CiAgICAgICAgcmVzdWx0WzNdID0gLW1hdHJpeFszXTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLnRyYW5zcG9zZSA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MCA9IG1hdHJpeFswXTsKICAgICAgICBjb25zdCBjb2x1bW4wUm93MSA9IG1hdHJpeFsyXTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MCA9IG1hdHJpeFsxXTsKICAgICAgICBjb25zdCBjb2x1bW4xUm93MSA9IG1hdHJpeFszXTsKICAgICAgICByZXN1bHRbMF0gPSBjb2x1bW4wUm93MDsKICAgICAgICByZXN1bHRbMV0gPSBjb2x1bW4wUm93MTsKICAgICAgICByZXN1bHRbMl0gPSBjb2x1bW4xUm93MDsKICAgICAgICByZXN1bHRbM10gPSBjb2x1bW4xUm93MTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBNYXRyaXgyLmFicyA9IGZ1bmN0aW9uKG1hdHJpeCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJtYXRyaXgiLCBtYXRyaXgpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHRbMF0gPSBNYXRoLmFicyhtYXRyaXhbMF0pOwogICAgICAgIHJlc3VsdFsxXSA9IE1hdGguYWJzKG1hdHJpeFsxXSk7CiAgICAgICAgcmVzdWx0WzJdID0gTWF0aC5hYnMobWF0cml4WzJdKTsKICAgICAgICByZXN1bHRbM10gPSBNYXRoLmFicyhtYXRyaXhbM10pOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE1hdHJpeDIuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgbGVmdFswXSA9PT0gcmlnaHRbMF0gJiYgbGVmdFsxXSA9PT0gcmlnaHRbMV0gJiYgbGVmdFsyXSA9PT0gcmlnaHRbMl0gJiYgbGVmdFszXSA9PT0gcmlnaHRbM107CiAgICAgIH07CiAgICAgIE1hdHJpeDIuZXF1YWxzQXJyYXkgPSBmdW5jdGlvbihtYXRyaXgsIGFycmF5LCBvZmZzZXQpIHsKICAgICAgICByZXR1cm4gbWF0cml4WzBdID09PSBhcnJheVtvZmZzZXRdICYmIG1hdHJpeFsxXSA9PT0gYXJyYXlbb2Zmc2V0ICsgMV0gJiYgbWF0cml4WzJdID09PSBhcnJheVtvZmZzZXQgKyAyXSAmJiBtYXRyaXhbM10gPT09IGFycmF5W29mZnNldCArIDNdOwogICAgICB9OwogICAgICBNYXRyaXgyLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgZXBzaWxvbikgewogICAgICAgIGVwc2lsb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlcHNpbG9uLCAwKTsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZF9kZWZhdWx0KGxlZnQpICYmIGRlZmluZWRfZGVmYXVsdChyaWdodCkgJiYgTWF0aC5hYnMobGVmdFswXSAtIHJpZ2h0WzBdKSA8PSBlcHNpbG9uICYmIE1hdGguYWJzKGxlZnRbMV0gLSByaWdodFsxXSkgPD0gZXBzaWxvbiAmJiBNYXRoLmFicyhsZWZ0WzJdIC0gcmlnaHRbMl0pIDw9IGVwc2lsb24gJiYgTWF0aC5hYnMobGVmdFszXSAtIHJpZ2h0WzNdKSA8PSBlcHNpbG9uOwogICAgICB9OwogICAgICBNYXRyaXgyLklERU5USVRZID0gT2JqZWN0LmZyZWV6ZShuZXcgTWF0cml4MigxLCAwLCAwLCAxKSk7CiAgICAgIE1hdHJpeDIuWkVSTyA9IE9iamVjdC5mcmVlemUobmV3IE1hdHJpeDIoMCwgMCwgMCwgMCkpOwogICAgICBNYXRyaXgyLkNPTFVNTjBST1cwID0gMDsKICAgICAgTWF0cml4Mi5DT0xVTU4wUk9XMSA9IDE7CiAgICAgIE1hdHJpeDIuQ09MVU1OMVJPVzAgPSAyOwogICAgICBNYXRyaXgyLkNPTFVNTjFST1cxID0gMzsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoTWF0cml4Mi5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBudW1iZXIgb2YgaXRlbXMgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgICogQG1lbWJlcm9mIE1hdHJpeDIucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGxlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdHJpeDIucGFja2VkTGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIE1hdHJpeDIucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE1hdHJpeDIuY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgTWF0cml4Mi5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gTWF0cml4Mi5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBNYXRyaXgyLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ocmlnaHQsIGVwc2lsb24pIHsKICAgICAgICByZXR1cm4gTWF0cml4Mi5lcXVhbHNFcHNpbG9uKHRoaXMsIHJpZ2h0LCBlcHNpbG9uKTsKICAgICAgfTsKICAgICAgTWF0cml4Mi5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYCgke3RoaXNbMF19LCAke3RoaXNbMl19KQooJHt0aGlzWzFdfSwgJHt0aGlzWzNdfSlgOwogICAgICB9OwogICAgICBNYXRyaXgyX2RlZmF1bHQgPSBNYXRyaXgyOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUHJpbWl0aXZlVHlwZS5qcwogIHZhciBQcmltaXRpdmVUeXBlLCBQcmltaXRpdmVUeXBlX2RlZmF1bHQ7CiAgdmFyIGluaXRfUHJpbWl0aXZlVHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUHJpbWl0aXZlVHlwZS5qcyIoKSB7CiAgICAgIGluaXRfV2ViR0xDb25zdGFudHMoKTsKICAgICAgUHJpbWl0aXZlVHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBQb2ludHMgcHJpbWl0aXZlIHdoZXJlIGVhY2ggdmVydGV4IChvciBpbmRleCkgaXMgYSBzZXBhcmF0ZSBwb2ludC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUE9JTlRTOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlBPSU5UUywKICAgICAgICAvKioKICAgICAgICAgKiBMaW5lcyBwcmltaXRpdmUgd2hlcmUgZWFjaCB0d28gdmVydGljZXMgKG9yIGluZGljZXMpIGlzIGEgbGluZSBzZWdtZW50LiAgTGluZSBzZWdtZW50cyBhcmUgbm90IG5lY2Vzc2FyaWx5IGNvbm5lY3RlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTElORVM6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuTElORVMsCiAgICAgICAgLyoqCiAgICAgICAgICogTGluZSBsb29wIHByaW1pdGl2ZSB3aGVyZSBlYWNoIHZlcnRleCAob3IgaW5kZXgpIGFmdGVyIHRoZSBmaXJzdCBjb25uZWN0cyBhIGxpbmUgdG8KICAgICAgICAgKiB0aGUgcHJldmlvdXMgdmVydGV4LCBhbmQgdGhlIGxhc3QgdmVydGV4IGltcGxpY2l0bHkgY29ubmVjdHMgdG8gdGhlIGZpcnN0LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBMSU5FX0xPT1A6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuTElORV9MT09QLAogICAgICAgIC8qKgogICAgICAgICAqIExpbmUgc3RyaXAgcHJpbWl0aXZlIHdoZXJlIGVhY2ggdmVydGV4IChvciBpbmRleCkgYWZ0ZXIgdGhlIGZpcnN0IGNvbm5lY3RzIGEgbGluZSB0byB0aGUgcHJldmlvdXMgdmVydGV4LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBMSU5FX1NUUklQOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkxJTkVfU1RSSVAsCiAgICAgICAgLyoqCiAgICAgICAgICogVHJpYW5nbGVzIHByaW1pdGl2ZSB3aGVyZSBlYWNoIHRocmVlIHZlcnRpY2VzIChvciBpbmRpY2VzKSBpcyBhIHRyaWFuZ2xlLiAgVHJpYW5nbGVzIGRvIG5vdCBuZWNlc3NhcmlseSBzaGFyZSBlZGdlcy4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVFJJQU5HTEVTOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAvKioKICAgICAgICAgKiBUcmlhbmdsZSBzdHJpcCBwcmltaXRpdmUgd2hlcmUgZWFjaCB2ZXJ0ZXggKG9yIGluZGV4KSBhZnRlciB0aGUgZmlyc3QgdHdvIGNvbm5lY3QgdG8KICAgICAgICAgKiB0aGUgcHJldmlvdXMgdHdvIHZlcnRpY2VzIGZvcm1pbmcgYSB0cmlhbmdsZS4gIEZvciBleGFtcGxlLCB0aGlzIGNhbiBiZSB1c2VkIHRvIG1vZGVsIGEgd2FsbC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVFJJQU5HTEVfU1RSSVA6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVFJJQU5HTEVfU1RSSVAsCiAgICAgICAgLyoqCiAgICAgICAgICogVHJpYW5nbGUgZmFuIHByaW1pdGl2ZSB3aGVyZSBlYWNoIHZlcnRleCAob3IgaW5kZXgpIGFmdGVyIHRoZSBmaXJzdCB0d28gY29ubmVjdCB0bwogICAgICAgICAqIHRoZSBwcmV2aW91cyB2ZXJ0ZXggYW5kIHRoZSBmaXJzdCB2ZXJ0ZXggZm9ybWluZyBhIHRyaWFuZ2xlLiAgRm9yIGV4YW1wbGUsIHRoaXMgY2FuIGJlIHVzZWQKICAgICAgICAgKiB0byBtb2RlbCBhIGNvbmUgb3IgY2lyY2xlLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBUUklBTkdMRV9GQU46IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVFJJQU5HTEVfRkFOCiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVR5cGUuaXNMaW5lcyA9IGZ1bmN0aW9uKHByaW1pdGl2ZVR5cGUpIHsKICAgICAgICByZXR1cm4gcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5MSU5FUyB8fCBwcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlLkxJTkVfTE9PUCB8fCBwcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlLkxJTkVfU1RSSVA7CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVR5cGUuaXNUcmlhbmdsZXMgPSBmdW5jdGlvbihwcmltaXRpdmVUeXBlKSB7CiAgICAgICAgcmV0dXJuIHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVTIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVfU1RSSVAgfHwgcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5UUklBTkdMRV9GQU47CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVR5cGUudmFsaWRhdGUgPSBmdW5jdGlvbihwcmltaXRpdmVUeXBlKSB7CiAgICAgICAgcmV0dXJuIHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuUE9JTlRTIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuTElORVMgfHwgcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5MSU5FX0xPT1AgfHwgcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5MSU5FX1NUUklQIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVTIHx8IHByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVfU1RSSVAgfHwgcHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZS5UUklBTkdMRV9GQU47CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVR5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoUHJpbWl0aXZlVHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeS5qcwogIGZ1bmN0aW9uIEdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zLmF0dHJpYnV0ZXMiLCBvcHRpb25zLmF0dHJpYnV0ZXMpOwogICAgdGhpcy5hdHRyaWJ1dGVzID0gb3B0aW9ucy5hdHRyaWJ1dGVzOwogICAgdGhpcy5pbmRpY2VzID0gb3B0aW9ucy5pbmRpY2VzOwogICAgdGhpcy5wcmltaXRpdmVUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMucHJpbWl0aXZlVHlwZSwKICAgICAgUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgKTsKICAgIHRoaXMuYm91bmRpbmdTcGhlcmUgPSBvcHRpb25zLmJvdW5kaW5nU3BoZXJlOwogICAgdGhpcy5nZW9tZXRyeVR5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmdlb21ldHJ5VHlwZSwgR2VvbWV0cnlUeXBlX2RlZmF1bHQuTk9ORSk7CiAgICB0aGlzLmJvdW5kaW5nU3BoZXJlQ1YgPSBvcHRpb25zLmJvdW5kaW5nU3BoZXJlQ1Y7CiAgICB0aGlzLm9mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogIH0KICB2YXIgcmVjdGFuZ2xlQ2VudGVyU2NyYXRjaCwgZW51Q2VudGVyU2NyYXRjaCwgZml4ZWRGcmFtZVRvRW51U2NyYXRjaCwgYm91bmRpbmdSZWN0YW5nbGVQb2ludHNDYXJ0b2dyYXBoaWNTY3JhdGNoLCBib3VuZGluZ1JlY3RhbmdsZVBvaW50c0VudVNjcmF0Y2gsIHBvaW50czJEU2NyYXRjaCwgcG9pbnRFbnVTY3JhdGNoLCBlbnVSb3RhdGlvblNjcmF0Y2gsIGVudVJvdGF0aW9uTWF0cml4U2NyYXRjaCwgcm90YXRpb24yRFNjcmF0Y2gsIEdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfR2VvbWV0cnlUeXBlKCk7CiAgICAgIGluaXRfTWF0cml4MigpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9UcmFuc2Zvcm1zKCk7CiAgICAgIEdlb21ldHJ5LmNvbXB1dGVOdW1iZXJPZlZlcnRpY2VzID0gZnVuY3Rpb24oZ2VvbWV0cnkpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImdlb21ldHJ5IiwgZ2VvbWV0cnkpOwogICAgICAgIGxldCBudW1iZXJPZlZlcnRpY2VzID0gLTE7CiAgICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBnZW9tZXRyeS5hdHRyaWJ1dGVzKSB7CiAgICAgICAgICBpZiAoZ2VvbWV0cnkuYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkgJiYgZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXNbcHJvcGVydHldKSAmJiBkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYXR0cmlidXRlc1twcm9wZXJ0eV0udmFsdWVzKSkgewogICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzW3Byb3BlcnR5XTsKICAgICAgICAgICAgY29uc3QgbnVtID0gYXR0cmlidXRlLnZhbHVlcy5sZW5ndGggLyBhdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZTsKICAgICAgICAgICAgaWYgKG51bWJlck9mVmVydGljZXMgIT09IG51bSAmJiBudW1iZXJPZlZlcnRpY2VzICE9PSAtMSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAgICAgIkFsbCBhdHRyaWJ1dGUgbGlzdHMgbXVzdCBoYXZlIHRoZSBzYW1lIG51bWJlciBvZiBhdHRyaWJ1dGVzLiIKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG51bWJlck9mVmVydGljZXMgPSBudW07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBudW1iZXJPZlZlcnRpY2VzOwogICAgICB9OwogICAgICByZWN0YW5nbGVDZW50ZXJTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIGVudUNlbnRlclNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZpeGVkRnJhbWVUb0VudVNjcmF0Y2ggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlUG9pbnRzQ2FydG9ncmFwaGljU2NyYXRjaCA9IFsKICAgICAgICBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKQogICAgICBdOwogICAgICBib3VuZGluZ1JlY3RhbmdsZVBvaW50c0VudVNjcmF0Y2ggPSBbCiAgICAgICAgbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpLAogICAgICAgIG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCkKICAgICAgXTsKICAgICAgcG9pbnRzMkRTY3JhdGNoID0gW25ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKSwgbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpLCBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCldOwogICAgICBwb2ludEVudVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGVudVJvdGF0aW9uU2NyYXRjaCA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgZW51Um90YXRpb25NYXRyaXhTY3JhdGNoID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICByb3RhdGlvbjJEU2NyYXRjaCA9IG5ldyBNYXRyaXgyX2RlZmF1bHQoKTsKICAgICAgR2VvbWV0cnkuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMgPSBmdW5jdGlvbihwb3NpdGlvbnMsIHN0Um90YXRpb24sIGVsbGlwc29pZCwgYm91bmRpbmdSZWN0YW5nbGUpIHsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCByZWN0YW5nbGVDZW50ZXIgPSBSZWN0YW5nbGVfZGVmYXVsdC5jZW50ZXIoCiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZSwKICAgICAgICAgIHJlY3RhbmdsZUNlbnRlclNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGVudUNlbnRlciA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LnRvQ2FydGVzaWFuKAogICAgICAgICAgcmVjdGFuZ2xlQ2VudGVyLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgZW51Q2VudGVyU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgZW51VG9GaXhlZEZyYW1lID0gVHJhbnNmb3Jtc19kZWZhdWx0LmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lKAogICAgICAgICAgZW51Q2VudGVyLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgZml4ZWRGcmFtZVRvRW51U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgZml4ZWRGcmFtZVRvRW51ID0gTWF0cml4NF9kZWZhdWx0LmludmVyc2UoCiAgICAgICAgICBlbnVUb0ZpeGVkRnJhbWUsCiAgICAgICAgICBmaXhlZEZyYW1lVG9FbnVTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBib3VuZGluZ1BvaW50c0VudSA9IGJvdW5kaW5nUmVjdGFuZ2xlUG9pbnRzRW51U2NyYXRjaDsKICAgICAgICBjb25zdCBib3VuZGluZ1BvaW50c0NhcnRvID0gYm91bmRpbmdSZWN0YW5nbGVQb2ludHNDYXJ0b2dyYXBoaWNTY3JhdGNoOwogICAgICAgIGJvdW5kaW5nUG9pbnRzQ2FydG9bMF0ubG9uZ2l0dWRlID0gYm91bmRpbmdSZWN0YW5nbGUud2VzdDsKICAgICAgICBib3VuZGluZ1BvaW50c0NhcnRvWzBdLmxhdGl0dWRlID0gYm91bmRpbmdSZWN0YW5nbGUuc291dGg7CiAgICAgICAgYm91bmRpbmdQb2ludHNDYXJ0b1sxXS5sb25naXR1ZGUgPSBib3VuZGluZ1JlY3RhbmdsZS53ZXN0OwogICAgICAgIGJvdW5kaW5nUG9pbnRzQ2FydG9bMV0ubGF0aXR1ZGUgPSBib3VuZGluZ1JlY3RhbmdsZS5ub3J0aDsKICAgICAgICBib3VuZGluZ1BvaW50c0NhcnRvWzJdLmxvbmdpdHVkZSA9IGJvdW5kaW5nUmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgYm91bmRpbmdQb2ludHNDYXJ0b1syXS5sYXRpdHVkZSA9IGJvdW5kaW5nUmVjdGFuZ2xlLnNvdXRoOwogICAgICAgIGxldCBwb3NFbnUgPSBwb2ludEVudVNjcmF0Y2g7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IDM7IGkrKykgewogICAgICAgICAgQ2FydG9ncmFwaGljX2RlZmF1bHQudG9DYXJ0ZXNpYW4oYm91bmRpbmdQb2ludHNDYXJ0b1tpXSwgZWxsaXBzb2lkLCBwb3NFbnUpOwogICAgICAgICAgcG9zRW51ID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludEFzVmVjdG9yKGZpeGVkRnJhbWVUb0VudSwgcG9zRW51LCBwb3NFbnUpOwogICAgICAgICAgYm91bmRpbmdQb2ludHNFbnVbaV0ueCA9IHBvc0VudS54OwogICAgICAgICAgYm91bmRpbmdQb2ludHNFbnVbaV0ueSA9IHBvc0VudS55OwogICAgICAgIH0KICAgICAgICBjb25zdCByb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwKICAgICAgICAgIC1zdFJvdGF0aW9uLAogICAgICAgICAgZW51Um90YXRpb25TY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0ZXh0dXJlTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICBlbnVSb3RhdGlvbk1hdHJpeFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgbGV0IGVudU1pblggPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbGV0IGVudU1pblkgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbGV0IGVudU1heFggPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbGV0IGVudU1heFkgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aDsgaSsrKSB7CiAgICAgICAgICBwb3NFbnUgPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50QXNWZWN0b3IoCiAgICAgICAgICAgIGZpeGVkRnJhbWVUb0VudSwKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBwb3NFbnUKICAgICAgICAgICk7CiAgICAgICAgICBwb3NFbnUgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0ZXh0dXJlTWF0cml4LCBwb3NFbnUsIHBvc0VudSk7CiAgICAgICAgICBlbnVNaW5YID0gTWF0aC5taW4oZW51TWluWCwgcG9zRW51LngpOwogICAgICAgICAgZW51TWluWSA9IE1hdGgubWluKGVudU1pblksIHBvc0VudS55KTsKICAgICAgICAgIGVudU1heFggPSBNYXRoLm1heChlbnVNYXhYLCBwb3NFbnUueCk7CiAgICAgICAgICBlbnVNYXhZID0gTWF0aC5tYXgoZW51TWF4WSwgcG9zRW51LnkpOwogICAgICAgIH0KICAgICAgICBjb25zdCB0b0Rlc2lyZWRJbkNvbXB1dGVkID0gTWF0cml4Ml9kZWZhdWx0LmZyb21Sb3RhdGlvbigKICAgICAgICAgIHN0Um90YXRpb24sCiAgICAgICAgICByb3RhdGlvbjJEU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgcG9pbnRzMkQgPSBwb2ludHMyRFNjcmF0Y2g7CiAgICAgICAgcG9pbnRzMkRbMF0ueCA9IGVudU1pblg7CiAgICAgICAgcG9pbnRzMkRbMF0ueSA9IGVudU1pblk7CiAgICAgICAgcG9pbnRzMkRbMV0ueCA9IGVudU1pblg7CiAgICAgICAgcG9pbnRzMkRbMV0ueSA9IGVudU1heFk7CiAgICAgICAgcG9pbnRzMkRbMl0ueCA9IGVudU1heFg7CiAgICAgICAgcG9pbnRzMkRbMl0ueSA9IGVudU1pblk7CiAgICAgICAgY29uc3QgYm91bmRpbmdFbnVNaW4gPSBib3VuZGluZ1BvaW50c0VudVswXTsKICAgICAgICBjb25zdCBib3VuZGluZ1BvaW50c1dpZHRoID0gYm91bmRpbmdQb2ludHNFbnVbMl0ueCAtIGJvdW5kaW5nRW51TWluLng7CiAgICAgICAgY29uc3QgYm91bmRpbmdQb2ludHNIZWlnaHQgPSBib3VuZGluZ1BvaW50c0VudVsxXS55IC0gYm91bmRpbmdFbnVNaW4ueTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMzsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwb2ludDJEID0gcG9pbnRzMkRbaV07CiAgICAgICAgICBNYXRyaXgyX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0b0Rlc2lyZWRJbkNvbXB1dGVkLCBwb2ludDJELCBwb2ludDJEKTsKICAgICAgICAgIHBvaW50MkQueCA9IChwb2ludDJELnggLSBib3VuZGluZ0VudU1pbi54KSAvIGJvdW5kaW5nUG9pbnRzV2lkdGg7CiAgICAgICAgICBwb2ludDJELnkgPSAocG9pbnQyRC55IC0gYm91bmRpbmdFbnVNaW4ueSkgLyBib3VuZGluZ1BvaW50c0hlaWdodDsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWluWFlDb3JuZXIgPSBwb2ludHMyRFswXTsKICAgICAgICBjb25zdCBtYXhZQ29ybmVyID0gcG9pbnRzMkRbMV07CiAgICAgICAgY29uc3QgbWF4WENvcm5lciA9IHBvaW50czJEWzJdOwogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheSg2KTsKICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFjayhtaW5YWUNvcm5lciwgcmVzdWx0KTsKICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFjayhtYXhZQ29ybmVyLCByZXN1bHQsIDIpOwogICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrKG1heFhDb3JuZXIsIHJlc3VsdCwgNCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgR2VvbWV0cnlfZGVmYXVsdCA9IEdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlBdHRyaWJ1dGUuanMKICBmdW5jdGlvbiBHZW9tZXRyeUF0dHJpYnV0ZShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuY29tcG9uZW50RGF0YXR5cGUpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLmNvbXBvbmVudERhdGF0eXBlIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5jb21wb25lbnRzUGVyQXR0cmlidXRlKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5jb21wb25lbnRzUGVyQXR0cmlidXRlIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKG9wdGlvbnMuY29tcG9uZW50c1BlckF0dHJpYnV0ZSA8IDEgfHwgb3B0aW9ucy5jb21wb25lbnRzUGVyQXR0cmlidXRlID4gNCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5jb21wb25lbnRzUGVyQXR0cmlidXRlIG11c3QgYmUgYmV0d2VlbiAxIGFuZCA0LiIKICAgICAgKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMudmFsdWVzKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy52YWx1ZXMgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICB0aGlzLmNvbXBvbmVudERhdGF0eXBlID0gb3B0aW9ucy5jb21wb25lbnREYXRhdHlwZTsKICAgIHRoaXMuY29tcG9uZW50c1BlckF0dHJpYnV0ZSA9IG9wdGlvbnMuY29tcG9uZW50c1BlckF0dHJpYnV0ZTsKICAgIHRoaXMubm9ybWFsaXplID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5ub3JtYWxpemUsIGZhbHNlKTsKICAgIHRoaXMudmFsdWVzID0gb3B0aW9ucy52YWx1ZXM7CiAgfQogIHZhciBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0OwogIHZhciBpbml0X0dlb21ldHJ5QXR0cmlidXRlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeUF0dHJpYnV0ZS5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQgPSBHZW9tZXRyeUF0dHJpYnV0ZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5QXR0cmlidXRlcy5qcwogIGZ1bmN0aW9uIEdlb21ldHJ5QXR0cmlidXRlcyhvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMucG9zaXRpb24gPSBvcHRpb25zLnBvc2l0aW9uOwogICAgdGhpcy5ub3JtYWwgPSBvcHRpb25zLm5vcm1hbDsKICAgIHRoaXMuc3QgPSBvcHRpb25zLnN0OwogICAgdGhpcy5iaXRhbmdlbnQgPSBvcHRpb25zLmJpdGFuZ2VudDsKICAgIHRoaXMudGFuZ2VudCA9IG9wdGlvbnMudGFuZ2VudDsKICAgIHRoaXMuY29sb3IgPSBvcHRpb25zLmNvbG9yOwogIH0KICB2YXIgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQ7CiAgdmFyIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9tZXRyeUF0dHJpYnV0ZXMuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCA9IEdlb21ldHJ5QXR0cmlidXRlczsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9TY2VuZS9BdHRyaWJ1dGVUeXBlLmpzCiAgdmFyIEF0dHJpYnV0ZVR5cGUsIEF0dHJpYnV0ZVR5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9BdHRyaWJ1dGVUeXBlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvU2NlbmUvQXR0cmlidXRlVHlwZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdHJpeDIoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBBdHRyaWJ1dGVUeXBlID0gewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBhdHRyaWJ1dGUgaXMgYSBzaW5nbGUgY29tcG9uZW50LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBTQ0FMQVI6ICJTQ0FMQVIiLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBhdHRyaWJ1dGUgaXMgYSB0d28tY29tcG9uZW50IHZlY3Rvci4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVkVDMjogIlZFQzIiLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBhdHRyaWJ1dGUgaXMgYSB0aHJlZS1jb21wb25lbnQgdmVjdG9yLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBWRUMzOiAiVkVDMyIsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGF0dHJpYnV0ZSBpcyBhIGZvdXItY29tcG9uZW50IHZlY3Rvci4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVkVDNDogIlZFQzQiLAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBhdHRyaWJ1dGUgaXMgYSAyeDIgbWF0cml4LgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge3N0cmluZ30KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBNQVQyOiAiTUFUMiIsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGF0dHJpYnV0ZSBpcyBhIDN4MyBtYXRyaXguCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7c3RyaW5nfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE1BVDM6ICJNQVQzIiwKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgYXR0cmlidXRlIGlzIGEgNHg0IG1hdHJpeC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtzdHJpbmd9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTUFUNDogIk1BVDQiCiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZVR5cGUuZ2V0TWF0aFR5cGUgPSBmdW5jdGlvbihhdHRyaWJ1dGVUeXBlKSB7CiAgICAgICAgc3dpdGNoIChhdHRyaWJ1dGVUeXBlKSB7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuU0NBTEFSOgogICAgICAgICAgICByZXR1cm4gTnVtYmVyOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzI6CiAgICAgICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yX2RlZmF1bHQ7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDMzoKICAgICAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdDsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUM0OgogICAgICAgICAgICByZXR1cm4gQ2FydGVzaWFuNF9kZWZhdWx0OwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLk1BVDI6CiAgICAgICAgICAgIHJldHVybiBNYXRyaXgyX2RlZmF1bHQ7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuTUFUMzoKICAgICAgICAgICAgcmV0dXJuIE1hdHJpeDNfZGVmYXVsdDsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQ0OgogICAgICAgICAgICByZXR1cm4gTWF0cml4NF9kZWZhdWx0OwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImF0dHJpYnV0ZVR5cGUgaXMgbm90IGEgdmFsaWQgdmFsdWUuIik7CiAgICAgICAgfQogICAgICB9OwogICAgICBBdHRyaWJ1dGVUeXBlLmdldE51bWJlck9mQ29tcG9uZW50cyA9IGZ1bmN0aW9uKGF0dHJpYnV0ZVR5cGUpIHsKICAgICAgICBzd2l0Y2ggKGF0dHJpYnV0ZVR5cGUpIHsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5TQ0FMQVI6CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzI6CiAgICAgICAgICAgIHJldHVybiAyOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzM6CiAgICAgICAgICAgIHJldHVybiAzOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzQ6CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuTUFUMjoKICAgICAgICAgICAgcmV0dXJuIDQ7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuTUFUMzoKICAgICAgICAgICAgcmV0dXJuIDk7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuTUFUNDoKICAgICAgICAgICAgcmV0dXJuIDE2OwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImF0dHJpYnV0ZVR5cGUgaXMgbm90IGEgdmFsaWQgdmFsdWUuIik7CiAgICAgICAgfQogICAgICB9OwogICAgICBBdHRyaWJ1dGVUeXBlLmdldEF0dHJpYnV0ZUxvY2F0aW9uQ291bnQgPSBmdW5jdGlvbihhdHRyaWJ1dGVUeXBlKSB7CiAgICAgICAgc3dpdGNoIChhdHRyaWJ1dGVUeXBlKSB7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuU0NBTEFSOgogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzI6CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDMzoKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUM0OgogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQyOgogICAgICAgICAgICByZXR1cm4gMjsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQzOgogICAgICAgICAgICByZXR1cm4gMzsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQ0OgogICAgICAgICAgICByZXR1cm4gNDsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVUeXBlIGlzIG5vdCBhIHZhbGlkIHZhbHVlLiIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgQXR0cmlidXRlVHlwZS5nZXRHbHNsVHlwZSA9IGZ1bmN0aW9uKGF0dHJpYnV0ZVR5cGUpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5zdHJpbmcoImF0dHJpYnV0ZVR5cGUiLCBhdHRyaWJ1dGVUeXBlKTsKICAgICAgICBzd2l0Y2ggKGF0dHJpYnV0ZVR5cGUpIHsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5TQ0FMQVI6CiAgICAgICAgICAgIHJldHVybiAiZmxvYXQiOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLlZFQzI6CiAgICAgICAgICAgIHJldHVybiAidmVjMiI7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuVkVDMzoKICAgICAgICAgICAgcmV0dXJuICJ2ZWMzIjsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5WRUM0OgogICAgICAgICAgICByZXR1cm4gInZlYzQiOwogICAgICAgICAgY2FzZSBBdHRyaWJ1dGVUeXBlLk1BVDI6CiAgICAgICAgICAgIHJldHVybiAibWF0MiI7CiAgICAgICAgICBjYXNlIEF0dHJpYnV0ZVR5cGUuTUFUMzoKICAgICAgICAgICAgcmV0dXJuICJtYXQzIjsKICAgICAgICAgIGNhc2UgQXR0cmlidXRlVHlwZS5NQVQ0OgogICAgICAgICAgICByZXR1cm4gIm1hdDQiOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImF0dHJpYnV0ZVR5cGUgaXMgbm90IGEgdmFsaWQgdmFsdWUuIik7CiAgICAgICAgfQogICAgICB9OwogICAgICBBdHRyaWJ1dGVUeXBlX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKEF0dHJpYnV0ZVR5cGUpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQXR0cmlidXRlQ29tcHJlc3Npb24uanMKICBmdW5jdGlvbiBmb3JjZVVpbnQ4KHZhbHVlKSB7CiAgICB1aW50OEZvcmNlQXJyYXlbMF0gPSB2YWx1ZTsKICAgIHJldHVybiB1aW50OEZvcmNlQXJyYXlbMF07CiAgfQogIGZ1bmN0aW9uIHppZ1phZ0RlY29kZSh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID4+IDEgXiAtKHZhbHVlICYgMSk7CiAgfQogIHZhciBSSUdIVF9TSElGVCwgTEVGVF9TSElGVCwgQXR0cmlidXRlQ29tcHJlc3Npb24sIG9jdEVuY29kZVNjcmF0Y2gsIHVpbnQ4Rm9yY2VBcnJheSwgc2NyYXRjaEVuY29kZUNhcnQyLCBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0OwogIHZhciBpbml0X0F0dHJpYnV0ZUNvbXByZXNzaW9uID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9BdHRyaWJ1dGVDb21wcmVzc2lvbi5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X0F0dHJpYnV0ZVR5cGUoKTsKICAgICAgUklHSFRfU0hJRlQgPSAxIC8gMjU2OwogICAgICBMRUZUX1NISUZUID0gMjU2OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbiA9IHt9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RFbmNvZGVJblJhbmdlID0gZnVuY3Rpb24odmVjdG9yLCByYW5nZU1heCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2ZWN0b3IiLCB2ZWN0b3IpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCBtYWdTcXVhcmVkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQodmVjdG9yKTsKICAgICAgICBpZiAoTWF0aC5hYnMobWFnU3F1YXJlZCAtIDEpID4gTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmVjdG9yIG11c3QgYmUgbm9ybWFsaXplZC4iKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSB2ZWN0b3IueCAvIChNYXRoLmFicyh2ZWN0b3IueCkgKyBNYXRoLmFicyh2ZWN0b3IueSkgKyBNYXRoLmFicyh2ZWN0b3IueikpOwogICAgICAgIHJlc3VsdC55ID0gdmVjdG9yLnkgLyAoTWF0aC5hYnModmVjdG9yLngpICsgTWF0aC5hYnModmVjdG9yLnkpICsgTWF0aC5hYnModmVjdG9yLnopKTsKICAgICAgICBpZiAodmVjdG9yLnogPCAwKSB7CiAgICAgICAgICBjb25zdCB4ID0gcmVzdWx0Lng7CiAgICAgICAgICBjb25zdCB5ID0gcmVzdWx0Lnk7CiAgICAgICAgICByZXN1bHQueCA9ICgxIC0gTWF0aC5hYnMoeSkpICogTWF0aF9kZWZhdWx0LnNpZ25Ob3RaZXJvKHgpOwogICAgICAgICAgcmVzdWx0LnkgPSAoMSAtIE1hdGguYWJzKHgpKSAqIE1hdGhfZGVmYXVsdC5zaWduTm90WmVybyh5KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBNYXRoX2RlZmF1bHQudG9TTm9ybShyZXN1bHQueCwgcmFuZ2VNYXgpOwogICAgICAgIHJlc3VsdC55ID0gTWF0aF9kZWZhdWx0LnRvU05vcm0ocmVzdWx0LnksIHJhbmdlTWF4KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RFbmNvZGUgPSBmdW5jdGlvbih2ZWN0b3IsIHJlc3VsdCkgewogICAgICAgIHJldHVybiBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RFbmNvZGVJblJhbmdlKHZlY3RvciwgMjU1LCByZXN1bHQpOwogICAgICB9OwogICAgICBvY3RFbmNvZGVTY3JhdGNoID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICB1aW50OEZvcmNlQXJyYXkgPSBuZXcgVWludDhBcnJheSgxKTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RW5jb2RlVG9DYXJ0ZXNpYW40ID0gZnVuY3Rpb24odmVjdG9yLCByZXN1bHQpIHsKICAgICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RFbmNvZGVJblJhbmdlKHZlY3RvciwgNjU1MzUsIG9jdEVuY29kZVNjcmF0Y2gpOwogICAgICAgIHJlc3VsdC54ID0gZm9yY2VVaW50OChvY3RFbmNvZGVTY3JhdGNoLnggKiBSSUdIVF9TSElGVCk7CiAgICAgICAgcmVzdWx0LnkgPSBmb3JjZVVpbnQ4KG9jdEVuY29kZVNjcmF0Y2gueCk7CiAgICAgICAgcmVzdWx0LnogPSBmb3JjZVVpbnQ4KG9jdEVuY29kZVNjcmF0Y2gueSAqIFJJR0hUX1NISUZUKTsKICAgICAgICByZXN1bHQudyA9IGZvcmNlVWludDgob2N0RW5jb2RlU2NyYXRjaC55KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3REZWNvZGVJblJhbmdlID0gZnVuY3Rpb24oeCwgeSwgcmFuZ2VNYXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBpZiAoeCA8IDAgfHwgeCA+IHJhbmdlTWF4IHx8IHkgPCAwIHx8IHkgPiByYW5nZU1heCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGB4IGFuZCB5IG11c3QgYmUgdW5zaWduZWQgbm9ybWFsaXplZCBpbnRlZ2VycyBiZXR3ZWVuIDAgYW5kICR7cmFuZ2VNYXh9YAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBNYXRoX2RlZmF1bHQuZnJvbVNOb3JtKHgsIHJhbmdlTWF4KTsKICAgICAgICByZXN1bHQueSA9IE1hdGhfZGVmYXVsdC5mcm9tU05vcm0oeSwgcmFuZ2VNYXgpOwogICAgICAgIHJlc3VsdC56ID0gMSAtIChNYXRoLmFicyhyZXN1bHQueCkgKyBNYXRoLmFicyhyZXN1bHQueSkpOwogICAgICAgIGlmIChyZXN1bHQueiA8IDApIHsKICAgICAgICAgIGNvbnN0IG9sZFZYID0gcmVzdWx0Lng7CiAgICAgICAgICByZXN1bHQueCA9ICgxIC0gTWF0aC5hYnMocmVzdWx0LnkpKSAqIE1hdGhfZGVmYXVsdC5zaWduTm90WmVybyhvbGRWWCk7CiAgICAgICAgICByZXN1bHQueSA9ICgxIC0gTWF0aC5hYnMob2xkVlgpKSAqIE1hdGhfZGVmYXVsdC5zaWduTm90WmVybyhyZXN1bHQueSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RGVjb2RlID0gZnVuY3Rpb24oeCwgeSwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdERlY29kZUluUmFuZ2UoeCwgeSwgMjU1LCByZXN1bHQpOwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3REZWNvZGVGcm9tQ2FydGVzaWFuNCA9IGZ1bmN0aW9uKGVuY29kZWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZW5jb2RlZCIsIGVuY29kZWQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB4ID0gZW5jb2RlZC54OwogICAgICAgIGNvbnN0IHkgPSBlbmNvZGVkLnk7CiAgICAgICAgY29uc3QgeiA9IGVuY29kZWQuejsKICAgICAgICBjb25zdCB3ID0gZW5jb2RlZC53OwogICAgICAgIGlmICh4IDwgMCB8fCB4ID4gMjU1IHx8IHkgPCAwIHx8IHkgPiAyNTUgfHwgeiA8IDAgfHwgeiA+IDI1NSB8fCB3IDwgMCB8fCB3ID4gMjU1KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIngsIHksIHosIGFuZCB3IG11c3QgYmUgdW5zaWduZWQgbm9ybWFsaXplZCBpbnRlZ2VycyBiZXR3ZWVuIDAgYW5kIDI1NSIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHhPY3QxNiA9IHggKiBMRUZUX1NISUZUICsgeTsKICAgICAgICBjb25zdCB5T2N0MTYgPSB6ICogTEVGVF9TSElGVCArIHc7CiAgICAgICAgcmV0dXJuIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdERlY29kZUluUmFuZ2UoeE9jdDE2LCB5T2N0MTYsIDY1NTM1LCByZXN1bHQpOwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RQYWNrRmxvYXQgPSBmdW5jdGlvbihlbmNvZGVkKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJlbmNvZGVkIiwgZW5jb2RlZCk7CiAgICAgICAgcmV0dXJuIDI1NiAqIGVuY29kZWQueCArIGVuY29kZWQueTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVuY29kZUNhcnQyID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RFbmNvZGVGbG9hdCA9IGZ1bmN0aW9uKHZlY3RvcikgewogICAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZSh2ZWN0b3IsIHNjcmF0Y2hFbmNvZGVDYXJ0Mik7CiAgICAgICAgcmV0dXJuIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdFBhY2tGbG9hdChzY3JhdGNoRW5jb2RlQ2FydDIpOwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3REZWNvZGVGbG9hdCA9IGZ1bmN0aW9uKHZhbHVlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIGNvbnN0IHRlbXAgPSB2YWx1ZSAvIDI1NjsKICAgICAgICBjb25zdCB4ID0gTWF0aC5mbG9vcih0ZW1wKTsKICAgICAgICBjb25zdCB5ID0gKHRlbXAgLSB4KSAqIDI1NjsKICAgICAgICByZXR1cm4gQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RGVjb2RlKHgsIHksIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdFBhY2sgPSBmdW5jdGlvbih2MTIsIHYyMiwgdjMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidjEiLCB2MTIpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidjIiLCB2MjIpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidjMiLCB2Myk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIGNvbnN0IGVuY29kZWQxID0gQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RW5jb2RlRmxvYXQodjEyKTsKICAgICAgICBjb25zdCBlbmNvZGVkMiA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdEVuY29kZUZsb2F0KHYyMik7CiAgICAgICAgY29uc3QgZW5jb2RlZDMgPSBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3RFbmNvZGUodjMsIHNjcmF0Y2hFbmNvZGVDYXJ0Mik7CiAgICAgICAgcmVzdWx0LnggPSA2NTUzNiAqIGVuY29kZWQzLnggKyBlbmNvZGVkMTsKICAgICAgICByZXN1bHQueSA9IDY1NTM2ICogZW5jb2RlZDMueSArIGVuY29kZWQyOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdFVucGFjayA9IGZ1bmN0aW9uKHBhY2tlZCwgdjEyLCB2MjIsIHYzKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwYWNrZWQiLCBwYWNrZWQpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidjEiLCB2MTIpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidjIiLCB2MjIpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidjMiLCB2Myk7CiAgICAgICAgbGV0IHRlbXAgPSBwYWNrZWQueCAvIDY1NTM2OwogICAgICAgIGNvbnN0IHggPSBNYXRoLmZsb29yKHRlbXApOwogICAgICAgIGNvbnN0IGVuY29kZWRGbG9hdDEgPSAodGVtcCAtIHgpICogNjU1MzY7CiAgICAgICAgdGVtcCA9IHBhY2tlZC55IC8gNjU1MzY7CiAgICAgICAgY29uc3QgeSA9IE1hdGguZmxvb3IodGVtcCk7CiAgICAgICAgY29uc3QgZW5jb2RlZEZsb2F0MiA9ICh0ZW1wIC0geSkgKiA2NTUzNjsKICAgICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5vY3REZWNvZGVGbG9hdChlbmNvZGVkRmxvYXQxLCB2MTIpOwogICAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLm9jdERlY29kZUZsb2F0KGVuY29kZWRGbG9hdDIsIHYyMik7CiAgICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24ub2N0RGVjb2RlKHgsIHksIHYzKTsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24uY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMgPSBmdW5jdGlvbih0ZXh0dXJlQ29vcmRpbmF0ZXMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInRleHR1cmVDb29yZGluYXRlcyIsIHRleHR1cmVDb29yZGluYXRlcyk7CiAgICAgICAgY29uc3QgeCA9IHRleHR1cmVDb29yZGluYXRlcy54ICogNDA5NSB8IDA7CiAgICAgICAgY29uc3QgeSA9IHRleHR1cmVDb29yZGluYXRlcy55ICogNDA5NSB8IDA7CiAgICAgICAgcmV0dXJuIDQwOTYgKiB4ICsgeTsKICAgICAgfTsKICAgICAgQXR0cmlidXRlQ29tcHJlc3Npb24uZGVjb21wcmVzc1RleHR1cmVDb29yZGluYXRlcyA9IGZ1bmN0aW9uKGNvbXByZXNzZWQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY29tcHJlc3NlZCIsIGNvbXByZXNzZWQpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBjb25zdCB0ZW1wID0gY29tcHJlc3NlZCAvIDQwOTY7CiAgICAgICAgY29uc3QgeFplcm9UbzQwOTUgPSBNYXRoLmZsb29yKHRlbXApOwogICAgICAgIHJlc3VsdC54ID0geFplcm9UbzQwOTUgLyA0MDk1OwogICAgICAgIHJlc3VsdC55ID0gKGNvbXByZXNzZWQgLSB4WmVyb1RvNDA5NSAqIDQwOTYpIC8gNDA5NTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi56aWdaYWdEZWx0YURlY29kZSA9IGZ1bmN0aW9uKHVCdWZmZXIsIHZCdWZmZXIsIGhlaWdodEJ1ZmZlcikgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidUJ1ZmZlciIsIHVCdWZmZXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidkJ1ZmZlciIsIHZCdWZmZXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5lcXVhbHMoCiAgICAgICAgICAidUJ1ZmZlci5sZW5ndGgiLAogICAgICAgICAgInZCdWZmZXIubGVuZ3RoIiwKICAgICAgICAgIHVCdWZmZXIubGVuZ3RoLAogICAgICAgICAgdkJ1ZmZlci5sZW5ndGgKICAgICAgICApOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaGVpZ2h0QnVmZmVyKSkgewogICAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmVxdWFscygKICAgICAgICAgICAgInVCdWZmZXIubGVuZ3RoIiwKICAgICAgICAgICAgImhlaWdodEJ1ZmZlci5sZW5ndGgiLAogICAgICAgICAgICB1QnVmZmVyLmxlbmd0aCwKICAgICAgICAgICAgaGVpZ2h0QnVmZmVyLmxlbmd0aAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY291bnQgPSB1QnVmZmVyLmxlbmd0aDsKICAgICAgICBsZXQgdTMgPSAwOwogICAgICAgIGxldCB2MyA9IDA7CiAgICAgICAgbGV0IGhlaWdodCA9IDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgKytpKSB7CiAgICAgICAgICB1MyArPSB6aWdaYWdEZWNvZGUodUJ1ZmZlcltpXSk7CiAgICAgICAgICB2MyArPSB6aWdaYWdEZWNvZGUodkJ1ZmZlcltpXSk7CiAgICAgICAgICB1QnVmZmVyW2ldID0gdTM7CiAgICAgICAgICB2QnVmZmVyW2ldID0gdjM7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGhlaWdodEJ1ZmZlcikpIHsKICAgICAgICAgICAgaGVpZ2h0ICs9IHppZ1phZ0RlY29kZShoZWlnaHRCdWZmZXJbaV0pOwogICAgICAgICAgICBoZWlnaHRCdWZmZXJbaV0gPSBoZWlnaHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbi5kZXF1YW50aXplID0gZnVuY3Rpb24odHlwZWRBcnJheSwgY29tcG9uZW50RGF0YXR5cGUsIHR5cGUsIGNvdW50KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ0eXBlZEFycmF5IiwgdHlwZWRBcnJheSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjb21wb25lbnREYXRhdHlwZSIsIGNvbXBvbmVudERhdGF0eXBlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInR5cGUiLCB0eXBlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNvdW50IiwgY291bnQpOwogICAgICAgIGNvbnN0IGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgPSBBdHRyaWJ1dGVUeXBlX2RlZmF1bHQuZ2V0TnVtYmVyT2ZDb21wb25lbnRzKHR5cGUpOwogICAgICAgIGxldCBkaXZpc29yOwogICAgICAgIHN3aXRjaCAoY29tcG9uZW50RGF0YXR5cGUpIHsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5CWVRFOgogICAgICAgICAgICBkaXZpc29yID0gMTI3OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFOgogICAgICAgICAgICBkaXZpc29yID0gMjU1OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5TSE9SVDoKICAgICAgICAgICAgZGl2aXNvciA9IDMyNzY3OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9TSE9SVDoKICAgICAgICAgICAgZGl2aXNvciA9IDY1NTM1OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5JTlQ6CiAgICAgICAgICAgIGRpdmlzb3IgPSAyMTQ3NDgzNjQ3OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9JTlQ6CiAgICAgICAgICAgIGRpdmlzb3IgPSA0Mjk0OTY3Mjk1OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAgIGBDYW5ub3QgZGVxdWFudGl6ZSBjb21wb25lbnQgZGF0YXR5cGU6ICR7Y29tcG9uZW50RGF0YXR5cGV9YAogICAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBkZXF1YW50aXplZFR5cGVkQXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KAogICAgICAgICAgY291bnQgKiBjb21wb25lbnRzUGVyQXR0cmlidXRlCiAgICAgICAgKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgY29tcG9uZW50c1BlckF0dHJpYnV0ZTsgaisrKSB7CiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gaSAqIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgKyBqOwogICAgICAgICAgICBkZXF1YW50aXplZFR5cGVkQXJyYXlbaW5kZXhdID0gTWF0aC5tYXgoCiAgICAgICAgICAgICAgdHlwZWRBcnJheVtpbmRleF0gLyBkaXZpc29yLAogICAgICAgICAgICAgIC0xCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZXF1YW50aXplZFR5cGVkQXJyYXk7CiAgICAgIH07CiAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uLmRlY29kZVJHQjU2NSA9IGZ1bmN0aW9uKHR5cGVkQXJyYXksIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidHlwZWRBcnJheSIsIHR5cGVkQXJyYXkpOwogICAgICAgIGNvbnN0IGV4cGVjdGVkTGVuZ3RoID0gdHlwZWRBcnJheS5sZW5ndGggKiAzOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmVxdWFscygKICAgICAgICAgICAgInJlc3VsdC5sZW5ndGgiLAogICAgICAgICAgICAidHlwZWRBcnJheS5sZW5ndGggKiAzIiwKICAgICAgICAgICAgcmVzdWx0Lmxlbmd0aCwKICAgICAgICAgICAgZXhwZWN0ZWRMZW5ndGgKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvdW50ID0gdHlwZWRBcnJheS5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEZsb2F0MzJBcnJheShjb3VudCAqIDMpOwogICAgICAgIH0KICAgICAgICBjb25zdCBtYXNrNSA9ICgxIDw8IDUpIC0gMTsKICAgICAgICBjb25zdCBtYXNrNiA9ICgxIDw8IDYpIC0gMTsKICAgICAgICBjb25zdCBub3JtYWxpemU1ID0gMSAvIDMxOwogICAgICAgIGNvbnN0IG5vcm1hbGl6ZTYgPSAxIC8gNjM7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHR5cGVkQXJyYXlbaV07CiAgICAgICAgICBjb25zdCByZWQgPSB2YWx1ZSA+PiAxMTsKICAgICAgICAgIGNvbnN0IGdyZWVuID0gdmFsdWUgPj4gNSAmIG1hc2s2OwogICAgICAgICAgY29uc3QgYmx1ZSA9IHZhbHVlICYgbWFzazU7CiAgICAgICAgICBjb25zdCBvZmZzZXQgPSAzICogaTsKICAgICAgICAgIHJlc3VsdFtvZmZzZXRdID0gcmVkICogbm9ybWFsaXplNTsKICAgICAgICAgIHJlc3VsdFtvZmZzZXQgKyAxXSA9IGdyZWVuICogbm9ybWFsaXplNjsKICAgICAgICAgIHJlc3VsdFtvZmZzZXQgKyAyXSA9IGJsdWUgKiBub3JtYWxpemU1OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0ID0gQXR0cmlidXRlQ29tcHJlc3Npb247CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9iYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzLmpzCiAgZnVuY3Rpb24gYmFyeWNlbnRyaWNDb29yZGluYXRlcyhwb2ludCwgcDAsIHAxLCBwMiwgcmVzdWx0KSB7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBvaW50IiwgcG9pbnQpOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwMCIsIHAwKTsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicDEiLCBwMSk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInAyIiwgcDIpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICB9CiAgICBsZXQgdjAyOwogICAgbGV0IHYxMjsKICAgIGxldCB2MjI7CiAgICBsZXQgZG90MDA7CiAgICBsZXQgZG90MDE7CiAgICBsZXQgZG90MDI7CiAgICBsZXQgZG90MTE7CiAgICBsZXQgZG90MTI7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwMC56KSkgewogICAgICBpZiAoQ2FydGVzaWFuMl9kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocG9pbnQsIHAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWCwgcmVzdWx0KTsKICAgICAgfQogICAgICBpZiAoQ2FydGVzaWFuMl9kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocG9pbnQsIHAxLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWSwgcmVzdWx0KTsKICAgICAgfQogICAgICBpZiAoQ2FydGVzaWFuMl9kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocG9pbnQsIHAyLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0KSkgewogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwgcmVzdWx0KTsKICAgICAgfQogICAgICB2MDIgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuc3VidHJhY3QocDEsIHAwLCBzY3JhdGNoQ2FydGVzaWFuMSk7CiAgICAgIHYxMiA9IENhcnRlc2lhbjJfZGVmYXVsdC5zdWJ0cmFjdChwMiwgcDAsIHNjcmF0Y2hDYXJ0ZXNpYW4yKTsKICAgICAgdjIyID0gQ2FydGVzaWFuMl9kZWZhdWx0LnN1YnRyYWN0KHBvaW50LCBwMCwgc2NyYXRjaENhcnRlc2lhbjMyKTsKICAgICAgZG90MDAgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZG90KHYwMiwgdjAyKTsKICAgICAgZG90MDEgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZG90KHYwMiwgdjEyKTsKICAgICAgZG90MDIgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZG90KHYwMiwgdjIyKTsKICAgICAgZG90MTEgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZG90KHYxMiwgdjEyKTsKICAgICAgZG90MTIgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZG90KHYxMiwgdjIyKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwb2ludCwgcDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLCByZXN1bHQpOwogICAgICB9CiAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwb2ludCwgcDEsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZLCByZXN1bHQpOwogICAgICB9CiAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwb2ludCwgcDIsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpKSB7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aLCByZXN1bHQpOwogICAgICB9CiAgICAgIHYwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMSwgcDAsIHNjcmF0Y2hDYXJ0ZXNpYW4xKTsKICAgICAgdjEyID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAyLCBwMCwgc2NyYXRjaENhcnRlc2lhbjIpOwogICAgICB2MjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocG9pbnQsIHAwLCBzY3JhdGNoQ2FydGVzaWFuMzIpOwogICAgICBkb3QwMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjAyLCB2MDIpOwogICAgICBkb3QwMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjAyLCB2MTIpOwogICAgICBkb3QwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjAyLCB2MjIpOwogICAgICBkb3QxMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjEyLCB2MTIpOwogICAgICBkb3QxMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjEyLCB2MjIpOwogICAgfQogICAgcmVzdWx0LnkgPSBkb3QxMSAqIGRvdDAyIC0gZG90MDEgKiBkb3QxMjsKICAgIHJlc3VsdC56ID0gZG90MDAgKiBkb3QxMiAtIGRvdDAxICogZG90MDI7CiAgICBjb25zdCBxID0gZG90MDAgKiBkb3QxMSAtIGRvdDAxICogZG90MDE7CiAgICBpZiAocSA9PT0gMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgcmVzdWx0LnkgLz0gcTsKICAgIHJlc3VsdC56IC89IHE7CiAgICByZXN1bHQueCA9IDEgLSByZXN1bHQueSAtIHJlc3VsdC56OwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4xLCBzY3JhdGNoQ2FydGVzaWFuMiwgc2NyYXRjaENhcnRlc2lhbjMyLCBiYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzX2RlZmF1bHQ7CiAgdmFyIGluaXRfYmFyeWNlbnRyaWNDb29yZGluYXRlcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYmFyeWNlbnRyaWNDb29yZGluYXRlcy5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjMyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBiYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzX2RlZmF1bHQgPSBiYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRW5jb2RlZENhcnRlc2lhbjMuanMKICBmdW5jdGlvbiBFbmNvZGVkQ2FydGVzaWFuMygpIHsKICAgIHRoaXMuaGlnaCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTyk7CiAgICB0aGlzLmxvdyA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTyk7CiAgfQogIHZhciBzY3JhdGNoRW5jb2RlLCBlbmNvZGVkUCwgRW5jb2RlZENhcnRlc2lhbjNfZGVmYXVsdDsKICB2YXIgaW5pdF9FbmNvZGVkQ2FydGVzaWFuMyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRW5jb2RlZENhcnRlc2lhbjMuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgRW5jb2RlZENhcnRlc2lhbjMuZW5jb2RlID0gZnVuY3Rpb24odmFsdWUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gewogICAgICAgICAgICBoaWdoOiAwLAogICAgICAgICAgICBsb3c6IDAKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGxldCBkb3VibGVIaWdoOwogICAgICAgIGlmICh2YWx1ZSA+PSAwKSB7CiAgICAgICAgICBkb3VibGVIaWdoID0gTWF0aC5mbG9vcih2YWx1ZSAvIDY1NTM2KSAqIDY1NTM2OwogICAgICAgICAgcmVzdWx0LmhpZ2ggPSBkb3VibGVIaWdoOwogICAgICAgICAgcmVzdWx0LmxvdyA9IHZhbHVlIC0gZG91YmxlSGlnaDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZG91YmxlSGlnaCA9IE1hdGguZmxvb3IoLXZhbHVlIC8gNjU1MzYpICogNjU1MzY7CiAgICAgICAgICByZXN1bHQuaGlnaCA9IC1kb3VibGVIaWdoOwogICAgICAgICAgcmVzdWx0LmxvdyA9IHZhbHVlICsgZG91YmxlSGlnaDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaEVuY29kZSA9IHsKICAgICAgICBoaWdoOiAwLAogICAgICAgIGxvdzogMAogICAgICB9OwogICAgICBFbmNvZGVkQ2FydGVzaWFuMy5mcm9tQ2FydGVzaWFuID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBFbmNvZGVkQ2FydGVzaWFuMygpOwogICAgICAgIH0KICAgICAgICBjb25zdCBoaWdoID0gcmVzdWx0LmhpZ2g7CiAgICAgICAgY29uc3QgbG93ID0gcmVzdWx0LmxvdzsKICAgICAgICBFbmNvZGVkQ2FydGVzaWFuMy5lbmNvZGUoY2FydGVzaWFuMTEueCwgc2NyYXRjaEVuY29kZSk7CiAgICAgICAgaGlnaC54ID0gc2NyYXRjaEVuY29kZS5oaWdoOwogICAgICAgIGxvdy54ID0gc2NyYXRjaEVuY29kZS5sb3c7CiAgICAgICAgRW5jb2RlZENhcnRlc2lhbjMuZW5jb2RlKGNhcnRlc2lhbjExLnksIHNjcmF0Y2hFbmNvZGUpOwogICAgICAgIGhpZ2gueSA9IHNjcmF0Y2hFbmNvZGUuaGlnaDsKICAgICAgICBsb3cueSA9IHNjcmF0Y2hFbmNvZGUubG93OwogICAgICAgIEVuY29kZWRDYXJ0ZXNpYW4zLmVuY29kZShjYXJ0ZXNpYW4xMS56LCBzY3JhdGNoRW5jb2RlKTsKICAgICAgICBoaWdoLnogPSBzY3JhdGNoRW5jb2RlLmhpZ2g7CiAgICAgICAgbG93LnogPSBzY3JhdGNoRW5jb2RlLmxvdzsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBlbmNvZGVkUCA9IG5ldyBFbmNvZGVkQ2FydGVzaWFuMygpOwogICAgICBFbmNvZGVkQ2FydGVzaWFuMy53cml0ZUVsZW1lbnRzID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIGNhcnRlc2lhbkFycmF5LCBpbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydGVzaWFuQXJyYXkiLCBjYXJ0ZXNpYW5BcnJheSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJpbmRleCIsIGluZGV4KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygiaW5kZXgiLCBpbmRleCwgMCk7CiAgICAgICAgRW5jb2RlZENhcnRlc2lhbjMuZnJvbUNhcnRlc2lhbihjYXJ0ZXNpYW4xMSwgZW5jb2RlZFApOwogICAgICAgIGNvbnN0IGhpZ2ggPSBlbmNvZGVkUC5oaWdoOwogICAgICAgIGNvbnN0IGxvdyA9IGVuY29kZWRQLmxvdzsKICAgICAgICBjYXJ0ZXNpYW5BcnJheVtpbmRleF0gPSBoaWdoLng7CiAgICAgICAgY2FydGVzaWFuQXJyYXlbaW5kZXggKyAxXSA9IGhpZ2gueTsKICAgICAgICBjYXJ0ZXNpYW5BcnJheVtpbmRleCArIDJdID0gaGlnaC56OwogICAgICAgIGNhcnRlc2lhbkFycmF5W2luZGV4ICsgM10gPSBsb3cueDsKICAgICAgICBjYXJ0ZXNpYW5BcnJheVtpbmRleCArIDRdID0gbG93Lnk7CiAgICAgICAgY2FydGVzaWFuQXJyYXlbaW5kZXggKyA1XSA9IGxvdy56OwogICAgICB9OwogICAgICBFbmNvZGVkQ2FydGVzaWFuM19kZWZhdWx0ID0gRW5jb2RlZENhcnRlc2lhbjM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbmRleERhdGF0eXBlLmpzCiAgdmFyIEluZGV4RGF0YXR5cGUsIEluZGV4RGF0YXR5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9JbmRleERhdGF0eXBlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbmRleERhdGF0eXBlLmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfV2ViR0xDb25zdGFudHMoKTsKICAgICAgSW5kZXhEYXRhdHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiA4LWJpdCB1bnNpZ25lZCBieXRlIGNvcnJlc3BvbmRpbmcgdG8gPGNvZGU+VU5TSUdORURfQllURTwvY29kZT4gYW5kIHRoZSB0eXBlCiAgICAgICAgICogb2YgYW4gZWxlbWVudCBpbiA8Y29kZT5VaW50OEFycmF5PC9jb2RlPi4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVU5TSUdORURfQllURTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIC8qKgogICAgICAgICAqIDE2LWJpdCB1bnNpZ25lZCBzaG9ydCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPlVOU0lHTkVEX1NIT1JUPC9jb2RlPiBhbmQgdGhlIHR5cGUKICAgICAgICAgKiBvZiBhbiBlbGVtZW50IGluIDxjb2RlPlVpbnQxNkFycmF5PC9jb2RlPi4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgVU5TSUdORURfU0hPUlQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfU0hPUlQsCiAgICAgICAgLyoqCiAgICAgICAgICogMzItYml0IHVuc2lnbmVkIGludCBjb3JyZXNwb25kaW5nIHRvIDxjb2RlPlVOU0lHTkVEX0lOVDwvY29kZT4gYW5kIHRoZSB0eXBlCiAgICAgICAgICogb2YgYW4gZWxlbWVudCBpbiA8Y29kZT5VaW50MzJBcnJheTwvY29kZT4uCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFVOU0lHTkVEX0lOVDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9JTlQKICAgICAgfTsKICAgICAgSW5kZXhEYXRhdHlwZS5nZXRTaXplSW5CeXRlcyA9IGZ1bmN0aW9uKGluZGV4RGF0YXR5cGUpIHsKICAgICAgICBzd2l0Y2ggKGluZGV4RGF0YXR5cGUpIHsKICAgICAgICAgIGNhc2UgSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9CWVRFOgogICAgICAgICAgICByZXR1cm4gVWludDhBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgICAgIGNhc2UgSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9TSE9SVDoKICAgICAgICAgICAgcmV0dXJuIFVpbnQxNkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgY2FzZSBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0lOVDoKICAgICAgICAgICAgcmV0dXJuIFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJpbmRleERhdGF0eXBlIGlzIHJlcXVpcmVkIGFuZCBtdXN0IGJlIGEgdmFsaWQgSW5kZXhEYXRhdHlwZSBjb25zdGFudC4iCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgSW5kZXhEYXRhdHlwZS5mcm9tU2l6ZUluQnl0ZXMgPSBmdW5jdGlvbihzaXplSW5CeXRlcykgewogICAgICAgIHN3aXRjaCAoc2l6ZUluQnl0ZXMpIHsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgcmV0dXJuIEluZGV4RGF0YXR5cGUuVU5TSUdORURfU0hPUlQ7CiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIHJldHVybiBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0lOVDsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgcmV0dXJuIEluZGV4RGF0YXR5cGUuVU5TSUdORURfQllURTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAgICJTaXplIGluIGJ5dGVzIGNhbm5vdCBiZSBtYXBwZWQgdG8gYW4gSW5kZXhEYXRhdHlwZSIKICAgICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIEluZGV4RGF0YXR5cGUudmFsaWRhdGUgPSBmdW5jdGlvbihpbmRleERhdGF0eXBlKSB7CiAgICAgICAgcmV0dXJuIGRlZmluZWRfZGVmYXVsdChpbmRleERhdGF0eXBlKSAmJiAoaW5kZXhEYXRhdHlwZSA9PT0gSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9CWVRFIHx8IGluZGV4RGF0YXR5cGUgPT09IEluZGV4RGF0YXR5cGUuVU5TSUdORURfU0hPUlQgfHwgaW5kZXhEYXRhdHlwZSA9PT0gSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9JTlQpOwogICAgICB9OwogICAgICBJbmRleERhdGF0eXBlLmNyZWF0ZVR5cGVkQXJyYXkgPSBmdW5jdGlvbihudW1iZXJPZlZlcnRpY2VzLCBpbmRpY2VzTGVuZ3RoT3JBcnJheSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG51bWJlck9mVmVydGljZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibnVtYmVyT2ZWZXJ0aWNlcyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG51bWJlck9mVmVydGljZXMgPj0gTWF0aF9kZWZhdWx0LlNJWFRZX0ZPVVJfS0lMT0JZVEVTKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFVpbnQzMkFycmF5KGluZGljZXNMZW5ndGhPckFycmF5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBVaW50MTZBcnJheShpbmRpY2VzTGVuZ3RoT3JBcnJheSk7CiAgICAgIH07CiAgICAgIEluZGV4RGF0YXR5cGUuY3JlYXRlVHlwZWRBcnJheUZyb21BcnJheUJ1ZmZlciA9IGZ1bmN0aW9uKG51bWJlck9mVmVydGljZXMsIHNvdXJjZUFycmF5LCBieXRlT2Zmc2V0LCBsZW5ndGgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChudW1iZXJPZlZlcnRpY2VzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm51bWJlck9mVmVydGljZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNvdXJjZUFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInNvdXJjZUFycmF5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChieXRlT2Zmc2V0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImJ5dGVPZmZzZXQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChudW1iZXJPZlZlcnRpY2VzID49IE1hdGhfZGVmYXVsdC5TSVhUWV9GT1VSX0tJTE9CWVRFUykgewogICAgICAgICAgcmV0dXJuIG5ldyBVaW50MzJBcnJheShzb3VyY2VBcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBVaW50MTZBcnJheShzb3VyY2VBcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICAgICAgfTsKICAgICAgSW5kZXhEYXRhdHlwZS5mcm9tVHlwZWRBcnJheSA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICAgICAgaWYgKGFycmF5IGluc3RhbmNlb2YgVWludDhBcnJheSkgewogICAgICAgICAgcmV0dXJuIEluZGV4RGF0YXR5cGUuVU5TSUdORURfQllURTsKICAgICAgICB9CiAgICAgICAgaWYgKGFycmF5IGluc3RhbmNlb2YgVWludDE2QXJyYXkpIHsKICAgICAgICAgIHJldHVybiBJbmRleERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBVaW50MzJBcnJheSkgewogICAgICAgICAgcmV0dXJuIEluZGV4RGF0YXR5cGUuVU5TSUdORURfSU5UOwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJhcnJheSBtdXN0IGJlIGEgVWludDhBcnJheSwgVWludDE2QXJyYXksIG9yIFVpbnQzMkFycmF5LiIKICAgICAgICApOwogICAgICB9OwogICAgICBJbmRleERhdGF0eXBlX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKEluZGV4RGF0YXR5cGUpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUXVhZHJhdGljUmVhbFBvbHlub21pYWwuanMKICBmdW5jdGlvbiBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2sobGVmdCwgcmlnaHQsIHRvbGVyYW5jZSkgewogICAgY29uc3QgZGlmZmVyZW5jZSA9IGxlZnQgKyByaWdodDsKICAgIGlmIChNYXRoX2RlZmF1bHQuc2lnbihsZWZ0KSAhPT0gTWF0aF9kZWZhdWx0LnNpZ24ocmlnaHQpICYmIE1hdGguYWJzKGRpZmZlcmVuY2UgLyBNYXRoLm1heChNYXRoLmFicyhsZWZ0KSwgTWF0aC5hYnMocmlnaHQpKSkgPCB0b2xlcmFuY2UpIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICByZXR1cm4gZGlmZmVyZW5jZTsKICB9CiAgdmFyIFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsLCBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0OwogIHZhciBpbml0X1F1YWRyYXRpY1JlYWxQb2x5bm9taWFsID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9RdWFkcmF0aWNSZWFsUG9seW5vbWlhbC5qcyIoKSB7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsID0ge307CiAgICAgIFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVEaXNjcmltaW5hbnQgPSBmdW5jdGlvbihhMywgYiwgYykgewogICAgICAgIGlmICh0eXBlb2YgYTMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImIgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBkaXNjcmltaW5hbnQgPSBiICogYiAtIDQgKiBhMyAqIGM7CiAgICAgICAgcmV0dXJuIGRpc2NyaW1pbmFudDsKICAgICAgfTsKICAgICAgUXVhZHJhdGljUmVhbFBvbHlub21pYWwuY29tcHV0ZVJlYWxSb290cyA9IGZ1bmN0aW9uKGEzLCBiLCBjKSB7CiAgICAgICAgaWYgKHR5cGVvZiBhMyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGIgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYiBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImMgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGxldCByYXRpbzsKICAgICAgICBpZiAoYTMgPT09IDApIHsKICAgICAgICAgIGlmIChiID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbLWMgLyBiXTsKICAgICAgICB9IGVsc2UgaWYgKGIgPT09IDApIHsKICAgICAgICAgIGlmIChjID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBbMCwgMF07CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBjTWFnbml0dWRlID0gTWF0aC5hYnMoYyk7CiAgICAgICAgICBjb25zdCBhTWFnbml0dWRlID0gTWF0aC5hYnMoYTMpOwogICAgICAgICAgaWYgKGNNYWduaXR1ZGUgPCBhTWFnbml0dWRlICYmIGNNYWduaXR1ZGUgLyBhTWFnbml0dWRlIDwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkgewogICAgICAgICAgICByZXR1cm4gWzAsIDBdOwogICAgICAgICAgfSBlbHNlIGlmIChjTWFnbml0dWRlID4gYU1hZ25pdHVkZSAmJiBhTWFnbml0dWRlIC8gY01hZ25pdHVkZSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTQpIHsKICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgfQogICAgICAgICAgcmF0aW8gPSAtYyAvIGEzOwogICAgICAgICAgaWYgKHJhdGlvIDwgMCkgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByb290ID0gTWF0aC5zcXJ0KHJhdGlvKTsKICAgICAgICAgIHJldHVybiBbLXJvb3QsIHJvb3RdOwogICAgICAgIH0gZWxzZSBpZiAoYyA9PT0gMCkgewogICAgICAgICAgcmF0aW8gPSAtYiAvIGEzOwogICAgICAgICAgaWYgKHJhdGlvIDwgMCkgewogICAgICAgICAgICByZXR1cm4gW3JhdGlvLCAwXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbMCwgcmF0aW9dOwogICAgICAgIH0KICAgICAgICBjb25zdCBiMiA9IGIgKiBiOwogICAgICAgIGNvbnN0IGZvdXJfYWMgPSA0ICogYTMgKiBjOwogICAgICAgIGNvbnN0IHJhZGljYW5kID0gYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrKGIyLCAtZm91cl9hYywgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCk7CiAgICAgICAgaWYgKHJhZGljYW5kIDwgMCkgewogICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0KICAgICAgICBjb25zdCBxID0gLTAuNSAqIGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjaygKICAgICAgICAgIGIsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuc2lnbihiKSAqIE1hdGguc3FydChyYWRpY2FuZCksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjE0CiAgICAgICAgKTsKICAgICAgICBpZiAoYiA+IDApIHsKICAgICAgICAgIHJldHVybiBbcSAvIGEzLCBjIC8gcV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBbYyAvIHEsIHEgLyBhM107CiAgICAgIH07CiAgICAgIFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0N1YmljUmVhbFBvbHlub21pYWwuanMKICBmdW5jdGlvbiBjb21wdXRlUmVhbFJvb3RzKGEzLCBiLCBjLCBkKSB7CiAgICBjb25zdCBBID0gYTM7CiAgICBjb25zdCBCID0gYiAvIDM7CiAgICBjb25zdCBDID0gYyAvIDM7CiAgICBjb25zdCBEID0gZDsKICAgIGNvbnN0IEFDID0gQSAqIEM7CiAgICBjb25zdCBCRCA9IEIgKiBEOwogICAgY29uc3QgQjIgPSBCICogQjsKICAgIGNvbnN0IEMyID0gQyAqIEM7CiAgICBjb25zdCBkZWx0YTEgPSBBICogQyAtIEIyOwogICAgY29uc3QgZGVsdGEyID0gQSAqIEQgLSBCICogQzsKICAgIGNvbnN0IGRlbHRhMyA9IEIgKiBEIC0gQzI7CiAgICBjb25zdCBkaXNjcmltaW5hbnQgPSA0ICogZGVsdGExICogZGVsdGEzIC0gZGVsdGEyICogZGVsdGEyOwogICAgbGV0IHRlbXA7CiAgICBsZXQgdGVtcDE7CiAgICBpZiAoZGlzY3JpbWluYW50IDwgMCkgewogICAgICBsZXQgQUJhcjsKICAgICAgbGV0IENCYXI7CiAgICAgIGxldCBEQmFyOwogICAgICBpZiAoQjIgKiBCRCA+PSBBQyAqIEMyKSB7CiAgICAgICAgQUJhciA9IEE7CiAgICAgICAgQ0JhciA9IGRlbHRhMTsKICAgICAgICBEQmFyID0gLTIgKiBCICogZGVsdGExICsgQSAqIGRlbHRhMjsKICAgICAgfSBlbHNlIHsKICAgICAgICBBQmFyID0gRDsKICAgICAgICBDQmFyID0gZGVsdGEzOwogICAgICAgIERCYXIgPSAtRCAqIGRlbHRhMiArIDIgKiBDICogZGVsdGEzOwogICAgICB9CiAgICAgIGNvbnN0IHMgPSBEQmFyIDwgMCA/IC0xIDogMTsKICAgICAgY29uc3QgdGVtcDAgPSAtcyAqIE1hdGguYWJzKEFCYXIpICogTWF0aC5zcXJ0KC1kaXNjcmltaW5hbnQpOwogICAgICB0ZW1wMSA9IC1EQmFyICsgdGVtcDA7CiAgICAgIGNvbnN0IHggPSB0ZW1wMSAvIDI7CiAgICAgIGNvbnN0IHAgPSB4IDwgMCA/IC1NYXRoLnBvdygteCwgMSAvIDMpIDogTWF0aC5wb3coeCwgMSAvIDMpOwogICAgICBjb25zdCBxID0gdGVtcDEgPT09IHRlbXAwID8gLXAgOiAtQ0JhciAvIHA7CiAgICAgIHRlbXAgPSBDQmFyIDw9IDAgPyBwICsgcSA6IC1EQmFyIC8gKHAgKiBwICsgcSAqIHEgKyBDQmFyKTsKICAgICAgaWYgKEIyICogQkQgPj0gQUMgKiBDMikgewogICAgICAgIHJldHVybiBbKHRlbXAgLSBCKSAvIEFdOwogICAgICB9CiAgICAgIHJldHVybiBbLUQgLyAodGVtcCArIEMpXTsKICAgIH0KICAgIGNvbnN0IENCYXJBID0gZGVsdGExOwogICAgY29uc3QgREJhckEgPSAtMiAqIEIgKiBkZWx0YTEgKyBBICogZGVsdGEyOwogICAgY29uc3QgQ0JhckQgPSBkZWx0YTM7CiAgICBjb25zdCBEQmFyRCA9IC1EICogZGVsdGEyICsgMiAqIEMgKiBkZWx0YTM7CiAgICBjb25zdCBzcXVhcmVSb290T2ZEaXNjcmltaW5hbnQgPSBNYXRoLnNxcnQoZGlzY3JpbWluYW50KTsKICAgIGNvbnN0IGhhbGZTcXVhcmVSb290T2YzID0gTWF0aC5zcXJ0KDMpIC8gMjsKICAgIGxldCB0aGV0YSA9IE1hdGguYWJzKE1hdGguYXRhbjIoQSAqIHNxdWFyZVJvb3RPZkRpc2NyaW1pbmFudCwgLURCYXJBKSAvIDMpOwogICAgdGVtcCA9IDIgKiBNYXRoLnNxcnQoLUNCYXJBKTsKICAgIGxldCBjb3NpbmUgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICB0ZW1wMSA9IHRlbXAgKiBjb3NpbmU7CiAgICBsZXQgdGVtcDMgPSB0ZW1wICogKC1jb3NpbmUgLyAyIC0gaGFsZlNxdWFyZVJvb3RPZjMgKiBNYXRoLnNpbih0aGV0YSkpOwogICAgY29uc3QgbnVtZXJhdG9yTGFyZ2UgPSB0ZW1wMSArIHRlbXAzID4gMiAqIEIgPyB0ZW1wMSAtIEIgOiB0ZW1wMyAtIEI7CiAgICBjb25zdCBkZW5vbWluYXRvckxhcmdlID0gQTsKICAgIGNvbnN0IHJvb3QxID0gbnVtZXJhdG9yTGFyZ2UgLyBkZW5vbWluYXRvckxhcmdlOwogICAgdGhldGEgPSBNYXRoLmFicyhNYXRoLmF0YW4yKEQgKiBzcXVhcmVSb290T2ZEaXNjcmltaW5hbnQsIC1EQmFyRCkgLyAzKTsKICAgIHRlbXAgPSAyICogTWF0aC5zcXJ0KC1DQmFyRCk7CiAgICBjb3NpbmUgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICB0ZW1wMSA9IHRlbXAgKiBjb3NpbmU7CiAgICB0ZW1wMyA9IHRlbXAgKiAoLWNvc2luZSAvIDIgLSBoYWxmU3F1YXJlUm9vdE9mMyAqIE1hdGguc2luKHRoZXRhKSk7CiAgICBjb25zdCBudW1lcmF0b3JTbWFsbCA9IC1EOwogICAgY29uc3QgZGVub21pbmF0b3JTbWFsbCA9IHRlbXAxICsgdGVtcDMgPCAyICogQyA/IHRlbXAxICsgQyA6IHRlbXAzICsgQzsKICAgIGNvbnN0IHJvb3QzID0gbnVtZXJhdG9yU21hbGwgLyBkZW5vbWluYXRvclNtYWxsOwogICAgY29uc3QgRSA9IGRlbm9taW5hdG9yTGFyZ2UgKiBkZW5vbWluYXRvclNtYWxsOwogICAgY29uc3QgRiA9IC1udW1lcmF0b3JMYXJnZSAqIGRlbm9taW5hdG9yU21hbGwgLSBkZW5vbWluYXRvckxhcmdlICogbnVtZXJhdG9yU21hbGw7CiAgICBjb25zdCBHID0gbnVtZXJhdG9yTGFyZ2UgKiBudW1lcmF0b3JTbWFsbDsKICAgIGNvbnN0IHJvb3QyID0gKEMgKiBGIC0gQiAqIEcpIC8gKC1CICogRiArIEMgKiBFKTsKICAgIGlmIChyb290MSA8PSByb290MikgewogICAgICBpZiAocm9vdDEgPD0gcm9vdDMpIHsKICAgICAgICBpZiAocm9vdDIgPD0gcm9vdDMpIHsKICAgICAgICAgIHJldHVybiBbcm9vdDEsIHJvb3QyLCByb290M107CiAgICAgICAgfQogICAgICAgIHJldHVybiBbcm9vdDEsIHJvb3QzLCByb290Ml07CiAgICAgIH0KICAgICAgcmV0dXJuIFtyb290Mywgcm9vdDEsIHJvb3QyXTsKICAgIH0KICAgIGlmIChyb290MSA8PSByb290MykgewogICAgICByZXR1cm4gW3Jvb3QyLCByb290MSwgcm9vdDNdOwogICAgfQogICAgaWYgKHJvb3QyIDw9IHJvb3QzKSB7CiAgICAgIHJldHVybiBbcm9vdDIsIHJvb3QzLCByb290MV07CiAgICB9CiAgICByZXR1cm4gW3Jvb3QzLCByb290Miwgcm9vdDFdOwogIH0KICB2YXIgQ3ViaWNSZWFsUG9seW5vbWlhbCwgQ3ViaWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0OwogIHZhciBpbml0X0N1YmljUmVhbFBvbHlub21pYWwgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0N1YmljUmVhbFBvbHlub21pYWwuanMiKCkgewogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfUXVhZHJhdGljUmVhbFBvbHlub21pYWwoKTsKICAgICAgQ3ViaWNSZWFsUG9seW5vbWlhbCA9IHt9OwogICAgICBDdWJpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVEaXNjcmltaW5hbnQgPSBmdW5jdGlvbihhMywgYiwgYywgZCkgewogICAgICAgIGlmICh0eXBlb2YgYTMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBiICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImIgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGQgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZCBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYTIyID0gYTMgKiBhMzsKICAgICAgICBjb25zdCBiMiA9IGIgKiBiOwogICAgICAgIGNvbnN0IGMyID0gYyAqIGM7CiAgICAgICAgY29uc3QgZDIgPSBkICogZDsKICAgICAgICBjb25zdCBkaXNjcmltaW5hbnQgPSAxOCAqIGEzICogYiAqIGMgKiBkICsgYjIgKiBjMiAtIDI3ICogYTIyICogZDIgLSA0ICogKGEzICogYzIgKiBjICsgYjIgKiBiICogZCk7CiAgICAgICAgcmV0dXJuIGRpc2NyaW1pbmFudDsKICAgICAgfTsKICAgICAgQ3ViaWNSZWFsUG9seW5vbWlhbC5jb21wdXRlUmVhbFJvb3RzID0gZnVuY3Rpb24oYTMsIGIsIGMsIGQpIHsKICAgICAgICBpZiAodHlwZW9mIGEzICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImEgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgYiAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJiIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGMgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYyBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBkICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImQgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGxldCByb290czsKICAgICAgICBsZXQgcmF0aW87CiAgICAgICAgaWYgKGEzID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKGIsIGMsIGQpOwogICAgICAgIH0gZWxzZSBpZiAoYiA9PT0gMCkgewogICAgICAgICAgaWYgKGMgPT09IDApIHsKICAgICAgICAgICAgaWYgKGQgPT09IDApIHsKICAgICAgICAgICAgICByZXR1cm4gWzAsIDAsIDBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJhdGlvID0gLWQgLyBhMzsKICAgICAgICAgICAgY29uc3Qgcm9vdCA9IHJhdGlvIDwgMCA/IC1NYXRoLnBvdygtcmF0aW8sIDEgLyAzKSA6IE1hdGgucG93KHJhdGlvLCAxIC8gMyk7CiAgICAgICAgICAgIHJldHVybiBbcm9vdCwgcm9vdCwgcm9vdF07CiAgICAgICAgICB9IGVsc2UgaWYgKGQgPT09IDApIHsKICAgICAgICAgICAgcm9vdHMgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoYTMsIDAsIGMpOwogICAgICAgICAgICBpZiAocm9vdHMuTGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFswXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gW3Jvb3RzWzBdLCAwLCByb290c1sxXV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29tcHV0ZVJlYWxSb290cyhhMywgMCwgYywgZCk7CiAgICAgICAgfSBlbHNlIGlmIChjID09PSAwKSB7CiAgICAgICAgICBpZiAoZCA9PT0gMCkgewogICAgICAgICAgICByYXRpbyA9IC1iIC8gYTM7CiAgICAgICAgICAgIGlmIChyYXRpbyA8IDApIHsKICAgICAgICAgICAgICByZXR1cm4gW3JhdGlvLCAwLCAwXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gWzAsIDAsIHJhdGlvXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb21wdXRlUmVhbFJvb3RzKGEzLCBiLCAwLCBkKTsKICAgICAgICB9IGVsc2UgaWYgKGQgPT09IDApIHsKICAgICAgICAgIHJvb3RzID0gUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKGEzLCBiLCBjKTsKICAgICAgICAgIGlmIChyb290cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIFswXTsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdHNbMV0gPD0gMCkgewogICAgICAgICAgICByZXR1cm4gW3Jvb3RzWzBdLCByb290c1sxXSwgMF07CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzWzBdID49IDApIHsKICAgICAgICAgICAgcmV0dXJuIFswLCByb290c1swXSwgcm9vdHNbMV1dOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFtyb290c1swXSwgMCwgcm9vdHNbMV1dOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29tcHV0ZVJlYWxSb290cyhhMywgYiwgYywgZCk7CiAgICAgIH07CiAgICAgIEN1YmljUmVhbFBvbHlub21pYWxfZGVmYXVsdCA9IEN1YmljUmVhbFBvbHlub21pYWw7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9RdWFydGljUmVhbFBvbHlub21pYWwuanMKICBmdW5jdGlvbiBvcmlnaW5hbChhMywgYTIyLCBhMSwgYTApIHsKICAgIGNvbnN0IGEzU3F1YXJlZCA9IGEzICogYTM7CiAgICBjb25zdCBwID0gYTIyIC0gMyAqIGEzU3F1YXJlZCAvIDg7CiAgICBjb25zdCBxID0gYTEgLSBhMjIgKiBhMyAvIDIgKyBhM1NxdWFyZWQgKiBhMyAvIDg7CiAgICBjb25zdCByID0gYTAgLSBhMSAqIGEzIC8gNCArIGEyMiAqIGEzU3F1YXJlZCAvIDE2IC0gMyAqIGEzU3F1YXJlZCAqIGEzU3F1YXJlZCAvIDI1NjsKICAgIGNvbnN0IGN1YmljUm9vdHMgPSBDdWJpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cygKICAgICAgMSwKICAgICAgMiAqIHAsCiAgICAgIHAgKiBwIC0gNCAqIHIsCiAgICAgIC1xICogcQogICAgKTsKICAgIGlmIChjdWJpY1Jvb3RzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgdGVtcCA9IC1hMyAvIDQ7CiAgICAgIGNvbnN0IGhTcXVhcmVkID0gY3ViaWNSb290c1tjdWJpY1Jvb3RzLmxlbmd0aCAtIDFdOwogICAgICBpZiAoTWF0aC5hYnMoaFNxdWFyZWQpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNCkgewogICAgICAgIGNvbnN0IHJvb3RzID0gUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKDEsIHAsIHIpOwogICAgICAgIGlmIChyb290cy5sZW5ndGggPT09IDIpIHsKICAgICAgICAgIGNvbnN0IHJvb3QwID0gcm9vdHNbMF07CiAgICAgICAgICBjb25zdCByb290MSA9IHJvb3RzWzFdOwogICAgICAgICAgbGV0IHk7CiAgICAgICAgICBpZiAocm9vdDAgPj0gMCAmJiByb290MSA+PSAwKSB7CiAgICAgICAgICAgIGNvbnN0IHkwID0gTWF0aC5zcXJ0KHJvb3QwKTsKICAgICAgICAgICAgY29uc3QgeTEgPSBNYXRoLnNxcnQocm9vdDEpOwogICAgICAgICAgICByZXR1cm4gW3RlbXAgLSB5MSwgdGVtcCAtIHkwLCB0ZW1wICsgeTAsIHRlbXAgKyB5MV07CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3QwID49IDAgJiYgcm9vdDEgPCAwKSB7CiAgICAgICAgICAgIHkgPSBNYXRoLnNxcnQocm9vdDApOwogICAgICAgICAgICByZXR1cm4gW3RlbXAgLSB5LCB0ZW1wICsgeV07CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3QwIDwgMCAmJiByb290MSA+PSAwKSB7CiAgICAgICAgICAgIHkgPSBNYXRoLnNxcnQocm9vdDEpOwogICAgICAgICAgICByZXR1cm4gW3RlbXAgLSB5LCB0ZW1wICsgeV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBbXTsKICAgICAgfSBlbHNlIGlmIChoU3F1YXJlZCA+IDApIHsKICAgICAgICBjb25zdCBoID0gTWF0aC5zcXJ0KGhTcXVhcmVkKTsKICAgICAgICBjb25zdCBtID0gKHAgKyBoU3F1YXJlZCAtIHEgLyBoKSAvIDI7CiAgICAgICAgY29uc3QgbiA9IChwICsgaFNxdWFyZWQgKyBxIC8gaCkgLyAyOwogICAgICAgIGNvbnN0IHJvb3RzMSA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cygxLCBoLCBtKTsKICAgICAgICBjb25zdCByb290czIgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoMSwgLWgsIG4pOwogICAgICAgIGlmIChyb290czEubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICByb290czFbMF0gKz0gdGVtcDsKICAgICAgICAgIHJvb3RzMVsxXSArPSB0ZW1wOwogICAgICAgICAgaWYgKHJvb3RzMi5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgcm9vdHMyWzBdICs9IHRlbXA7CiAgICAgICAgICAgIHJvb3RzMlsxXSArPSB0ZW1wOwogICAgICAgICAgICBpZiAocm9vdHMxWzFdIDw9IHJvb3RzMlswXSkgewogICAgICAgICAgICAgIHJldHVybiBbcm9vdHMxWzBdLCByb290czFbMV0sIHJvb3RzMlswXSwgcm9vdHMyWzFdXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb290czJbMV0gPD0gcm9vdHMxWzBdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFtyb290czJbMF0sIHJvb3RzMlsxXSwgcm9vdHMxWzBdLCByb290czFbMV1dOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzMVswXSA+PSByb290czJbMF0gJiYgcm9vdHMxWzFdIDw9IHJvb3RzMlsxXSkgewogICAgICAgICAgICAgIHJldHVybiBbcm9vdHMyWzBdLCByb290czFbMF0sIHJvb3RzMVsxXSwgcm9vdHMyWzFdXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyb290czJbMF0gPj0gcm9vdHMxWzBdICYmIHJvb3RzMlsxXSA8PSByb290czFbMV0pIHsKICAgICAgICAgICAgICByZXR1cm4gW3Jvb3RzMVswXSwgcm9vdHMyWzBdLCByb290czJbMV0sIHJvb3RzMVsxXV07CiAgICAgICAgICAgIH0gZWxzZSBpZiAocm9vdHMxWzBdID4gcm9vdHMyWzBdICYmIHJvb3RzMVswXSA8IHJvb3RzMlsxXSkgewogICAgICAgICAgICAgIHJldHVybiBbcm9vdHMyWzBdLCByb290czFbMF0sIHJvb3RzMlsxXSwgcm9vdHMxWzFdXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gW3Jvb3RzMVswXSwgcm9vdHMyWzBdLCByb290czFbMV0sIHJvb3RzMlsxXV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcm9vdHMxOwogICAgICAgIH0KICAgICAgICBpZiAocm9vdHMyLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgcm9vdHMyWzBdICs9IHRlbXA7CiAgICAgICAgICByb290czJbMV0gKz0gdGVtcDsKICAgICAgICAgIHJldHVybiByb290czI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIFtdOwogIH0KICBmdW5jdGlvbiBuZXVtYXJrKGEzLCBhMjIsIGExLCBhMCkgewogICAgY29uc3QgYTFTcXVhcmVkID0gYTEgKiBhMTsKICAgIGNvbnN0IGEyU3F1YXJlZCA9IGEyMiAqIGEyMjsKICAgIGNvbnN0IGEzU3F1YXJlZCA9IGEzICogYTM7CiAgICBjb25zdCBwID0gLTIgKiBhMjI7CiAgICBjb25zdCBxID0gYTEgKiBhMyArIGEyU3F1YXJlZCAtIDQgKiBhMDsKICAgIGNvbnN0IHIgPSBhM1NxdWFyZWQgKiBhMCAtIGExICogYTIyICogYTMgKyBhMVNxdWFyZWQ7CiAgICBjb25zdCBjdWJpY1Jvb3RzID0gQ3ViaWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoMSwgcCwgcSwgcik7CiAgICBpZiAoY3ViaWNSb290cy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHkgPSBjdWJpY1Jvb3RzWzBdOwogICAgICBjb25zdCB0ZW1wID0gYTIyIC0geTsKICAgICAgY29uc3QgdGVtcFNxdWFyZWQgPSB0ZW1wICogdGVtcDsKICAgICAgY29uc3QgZzEgPSBhMyAvIDI7CiAgICAgIGNvbnN0IGgxID0gdGVtcCAvIDI7CiAgICAgIGNvbnN0IG0gPSB0ZW1wU3F1YXJlZCAtIDQgKiBhMDsKICAgICAgY29uc3QgbUVycm9yID0gdGVtcFNxdWFyZWQgKyA0ICogTWF0aC5hYnMoYTApOwogICAgICBjb25zdCBuID0gYTNTcXVhcmVkIC0gNCAqIHk7CiAgICAgIGNvbnN0IG5FcnJvciA9IGEzU3F1YXJlZCArIDQgKiBNYXRoLmFicyh5KTsKICAgICAgbGV0IGcyOwogICAgICBsZXQgaDI7CiAgICAgIGlmICh5IDwgMCB8fCBtICogbkVycm9yIDwgbiAqIG1FcnJvcikgewogICAgICAgIGNvbnN0IHNxdWFyZVJvb3RPZk4gPSBNYXRoLnNxcnQobik7CiAgICAgICAgZzIgPSBzcXVhcmVSb290T2ZOIC8gMjsKICAgICAgICBoMiA9IHNxdWFyZVJvb3RPZk4gPT09IDAgPyAwIDogKGEzICogaDEgLSBhMSkgLyBzcXVhcmVSb290T2ZOOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHNxdWFyZVJvb3RPZk0gPSBNYXRoLnNxcnQobSk7CiAgICAgICAgZzIgPSBzcXVhcmVSb290T2ZNID09PSAwID8gMCA6IChhMyAqIGgxIC0gYTEpIC8gc3F1YXJlUm9vdE9mTTsKICAgICAgICBoMiA9IHNxdWFyZVJvb3RPZk0gLyAyOwogICAgICB9CiAgICAgIGxldCBHOwogICAgICBsZXQgZzsKICAgICAgaWYgKGcxID09PSAwICYmIGcyID09PSAwKSB7CiAgICAgICAgRyA9IDA7CiAgICAgICAgZyA9IDA7CiAgICAgIH0gZWxzZSBpZiAoTWF0aF9kZWZhdWx0LnNpZ24oZzEpID09PSBNYXRoX2RlZmF1bHQuc2lnbihnMikpIHsKICAgICAgICBHID0gZzEgKyBnMjsKICAgICAgICBnID0geSAvIEc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZyA9IGcxIC0gZzI7CiAgICAgICAgRyA9IHkgLyBnOwogICAgICB9CiAgICAgIGxldCBIOwogICAgICBsZXQgaDsKICAgICAgaWYgKGgxID09PSAwICYmIGgyID09PSAwKSB7CiAgICAgICAgSCA9IDA7CiAgICAgICAgaCA9IDA7CiAgICAgIH0gZWxzZSBpZiAoTWF0aF9kZWZhdWx0LnNpZ24oaDEpID09PSBNYXRoX2RlZmF1bHQuc2lnbihoMikpIHsKICAgICAgICBIID0gaDEgKyBoMjsKICAgICAgICBoID0gYTAgLyBIOwogICAgICB9IGVsc2UgewogICAgICAgIGggPSBoMSAtIGgyOwogICAgICAgIEggPSBhMCAvIGg7CiAgICAgIH0KICAgICAgY29uc3Qgcm9vdHMxID0gUXVhZHJhdGljUmVhbFBvbHlub21pYWxfZGVmYXVsdC5jb21wdXRlUmVhbFJvb3RzKDEsIEcsIEgpOwogICAgICBjb25zdCByb290czIgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMoMSwgZywgaCk7CiAgICAgIGlmIChyb290czEubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgaWYgKHJvb3RzMi5sZW5ndGggIT09IDApIHsKICAgICAgICAgIGlmIChyb290czFbMV0gPD0gcm9vdHMyWzBdKSB7CiAgICAgICAgICAgIHJldHVybiBbcm9vdHMxWzBdLCByb290czFbMV0sIHJvb3RzMlswXSwgcm9vdHMyWzFdXTsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdHMyWzFdIDw9IHJvb3RzMVswXSkgewogICAgICAgICAgICByZXR1cm4gW3Jvb3RzMlswXSwgcm9vdHMyWzFdLCByb290czFbMF0sIHJvb3RzMVsxXV07CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzMVswXSA+PSByb290czJbMF0gJiYgcm9vdHMxWzFdIDw9IHJvb3RzMlsxXSkgewogICAgICAgICAgICByZXR1cm4gW3Jvb3RzMlswXSwgcm9vdHMxWzBdLCByb290czFbMV0sIHJvb3RzMlsxXV07CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzMlswXSA+PSByb290czFbMF0gJiYgcm9vdHMyWzFdIDw9IHJvb3RzMVsxXSkgewogICAgICAgICAgICByZXR1cm4gW3Jvb3RzMVswXSwgcm9vdHMyWzBdLCByb290czJbMV0sIHJvb3RzMVsxXV07CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzMVswXSA+IHJvb3RzMlswXSAmJiByb290czFbMF0gPCByb290czJbMV0pIHsKICAgICAgICAgICAgcmV0dXJuIFtyb290czJbMF0sIHJvb3RzMVswXSwgcm9vdHMyWzFdLCByb290czFbMV1dOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFtyb290czFbMF0sIHJvb3RzMlswXSwgcm9vdHMxWzFdLCByb290czJbMV1dOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcm9vdHMxOwogICAgICB9CiAgICAgIGlmIChyb290czIubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgcmV0dXJuIHJvb3RzMjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIFtdOwogIH0KICB2YXIgUXVhcnRpY1JlYWxQb2x5bm9taWFsLCBRdWFydGljUmVhbFBvbHlub21pYWxfZGVmYXVsdDsKICB2YXIgaW5pdF9RdWFydGljUmVhbFBvbHlub21pYWwgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1F1YXJ0aWNSZWFsUG9seW5vbWlhbC5qcyIoKSB7CiAgICAgIGluaXRfQ3ViaWNSZWFsUG9seW5vbWlhbCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1F1YWRyYXRpY1JlYWxQb2x5bm9taWFsKCk7CiAgICAgIFF1YXJ0aWNSZWFsUG9seW5vbWlhbCA9IHt9OwogICAgICBRdWFydGljUmVhbFBvbHlub21pYWwuY29tcHV0ZURpc2NyaW1pbmFudCA9IGZ1bmN0aW9uKGEzLCBiLCBjLCBkLCBlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBhMyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGIgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYiBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImMgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZCAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGUgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYTIyID0gYTMgKiBhMzsKICAgICAgICBjb25zdCBhMzIgPSBhMjIgKiBhMzsKICAgICAgICBjb25zdCBiMiA9IGIgKiBiOwogICAgICAgIGNvbnN0IGIzID0gYjIgKiBiOwogICAgICAgIGNvbnN0IGMyID0gYyAqIGM7CiAgICAgICAgY29uc3QgYzMyID0gYzIgKiBjOwogICAgICAgIGNvbnN0IGQyID0gZCAqIGQ7CiAgICAgICAgY29uc3QgZDMgPSBkMiAqIGQ7CiAgICAgICAgY29uc3QgZTIgPSBlICogZTsKICAgICAgICBjb25zdCBlMyA9IGUyICogZTsKICAgICAgICBjb25zdCBkaXNjcmltaW5hbnQgPSBiMiAqIGMyICogZDIgLSA0ICogYjMgKiBkMyAtIDQgKiBhMyAqIGMzMiAqIGQyICsgMTggKiBhMyAqIGIgKiBjICogZDMgLSAyNyAqIGEyMiAqIGQyICogZDIgKyAyNTYgKiBhMzIgKiBlMyArIGUgKiAoMTggKiBiMyAqIGMgKiBkIC0gNCAqIGIyICogYzMyICsgMTYgKiBhMyAqIGMyICogYzIgLSA4MCAqIGEzICogYiAqIGMyICogZCAtIDYgKiBhMyAqIGIyICogZDIgKyAxNDQgKiBhMjIgKiBjICogZDIpICsgZTIgKiAoMTQ0ICogYTMgKiBiMiAqIGMgLSAyNyAqIGIyICogYjIgLSAxMjggKiBhMjIgKiBjMiAtIDE5MiAqIGEyMiAqIGIgKiBkKTsKICAgICAgICByZXR1cm4gZGlzY3JpbWluYW50OwogICAgICB9OwogICAgICBRdWFydGljUmVhbFBvbHlub21pYWwuY29tcHV0ZVJlYWxSb290cyA9IGZ1bmN0aW9uKGEzLCBiLCBjLCBkLCBlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBhMyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGIgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYiBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImMgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgZCAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGUgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKE1hdGguYWJzKGEzKSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTUpIHsKICAgICAgICAgIHJldHVybiBDdWJpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cyhiLCBjLCBkLCBlKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYTMyID0gYiAvIGEzOwogICAgICAgIGNvbnN0IGEyMiA9IGMgLyBhMzsKICAgICAgICBjb25zdCBhMSA9IGQgLyBhMzsKICAgICAgICBjb25zdCBhMCA9IGUgLyBhMzsKICAgICAgICBsZXQgayA9IGEzMiA8IDAgPyAxIDogMDsKICAgICAgICBrICs9IGEyMiA8IDAgPyBrICsgMSA6IGs7CiAgICAgICAgayArPSBhMSA8IDAgPyBrICsgMSA6IGs7CiAgICAgICAgayArPSBhMCA8IDAgPyBrICsgMSA6IGs7CiAgICAgICAgc3dpdGNoIChrKSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbChhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgcmV0dXJuIG5ldW1hcmsoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIHJldHVybiBuZXVtYXJrKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbChhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgcmV0dXJuIG5ldW1hcmsoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgIHJldHVybiBvcmlnaW5hbChhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICByZXR1cm4gbmV1bWFyayhhMzIsIGEyMiwgYTEsIGEwKTsKICAgICAgICAgIGNhc2UgOToKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzMiwgYTIyLCBhMSwgYTApOwogICAgICAgICAgY2FzZSAxMToKICAgICAgICAgICAgcmV0dXJuIG5ldW1hcmsoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDEyOgogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDE0OgogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBjYXNlIDE1OgogICAgICAgICAgICByZXR1cm4gb3JpZ2luYWwoYTMyLCBhMjIsIGExLCBhMCk7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgfTsKICAgICAgUXVhcnRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQgPSBRdWFydGljUmVhbFBvbHlub21pYWw7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SYXkuanMKICBmdW5jdGlvbiBSYXkob3JpZ2luLCBkaXJlY3Rpb24yKSB7CiAgICBkaXJlY3Rpb24yID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGRpcmVjdGlvbjIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSk7CiAgICBpZiAoIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMoZGlyZWN0aW9uMiwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKSB7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZGlyZWN0aW9uMiwgZGlyZWN0aW9uMik7CiAgICB9CiAgICB0aGlzLm9yaWdpbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShkZWZhdWx0VmFsdWVfZGVmYXVsdChvcmlnaW4sIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSk7CiAgICB0aGlzLmRpcmVjdGlvbiA9IGRpcmVjdGlvbjI7CiAgfQogIHZhciBSYXlfZGVmYXVsdDsKICB2YXIgaW5pdF9SYXkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JheS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBSYXkuY2xvbmUgPSBmdW5jdGlvbihyYXksIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJheSkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUmF5KHJheS5vcmlnaW4sIHJheS5kaXJlY3Rpb24pOwogICAgICAgIH0KICAgICAgICByZXN1bHQub3JpZ2luID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJheS5vcmlnaW4pOwogICAgICAgIHJlc3VsdC5kaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocmF5LmRpcmVjdGlvbik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmF5LmdldFBvaW50ID0gZnVuY3Rpb24ocmF5LCB0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJheSIsIHJheSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ0IiwgdCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihyYXkuZGlyZWN0aW9uLCB0LCByZXN1bHQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJheS5vcmlnaW4sIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUmF5X2RlZmF1bHQgPSBSYXk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbnRlcnNlY3Rpb25UZXN0cy5qcwogIGZ1bmN0aW9uIHNvbHZlUXVhZHJhdGljKGEzLCBiLCBjLCByZXN1bHQpIHsKICAgIGNvbnN0IGRldCA9IGIgKiBiIC0gNCAqIGEzICogYzsKICAgIGlmIChkZXQgPCAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9IGVsc2UgaWYgKGRldCA+IDApIHsKICAgICAgY29uc3QgZGVub20gPSAxIC8gKDIgKiBhMyk7CiAgICAgIGNvbnN0IGRpc2MgPSBNYXRoLnNxcnQoZGV0KTsKICAgICAgY29uc3Qgcm9vdDAgPSAoLWIgKyBkaXNjKSAqIGRlbm9tOwogICAgICBjb25zdCByb290MSA9ICgtYiAtIGRpc2MpICogZGVub207CiAgICAgIGlmIChyb290MCA8IHJvb3QxKSB7CiAgICAgICAgcmVzdWx0LnJvb3QwID0gcm9vdDA7CiAgICAgICAgcmVzdWx0LnJvb3QxID0gcm9vdDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0LnJvb3QwID0gcm9vdDE7CiAgICAgICAgcmVzdWx0LnJvb3QxID0gcm9vdDA7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGNvbnN0IHJvb3QgPSAtYiAvICgyICogYTMpOwogICAgaWYgKHJvb3QgPT09IDApIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHJlc3VsdC5yb290MCA9IHJlc3VsdC5yb290MSA9IHJvb3Q7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiByYXlTcGhlcmUocmF5LCBzcGhlcmUsIHJlc3VsdCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICByZXN1bHQgPSBuZXcgSW50ZXJ2YWxfZGVmYXVsdCgpOwogICAgfQogICAgY29uc3Qgb3JpZ2luID0gcmF5Lm9yaWdpbjsKICAgIGNvbnN0IGRpcmVjdGlvbjIgPSByYXkuZGlyZWN0aW9uOwogICAgY29uc3QgY2VudGVyID0gc3BoZXJlLmNlbnRlcjsKICAgIGNvbnN0IHJhZGl1c1NxdWFyZWQgPSBzcGhlcmUucmFkaXVzICogc3BoZXJlLnJhZGl1czsKICAgIGNvbnN0IGRpZmYgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qob3JpZ2luLCBjZW50ZXIsIHNjcmF0Y2hQVmVjKTsKICAgIGNvbnN0IGEzID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCBkaXJlY3Rpb24yKTsKICAgIGNvbnN0IGIgPSAyICogQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCBkaWZmKTsKICAgIGNvbnN0IGMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZChkaWZmKSAtIHJhZGl1c1NxdWFyZWQ7CiAgICBjb25zdCByb290cyA9IHNvbHZlUXVhZHJhdGljKGEzLCBiLCBjLCByYXlTcGhlcmVSb290cyk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyb290cykpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHJlc3VsdC5zdGFydCA9IHJvb3RzLnJvb3QwOwogICAgcmVzdWx0LnN0b3AgPSByb290cy5yb290MTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjazIobGVmdCwgcmlnaHQsIHRvbGVyYW5jZSkgewogICAgY29uc3QgZGlmZmVyZW5jZSA9IGxlZnQgKyByaWdodDsKICAgIGlmIChNYXRoX2RlZmF1bHQuc2lnbihsZWZ0KSAhPT0gTWF0aF9kZWZhdWx0LnNpZ24ocmlnaHQpICYmIE1hdGguYWJzKGRpZmZlcmVuY2UgLyBNYXRoLm1heChNYXRoLmFicyhsZWZ0KSwgTWF0aC5hYnMocmlnaHQpKSkgPCB0b2xlcmFuY2UpIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICByZXR1cm4gZGlmZmVyZW5jZTsKICB9CiAgdmFyIEludGVyc2VjdGlvblRlc3RzLCBzY3JhdGNoRWRnZTAsIHNjcmF0Y2hFZGdlMSwgc2NyYXRjaFBWZWMsIHNjcmF0Y2hUVmVjLCBzY3JhdGNoUVZlYywgc2NyYXRjaExpbmVTZWdtZW50VHJpYW5nbGVSYXksIHJheVNwaGVyZVJvb3RzLCBzY3JhdGNoTGluZVNlZ21lbnRSYXksIHNjcmF0Y2hRLCBzY3JhdGNoVywgZmlyc3RBeGlzU2NyYXRjaCwgc2Vjb25kQXhpc1NjcmF0Y2gsIHRoaXJkQXhpc1NjcmF0Y2gsIHJlZmVyZW5jZVNjcmF0Y2gsIGJDYXJ0LCBiU2NyYXRjaCwgYnRTY3JhdGNoLCBkaVNjcmF0Y2gsIGRTY3JhdGNoLCBjU2NyYXRjaCwgdGVtcE1hdHJpeCwgYVNjcmF0Y2gsIHNTY3JhdGNoLCBjbG9zZXN0U2NyYXRjaCwgc3VyZlBvaW50U2NyYXRjaCwgbGluZVNlZ21lbnRQbGFuZURpZmZlcmVuY2UsIEludGVyc2VjdGlvblRlc3RzX2RlZmF1bHQ7CiAgdmFyIGluaXRfSW50ZXJzZWN0aW9uVGVzdHMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ludGVyc2VjdGlvblRlc3RzLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfSW50ZXJ2YWwoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X1F1YWRyYXRpY1JlYWxQb2x5bm9taWFsKCk7CiAgICAgIGluaXRfUXVhcnRpY1JlYWxQb2x5bm9taWFsKCk7CiAgICAgIGluaXRfUmF5KCk7CiAgICAgIEludGVyc2VjdGlvblRlc3RzID0ge307CiAgICAgIEludGVyc2VjdGlvblRlc3RzLnJheVBsYW5lID0gZnVuY3Rpb24ocmF5LCBwbGFuZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJheSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicGxhbmUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb3JpZ2luID0gcmF5Lm9yaWdpbjsKICAgICAgICBjb25zdCBkaXJlY3Rpb24yID0gcmF5LmRpcmVjdGlvbjsKICAgICAgICBjb25zdCBub3JtYWwyID0gcGxhbmUubm9ybWFsOwogICAgICAgIGNvbnN0IGRlbm9taW5hdG9yID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBkaXJlY3Rpb24yKTsKICAgICAgICBpZiAoTWF0aC5hYnMoZGVub21pbmF0b3IpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT04xNSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgdCA9ICgtcGxhbmUuZGlzdGFuY2UgLSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIG9yaWdpbikpIC8gZGVub21pbmF0b3I7CiAgICAgICAgaWYgKHQgPCAwKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaXJlY3Rpb24yLCB0LCByZXN1bHQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG9yaWdpbiwgcmVzdWx0LCByZXN1bHQpOwogICAgICB9OwogICAgICBzY3JhdGNoRWRnZTAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFZGdlMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBWZWMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hUVmVjID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUVZlYyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMucmF5VHJpYW5nbGVQYXJhbWV0cmljID0gZnVuY3Rpb24ocmF5LCBwMCwgcDEsIHAyLCBjdWxsQmFja0ZhY2VzKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJheSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicDAgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHAxKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInAxIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwMikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwMiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY3VsbEJhY2tGYWNlcyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGN1bGxCYWNrRmFjZXMsIGZhbHNlKTsKICAgICAgICBjb25zdCBvcmlnaW4gPSByYXkub3JpZ2luOwogICAgICAgIGNvbnN0IGRpcmVjdGlvbjIgPSByYXkuZGlyZWN0aW9uOwogICAgICAgIGNvbnN0IGVkZ2UwID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAxLCBwMCwgc2NyYXRjaEVkZ2UwKTsKICAgICAgICBjb25zdCBlZGdlMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMiwgcDAsIHNjcmF0Y2hFZGdlMSk7CiAgICAgICAgY29uc3QgcCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhkaXJlY3Rpb24yLCBlZGdlMSwgc2NyYXRjaFBWZWMpOwogICAgICAgIGNvbnN0IGRldCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZWRnZTAsIHApOwogICAgICAgIGxldCB0dmVjOwogICAgICAgIGxldCBxOwogICAgICAgIGxldCB1MzsKICAgICAgICBsZXQgdjM7CiAgICAgICAgbGV0IHQ7CiAgICAgICAgaWYgKGN1bGxCYWNrRmFjZXMpIHsKICAgICAgICAgIGlmIChkZXQgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjYpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIHR2ZWMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qob3JpZ2luLCBwMCwgc2NyYXRjaFRWZWMpOwogICAgICAgICAgdTMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHR2ZWMsIHApOwogICAgICAgICAgaWYgKHUzIDwgMCB8fCB1MyA+IGRldCkgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgcSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh0dmVjLCBlZGdlMCwgc2NyYXRjaFFWZWMpOwogICAgICAgICAgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHEpOwogICAgICAgICAgaWYgKHYzIDwgMCB8fCB1MyArIHYzID4gZGV0KSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICB0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChlZGdlMSwgcSkgLyBkZXQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChNYXRoLmFicyhkZXQpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBpbnZEZXQgPSAxIC8gZGV0OwogICAgICAgICAgdHZlYyA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChvcmlnaW4sIHAwLCBzY3JhdGNoVFZlYyk7CiAgICAgICAgICB1MyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodHZlYywgcCkgKiBpbnZEZXQ7CiAgICAgICAgICBpZiAodTMgPCAwIHx8IHUzID4gMSkgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgcSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh0dmVjLCBlZGdlMCwgc2NyYXRjaFFWZWMpOwogICAgICAgICAgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHEpICogaW52RGV0OwogICAgICAgICAgaWYgKHYzIDwgMCB8fCB1MyArIHYzID4gMSkgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZWRnZTEsIHEpICogaW52RGV0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdDsKICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMucmF5VHJpYW5nbGUgPSBmdW5jdGlvbihyYXksIHAwLCBwMSwgcDIsIGN1bGxCYWNrRmFjZXMsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IHQgPSBJbnRlcnNlY3Rpb25UZXN0cy5yYXlUcmlhbmdsZVBhcmFtZXRyaWMoCiAgICAgICAgICByYXksCiAgICAgICAgICBwMCwKICAgICAgICAgIHAxLAogICAgICAgICAgcDIsCiAgICAgICAgICBjdWxsQmFja0ZhY2VzCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0KSB8fCB0IDwgMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihyYXkuZGlyZWN0aW9uLCB0LCByZXN1bHQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJheS5vcmlnaW4sIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgc2NyYXRjaExpbmVTZWdtZW50VHJpYW5nbGVSYXkgPSBuZXcgUmF5X2RlZmF1bHQoKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRUcmlhbmdsZSA9IGZ1bmN0aW9uKHYwMiwgdjEyLCBwMCwgcDEsIHAyLCBjdWxsQmFja0ZhY2VzLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2MDIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidjAgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHYxMikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2MSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicDAgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHAxKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInAxIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwMikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwMiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmF5ID0gc2NyYXRjaExpbmVTZWdtZW50VHJpYW5nbGVSYXk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHYwMiwgcmF5Lm9yaWdpbik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHYxMiwgdjAyLCByYXkuZGlyZWN0aW9uKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJheS5kaXJlY3Rpb24sIHJheS5kaXJlY3Rpb24pOwogICAgICAgIGNvbnN0IHQgPSBJbnRlcnNlY3Rpb25UZXN0cy5yYXlUcmlhbmdsZVBhcmFtZXRyaWMoCiAgICAgICAgICByYXksCiAgICAgICAgICBwMCwKICAgICAgICAgIHAxLAogICAgICAgICAgcDIsCiAgICAgICAgICBjdWxsQmFja0ZhY2VzCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0KSB8fCB0IDwgMCB8fCB0ID4gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKHYwMiwgdjEyKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihyYXkuZGlyZWN0aW9uLCB0LCByZXN1bHQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJheS5vcmlnaW4sIHJlc3VsdCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgcmF5U3BoZXJlUm9vdHMgPSB7CiAgICAgICAgcm9vdDA6IDAsCiAgICAgICAgcm9vdDE6IDAKICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMucmF5U3BoZXJlID0gZnVuY3Rpb24ocmF5LCBzcGhlcmUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyYXkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNwaGVyZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzcGhlcmUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIHJlc3VsdCA9IHJheVNwaGVyZShyYXksIHNwaGVyZSwgcmVzdWx0KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpIHx8IHJlc3VsdC5zdG9wIDwgMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnN0YXJ0ID0gTWF0aC5tYXgocmVzdWx0LnN0YXJ0LCAwKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoTGluZVNlZ21lbnRSYXkgPSBuZXcgUmF5X2RlZmF1bHQoKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRTcGhlcmUgPSBmdW5jdGlvbihwMCwgcDEsIHNwaGVyZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicDAgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHAxKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInAxIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzcGhlcmUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic3BoZXJlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCByYXkgPSBzY3JhdGNoTGluZVNlZ21lbnRSYXk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHAwLCByYXkub3JpZ2luKTsKICAgICAgICBjb25zdCBkaXJlY3Rpb24yID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAxLCBwMCwgcmF5LmRpcmVjdGlvbik7CiAgICAgICAgY29uc3QgbWF4VCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoZGlyZWN0aW9uMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShkaXJlY3Rpb24yLCBkaXJlY3Rpb24yKTsKICAgICAgICByZXN1bHQgPSByYXlTcGhlcmUocmF5LCBzcGhlcmUsIHJlc3VsdCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSB8fCByZXN1bHQuc3RvcCA8IDAgfHwgcmVzdWx0LnN0YXJ0ID4gbWF4VCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnN0YXJ0ID0gTWF0aC5tYXgocmVzdWx0LnN0YXJ0LCAwKTsKICAgICAgICByZXN1bHQuc3RvcCA9IE1hdGgubWluKHJlc3VsdC5zdG9wLCBtYXhUKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoUSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEludGVyc2VjdGlvblRlc3RzLnJheUVsbGlwc29pZCA9IGZ1bmN0aW9uKHJheSwgZWxsaXBzb2lkKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInJheSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImVsbGlwc29pZCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW52ZXJzZVJhZGlpID0gZWxsaXBzb2lkLm9uZU92ZXJSYWRpaTsKICAgICAgICBjb25zdCBxID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5Q29tcG9uZW50cyhpbnZlcnNlUmFkaWksIHJheS5vcmlnaW4sIHNjcmF0Y2hRKTsKICAgICAgICBjb25zdCB3ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5Q29tcG9uZW50cygKICAgICAgICAgIGludmVyc2VSYWRpaSwKICAgICAgICAgIHJheS5kaXJlY3Rpb24sCiAgICAgICAgICBzY3JhdGNoVwogICAgICAgICk7CiAgICAgICAgY29uc3QgcTIyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQocSk7CiAgICAgICAgY29uc3QgcXcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHEsIHcpOwogICAgICAgIGxldCBkaWZmZXJlbmNlLCB3MiwgcHJvZHVjdCwgZGlzY3JpbWluYW50LCB0ZW1wOwogICAgICAgIGlmIChxMjIgPiAxKSB7CiAgICAgICAgICBpZiAocXcgPj0gMCkgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcXcyID0gcXcgKiBxdzsKICAgICAgICAgIGRpZmZlcmVuY2UgPSBxMjIgLSAxOwogICAgICAgICAgdzIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCh3KTsKICAgICAgICAgIHByb2R1Y3QgPSB3MiAqIGRpZmZlcmVuY2U7CiAgICAgICAgICBpZiAocXcyIDwgcHJvZHVjdCkgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfSBlbHNlIGlmIChxdzIgPiBwcm9kdWN0KSB7CiAgICAgICAgICAgIGRpc2NyaW1pbmFudCA9IHF3ICogcXcgLSBwcm9kdWN0OwogICAgICAgICAgICB0ZW1wID0gLXF3ICsgTWF0aC5zcXJ0KGRpc2NyaW1pbmFudCk7CiAgICAgICAgICAgIGNvbnN0IHJvb3QwID0gdGVtcCAvIHcyOwogICAgICAgICAgICBjb25zdCByb290MSA9IGRpZmZlcmVuY2UgLyB0ZW1wOwogICAgICAgICAgICBpZiAocm9vdDAgPCByb290MSkgewogICAgICAgICAgICAgIHJldHVybiBuZXcgSW50ZXJ2YWxfZGVmYXVsdChyb290MCwgcm9vdDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgc3RhcnQ6IHJvb3QxLAogICAgICAgICAgICAgIHN0b3A6IHJvb3QwCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByb290ID0gTWF0aC5zcXJ0KGRpZmZlcmVuY2UgLyB3Mik7CiAgICAgICAgICByZXR1cm4gbmV3IEludGVydmFsX2RlZmF1bHQocm9vdCwgcm9vdCk7CiAgICAgICAgfSBlbHNlIGlmIChxMjIgPCAxKSB7CiAgICAgICAgICBkaWZmZXJlbmNlID0gcTIyIC0gMTsKICAgICAgICAgIHcyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQodyk7CiAgICAgICAgICBwcm9kdWN0ID0gdzIgKiBkaWZmZXJlbmNlOwogICAgICAgICAgZGlzY3JpbWluYW50ID0gcXcgKiBxdyAtIHByb2R1Y3Q7CiAgICAgICAgICB0ZW1wID0gLXF3ICsgTWF0aC5zcXJ0KGRpc2NyaW1pbmFudCk7CiAgICAgICAgICByZXR1cm4gbmV3IEludGVydmFsX2RlZmF1bHQoMCwgdGVtcCAvIHcyKTsKICAgICAgICB9CiAgICAgICAgaWYgKHF3IDwgMCkgewogICAgICAgICAgdzIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCh3KTsKICAgICAgICAgIHJldHVybiBuZXcgSW50ZXJ2YWxfZGVmYXVsdCgwLCAtcXcgLyB3Mik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH07CiAgICAgIEludGVyc2VjdGlvblRlc3RzLnF1YWRyYXRpY1ZlY3RvckV4cHJlc3Npb24gPSBmdW5jdGlvbihBLCBiLCBjLCB4LCB3KSB7CiAgICAgICAgY29uc3QgeFNxdWFyZWQgPSB4ICogeDsKICAgICAgICBjb25zdCB3U3F1YXJlZCA9IHcgKiB3OwogICAgICAgIGNvbnN0IGwyID0gKEFbTWF0cml4M19kZWZhdWx0LkNPTFVNTjFST1cxXSAtIEFbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cyXSkgKiB3U3F1YXJlZDsKICAgICAgICBjb25zdCBsMSA9IHcgKiAoeCAqIGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjazIoCiAgICAgICAgICBBW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4xUk9XMF0sCiAgICAgICAgICBBW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4wUk9XMV0sCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1CiAgICAgICAgKSArIGIueSk7CiAgICAgICAgY29uc3QgbDAgPSBBW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4wUk9XMF0gKiB4U3F1YXJlZCArIEFbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cyXSAqIHdTcXVhcmVkICsgeCAqIGIueCArIGM7CiAgICAgICAgY29uc3QgcjEgPSB3U3F1YXJlZCAqIGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjazIoCiAgICAgICAgICBBW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4yUk9XMV0sCiAgICAgICAgICBBW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4xUk9XMl0sCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1CiAgICAgICAgKTsKICAgICAgICBjb25zdCByMCA9IHcgKiAoeCAqIGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjazIoQVtNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMlJPVzBdLCBBW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4wUk9XMl0pICsgYi56KTsKICAgICAgICBsZXQgY29zaW5lczsKICAgICAgICBjb25zdCBzb2x1dGlvbnMgPSBbXTsKICAgICAgICBpZiAocjAgPT09IDAgJiYgcjEgPT09IDApIHsKICAgICAgICAgIGNvc2luZXMgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbF9kZWZhdWx0LmNvbXB1dGVSZWFsUm9vdHMobDIsIGwxLCBsMCk7CiAgICAgICAgICBpZiAoY29zaW5lcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIHNvbHV0aW9uczsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGNvc2luZTAgPSBjb3NpbmVzWzBdOwogICAgICAgICAgY29uc3Qgc2luZTAgPSBNYXRoLnNxcnQoTWF0aC5tYXgoMSAtIGNvc2luZTAgKiBjb3NpbmUwLCAwKSk7CiAgICAgICAgICBzb2x1dGlvbnMucHVzaChuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHgsIHcgKiBjb3NpbmUwLCB3ICogLXNpbmUwKSk7CiAgICAgICAgICBzb2x1dGlvbnMucHVzaChuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHgsIHcgKiBjb3NpbmUwLCB3ICogc2luZTApKTsKICAgICAgICAgIGlmIChjb3NpbmVzLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICBjb25zdCBjb3NpbmUxID0gY29zaW5lc1sxXTsKICAgICAgICAgICAgY29uc3Qgc2luZTEgPSBNYXRoLnNxcnQoTWF0aC5tYXgoMSAtIGNvc2luZTEgKiBjb3NpbmUxLCAwKSk7CiAgICAgICAgICAgIHNvbHV0aW9ucy5wdXNoKG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgdyAqIGNvc2luZTEsIHcgKiAtc2luZTEpKTsKICAgICAgICAgICAgc29sdXRpb25zLnB1c2gobmV3IENhcnRlc2lhbjNfZGVmYXVsdCh4LCB3ICogY29zaW5lMSwgdyAqIHNpbmUxKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc29sdXRpb25zOwogICAgICAgIH0KICAgICAgICBjb25zdCByMFNxdWFyZWQgPSByMCAqIHIwOwogICAgICAgIGNvbnN0IHIxU3F1YXJlZCA9IHIxICogcjE7CiAgICAgICAgY29uc3QgbDJTcXVhcmVkID0gbDIgKiBsMjsKICAgICAgICBjb25zdCByMHIxID0gcjAgKiByMTsKICAgICAgICBjb25zdCBjNCA9IGwyU3F1YXJlZCArIHIxU3F1YXJlZDsKICAgICAgICBjb25zdCBjMzIgPSAyICogKGwxICogbDIgKyByMHIxKTsKICAgICAgICBjb25zdCBjMiA9IDIgKiBsMCAqIGwyICsgbDEgKiBsMSAtIHIxU3F1YXJlZCArIHIwU3F1YXJlZDsKICAgICAgICBjb25zdCBjMSA9IDIgKiAobDAgKiBsMSAtIHIwcjEpOwogICAgICAgIGNvbnN0IGMwID0gbDAgKiBsMCAtIHIwU3F1YXJlZDsKICAgICAgICBpZiAoYzQgPT09IDAgJiYgYzMyID09PSAwICYmIGMyID09PSAwICYmIGMxID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gc29sdXRpb25zOwogICAgICAgIH0KICAgICAgICBjb3NpbmVzID0gUXVhcnRpY1JlYWxQb2x5bm9taWFsX2RlZmF1bHQuY29tcHV0ZVJlYWxSb290cyhjNCwgYzMyLCBjMiwgYzEsIGMwKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBjb3NpbmVzLmxlbmd0aDsKICAgICAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gc29sdXRpb25zOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjb25zdCBjb3NpbmUgPSBjb3NpbmVzW2ldOwogICAgICAgICAgY29uc3QgY29zaW5lU3F1YXJlZCA9IGNvc2luZSAqIGNvc2luZTsKICAgICAgICAgIGNvbnN0IHNpbmVTcXVhcmVkID0gTWF0aC5tYXgoMSAtIGNvc2luZVNxdWFyZWQsIDApOwogICAgICAgICAgY29uc3Qgc2luZSA9IE1hdGguc3FydChzaW5lU3F1YXJlZCk7CiAgICAgICAgICBsZXQgbGVmdDsKICAgICAgICAgIGlmIChNYXRoX2RlZmF1bHQuc2lnbihsMikgPT09IE1hdGhfZGVmYXVsdC5zaWduKGwwKSkgewogICAgICAgICAgICBsZWZ0ID0gYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrMigKICAgICAgICAgICAgICBsMiAqIGNvc2luZVNxdWFyZWQgKyBsMCwKICAgICAgICAgICAgICBsMSAqIGNvc2luZSwKICAgICAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEyCiAgICAgICAgICAgICk7CiAgICAgICAgICB9IGVsc2UgaWYgKE1hdGhfZGVmYXVsdC5zaWduKGwwKSA9PT0gTWF0aF9kZWZhdWx0LnNpZ24obDEgKiBjb3NpbmUpKSB7CiAgICAgICAgICAgIGxlZnQgPSBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2syKAogICAgICAgICAgICAgIGwyICogY29zaW5lU3F1YXJlZCwKICAgICAgICAgICAgICBsMSAqIGNvc2luZSArIGwwLAogICAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTIKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxlZnQgPSBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2syKAogICAgICAgICAgICAgIGwyICogY29zaW5lU3F1YXJlZCArIGwxICogY29zaW5lLAogICAgICAgICAgICAgIGwwLAogICAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTIKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJpZ2h0ID0gYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrMigKICAgICAgICAgICAgcjEgKiBjb3NpbmUsCiAgICAgICAgICAgIHIwLAogICAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1CiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcHJvZHVjdCA9IGxlZnQgKiByaWdodDsKICAgICAgICAgIGlmIChwcm9kdWN0IDwgMCkgewogICAgICAgICAgICBzb2x1dGlvbnMucHVzaChuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHgsIHcgKiBjb3NpbmUsIHcgKiBzaW5lKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHByb2R1Y3QgPiAwKSB7CiAgICAgICAgICAgIHNvbHV0aW9ucy5wdXNoKG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoeCwgdyAqIGNvc2luZSwgdyAqIC1zaW5lKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHNpbmUgIT09IDApIHsKICAgICAgICAgICAgc29sdXRpb25zLnB1c2gobmV3IENhcnRlc2lhbjNfZGVmYXVsdCh4LCB3ICogY29zaW5lLCB3ICogLXNpbmUpKTsKICAgICAgICAgICAgc29sdXRpb25zLnB1c2gobmV3IENhcnRlc2lhbjNfZGVmYXVsdCh4LCB3ICogY29zaW5lLCB3ICogc2luZSkpOwogICAgICAgICAgICArK2k7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzb2x1dGlvbnMucHVzaChuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHgsIHcgKiBjb3NpbmUsIHcgKiBzaW5lKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzb2x1dGlvbnM7CiAgICAgIH07CiAgICAgIGZpcnN0QXhpc1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlY29uZEF4aXNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0aGlyZEF4aXNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICByZWZlcmVuY2VTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBiQ2FydCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYlNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIGJ0U2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgZGlTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBkU2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgY1NjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHRlbXBNYXRyaXggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIGFTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBzU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2xvc2VzdFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN1cmZQb2ludFNjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMuZ3JhemluZ0FsdGl0dWRlTG9jYXRpb24gPSBmdW5jdGlvbihyYXksIGVsbGlwc29pZCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyYXkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJlbGxpcHNvaWQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvc2l0aW9uID0gcmF5Lm9yaWdpbjsKICAgICAgICBjb25zdCBkaXJlY3Rpb24yID0gcmF5LmRpcmVjdGlvbjsKICAgICAgICBpZiAoIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMocG9zaXRpb24sIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICAgICAgY29uc3Qgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIGZpcnN0QXhpc1NjcmF0Y2gpOwogICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgbm9ybWFsMikgPj0gMCkgewogICAgICAgICAgICByZXR1cm4gcG9zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGludGVyc2VjdHMgPSBkZWZpbmVkX2RlZmF1bHQodGhpcy5yYXlFbGxpcHNvaWQocmF5LCBlbGxpcHNvaWQpKTsKICAgICAgICBjb25zdCBmID0gZWxsaXBzb2lkLnRyYW5zZm9ybVBvc2l0aW9uVG9TY2FsZWRTcGFjZSgKICAgICAgICAgIGRpcmVjdGlvbjIsCiAgICAgICAgICBmaXJzdEF4aXNTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBmaXJzdEF4aXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGYsIGYpOwogICAgICAgIGNvbnN0IHJlZmVyZW5jZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tb3N0T3J0aG9nb25hbEF4aXMoZiwgcmVmZXJlbmNlU2NyYXRjaCk7CiAgICAgICAgY29uc3Qgc2Vjb25kQXhpcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MocmVmZXJlbmNlLCBmaXJzdEF4aXMsIHNlY29uZEF4aXNTY3JhdGNoKSwKICAgICAgICAgIHNlY29uZEF4aXNTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0aGlyZEF4aXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGZpcnN0QXhpcywgc2Vjb25kQXhpcywgdGhpcmRBeGlzU2NyYXRjaCksCiAgICAgICAgICB0aGlyZEF4aXNTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBCID0gYlNjcmF0Y2g7CiAgICAgICAgQlswXSA9IGZpcnN0QXhpcy54OwogICAgICAgIEJbMV0gPSBmaXJzdEF4aXMueTsKICAgICAgICBCWzJdID0gZmlyc3RBeGlzLno7CiAgICAgICAgQlszXSA9IHNlY29uZEF4aXMueDsKICAgICAgICBCWzRdID0gc2Vjb25kQXhpcy55OwogICAgICAgIEJbNV0gPSBzZWNvbmRBeGlzLno7CiAgICAgICAgQls2XSA9IHRoaXJkQXhpcy54OwogICAgICAgIEJbN10gPSB0aGlyZEF4aXMueTsKICAgICAgICBCWzhdID0gdGhpcmRBeGlzLno7CiAgICAgICAgY29uc3QgQl9UID0gTWF0cml4M19kZWZhdWx0LnRyYW5zcG9zZShCLCBidFNjcmF0Y2gpOwogICAgICAgIGNvbnN0IERfSSA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tU2NhbGUoZWxsaXBzb2lkLnJhZGlpLCBkaVNjcmF0Y2gpOwogICAgICAgIGNvbnN0IEQgPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVNjYWxlKGVsbGlwc29pZC5vbmVPdmVyUmFkaWksIGRTY3JhdGNoKTsKICAgICAgICBjb25zdCBDID0gY1NjcmF0Y2g7CiAgICAgICAgQ1swXSA9IDA7CiAgICAgICAgQ1sxXSA9IC1kaXJlY3Rpb24yLno7CiAgICAgICAgQ1syXSA9IGRpcmVjdGlvbjIueTsKICAgICAgICBDWzNdID0gZGlyZWN0aW9uMi56OwogICAgICAgIENbNF0gPSAwOwogICAgICAgIENbNV0gPSAtZGlyZWN0aW9uMi54OwogICAgICAgIENbNl0gPSAtZGlyZWN0aW9uMi55OwogICAgICAgIENbN10gPSBkaXJlY3Rpb24yLng7CiAgICAgICAgQ1s4XSA9IDA7CiAgICAgICAgY29uc3QgdGVtcCA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseSgKICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseShCX1QsIEQsIHRlbXBNYXRyaXgpLAogICAgICAgICAgQywKICAgICAgICAgIHRlbXBNYXRyaXgKICAgICAgICApOwogICAgICAgIGNvbnN0IEEgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHkoCiAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHkodGVtcCwgRF9JLCBhU2NyYXRjaCksCiAgICAgICAgICBCLAogICAgICAgICAgYVNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGIgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0ZW1wLCBwb3NpdGlvbiwgYkNhcnQpOwogICAgICAgIGNvbnN0IHNvbHV0aW9ucyA9IEludGVyc2VjdGlvblRlc3RzLnF1YWRyYXRpY1ZlY3RvckV4cHJlc3Npb24oCiAgICAgICAgICBBLAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShiLCBmaXJzdEF4aXNTY3JhdGNoKSwKICAgICAgICAgIDAsCiAgICAgICAgICAwLAogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgbGV0IHM7CiAgICAgICAgbGV0IGFsdGl0dWRlOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHNvbHV0aW9ucy5sZW5ndGg7CiAgICAgICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgICAgIGxldCBjbG9zZXN0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBjbG9zZXN0U2NyYXRjaCk7CiAgICAgICAgICBsZXQgbWF4aW11bVZhbHVlID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBzID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICAgICAgRF9JLAogICAgICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKEIsIHNvbHV0aW9uc1tpXSwgc1NjcmF0Y2gpLAogICAgICAgICAgICAgIHNTY3JhdGNoCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IHYzID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocywgcG9zaXRpb24sIHJlZmVyZW5jZVNjcmF0Y2gpLAogICAgICAgICAgICAgIHJlZmVyZW5jZVNjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29uc3QgZG90UHJvZHVjdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjMsIGRpcmVjdGlvbjIpOwogICAgICAgICAgICBpZiAoZG90UHJvZHVjdCA+IG1heGltdW1WYWx1ZSkgewogICAgICAgICAgICAgIG1heGltdW1WYWx1ZSA9IGRvdFByb2R1Y3Q7CiAgICAgICAgICAgICAgY2xvc2VzdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShzLCBjbG9zZXN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3Qgc3VyZmFjZVBvaW50ID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgICBjbG9zZXN0LAogICAgICAgICAgICBzdXJmUG9pbnRTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgbWF4aW11bVZhbHVlID0gTWF0aF9kZWZhdWx0LmNsYW1wKG1heGltdW1WYWx1ZSwgMCwgMSk7CiAgICAgICAgICBhbHRpdHVkZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjbG9zZXN0LCBwb3NpdGlvbiwgcmVmZXJlbmNlU2NyYXRjaCkKICAgICAgICAgICkgKiBNYXRoLnNxcnQoMSAtIG1heGltdW1WYWx1ZSAqIG1heGltdW1WYWx1ZSk7CiAgICAgICAgICBhbHRpdHVkZSA9IGludGVyc2VjdHMgPyAtYWx0aXR1ZGUgOiBhbHRpdHVkZTsKICAgICAgICAgIHN1cmZhY2VQb2ludC5oZWlnaHQgPSBhbHRpdHVkZTsKICAgICAgICAgIHJldHVybiBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oc3VyZmFjZVBvaW50LCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9OwogICAgICBsaW5lU2VnbWVudFBsYW5lRGlmZmVyZW5jZSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZSA9IGZ1bmN0aW9uKGVuZFBvaW50MCwgZW5kUG9pbnQxLCBwbGFuZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZW5kUG9pbnQwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImVuZFBvaW50MCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZW5kUG9pbnQxKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImVuZFBvaW50MSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicGxhbmUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGlmZmVyZW5jZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIGVuZFBvaW50MSwKICAgICAgICAgIGVuZFBvaW50MCwKICAgICAgICAgIGxpbmVTZWdtZW50UGxhbmVEaWZmZXJlbmNlCiAgICAgICAgKTsKICAgICAgICBjb25zdCBub3JtYWwyID0gcGxhbmUubm9ybWFsOwogICAgICAgIGNvbnN0IG5Eb3REaWZmID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBkaWZmZXJlbmNlKTsKICAgICAgICBpZiAoTWF0aC5hYnMobkRvdERpZmYpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCBuRG90UDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIGVuZFBvaW50MCk7CiAgICAgICAgY29uc3QgdCA9IC0ocGxhbmUuZGlzdGFuY2UgKyBuRG90UDApIC8gbkRvdERpZmY7CiAgICAgICAgaWYgKHQgPCAwIHx8IHQgPiAxKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaWZmZXJlbmNlLCB0LCByZXN1bHQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZW5kUG9pbnQwLCByZXN1bHQsIHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMudHJpYW5nbGVQbGFuZUludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKHAwLCBwMSwgcDIsIHBsYW5lKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocDApIHx8ICFkZWZpbmVkX2RlZmF1bHQocDEpIHx8ICFkZWZpbmVkX2RlZmF1bHQocDIpIHx8ICFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicDAsIHAxLCBwMiwgYW5kIHBsYW5lIGFyZSByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGxhbmVOb3JtYWwgPSBwbGFuZS5ub3JtYWw7CiAgICAgICAgY29uc3QgcGxhbmVEID0gcGxhbmUuZGlzdGFuY2U7CiAgICAgICAgY29uc3QgcDBCZWhpbmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHBsYW5lTm9ybWFsLCBwMCkgKyBwbGFuZUQgPCAwOwogICAgICAgIGNvbnN0IHAxQmVoaW5kID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChwbGFuZU5vcm1hbCwgcDEpICsgcGxhbmVEIDwgMDsKICAgICAgICBjb25zdCBwMkJlaGluZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QocGxhbmVOb3JtYWwsIHAyKSArIHBsYW5lRCA8IDA7CiAgICAgICAgbGV0IG51bUJlaGluZCA9IDA7CiAgICAgICAgbnVtQmVoaW5kICs9IHAwQmVoaW5kID8gMSA6IDA7CiAgICAgICAgbnVtQmVoaW5kICs9IHAxQmVoaW5kID8gMSA6IDA7CiAgICAgICAgbnVtQmVoaW5kICs9IHAyQmVoaW5kID8gMSA6IDA7CiAgICAgICAgbGV0IHUxMiwgdTIyOwogICAgICAgIGlmIChudW1CZWhpbmQgPT09IDEgfHwgbnVtQmVoaW5kID09PSAyKSB7CiAgICAgICAgICB1MTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgICB1MjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGlmIChudW1CZWhpbmQgPT09IDEpIHsKICAgICAgICAgIGlmIChwMEJlaGluZCkgewogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAwLCBwMSwgcGxhbmUsIHUxMik7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDAsIHAyLCBwbGFuZSwgdTIyKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwb3NpdGlvbnM6IFtwMCwgcDEsIHAyLCB1MTIsIHUyMl0sCiAgICAgICAgICAgICAgaW5kaWNlczogWwogICAgICAgICAgICAgICAgLy8gQmVoaW5kCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAvLyBJbiBmcm9udAogICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgIDIsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAzCiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmIChwMUJlaGluZCkgewogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAxLCBwMiwgcGxhbmUsIHUxMik7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDEsIHAwLCBwbGFuZSwgdTIyKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwb3NpdGlvbnM6IFtwMCwgcDEsIHAyLCB1MTIsIHUyMl0sCiAgICAgICAgICAgICAgaW5kaWNlczogWwogICAgICAgICAgICAgICAgLy8gQmVoaW5kCiAgICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAvLyBJbiBmcm9udAogICAgICAgICAgICAgICAgMiwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMiwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAzCiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmIChwMkJlaGluZCkgewogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAyLCBwMCwgcGxhbmUsIHUxMik7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDIsIHAxLCBwbGFuZSwgdTIyKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwb3NpdGlvbnM6IFtwMCwgcDEsIHAyLCB1MTIsIHUyMl0sCiAgICAgICAgICAgICAgaW5kaWNlczogWwogICAgICAgICAgICAgICAgLy8gQmVoaW5kCiAgICAgICAgICAgICAgICAyLAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAvLyBJbiBmcm9udAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAzCiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAobnVtQmVoaW5kID09PSAyKSB7CiAgICAgICAgICBpZiAoIXAwQmVoaW5kKSB7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDEsIHAwLCBwbGFuZSwgdTEyKTsKICAgICAgICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMiwgcDAsIHBsYW5lLCB1MjIpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHBvc2l0aW9uczogW3AwLCBwMSwgcDIsIHUxMiwgdTIyXSwKICAgICAgICAgICAgICBpbmRpY2VzOiBbCiAgICAgICAgICAgICAgICAvLyBCZWhpbmQKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAyLAogICAgICAgICAgICAgICAgNCwKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIC8vIEluIGZyb250CiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMywKICAgICAgICAgICAgICAgIDQKICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgaWYgKCFwMUJlaGluZCkgewogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAyLCBwMSwgcGxhbmUsIHUxMik7CiAgICAgICAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDAsIHAxLCBwbGFuZSwgdTIyKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBwb3NpdGlvbnM6IFtwMCwgcDEsIHAyLCB1MTIsIHUyMl0sCiAgICAgICAgICAgICAgaW5kaWNlczogWwogICAgICAgICAgICAgICAgLy8gQmVoaW5kCiAgICAgICAgICAgICAgICAyLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAyLAogICAgICAgICAgICAgICAgNCwKICAgICAgICAgICAgICAgIDMsCiAgICAgICAgICAgICAgICAvLyBJbiBmcm9udAogICAgICAgICAgICAgICAgMSwKICAgICAgICAgICAgICAgIDMsCiAgICAgICAgICAgICAgICA0CiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmICghcDJCZWhpbmQpIHsKICAgICAgICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMCwgcDIsIHBsYW5lLCB1MTIpOwogICAgICAgICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAxLCBwMiwgcGxhbmUsIHUyMik7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgcG9zaXRpb25zOiBbcDAsIHAxLCBwMiwgdTEyLCB1MjJdLAogICAgICAgICAgICAgIGluZGljZXM6IFsKICAgICAgICAgICAgICAgIC8vIEJlaGluZAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICA0LAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAzLAogICAgICAgICAgICAgICAgLy8gSW4gZnJvbnQKICAgICAgICAgICAgICAgIDIsCiAgICAgICAgICAgICAgICAzLAogICAgICAgICAgICAgICAgNAogICAgICAgICAgICAgIF0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHNfZGVmYXVsdCA9IEludGVyc2VjdGlvblRlc3RzOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUGxhbmUuanMKICBmdW5jdGlvbiBQbGFuZShub3JtYWwyLCBkaXN0YW5jZSkgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJub3JtYWwiLCBub3JtYWwyKTsKICAgIGlmICghTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUobm9ybWFsMiksCiAgICAgIDEsCiAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9ONgogICAgKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibm9ybWFsIG11c3QgYmUgbm9ybWFsaXplZC4iKTsKICAgIH0KICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiZGlzdGFuY2UiLCBkaXN0YW5jZSk7CiAgICB0aGlzLm5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShub3JtYWwyKTsKICAgIHRoaXMuZGlzdGFuY2UgPSBkaXN0YW5jZTsKICB9CiAgdmFyIHNjcmF0Y2hOb3JtYWwsIHNjcmF0Y2hDYXJ0ZXNpYW4sIHNjcmF0Y2hJbnZlcnNlVHJhbnNwb3NlLCBzY3JhdGNoUGxhbmVDYXJ0ZXNpYW40LCBzY3JhdGNoVHJhbnNmb3JtTm9ybWFsLCBQbGFuZV9kZWZhdWx0OwogIHZhciBpbml0X1BsYW5lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QbGFuZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRlc2lhbjQoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIFBsYW5lLmZyb21Qb2ludE5vcm1hbCA9IGZ1bmN0aW9uKHBvaW50LCBub3JtYWwyLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBvaW50IiwgcG9pbnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibm9ybWFsIiwgbm9ybWFsMik7CiAgICAgICAgaWYgKCFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUobm9ybWFsMiksCiAgICAgICAgICAxLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT042CiAgICAgICAgKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm5vcm1hbCBtdXN0IGJlIG5vcm1hbGl6ZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRpc3RhbmNlID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgcG9pbnQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUGxhbmUobm9ybWFsMiwgZGlzdGFuY2UpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobm9ybWFsMiwgcmVzdWx0Lm5vcm1hbCk7CiAgICAgICAgcmVzdWx0LmRpc3RhbmNlID0gZGlzdGFuY2U7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaE5vcm1hbCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUGxhbmUuZnJvbUNhcnRlc2lhbjQgPSBmdW5jdGlvbihjb2VmZmljaWVudHMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY29lZmZpY2llbnRzIiwgY29lZmZpY2llbnRzKTsKICAgICAgICBjb25zdCBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21DYXJ0ZXNpYW40KGNvZWZmaWNpZW50cywgc2NyYXRjaE5vcm1hbCk7CiAgICAgICAgY29uc3QgZGlzdGFuY2UgPSBjb2VmZmljaWVudHMudzsKICAgICAgICBpZiAoIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShub3JtYWwyKSwKICAgICAgICAgIDEsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjYKICAgICAgICApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibm9ybWFsIG11c3QgYmUgbm9ybWFsaXplZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBQbGFuZShub3JtYWwyLCBkaXN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShub3JtYWwyLCByZXN1bHQubm9ybWFsKTsKICAgICAgICByZXN1bHQuZGlzdGFuY2UgPSBkaXN0YW5jZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBQbGFuZS5nZXRQb2ludERpc3RhbmNlID0gZnVuY3Rpb24ocGxhbmUsIHBvaW50KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwbGFuZSIsIHBsYW5lKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBvaW50IiwgcG9pbnQpOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHBsYW5lLm5vcm1hbCwgcG9pbnQpICsgcGxhbmUuZGlzdGFuY2U7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBsYW5lLnByb2plY3RQb2ludE9udG9QbGFuZSA9IGZ1bmN0aW9uKHBsYW5lLCBwb2ludCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwbGFuZSIsIHBsYW5lKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInBvaW50IiwgcG9pbnQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcG9pbnREaXN0YW5jZSA9IFBsYW5lLmdldFBvaW50RGlzdGFuY2UocGxhbmUsIHBvaW50KTsKICAgICAgICBjb25zdCBzY2FsZWROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgIHBsYW5lLm5vcm1hbCwKICAgICAgICAgIHBvaW50RGlzdGFuY2UsCiAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvaW50LCBzY2FsZWROb3JtYWwsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hJbnZlcnNlVHJhbnNwb3NlID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGxhbmVDYXJ0ZXNpYW40ID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVHJhbnNmb3JtTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBQbGFuZS50cmFuc2Zvcm0gPSBmdW5jdGlvbihwbGFuZSwgdHJhbnNmb3JtMiwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwbGFuZSIsIHBsYW5lKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInRyYW5zZm9ybSIsIHRyYW5zZm9ybTIpOwogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBwbGFuZS5ub3JtYWw7CiAgICAgICAgY29uc3QgZGlzdGFuY2UgPSBwbGFuZS5kaXN0YW5jZTsKICAgICAgICBjb25zdCBpbnZlcnNlVHJhbnNwb3NlMiA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNwb3NlKAogICAgICAgICAgdHJhbnNmb3JtMiwKICAgICAgICAgIHNjcmF0Y2hJbnZlcnNlVHJhbnNwb3NlCiAgICAgICAgKTsKICAgICAgICBsZXQgcGxhbmVBc0NhcnRlc2lhbjQgPSBDYXJ0ZXNpYW40X2RlZmF1bHQuZnJvbUVsZW1lbnRzKAogICAgICAgICAgbm9ybWFsMi54LAogICAgICAgICAgbm9ybWFsMi55LAogICAgICAgICAgbm9ybWFsMi56LAogICAgICAgICAgZGlzdGFuY2UsCiAgICAgICAgICBzY3JhdGNoUGxhbmVDYXJ0ZXNpYW40CiAgICAgICAgKTsKICAgICAgICBwbGFuZUFzQ2FydGVzaWFuNCA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgICAgaW52ZXJzZVRyYW5zcG9zZTIsCiAgICAgICAgICBwbGFuZUFzQ2FydGVzaWFuNCwKICAgICAgICAgIHBsYW5lQXNDYXJ0ZXNpYW40CiAgICAgICAgKTsKICAgICAgICBjb25zdCB0cmFuc2Zvcm1lZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuNCgKICAgICAgICAgIHBsYW5lQXNDYXJ0ZXNpYW40LAogICAgICAgICAgc2NyYXRjaFRyYW5zZm9ybU5vcm1hbAogICAgICAgICk7CiAgICAgICAgcGxhbmVBc0NhcnRlc2lhbjQgPSBDYXJ0ZXNpYW40X2RlZmF1bHQuZGl2aWRlQnlTY2FsYXIoCiAgICAgICAgICBwbGFuZUFzQ2FydGVzaWFuNCwKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUodHJhbnNmb3JtZWROb3JtYWwpLAogICAgICAgICAgcGxhbmVBc0NhcnRlc2lhbjQKICAgICAgICApOwogICAgICAgIHJldHVybiBQbGFuZS5mcm9tQ2FydGVzaWFuNChwbGFuZUFzQ2FydGVzaWFuNCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgUGxhbmUuY2xvbmUgPSBmdW5jdGlvbihwbGFuZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJwbGFuZSIsIHBsYW5lKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFBsYW5lKHBsYW5lLm5vcm1hbCwgcGxhbmUuZGlzdGFuY2UpOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocGxhbmUubm9ybWFsLCByZXN1bHQubm9ybWFsKTsKICAgICAgICByZXN1bHQuZGlzdGFuY2UgPSBwbGFuZS5kaXN0YW5jZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBQbGFuZS5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgcmV0dXJuIGxlZnQuZGlzdGFuY2UgPT09IHJpZ2h0LmRpc3RhbmNlICYmIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMobGVmdC5ub3JtYWwsIHJpZ2h0Lm5vcm1hbCk7CiAgICAgIH07CiAgICAgIFBsYW5lLk9SSUdJTl9YWV9QTEFORSA9IE9iamVjdC5mcmVlemUobmV3IFBsYW5lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osIDApKTsKICAgICAgUGxhbmUuT1JJR0lOX1laX1BMQU5FID0gT2JqZWN0LmZyZWV6ZShuZXcgUGxhbmUoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWCwgMCkpOwogICAgICBQbGFuZS5PUklHSU5fWlhfUExBTkUgPSBPYmplY3QuZnJlZXplKG5ldyBQbGFuZShDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZLCAwKSk7CiAgICAgIFBsYW5lX2RlZmF1bHQgPSBQbGFuZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RpcHNpZnkuanMKICB2YXIgVGlwc2lmeSwgVGlwc2lmeV9kZWZhdWx0OwogIHZhciBpbml0X1RpcHNpZnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RpcHNpZnkuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBUaXBzaWZ5ID0ge307CiAgICAgIFRpcHNpZnkuY2FsY3VsYXRlQUNNUiA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gb3B0aW9ucy5pbmRpY2VzOwogICAgICAgIGxldCBtYXhpbXVtSW5kZXggPSBvcHRpb25zLm1heGltdW1JbmRleDsKICAgICAgICBjb25zdCBjYWNoZVNpemUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNhY2hlU2l6ZSwgMjQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiaW5kaWNlcyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IGluZGljZXMubGVuZ3RoOwogICAgICAgIGlmIChudW1JbmRpY2VzIDwgMyB8fCBudW1JbmRpY2VzICUgMyAhPT0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImluZGljZXMgbGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiB0aHJlZS4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG1heGltdW1JbmRleCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgibWF4aW11bUluZGV4IG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICAgICAgfQogICAgICAgIGlmIChjYWNoZVNpemUgPCAzKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2FjaGVTaXplIG11c3QgYmUgZ3JlYXRlciB0aGFuIHR3by4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobWF4aW11bUluZGV4KSkgewogICAgICAgICAgbWF4aW11bUluZGV4ID0gMDsKICAgICAgICAgIGxldCBjdXJyZW50SW5kZXggPSAwOwogICAgICAgICAgbGV0IGludG9JbmRpY2VzID0gaW5kaWNlc1tjdXJyZW50SW5kZXhdOwogICAgICAgICAgd2hpbGUgKGN1cnJlbnRJbmRleCA8IG51bUluZGljZXMpIHsKICAgICAgICAgICAgaWYgKGludG9JbmRpY2VzID4gbWF4aW11bUluZGV4KSB7CiAgICAgICAgICAgICAgbWF4aW11bUluZGV4ID0gaW50b0luZGljZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKytjdXJyZW50SW5kZXg7CiAgICAgICAgICAgIGludG9JbmRpY2VzID0gaW5kaWNlc1tjdXJyZW50SW5kZXhdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCB2ZXJ0ZXhUaW1lU3RhbXBzID0gW107CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtYXhpbXVtSW5kZXggKyAxOyBpKyspIHsKICAgICAgICAgIHZlcnRleFRpbWVTdGFtcHNbaV0gPSAwOwogICAgICAgIH0KICAgICAgICBsZXQgcyA9IGNhY2hlU2l6ZSArIDE7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBudW1JbmRpY2VzOyArK2opIHsKICAgICAgICAgIGlmIChzIC0gdmVydGV4VGltZVN0YW1wc1tpbmRpY2VzW2pdXSA+IGNhY2hlU2l6ZSkgewogICAgICAgICAgICB2ZXJ0ZXhUaW1lU3RhbXBzW2luZGljZXNbal1dID0gczsKICAgICAgICAgICAgKytzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gKHMgLSBjYWNoZVNpemUgKyAxKSAvIChudW1JbmRpY2VzIC8gMyk7CiAgICAgIH07CiAgICAgIFRpcHNpZnkudGlwc2lmeSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gb3B0aW9ucy5pbmRpY2VzOwogICAgICAgIGNvbnN0IG1heGltdW1JbmRleCA9IG9wdGlvbnMubWF4aW11bUluZGV4OwogICAgICAgIGNvbnN0IGNhY2hlU2l6ZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY2FjaGVTaXplLCAyNCk7CiAgICAgICAgbGV0IGN1cnNvcjsKICAgICAgICBmdW5jdGlvbiBza2lwRGVhZEVuZCh2ZXJ0aWNlczIsIGRlYWRFbmQyLCBpbmRpY2VzMiwgbWF4aW11bUluZGV4UGx1c09uZTIpIHsKICAgICAgICAgIHdoaWxlIChkZWFkRW5kMi5sZW5ndGggPj0gMSkgewogICAgICAgICAgICBjb25zdCBkID0gZGVhZEVuZDJbZGVhZEVuZDIubGVuZ3RoIC0gMV07CiAgICAgICAgICAgIGRlYWRFbmQyLnNwbGljZShkZWFkRW5kMi5sZW5ndGggLSAxLCAxKTsKICAgICAgICAgICAgaWYgKHZlcnRpY2VzMltkXS5udW1MaXZlVHJpYW5nbGVzID4gMCkgewogICAgICAgICAgICAgIHJldHVybiBkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoY3Vyc29yIDwgbWF4aW11bUluZGV4UGx1c09uZTIpIHsKICAgICAgICAgICAgaWYgKHZlcnRpY2VzMltjdXJzb3JdLm51bUxpdmVUcmlhbmdsZXMgPiAwKSB7CiAgICAgICAgICAgICAgKytjdXJzb3I7CiAgICAgICAgICAgICAgcmV0dXJuIGN1cnNvciAtIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKytjdXJzb3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5leHRWZXJ0ZXgoaW5kaWNlczIsIGNhY2hlU2l6ZTIsIG9uZVJpbmcyLCB2ZXJ0aWNlczIsIHMyLCBkZWFkRW5kMiwgbWF4aW11bUluZGV4UGx1c09uZTIpIHsKICAgICAgICAgIGxldCBuID0gLTE7CiAgICAgICAgICBsZXQgcDsKICAgICAgICAgIGxldCBtID0gLTE7CiAgICAgICAgICBsZXQgaXRPbmVSaW5nID0gMDsKICAgICAgICAgIHdoaWxlIChpdE9uZVJpbmcgPCBvbmVSaW5nMi5sZW5ndGgpIHsKICAgICAgICAgICAgY29uc3QgaW5kZXgyID0gb25lUmluZzJbaXRPbmVSaW5nXTsKICAgICAgICAgICAgaWYgKHZlcnRpY2VzMltpbmRleDJdLm51bUxpdmVUcmlhbmdsZXMpIHsKICAgICAgICAgICAgICBwID0gMDsKICAgICAgICAgICAgICBpZiAoczIgLSB2ZXJ0aWNlczJbaW5kZXgyXS50aW1lU3RhbXAgKyAyICogdmVydGljZXMyW2luZGV4Ml0ubnVtTGl2ZVRyaWFuZ2xlcyA8PSBjYWNoZVNpemUyKSB7CiAgICAgICAgICAgICAgICBwID0gczIgLSB2ZXJ0aWNlczJbaW5kZXgyXS50aW1lU3RhbXA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwID4gbSB8fCBtID09PSAtMSkgewogICAgICAgICAgICAgICAgbSA9IHA7CiAgICAgICAgICAgICAgICBuID0gaW5kZXgyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICArK2l0T25lUmluZzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gc2tpcERlYWRFbmQodmVydGljZXMyLCBkZWFkRW5kMiwgaW5kaWNlczIsIG1heGltdW1JbmRleFBsdXNPbmUyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImluZGljZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG51bUluZGljZXMgPSBpbmRpY2VzLmxlbmd0aDsKICAgICAgICBpZiAobnVtSW5kaWNlcyA8IDMgfHwgbnVtSW5kaWNlcyAlIDMgIT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJpbmRpY2VzIGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgdGhyZWUuIik7CiAgICAgICAgfQogICAgICAgIGlmIChtYXhpbXVtSW5kZXggPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm1heGltdW1JbmRleCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoY2FjaGVTaXplIDwgMykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImNhY2hlU2l6ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB0d28uIik7CiAgICAgICAgfQogICAgICAgIGxldCBtYXhpbXVtSW5kZXhQbHVzT25lID0gMDsKICAgICAgICBsZXQgY3VycmVudEluZGV4ID0gMDsKICAgICAgICBsZXQgaW50b0luZGljZXMgPSBpbmRpY2VzW2N1cnJlbnRJbmRleF07CiAgICAgICAgY29uc3QgZW5kSW5kZXggPSBudW1JbmRpY2VzOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWF4aW11bUluZGV4KSkgewogICAgICAgICAgbWF4aW11bUluZGV4UGx1c09uZSA9IG1heGltdW1JbmRleCArIDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdoaWxlIChjdXJyZW50SW5kZXggPCBlbmRJbmRleCkgewogICAgICAgICAgICBpZiAoaW50b0luZGljZXMgPiBtYXhpbXVtSW5kZXhQbHVzT25lKSB7CiAgICAgICAgICAgICAgbWF4aW11bUluZGV4UGx1c09uZSA9IGludG9JbmRpY2VzOwogICAgICAgICAgICB9CiAgICAgICAgICAgICsrY3VycmVudEluZGV4OwogICAgICAgICAgICBpbnRvSW5kaWNlcyA9IGluZGljZXNbY3VycmVudEluZGV4XTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChtYXhpbXVtSW5kZXhQbHVzT25lID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgICsrbWF4aW11bUluZGV4UGx1c09uZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmVydGljZXMgPSBbXTsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbWF4aW11bUluZGV4UGx1c09uZTsgaSsrKSB7CiAgICAgICAgICB2ZXJ0aWNlc1tpXSA9IHsKICAgICAgICAgICAgbnVtTGl2ZVRyaWFuZ2xlczogMCwKICAgICAgICAgICAgdGltZVN0YW1wOiAwLAogICAgICAgICAgICB2ZXJ0ZXhUcmlhbmdsZXM6IFtdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBjdXJyZW50SW5kZXggPSAwOwogICAgICAgIGxldCB0cmlhbmdsZSA9IDA7CiAgICAgICAgd2hpbGUgKGN1cnJlbnRJbmRleCA8IGVuZEluZGV4KSB7CiAgICAgICAgICB2ZXJ0aWNlc1tpbmRpY2VzW2N1cnJlbnRJbmRleF1dLnZlcnRleFRyaWFuZ2xlcy5wdXNoKHRyaWFuZ2xlKTsKICAgICAgICAgICsrdmVydGljZXNbaW5kaWNlc1tjdXJyZW50SW5kZXhdXS5udW1MaXZlVHJpYW5nbGVzOwogICAgICAgICAgdmVydGljZXNbaW5kaWNlc1tjdXJyZW50SW5kZXggKyAxXV0udmVydGV4VHJpYW5nbGVzLnB1c2godHJpYW5nbGUpOwogICAgICAgICAgKyt2ZXJ0aWNlc1tpbmRpY2VzW2N1cnJlbnRJbmRleCArIDFdXS5udW1MaXZlVHJpYW5nbGVzOwogICAgICAgICAgdmVydGljZXNbaW5kaWNlc1tjdXJyZW50SW5kZXggKyAyXV0udmVydGV4VHJpYW5nbGVzLnB1c2godHJpYW5nbGUpOwogICAgICAgICAgKyt2ZXJ0aWNlc1tpbmRpY2VzW2N1cnJlbnRJbmRleCArIDJdXS5udW1MaXZlVHJpYW5nbGVzOwogICAgICAgICAgKyt0cmlhbmdsZTsKICAgICAgICAgIGN1cnJlbnRJbmRleCArPSAzOwogICAgICAgIH0KICAgICAgICBsZXQgZiA9IDA7CiAgICAgICAgbGV0IHMgPSBjYWNoZVNpemUgKyAxOwogICAgICAgIGN1cnNvciA9IDE7CiAgICAgICAgbGV0IG9uZVJpbmcgPSBbXTsKICAgICAgICBjb25zdCBkZWFkRW5kID0gW107CiAgICAgICAgbGV0IHZlcnRleDsKICAgICAgICBsZXQgaW50b1ZlcnRpY2VzOwogICAgICAgIGxldCBjdXJyZW50T3V0cHV0SW5kZXggPSAwOwogICAgICAgIGNvbnN0IG91dHB1dEluZGljZXMgPSBbXTsKICAgICAgICBjb25zdCBudW1UcmlhbmdsZXMgPSBudW1JbmRpY2VzIC8gMzsKICAgICAgICBjb25zdCB0cmlhbmdsZUVtaXR0ZWQgPSBbXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtVHJpYW5nbGVzOyBpKyspIHsKICAgICAgICAgIHRyaWFuZ2xlRW1pdHRlZFtpXSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBsZXQgaW5kZXg7CiAgICAgICAgbGV0IGxpbWl0OwogICAgICAgIHdoaWxlIChmICE9PSAtMSkgewogICAgICAgICAgb25lUmluZyA9IFtdOwogICAgICAgICAgaW50b1ZlcnRpY2VzID0gdmVydGljZXNbZl07CiAgICAgICAgICBsaW1pdCA9IGludG9WZXJ0aWNlcy52ZXJ0ZXhUcmlhbmdsZXMubGVuZ3RoOwogICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBsaW1pdDsgKytrKSB7CiAgICAgICAgICAgIHRyaWFuZ2xlID0gaW50b1ZlcnRpY2VzLnZlcnRleFRyaWFuZ2xlc1trXTsKICAgICAgICAgICAgaWYgKCF0cmlhbmdsZUVtaXR0ZWRbdHJpYW5nbGVdKSB7CiAgICAgICAgICAgICAgdHJpYW5nbGVFbWl0dGVkW3RyaWFuZ2xlXSA9IHRydWU7CiAgICAgICAgICAgICAgY3VycmVudEluZGV4ID0gdHJpYW5nbGUgKyB0cmlhbmdsZSArIHRyaWFuZ2xlOwogICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMzsgKytqKSB7CiAgICAgICAgICAgICAgICBpbmRleCA9IGluZGljZXNbY3VycmVudEluZGV4XTsKICAgICAgICAgICAgICAgIG9uZVJpbmcucHVzaChpbmRleCk7CiAgICAgICAgICAgICAgICBkZWFkRW5kLnB1c2goaW5kZXgpOwogICAgICAgICAgICAgICAgb3V0cHV0SW5kaWNlc1tjdXJyZW50T3V0cHV0SW5kZXhdID0gaW5kZXg7CiAgICAgICAgICAgICAgICArK2N1cnJlbnRPdXRwdXRJbmRleDsKICAgICAgICAgICAgICAgIHZlcnRleCA9IHZlcnRpY2VzW2luZGV4XTsKICAgICAgICAgICAgICAgIC0tdmVydGV4Lm51bUxpdmVUcmlhbmdsZXM7CiAgICAgICAgICAgICAgICBpZiAocyAtIHZlcnRleC50aW1lU3RhbXAgPiBjYWNoZVNpemUpIHsKICAgICAgICAgICAgICAgICAgdmVydGV4LnRpbWVTdGFtcCA9IHM7CiAgICAgICAgICAgICAgICAgICsrczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICsrY3VycmVudEluZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZiA9IGdldE5leHRWZXJ0ZXgoCiAgICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAgIGNhY2hlU2l6ZSwKICAgICAgICAgICAgb25lUmluZywKICAgICAgICAgICAgdmVydGljZXMsCiAgICAgICAgICAgIHMsCiAgICAgICAgICAgIGRlYWRFbmQsCiAgICAgICAgICAgIG1heGltdW1JbmRleFBsdXNPbmUKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvdXRwdXRJbmRpY2VzOwogICAgICB9OwogICAgICBUaXBzaWZ5X2RlZmF1bHQgPSBUaXBzaWZ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlQaXBlbGluZS5qcwogIGZ1bmN0aW9uIGFkZFRyaWFuZ2xlKGxpbmVzLCBpbmRleCwgaTAsIGkxLCBpMikgewogICAgbGluZXNbaW5kZXgrK10gPSBpMDsKICAgIGxpbmVzW2luZGV4KytdID0gaTE7CiAgICBsaW5lc1tpbmRleCsrXSA9IGkxOwogICAgbGluZXNbaW5kZXgrK10gPSBpMjsKICAgIGxpbmVzW2luZGV4KytdID0gaTI7CiAgICBsaW5lc1tpbmRleF0gPSBpMDsKICB9CiAgZnVuY3Rpb24gdHJpYW5nbGVzVG9MaW5lcyh0cmlhbmdsZXMpIHsKICAgIGNvbnN0IGNvdW50ID0gdHJpYW5nbGVzLmxlbmd0aDsKICAgIGNvbnN0IHNpemUgPSBjb3VudCAvIDMgKiA2OwogICAgY29uc3QgbGluZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShjb3VudCwgc2l6ZSk7CiAgICBsZXQgaW5kZXggPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSArPSAzLCBpbmRleCArPSA2KSB7CiAgICAgIGFkZFRyaWFuZ2xlKGxpbmVzLCBpbmRleCwgdHJpYW5nbGVzW2ldLCB0cmlhbmdsZXNbaSArIDFdLCB0cmlhbmdsZXNbaSArIDJdKTsKICAgIH0KICAgIHJldHVybiBsaW5lczsKICB9CiAgZnVuY3Rpb24gdHJpYW5nbGVTdHJpcFRvTGluZXModHJpYW5nbGVzKSB7CiAgICBjb25zdCBjb3VudCA9IHRyaWFuZ2xlcy5sZW5ndGg7CiAgICBpZiAoY291bnQgPj0gMykgewogICAgICBjb25zdCBzaXplID0gKGNvdW50IC0gMikgKiA2OwogICAgICBjb25zdCBsaW5lcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KGNvdW50LCBzaXplKTsKICAgICAgYWRkVHJpYW5nbGUobGluZXMsIDAsIHRyaWFuZ2xlc1swXSwgdHJpYW5nbGVzWzFdLCB0cmlhbmdsZXNbMl0pOwogICAgICBsZXQgaW5kZXggPSA2OwogICAgICBmb3IgKGxldCBpID0gMzsgaSA8IGNvdW50OyArK2ksIGluZGV4ICs9IDYpIHsKICAgICAgICBhZGRUcmlhbmdsZSgKICAgICAgICAgIGxpbmVzLAogICAgICAgICAgaW5kZXgsCiAgICAgICAgICB0cmlhbmdsZXNbaSAtIDFdLAogICAgICAgICAgdHJpYW5nbGVzW2ldLAogICAgICAgICAgdHJpYW5nbGVzW2kgLSAyXQogICAgICAgICk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpbmVzOwogICAgfQogICAgcmV0dXJuIG5ldyBVaW50MTZBcnJheSgpOwogIH0KICBmdW5jdGlvbiB0cmlhbmdsZUZhblRvTGluZXModHJpYW5nbGVzKSB7CiAgICBpZiAodHJpYW5nbGVzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgY291bnQgPSB0cmlhbmdsZXMubGVuZ3RoIC0gMTsKICAgICAgY29uc3Qgc2l6ZSA9IChjb3VudCAtIDEpICogNjsKICAgICAgY29uc3QgbGluZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShjb3VudCwgc2l6ZSk7CiAgICAgIGNvbnN0IGJhc2UgPSB0cmlhbmdsZXNbMF07CiAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgY291bnQ7ICsraSwgaW5kZXggKz0gNikgewogICAgICAgIGFkZFRyaWFuZ2xlKGxpbmVzLCBpbmRleCwgYmFzZSwgdHJpYW5nbGVzW2ldLCB0cmlhbmdsZXNbaSArIDFdKTsKICAgICAgfQogICAgICByZXR1cm4gbGluZXM7CiAgICB9CiAgICByZXR1cm4gbmV3IFVpbnQxNkFycmF5KCk7CiAgfQogIGZ1bmN0aW9uIGNvcHlBdHRyaWJ1dGVzRGVzY3JpcHRpb25zKGF0dHJpYnV0ZXMpIHsKICAgIGNvbnN0IG5ld0F0dHJpYnV0ZXMgPSB7fTsKICAgIGZvciAoY29uc3QgYXR0cmlidXRlIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkoYXR0cmlidXRlKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1thdHRyaWJ1dGVdKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1thdHRyaWJ1dGVdLnZhbHVlcykpIHsKICAgICAgICBjb25zdCBhdHRyID0gYXR0cmlidXRlc1thdHRyaWJ1dGVdOwogICAgICAgIG5ld0F0dHJpYnV0ZXNbYXR0cmlidXRlXSA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBhdHRyLmNvbXBvbmVudERhdGF0eXBlLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogYXR0ci5jb21wb25lbnRzUGVyQXR0cmlidXRlLAogICAgICAgICAgbm9ybWFsaXplOiBhdHRyLm5vcm1hbGl6ZSwKICAgICAgICAgIHZhbHVlczogW10KICAgICAgICB9KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG5ld0F0dHJpYnV0ZXM7CiAgfQogIGZ1bmN0aW9uIGNvcHlWZXJ0ZXgoZGVzdGluYXRpb25BdHRyaWJ1dGVzLCBzb3VyY2VBdHRyaWJ1dGVzLCBpbmRleCkgewogICAgZm9yIChjb25zdCBhdHRyaWJ1dGUgaW4gc291cmNlQXR0cmlidXRlcykgewogICAgICBpZiAoc291cmNlQXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShhdHRyaWJ1dGUpICYmIGRlZmluZWRfZGVmYXVsdChzb3VyY2VBdHRyaWJ1dGVzW2F0dHJpYnV0ZV0pICYmIGRlZmluZWRfZGVmYXVsdChzb3VyY2VBdHRyaWJ1dGVzW2F0dHJpYnV0ZV0udmFsdWVzKSkgewogICAgICAgIGNvbnN0IGF0dHIgPSBzb3VyY2VBdHRyaWJ1dGVzW2F0dHJpYnV0ZV07CiAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBhdHRyLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGU7ICsraykgewogICAgICAgICAgZGVzdGluYXRpb25BdHRyaWJ1dGVzW2F0dHJpYnV0ZV0udmFsdWVzLnB1c2goCiAgICAgICAgICAgIGF0dHIudmFsdWVzW2luZGV4ICogYXR0ci5jb21wb25lbnRzUGVyQXR0cmlidXRlICsga10KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyYW5zZm9ybVBvaW50KG1hdHJpeCwgYXR0cmlidXRlKSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZSkpIHsKICAgICAgY29uc3QgdmFsdWVzID0gYXR0cmlidXRlLnZhbHVlczsKICAgICAgY29uc3QgbGVuZ3RoID0gdmFsdWVzLmxlbmd0aDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2sodmFsdWVzLCBpLCBzY3JhdGNoQ2FydGVzaWFuMzMpOwogICAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQobWF0cml4LCBzY3JhdGNoQ2FydGVzaWFuMzMsIHNjcmF0Y2hDYXJ0ZXNpYW4zMyk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soc2NyYXRjaENhcnRlc2lhbjMzLCB2YWx1ZXMsIGkpOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyYW5zZm9ybVZlY3RvcihtYXRyaXgsIGF0dHJpYnV0ZSkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGUpKSB7CiAgICAgIGNvbnN0IHZhbHVlcyA9IGF0dHJpYnV0ZS52YWx1ZXM7CiAgICAgIGNvbnN0IGxlbmd0aCA9IHZhbHVlcy5sZW5ndGg7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHZhbHVlcywgaSwgc2NyYXRjaENhcnRlc2lhbjMzKTsKICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcihtYXRyaXgsIHNjcmF0Y2hDYXJ0ZXNpYW4zMywgc2NyYXRjaENhcnRlc2lhbjMzKTsKICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMzMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjMzLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjMzCiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhzY3JhdGNoQ2FydGVzaWFuMzMsIHZhbHVlcywgaSk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZmluZEF0dHJpYnV0ZXNJbkFsbEdlb21ldHJpZXMoaW5zdGFuY2VzLCBwcm9wZXJ0eU5hbWUpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBjb25zdCBhdHRyaWJ1dGVzSW5BbGxHZW9tZXRyaWVzID0ge307CiAgICBjb25zdCBhdHRyaWJ1dGVzMCA9IGluc3RhbmNlc1swXVtwcm9wZXJ0eU5hbWVdLmF0dHJpYnV0ZXM7CiAgICBsZXQgbmFtZTsKICAgIGZvciAobmFtZSBpbiBhdHRyaWJ1dGVzMCkgewogICAgICBpZiAoYXR0cmlidXRlczAuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMwW25hbWVdKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlczBbbmFtZV0udmFsdWVzKSkgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXMwW25hbWVdOwogICAgICAgIGxldCBudW1iZXJPZkNvbXBvbmVudHMgPSBhdHRyaWJ1dGUudmFsdWVzLmxlbmd0aDsKICAgICAgICBsZXQgaW5BbGxHZW9tZXRyaWVzID0gdHJ1ZTsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjb25zdCBvdGhlckF0dHJpYnV0ZSA9IGluc3RhbmNlc1tpXVtwcm9wZXJ0eU5hbWVdLmF0dHJpYnV0ZXNbbmFtZV07CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvdGhlckF0dHJpYnV0ZSkgfHwgYXR0cmlidXRlLmNvbXBvbmVudERhdGF0eXBlICE9PSBvdGhlckF0dHJpYnV0ZS5jb21wb25lbnREYXRhdHlwZSB8fCBhdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZSAhPT0gb3RoZXJBdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZSB8fCBhdHRyaWJ1dGUubm9ybWFsaXplICE9PSBvdGhlckF0dHJpYnV0ZS5ub3JtYWxpemUpIHsKICAgICAgICAgICAgaW5BbGxHZW9tZXRyaWVzID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgbnVtYmVyT2ZDb21wb25lbnRzICs9IG90aGVyQXR0cmlidXRlLnZhbHVlcy5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIGlmIChpbkFsbEdlb21ldHJpZXMpIHsKICAgICAgICAgIGF0dHJpYnV0ZXNJbkFsbEdlb21ldHJpZXNbbmFtZV0gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBhdHRyaWJ1dGUuY29tcG9uZW50RGF0YXR5cGUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IGF0dHJpYnV0ZS5jb21wb25lbnRzUGVyQXR0cmlidXRlLAogICAgICAgICAgICBub3JtYWxpemU6IGF0dHJpYnV0ZS5ub3JtYWxpemUsCiAgICAgICAgICAgIHZhbHVlczogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgICAgIGF0dHJpYnV0ZS5jb21wb25lbnREYXRhdHlwZSwKICAgICAgICAgICAgICBudW1iZXJPZkNvbXBvbmVudHMKICAgICAgICAgICAgKQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gYXR0cmlidXRlc0luQWxsR2VvbWV0cmllczsKICB9CiAgZnVuY3Rpb24gY29tYmluZUdlb21ldHJpZXMoaW5zdGFuY2VzLCBwcm9wZXJ0eU5hbWUpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGluc3RhbmNlcy5sZW5ndGg7CiAgICBsZXQgbmFtZTsKICAgIGxldCBpOwogICAgbGV0IGo7CiAgICBsZXQgazsKICAgIGNvbnN0IG0gPSBpbnN0YW5jZXNbMF0ubW9kZWxNYXRyaXg7CiAgICBjb25zdCBoYXZlSW5kaWNlcyA9IGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXNbMF1bcHJvcGVydHlOYW1lXS5pbmRpY2VzKTsKICAgIGNvbnN0IHByaW1pdGl2ZVR5cGUgPSBpbnN0YW5jZXNbMF1bcHJvcGVydHlOYW1lXS5wcmltaXRpdmVUeXBlOwogICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGlmICghTWF0cml4NF9kZWZhdWx0LmVxdWFscyhpbnN0YW5jZXNbaV0ubW9kZWxNYXRyaXgsIG0pKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIkFsbCBpbnN0YW5jZXMgbXVzdCBoYXZlIHRoZSBzYW1lIG1vZGVsTWF0cml4LiIpOwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2VzW2ldW3Byb3BlcnR5TmFtZV0uaW5kaWNlcykgIT09IGhhdmVJbmRpY2VzKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAiQWxsIGluc3RhbmNlIGdlb21ldHJpZXMgbXVzdCBoYXZlIGFuIGluZGljZXMgb3Igbm90IGhhdmUgb25lLiIKICAgICAgICApOwogICAgICB9CiAgICAgIGlmIChpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXS5wcmltaXRpdmVUeXBlICE9PSBwcmltaXRpdmVUeXBlKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAiQWxsIGluc3RhbmNlIGdlb21ldHJpZXMgbXVzdCBoYXZlIHRoZSBzYW1lIHByaW1pdGl2ZVR5cGUuIgogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBmaW5kQXR0cmlidXRlc0luQWxsR2VvbWV0cmllcyhpbnN0YW5jZXMsIHByb3BlcnR5TmFtZSk7CiAgICBsZXQgdmFsdWVzOwogICAgbGV0IHNvdXJjZVZhbHVlczsKICAgIGxldCBzb3VyY2VWYWx1ZXNMZW5ndGg7CiAgICBmb3IgKG5hbWUgaW4gYXR0cmlidXRlcykgewogICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgIHZhbHVlcyA9IGF0dHJpYnV0ZXNbbmFtZV0udmFsdWVzOwogICAgICAgIGsgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgc291cmNlVmFsdWVzID0gaW5zdGFuY2VzW2ldW3Byb3BlcnR5TmFtZV0uYXR0cmlidXRlc1tuYW1lXS52YWx1ZXM7CiAgICAgICAgICBzb3VyY2VWYWx1ZXNMZW5ndGggPSBzb3VyY2VWYWx1ZXMubGVuZ3RoOwogICAgICAgICAgZm9yIChqID0gMDsgaiA8IHNvdXJjZVZhbHVlc0xlbmd0aDsgKytqKSB7CiAgICAgICAgICAgIHZhbHVlc1trKytdID0gc291cmNlVmFsdWVzW2pdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgbGV0IGluZGljZXM7CiAgICBpZiAoaGF2ZUluZGljZXMpIHsKICAgICAgbGV0IG51bWJlck9mSW5kaWNlcyA9IDA7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIG51bWJlck9mSW5kaWNlcyArPSBpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXS5pbmRpY2VzLmxlbmd0aDsKICAgICAgfQogICAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcygKICAgICAgICBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlBPSU5UUwogICAgICAgIH0pCiAgICAgICk7CiAgICAgIGNvbnN0IGRlc3RJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgICAgbnVtYmVyT2ZWZXJ0aWNlcywKICAgICAgICBudW1iZXJPZkluZGljZXMKICAgICAgKTsKICAgICAgbGV0IGRlc3RPZmZzZXQgPSAwOwogICAgICBsZXQgb2Zmc2V0ID0gMDsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgY29uc3Qgc291cmNlSW5kaWNlcyA9IGluc3RhbmNlc1tpXVtwcm9wZXJ0eU5hbWVdLmluZGljZXM7CiAgICAgICAgY29uc3Qgc291cmNlSW5kaWNlc0xlbiA9IHNvdXJjZUluZGljZXMubGVuZ3RoOwogICAgICAgIGZvciAoayA9IDA7IGsgPCBzb3VyY2VJbmRpY2VzTGVuOyArK2spIHsKICAgICAgICAgIGRlc3RJbmRpY2VzW2Rlc3RPZmZzZXQrK10gPSBvZmZzZXQgKyBzb3VyY2VJbmRpY2VzW2tdOwogICAgICAgIH0KICAgICAgICBvZmZzZXQgKz0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXSk7CiAgICAgIH0KICAgICAgaW5kaWNlcyA9IGRlc3RJbmRpY2VzOwogICAgfQogICAgbGV0IGNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgIGxldCByYWRpdXMgPSAwOwogICAgbGV0IGJzOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGJzID0gaW5zdGFuY2VzW2ldW3Byb3BlcnR5TmFtZV0uYm91bmRpbmdTcGhlcmU7CiAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJzKSkgewogICAgICAgIGNlbnRlciA9IHZvaWQgMDsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGJzLmNlbnRlciwgY2VudGVyLCBjZW50ZXIpOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChjZW50ZXIpKSB7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kaXZpZGVCeVNjYWxhcihjZW50ZXIsIGxlbmd0aCwgY2VudGVyKTsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgYnMgPSBpbnN0YW5jZXNbaV1bcHJvcGVydHlOYW1lXS5ib3VuZGluZ1NwaGVyZTsKICAgICAgICBjb25zdCB0ZW1wUmFkaXVzID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChicy5jZW50ZXIsIGNlbnRlciwgdGVtcFNjcmF0Y2gpCiAgICAgICAgKSArIGJzLnJhZGl1czsKICAgICAgICBpZiAodGVtcFJhZGl1cyA+IHJhZGl1cykgewogICAgICAgICAgcmFkaXVzID0gdGVtcFJhZGl1czsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMsCiAgICAgIHByaW1pdGl2ZVR5cGUsCiAgICAgIGJvdW5kaW5nU3BoZXJlOiBkZWZpbmVkX2RlZmF1bHQoY2VudGVyKSA/IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KGNlbnRlciwgcmFkaXVzKSA6IHZvaWQgMAogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGluZGV4VHJpYW5nbGVzKGdlb21ldHJ5KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmluZGljZXMpKSB7CiAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgIH0KICAgIGNvbnN0IG51bWJlck9mVmVydGljZXMgPSBHZW9tZXRyeV9kZWZhdWx0LmNvbXB1dGVOdW1iZXJPZlZlcnRpY2VzKGdlb21ldHJ5KTsKICAgIGlmIChudW1iZXJPZlZlcnRpY2VzIDwgMykgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiVGhlIG51bWJlciBvZiB2ZXJ0aWNlcyBtdXN0IGJlIGF0IGxlYXN0IHRocmVlLiIpOwogICAgfQogICAgaWYgKG51bWJlck9mVmVydGljZXMgJSAzICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJUaGUgbnVtYmVyIG9mIHZlcnRpY2VzIG11c3QgYmUgYSBtdWx0aXBsZSBvZiB0aHJlZS4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG51bWJlck9mVmVydGljZXMsCiAgICAgIG51bWJlck9mVmVydGljZXMKICAgICk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bWJlck9mVmVydGljZXM7ICsraSkgewogICAgICBpbmRpY2VzW2ldID0gaTsKICAgIH0KICAgIGdlb21ldHJ5LmluZGljZXMgPSBpbmRpY2VzOwogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBpbmRleFRyaWFuZ2xlRmFuKGdlb21ldHJ5KSB7CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyA8IDMpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhdCBsZWFzdCB0aHJlZS4iKTsKICAgIH0KICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgbnVtYmVyT2ZWZXJ0aWNlcywKICAgICAgKG51bWJlck9mVmVydGljZXMgLSAyKSAqIDMKICAgICk7CiAgICBpbmRpY2VzWzBdID0gMTsKICAgIGluZGljZXNbMV0gPSAwOwogICAgaW5kaWNlc1syXSA9IDI7CiAgICBsZXQgaW5kaWNlc0luZGV4ID0gMzsKICAgIGZvciAobGV0IGkgPSAzOyBpIDwgbnVtYmVyT2ZWZXJ0aWNlczsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaSAtIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gMDsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpOwogICAgfQogICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXM7CiAgICBnZW9tZXRyeS5wcmltaXRpdmVUeXBlID0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUzsKICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gaW5kZXhUcmlhbmdsZVN0cmlwKGdlb21ldHJ5KSB7CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyA8IDMpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhdCBsZWFzdCAzLiIpOwogICAgfQogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBudW1iZXJPZlZlcnRpY2VzLAogICAgICAobnVtYmVyT2ZWZXJ0aWNlcyAtIDIpICogMwogICAgKTsKICAgIGluZGljZXNbMF0gPSAwOwogICAgaW5kaWNlc1sxXSA9IDE7CiAgICBpbmRpY2VzWzJdID0gMjsKICAgIGlmIChudW1iZXJPZlZlcnRpY2VzID4gMykgewogICAgICBpbmRpY2VzWzNdID0gMDsKICAgICAgaW5kaWNlc1s0XSA9IDI7CiAgICAgIGluZGljZXNbNV0gPSAzOwogICAgfQogICAgbGV0IGluZGljZXNJbmRleCA9IDY7CiAgICBmb3IgKGxldCBpID0gMzsgaSA8IG51bWJlck9mVmVydGljZXMgLSAxOyBpICs9IDIpIHsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkgLSAxOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkgKyAxOwogICAgICBpZiAoaSArIDIgPCBudW1iZXJPZlZlcnRpY2VzKSB7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpOwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaSArIDE7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpICsgMjsKICAgICAgfQogICAgfQogICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXM7CiAgICBnZW9tZXRyeS5wcmltaXRpdmVUeXBlID0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUzsKICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gaW5kZXhMaW5lcyhnZW9tZXRyeSkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5pbmRpY2VzKSkgewogICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICB9CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyA8IDIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhdCBsZWFzdCB0d28uIik7CiAgICB9CiAgICBpZiAobnVtYmVyT2ZWZXJ0aWNlcyAlIDIgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlRoZSBudW1iZXIgb2YgdmVydGljZXMgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDIuIik7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG51bWJlck9mVmVydGljZXMsCiAgICAgIG51bWJlck9mVmVydGljZXMKICAgICk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bWJlck9mVmVydGljZXM7ICsraSkgewogICAgICBpbmRpY2VzW2ldID0gaTsKICAgIH0KICAgIGdlb21ldHJ5LmluZGljZXMgPSBpbmRpY2VzOwogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBpbmRleExpbmVTdHJpcChnZW9tZXRyeSkgewogICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNlcyA9IEdlb21ldHJ5X2RlZmF1bHQuY29tcHV0ZU51bWJlck9mVmVydGljZXMoZ2VvbWV0cnkpOwogICAgaWYgKG51bWJlck9mVmVydGljZXMgPCAyKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJUaGUgbnVtYmVyIG9mIHZlcnRpY2VzIG11c3QgYmUgYXQgbGVhc3QgdHdvLiIpOwogICAgfQogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBudW1iZXJPZlZlcnRpY2VzLAogICAgICAobnVtYmVyT2ZWZXJ0aWNlcyAtIDEpICogMgogICAgKTsKICAgIGluZGljZXNbMF0gPSAwOwogICAgaW5kaWNlc1sxXSA9IDE7CiAgICBsZXQgaW5kaWNlc0luZGV4ID0gMjsKICAgIGZvciAobGV0IGkgPSAyOyBpIDwgbnVtYmVyT2ZWZXJ0aWNlczsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaSAtIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTsKICAgIH0KICAgIGdlb21ldHJ5LmluZGljZXMgPSBpbmRpY2VzOwogICAgZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSA9IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUzsKICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gaW5kZXhMaW5lTG9vcChnZW9tZXRyeSkgewogICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNlcyA9IEdlb21ldHJ5X2RlZmF1bHQuY29tcHV0ZU51bWJlck9mVmVydGljZXMoZ2VvbWV0cnkpOwogICAgaWYgKG51bWJlck9mVmVydGljZXMgPCAyKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJUaGUgbnVtYmVyIG9mIHZlcnRpY2VzIG11c3QgYmUgYXQgbGVhc3QgdHdvLiIpOwogICAgfQogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBudW1iZXJPZlZlcnRpY2VzLAogICAgICBudW1iZXJPZlZlcnRpY2VzICogMgogICAgKTsKICAgIGluZGljZXNbMF0gPSAwOwogICAgaW5kaWNlc1sxXSA9IDE7CiAgICBsZXQgaW5kaWNlc0luZGV4ID0gMjsKICAgIGZvciAobGV0IGkgPSAyOyBpIDwgbnVtYmVyT2ZWZXJ0aWNlczsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaSAtIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTsKICAgIH0KICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gbnVtYmVyT2ZWZXJ0aWNlcyAtIDE7CiAgICBpbmRpY2VzW2luZGljZXNJbmRleF0gPSAwOwogICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXM7CiAgICBnZW9tZXRyeS5wcmltaXRpdmVUeXBlID0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTOwogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBpbmRleFByaW1pdGl2ZShnZW9tZXRyeSkgewogICAgc3dpdGNoIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlKSB7CiAgICAgIGNhc2UgUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFX0ZBTjoKICAgICAgICByZXR1cm4gaW5kZXhUcmlhbmdsZUZhbihnZW9tZXRyeSk7CiAgICAgIGNhc2UgUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFX1NUUklQOgogICAgICAgIHJldHVybiBpbmRleFRyaWFuZ2xlU3RyaXAoZ2VvbWV0cnkpOwogICAgICBjYXNlIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVM6CiAgICAgICAgcmV0dXJuIGluZGV4VHJpYW5nbGVzKGdlb21ldHJ5KTsKICAgICAgY2FzZSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORV9TVFJJUDoKICAgICAgICByZXR1cm4gaW5kZXhMaW5lU3RyaXAoZ2VvbWV0cnkpOwogICAgICBjYXNlIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FX0xPT1A6CiAgICAgICAgcmV0dXJuIGluZGV4TGluZUxvb3AoZ2VvbWV0cnkpOwogICAgICBjYXNlIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUzoKICAgICAgICByZXR1cm4gaW5kZXhMaW5lcyhnZW9tZXRyeSk7CiAgICB9CiAgICByZXR1cm4gZ2VvbWV0cnk7CiAgfQogIGZ1bmN0aW9uIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocCwgaXNCZWhpbmQpIHsKICAgIGlmIChNYXRoLmFicyhwLnkpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgIGlmIChpc0JlaGluZCkgewogICAgICAgIHAueSA9IC1NYXRoX2RlZmF1bHQuRVBTSUxPTjY7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcC55ID0gTWF0aF9kZWZhdWx0LkVQU0lMT042OwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIG9mZnNldFRyaWFuZ2xlRnJvbVhaUGxhbmUocDAsIHAxLCBwMikgewogICAgaWYgKHAwLnkgIT09IDAgJiYgcDEueSAhPT0gMCAmJiBwMi55ICE9PSAwKSB7CiAgICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocDAsIHAwLnkgPCAwKTsKICAgICAgb2Zmc2V0UG9pbnRGcm9tWFpQbGFuZShwMSwgcDEueSA8IDApOwogICAgICBvZmZzZXRQb2ludEZyb21YWlBsYW5lKHAyLCBwMi55IDwgMCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHAweSA9IE1hdGguYWJzKHAwLnkpOwogICAgY29uc3QgcDF5ID0gTWF0aC5hYnMocDEueSk7CiAgICBjb25zdCBwMnkgPSBNYXRoLmFicyhwMi55KTsKICAgIGxldCBzaWduMjsKICAgIGlmIChwMHkgPiBwMXkpIHsKICAgICAgaWYgKHAweSA+IHAyeSkgewogICAgICAgIHNpZ24yID0gTWF0aF9kZWZhdWx0LnNpZ24ocDAueSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2lnbjIgPSBNYXRoX2RlZmF1bHQuc2lnbihwMi55KTsKICAgICAgfQogICAgfSBlbHNlIGlmIChwMXkgPiBwMnkpIHsKICAgICAgc2lnbjIgPSBNYXRoX2RlZmF1bHQuc2lnbihwMS55KTsKICAgIH0gZWxzZSB7CiAgICAgIHNpZ24yID0gTWF0aF9kZWZhdWx0LnNpZ24ocDIueSk7CiAgICB9CiAgICBjb25zdCBpc0JlaGluZCA9IHNpZ24yIDwgMDsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocDAsIGlzQmVoaW5kKTsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocDEsIGlzQmVoaW5kKTsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUocDIsIGlzQmVoaW5kKTsKICB9CiAgZnVuY3Rpb24gZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocCwgcDEsIHUxMiwgdjEyKSB7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICBwLAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDEsIHAsIGMzKSwKICAgICAgICBwLnkgLyAocC55IC0gcDEueSksCiAgICAgICAgYzMKICAgICAgKSwKICAgICAgdTEyCiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHUxMiwgdjEyKTsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUodTEyLCB0cnVlKTsKICAgIG9mZnNldFBvaW50RnJvbVhaUGxhbmUodjEyLCBmYWxzZSk7CiAgfQogIGZ1bmN0aW9uIHNwbGl0VHJpYW5nbGUocDAsIHAxLCBwMikgewogICAgaWYgKHAwLnggPj0gMCB8fCBwMS54ID49IDAgfHwgcDIueCA+PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBvZmZzZXRUcmlhbmdsZUZyb21YWlBsYW5lKHAwLCBwMSwgcDIpOwogICAgY29uc3QgcDBCZWhpbmQgPSBwMC55IDwgMDsKICAgIGNvbnN0IHAxQmVoaW5kID0gcDEueSA8IDA7CiAgICBjb25zdCBwMkJlaGluZCA9IHAyLnkgPCAwOwogICAgbGV0IG51bUJlaGluZCA9IDA7CiAgICBudW1CZWhpbmQgKz0gcDBCZWhpbmQgPyAxIDogMDsKICAgIG51bUJlaGluZCArPSBwMUJlaGluZCA/IDEgOiAwOwogICAgbnVtQmVoaW5kICs9IHAyQmVoaW5kID8gMSA6IDA7CiAgICBjb25zdCBpbmRpY2VzID0gc3BsaXRUcmlhbmdsZVJlc3VsdC5pbmRpY2VzOwogICAgaWYgKG51bUJlaGluZCA9PT0gMSkgewogICAgICBpbmRpY2VzWzFdID0gMzsKICAgICAgaW5kaWNlc1syXSA9IDQ7CiAgICAgIGluZGljZXNbNV0gPSA2OwogICAgICBpbmRpY2VzWzddID0gNjsKICAgICAgaW5kaWNlc1s4XSA9IDU7CiAgICAgIGlmIChwMEJlaGluZCkgewogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAwLCBwMSwgdTEsIHExKTsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMCwgcDIsIHUyLCBxMik7CiAgICAgICAgaW5kaWNlc1swXSA9IDA7CiAgICAgICAgaW5kaWNlc1szXSA9IDE7CiAgICAgICAgaW5kaWNlc1s0XSA9IDI7CiAgICAgICAgaW5kaWNlc1s2XSA9IDE7CiAgICAgIH0gZWxzZSBpZiAocDFCZWhpbmQpIHsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMSwgcDIsIHUxLCBxMSk7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDEsIHAwLCB1MiwgcTIpOwogICAgICAgIGluZGljZXNbMF0gPSAxOwogICAgICAgIGluZGljZXNbM10gPSAyOwogICAgICAgIGluZGljZXNbNF0gPSAwOwogICAgICAgIGluZGljZXNbNl0gPSAyOwogICAgICB9IGVsc2UgaWYgKHAyQmVoaW5kKSB7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDIsIHAwLCB1MSwgcTEpOwogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAyLCBwMSwgdTIsIHEyKTsKICAgICAgICBpbmRpY2VzWzBdID0gMjsKICAgICAgICBpbmRpY2VzWzNdID0gMDsKICAgICAgICBpbmRpY2VzWzRdID0gMTsKICAgICAgICBpbmRpY2VzWzZdID0gMDsKICAgICAgfQogICAgfSBlbHNlIGlmIChudW1CZWhpbmQgPT09IDIpIHsKICAgICAgaW5kaWNlc1syXSA9IDQ7CiAgICAgIGluZGljZXNbNF0gPSA0OwogICAgICBpbmRpY2VzWzVdID0gMzsKICAgICAgaW5kaWNlc1s3XSA9IDU7CiAgICAgIGluZGljZXNbOF0gPSA2OwogICAgICBpZiAoIXAwQmVoaW5kKSB7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDAsIHAxLCB1MSwgcTEpOwogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAwLCBwMiwgdTIsIHEyKTsKICAgICAgICBpbmRpY2VzWzBdID0gMTsKICAgICAgICBpbmRpY2VzWzFdID0gMjsKICAgICAgICBpbmRpY2VzWzNdID0gMTsKICAgICAgICBpbmRpY2VzWzZdID0gMDsKICAgICAgfSBlbHNlIGlmICghcDFCZWhpbmQpIHsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMSwgcDIsIHUxLCBxMSk7CiAgICAgICAgZ2V0WFpJbnRlcnNlY3Rpb25PZmZzZXRQb2ludHMocDEsIHAwLCB1MiwgcTIpOwogICAgICAgIGluZGljZXNbMF0gPSAyOwogICAgICAgIGluZGljZXNbMV0gPSAwOwogICAgICAgIGluZGljZXNbM10gPSAyOwogICAgICAgIGluZGljZXNbNl0gPSAxOwogICAgICB9IGVsc2UgaWYgKCFwMkJlaGluZCkgewogICAgICAgIGdldFhaSW50ZXJzZWN0aW9uT2Zmc2V0UG9pbnRzKHAyLCBwMCwgdTEsIHExKTsKICAgICAgICBnZXRYWkludGVyc2VjdGlvbk9mZnNldFBvaW50cyhwMiwgcDEsIHUyLCBxMik7CiAgICAgICAgaW5kaWNlc1swXSA9IDA7CiAgICAgICAgaW5kaWNlc1sxXSA9IDE7CiAgICAgICAgaW5kaWNlc1szXSA9IDA7CiAgICAgICAgaW5kaWNlc1s2XSA9IDI7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHBvc2l0aW9ucyA9IHNwbGl0VHJpYW5nbGVSZXN1bHQucG9zaXRpb25zOwogICAgcG9zaXRpb25zWzBdID0gcDA7CiAgICBwb3NpdGlvbnNbMV0gPSBwMTsKICAgIHBvc2l0aW9uc1syXSA9IHAyOwogICAgcG9zaXRpb25zLmxlbmd0aCA9IDM7CiAgICBpZiAobnVtQmVoaW5kID09PSAxIHx8IG51bUJlaGluZCA9PT0gMikgewogICAgICBwb3NpdGlvbnNbM10gPSB1MTsKICAgICAgcG9zaXRpb25zWzRdID0gdTI7CiAgICAgIHBvc2l0aW9uc1s1XSA9IHExOwogICAgICBwb3NpdGlvbnNbNl0gPSBxMjsKICAgICAgcG9zaXRpb25zLmxlbmd0aCA9IDc7CiAgICB9CiAgICByZXR1cm4gc3BsaXRUcmlhbmdsZVJlc3VsdDsKICB9CiAgZnVuY3Rpb24gdXBkYXRlR2VvbWV0cnlBZnRlclNwbGl0KGdlb21ldHJ5LCBjb21wdXRlQm91bmRpbmdTcGhlcmUpIHsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgaWYgKGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBhdHRyaWJ1dGVzKSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1twcm9wZXJ0eV0pICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzW3Byb3BlcnR5XS52YWx1ZXMpKSB7CiAgICAgICAgY29uc3QgYXR0cmlidXRlID0gYXR0cmlidXRlc1twcm9wZXJ0eV07CiAgICAgICAgYXR0cmlidXRlLnZhbHVlcyA9IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgICAgIGF0dHJpYnV0ZS5jb21wb25lbnREYXRhdHlwZSwKICAgICAgICAgIGF0dHJpYnV0ZS52YWx1ZXMKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICBjb25zdCBudW1iZXJPZlZlcnRpY2VzID0gR2VvbWV0cnlfZGVmYXVsdC5jb21wdXRlTnVtYmVyT2ZWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICBnZW9tZXRyeS5pbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIG51bWJlck9mVmVydGljZXMsCiAgICAgIGdlb21ldHJ5LmluZGljZXMKICAgICk7CiAgICBpZiAoY29tcHV0ZUJvdW5kaW5nU3BoZXJlKSB7CiAgICAgIGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMoCiAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBnZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gY29weUdlb21ldHJ5Rm9yU3BsaXQoZ2VvbWV0cnkpIHsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgY29uc3QgY29waWVkQXR0cmlidXRlcyA9IHt9OwogICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBhdHRyaWJ1dGVzKSB7CiAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1twcm9wZXJ0eV0pICYmIGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzW3Byb3BlcnR5XS52YWx1ZXMpKSB7CiAgICAgICAgY29uc3QgYXR0cmlidXRlID0gYXR0cmlidXRlc1twcm9wZXJ0eV07CiAgICAgICAgY29waWVkQXR0cmlidXRlc1twcm9wZXJ0eV0gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogYXR0cmlidXRlLmNvbXBvbmVudERhdGF0eXBlLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogYXR0cmlidXRlLmNvbXBvbmVudHNQZXJBdHRyaWJ1dGUsCiAgICAgICAgICBub3JtYWxpemU6IGF0dHJpYnV0ZS5ub3JtYWxpemUsCiAgICAgICAgICB2YWx1ZXM6IFtdCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXM6IGNvcGllZEF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXM6IFtdLAogICAgICBwcmltaXRpdmVUeXBlOiBnZW9tZXRyeS5wcmltaXRpdmVUeXBlCiAgICB9KTsKICB9CiAgZnVuY3Rpb24gdXBkYXRlSW5zdGFuY2VBZnRlclNwbGl0KGluc3RhbmNlLCB3ZXN0R2VvbWV0cnksIGVhc3RHZW9tZXRyeSkgewogICAgY29uc3QgY29tcHV0ZUJvdW5kaW5nU3BoZXJlID0gZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlLmdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlKTsKICAgIHdlc3RHZW9tZXRyeSA9IHVwZGF0ZUdlb21ldHJ5QWZ0ZXJTcGxpdCh3ZXN0R2VvbWV0cnksIGNvbXB1dGVCb3VuZGluZ1NwaGVyZSk7CiAgICBlYXN0R2VvbWV0cnkgPSB1cGRhdGVHZW9tZXRyeUFmdGVyU3BsaXQoZWFzdEdlb21ldHJ5LCBjb21wdXRlQm91bmRpbmdTcGhlcmUpOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChlYXN0R2VvbWV0cnkpICYmICFkZWZpbmVkX2RlZmF1bHQod2VzdEdlb21ldHJ5KSkgewogICAgICBpbnN0YW5jZS5nZW9tZXRyeSA9IGVhc3RHZW9tZXRyeTsKICAgIH0gZWxzZSBpZiAoIWRlZmluZWRfZGVmYXVsdChlYXN0R2VvbWV0cnkpICYmIGRlZmluZWRfZGVmYXVsdCh3ZXN0R2VvbWV0cnkpKSB7CiAgICAgIGluc3RhbmNlLmdlb21ldHJ5ID0gd2VzdEdlb21ldHJ5OwogICAgfSBlbHNlIHsKICAgICAgaW5zdGFuY2Uud2VzdEhlbWlzcGhlcmVHZW9tZXRyeSA9IHdlc3RHZW9tZXRyeTsKICAgICAgaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSA9IGVhc3RHZW9tZXRyeTsKICAgICAgaW5zdGFuY2UuZ2VvbWV0cnkgPSB2b2lkIDA7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdlbmVyYXRlQmFyeWNlbnRyaWNJbnRlcnBvbGF0ZUZ1bmN0aW9uKENhcnRlc2lhblR5cGUsIG51bWJlck9mQ29tcG9uZW50cykgewogICAgY29uc3QgdjBTY3JhdGNoID0gbmV3IENhcnRlc2lhblR5cGUoKTsKICAgIGNvbnN0IHYxU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuVHlwZSgpOwogICAgY29uc3QgdjJTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW5UeXBlKCk7CiAgICByZXR1cm4gZnVuY3Rpb24oaTAsIGkxLCBpMiwgY29vcmRzLCBzb3VyY2VWYWx1ZXMsIGN1cnJlbnRWYWx1ZXMsIGluc2VydGVkSW5kZXgsIG5vcm1hbGl6ZSkgewogICAgICBjb25zdCB2MDIgPSBDYXJ0ZXNpYW5UeXBlLmZyb21BcnJheSgKICAgICAgICBzb3VyY2VWYWx1ZXMsCiAgICAgICAgaTAgKiBudW1iZXJPZkNvbXBvbmVudHMsCiAgICAgICAgdjBTY3JhdGNoCiAgICAgICk7CiAgICAgIGNvbnN0IHYxMiA9IENhcnRlc2lhblR5cGUuZnJvbUFycmF5KAogICAgICAgIHNvdXJjZVZhbHVlcywKICAgICAgICBpMSAqIG51bWJlck9mQ29tcG9uZW50cywKICAgICAgICB2MVNjcmF0Y2gyCiAgICAgICk7CiAgICAgIGNvbnN0IHYyMiA9IENhcnRlc2lhblR5cGUuZnJvbUFycmF5KAogICAgICAgIHNvdXJjZVZhbHVlcywKICAgICAgICBpMiAqIG51bWJlck9mQ29tcG9uZW50cywKICAgICAgICB2MlNjcmF0Y2gyCiAgICAgICk7CiAgICAgIENhcnRlc2lhblR5cGUubXVsdGlwbHlCeVNjYWxhcih2MDIsIGNvb3Jkcy54LCB2MDIpOwogICAgICBDYXJ0ZXNpYW5UeXBlLm11bHRpcGx5QnlTY2FsYXIodjEyLCBjb29yZHMueSwgdjEyKTsKICAgICAgQ2FydGVzaWFuVHlwZS5tdWx0aXBseUJ5U2NhbGFyKHYyMiwgY29vcmRzLnosIHYyMik7CiAgICAgIGNvbnN0IHZhbHVlID0gQ2FydGVzaWFuVHlwZS5hZGQodjAyLCB2MTIsIHYwMik7CiAgICAgIENhcnRlc2lhblR5cGUuYWRkKHZhbHVlLCB2MjIsIHZhbHVlKTsKICAgICAgaWYgKG5vcm1hbGl6ZSkgewogICAgICAgIENhcnRlc2lhblR5cGUubm9ybWFsaXplKHZhbHVlLCB2YWx1ZSk7CiAgICAgIH0KICAgICAgQ2FydGVzaWFuVHlwZS5wYWNrKAogICAgICAgIHZhbHVlLAogICAgICAgIGN1cnJlbnRWYWx1ZXMsCiAgICAgICAgaW5zZXJ0ZWRJbmRleCAqIG51bWJlck9mQ29tcG9uZW50cwogICAgICApOwogICAgfTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVRyaWFuZ2xlQXR0cmlidXRlcyhpMCwgaTEsIGkyLCBwb2ludCwgcG9zaXRpb25zLCBub3JtYWxzLCB0YW5nZW50cywgYml0YW5nZW50cywgdGV4Q29vcmRzLCBleHRydWRlRGlyZWN0aW9ucywgYXBwbHlPZmZzZXQsIGN1cnJlbnRBdHRyaWJ1dGVzLCBjdXN0b21BdHRyaWJ1dGVOYW1lcywgY3VzdG9tQXR0cmlidXRlc0xlbmd0aCwgYWxsQXR0cmlidXRlcywgaW5zZXJ0ZWRJbmRleCkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobm9ybWFscykgJiYgIWRlZmluZWRfZGVmYXVsdCh0YW5nZW50cykgJiYgIWRlZmluZWRfZGVmYXVsdChiaXRhbmdlbnRzKSAmJiAhZGVmaW5lZF9kZWZhdWx0KHRleENvb3JkcykgJiYgIWRlZmluZWRfZGVmYXVsdChleHRydWRlRGlyZWN0aW9ucykgJiYgY3VzdG9tQXR0cmlidXRlc0xlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBwMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMCAqIDMsIHAwU2NyYXRjaCk7CiAgICBjb25zdCBwMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMSAqIDMsIHAxU2NyYXRjaCk7CiAgICBjb25zdCBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMiAqIDMsIHAyU2NyYXRjaCk7CiAgICBjb25zdCBjb29yZHMgPSBiYXJ5Y2VudHJpY0Nvb3JkaW5hdGVzX2RlZmF1bHQocG9pbnQsIHAwLCBwMSwgcDIsIGJhcnljZW50cmljU2NyYXRjaCk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb29yZHMpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobm9ybWFscykpIHsKICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQ2FydGVzaWFuMygKICAgICAgICBpMCwKICAgICAgICBpMSwKICAgICAgICBpMiwKICAgICAgICBjb29yZHMsCiAgICAgICAgbm9ybWFscywKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5ub3JtYWwudmFsdWVzLAogICAgICAgIGluc2VydGVkSW5kZXgsCiAgICAgICAgdHJ1ZQogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChleHRydWRlRGlyZWN0aW9ucykpIHsKICAgICAgY29uc3QgZDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGV4dHJ1ZGVEaXJlY3Rpb25zLCBpMCAqIDMsIHAwU2NyYXRjaCk7CiAgICAgIGNvbnN0IGQxID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShleHRydWRlRGlyZWN0aW9ucywgaTEgKiAzLCBwMVNjcmF0Y2gpOwogICAgICBjb25zdCBkMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZXh0cnVkZURpcmVjdGlvbnMsIGkyICogMywgcDJTY3JhdGNoKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZDAsIGNvb3Jkcy54LCBkMCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGQxLCBjb29yZHMueSwgZDEpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkMiwgY29vcmRzLnosIGQyKTsKICAgICAgbGV0IGRpcmVjdGlvbjI7CiAgICAgIGlmICghQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhkMCwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pIHx8ICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGQxLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykgfHwgIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMoZDIsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICAgIGRpcmVjdGlvbjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGQwLCBkMSwgZDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZGlyZWN0aW9uMiwgZDIsIGRpcmVjdGlvbjIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZGlyZWN0aW9uMiwgZGlyZWN0aW9uMik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGlyZWN0aW9uMiA9IHAwU2NyYXRjaDsKICAgICAgICBkaXJlY3Rpb24yLnggPSAwOwogICAgICAgIGRpcmVjdGlvbjIueSA9IDA7CiAgICAgICAgZGlyZWN0aW9uMi56ID0gMDsKICAgICAgfQogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjaygKICAgICAgICBkaXJlY3Rpb24yLAogICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLmV4dHJ1ZGVEaXJlY3Rpb24udmFsdWVzLAogICAgICAgIGluc2VydGVkSW5kZXggKiAzCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGFwcGx5T2Zmc2V0KSkgewogICAgICBpbnRlcnBvbGF0ZUFuZFBhY2tCb29sZWFuKAogICAgICAgIGkwLAogICAgICAgIGkxLAogICAgICAgIGkyLAogICAgICAgIGNvb3JkcywKICAgICAgICBhcHBseU9mZnNldCwKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5hcHBseU9mZnNldC52YWx1ZXMsCiAgICAgICAgaW5zZXJ0ZWRJbmRleAogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0YW5nZW50cykpIHsKICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQ2FydGVzaWFuMygKICAgICAgICBpMCwKICAgICAgICBpMSwKICAgICAgICBpMiwKICAgICAgICBjb29yZHMsCiAgICAgICAgdGFuZ2VudHMsCiAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMudGFuZ2VudC52YWx1ZXMsCiAgICAgICAgaW5zZXJ0ZWRJbmRleCwKICAgICAgICB0cnVlCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJpdGFuZ2VudHMpKSB7CiAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjMoCiAgICAgICAgaTAsCiAgICAgICAgaTEsCiAgICAgICAgaTIsCiAgICAgICAgY29vcmRzLAogICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMuYml0YW5nZW50LnZhbHVlcywKICAgICAgICBpbnNlcnRlZEluZGV4LAogICAgICAgIHRydWUKICAgICAgKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGV4Q29vcmRzKSkgewogICAgICBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4yKAogICAgICAgIGkwLAogICAgICAgIGkxLAogICAgICAgIGkyLAogICAgICAgIGNvb3JkcywKICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMuc3QudmFsdWVzLAogICAgICAgIGluc2VydGVkSW5kZXgKICAgICAgKTsKICAgIH0KICAgIGlmIChjdXN0b21BdHRyaWJ1dGVzTGVuZ3RoID4gMCkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZU5hbWUgPSBjdXN0b21BdHRyaWJ1dGVOYW1lc1tpXTsKICAgICAgICBnZW5lcmljSW50ZXJwb2xhdGUoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBjb29yZHMsCiAgICAgICAgICBpbnNlcnRlZEluZGV4LAogICAgICAgICAgYWxsQXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXSwKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdCiAgICAgICAgKTsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBnZW5lcmljSW50ZXJwb2xhdGUoaTAsIGkxLCBpMiwgY29vcmRzLCBpbnNlcnRlZEluZGV4LCBzb3VyY2VBdHRyaWJ1dGUsIGN1cnJlbnRBdHRyaWJ1dGUpIHsKICAgIGNvbnN0IGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgPSBzb3VyY2VBdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZTsKICAgIGNvbnN0IHNvdXJjZVZhbHVlcyA9IHNvdXJjZUF0dHJpYnV0ZS52YWx1ZXM7CiAgICBjb25zdCBjdXJyZW50VmFsdWVzID0gY3VycmVudEF0dHJpYnV0ZS52YWx1ZXM7CiAgICBzd2l0Y2ggKGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUpIHsKICAgICAgY2FzZSA0OgogICAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjQoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBjb29yZHMsCiAgICAgICAgICBzb3VyY2VWYWx1ZXMsCiAgICAgICAgICBjdXJyZW50VmFsdWVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleCwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAzOgogICAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBjb29yZHMsCiAgICAgICAgICBzb3VyY2VWYWx1ZXMsCiAgICAgICAgICBjdXJyZW50VmFsdWVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleCwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjIoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBjb29yZHMsCiAgICAgICAgICBzb3VyY2VWYWx1ZXMsCiAgICAgICAgICBjdXJyZW50VmFsdWVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleCwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBjdXJyZW50VmFsdWVzW2luc2VydGVkSW5kZXhdID0gc291cmNlVmFsdWVzW2kwXSAqIGNvb3Jkcy54ICsgc291cmNlVmFsdWVzW2kxXSAqIGNvb3Jkcy55ICsgc291cmNlVmFsdWVzW2kyXSAqIGNvb3Jkcy56OwogICAgfQogIH0KICBmdW5jdGlvbiBpbnNlcnRTcGxpdFBvaW50KGN1cnJlbnRBdHRyaWJ1dGVzLCBjdXJyZW50SW5kaWNlcywgY3VycmVudEluZGV4TWFwLCBpbmRpY2VzLCBjdXJyZW50SW5kZXgsIHBvaW50KSB7CiAgICBjb25zdCBpbnNlcnRJbmRleCA9IGN1cnJlbnRBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzOwogICAgaWYgKGN1cnJlbnRJbmRleCAhPT0gLTEpIHsKICAgICAgY29uc3QgcHJldkluZGV4ID0gaW5kaWNlc1tjdXJyZW50SW5kZXhdOwogICAgICBjb25zdCBuZXdJbmRleCA9IGN1cnJlbnRJbmRleE1hcFtwcmV2SW5kZXhdOwogICAgICBpZiAobmV3SW5kZXggPT09IC0xKSB7CiAgICAgICAgY3VycmVudEluZGV4TWFwW3ByZXZJbmRleF0gPSBpbnNlcnRJbmRleDsKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwb2ludC54LCBwb2ludC55LCBwb2ludC56KTsKICAgICAgICBjdXJyZW50SW5kaWNlcy5wdXNoKGluc2VydEluZGV4KTsKICAgICAgICByZXR1cm4gaW5zZXJ0SW5kZXg7CiAgICAgIH0KICAgICAgY3VycmVudEluZGljZXMucHVzaChuZXdJbmRleCk7CiAgICAgIHJldHVybiBuZXdJbmRleDsKICAgIH0KICAgIGN1cnJlbnRBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKHBvaW50LngsIHBvaW50LnksIHBvaW50LnopOwogICAgY3VycmVudEluZGljZXMucHVzaChpbnNlcnRJbmRleCk7CiAgICByZXR1cm4gaW5zZXJ0SW5kZXg7CiAgfQogIGZ1bmN0aW9uIHNwbGl0TG9uZ2l0dWRlVHJpYW5nbGVzKGluc3RhbmNlKSB7CiAgICBjb25zdCBnZW9tZXRyeSA9IGluc3RhbmNlLmdlb21ldHJ5OwogICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IG5vcm1hbHMgPSBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5ub3JtYWwpID8gYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzIDogdm9pZCAwOwogICAgY29uc3QgYml0YW5nZW50cyA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLmJpdGFuZ2VudCkgPyBhdHRyaWJ1dGVzLmJpdGFuZ2VudC52YWx1ZXMgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnRhbmdlbnQpID8gYXR0cmlidXRlcy50YW5nZW50LnZhbHVlcyA6IHZvaWQgMDsKICAgIGNvbnN0IHRleENvb3JkcyA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnN0KSA/IGF0dHJpYnV0ZXMuc3QudmFsdWVzIDogdm9pZCAwOwogICAgY29uc3QgZXh0cnVkZURpcmVjdGlvbnMgPSBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uKSA/IGF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbi52YWx1ZXMgOiB2b2lkIDA7CiAgICBjb25zdCBhcHBseU9mZnNldCA9IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0KSA/IGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQudmFsdWVzIDogdm9pZCAwOwogICAgY29uc3QgaW5kaWNlcyA9IGdlb21ldHJ5LmluZGljZXM7CiAgICBjb25zdCBjdXN0b21BdHRyaWJ1dGVOYW1lcyA9IFtdOwogICAgZm9yIChjb25zdCBhdHRyaWJ1dGVOYW1lIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkoYXR0cmlidXRlTmFtZSkgJiYgIU5BTUVEX0FUVFJJQlVURVNbYXR0cmlidXRlTmFtZV0gJiYgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICAgICAgY3VzdG9tQXR0cmlidXRlTmFtZXMucHVzaChhdHRyaWJ1dGVOYW1lKTsKICAgICAgfQogICAgfQogICAgY29uc3QgY3VzdG9tQXR0cmlidXRlc0xlbmd0aCA9IGN1c3RvbUF0dHJpYnV0ZU5hbWVzLmxlbmd0aDsKICAgIGNvbnN0IGVhc3RHZW9tZXRyeSA9IGNvcHlHZW9tZXRyeUZvclNwbGl0KGdlb21ldHJ5KTsKICAgIGNvbnN0IHdlc3RHZW9tZXRyeSA9IGNvcHlHZW9tZXRyeUZvclNwbGl0KGdlb21ldHJ5KTsKICAgIGxldCBjdXJyZW50QXR0cmlidXRlczsKICAgIGxldCBjdXJyZW50SW5kaWNlczsKICAgIGxldCBjdXJyZW50SW5kZXhNYXA7CiAgICBsZXQgaW5zZXJ0ZWRJbmRleDsKICAgIGxldCBpOwogICAgY29uc3Qgd2VzdEdlb21ldHJ5SW5kZXhNYXAgPSBbXTsKICAgIHdlc3RHZW9tZXRyeUluZGV4TWFwLmxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3QgZWFzdEdlb21ldHJ5SW5kZXhNYXAgPSBbXTsKICAgIGVhc3RHZW9tZXRyeUluZGV4TWFwLmxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgZm9yIChpID0gMDsgaSA8IHdlc3RHZW9tZXRyeUluZGV4TWFwLmxlbmd0aDsgKytpKSB7CiAgICAgIHdlc3RHZW9tZXRyeUluZGV4TWFwW2ldID0gLTE7CiAgICAgIGVhc3RHZW9tZXRyeUluZGV4TWFwW2ldID0gLTE7CiAgICB9CiAgICBjb25zdCBsZW4gPSBpbmRpY2VzLmxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkgKz0gMykgewogICAgICBjb25zdCBpMCA9IGluZGljZXNbaV07CiAgICAgIGNvbnN0IGkxID0gaW5kaWNlc1tpICsgMV07CiAgICAgIGNvbnN0IGkyID0gaW5kaWNlc1tpICsgMl07CiAgICAgIGxldCBwMCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMCAqIDMpOwogICAgICBsZXQgcDEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaTEgKiAzKTsKICAgICAgbGV0IHAyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGkyICogMyk7CiAgICAgIGNvbnN0IHJlc3VsdCA9IHNwbGl0VHJpYW5nbGUocDAsIHAxLCBwMik7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSAmJiByZXN1bHQucG9zaXRpb25zLmxlbmd0aCA+IDMpIHsKICAgICAgICBjb25zdCByZXN1bHRQb3NpdGlvbnMgPSByZXN1bHQucG9zaXRpb25zOwogICAgICAgIGNvbnN0IHJlc3VsdEluZGljZXMgPSByZXN1bHQuaW5kaWNlczsKICAgICAgICBjb25zdCByZXN1bHRMZW5ndGggPSByZXN1bHRJbmRpY2VzLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3VsdExlbmd0aDsgKytqKSB7CiAgICAgICAgICBjb25zdCByZXN1bHRJbmRleCA9IHJlc3VsdEluZGljZXNbal07CiAgICAgICAgICBjb25zdCBwb2ludCA9IHJlc3VsdFBvc2l0aW9uc1tyZXN1bHRJbmRleF07CiAgICAgICAgICBpZiAocG9pbnQueSA8IDApIHsKICAgICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgICAgY3VycmVudEluZGljZXMgPSB3ZXN0R2VvbWV0cnkuaW5kaWNlczsKICAgICAgICAgICAgY3VycmVudEluZGV4TWFwID0gd2VzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcyA9IGVhc3RHZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgICBjdXJyZW50SW5kZXhNYXAgPSBlYXN0R2VvbWV0cnlJbmRleE1hcDsKICAgICAgICAgIH0KICAgICAgICAgIGluc2VydGVkSW5kZXggPSBpbnNlcnRTcGxpdFBvaW50KAogICAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgICAgY3VycmVudEluZGljZXMsCiAgICAgICAgICAgIGN1cnJlbnRJbmRleE1hcCwKICAgICAgICAgICAgaW5kaWNlcywKICAgICAgICAgICAgcmVzdWx0SW5kZXggPCAzID8gaSArIHJlc3VsdEluZGV4IDogLTEsCiAgICAgICAgICAgIHBvaW50CiAgICAgICAgICApOwogICAgICAgICAgY29tcHV0ZVRyaWFuZ2xlQXR0cmlidXRlcygKICAgICAgICAgICAgaTAsCiAgICAgICAgICAgIGkxLAogICAgICAgICAgICBpMiwKICAgICAgICAgICAgcG9pbnQsCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgbm9ybWFscywKICAgICAgICAgICAgdGFuZ2VudHMsCiAgICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICAgIHRleENvb3JkcywKICAgICAgICAgICAgZXh0cnVkZURpcmVjdGlvbnMsCiAgICAgICAgICAgIGFwcGx5T2Zmc2V0LAogICAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgICAgY3VzdG9tQXR0cmlidXRlTmFtZXMsCiAgICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGgsCiAgICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICAgIGluc2VydGVkSW5kZXgKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcDAgPSByZXN1bHQucG9zaXRpb25zWzBdOwogICAgICAgICAgcDEgPSByZXN1bHQucG9zaXRpb25zWzFdOwogICAgICAgICAgcDIgPSByZXN1bHQucG9zaXRpb25zWzJdOwogICAgICAgIH0KICAgICAgICBpZiAocDAueSA8IDApIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gd2VzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgY3VycmVudEluZGV4TWFwID0gd2VzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgY3VycmVudEluZGV4TWFwID0gZWFzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgfQogICAgICAgIGluc2VydGVkSW5kZXggPSBpbnNlcnRTcGxpdFBvaW50KAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBjdXJyZW50SW5kaWNlcywKICAgICAgICAgIGN1cnJlbnRJbmRleE1hcCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBpLAogICAgICAgICAgcDAKICAgICAgICApOwogICAgICAgIGNvbXB1dGVUcmlhbmdsZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBwMCwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG5vcm1hbHMsCiAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgICBleHRydWRlRGlyZWN0aW9ucywKICAgICAgICAgIGFwcGx5T2Zmc2V0LAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBjdXN0b21BdHRyaWJ1dGVOYW1lcywKICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGgsCiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleAogICAgICAgICk7CiAgICAgICAgaW5zZXJ0ZWRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzLAogICAgICAgICAgY3VycmVudEluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIGkgKyAxLAogICAgICAgICAgcDEKICAgICAgICApOwogICAgICAgIGNvbXB1dGVUcmlhbmdsZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBwMSwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG5vcm1hbHMsCiAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgICBleHRydWRlRGlyZWN0aW9ucywKICAgICAgICAgIGFwcGx5T2Zmc2V0LAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBjdXN0b21BdHRyaWJ1dGVOYW1lcywKICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGgsCiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleAogICAgICAgICk7CiAgICAgICAgaW5zZXJ0ZWRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzLAogICAgICAgICAgY3VycmVudEluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIGkgKyAyLAogICAgICAgICAgcDIKICAgICAgICApOwogICAgICAgIGNvbXB1dGVUcmlhbmdsZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgaTIsCiAgICAgICAgICBwMiwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG5vcm1hbHMsCiAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgICBleHRydWRlRGlyZWN0aW9ucywKICAgICAgICAgIGFwcGx5T2Zmc2V0LAogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMsCiAgICAgICAgICBjdXN0b21BdHRyaWJ1dGVOYW1lcywKICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXNMZW5ndGgsCiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5zZXJ0ZWRJbmRleAogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIHVwZGF0ZUluc3RhbmNlQWZ0ZXJTcGxpdChpbnN0YW5jZSwgd2VzdEdlb21ldHJ5LCBlYXN0R2VvbWV0cnkpOwogIH0KICBmdW5jdGlvbiBjb21wdXRlTGluZUF0dHJpYnV0ZXMoaTAsIGkxLCBwb2ludCwgcG9zaXRpb25zLCBpbnNlcnRJbmRleCwgY3VycmVudEF0dHJpYnV0ZXMsIGFwcGx5T2Zmc2V0KSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcHBseU9mZnNldCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgcDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaTAgKiAzLCBwMFNjcmF0Y2gpOwogICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKHAwLCBwb2ludCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkpIHsKICAgICAgY3VycmVudEF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQudmFsdWVzW2luc2VydEluZGV4XSA9IGFwcGx5T2Zmc2V0W2kwXTsKICAgIH0gZWxzZSB7CiAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0LnZhbHVlc1tpbnNlcnRJbmRleF0gPSBhcHBseU9mZnNldFtpMV07CiAgICB9CiAgfQogIGZ1bmN0aW9uIHNwbGl0TG9uZ2l0dWRlTGluZXMoaW5zdGFuY2UpIHsKICAgIGNvbnN0IGdlb21ldHJ5ID0gaW5zdGFuY2UuZ2VvbWV0cnk7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgYXBwbHlPZmZzZXQgPSBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5hcHBseU9mZnNldCkgPyBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0LnZhbHVlcyA6IHZvaWQgMDsKICAgIGNvbnN0IGluZGljZXMgPSBnZW9tZXRyeS5pbmRpY2VzOwogICAgY29uc3QgZWFzdEdlb21ldHJ5ID0gY29weUdlb21ldHJ5Rm9yU3BsaXQoZ2VvbWV0cnkpOwogICAgY29uc3Qgd2VzdEdlb21ldHJ5ID0gY29weUdlb21ldHJ5Rm9yU3BsaXQoZ2VvbWV0cnkpOwogICAgbGV0IGk7CiAgICBjb25zdCBsZW5ndGggPSBpbmRpY2VzLmxlbmd0aDsKICAgIGNvbnN0IHdlc3RHZW9tZXRyeUluZGV4TWFwID0gW107CiAgICB3ZXN0R2VvbWV0cnlJbmRleE1hcC5sZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IGVhc3RHZW9tZXRyeUluZGV4TWFwID0gW107CiAgICBlYXN0R2VvbWV0cnlJbmRleE1hcC5sZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGZvciAoaSA9IDA7IGkgPCB3ZXN0R2VvbWV0cnlJbmRleE1hcC5sZW5ndGg7ICsraSkgewogICAgICB3ZXN0R2VvbWV0cnlJbmRleE1hcFtpXSA9IC0xOwogICAgICBlYXN0R2VvbWV0cnlJbmRleE1hcFtpXSA9IC0xOwogICAgfQogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAyKSB7CiAgICAgIGNvbnN0IGkwID0gaW5kaWNlc1tpXTsKICAgICAgY29uc3QgaTEgPSBpbmRpY2VzW2kgKyAxXTsKICAgICAgY29uc3QgcDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaTAgKiAzLCBwMFNjcmF0Y2gpOwogICAgICBjb25zdCBwMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMSAqIDMsIHAxU2NyYXRjaCk7CiAgICAgIGxldCBpbnNlcnRJbmRleDsKICAgICAgaWYgKE1hdGguYWJzKHAwLnkpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgaWYgKHAwLnkgPCAwKSB7CiAgICAgICAgICBwMC55ID0gLU1hdGhfZGVmYXVsdC5FUFNJTE9ONjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcDAueSA9IE1hdGhfZGVmYXVsdC5FUFNJTE9ONjsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKE1hdGguYWJzKHAxLnkpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT042KSB7CiAgICAgICAgaWYgKHAxLnkgPCAwKSB7CiAgICAgICAgICBwMS55ID0gLU1hdGhfZGVmYXVsdC5FUFNJTE9ONjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcDEueSA9IE1hdGhfZGVmYXVsdC5FUFNJTE9ONjsKICAgICAgICB9CiAgICAgIH0KICAgICAgbGV0IHAwQXR0cmlidXRlcyA9IGVhc3RHZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICBsZXQgcDBJbmRpY2VzID0gZWFzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgIGxldCBwMEluZGV4TWFwID0gZWFzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgIGxldCBwMUF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgbGV0IHAxSW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICBsZXQgcDFJbmRleE1hcCA9IHdlc3RHZW9tZXRyeUluZGV4TWFwOwogICAgICBjb25zdCBpbnRlcnNlY3Rpb24gPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LmxpbmVTZWdtZW50UGxhbmUoCiAgICAgICAgcDAsCiAgICAgICAgcDEsCiAgICAgICAgeHpQbGFuZSwKICAgICAgICBwMlNjcmF0Y2gKICAgICAgKTsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb24pKSB7CiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZLAogICAgICAgICAgNSAqIE1hdGhfZGVmYXVsdC5FUFNJTE9OOSwKICAgICAgICAgIG9mZnNldFNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGlmIChwMC55IDwgMCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShvZmZzZXQsIG9mZnNldCk7CiAgICAgICAgICBwMEF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIHAwSW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgcDBJbmRleE1hcCA9IHdlc3RHZW9tZXRyeUluZGV4TWFwOwogICAgICAgICAgcDFBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBwMUluZGljZXMgPSBlYXN0R2VvbWV0cnkuaW5kaWNlczsKICAgICAgICAgIHAxSW5kZXhNYXAgPSBlYXN0R2VvbWV0cnlJbmRleE1hcDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb2Zmc2V0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgaW50ZXJzZWN0aW9uLAogICAgICAgICAgb2Zmc2V0LAogICAgICAgICAgb2Zmc2V0UG9pbnRTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBpbnNlcnRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBwMEF0dHJpYnV0ZXMsCiAgICAgICAgICBwMEluZGljZXMsCiAgICAgICAgICBwMEluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIGksCiAgICAgICAgICBwMAogICAgICAgICk7CiAgICAgICAgY29tcHV0ZUxpbmVBdHRyaWJ1dGVzKAogICAgICAgICAgaTAsCiAgICAgICAgICBpMSwKICAgICAgICAgIHAwLAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgaW5zZXJ0SW5kZXgsCiAgICAgICAgICBwMEF0dHJpYnV0ZXMsCiAgICAgICAgICBhcHBseU9mZnNldAogICAgICAgICk7CiAgICAgICAgaW5zZXJ0SW5kZXggPSBpbnNlcnRTcGxpdFBvaW50KAogICAgICAgICAgcDBBdHRyaWJ1dGVzLAogICAgICAgICAgcDBJbmRpY2VzLAogICAgICAgICAgcDBJbmRleE1hcCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAtMSwKICAgICAgICAgIG9mZnNldFBvaW50CiAgICAgICAgKTsKICAgICAgICBjb21wdXRlTGluZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgb2Zmc2V0UG9pbnQsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBpbnNlcnRJbmRleCwKICAgICAgICAgIHAwQXR0cmlidXRlcywKICAgICAgICAgIGFwcGx5T2Zmc2V0CiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG9mZnNldCwgb2Zmc2V0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGludGVyc2VjdGlvbiwgb2Zmc2V0LCBvZmZzZXRQb2ludCk7CiAgICAgICAgaW5zZXJ0SW5kZXggPSBpbnNlcnRTcGxpdFBvaW50KAogICAgICAgICAgcDFBdHRyaWJ1dGVzLAogICAgICAgICAgcDFJbmRpY2VzLAogICAgICAgICAgcDFJbmRleE1hcCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAtMSwKICAgICAgICAgIG9mZnNldFBvaW50CiAgICAgICAgKTsKICAgICAgICBjb21wdXRlTGluZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgb2Zmc2V0UG9pbnQsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBpbnNlcnRJbmRleCwKICAgICAgICAgIHAxQXR0cmlidXRlcywKICAgICAgICAgIGFwcGx5T2Zmc2V0CiAgICAgICAgKTsKICAgICAgICBpbnNlcnRJbmRleCA9IGluc2VydFNwbGl0UG9pbnQoCiAgICAgICAgICBwMUF0dHJpYnV0ZXMsCiAgICAgICAgICBwMUluZGljZXMsCiAgICAgICAgICBwMUluZGV4TWFwLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIGkgKyAxLAogICAgICAgICAgcDEKICAgICAgICApOwogICAgICAgIGNvbXB1dGVMaW5lQXR0cmlidXRlcygKICAgICAgICAgIGkwLAogICAgICAgICAgaTEsCiAgICAgICAgICBwMSwKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIGluc2VydEluZGV4LAogICAgICAgICAgcDFBdHRyaWJ1dGVzLAogICAgICAgICAgYXBwbHlPZmZzZXQKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIGxldCBjdXJyZW50QXR0cmlidXRlczsKICAgICAgICBsZXQgY3VycmVudEluZGljZXM7CiAgICAgICAgbGV0IGN1cnJlbnRJbmRleE1hcDsKICAgICAgICBpZiAocDAueSA8IDApIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gd2VzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgY3VycmVudEluZGV4TWFwID0gd2VzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgY3VycmVudEluZGV4TWFwID0gZWFzdEdlb21ldHJ5SW5kZXhNYXA7CiAgICAgICAgfQogICAgICAgIGluc2VydEluZGV4ID0gaW5zZXJ0U3BsaXRQb2ludCgKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLAogICAgICAgICAgY3VycmVudEluZGljZXMsCiAgICAgICAgICBjdXJyZW50SW5kZXhNYXAsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgaSwKICAgICAgICAgIHAwCiAgICAgICAgKTsKICAgICAgICBjb21wdXRlTGluZUF0dHJpYnV0ZXMoCiAgICAgICAgICBpMCwKICAgICAgICAgIGkxLAogICAgICAgICAgcDAsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBpbnNlcnRJbmRleCwKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLAogICAgICAgICAgYXBwbHlPZmZzZXQKICAgICAgICApOwogICAgICAgIGluc2VydEluZGV4ID0gaW5zZXJ0U3BsaXRQb2ludCgKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLAogICAgICAgICAgY3VycmVudEluZGljZXMsCiAgICAgICAgICBjdXJyZW50SW5kZXhNYXAsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgaSArIDEsCiAgICAgICAgICBwMQogICAgICAgICk7CiAgICAgICAgY29tcHV0ZUxpbmVBdHRyaWJ1dGVzKAogICAgICAgICAgaTAsCiAgICAgICAgICBpMSwKICAgICAgICAgIHAxLAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgaW5zZXJ0SW5kZXgsCiAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcywKICAgICAgICAgIGFwcGx5T2Zmc2V0CiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgdXBkYXRlSW5zdGFuY2VBZnRlclNwbGl0KGluc3RhbmNlLCB3ZXN0R2VvbWV0cnksIGVhc3RHZW9tZXRyeSk7CiAgfQogIGZ1bmN0aW9uIHVwZGF0ZUFkamFjZW5jeUFmdGVyU3BsaXQoZ2VvbWV0cnkpIHsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgY29uc3QgcG9zaXRpb25zID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBjb25zdCBwcmV2UG9zaXRpb25zID0gYXR0cmlidXRlcy5wcmV2UG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgbmV4dFBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGxlbmd0aDsgaiArPSAzKSB7CiAgICAgIGNvbnN0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwb3NpdGlvbnMsIGosIGNhcnRlc2lhbjNTY3JhdGNoMCk7CiAgICAgIGlmIChwb3NpdGlvbi54ID4gMCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IHByZXZQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgcHJldlBvc2l0aW9ucywKICAgICAgICBqLAogICAgICAgIGNhcnRlc2lhbjNTY3JhdGNoMgogICAgICApOwogICAgICBpZiAocG9zaXRpb24ueSA8IDAgJiYgcHJldlBvc2l0aW9uLnkgPiAwIHx8IHBvc2l0aW9uLnkgPiAwICYmIHByZXZQb3NpdGlvbi55IDwgMCkgewogICAgICAgIGlmIChqIC0gMyA+IDApIHsKICAgICAgICAgIHByZXZQb3NpdGlvbnNbal0gPSBwb3NpdGlvbnNbaiAtIDNdOwogICAgICAgICAgcHJldlBvc2l0aW9uc1tqICsgMV0gPSBwb3NpdGlvbnNbaiAtIDJdOwogICAgICAgICAgcHJldlBvc2l0aW9uc1tqICsgMl0gPSBwb3NpdGlvbnNbaiAtIDFdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbiwgcHJldlBvc2l0aW9ucywgaik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IG5leHRQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgbmV4dFBvc2l0aW9ucywKICAgICAgICBqLAogICAgICAgIGNhcnRlc2lhbjNTY3JhdGNoMwogICAgICApOwogICAgICBpZiAocG9zaXRpb24ueSA8IDAgJiYgbmV4dFBvc2l0aW9uLnkgPiAwIHx8IHBvc2l0aW9uLnkgPiAwICYmIG5leHRQb3NpdGlvbi55IDwgMCkgewogICAgICAgIGlmIChqICsgMyA8IGxlbmd0aCkgewogICAgICAgICAgbmV4dFBvc2l0aW9uc1tqXSA9IHBvc2l0aW9uc1tqICsgM107CiAgICAgICAgICBuZXh0UG9zaXRpb25zW2ogKyAxXSA9IHBvc2l0aW9uc1tqICsgNF07CiAgICAgICAgICBuZXh0UG9zaXRpb25zW2ogKyAyXSA9IHBvc2l0aW9uc1tqICsgNV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uLCBuZXh0UG9zaXRpb25zLCBqKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gc3BsaXRMb25naXR1ZGVQb2x5bGluZShpbnN0YW5jZSkgewogICAgY29uc3QgZ2VvbWV0cnkgPSBpbnN0YW5jZS5nZW9tZXRyeTsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgY29uc3QgcG9zaXRpb25zID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBjb25zdCBwcmV2UG9zaXRpb25zID0gYXR0cmlidXRlcy5wcmV2UG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgbmV4dFBvc2l0aW9ucyA9IGF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IGV4cGFuZEFuZFdpZHRocyA9IGF0dHJpYnV0ZXMuZXhwYW5kQW5kV2lkdGgudmFsdWVzOwogICAgY29uc3QgdGV4Q29vcmRzID0gZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMuc3QpID8gYXR0cmlidXRlcy5zdC52YWx1ZXMgOiB2b2lkIDA7CiAgICBjb25zdCBjb2xvcnMgPSBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5jb2xvcikgPyBhdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcyA6IHZvaWQgMDsKICAgIGNvbnN0IGVhc3RHZW9tZXRyeSA9IGNvcHlHZW9tZXRyeUZvclNwbGl0KGdlb21ldHJ5KTsKICAgIGNvbnN0IHdlc3RHZW9tZXRyeSA9IGNvcHlHZW9tZXRyeUZvclNwbGl0KGdlb21ldHJ5KTsKICAgIGxldCBpOwogICAgbGV0IGo7CiAgICBsZXQgaW5kZXg7CiAgICBsZXQgaW50ZXJzZWN0aW9uRm91bmQgPSBmYWxzZTsKICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSArPSA0KSB7CiAgICAgIGNvbnN0IGkwID0gaTsKICAgICAgY29uc3QgaTIgPSBpICsgMjsKICAgICAgY29uc3QgcDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaTAgKiAzLCBjYXJ0ZXNpYW4zU2NyYXRjaDApOwogICAgICBjb25zdCBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpMiAqIDMsIGNhcnRlc2lhbjNTY3JhdGNoMik7CiAgICAgIGlmIChNYXRoLmFicyhwMC55KSA8IGNvcGxhbmFyT2Zmc2V0KSB7CiAgICAgICAgcDAueSA9IGNvcGxhbmFyT2Zmc2V0ICogKHAyLnkgPCAwID8gLTEgOiAxKTsKICAgICAgICBwb3NpdGlvbnNbaSAqIDMgKyAxXSA9IHAwLnk7CiAgICAgICAgcG9zaXRpb25zWyhpICsgMSkgKiAzICsgMV0gPSBwMC55OwogICAgICAgIGZvciAoaiA9IGkwICogMzsgaiA8IGkwICogMyArIDQgKiAzOyBqICs9IDMpIHsKICAgICAgICAgIHByZXZQb3NpdGlvbnNbal0gPSBwb3NpdGlvbnNbaSAqIDNdOwogICAgICAgICAgcHJldlBvc2l0aW9uc1tqICsgMV0gPSBwb3NpdGlvbnNbaSAqIDMgKyAxXTsKICAgICAgICAgIHByZXZQb3NpdGlvbnNbaiArIDJdID0gcG9zaXRpb25zW2kgKiAzICsgMl07CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChNYXRoLmFicyhwMi55KSA8IGNvcGxhbmFyT2Zmc2V0KSB7CiAgICAgICAgcDIueSA9IGNvcGxhbmFyT2Zmc2V0ICogKHAwLnkgPCAwID8gLTEgOiAxKTsKICAgICAgICBwb3NpdGlvbnNbKGkgKyAyKSAqIDMgKyAxXSA9IHAyLnk7CiAgICAgICAgcG9zaXRpb25zWyhpICsgMykgKiAzICsgMV0gPSBwMi55OwogICAgICAgIGZvciAoaiA9IGkwICogMzsgaiA8IGkwICogMyArIDQgKiAzOyBqICs9IDMpIHsKICAgICAgICAgIG5leHRQb3NpdGlvbnNbal0gPSBwb3NpdGlvbnNbKGkgKyAyKSAqIDNdOwogICAgICAgICAgbmV4dFBvc2l0aW9uc1tqICsgMV0gPSBwb3NpdGlvbnNbKGkgKyAyKSAqIDMgKyAxXTsKICAgICAgICAgIG5leHRQb3NpdGlvbnNbaiArIDJdID0gcG9zaXRpb25zWyhpICsgMikgKiAzICsgMl07CiAgICAgICAgfQogICAgICB9CiAgICAgIGxldCBwMEF0dHJpYnV0ZXMgPSBlYXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgbGV0IHAwSW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICBsZXQgcDJBdHRyaWJ1dGVzID0gd2VzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgIGxldCBwMkluZGljZXMgPSB3ZXN0R2VvbWV0cnkuaW5kaWNlczsKICAgICAgY29uc3QgaW50ZXJzZWN0aW9uID0gSW50ZXJzZWN0aW9uVGVzdHNfZGVmYXVsdC5saW5lU2VnbWVudFBsYW5lKAogICAgICAgIHAwLAogICAgICAgIHAyLAogICAgICAgIHh6UGxhbmUsCiAgICAgICAgY2FydGVzaWFuM1NjcmF0Y2g0CiAgICAgICk7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSkgewogICAgICAgIGludGVyc2VjdGlvbkZvdW5kID0gdHJ1ZTsKICAgICAgICBjb25zdCBvZmZzZXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1ksCiAgICAgICAgICBvZmZzZXRTY2FsYXIsCiAgICAgICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDUKICAgICAgICApOwogICAgICAgIGlmIChwMC55IDwgMCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShvZmZzZXQsIG9mZnNldCk7CiAgICAgICAgICBwMEF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIHAwSW5kaWNlcyA9IHdlc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgICAgcDJBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBwMkluZGljZXMgPSBlYXN0R2VvbWV0cnkuaW5kaWNlczsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb2Zmc2V0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgaW50ZXJzZWN0aW9uLAogICAgICAgICAgb2Zmc2V0LAogICAgICAgICAgY2FydGVzaWFuM1NjcmF0Y2g2CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLnB1c2gocDAueCwgcDAueSwgcDAueiwgcDAueCwgcDAueSwgcDAueik7CiAgICAgICAgcDBBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAwQXR0cmlidXRlcy5wcmV2UG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBwcmV2UG9zaXRpb25zW2kwICogM10sCiAgICAgICAgICBwcmV2UG9zaXRpb25zW2kwICogMyArIDFdLAogICAgICAgICAgcHJldlBvc2l0aW9uc1tpMCAqIDMgKyAyXQogICAgICAgICk7CiAgICAgICAgcDBBdHRyaWJ1dGVzLnByZXZQb3NpdGlvbi52YWx1ZXMucHVzaCgKICAgICAgICAgIHByZXZQb3NpdGlvbnNbaTAgKiAzICsgM10sCiAgICAgICAgICBwcmV2UG9zaXRpb25zW2kwICogMyArIDRdLAogICAgICAgICAgcHJldlBvc2l0aW9uc1tpMCAqIDMgKyA1XQogICAgICAgICk7CiAgICAgICAgcDBBdHRyaWJ1dGVzLnByZXZQb3NpdGlvbi52YWx1ZXMucHVzaChwMC54LCBwMC55LCBwMC56LCBwMC54LCBwMC55LCBwMC56KTsKICAgICAgICBwMEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG9mZnNldCwgb2Zmc2V0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGludGVyc2VjdGlvbiwgb2Zmc2V0LCBvZmZzZXRQb2ludCk7CiAgICAgICAgcDJBdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBvZmZzZXRQb2ludC54LAogICAgICAgICAgb2Zmc2V0UG9pbnQueSwKICAgICAgICAgIG9mZnNldFBvaW50LnoKICAgICAgICApOwogICAgICAgIHAyQXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMi54LCBwMi55LCBwMi56LCBwMi54LCBwMi55LCBwMi56KTsKICAgICAgICBwMkF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKAogICAgICAgICAgb2Zmc2V0UG9pbnQueCwKICAgICAgICAgIG9mZnNldFBvaW50LnksCiAgICAgICAgICBvZmZzZXRQb2ludC56CiAgICAgICAgKTsKICAgICAgICBwMkF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKHAyLngsIHAyLnksIHAyLnosIHAyLngsIHAyLnksIHAyLnopOwogICAgICAgIHAyQXR0cmlidXRlcy5uZXh0UG9zaXRpb24udmFsdWVzLnB1c2goCiAgICAgICAgICBuZXh0UG9zaXRpb25zW2kyICogM10sCiAgICAgICAgICBuZXh0UG9zaXRpb25zW2kyICogMyArIDFdLAogICAgICAgICAgbmV4dFBvc2l0aW9uc1tpMiAqIDMgKyAyXQogICAgICAgICk7CiAgICAgICAgcDJBdHRyaWJ1dGVzLm5leHRQb3NpdGlvbi52YWx1ZXMucHVzaCgKICAgICAgICAgIG5leHRQb3NpdGlvbnNbaTIgKiAzICsgM10sCiAgICAgICAgICBuZXh0UG9zaXRpb25zW2kyICogMyArIDRdLAogICAgICAgICAgbmV4dFBvc2l0aW9uc1tpMiAqIDMgKyA1XQogICAgICAgICk7CiAgICAgICAgY29uc3QgZXcwID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIGV4cGFuZEFuZFdpZHRocywKICAgICAgICAgIGkwICogMiwKICAgICAgICAgIGNhcnRlc2lhbjJTY3JhdGNoMAogICAgICAgICk7CiAgICAgICAgY29uc3Qgd2lkdGggPSBNYXRoLmFicyhldzAueSk7CiAgICAgICAgcDBBdHRyaWJ1dGVzLmV4cGFuZEFuZFdpZHRoLnZhbHVlcy5wdXNoKC0xLCB3aWR0aCwgMSwgd2lkdGgpOwogICAgICAgIHAwQXR0cmlidXRlcy5leHBhbmRBbmRXaWR0aC52YWx1ZXMucHVzaCgtMSwgLXdpZHRoLCAxLCAtd2lkdGgpOwogICAgICAgIHAyQXR0cmlidXRlcy5leHBhbmRBbmRXaWR0aC52YWx1ZXMucHVzaCgtMSwgd2lkdGgsIDEsIHdpZHRoKTsKICAgICAgICBwMkF0dHJpYnV0ZXMuZXhwYW5kQW5kV2lkdGgudmFsdWVzLnB1c2goLTEsIC13aWR0aCwgMSwgLXdpZHRoKTsKICAgICAgICBsZXQgdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGludGVyc2VjdGlvbiwgcDAsIGNhcnRlc2lhbjNTY3JhdGNoMykKICAgICAgICApOwogICAgICAgIHQgLz0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDIsIHAwLCBjYXJ0ZXNpYW4zU2NyYXRjaDMpCiAgICAgICAgKTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykpIHsKICAgICAgICAgIGNvbnN0IGMwID0gQ2FydGVzaWFuNF9kZWZhdWx0LmZyb21BcnJheShjb2xvcnMsIGkwICogNCwgY2FydGVzaWFuNFNjcmF0Y2gwKTsKICAgICAgICAgIGNvbnN0IGMyID0gQ2FydGVzaWFuNF9kZWZhdWx0LmZyb21BcnJheShjb2xvcnMsIGkyICogNCwgY2FydGVzaWFuNFNjcmF0Y2gwKTsKICAgICAgICAgIGNvbnN0IHIgPSBNYXRoX2RlZmF1bHQubGVycChjMC54LCBjMi54LCB0KTsKICAgICAgICAgIGNvbnN0IGcgPSBNYXRoX2RlZmF1bHQubGVycChjMC55LCBjMi55LCB0KTsKICAgICAgICAgIGNvbnN0IGIgPSBNYXRoX2RlZmF1bHQubGVycChjMC56LCBjMi56LCB0KTsKICAgICAgICAgIGNvbnN0IGEzID0gTWF0aF9kZWZhdWx0LmxlcnAoYzAudywgYzIudywgdCk7CiAgICAgICAgICBmb3IgKGogPSBpMCAqIDQ7IGogPCBpMCAqIDQgKyAyICogNDsgKytqKSB7CiAgICAgICAgICAgIHAwQXR0cmlidXRlcy5jb2xvci52YWx1ZXMucHVzaChjb2xvcnNbal0pOwogICAgICAgICAgfQogICAgICAgICAgcDBBdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcy5wdXNoKHIsIGcsIGIsIGEzKTsKICAgICAgICAgIHAwQXR0cmlidXRlcy5jb2xvci52YWx1ZXMucHVzaChyLCBnLCBiLCBhMyk7CiAgICAgICAgICBwMkF0dHJpYnV0ZXMuY29sb3IudmFsdWVzLnB1c2gociwgZywgYiwgYTMpOwogICAgICAgICAgcDJBdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcy5wdXNoKHIsIGcsIGIsIGEzKTsKICAgICAgICAgIGZvciAoaiA9IGkyICogNDsgaiA8IGkyICogNCArIDIgKiA0OyArK2opIHsKICAgICAgICAgICAgcDJBdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcy5wdXNoKGNvbG9yc1tqXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGV4Q29vcmRzKSkgewogICAgICAgICAgY29uc3QgczAgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KHRleENvb3JkcywgaTAgKiAyLCBjYXJ0ZXNpYW4yU2NyYXRjaDApOwogICAgICAgICAgY29uc3QgczMgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICB0ZXhDb29yZHMsCiAgICAgICAgICAgIChpICsgMykgKiAyLAogICAgICAgICAgICBjYXJ0ZXNpYW4yU2NyYXRjaDEKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBzeCA9IE1hdGhfZGVmYXVsdC5sZXJwKHMwLngsIHMzLngsIHQpOwogICAgICAgICAgZm9yIChqID0gaTAgKiAyOyBqIDwgaTAgKiAyICsgMiAqIDI7ICsraikgewogICAgICAgICAgICBwMEF0dHJpYnV0ZXMuc3QudmFsdWVzLnB1c2godGV4Q29vcmRzW2pdKTsKICAgICAgICAgIH0KICAgICAgICAgIHAwQXR0cmlidXRlcy5zdC52YWx1ZXMucHVzaChzeCwgczAueSk7CiAgICAgICAgICBwMEF0dHJpYnV0ZXMuc3QudmFsdWVzLnB1c2goc3gsIHMzLnkpOwogICAgICAgICAgcDJBdHRyaWJ1dGVzLnN0LnZhbHVlcy5wdXNoKHN4LCBzMC55KTsKICAgICAgICAgIHAyQXR0cmlidXRlcy5zdC52YWx1ZXMucHVzaChzeCwgczMueSk7CiAgICAgICAgICBmb3IgKGogPSBpMiAqIDI7IGogPCBpMiAqIDIgKyAyICogMjsgKytqKSB7CiAgICAgICAgICAgIHAyQXR0cmlidXRlcy5zdC52YWx1ZXMucHVzaCh0ZXhDb29yZHNbal0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpbmRleCA9IHAwQXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMyAtIDQ7CiAgICAgICAgcDBJbmRpY2VzLnB1c2goaW5kZXgsIGluZGV4ICsgMiwgaW5kZXggKyAxKTsKICAgICAgICBwMEluZGljZXMucHVzaChpbmRleCArIDEsIGluZGV4ICsgMiwgaW5kZXggKyAzKTsKICAgICAgICBpbmRleCA9IHAyQXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMyAtIDQ7CiAgICAgICAgcDJJbmRpY2VzLnB1c2goaW5kZXgsIGluZGV4ICsgMiwgaW5kZXggKyAxKTsKICAgICAgICBwMkluZGljZXMucHVzaChpbmRleCArIDEsIGluZGV4ICsgMiwgaW5kZXggKyAzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsZXQgY3VycmVudEF0dHJpYnV0ZXM7CiAgICAgICAgbGV0IGN1cnJlbnRJbmRpY2VzOwogICAgICAgIGlmIChwMC55IDwgMCkgewogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMgPSB3ZXN0R2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIGN1cnJlbnRJbmRpY2VzID0gd2VzdEdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzID0gZWFzdEdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgICBjdXJyZW50SW5kaWNlcyA9IGVhc3RHZW9tZXRyeS5pbmRpY2VzOwogICAgICAgIH0KICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMC54LCBwMC55LCBwMC56KTsKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMC54LCBwMC55LCBwMC56KTsKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMi54LCBwMi55LCBwMi56KTsKICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMucHVzaChwMi54LCBwMi55LCBwMi56KTsKICAgICAgICBmb3IgKGogPSBpICogMzsgaiA8IGkgKiAzICsgNCAqIDM7ICsraikgewogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMucHJldlBvc2l0aW9uLnZhbHVlcy5wdXNoKHByZXZQb3NpdGlvbnNbal0pOwogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uLnZhbHVlcy5wdXNoKG5leHRQb3NpdGlvbnNbal0pOwogICAgICAgIH0KICAgICAgICBmb3IgKGogPSBpICogMjsgaiA8IGkgKiAyICsgNCAqIDI7ICsraikgewogICAgICAgICAgY3VycmVudEF0dHJpYnV0ZXMuZXhwYW5kQW5kV2lkdGgudmFsdWVzLnB1c2goZXhwYW5kQW5kV2lkdGhzW2pdKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGV4Q29vcmRzKSkgewogICAgICAgICAgICBjdXJyZW50QXR0cmlidXRlcy5zdC52YWx1ZXMucHVzaCh0ZXhDb29yZHNbal0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykpIHsKICAgICAgICAgIGZvciAoaiA9IGkgKiA0OyBqIDwgaSAqIDQgKyA0ICogNDsgKytqKSB7CiAgICAgICAgICAgIGN1cnJlbnRBdHRyaWJ1dGVzLmNvbG9yLnZhbHVlcy5wdXNoKGNvbG9yc1tqXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGluZGV4ID0gY3VycmVudEF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCAvIDMgLSA0OwogICAgICAgIGN1cnJlbnRJbmRpY2VzLnB1c2goaW5kZXgsIGluZGV4ICsgMiwgaW5kZXggKyAxKTsKICAgICAgICBjdXJyZW50SW5kaWNlcy5wdXNoKGluZGV4ICsgMSwgaW5kZXggKyAyLCBpbmRleCArIDMpOwogICAgICB9CiAgICB9CiAgICBpZiAoaW50ZXJzZWN0aW9uRm91bmQpIHsKICAgICAgdXBkYXRlQWRqYWNlbmN5QWZ0ZXJTcGxpdCh3ZXN0R2VvbWV0cnkpOwogICAgICB1cGRhdGVBZGphY2VuY3lBZnRlclNwbGl0KGVhc3RHZW9tZXRyeSk7CiAgICB9CiAgICB1cGRhdGVJbnN0YW5jZUFmdGVyU3BsaXQoaW5zdGFuY2UsIHdlc3RHZW9tZXRyeSwgZWFzdEdlb21ldHJ5KTsKICB9CiAgdmFyIEdlb21ldHJ5UGlwZWxpbmUsIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRlc2lhbjMsIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRvZ3JhcGhpYywgZW5jb2RlZFJlc3VsdCwgc2NyYXRjaENhcnRlc2lhbjMzLCBpbnZlcnNlVHJhbnNwb3NlLCBub3JtYWxNYXRyaXgsIHRlbXBTY3JhdGNoLCBub3JtYWwsIHYwLCB2MSwgdjIsIG5vcm1hbFNjcmF0Y2gyLCBub3JtYWxTY2FsZSwgdFNjcmF0Y2gsIHNjcmF0Y2hDYXJ0ZXNpYW4yMiwgdG9FbmNvZGUxLCB0b0VuY29kZTIsIHRvRW5jb2RlMywgZW5jb2RlUmVzdWx0MiwgYzMsIHUxLCB1MiwgcTEsIHEyLCBzcGxpdFRyaWFuZ2xlUmVzdWx0LCBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW40LCBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4zLCBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4yLCBpbnRlcnBvbGF0ZUFuZFBhY2tCb29sZWFuLCBwMFNjcmF0Y2gsIHAxU2NyYXRjaCwgcDJTY3JhdGNoLCBiYXJ5Y2VudHJpY1NjcmF0Y2gsIE5BTUVEX0FUVFJJQlVURVMsIHh6UGxhbmUsIG9mZnNldFNjcmF0Y2gsIG9mZnNldFBvaW50U2NyYXRjaCwgY2FydGVzaWFuMlNjcmF0Y2gwLCBjYXJ0ZXNpYW4yU2NyYXRjaDEsIGNhcnRlc2lhbjNTY3JhdGNoMCwgY2FydGVzaWFuM1NjcmF0Y2gyLCBjYXJ0ZXNpYW4zU2NyYXRjaDMsIGNhcnRlc2lhbjNTY3JhdGNoNCwgY2FydGVzaWFuM1NjcmF0Y2g1LCBjYXJ0ZXNpYW4zU2NyYXRjaDYsIGNhcnRlc2lhbjRTY3JhdGNoMCwgb2Zmc2V0U2NhbGFyLCBjb3BsYW5hck9mZnNldCwgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0OwogIHZhciBpbml0X0dlb21ldHJ5UGlwZWxpbmUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5UGlwZWxpbmUuanMiKCkgewogICAgICBpbml0X0F0dHJpYnV0ZUNvbXByZXNzaW9uKCk7CiAgICAgIGluaXRfYmFyeWNlbnRyaWNDb29yZGluYXRlcygpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbmNvZGVkQ2FydGVzaWFuMygpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5VHlwZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9JbnRlcnNlY3QoKTsKICAgICAgaW5pdF9JbnRlcnNlY3Rpb25UZXN0cygpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBpbml0X1BsYW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1RpcHNpZnkoKTsKICAgICAgR2VvbWV0cnlQaXBlbGluZSA9IHt9OwogICAgICBHZW9tZXRyeVBpcGVsaW5lLnRvV2lyZWZyYW1lID0gZnVuY3Rpb24oZ2VvbWV0cnkpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IGdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSkgewogICAgICAgICAgc3dpdGNoIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlKSB7CiAgICAgICAgICAgIGNhc2UgUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUzoKICAgICAgICAgICAgICBnZW9tZXRyeS5pbmRpY2VzID0gdHJpYW5nbGVzVG9MaW5lcyhpbmRpY2VzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVfU1RSSVA6CiAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcyA9IHRyaWFuZ2xlU3RyaXBUb0xpbmVzKGluZGljZXMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRV9GQU46CiAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcyA9IHRyaWFuZ2xlRmFuVG9MaW5lcyhpbmRpY2VzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgICAgICJnZW9tZXRyeS5wcmltaXRpdmVUeXBlIG11c3QgYmUgVFJJQU5HTEVTLCBUUklBTkdMRV9TVFJJUCwgb3IgVFJJQU5HTEVfRkFOLiIKICAgICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSA9IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICB9OwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmNyZWF0ZUxpbmVTZWdtZW50c0ZvclZlY3RvcnMgPSBmdW5jdGlvbihnZW9tZXRyeSwgYXR0cmlidXRlTmFtZSwgbGVuZ3RoKSB7CiAgICAgICAgYXR0cmlidXRlTmFtZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGF0dHJpYnV0ZU5hbWUsICJub3JtYWwiKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGBnZW9tZXRyeS5hdHRyaWJ1dGVzIG11c3QgaGF2ZSBhbiBhdHRyaWJ1dGUgd2l0aCB0aGUgc2FtZSBuYW1lIGFzIHRoZSBhdHRyaWJ1dGVOYW1lIHBhcmFtZXRlciwgJHthdHRyaWJ1dGVOYW1lfS5gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChsZW5ndGgsIDFlNCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICAgICAgY29uc3QgdmVjdG9ycyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0udmFsdWVzOwogICAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgbmV3UG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSgyICogcG9zaXRpb25zTGVuZ3RoKTsKICAgICAgICBsZXQgaiA9IDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgbmV3UG9zaXRpb25zW2orK10gPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaisrXSA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaisrXSA9IHBvc2l0aW9uc1tpICsgMl07CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaisrXSA9IHBvc2l0aW9uc1tpXSArIHZlY3RvcnNbaV0gKiBsZW5ndGg7CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaisrXSA9IHBvc2l0aW9uc1tpICsgMV0gKyB2ZWN0b3JzW2kgKyAxXSAqIGxlbmd0aDsKICAgICAgICAgIG5ld1Bvc2l0aW9uc1tqKytdID0gcG9zaXRpb25zW2kgKyAyXSArIHZlY3RvcnNbaSArIDJdICogbGVuZ3RoOwogICAgICAgIH0KICAgICAgICBsZXQgbmV3Qm91bmRpbmdTcGhlcmU7CiAgICAgICAgY29uc3QgYnMgPSBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJzKSkgewogICAgICAgICAgbmV3Qm91bmRpbmdTcGhlcmUgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdChicy5jZW50ZXIsIGJzLnJhZGl1cyArIGxlbmd0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzOiB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBuZXdQb3NpdGlvbnMKICAgICAgICAgICAgfSkKICAgICAgICAgIH0sCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogbmV3Qm91bmRpbmdTcGhlcmUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5jcmVhdGVBdHRyaWJ1dGVMb2NhdGlvbnMgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBzZW1hbnRpY3MgPSBbCiAgICAgICAgICAicG9zaXRpb24iLAogICAgICAgICAgInBvc2l0aW9uSGlnaCIsCiAgICAgICAgICAicG9zaXRpb25Mb3ciLAogICAgICAgICAgLy8gRnJvbSBWZXJ0ZXhGb3JtYXQucG9zaXRpb24gLSBhZnRlciAyRCBwcm9qZWN0aW9uIGFuZCBoaWdoLXByZWNpc2lvbiBlbmNvZGluZwogICAgICAgICAgInBvc2l0aW9uM0RIaWdoIiwKICAgICAgICAgICJwb3NpdGlvbjNETG93IiwKICAgICAgICAgICJwb3NpdGlvbjJESGlnaCIsCiAgICAgICAgICAicG9zaXRpb24yRExvdyIsCiAgICAgICAgICAvLyBGcm9tIFByaW1pdGl2ZQogICAgICAgICAgInBpY2tDb2xvciIsCiAgICAgICAgICAvLyBGcm9tIFZlcnRleEZvcm1hdAogICAgICAgICAgIm5vcm1hbCIsCiAgICAgICAgICAic3QiLAogICAgICAgICAgInRhbmdlbnQiLAogICAgICAgICAgImJpdGFuZ2VudCIsCiAgICAgICAgICAvLyBGb3Igc2hhZG93IHZvbHVtZXMKICAgICAgICAgICJleHRydWRlRGlyZWN0aW9uIiwKICAgICAgICAgIC8vIEZyb20gY29tcHJlc3NpbmcgdGV4dHVyZSBjb29yZGluYXRlcyBhbmQgbm9ybWFscwogICAgICAgICAgImNvbXByZXNzZWRBdHRyaWJ1dGVzIgogICAgICAgIF07CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IHt9OwogICAgICAgIGxldCBqID0gMDsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBsZW4gPSBzZW1hbnRpY3MubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgICAgY29uc3Qgc2VtYW50aWMgPSBzZW1hbnRpY3NbaV07CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXNbc2VtYW50aWNdKSkgewogICAgICAgICAgICBpbmRpY2VzW3NlbWFudGljXSA9IGorKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBuYW1lIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KG5hbWUpICYmICFkZWZpbmVkX2RlZmF1bHQoaW5kaWNlc1tuYW1lXSkpIHsKICAgICAgICAgICAgaW5kaWNlc1tuYW1lXSA9IGorKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGluZGljZXM7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUucmVvcmRlckZvclByZVZlcnRleENhY2hlID0gZnVuY3Rpb24oZ2VvbWV0cnkpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSBHZW9tZXRyeV9kZWZhdWx0LmNvbXB1dGVOdW1iZXJPZlZlcnRpY2VzKGdlb21ldHJ5KTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gZ2VvbWV0cnkuaW5kaWNlczsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgICAgICBjb25zdCBpbmRleENyb3NzUmVmZXJlbmNlT2xkVG9OZXcgPSBuZXcgSW50MzJBcnJheShudW1WZXJ0aWNlcyk7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVZlcnRpY2VzOyBpKyspIHsKICAgICAgICAgICAgaW5kZXhDcm9zc1JlZmVyZW5jZU9sZFRvTmV3W2ldID0gLTE7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBpbmRpY2VzSW4gPSBpbmRpY2VzOwogICAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IGluZGljZXNJbi5sZW5ndGg7CiAgICAgICAgICBjb25zdCBpbmRpY2VzT3V0ID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtVmVydGljZXMsIG51bUluZGljZXMpOwogICAgICAgICAgbGV0IGludG9JbmRpY2VzSW4gPSAwOwogICAgICAgICAgbGV0IGludG9JbmRpY2VzT3V0ID0gMDsKICAgICAgICAgIGxldCBuZXh0SW5kZXggPSAwOwogICAgICAgICAgbGV0IHRlbXBJbmRleDsKICAgICAgICAgIHdoaWxlIChpbnRvSW5kaWNlc0luIDwgbnVtSW5kaWNlcykgewogICAgICAgICAgICB0ZW1wSW5kZXggPSBpbmRleENyb3NzUmVmZXJlbmNlT2xkVG9OZXdbaW5kaWNlc0luW2ludG9JbmRpY2VzSW5dXTsKICAgICAgICAgICAgaWYgKHRlbXBJbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICBpbmRpY2VzT3V0W2ludG9JbmRpY2VzT3V0XSA9IHRlbXBJbmRleDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0ZW1wSW5kZXggPSBpbmRpY2VzSW5baW50b0luZGljZXNJbl07CiAgICAgICAgICAgICAgaW5kZXhDcm9zc1JlZmVyZW5jZU9sZFRvTmV3W3RlbXBJbmRleF0gPSBuZXh0SW5kZXg7CiAgICAgICAgICAgICAgaW5kaWNlc091dFtpbnRvSW5kaWNlc091dF0gPSBuZXh0SW5kZXg7CiAgICAgICAgICAgICAgKytuZXh0SW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKytpbnRvSW5kaWNlc0luOwogICAgICAgICAgICArK2ludG9JbmRpY2VzT3V0OwogICAgICAgICAgfQogICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcyA9IGluZGljZXNPdXQ7CiAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgaW4gYXR0cmlidXRlcykgewogICAgICAgICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkgJiYgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXNbcHJvcGVydHldKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1twcm9wZXJ0eV0udmFsdWVzKSkgewogICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbcHJvcGVydHldOwogICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRzSW4gPSBhdHRyaWJ1dGUudmFsdWVzOwogICAgICAgICAgICAgIGxldCBpbnRvRWxlbWVudHNJbiA9IDA7CiAgICAgICAgICAgICAgY29uc3QgbnVtQ29tcG9uZW50cyA9IGF0dHJpYnV0ZS5jb21wb25lbnRzUGVyQXR0cmlidXRlOwogICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRzT3V0ID0gQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICAgICAgICAgICAgYXR0cmlidXRlLmNvbXBvbmVudERhdGF0eXBlLAogICAgICAgICAgICAgICAgbmV4dEluZGV4ICogbnVtQ29tcG9uZW50cwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgd2hpbGUgKGludG9FbGVtZW50c0luIDwgbnVtVmVydGljZXMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRlbXAgPSBpbmRleENyb3NzUmVmZXJlbmNlT2xkVG9OZXdbaW50b0VsZW1lbnRzSW5dOwogICAgICAgICAgICAgICAgaWYgKHRlbXAgIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbnVtQ29tcG9uZW50czsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudHNPdXRbbnVtQ29tcG9uZW50cyAqIHRlbXAgKyBqXSA9IGVsZW1lbnRzSW5bbnVtQ29tcG9uZW50cyAqIGludG9FbGVtZW50c0luICsgal07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICsraW50b0VsZW1lbnRzSW47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGF0dHJpYnV0ZS52YWx1ZXMgPSBlbGVtZW50c091dDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUucmVvcmRlckZvclBvc3RWZXJ0ZXhDYWNoZSA9IGZ1bmN0aW9uKGdlb21ldHJ5LCBjYWNoZUNhcGFjaXR5KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ2VvbWV0cnkgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGluZGljZXMgPSBnZW9tZXRyeS5pbmRpY2VzOwogICAgICAgIGlmIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTICYmIGRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSkgewogICAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IGluZGljZXMubGVuZ3RoOwogICAgICAgICAgbGV0IG1heGltdW1JbmRleCA9IDA7CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IG51bUluZGljZXM7IGorKykgewogICAgICAgICAgICBpZiAoaW5kaWNlc1tqXSA+IG1heGltdW1JbmRleCkgewogICAgICAgICAgICAgIG1heGltdW1JbmRleCA9IGluZGljZXNbal07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMgPSBUaXBzaWZ5X2RlZmF1bHQudGlwc2lmeSh7CiAgICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAgIG1heGltdW1JbmRleCwKICAgICAgICAgICAgY2FjaGVTaXplOiBjYWNoZUNhcGFjaXR5CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICB9OwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmZpdFRvVW5zaWduZWRTaG9ydEluZGljZXMgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmluZGljZXMpICYmIGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgIT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMgJiYgZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSAhPT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTICYmIGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgIT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5QT0lOVFMpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSBtdXN0IGVxdWFsIHRvIFByaW1pdGl2ZVR5cGUuVFJJQU5HTEVTLCBQcmltaXRpdmVUeXBlLkxJTkVTLCBvciBQcmltaXRpdmVUeXBlLlBPSU5UUy4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyaWVzID0gW107CiAgICAgICAgY29uc3QgbnVtYmVyT2ZWZXJ0aWNlcyA9IEdlb21ldHJ5X2RlZmF1bHQuY29tcHV0ZU51bWJlck9mVmVydGljZXMoZ2VvbWV0cnkpOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuaW5kaWNlcykgJiYgbnVtYmVyT2ZWZXJ0aWNlcyA+PSBNYXRoX2RlZmF1bHQuU0lYVFlfRk9VUl9LSUxPQllURVMpIHsKICAgICAgICAgIGxldCBvbGRUb05ld0luZGV4ID0gW107CiAgICAgICAgICBsZXQgbmV3SW5kaWNlcyA9IFtdOwogICAgICAgICAgbGV0IGN1cnJlbnRJbmRleCA9IDA7CiAgICAgICAgICBsZXQgbmV3QXR0cmlidXRlcyA9IGNvcHlBdHRyaWJ1dGVzRGVzY3JpcHRpb25zKGdlb21ldHJ5LmF0dHJpYnV0ZXMpOwogICAgICAgICAgY29uc3Qgb3JpZ2luYWxJbmRpY2VzID0gZ2VvbWV0cnkuaW5kaWNlczsKICAgICAgICAgIGNvbnN0IG51bWJlck9mSW5kaWNlcyA9IG9yaWdpbmFsSW5kaWNlcy5sZW5ndGg7CiAgICAgICAgICBsZXQgaW5kaWNlc1BlclByaW1pdGl2ZTsKICAgICAgICAgIGlmIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTKSB7CiAgICAgICAgICAgIGluZGljZXNQZXJQcmltaXRpdmUgPSAzOwogICAgICAgICAgfSBlbHNlIGlmIChnZW9tZXRyeS5wcmltaXRpdmVUeXBlID09PSBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMpIHsKICAgICAgICAgICAgaW5kaWNlc1BlclByaW1pdGl2ZSA9IDI7CiAgICAgICAgICB9IGVsc2UgaWYgKGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5QT0lOVFMpIHsKICAgICAgICAgICAgaW5kaWNlc1BlclByaW1pdGl2ZSA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IG51bWJlck9mSW5kaWNlczsgaiArPSBpbmRpY2VzUGVyUHJpbWl0aXZlKSB7CiAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgaW5kaWNlc1BlclByaW1pdGl2ZTsgKytrKSB7CiAgICAgICAgICAgICAgY29uc3QgeCA9IG9yaWdpbmFsSW5kaWNlc1tqICsga107CiAgICAgICAgICAgICAgbGV0IGkgPSBvbGRUb05ld0luZGV4W3hdOwogICAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGkpKSB7CiAgICAgICAgICAgICAgICBpID0gY3VycmVudEluZGV4Kys7CiAgICAgICAgICAgICAgICBvbGRUb05ld0luZGV4W3hdID0gaTsKICAgICAgICAgICAgICAgIGNvcHlWZXJ0ZXgobmV3QXR0cmlidXRlcywgZ2VvbWV0cnkuYXR0cmlidXRlcywgeCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5ld0luZGljZXMucHVzaChpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY3VycmVudEluZGV4ICsgaW5kaWNlc1BlclByaW1pdGl2ZSA+PSBNYXRoX2RlZmF1bHQuU0lYVFlfRk9VUl9LSUxPQllURVMpIHsKICAgICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goCiAgICAgICAgICAgICAgICBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXM6IG5ld0F0dHJpYnV0ZXMsCiAgICAgICAgICAgICAgICAgIGluZGljZXM6IG5ld0luZGljZXMsCiAgICAgICAgICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUsCiAgICAgICAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSwKICAgICAgICAgICAgICAgICAgYm91bmRpbmdTcGhlcmVDVjogZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVgogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIG9sZFRvTmV3SW5kZXggPSBbXTsKICAgICAgICAgICAgICBuZXdJbmRpY2VzID0gW107CiAgICAgICAgICAgICAgY3VycmVudEluZGV4ID0gMDsKICAgICAgICAgICAgICBuZXdBdHRyaWJ1dGVzID0gY29weUF0dHJpYnV0ZXNEZXNjcmlwdGlvbnMoZ2VvbWV0cnkuYXR0cmlidXRlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXdJbmRpY2VzLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goCiAgICAgICAgICAgICAgbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgICAgICAgYXR0cmlidXRlczogbmV3QXR0cmlidXRlcywKICAgICAgICAgICAgICAgIGluZGljZXM6IG5ld0luZGljZXMsCiAgICAgICAgICAgICAgICBwcmltaXRpdmVUeXBlOiBnZW9tZXRyeS5wcmltaXRpdmVUeXBlLAogICAgICAgICAgICAgICAgYm91bmRpbmdTcGhlcmU6IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgICAgICAgYm91bmRpbmdTcGhlcmVDVjogZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVgogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGdlb21ldHJpZXMucHVzaChnZW9tZXRyeSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZW9tZXRyaWVzOwogICAgICB9OwogICAgICBzY3JhdGNoUHJvamVjdFRvMkRDYXJ0ZXNpYW4zID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUHJvamVjdFRvMkRDYXJ0b2dyYXBoaWMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5wcm9qZWN0VG8yRCA9IGZ1bmN0aW9uKGdlb21ldHJ5LCBhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVOYW1lM0QsIGF0dHJpYnV0ZU5hbWUyRCwgcHJvamVjdGlvbikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImF0dHJpYnV0ZU5hbWUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZU5hbWUzRCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVOYW1lM0QgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZU5hbWUyRCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVOYW1lMkQgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgYGdlb21ldHJ5IG11c3QgaGF2ZSBhdHRyaWJ1dGUgbWF0Y2hpbmcgdGhlIGF0dHJpYnV0ZU5hbWUgYXJndW1lbnQ6ICR7YXR0cmlidXRlTmFtZX0uYAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV0uY29tcG9uZW50RGF0YXR5cGUgIT09IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIlRoZSBhdHRyaWJ1dGUgY29tcG9uZW50RGF0YXR5cGUgbXVzdCBiZSBDb21wb25lbnREYXRhdHlwZS5ET1VCTEUuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlID0gZ2VvbWV0cnkuYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXTsKICAgICAgICBwcm9qZWN0aW9uID0gZGVmaW5lZF9kZWZhdWx0KHByb2plY3Rpb24pID8gcHJvamVjdGlvbiA6IG5ldyBHZW9ncmFwaGljUHJvamVjdGlvbl9kZWZhdWx0KCk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcHJvamVjdGlvbi5lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgdmFsdWVzM0QgPSBhdHRyaWJ1dGUudmFsdWVzOwogICAgICAgIGNvbnN0IHByb2plY3RlZFZhbHVlcyA9IG5ldyBGbG9hdDY0QXJyYXkodmFsdWVzM0QubGVuZ3RoKTsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWVzM0QubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgdmFsdWVzM0QsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRlc2lhbjMKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBsb25MYXQgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICBzY3JhdGNoUHJvamVjdFRvMkRDYXJ0b2dyYXBoaWMKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChsb25MYXQpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAgIGBDb3VsZCBub3QgcHJvamVjdCBwb2ludCAoJHt2YWx1ZS54fSwgJHt2YWx1ZS55fSwgJHt2YWx1ZS56fSkgdG8gMkQuYAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcHJvamVjdGVkTG9uTGF0ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgICBsb25MYXQsCiAgICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0VG8yRENhcnRlc2lhbjMKICAgICAgICAgICk7CiAgICAgICAgICBwcm9qZWN0ZWRWYWx1ZXNbaW5kZXgrK10gPSBwcm9qZWN0ZWRMb25MYXQueDsKICAgICAgICAgIHByb2plY3RlZFZhbHVlc1tpbmRleCsrXSA9IHByb2plY3RlZExvbkxhdC55OwogICAgICAgICAgcHJvamVjdGVkVmFsdWVzW2luZGV4KytdID0gcHJvamVjdGVkTG9uTGF0Lno7CiAgICAgICAgfQogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZTNEXSA9IGF0dHJpYnV0ZTsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWUyRF0gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBwcm9qZWN0ZWRWYWx1ZXMKICAgICAgICB9KTsKICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXTsKICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIGVuY29kZWRSZXN1bHQgPSB7CiAgICAgICAgaGlnaDogMCwKICAgICAgICBsb3c6IDAKICAgICAgfTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5lbmNvZGVBdHRyaWJ1dGUgPSBmdW5jdGlvbihnZW9tZXRyeSwgYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlSGlnaE5hbWUsIGF0dHJpYnV0ZUxvd05hbWUpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVOYW1lIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVIaWdoTmFtZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVIaWdoTmFtZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlTG93TmFtZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhdHRyaWJ1dGVMb3dOYW1lIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgIGBnZW9tZXRyeSBtdXN0IGhhdmUgYXR0cmlidXRlIG1hdGNoaW5nIHRoZSBhdHRyaWJ1dGVOYW1lIGFyZ3VtZW50OiAke2F0dHJpYnV0ZU5hbWV9LmAKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdLmNvbXBvbmVudERhdGF0eXBlICE9PSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJUaGUgYXR0cmlidXRlIGNvbXBvbmVudERhdGF0eXBlIG11c3QgYmUgQ29tcG9uZW50RGF0YXR5cGUuRE9VQkxFLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV07CiAgICAgICAgY29uc3QgdmFsdWVzID0gYXR0cmlidXRlLnZhbHVlczsKICAgICAgICBjb25zdCBsZW5ndGggPSB2YWx1ZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IGhpZ2hWYWx1ZXMgPSBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCk7CiAgICAgICAgY29uc3QgbG93VmFsdWVzID0gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIEVuY29kZWRDYXJ0ZXNpYW4zX2RlZmF1bHQuZW5jb2RlKHZhbHVlc1tpXSwgZW5jb2RlZFJlc3VsdCk7CiAgICAgICAgICBoaWdoVmFsdWVzW2ldID0gZW5jb2RlZFJlc3VsdC5oaWdoOwogICAgICAgICAgbG93VmFsdWVzW2ldID0gZW5jb2RlZFJlc3VsdC5sb3c7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgPSBhdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZTsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZUhpZ2hOYW1lXSA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZSwKICAgICAgICAgIHZhbHVlczogaGlnaFZhbHVlcwogICAgICAgIH0pOwogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXNbYXR0cmlidXRlTG93TmFtZV0gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUsCiAgICAgICAgICB2YWx1ZXM6IGxvd1ZhbHVlcwogICAgICAgIH0pOwogICAgICAgIGRlbGV0ZSBnZW9tZXRyeS5hdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdOwogICAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgICAgfTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjMzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBpbnZlcnNlVHJhbnNwb3NlID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBub3JtYWxNYXRyaXggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUudHJhbnNmb3JtVG9Xb3JsZENvb3JkaW5hdGVzID0gZnVuY3Rpb24oaW5zdGFuY2UpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnN0YW5jZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJpbnN0YW5jZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbW9kZWxNYXRyaXggPSBpbnN0YW5jZS5tb2RlbE1hdHJpeDsKICAgICAgICBpZiAoTWF0cml4NF9kZWZhdWx0LmVxdWFscyhtb2RlbE1hdHJpeCwgTWF0cml4NF9kZWZhdWx0LklERU5USVRZKSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gaW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICB0cmFuc2Zvcm1Qb2ludChtb2RlbE1hdHJpeCwgYXR0cmlidXRlcy5wb3NpdGlvbik7CiAgICAgICAgdHJhbnNmb3JtUG9pbnQobW9kZWxNYXRyaXgsIGF0dHJpYnV0ZXMucHJldlBvc2l0aW9uKTsKICAgICAgICB0cmFuc2Zvcm1Qb2ludChtb2RlbE1hdHJpeCwgYXR0cmlidXRlcy5uZXh0UG9zaXRpb24pOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlcy5ub3JtYWwpIHx8IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnRhbmdlbnQpIHx8IGRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLmJpdGFuZ2VudCkpIHsKICAgICAgICAgIE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlKG1vZGVsTWF0cml4LCBpbnZlcnNlVHJhbnNwb3NlKTsKICAgICAgICAgIE1hdHJpeDRfZGVmYXVsdC50cmFuc3Bvc2UoaW52ZXJzZVRyYW5zcG9zZSwgaW52ZXJzZVRyYW5zcG9zZSk7CiAgICAgICAgICBNYXRyaXg0X2RlZmF1bHQuZ2V0TWF0cml4MyhpbnZlcnNlVHJhbnNwb3NlLCBub3JtYWxNYXRyaXgpOwogICAgICAgICAgdHJhbnNmb3JtVmVjdG9yKG5vcm1hbE1hdHJpeCwgYXR0cmlidXRlcy5ub3JtYWwpOwogICAgICAgICAgdHJhbnNmb3JtVmVjdG9yKG5vcm1hbE1hdHJpeCwgYXR0cmlidXRlcy50YW5nZW50KTsKICAgICAgICAgIHRyYW5zZm9ybVZlY3Rvcihub3JtYWxNYXRyaXgsIGF0dHJpYnV0ZXMuYml0YW5nZW50KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBpbnN0YW5jZS5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJvdW5kaW5nU3BoZXJlKSkgewogICAgICAgICAgaW5zdGFuY2UuZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnRyYW5zZm9ybSgKICAgICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICAgIG1vZGVsTWF0cml4LAogICAgICAgICAgICBib3VuZGluZ1NwaGVyZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaW5zdGFuY2UubW9kZWxNYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQuY2xvbmUoTWF0cml4NF9kZWZhdWx0LklERU5USVRZKTsKICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgIH07CiAgICAgIHRlbXBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmNvbWJpbmVJbnN0YW5jZXMgPSBmdW5jdGlvbihpbnN0YW5jZXMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXMpIHx8IGluc3RhbmNlcy5sZW5ndGggPCAxKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgImluc3RhbmNlcyBpcyByZXF1aXJlZCBhbmQgbXVzdCBoYXZlIGxlbmd0aCBncmVhdGVyIHRoYW4gemVyby4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbnN0YW5jZUdlb21ldHJ5ID0gW107CiAgICAgICAgY29uc3QgaW5zdGFuY2VTcGxpdEdlb21ldHJ5ID0gW107CiAgICAgICAgY29uc3QgbGVuZ3RoID0gaW5zdGFuY2VzLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpXTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuZ2VvbWV0cnkpKSB7CiAgICAgICAgICAgIGluc3RhbmNlR2VvbWV0cnkucHVzaChpbnN0YW5jZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5KSAmJiBkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSkpIHsKICAgICAgICAgICAgaW5zdGFuY2VTcGxpdEdlb21ldHJ5LnB1c2goaW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyaWVzID0gW107CiAgICAgICAgaWYgKGluc3RhbmNlR2VvbWV0cnkubGVuZ3RoID4gMCkgewogICAgICAgICAgZ2VvbWV0cmllcy5wdXNoKGNvbWJpbmVHZW9tZXRyaWVzKGluc3RhbmNlR2VvbWV0cnksICJnZW9tZXRyeSIpKTsKICAgICAgICB9CiAgICAgICAgaWYgKGluc3RhbmNlU3BsaXRHZW9tZXRyeS5sZW5ndGggPiAwKSB7CiAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goCiAgICAgICAgICAgIGNvbWJpbmVHZW9tZXRyaWVzKGluc3RhbmNlU3BsaXRHZW9tZXRyeSwgIndlc3RIZW1pc3BoZXJlR2VvbWV0cnkiKQogICAgICAgICAgKTsKICAgICAgICAgIGdlb21ldHJpZXMucHVzaCgKICAgICAgICAgICAgY29tYmluZUdlb21ldHJpZXMoaW5zdGFuY2VTcGxpdEdlb21ldHJ5LCAiZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSIpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VvbWV0cmllczsKICAgICAgfTsKICAgICAgbm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB2MCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdjEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHYyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBHZW9tZXRyeVBpcGVsaW5lLmNvbXB1dGVOb3JtYWwgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyBpcyByZXF1aXJlZC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5pbmRpY2VzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5LmluZGljZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChnZW9tZXRyeS5pbmRpY2VzLmxlbmd0aCA8IDIgfHwgZ2VvbWV0cnkuaW5kaWNlcy5sZW5ndGggJSAzICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgImdlb21ldHJ5LmluZGljZXMgbGVuZ3RoIG11c3QgYmUgZ3JlYXRlciB0aGFuIDAgYW5kIGJlIGEgbXVsdGlwbGUgb2YgMy4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSAhPT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJnZW9tZXRyeS5wcmltaXRpdmVUeXBlIG11c3QgYmUgUHJpbWl0aXZlVHlwZS5UUklBTkdMRVMuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IGdlb21ldHJ5LmluZGljZXM7CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgICAgY29uc3QgdmVydGljZXMgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgICAgICBjb25zdCBudW1WZXJ0aWNlcyA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCAvIDM7CiAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IGluZGljZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IG5vcm1hbHNQZXJWZXJ0ZXggPSBuZXcgQXJyYXkobnVtVmVydGljZXMpOwogICAgICAgIGNvbnN0IG5vcm1hbHNQZXJUcmlhbmdsZSA9IG5ldyBBcnJheShudW1JbmRpY2VzIC8gMyk7CiAgICAgICAgY29uc3Qgbm9ybWFsSW5kaWNlcyA9IG5ldyBBcnJheShudW1JbmRpY2VzKTsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtVmVydGljZXM7IGkrKykgewogICAgICAgICAgbm9ybWFsc1BlclZlcnRleFtpXSA9IHsKICAgICAgICAgICAgaW5kZXhPZmZzZXQ6IDAsCiAgICAgICAgICAgIGNvdW50OiAwLAogICAgICAgICAgICBjdXJyZW50Q291bnQ6IDAKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGxldCBqID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtSW5kaWNlczsgaSArPSAzKSB7CiAgICAgICAgICBjb25zdCBpMCA9IGluZGljZXNbaV07CiAgICAgICAgICBjb25zdCBpMSA9IGluZGljZXNbaSArIDFdOwogICAgICAgICAgY29uc3QgaTIgPSBpbmRpY2VzW2kgKyAyXTsKICAgICAgICAgIGNvbnN0IGkwMyA9IGkwICogMzsKICAgICAgICAgIGNvbnN0IGkxMyA9IGkxICogMzsKICAgICAgICAgIGNvbnN0IGkyMyA9IGkyICogMzsKICAgICAgICAgIHYwLnggPSB2ZXJ0aWNlc1tpMDNdOwogICAgICAgICAgdjAueSA9IHZlcnRpY2VzW2kwMyArIDFdOwogICAgICAgICAgdjAueiA9IHZlcnRpY2VzW2kwMyArIDJdOwogICAgICAgICAgdjEueCA9IHZlcnRpY2VzW2kxM107CiAgICAgICAgICB2MS55ID0gdmVydGljZXNbaTEzICsgMV07CiAgICAgICAgICB2MS56ID0gdmVydGljZXNbaTEzICsgMl07CiAgICAgICAgICB2Mi54ID0gdmVydGljZXNbaTIzXTsKICAgICAgICAgIHYyLnkgPSB2ZXJ0aWNlc1tpMjMgKyAxXTsKICAgICAgICAgIHYyLnogPSB2ZXJ0aWNlc1tpMjMgKyAyXTsKICAgICAgICAgIG5vcm1hbHNQZXJWZXJ0ZXhbaTBdLmNvdW50Kys7CiAgICAgICAgICBub3JtYWxzUGVyVmVydGV4W2kxXS5jb3VudCsrOwogICAgICAgICAgbm9ybWFsc1BlclZlcnRleFtpMl0uY291bnQrKzsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh2MSwgdjAsIHYxKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCh2MiwgdjAsIHYyKTsKICAgICAgICAgIG5vcm1hbHNQZXJUcmlhbmdsZVtqXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh2MSwgdjIsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSk7CiAgICAgICAgICBqKys7CiAgICAgICAgfQogICAgICAgIGxldCBpbmRleE9mZnNldCA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bVZlcnRpY2VzOyBpKyspIHsKICAgICAgICAgIG5vcm1hbHNQZXJWZXJ0ZXhbaV0uaW5kZXhPZmZzZXQgKz0gaW5kZXhPZmZzZXQ7CiAgICAgICAgICBpbmRleE9mZnNldCArPSBub3JtYWxzUGVyVmVydGV4W2ldLmNvdW50OwogICAgICAgIH0KICAgICAgICBqID0gMDsKICAgICAgICBsZXQgdmVydGV4Tm9ybWFsRGF0YTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtSW5kaWNlczsgaSArPSAzKSB7CiAgICAgICAgICB2ZXJ0ZXhOb3JtYWxEYXRhID0gbm9ybWFsc1BlclZlcnRleFtpbmRpY2VzW2ldXTsKICAgICAgICAgIGxldCBpbmRleCA9IHZlcnRleE5vcm1hbERhdGEuaW5kZXhPZmZzZXQgKyB2ZXJ0ZXhOb3JtYWxEYXRhLmN1cnJlbnRDb3VudDsKICAgICAgICAgIG5vcm1hbEluZGljZXNbaW5kZXhdID0gajsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEuY3VycmVudENvdW50Kys7CiAgICAgICAgICB2ZXJ0ZXhOb3JtYWxEYXRhID0gbm9ybWFsc1BlclZlcnRleFtpbmRpY2VzW2kgKyAxXV07CiAgICAgICAgICBpbmRleCA9IHZlcnRleE5vcm1hbERhdGEuaW5kZXhPZmZzZXQgKyB2ZXJ0ZXhOb3JtYWxEYXRhLmN1cnJlbnRDb3VudDsKICAgICAgICAgIG5vcm1hbEluZGljZXNbaW5kZXhdID0gajsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEuY3VycmVudENvdW50Kys7CiAgICAgICAgICB2ZXJ0ZXhOb3JtYWxEYXRhID0gbm9ybWFsc1BlclZlcnRleFtpbmRpY2VzW2kgKyAyXV07CiAgICAgICAgICBpbmRleCA9IHZlcnRleE5vcm1hbERhdGEuaW5kZXhPZmZzZXQgKyB2ZXJ0ZXhOb3JtYWxEYXRhLmN1cnJlbnRDb3VudDsKICAgICAgICAgIG5vcm1hbEluZGljZXNbaW5kZXhdID0gajsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEuY3VycmVudENvdW50Kys7CiAgICAgICAgICBqKys7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5vcm1hbFZhbHVlcyA9IG5ldyBGbG9hdDMyQXJyYXkobnVtVmVydGljZXMgKiAzKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtVmVydGljZXM7IGkrKykgewogICAgICAgICAgY29uc3QgaTMgPSBpICogMzsKICAgICAgICAgIHZlcnRleE5vcm1hbERhdGEgPSBub3JtYWxzUGVyVmVydGV4W2ldOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBub3JtYWwpOwogICAgICAgICAgaWYgKHZlcnRleE5vcm1hbERhdGEuY291bnQgPiAwKSB7CiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCB2ZXJ0ZXhOb3JtYWxEYXRhLmNvdW50OyBqKyspIHsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgbm9ybWFsLAogICAgICAgICAgICAgICAgbm9ybWFsc1BlclRyaWFuZ2xlW25vcm1hbEluZGljZXNbdmVydGV4Tm9ybWFsRGF0YS5pbmRleE9mZnNldCArIGpdXSwKICAgICAgICAgICAgICAgIG5vcm1hbAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBub3JtYWwsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApKSB7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgICAgICAgICAgbm9ybWFsc1BlclRyaWFuZ2xlW25vcm1hbEluZGljZXNbdmVydGV4Tm9ybWFsRGF0YS5pbmRleE9mZnNldF1dLAogICAgICAgICAgICAgICAgbm9ybWFsCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBub3JtYWwsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApKSB7CiAgICAgICAgICAgIG5vcm1hbC56ID0gMTsKICAgICAgICAgIH0KICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobm9ybWFsLCBub3JtYWwpOwogICAgICAgICAgbm9ybWFsVmFsdWVzW2kzXSA9IG5vcm1hbC54OwogICAgICAgICAgbm9ybWFsVmFsdWVzW2kzICsgMV0gPSBub3JtYWwueTsKICAgICAgICAgIG5vcm1hbFZhbHVlc1tpMyArIDJdID0gbm9ybWFsLno7CiAgICAgICAgfQogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBub3JtYWxWYWx1ZXMKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIG5vcm1hbFNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBub3JtYWxTY2FsZSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEdlb21ldHJ5UGlwZWxpbmUuY29tcHV0ZVRhbmdlbnRBbmRCaXRhbmdlbnQgPSBmdW5jdGlvbihnZW9tZXRyeSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICBjb25zdCBpbmRpY2VzID0gZ2VvbWV0cnkuaW5kaWNlczsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnBvc2l0aW9uKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyBpcyByZXF1aXJlZC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLm5vcm1hbCkgfHwgIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ2VvbWV0cnkuYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhdHRyaWJ1dGVzLnN0KSB8fCAhZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXMuc3QudmFsdWVzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5LmF0dHJpYnV0ZXMuc3QudmFsdWVzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdlb21ldHJ5LmluZGljZXMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmIChpbmRpY2VzLmxlbmd0aCA8IDIgfHwgaW5kaWNlcy5sZW5ndGggJSAzICE9PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgImdlb21ldHJ5LmluZGljZXMgbGVuZ3RoIG11c3QgYmUgZ3JlYXRlciB0aGFuIDAgYW5kIGJlIGEgbXVsdGlwbGUgb2YgMy4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSAhPT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJnZW9tZXRyeS5wcmltaXRpdmVUeXBlIG11c3QgYmUgUHJpbWl0aXZlVHlwZS5UUklBTkdMRVMuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmVydGljZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgICAgICBjb25zdCBub3JtYWxzID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzOwogICAgICAgIGNvbnN0IHN0ID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5zdC52YWx1ZXM7CiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGggLyAzOwogICAgICAgIGNvbnN0IG51bUluZGljZXMgPSBpbmRpY2VzLmxlbmd0aDsKICAgICAgICBjb25zdCB0YW4xID0gbmV3IEFycmF5KG51bVZlcnRpY2VzICogMyk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRhbjEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHRhbjFbaV0gPSAwOwogICAgICAgIH0KICAgICAgICBsZXQgaTAzOwogICAgICAgIGxldCBpMTM7CiAgICAgICAgbGV0IGkyMzsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtSW5kaWNlczsgaSArPSAzKSB7CiAgICAgICAgICBjb25zdCBpMCA9IGluZGljZXNbaV07CiAgICAgICAgICBjb25zdCBpMSA9IGluZGljZXNbaSArIDFdOwogICAgICAgICAgY29uc3QgaTIgPSBpbmRpY2VzW2kgKyAyXTsKICAgICAgICAgIGkwMyA9IGkwICogMzsKICAgICAgICAgIGkxMyA9IGkxICogMzsKICAgICAgICAgIGkyMyA9IGkyICogMzsKICAgICAgICAgIGNvbnN0IGkwMiA9IGkwICogMjsKICAgICAgICAgIGNvbnN0IGkxMiA9IGkxICogMjsKICAgICAgICAgIGNvbnN0IGkyMiA9IGkyICogMjsKICAgICAgICAgIGNvbnN0IHV4ID0gdmVydGljZXNbaTAzXTsKICAgICAgICAgIGNvbnN0IHV5ID0gdmVydGljZXNbaTAzICsgMV07CiAgICAgICAgICBjb25zdCB1eiA9IHZlcnRpY2VzW2kwMyArIDJdOwogICAgICAgICAgY29uc3Qgd3ggPSBzdFtpMDJdOwogICAgICAgICAgY29uc3Qgd3kgPSBzdFtpMDIgKyAxXTsKICAgICAgICAgIGNvbnN0IHQxID0gc3RbaTEyICsgMV0gLSB3eTsKICAgICAgICAgIGNvbnN0IHQyID0gc3RbaTIyICsgMV0gLSB3eTsKICAgICAgICAgIGNvbnN0IHIgPSAxIC8gKChzdFtpMTJdIC0gd3gpICogdDIgLSAoc3RbaTIyXSAtIHd4KSAqIHQxKTsKICAgICAgICAgIGNvbnN0IHNkaXJ4ID0gKHQyICogKHZlcnRpY2VzW2kxM10gLSB1eCkgLSB0MSAqICh2ZXJ0aWNlc1tpMjNdIC0gdXgpKSAqIHI7CiAgICAgICAgICBjb25zdCBzZGlyeSA9ICh0MiAqICh2ZXJ0aWNlc1tpMTMgKyAxXSAtIHV5KSAtIHQxICogKHZlcnRpY2VzW2kyMyArIDFdIC0gdXkpKSAqIHI7CiAgICAgICAgICBjb25zdCBzZGlyeiA9ICh0MiAqICh2ZXJ0aWNlc1tpMTMgKyAyXSAtIHV6KSAtIHQxICogKHZlcnRpY2VzW2kyMyArIDJdIC0gdXopKSAqIHI7CiAgICAgICAgICB0YW4xW2kwM10gKz0gc2Rpcng7CiAgICAgICAgICB0YW4xW2kwMyArIDFdICs9IHNkaXJ5OwogICAgICAgICAgdGFuMVtpMDMgKyAyXSArPSBzZGlyejsKICAgICAgICAgIHRhbjFbaTEzXSArPSBzZGlyeDsKICAgICAgICAgIHRhbjFbaTEzICsgMV0gKz0gc2Rpcnk7CiAgICAgICAgICB0YW4xW2kxMyArIDJdICs9IHNkaXJ6OwogICAgICAgICAgdGFuMVtpMjNdICs9IHNkaXJ4OwogICAgICAgICAgdGFuMVtpMjMgKyAxXSArPSBzZGlyeTsKICAgICAgICAgIHRhbjFbaTIzICsgMl0gKz0gc2Rpcno7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRhbmdlbnRWYWx1ZXMgPSBuZXcgRmxvYXQzMkFycmF5KG51bVZlcnRpY2VzICogMyk7CiAgICAgICAgY29uc3QgYml0YW5nZW50VmFsdWVzID0gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0aWNlcyAqIDMpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgaSsrKSB7CiAgICAgICAgICBpMDMgPSBpICogMzsKICAgICAgICAgIGkxMyA9IGkwMyArIDE7CiAgICAgICAgICBpMjMgPSBpMDMgKyAyOwogICAgICAgICAgY29uc3QgbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobm9ybWFscywgaTAzLCBub3JtYWxTY3JhdGNoMik7CiAgICAgICAgICBjb25zdCB0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh0YW4xLCBpMDMsIHRTY3JhdGNoKTsKICAgICAgICAgIGNvbnN0IHNjYWxhciA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QobiwgdCk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuLCBzY2FsYXIsIG5vcm1hbFNjYWxlKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHQsIG5vcm1hbFNjYWxlLCB0KSwgdCk7CiAgICAgICAgICB0YW5nZW50VmFsdWVzW2kwM10gPSB0Lng7CiAgICAgICAgICB0YW5nZW50VmFsdWVzW2kxM10gPSB0Lnk7CiAgICAgICAgICB0YW5nZW50VmFsdWVzW2kyM10gPSB0Lno7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhuLCB0LCB0KSwgdCk7CiAgICAgICAgICBiaXRhbmdlbnRWYWx1ZXNbaTAzXSA9IHQueDsKICAgICAgICAgIGJpdGFuZ2VudFZhbHVlc1tpMTNdID0gdC55OwogICAgICAgICAgYml0YW5nZW50VmFsdWVzW2kyM10gPSB0Lno7CiAgICAgICAgfQogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogdGFuZ2VudFZhbHVlcwogICAgICAgIH0pOwogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuYml0YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBiaXRhbmdlbnRWYWx1ZXMKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yMiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgdG9FbmNvZGUxID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0b0VuY29kZTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHRvRW5jb2RlMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZW5jb2RlUmVzdWx0MiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgR2VvbWV0cnlQaXBlbGluZS5jb21wcmVzc1ZlcnRpY2VzID0gZnVuY3Rpb24oZ2VvbWV0cnkpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJnZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZXh0cnVkZUF0dHJpYnV0ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbjsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgbnVtVmVydGljZXM7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChleHRydWRlQXR0cmlidXRlKSkgewogICAgICAgICAgY29uc3QgZXh0cnVkZURpcmVjdGlvbnMgPSBleHRydWRlQXR0cmlidXRlLnZhbHVlczsKICAgICAgICAgIG51bVZlcnRpY2VzID0gZXh0cnVkZURpcmVjdGlvbnMubGVuZ3RoIC8gMzsKICAgICAgICAgIGNvbnN0IGNvbXByZXNzZWREaXJlY3Rpb25zID0gbmV3IEZsb2F0MzJBcnJheShudW1WZXJ0aWNlcyAqIDIpOwogICAgICAgICAgbGV0IGkyID0gMDsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgKytpKSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZXh0cnVkZURpcmVjdGlvbnMsIGkgKiAzLCB0b0VuY29kZTEpOwogICAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyh0b0VuY29kZTEsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICAgICAgICAgIGkyICs9IDI7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZW5jb2RlUmVzdWx0MiA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQub2N0RW5jb2RlSW5SYW5nZSgKICAgICAgICAgICAgICB0b0VuY29kZTEsCiAgICAgICAgICAgICAgNjU1MzUsCiAgICAgICAgICAgICAgZW5jb2RlUmVzdWx0MgogICAgICAgICAgICApOwogICAgICAgICAgICBjb21wcmVzc2VkRGlyZWN0aW9uc1tpMisrXSA9IGVuY29kZVJlc3VsdDIueDsKICAgICAgICAgICAgY29tcHJlc3NlZERpcmVjdGlvbnNbaTIrK10gPSBlbmNvZGVSZXN1bHQyLnk7CiAgICAgICAgICB9CiAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmNvbXByZXNzZWRBdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgdmFsdWVzOiBjb21wcmVzc2VkRGlyZWN0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uOwogICAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICAgIH0KICAgICAgICBjb25zdCBub3JtYWxBdHRyaWJ1dGUgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLm5vcm1hbDsKICAgICAgICBjb25zdCBzdEF0dHJpYnV0ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMuc3Q7CiAgICAgICAgY29uc3QgaGFzTm9ybWFsID0gZGVmaW5lZF9kZWZhdWx0KG5vcm1hbEF0dHJpYnV0ZSk7CiAgICAgICAgY29uc3QgaGFzU3QgPSBkZWZpbmVkX2RlZmF1bHQoc3RBdHRyaWJ1dGUpOwogICAgICAgIGlmICghaGFzTm9ybWFsICYmICFoYXNTdCkgewogICAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICAgIH0KICAgICAgICBjb25zdCB0YW5nZW50QXR0cmlidXRlID0gZ2VvbWV0cnkuYXR0cmlidXRlcy50YW5nZW50OwogICAgICAgIGNvbnN0IGJpdGFuZ2VudEF0dHJpYnV0ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMuYml0YW5nZW50OwogICAgICAgIGNvbnN0IGhhc1RhbmdlbnQgPSBkZWZpbmVkX2RlZmF1bHQodGFuZ2VudEF0dHJpYnV0ZSk7CiAgICAgICAgY29uc3QgaGFzQml0YW5nZW50ID0gZGVmaW5lZF9kZWZhdWx0KGJpdGFuZ2VudEF0dHJpYnV0ZSk7CiAgICAgICAgbGV0IG5vcm1hbHM7CiAgICAgICAgbGV0IHN0OwogICAgICAgIGxldCB0YW5nZW50czsKICAgICAgICBsZXQgYml0YW5nZW50czsKICAgICAgICBpZiAoaGFzTm9ybWFsKSB7CiAgICAgICAgICBub3JtYWxzID0gbm9ybWFsQXR0cmlidXRlLnZhbHVlczsKICAgICAgICB9CiAgICAgICAgaWYgKGhhc1N0KSB7CiAgICAgICAgICBzdCA9IHN0QXR0cmlidXRlLnZhbHVlczsKICAgICAgICB9CiAgICAgICAgaWYgKGhhc1RhbmdlbnQpIHsKICAgICAgICAgIHRhbmdlbnRzID0gdGFuZ2VudEF0dHJpYnV0ZS52YWx1ZXM7CiAgICAgICAgfQogICAgICAgIGlmIChoYXNCaXRhbmdlbnQpIHsKICAgICAgICAgIGJpdGFuZ2VudHMgPSBiaXRhbmdlbnRBdHRyaWJ1dGUudmFsdWVzOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBoYXNOb3JtYWwgPyBub3JtYWxzLmxlbmd0aCA6IHN0Lmxlbmd0aDsKICAgICAgICBjb25zdCBudW1Db21wb25lbnRzID0gaGFzTm9ybWFsID8gMyA6IDI7CiAgICAgICAgbnVtVmVydGljZXMgPSBsZW5ndGggLyBudW1Db21wb25lbnRzOwogICAgICAgIGxldCBjb21wcmVzc2VkTGVuZ3RoID0gbnVtVmVydGljZXM7CiAgICAgICAgbGV0IG51bUNvbXByZXNzZWRDb21wb25lbnRzID0gaGFzU3QgJiYgaGFzTm9ybWFsID8gMiA6IDE7CiAgICAgICAgbnVtQ29tcHJlc3NlZENvbXBvbmVudHMgKz0gaGFzVGFuZ2VudCB8fCBoYXNCaXRhbmdlbnQgPyAxIDogMDsKICAgICAgICBjb21wcmVzc2VkTGVuZ3RoICo9IG51bUNvbXByZXNzZWRDb21wb25lbnRzOwogICAgICAgIGNvbnN0IGNvbXByZXNzZWRBdHRyaWJ1dGVzID0gbmV3IEZsb2F0MzJBcnJheShjb21wcmVzc2VkTGVuZ3RoKTsKICAgICAgICBsZXQgbm9ybWFsSW5kZXggPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgKytpKSB7CiAgICAgICAgICBpZiAoaGFzU3QpIHsKICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21BcnJheShzdCwgaSAqIDIsIHNjcmF0Y2hDYXJ0ZXNpYW4yMik7CiAgICAgICAgICAgIGNvbXByZXNzZWRBdHRyaWJ1dGVzW25vcm1hbEluZGV4KytdID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5jb21wcmVzc1RleHR1cmVDb29yZGluYXRlcyhzY3JhdGNoQ2FydGVzaWFuMjIpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgaW5kZXggPSBpICogMzsKICAgICAgICAgIGlmIChoYXNOb3JtYWwgJiYgZGVmaW5lZF9kZWZhdWx0KHRhbmdlbnRzKSAmJiBkZWZpbmVkX2RlZmF1bHQoYml0YW5nZW50cykpIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShub3JtYWxzLCBpbmRleCwgdG9FbmNvZGUxKTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh0YW5nZW50cywgaW5kZXgsIHRvRW5jb2RlMik7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoYml0YW5nZW50cywgaW5kZXgsIHRvRW5jb2RlMyk7CiAgICAgICAgICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQub2N0UGFjaygKICAgICAgICAgICAgICB0b0VuY29kZTEsCiAgICAgICAgICAgICAgdG9FbmNvZGUyLAogICAgICAgICAgICAgIHRvRW5jb2RlMywKICAgICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMjIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZXNbbm9ybWFsSW5kZXgrK10gPSBzY3JhdGNoQ2FydGVzaWFuMjIueDsKICAgICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZXNbbm9ybWFsSW5kZXgrK10gPSBzY3JhdGNoQ2FydGVzaWFuMjIueTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChoYXNOb3JtYWwpIHsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KG5vcm1hbHMsIGluZGV4LCB0b0VuY29kZTEpOwogICAgICAgICAgICAgIGNvbXByZXNzZWRBdHRyaWJ1dGVzW25vcm1hbEluZGV4KytdID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5vY3RFbmNvZGVGbG9hdCh0b0VuY29kZTEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNUYW5nZW50KSB7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh0YW5nZW50cywgaW5kZXgsIHRvRW5jb2RlMSk7CiAgICAgICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZXNbbm9ybWFsSW5kZXgrK10gPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0Lm9jdEVuY29kZUZsb2F0KHRvRW5jb2RlMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc0JpdGFuZ2VudCkgewogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoYml0YW5nZW50cywgaW5kZXgsIHRvRW5jb2RlMSk7CiAgICAgICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZXNbbm9ybWFsSW5kZXgrK10gPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0Lm9jdEVuY29kZUZsb2F0KHRvRW5jb2RlMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5jb21wcmVzc2VkQXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogbnVtQ29tcHJlc3NlZENvbXBvbmVudHMsCiAgICAgICAgICB2YWx1ZXM6IGNvbXByZXNzZWRBdHRyaWJ1dGVzCiAgICAgICAgfSk7CiAgICAgICAgaWYgKGhhc05vcm1hbCkgewogICAgICAgICAgZGVsZXRlIGdlb21ldHJ5LmF0dHJpYnV0ZXMubm9ybWFsOwogICAgICAgIH0KICAgICAgICBpZiAoaGFzU3QpIHsKICAgICAgICAgIGRlbGV0ZSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnN0OwogICAgICAgIH0KICAgICAgICBpZiAoaGFzQml0YW5nZW50KSB7CiAgICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlcy5iaXRhbmdlbnQ7CiAgICAgICAgfQogICAgICAgIGlmIChoYXNUYW5nZW50KSB7CiAgICAgICAgICBkZWxldGUgZ2VvbWV0cnkuYXR0cmlidXRlcy50YW5nZW50OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIGMzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB1MSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHExID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBxMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3BsaXRUcmlhbmdsZVJlc3VsdCA9IHsKICAgICAgICBwb3NpdGlvbnM6IG5ldyBBcnJheSg3KSwKICAgICAgICBpbmRpY2VzOiBuZXcgQXJyYXkoMyAqIDMpCiAgICAgIH07CiAgICAgIGludGVycG9sYXRlQW5kUGFja0NhcnRlc2lhbjQgPSBnZW5lcmF0ZUJhcnljZW50cmljSW50ZXJwb2xhdGVGdW5jdGlvbigKICAgICAgICBDYXJ0ZXNpYW40X2RlZmF1bHQsCiAgICAgICAgNAogICAgICApOwogICAgICBpbnRlcnBvbGF0ZUFuZFBhY2tDYXJ0ZXNpYW4zID0gZ2VuZXJhdGVCYXJ5Y2VudHJpY0ludGVycG9sYXRlRnVuY3Rpb24oCiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LAogICAgICAgIDMKICAgICAgKTsKICAgICAgaW50ZXJwb2xhdGVBbmRQYWNrQ2FydGVzaWFuMiA9IGdlbmVyYXRlQmFyeWNlbnRyaWNJbnRlcnBvbGF0ZUZ1bmN0aW9uKAogICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdCwKICAgICAgICAyCiAgICAgICk7CiAgICAgIGludGVycG9sYXRlQW5kUGFja0Jvb2xlYW4gPSBmdW5jdGlvbihpMCwgaTEsIGkyLCBjb29yZHMsIHNvdXJjZVZhbHVlcywgY3VycmVudFZhbHVlcywgaW5zZXJ0ZWRJbmRleCkgewogICAgICAgIGNvbnN0IHYxMiA9IHNvdXJjZVZhbHVlc1tpMF0gKiBjb29yZHMueDsKICAgICAgICBjb25zdCB2MjIgPSBzb3VyY2VWYWx1ZXNbaTFdICogY29vcmRzLnk7CiAgICAgICAgY29uc3QgdjMgPSBzb3VyY2VWYWx1ZXNbaTJdICogY29vcmRzLno7CiAgICAgICAgY3VycmVudFZhbHVlc1tpbnNlcnRlZEluZGV4XSA9IHYxMiArIHYyMiArIHYzID4gTWF0aF9kZWZhdWx0LkVQU0lMT042ID8gMSA6IDA7CiAgICAgIH07CiAgICAgIHAwU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcDFTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwMlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGJhcnljZW50cmljU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgTkFNRURfQVRUUklCVVRFUyA9IHsKICAgICAgICBwb3NpdGlvbjogdHJ1ZSwKICAgICAgICBub3JtYWw6IHRydWUsCiAgICAgICAgYml0YW5nZW50OiB0cnVlLAogICAgICAgIHRhbmdlbnQ6IHRydWUsCiAgICAgICAgc3Q6IHRydWUsCiAgICAgICAgZXh0cnVkZURpcmVjdGlvbjogdHJ1ZSwKICAgICAgICBhcHBseU9mZnNldDogdHJ1ZQogICAgICB9OwogICAgICB4elBsYW5lID0gUGxhbmVfZGVmYXVsdC5mcm9tUG9pbnROb3JtYWwoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1kpOwogICAgICBvZmZzZXRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBvZmZzZXRQb2ludFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjJTY3JhdGNoMCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuMlNjcmF0Y2gxID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjNTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjNTY3JhdGNoNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2g2ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW40U2NyYXRjaDAgPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgIG9mZnNldFNjYWxhciA9IDUgKiBNYXRoX2RlZmF1bHQuRVBTSUxPTjk7CiAgICAgIGNvcGxhbmFyT2Zmc2V0ID0gTWF0aF9kZWZhdWx0LkVQU0lMT042OwogICAgICBHZW9tZXRyeVBpcGVsaW5lLnNwbGl0TG9uZ2l0dWRlID0gZnVuY3Rpb24oaW5zdGFuY2UpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnN0YW5jZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJpbnN0YW5jZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBpbnN0YW5jZS5nZW9tZXRyeTsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYm91bmRpbmdTcGhlcmUpKSB7CiAgICAgICAgICBjb25zdCBtaW5YID0gYm91bmRpbmdTcGhlcmUuY2VudGVyLnggLSBib3VuZGluZ1NwaGVyZS5yYWRpdXM7CiAgICAgICAgICBpZiAobWluWCA+IDAgfHwgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5pbnRlcnNlY3RQbGFuZShib3VuZGluZ1NwaGVyZSwgUGxhbmVfZGVmYXVsdC5PUklHSU5fWlhfUExBTkUpICE9PSBJbnRlcnNlY3RfZGVmYXVsdC5JTlRFUlNFQ1RJTkcpIHsKICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZ2VvbWV0cnkuZ2VvbWV0cnlUeXBlICE9PSBHZW9tZXRyeVR5cGVfZGVmYXVsdC5OT05FKSB7CiAgICAgICAgICBzd2l0Y2ggKGdlb21ldHJ5Lmdlb21ldHJ5VHlwZSkgewogICAgICAgICAgICBjYXNlIEdlb21ldHJ5VHlwZV9kZWZhdWx0LlBPTFlMSU5FUzoKICAgICAgICAgICAgICBzcGxpdExvbmdpdHVkZVBvbHlsaW5lKGluc3RhbmNlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBHZW9tZXRyeVR5cGVfZGVmYXVsdC5UUklBTkdMRVM6CiAgICAgICAgICAgICAgc3BsaXRMb25naXR1ZGVUcmlhbmdsZXMoaW5zdGFuY2UpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIEdlb21ldHJ5VHlwZV9kZWZhdWx0LkxJTkVTOgogICAgICAgICAgICAgIHNwbGl0TG9uZ2l0dWRlTGluZXMoaW5zdGFuY2UpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpbmRleFByaW1pdGl2ZShnZW9tZXRyeSk7CiAgICAgICAgICBpZiAoZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSA9PT0gUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUykgewogICAgICAgICAgICBzcGxpdExvbmdpdHVkZVRyaWFuZ2xlcyhpbnN0YW5jZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUgPT09IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUykgewogICAgICAgICAgICBzcGxpdExvbmdpdHVkZUxpbmVzKGluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICB9OwogICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQgPSBHZW9tZXRyeVBpcGVsaW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZS5qcwogIGZ1bmN0aW9uIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUoeCwgeSwgeikgewogICAgeCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHgsIDApOwogICAgeSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHksIDApOwogICAgeiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHosIDApOwogICAgdGhpcy52YWx1ZSA9IG5ldyBGbG9hdDMyQXJyYXkoW3gsIHksIHpdKTsKICB9CiAgdmFyIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGVfZGVmYXVsdDsKICB2YXIgaW5pdF9PZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9PZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhPZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBkYXRhdHlwZSBvZiBlYWNoIGNvbXBvbmVudCBpbiB0aGUgYXR0cmlidXRlLCBlLmcuLCBpbmRpdmlkdWFsIGVsZW1lbnRzIGluCiAgICAgICAgICoge0BsaW5rIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUjdmFsdWV9LgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7Q29tcG9uZW50RGF0YXR5cGV9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICoKICAgICAgICAgKiBAZGVmYXVsdCB7QGxpbmsgQ29tcG9uZW50RGF0YXR5cGUuRkxPQVR9CiAgICAgICAgICovCiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FUOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG51bWJlciBvZiBjb21wb25lbnRzIGluIHRoZSBhdHRyaWJ1dGVzLCBpLmUuLCB7QGxpbmsgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZSN2YWx1ZX0uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZS5wcm90b3R5cGUKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICoKICAgICAgICAgKiBAZGVmYXVsdCAzCiAgICAgICAgICovCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIDM7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBXaGVuIDxjb2RlPnRydWU8L2NvZGU+IGFuZCA8Y29kZT5jb21wb25lbnREYXRhdHlwZTwvY29kZT4gaXMgYW4gaW50ZWdlciBmb3JtYXQsCiAgICAgICAgICogaW5kaWNhdGUgdGhhdCB0aGUgY29tcG9uZW50cyBzaG91bGQgYmUgbWFwcGVkIHRvIHRoZSByYW5nZSBbMCwgMV0gKHVuc2lnbmVkKQogICAgICAgICAqIG9yIFstMSwgMV0gKHNpZ25lZCkgd2hlbiB0aGV5IGFyZSBhY2Nlc3NlZCBhcyBmbG9hdGluZy1wb2ludCBmb3IgcmVuZGVyaW5nLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlcm9mIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKgogICAgICAgICAqIEBkZWZhdWx0IGZhbHNlCiAgICAgICAgICovCiAgICAgICAgbm9ybWFsaXplOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZS5mcm9tQ2FydGVzaWFuMyA9IGZ1bmN0aW9uKG9mZnNldCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib2Zmc2V0Iiwgb2Zmc2V0KTsKICAgICAgICByZXR1cm4gbmV3IE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUob2Zmc2V0LngsIG9mZnNldC55LCBvZmZzZXQueik7CiAgICAgIH07CiAgICAgIE9mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUudG9WYWx1ZSA9IGZ1bmN0aW9uKG9mZnNldCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvZmZzZXQiLCBvZmZzZXQpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBGbG9hdDMyQXJyYXkoW29mZnNldC54LCBvZmZzZXQueSwgb2Zmc2V0LnpdKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0WzBdID0gb2Zmc2V0Lng7CiAgICAgICAgcmVzdWx0WzFdID0gb2Zmc2V0Lnk7CiAgICAgICAgcmVzdWx0WzJdID0gb2Zmc2V0Lno7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZV9kZWZhdWx0ID0gT2Zmc2V0R2VvbWV0cnlJbnN0YW5jZUF0dHJpYnV0ZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dlYk1lcmNhdG9yUHJvamVjdGlvbi5qcwogIGZ1bmN0aW9uIFdlYk1lcmNhdG9yUHJvamVjdGlvbihlbGxpcHNvaWQpIHsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgdGhpcy5fc2VtaW1ham9yQXhpcyA9IHRoaXMuX2VsbGlwc29pZC5tYXhpbXVtUmFkaXVzOwogICAgdGhpcy5fb25lT3ZlclNlbWltYWpvckF4aXMgPSAxIC8gdGhpcy5fc2VtaW1ham9yQXhpczsKICB9CiAgdmFyIFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0OwogIHZhciBpbml0X1dlYk1lcmNhdG9yUHJvamVjdGlvbiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2ViTWVyY2F0b3JQcm9qZWN0aW9uLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhXZWJNZXJjYXRvclByb2plY3Rpb24ucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUge0BsaW5rIEVsbGlwc29pZH0uCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgV2ViTWVyY2F0b3JQcm9qZWN0aW9uLnByb3RvdHlwZQogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgV2ViTWVyY2F0b3JQcm9qZWN0aW9uLm1lcmNhdG9yQW5nbGVUb0dlb2RldGljTGF0aXR1ZGUgPSBmdW5jdGlvbihtZXJjYXRvckFuZ2xlKSB7CiAgICAgICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIDIgKiBNYXRoLmF0YW4oTWF0aC5leHAoLW1lcmNhdG9yQW5nbGUpKTsKICAgICAgfTsKICAgICAgV2ViTWVyY2F0b3JQcm9qZWN0aW9uLmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUgPSBmdW5jdGlvbihsYXRpdHVkZSkgewogICAgICAgIGlmIChsYXRpdHVkZSA+IFdlYk1lcmNhdG9yUHJvamVjdGlvbi5NYXhpbXVtTGF0aXR1ZGUpIHsKICAgICAgICAgIGxhdGl0dWRlID0gV2ViTWVyY2F0b3JQcm9qZWN0aW9uLk1heGltdW1MYXRpdHVkZTsKICAgICAgICB9IGVsc2UgaWYgKGxhdGl0dWRlIDwgLVdlYk1lcmNhdG9yUHJvamVjdGlvbi5NYXhpbXVtTGF0aXR1ZGUpIHsKICAgICAgICAgIGxhdGl0dWRlID0gLVdlYk1lcmNhdG9yUHJvamVjdGlvbi5NYXhpbXVtTGF0aXR1ZGU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNpbkxhdGl0dWRlID0gTWF0aC5zaW4obGF0aXR1ZGUpOwogICAgICAgIHJldHVybiAwLjUgKiBNYXRoLmxvZygoMSArIHNpbkxhdGl0dWRlKSAvICgxIC0gc2luTGF0aXR1ZGUpKTsKICAgICAgfTsKICAgICAgV2ViTWVyY2F0b3JQcm9qZWN0aW9uLk1heGltdW1MYXRpdHVkZSA9IFdlYk1lcmNhdG9yUHJvamVjdGlvbi5tZXJjYXRvckFuZ2xlVG9HZW9kZXRpY0xhdGl0dWRlKAogICAgICAgIE1hdGguUEkKICAgICAgKTsKICAgICAgV2ViTWVyY2F0b3JQcm9qZWN0aW9uLnByb3RvdHlwZS5wcm9qZWN0ID0gZnVuY3Rpb24oY2FydG9ncmFwaGljMiwgcmVzdWx0KSB7CiAgICAgICAgY29uc3Qgc2VtaW1ham9yQXhpcyA9IHRoaXMuX3NlbWltYWpvckF4aXM7CiAgICAgICAgY29uc3QgeCA9IGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlICogc2VtaW1ham9yQXhpczsKICAgICAgICBjb25zdCB5ID0gV2ViTWVyY2F0b3JQcm9qZWN0aW9uLmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoCiAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlCiAgICAgICAgKSAqIHNlbWltYWpvckF4aXM7CiAgICAgICAgY29uc3QgeiA9IGNhcnRvZ3JhcGhpYzIuaGVpZ2h0OwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHgsIHksIHopOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IHg7CiAgICAgICAgcmVzdWx0LnkgPSB5OwogICAgICAgIHJlc3VsdC56ID0gejsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBXZWJNZXJjYXRvclByb2plY3Rpb24ucHJvdG90eXBlLnVucHJvamVjdCA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjYXJ0ZXNpYW4xMSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjYXJ0ZXNpYW4gaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb25lT3ZlckVhcnRoU2VtaW1ham9yQXhpcyA9IHRoaXMuX29uZU92ZXJTZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IGNhcnRlc2lhbjExLnggKiBvbmVPdmVyRWFydGhTZW1pbWFqb3JBeGlzOwogICAgICAgIGNvbnN0IGxhdGl0dWRlID0gV2ViTWVyY2F0b3JQcm9qZWN0aW9uLm1lcmNhdG9yQW5nbGVUb0dlb2RldGljTGF0aXR1ZGUoCiAgICAgICAgICBjYXJ0ZXNpYW4xMS55ICogb25lT3ZlckVhcnRoU2VtaW1ham9yQXhpcwogICAgICAgICk7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gY2FydGVzaWFuMTEuejsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IGhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdCA9IFdlYk1lcmNhdG9yUHJvamVjdGlvbjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9TY2VuZS9QcmltaXRpdmVQaXBlbGluZS5qcwogIGZ1bmN0aW9uIHRyYW5zZm9ybVRvV29ybGRDb29yZGluYXRlcyhpbnN0YW5jZXMsIHByaW1pdGl2ZU1vZGVsTWF0cml4LCBzY2VuZTNET25seSkgewogICAgbGV0IHRvV29ybGQgPSAhc2NlbmUzRE9ubHk7CiAgICBjb25zdCBsZW5ndGggPSBpbnN0YW5jZXMubGVuZ3RoOwogICAgbGV0IGk7CiAgICBpZiAoIXRvV29ybGQgJiYgbGVuZ3RoID4gMSkgewogICAgICBjb25zdCBtb2RlbE1hdHJpeCA9IGluc3RhbmNlc1swXS5tb2RlbE1hdHJpeDsKICAgICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgaWYgKCFNYXRyaXg0X2RlZmF1bHQuZXF1YWxzKG1vZGVsTWF0cml4LCBpbnN0YW5jZXNbaV0ubW9kZWxNYXRyaXgpKSB7CiAgICAgICAgICB0b1dvcmxkID0gdHJ1ZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHRvV29ybGQpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZXNbaV0uZ2VvbWV0cnkpKSB7CiAgICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQudHJhbnNmb3JtVG9Xb3JsZENvb3JkaW5hdGVzKGluc3RhbmNlc1tpXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlUcmFuc2Zvcm1hdGlvbigKICAgICAgICBwcmltaXRpdmVNb2RlbE1hdHJpeCwKICAgICAgICBpbnN0YW5jZXNbMF0ubW9kZWxNYXRyaXgsCiAgICAgICAgcHJpbWl0aXZlTW9kZWxNYXRyaXgKICAgICAgKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gYWRkR2VvbWV0cnlCYXRjaElkKGdlb21ldHJ5LCBiYXRjaElkKSB7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgIGNvbnN0IHBvc2l0aW9uQXR0ciA9IGF0dHJpYnV0ZXMucG9zaXRpb247CiAgICBjb25zdCBudW1iZXJPZkNvbXBvbmVudHMgPSBwb3NpdGlvbkF0dHIudmFsdWVzLmxlbmd0aCAvIHBvc2l0aW9uQXR0ci5jb21wb25lbnRzUGVyQXR0cmlidXRlOwogICAgYXR0cmlidXRlcy5iYXRjaElkID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgdmFsdWVzOiBuZXcgRmxvYXQzMkFycmF5KG51bWJlck9mQ29tcG9uZW50cykKICAgIH0pOwogICAgY29uc3QgdmFsdWVzID0gYXR0cmlidXRlcy5iYXRjaElkLnZhbHVlczsKICAgIGZvciAobGV0IGogPSAwOyBqIDwgbnVtYmVyT2ZDb21wb25lbnRzOyArK2opIHsKICAgICAgdmFsdWVzW2pdID0gYmF0Y2hJZDsKICAgIH0KICB9CiAgZnVuY3Rpb24gYWRkQmF0Y2hJZHMoaW5zdGFuY2VzKSB7CiAgICBjb25zdCBsZW5ndGggPSBpbnN0YW5jZXMubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpXTsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS5nZW9tZXRyeSkpIHsKICAgICAgICBhZGRHZW9tZXRyeUJhdGNoSWQoaW5zdGFuY2UuZ2VvbWV0cnksIGkpOwogICAgICB9IGVsc2UgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5KSAmJiBkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSkpIHsKICAgICAgICBhZGRHZW9tZXRyeUJhdGNoSWQoaW5zdGFuY2Uud2VzdEhlbWlzcGhlcmVHZW9tZXRyeSwgaSk7CiAgICAgICAgYWRkR2VvbWV0cnlCYXRjaElkKGluc3RhbmNlLmVhc3RIZW1pc3BoZXJlR2VvbWV0cnksIGkpOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdlb21ldHJ5UGlwZWxpbmUocGFyYW1ldGVycykgewogICAgY29uc3QgaW5zdGFuY2VzID0gcGFyYW1ldGVycy5pbnN0YW5jZXM7CiAgICBjb25zdCBwcm9qZWN0aW9uID0gcGFyYW1ldGVycy5wcm9qZWN0aW9uOwogICAgY29uc3QgdWludEluZGV4U3VwcG9ydCA9IHBhcmFtZXRlcnMuZWxlbWVudEluZGV4VWludFN1cHBvcnRlZDsKICAgIGNvbnN0IHNjZW5lM0RPbmx5ID0gcGFyYW1ldGVycy5zY2VuZTNET25seTsKICAgIGNvbnN0IHZlcnRleENhY2hlT3B0aW1pemUgPSBwYXJhbWV0ZXJzLnZlcnRleENhY2hlT3B0aW1pemU7CiAgICBjb25zdCBjb21wcmVzc1ZlcnRpY2VzID0gcGFyYW1ldGVycy5jb21wcmVzc1ZlcnRpY2VzOwogICAgY29uc3QgbW9kZWxNYXRyaXggPSBwYXJhbWV0ZXJzLm1vZGVsTWF0cml4OwogICAgbGV0IGk7CiAgICBsZXQgZ2VvbWV0cnk7CiAgICBsZXQgcHJpbWl0aXZlVHlwZTsKICAgIGxldCBsZW5ndGggPSBpbnN0YW5jZXMubGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2VzW2ldLmdlb21ldHJ5KSkgewogICAgICAgIHByaW1pdGl2ZVR5cGUgPSBpbnN0YW5jZXNbaV0uZ2VvbWV0cnkucHJpbWl0aXZlVHlwZTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2VzW2ldLmdlb21ldHJ5KSAmJiBpbnN0YW5jZXNbaV0uZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSAhPT0gcHJpbWl0aXZlVHlwZSkgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgIkFsbCBpbnN0YW5jZSBnZW9tZXRyaWVzIG11c3QgaGF2ZSB0aGUgc2FtZSBwcmltaXRpdmVUeXBlLiIKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICB0cmFuc2Zvcm1Ub1dvcmxkQ29vcmRpbmF0ZXMoaW5zdGFuY2VzLCBtb2RlbE1hdHJpeCwgc2NlbmUzRE9ubHkpOwogICAgaWYgKCFzY2VuZTNET25seSkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlc1tpXS5nZW9tZXRyeSkpIHsKICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5zcGxpdExvbmdpdHVkZShpbnN0YW5jZXNbaV0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgYWRkQmF0Y2hJZHMoaW5zdGFuY2VzKTsKICAgIGlmICh2ZXJ0ZXhDYWNoZU9wdGltaXplKSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VzW2ldOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuZ2VvbWV0cnkpKSB7CiAgICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQucmVvcmRlckZvclBvc3RWZXJ0ZXhDYWNoZShpbnN0YW5jZS5nZW9tZXRyeSk7CiAgICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQucmVvcmRlckZvclByZVZlcnRleENhY2hlKGluc3RhbmNlLmdlb21ldHJ5KTsKICAgICAgICB9IGVsc2UgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5KSAmJiBkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSkpIHsKICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5yZW9yZGVyRm9yUG9zdFZlcnRleENhY2hlKAogICAgICAgICAgICBpbnN0YW5jZS53ZXN0SGVtaXNwaGVyZUdlb21ldHJ5CiAgICAgICAgICApOwogICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LnJlb3JkZXJGb3JQcmVWZXJ0ZXhDYWNoZSgKICAgICAgICAgICAgaW5zdGFuY2Uud2VzdEhlbWlzcGhlcmVHZW9tZXRyeQogICAgICAgICAgKTsKICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5yZW9yZGVyRm9yUG9zdFZlcnRleENhY2hlKAogICAgICAgICAgICBpbnN0YW5jZS5lYXN0SGVtaXNwaGVyZUdlb21ldHJ5CiAgICAgICAgICApOwogICAgICAgICAgR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LnJlb3JkZXJGb3JQcmVWZXJ0ZXhDYWNoZSgKICAgICAgICAgICAgaW5zdGFuY2UuZWFzdEhlbWlzcGhlcmVHZW9tZXRyeQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGxldCBnZW9tZXRyaWVzID0gR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmNvbWJpbmVJbnN0YW5jZXMoaW5zdGFuY2VzKTsKICAgIGxlbmd0aCA9IGdlb21ldHJpZXMubGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGdlb21ldHJ5ID0gZ2VvbWV0cmllc1tpXTsKICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CiAgICAgIGlmICghc2NlbmUzRE9ubHkpIHsKICAgICAgICBmb3IgKGNvbnN0IG5hbWUgaW4gYXR0cmlidXRlcykgewogICAgICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgYXR0cmlidXRlc1tuYW1lXS5jb21wb25lbnREYXRhdHlwZSA9PT0gQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUpIHsKICAgICAgICAgICAgY29uc3QgbmFtZTNEID0gYCR7bmFtZX0zRGA7CiAgICAgICAgICAgIGNvbnN0IG5hbWUyRCA9IGAke25hbWV9MkRgOwogICAgICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQucHJvamVjdFRvMkQoCiAgICAgICAgICAgICAgZ2VvbWV0cnksCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICBuYW1lM0QsCiAgICAgICAgICAgICAgbmFtZTJELAogICAgICAgICAgICAgIHByb2plY3Rpb24KICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSkgJiYgbmFtZSA9PT0gInBvc2l0aW9uIikgewogICAgICAgICAgICAgIGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlQ1YgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcygKICAgICAgICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24yRC52YWx1ZXMKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5lbmNvZGVBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgZ2VvbWV0cnksCiAgICAgICAgICAgICAgbmFtZTNELAogICAgICAgICAgICAgIGAke25hbWUzRH1IaWdoYCwKICAgICAgICAgICAgICBgJHtuYW1lM0R9TG93YAogICAgICAgICAgICApOwogICAgICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuZW5jb2RlQXR0cmlidXRlKAogICAgICAgICAgICAgIGdlb21ldHJ5LAogICAgICAgICAgICAgIG5hbWUyRCwKICAgICAgICAgICAgICBgJHtuYW1lMkR9SGlnaGAsCiAgICAgICAgICAgICAgYCR7bmFtZTJEfUxvd2AKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChjb25zdCBuYW1lIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KG5hbWUpICYmIGF0dHJpYnV0ZXNbbmFtZV0uY29tcG9uZW50RGF0YXR5cGUgPT09IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFKSB7CiAgICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5lbmNvZGVBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgZ2VvbWV0cnksCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICBgJHtuYW1lfTNESGlnaGAsCiAgICAgICAgICAgICAgYCR7bmFtZX0zRExvd2AKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGNvbXByZXNzVmVydGljZXMpIHsKICAgICAgICBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tcHJlc3NWZXJ0aWNlcyhnZW9tZXRyeSk7CiAgICAgIH0KICAgIH0KICAgIGlmICghdWludEluZGV4U3VwcG9ydCkgewogICAgICBsZXQgc3BsaXRHZW9tZXRyaWVzID0gW107CiAgICAgIGxlbmd0aCA9IGdlb21ldHJpZXMubGVuZ3RoOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICBnZW9tZXRyeSA9IGdlb21ldHJpZXNbaV07CiAgICAgICAgc3BsaXRHZW9tZXRyaWVzID0gc3BsaXRHZW9tZXRyaWVzLmNvbmNhdCgKICAgICAgICAgIEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5maXRUb1Vuc2lnbmVkU2hvcnRJbmRpY2VzKGdlb21ldHJ5KQogICAgICAgICk7CiAgICAgIH0KICAgICAgZ2VvbWV0cmllcyA9IHNwbGl0R2VvbWV0cmllczsKICAgIH0KICAgIHJldHVybiBnZW9tZXRyaWVzOwogIH0KICBmdW5jdGlvbiBjcmVhdGVQaWNrT2Zmc2V0cyhpbnN0YW5jZXMsIGdlb21ldHJ5TmFtZSwgZ2VvbWV0cmllcywgcGlja09mZnNldHMpIHsKICAgIGxldCBvZmZzZXQ7CiAgICBsZXQgaW5kZXhDb3VudDsKICAgIGxldCBnZW9tZXRyeUluZGV4OwogICAgY29uc3Qgb2Zmc2V0SW5kZXggPSBwaWNrT2Zmc2V0cy5sZW5ndGggLSAxOwogICAgaWYgKG9mZnNldEluZGV4ID49IDApIHsKICAgICAgY29uc3QgcGlja09mZnNldCA9IHBpY2tPZmZzZXRzW29mZnNldEluZGV4XTsKICAgICAgb2Zmc2V0ID0gcGlja09mZnNldC5vZmZzZXQgKyBwaWNrT2Zmc2V0LmNvdW50OwogICAgICBnZW9tZXRyeUluZGV4ID0gcGlja09mZnNldC5pbmRleDsKICAgICAgaW5kZXhDb3VudCA9IGdlb21ldHJpZXNbZ2VvbWV0cnlJbmRleF0uaW5kaWNlcy5sZW5ndGg7CiAgICB9IGVsc2UgewogICAgICBvZmZzZXQgPSAwOwogICAgICBnZW9tZXRyeUluZGV4ID0gMDsKICAgICAgaW5kZXhDb3VudCA9IGdlb21ldHJpZXNbZ2VvbWV0cnlJbmRleF0uaW5kaWNlcy5sZW5ndGg7CiAgICB9CiAgICBjb25zdCBsZW5ndGggPSBpbnN0YW5jZXMubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpXTsKICAgICAgY29uc3QgZ2VvbWV0cnkgPSBpbnN0YW5jZVtnZW9tZXRyeU5hbWVdOwogICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChnZW9tZXRyeSkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCBjb3VudCA9IGdlb21ldHJ5LmluZGljZXMubGVuZ3RoOwogICAgICBpZiAob2Zmc2V0ICsgY291bnQgPiBpbmRleENvdW50KSB7CiAgICAgICAgb2Zmc2V0ID0gMDsKICAgICAgICBpbmRleENvdW50ID0gZ2VvbWV0cmllc1srK2dlb21ldHJ5SW5kZXhdLmluZGljZXMubGVuZ3RoOwogICAgICB9CiAgICAgIHBpY2tPZmZzZXRzLnB1c2goewogICAgICAgIGluZGV4OiBnZW9tZXRyeUluZGV4LAogICAgICAgIG9mZnNldCwKICAgICAgICBjb3VudAogICAgICB9KTsKICAgICAgb2Zmc2V0ICs9IGNvdW50OwogICAgfQogIH0KICBmdW5jdGlvbiBjcmVhdGVJbnN0YW5jZVBpY2tPZmZzZXRzKGluc3RhbmNlcywgZ2VvbWV0cmllcykgewogICAgY29uc3QgcGlja09mZnNldHMgPSBbXTsKICAgIGNyZWF0ZVBpY2tPZmZzZXRzKGluc3RhbmNlcywgImdlb21ldHJ5IiwgZ2VvbWV0cmllcywgcGlja09mZnNldHMpOwogICAgY3JlYXRlUGlja09mZnNldHMoCiAgICAgIGluc3RhbmNlcywKICAgICAgIndlc3RIZW1pc3BoZXJlR2VvbWV0cnkiLAogICAgICBnZW9tZXRyaWVzLAogICAgICBwaWNrT2Zmc2V0cwogICAgKTsKICAgIGNyZWF0ZVBpY2tPZmZzZXRzKAogICAgICBpbnN0YW5jZXMsCiAgICAgICJlYXN0SGVtaXNwaGVyZUdlb21ldHJ5IiwKICAgICAgZ2VvbWV0cmllcywKICAgICAgcGlja09mZnNldHMKICAgICk7CiAgICByZXR1cm4gcGlja09mZnNldHM7CiAgfQogIGZ1bmN0aW9uIHRyYW5zZmVyR2VvbWV0cnkoZ2VvbWV0cnksIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgZm9yIChjb25zdCBuYW1lIGluIGF0dHJpYnV0ZXMpIHsKICAgICAgaWYgKGF0dHJpYnV0ZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzW25hbWVdOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlKSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlLnZhbHVlcykpIHsKICAgICAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChhdHRyaWJ1dGUudmFsdWVzLmJ1ZmZlcik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmluZGljZXMpKSB7CiAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChnZW9tZXRyeS5pbmRpY2VzLmJ1ZmZlcik7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyYW5zZmVyR2VvbWV0cmllcyhnZW9tZXRyaWVzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCBsZW5ndGggPSBnZW9tZXRyaWVzLmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgdHJhbnNmZXJHZW9tZXRyeShnZW9tZXRyaWVzW2ldLCB0cmFuc2ZlcmFibGVPYmplY3RzKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gY291bnRDcmVhdGVHZW9tZXRyeVJlc3VsdHMoaXRlbXMpIHsKICAgIGxldCBjb3VudCA9IDE7CiAgICBjb25zdCBsZW5ndGggPSBpdGVtcy5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGdlb21ldHJ5ID0gaXRlbXNbaV07CiAgICAgICsrY291bnQ7CiAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICBjb3VudCArPSA3ICsgMiAqIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgKGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5pbmRpY2VzKSA/IGdlb21ldHJ5LmluZGljZXMubGVuZ3RoIDogMCk7CiAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgaW4gYXR0cmlidXRlcykgewogICAgICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiBkZWZpbmVkX2RlZmF1bHQoYXR0cmlidXRlc1twcm9wZXJ0eV0pKSB7CiAgICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzW3Byb3BlcnR5XTsKICAgICAgICAgIGNvdW50ICs9IDUgKyBhdHRyaWJ1dGUudmFsdWVzLmxlbmd0aDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjb3VudDsKICB9CiAgZnVuY3Rpb24gcGFja0luc3RhbmNlc0ZvckNvbWJpbmUoaW5zdGFuY2VzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCBsZW5ndGggPSBpbnN0YW5jZXMubGVuZ3RoOwogICAgY29uc3QgcGFja2VkRGF0YSA9IG5ldyBGbG9hdDY0QXJyYXkoMSArIGxlbmd0aCAqIDE5KTsKICAgIGxldCBjb3VudCA9IDA7CiAgICBwYWNrZWREYXRhW2NvdW50KytdID0gbGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpXTsKICAgICAgTWF0cml4NF9kZWZhdWx0LnBhY2soaW5zdGFuY2UubW9kZWxNYXRyaXgsIHBhY2tlZERhdGEsIGNvdW50KTsKICAgICAgY291bnQgKz0gTWF0cml4NF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnN0YW5jZS5hdHRyaWJ1dGVzKSAmJiBkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2UuYXR0cmlidXRlcy5vZmZzZXQpKSB7CiAgICAgICAgY29uc3QgdmFsdWVzID0gaW5zdGFuY2UuYXR0cmlidXRlcy5vZmZzZXQudmFsdWU7CiAgICAgICAgcGFja2VkRGF0YVtjb3VudF0gPSB2YWx1ZXNbMF07CiAgICAgICAgcGFja2VkRGF0YVtjb3VudCArIDFdID0gdmFsdWVzWzFdOwogICAgICAgIHBhY2tlZERhdGFbY291bnQgKyAyXSA9IHZhbHVlc1syXTsKICAgICAgfQogICAgICBjb3VudCArPSAzOwogICAgfQogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKHBhY2tlZERhdGEuYnVmZmVyKTsKICAgIHJldHVybiBwYWNrZWREYXRhOwogIH0KICBmdW5jdGlvbiB1bnBhY2tJbnN0YW5jZXNGb3JDb21iaW5lKGRhdGEpIHsKICAgIGNvbnN0IHBhY2tlZEluc3RhbmNlcyA9IGRhdGE7CiAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkocGFja2VkSW5zdGFuY2VzWzBdKTsKICAgIGxldCBjb3VudCA9IDA7CiAgICBsZXQgaSA9IDE7CiAgICB3aGlsZSAoaSA8IHBhY2tlZEluc3RhbmNlcy5sZW5ndGgpIHsKICAgICAgY29uc3QgbW9kZWxNYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQudW5wYWNrKHBhY2tlZEluc3RhbmNlcywgaSk7CiAgICAgIGxldCBhdHRyaWJ1dGVzOwogICAgICBpICs9IE1hdHJpeDRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocGFja2VkSW5zdGFuY2VzW2ldKSkgewogICAgICAgIGF0dHJpYnV0ZXMgPSB7CiAgICAgICAgICBvZmZzZXQ6IG5ldyBPZmZzZXRHZW9tZXRyeUluc3RhbmNlQXR0cmlidXRlX2RlZmF1bHQoCiAgICAgICAgICAgIHBhY2tlZEluc3RhbmNlc1tpXSwKICAgICAgICAgICAgcGFja2VkSW5zdGFuY2VzW2kgKyAxXSwKICAgICAgICAgICAgcGFja2VkSW5zdGFuY2VzW2kgKyAyXQogICAgICAgICAgKQogICAgICAgIH07CiAgICAgIH0KICAgICAgaSArPSAzOwogICAgICByZXN1bHRbY291bnQrK10gPSB7CiAgICAgICAgbW9kZWxNYXRyaXgsCiAgICAgICAgYXR0cmlidXRlcwogICAgICB9OwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gcGFja0JvdW5kaW5nU3BoZXJlcyhib3VuZGluZ1NwaGVyZXMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGJvdW5kaW5nU3BoZXJlcy5sZW5ndGg7CiAgICBjb25zdCBidWZmZXJMZW5ndGggPSAxICsgKEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMSkgKiBsZW5ndGg7CiAgICBjb25zdCBidWZmZXIgPSBuZXcgRmxvYXQzMkFycmF5KGJ1ZmZlckxlbmd0aCk7CiAgICBsZXQgYnVmZmVySW5kZXggPSAwOwogICAgYnVmZmVyW2J1ZmZlckluZGV4KytdID0gbGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb25zdCBicyA9IGJvdW5kaW5nU3BoZXJlc1tpXTsKICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnMpKSB7CiAgICAgICAgYnVmZmVyW2J1ZmZlckluZGV4KytdID0gMDsKICAgICAgfSBlbHNlIHsKICAgICAgICBidWZmZXJbYnVmZmVySW5kZXgrK10gPSAxOwogICAgICAgIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFjayhib3VuZGluZ1NwaGVyZXNbaV0sIGJ1ZmZlciwgYnVmZmVySW5kZXgpOwogICAgICB9CiAgICAgIGJ1ZmZlckluZGV4ICs9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgfQogICAgcmV0dXJuIGJ1ZmZlcjsKICB9CiAgZnVuY3Rpb24gdW5wYWNrQm91bmRpbmdTcGhlcmVzKGJ1ZmZlcikgewogICAgY29uc3QgcmVzdWx0ID0gbmV3IEFycmF5KGJ1ZmZlclswXSk7CiAgICBsZXQgY291bnQgPSAwOwogICAgbGV0IGkgPSAxOwogICAgd2hpbGUgKGkgPCBidWZmZXIubGVuZ3RoKSB7CiAgICAgIGlmIChidWZmZXJbaSsrXSA9PT0gMSkgewogICAgICAgIHJlc3VsdFtjb3VudF0gPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnVucGFjayhidWZmZXIsIGkpOwogICAgICB9CiAgICAgICsrY291bnQ7CiAgICAgIGkgKz0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB2YXIgUHJpbWl0aXZlUGlwZWxpbmUsIFByaW1pdGl2ZVBpcGVsaW5lX2RlZmF1bHQ7CiAgdmFyIGluaXRfUHJpbWl0aXZlUGlwZWxpbmUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9TY2VuZS9QcmltaXRpdmVQaXBlbGluZS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5UGlwZWxpbmUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBpbml0X09mZnNldEdlb21ldHJ5SW5zdGFuY2VBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9XZWJNZXJjYXRvclByb2plY3Rpb24oKTsKICAgICAgUHJpbWl0aXZlUGlwZWxpbmUgPSB7fTsKICAgICAgUHJpbWl0aXZlUGlwZWxpbmUuY29tYmluZUdlb21ldHJ5ID0gZnVuY3Rpb24ocGFyYW1ldGVycykgewogICAgICAgIGxldCBnZW9tZXRyaWVzOwogICAgICAgIGxldCBhdHRyaWJ1dGVMb2NhdGlvbnM7CiAgICAgICAgY29uc3QgaW5zdGFuY2VzID0gcGFyYW1ldGVycy5pbnN0YW5jZXM7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gaW5zdGFuY2VzLmxlbmd0aDsKICAgICAgICBsZXQgcGlja09mZnNldHM7CiAgICAgICAgbGV0IG9mZnNldEluc3RhbmNlRXh0ZW5kOwogICAgICAgIGxldCBoYXNPZmZzZXQgPSBmYWxzZTsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgZ2VvbWV0cmllcyA9IGdlb21ldHJ5UGlwZWxpbmUocGFyYW1ldGVycyk7CiAgICAgICAgICBpZiAoZ2VvbWV0cmllcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZUxvY2F0aW9ucyA9IEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jcmVhdGVBdHRyaWJ1dGVMb2NhdGlvbnMoCiAgICAgICAgICAgICAgZ2VvbWV0cmllc1swXQogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAocGFyYW1ldGVycy5jcmVhdGVQaWNrT2Zmc2V0cykgewogICAgICAgICAgICAgIHBpY2tPZmZzZXRzID0gY3JlYXRlSW5zdGFuY2VQaWNrT2Zmc2V0cyhpbnN0YW5jZXMsIGdlb21ldHJpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluc3RhbmNlc1swXS5hdHRyaWJ1dGVzKSAmJiBkZWZpbmVkX2RlZmF1bHQoaW5zdGFuY2VzWzBdLmF0dHJpYnV0ZXMub2Zmc2V0KSkgewogICAgICAgICAgICBvZmZzZXRJbnN0YW5jZUV4dGVuZCA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgICAgICBoYXNPZmZzZXQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZXMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZXNDViA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VzW2ldOwogICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBpbnN0YW5jZS5nZW9tZXRyeTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpKSB7CiAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlc1tpXSA9IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlOwogICAgICAgICAgICBib3VuZGluZ1NwaGVyZXNDVltpXSA9IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlQ1Y7CiAgICAgICAgICAgIGlmIChoYXNPZmZzZXQpIHsKICAgICAgICAgICAgICBvZmZzZXRJbnN0YW5jZUV4dGVuZFtpXSA9IGluc3RhbmNlLmdlb21ldHJ5Lm9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3QgZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSA9IGluc3RhbmNlLmVhc3RIZW1pc3BoZXJlR2VvbWV0cnk7CiAgICAgICAgICBjb25zdCB3ZXN0SGVtaXNwaGVyZUdlb21ldHJ5ID0gaW5zdGFuY2Uud2VzdEhlbWlzcGhlcmVHZW9tZXRyeTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZWFzdEhlbWlzcGhlcmVHZW9tZXRyeSkgJiYgZGVmaW5lZF9kZWZhdWx0KHdlc3RIZW1pc3BoZXJlR2VvbWV0cnkpKSB7CiAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZWFzdEhlbWlzcGhlcmVHZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSkgJiYgZGVmaW5lZF9kZWZhdWx0KHdlc3RIZW1pc3BoZXJlR2VvbWV0cnkuYm91bmRpbmdTcGhlcmUpKSB7CiAgICAgICAgICAgICAgYm91bmRpbmdTcGhlcmVzW2ldID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bmlvbigKICAgICAgICAgICAgICAgIGVhc3RIZW1pc3BoZXJlR2VvbWV0cnkuYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICAgICAgICB3ZXN0SGVtaXNwaGVyZUdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGVhc3RIZW1pc3BoZXJlR2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVikgJiYgZGVmaW5lZF9kZWZhdWx0KHdlc3RIZW1pc3BoZXJlR2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVikpIHsKICAgICAgICAgICAgICBib3VuZGluZ1NwaGVyZXNDVltpXSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5pb24oCiAgICAgICAgICAgICAgICBlYXN0SGVtaXNwaGVyZUdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlQ1YsCiAgICAgICAgICAgICAgICB3ZXN0SGVtaXNwaGVyZUdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlQ1YKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBnZW9tZXRyaWVzLAogICAgICAgICAgbW9kZWxNYXRyaXg6IHBhcmFtZXRlcnMubW9kZWxNYXRyaXgsCiAgICAgICAgICBhdHRyaWJ1dGVMb2NhdGlvbnMsCiAgICAgICAgICBwaWNrT2Zmc2V0cywKICAgICAgICAgIG9mZnNldEluc3RhbmNlRXh0ZW5kLAogICAgICAgICAgYm91bmRpbmdTcGhlcmVzLAogICAgICAgICAgYm91bmRpbmdTcGhlcmVzQ1YKICAgICAgICB9OwogICAgICB9OwogICAgICBQcmltaXRpdmVQaXBlbGluZS5wYWNrQ3JlYXRlR2VvbWV0cnlSZXN1bHRzID0gZnVuY3Rpb24oaXRlbXMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgICAgICBjb25zdCBwYWNrZWREYXRhID0gbmV3IEZsb2F0NjRBcnJheShjb3VudENyZWF0ZUdlb21ldHJ5UmVzdWx0cyhpdGVtcykpOwogICAgICAgIGNvbnN0IHN0cmluZ1RhYmxlID0gW107CiAgICAgICAgY29uc3Qgc3RyaW5nSGFzaCA9IHt9OwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGl0ZW1zLmxlbmd0aDsKICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBpdGVtc1tpXTsKICAgICAgICAgIGNvbnN0IHZhbGlkR2VvbWV0cnkgPSBkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkpOwogICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IHZhbGlkR2VvbWV0cnkgPyAxIDogMDsKICAgICAgICAgIGlmICghdmFsaWRHZW9tZXRyeSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBnZW9tZXRyeS5wcmltaXRpdmVUeXBlOwogICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGdlb21ldHJ5Lmdlb21ldHJ5VHlwZTsKICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChnZW9tZXRyeS5vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICAgIGNvbnN0IHZhbGlkQm91bmRpbmdTcGhlcmUgPSBkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUpID8gMSA6IDA7CiAgICAgICAgICBwYWNrZWREYXRhW2NvdW50KytdID0gdmFsaWRCb3VuZGluZ1NwaGVyZTsKICAgICAgICAgIGlmICh2YWxpZEJvdW5kaW5nU3BoZXJlKSB7CiAgICAgICAgICAgIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFjayhnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSwgcGFja2VkRGF0YSwgY291bnQpOwogICAgICAgICAgfQogICAgICAgICAgY291bnQgKz0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgICBjb25zdCB2YWxpZEJvdW5kaW5nU3BoZXJlQ1YgPSBkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmVDVikgPyAxIDogMDsKICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSB2YWxpZEJvdW5kaW5nU3BoZXJlQ1Y7CiAgICAgICAgICBpZiAodmFsaWRCb3VuZGluZ1NwaGVyZUNWKSB7CiAgICAgICAgICAgIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFjayhnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZUNWLCBwYWNrZWREYXRhLCBjb3VudCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb3VudCArPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwogICAgICAgICAgY29uc3QgYXR0cmlidXRlc1RvV3JpdGUgPSBbXTsKICAgICAgICAgIGZvciAoY29uc3QgcHJvcGVydHkgaW4gYXR0cmlidXRlcykgewogICAgICAgICAgICBpZiAoYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkgJiYgZGVmaW5lZF9kZWZhdWx0KGF0dHJpYnV0ZXNbcHJvcGVydHldKSkgewogICAgICAgICAgICAgIGF0dHJpYnV0ZXNUb1dyaXRlLnB1c2gocHJvcGVydHkpOwogICAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHN0cmluZ0hhc2hbcHJvcGVydHldKSkgewogICAgICAgICAgICAgICAgc3RyaW5nSGFzaFtwcm9wZXJ0eV0gPSBzdHJpbmdUYWJsZS5sZW5ndGg7CiAgICAgICAgICAgICAgICBzdHJpbmdUYWJsZS5wdXNoKHByb3BlcnR5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBhdHRyaWJ1dGVzVG9Xcml0ZS5sZW5ndGg7CiAgICAgICAgICBmb3IgKGxldCBxID0gMDsgcSA8IGF0dHJpYnV0ZXNUb1dyaXRlLmxlbmd0aDsgcSsrKSB7CiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBhdHRyaWJ1dGVzVG9Xcml0ZVtxXTsKICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlID0gYXR0cmlidXRlc1tuYW1lXTsKICAgICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IHN0cmluZ0hhc2hbbmFtZV07CiAgICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBhdHRyaWJ1dGUuY29tcG9uZW50RGF0YXR5cGU7CiAgICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBhdHRyaWJ1dGUuY29tcG9uZW50c1BlckF0dHJpYnV0ZTsKICAgICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGF0dHJpYnV0ZS5ub3JtYWxpemUgPyAxIDogMDsKICAgICAgICAgICAgcGFja2VkRGF0YVtjb3VudCsrXSA9IGF0dHJpYnV0ZS52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICBwYWNrZWREYXRhLnNldChhdHRyaWJ1dGUudmFsdWVzLCBjb3VudCk7CiAgICAgICAgICAgIGNvdW50ICs9IGF0dHJpYnV0ZS52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgaW5kaWNlc0xlbmd0aCA9IGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5pbmRpY2VzKSA/IGdlb21ldHJ5LmluZGljZXMubGVuZ3RoIDogMDsKICAgICAgICAgIHBhY2tlZERhdGFbY291bnQrK10gPSBpbmRpY2VzTGVuZ3RoOwogICAgICAgICAgaWYgKGluZGljZXNMZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHBhY2tlZERhdGEuc2V0KGdlb21ldHJ5LmluZGljZXMsIGNvdW50KTsKICAgICAgICAgICAgY291bnQgKz0gaW5kaWNlc0xlbmd0aDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKHBhY2tlZERhdGEuYnVmZmVyKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgc3RyaW5nVGFibGUsCiAgICAgICAgICBwYWNrZWREYXRhCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgUHJpbWl0aXZlUGlwZWxpbmUudW5wYWNrQ3JlYXRlR2VvbWV0cnlSZXN1bHRzID0gZnVuY3Rpb24oY3JlYXRlR2VvbWV0cnlSZXN1bHQpIHsKICAgICAgICBjb25zdCBzdHJpbmdUYWJsZSA9IGNyZWF0ZUdlb21ldHJ5UmVzdWx0LnN0cmluZ1RhYmxlOwogICAgICAgIGNvbnN0IHBhY2tlZEdlb21ldHJ5ID0gY3JlYXRlR2VvbWV0cnlSZXN1bHQucGFja2VkRGF0YTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkocGFja2VkR2VvbWV0cnlbMF0pOwogICAgICAgIGxldCByZXN1bHRJbmRleCA9IDA7CiAgICAgICAgbGV0IHBhY2tlZEdlb21ldHJ5SW5kZXggPSAxOwogICAgICAgIHdoaWxlIChwYWNrZWRHZW9tZXRyeUluZGV4IDwgcGFja2VkR2VvbWV0cnkubGVuZ3RoKSB7CiAgICAgICAgICBjb25zdCB2YWxpZCA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK10gPT09IDE7CiAgICAgICAgICBpZiAoIXZhbGlkKSB7CiAgICAgICAgICAgIHJlc3VsdFtyZXN1bHRJbmRleCsrXSA9IHZvaWQgMDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBwcmltaXRpdmVUeXBlID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXTsKICAgICAgICAgIGNvbnN0IGdlb21ldHJ5VHlwZSA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK107CiAgICAgICAgICBsZXQgb2Zmc2V0QXR0cmlidXRlID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXTsKICAgICAgICAgIGlmIChvZmZzZXRBdHRyaWJ1dGUgPT09IC0xKSB7CiAgICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBib3VuZGluZ1NwaGVyZTsKICAgICAgICAgIGxldCBib3VuZGluZ1NwaGVyZUNWOwogICAgICAgICAgY29uc3QgdmFsaWRCb3VuZGluZ1NwaGVyZSA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK10gPT09IDE7CiAgICAgICAgICBpZiAodmFsaWRCb3VuZGluZ1NwaGVyZSkgewogICAgICAgICAgICBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICAgIHBhY2tlZEdlb21ldHJ5LAogICAgICAgICAgICAgIHBhY2tlZEdlb21ldHJ5SW5kZXgKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIHBhY2tlZEdlb21ldHJ5SW5kZXggKz0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgICBjb25zdCB2YWxpZEJvdW5kaW5nU3BoZXJlQ1YgPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdID09PSAxOwogICAgICAgICAgaWYgKHZhbGlkQm91bmRpbmdTcGhlcmVDVikgewogICAgICAgICAgICBib3VuZGluZ1NwaGVyZUNWID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgICAgcGFja2VkR2VvbWV0cnksCiAgICAgICAgICAgICAgcGFja2VkR2VvbWV0cnlJbmRleAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgcGFja2VkR2VvbWV0cnlJbmRleCArPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICAgIGxldCBsZW5ndGg7CiAgICAgICAgICBsZXQgdmFsdWVzOwogICAgICAgICAgbGV0IGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU7CiAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgICBjb25zdCBudW1BdHRyaWJ1dGVzID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1BdHRyaWJ1dGVzOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgbmFtZSA9IHN0cmluZ1RhYmxlW3BhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK11dOwogICAgICAgICAgICBjb25zdCBjb21wb25lbnREYXRhdHlwZSA9IHBhY2tlZEdlb21ldHJ5W3BhY2tlZEdlb21ldHJ5SW5kZXgrK107CiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgICBjb25zdCBub3JtYWxpemUgPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdICE9PSAwOwogICAgICAgICAgICBsZW5ndGggPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgICB2YWx1ZXMgPSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoY29tcG9uZW50RGF0YXR5cGUsIGxlbmd0aCk7CiAgICAgICAgICAgIGZvciAobGV0IHZhbHVlc0luZGV4ID0gMDsgdmFsdWVzSW5kZXggPCBsZW5ndGg7IHZhbHVlc0luZGV4KyspIHsKICAgICAgICAgICAgICB2YWx1ZXNbdmFsdWVzSW5kZXhdID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhdHRyaWJ1dGVzW25hbWVdID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUsCiAgICAgICAgICAgICAgbm9ybWFsaXplLAogICAgICAgICAgICAgIHZhbHVlcwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBpbmRpY2VzOwogICAgICAgICAgbGVuZ3RoID0gcGFja2VkR2VvbWV0cnlbcGFja2VkR2VvbWV0cnlJbmRleCsrXTsKICAgICAgICAgIGlmIChsZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IG51bWJlck9mVmVydGljZXMgPSB2YWx1ZXMubGVuZ3RoIC8gY29tcG9uZW50c1BlckF0dHJpYnV0ZTsKICAgICAgICAgICAgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KG51bWJlck9mVmVydGljZXMsIGxlbmd0aCk7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGluZGljZXNbaV0gPSBwYWNrZWRHZW9tZXRyeVtwYWNrZWRHZW9tZXRyeUluZGV4KytdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHRbcmVzdWx0SW5kZXgrK10gPSBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICAgIHByaW1pdGl2ZVR5cGUsCiAgICAgICAgICAgIGdlb21ldHJ5VHlwZSwKICAgICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICAgIGJvdW5kaW5nU3BoZXJlQ1YsCiAgICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFByaW1pdGl2ZVBpcGVsaW5lLnBhY2tDb21iaW5lR2VvbWV0cnlQYXJhbWV0ZXJzID0gZnVuY3Rpb24ocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgICAgIGNvbnN0IGNyZWF0ZUdlb21ldHJ5UmVzdWx0cyA9IHBhcmFtZXRlcnMuY3JlYXRlR2VvbWV0cnlSZXN1bHRzOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNyZWF0ZUdlb21ldHJ5UmVzdWx0cy5sZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGNyZWF0ZUdlb21ldHJ5UmVzdWx0c1tpXS5wYWNrZWREYXRhLmJ1ZmZlcik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBjcmVhdGVHZW9tZXRyeVJlc3VsdHM6IHBhcmFtZXRlcnMuY3JlYXRlR2VvbWV0cnlSZXN1bHRzLAogICAgICAgICAgcGFja2VkSW5zdGFuY2VzOiBwYWNrSW5zdGFuY2VzRm9yQ29tYmluZSgKICAgICAgICAgICAgcGFyYW1ldGVycy5pbnN0YW5jZXMsCiAgICAgICAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMKICAgICAgICAgICksCiAgICAgICAgICBlbGxpcHNvaWQ6IHBhcmFtZXRlcnMuZWxsaXBzb2lkLAogICAgICAgICAgaXNHZW9ncmFwaGljOiBwYXJhbWV0ZXJzLnByb2plY3Rpb24gaW5zdGFuY2VvZiBHZW9ncmFwaGljUHJvamVjdGlvbl9kZWZhdWx0LAogICAgICAgICAgZWxlbWVudEluZGV4VWludFN1cHBvcnRlZDogcGFyYW1ldGVycy5lbGVtZW50SW5kZXhVaW50U3VwcG9ydGVkLAogICAgICAgICAgc2NlbmUzRE9ubHk6IHBhcmFtZXRlcnMuc2NlbmUzRE9ubHksCiAgICAgICAgICB2ZXJ0ZXhDYWNoZU9wdGltaXplOiBwYXJhbWV0ZXJzLnZlcnRleENhY2hlT3B0aW1pemUsCiAgICAgICAgICBjb21wcmVzc1ZlcnRpY2VzOiBwYXJhbWV0ZXJzLmNvbXByZXNzVmVydGljZXMsCiAgICAgICAgICBtb2RlbE1hdHJpeDogcGFyYW1ldGVycy5tb2RlbE1hdHJpeCwKICAgICAgICAgIGNyZWF0ZVBpY2tPZmZzZXRzOiBwYXJhbWV0ZXJzLmNyZWF0ZVBpY2tPZmZzZXRzCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgUHJpbWl0aXZlUGlwZWxpbmUudW5wYWNrQ29tYmluZUdlb21ldHJ5UGFyYW1ldGVycyA9IGZ1bmN0aW9uKHBhY2tlZFBhcmFtZXRlcnMpIHsKICAgICAgICBjb25zdCBpbnN0YW5jZXMgPSB1bnBhY2tJbnN0YW5jZXNGb3JDb21iaW5lKHBhY2tlZFBhcmFtZXRlcnMucGFja2VkSW5zdGFuY2VzKTsKICAgICAgICBjb25zdCBjcmVhdGVHZW9tZXRyeVJlc3VsdHMgPSBwYWNrZWRQYXJhbWV0ZXJzLmNyZWF0ZUdlb21ldHJ5UmVzdWx0czsKICAgICAgICBjb25zdCBsZW5ndGggPSBjcmVhdGVHZW9tZXRyeVJlc3VsdHMubGVuZ3RoOwogICAgICAgIGxldCBpbnN0YW5jZUluZGV4ID0gMDsKICAgICAgICBmb3IgKGxldCByZXN1bHRJbmRleCA9IDA7IHJlc3VsdEluZGV4IDwgbGVuZ3RoOyByZXN1bHRJbmRleCsrKSB7CiAgICAgICAgICBjb25zdCBnZW9tZXRyaWVzID0gUHJpbWl0aXZlUGlwZWxpbmUudW5wYWNrQ3JlYXRlR2VvbWV0cnlSZXN1bHRzKAogICAgICAgICAgICBjcmVhdGVHZW9tZXRyeVJlc3VsdHNbcmVzdWx0SW5kZXhdCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgZ2VvbWV0cmllc0xlbmd0aCA9IGdlb21ldHJpZXMubGVuZ3RoOwogICAgICAgICAgZm9yIChsZXQgZ2VvbWV0cnlJbmRleCA9IDA7IGdlb21ldHJ5SW5kZXggPCBnZW9tZXRyaWVzTGVuZ3RoOyBnZW9tZXRyeUluZGV4KyspIHsKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBnZW9tZXRyaWVzW2dlb21ldHJ5SW5kZXhdOwogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGluc3RhbmNlc1tpbnN0YW5jZUluZGV4XTsKICAgICAgICAgICAgaW5zdGFuY2UuZ2VvbWV0cnkgPSBnZW9tZXRyeTsKICAgICAgICAgICAgKytpbnN0YW5jZUluZGV4OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShwYWNrZWRQYXJhbWV0ZXJzLmVsbGlwc29pZCk7CiAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IHBhY2tlZFBhcmFtZXRlcnMuaXNHZW9ncmFwaGljID8gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoZWxsaXBzb2lkKSA6IG5ldyBXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdChlbGxpcHNvaWQpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBpbnN0YW5jZXMsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBwcm9qZWN0aW9uLAogICAgICAgICAgZWxlbWVudEluZGV4VWludFN1cHBvcnRlZDogcGFja2VkUGFyYW1ldGVycy5lbGVtZW50SW5kZXhVaW50U3VwcG9ydGVkLAogICAgICAgICAgc2NlbmUzRE9ubHk6IHBhY2tlZFBhcmFtZXRlcnMuc2NlbmUzRE9ubHksCiAgICAgICAgICB2ZXJ0ZXhDYWNoZU9wdGltaXplOiBwYWNrZWRQYXJhbWV0ZXJzLnZlcnRleENhY2hlT3B0aW1pemUsCiAgICAgICAgICBjb21wcmVzc1ZlcnRpY2VzOiBwYWNrZWRQYXJhbWV0ZXJzLmNvbXByZXNzVmVydGljZXMsCiAgICAgICAgICBtb2RlbE1hdHJpeDogTWF0cml4NF9kZWZhdWx0LmNsb25lKHBhY2tlZFBhcmFtZXRlcnMubW9kZWxNYXRyaXgpLAogICAgICAgICAgY3JlYXRlUGlja09mZnNldHM6IHBhY2tlZFBhcmFtZXRlcnMuY3JlYXRlUGlja09mZnNldHMKICAgICAgICB9OwogICAgICB9OwogICAgICBQcmltaXRpdmVQaXBlbGluZS5wYWNrQ29tYmluZUdlb21ldHJ5UmVzdWx0cyA9IGZ1bmN0aW9uKHJlc3VsdHMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlc3VsdHMuZ2VvbWV0cmllcykpIHsKICAgICAgICAgIHRyYW5zZmVyR2VvbWV0cmllcyhyZXN1bHRzLmdlb21ldHJpZXMsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwYWNrZWRCb3VuZGluZ1NwaGVyZXMgPSBwYWNrQm91bmRpbmdTcGhlcmVzKHJlc3VsdHMuYm91bmRpbmdTcGhlcmVzKTsKICAgICAgICBjb25zdCBwYWNrZWRCb3VuZGluZ1NwaGVyZXNDViA9IHBhY2tCb3VuZGluZ1NwaGVyZXMoCiAgICAgICAgICByZXN1bHRzLmJvdW5kaW5nU3BoZXJlc0NWCiAgICAgICAgKTsKICAgICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goCiAgICAgICAgICBwYWNrZWRCb3VuZGluZ1NwaGVyZXMuYnVmZmVyLAogICAgICAgICAgcGFja2VkQm91bmRpbmdTcGhlcmVzQ1YuYnVmZmVyCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZ2VvbWV0cmllczogcmVzdWx0cy5nZW9tZXRyaWVzLAogICAgICAgICAgYXR0cmlidXRlTG9jYXRpb25zOiByZXN1bHRzLmF0dHJpYnV0ZUxvY2F0aW9ucywKICAgICAgICAgIG1vZGVsTWF0cml4OiByZXN1bHRzLm1vZGVsTWF0cml4LAogICAgICAgICAgcGlja09mZnNldHM6IHJlc3VsdHMucGlja09mZnNldHMsCiAgICAgICAgICBvZmZzZXRJbnN0YW5jZUV4dGVuZDogcmVzdWx0cy5vZmZzZXRJbnN0YW5jZUV4dGVuZCwKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlczogcGFja2VkQm91bmRpbmdTcGhlcmVzLAogICAgICAgICAgYm91bmRpbmdTcGhlcmVzQ1Y6IHBhY2tlZEJvdW5kaW5nU3BoZXJlc0NWCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgUHJpbWl0aXZlUGlwZWxpbmUudW5wYWNrQ29tYmluZUdlb21ldHJ5UmVzdWx0cyA9IGZ1bmN0aW9uKHBhY2tlZFJlc3VsdCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBnZW9tZXRyaWVzOiBwYWNrZWRSZXN1bHQuZ2VvbWV0cmllcywKICAgICAgICAgIGF0dHJpYnV0ZUxvY2F0aW9uczogcGFja2VkUmVzdWx0LmF0dHJpYnV0ZUxvY2F0aW9ucywKICAgICAgICAgIG1vZGVsTWF0cml4OiBwYWNrZWRSZXN1bHQubW9kZWxNYXRyaXgsCiAgICAgICAgICBwaWNrT2Zmc2V0czogcGFja2VkUmVzdWx0LnBpY2tPZmZzZXRzLAogICAgICAgICAgb2Zmc2V0SW5zdGFuY2VFeHRlbmQ6IHBhY2tlZFJlc3VsdC5vZmZzZXRJbnN0YW5jZUV4dGVuZCwKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlczogdW5wYWNrQm91bmRpbmdTcGhlcmVzKHBhY2tlZFJlc3VsdC5ib3VuZGluZ1NwaGVyZXMpLAogICAgICAgICAgYm91bmRpbmdTcGhlcmVzQ1Y6IHVucGFja0JvdW5kaW5nU3BoZXJlcyhwYWNrZWRSZXN1bHQuYm91bmRpbmdTcGhlcmVzQ1YpCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgUHJpbWl0aXZlUGlwZWxpbmVfZGVmYXVsdCA9IFByaW1pdGl2ZVBpcGVsaW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZm9ybWF0RXJyb3IuanMKICBmdW5jdGlvbiBmb3JtYXRFcnJvcihvYmplY3QpIHsKICAgIGxldCByZXN1bHQ7CiAgICBjb25zdCBuYW1lID0gb2JqZWN0Lm5hbWU7CiAgICBjb25zdCBtZXNzYWdlID0gb2JqZWN0Lm1lc3NhZ2U7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG5hbWUpICYmIGRlZmluZWRfZGVmYXVsdChtZXNzYWdlKSkgewogICAgICByZXN1bHQgPSBgJHtuYW1lfTogJHttZXNzYWdlfWA7CiAgICB9IGVsc2UgewogICAgICByZXN1bHQgPSBvYmplY3QudG9TdHJpbmcoKTsKICAgIH0KICAgIGNvbnN0IHN0YWNrID0gb2JqZWN0LnN0YWNrOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChzdGFjaykpIHsKICAgICAgcmVzdWx0ICs9IGAKJHtzdGFja31gOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIGZvcm1hdEVycm9yX2RlZmF1bHQ7CiAgdmFyIGluaXRfZm9ybWF0RXJyb3IgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2Zvcm1hdEVycm9yLmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGZvcm1hdEVycm9yX2RlZmF1bHQgPSBmb3JtYXRFcnJvcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIuanMKICB2YXIgY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKHdvcmtlckZ1bmN0aW9uKSB7CiAgICBhc3luYyBmdW5jdGlvbiBvbk1lc3NhZ2VIYW5kbGVyKHsgZGF0YSB9KSB7CiAgICAgIGNvbnN0IHRyYW5zZmVyYWJsZU9iamVjdHMgPSBbXTsKICAgICAgY29uc3QgcmVzcG9uc2VNZXNzYWdlID0gewogICAgICAgIGlkOiBkYXRhLmlkLAogICAgICAgIHJlc3VsdDogdm9pZCAwLAogICAgICAgIGVycm9yOiB2b2lkIDAKICAgICAgfTsKICAgICAgc2VsZi5DRVNJVU1fQkFTRV9VUkwgPSBkYXRhLmJhc2VVcmw7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgd29ya2VyRnVuY3Rpb24oZGF0YS5wYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKTsKICAgICAgICByZXNwb25zZU1lc3NhZ2UucmVzdWx0ID0gcmVzdWx0OwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICByZXNwb25zZU1lc3NhZ2UuZXJyb3IgPSB7CiAgICAgICAgICAgIG5hbWU6IGVycm9yLm5hbWUsCiAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsCiAgICAgICAgICAgIHN0YWNrOiBlcnJvci5zdGFjawogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzcG9uc2VNZXNzYWdlLmVycm9yID0gZXJyb3I7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghZGF0YS5jYW5UcmFuc2ZlckFycmF5QnVmZmVyKSB7CiAgICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5sZW5ndGggPSAwOwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgcG9zdE1lc3NhZ2UocmVzcG9uc2VNZXNzYWdlLCB0cmFuc2ZlcmFibGVPYmplY3RzKTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICByZXNwb25zZU1lc3NhZ2UucmVzdWx0ID0gdm9pZCAwOwogICAgICAgIHJlc3BvbnNlTWVzc2FnZS5lcnJvciA9IGBwb3N0TWVzc2FnZSBmYWlsZWQgd2l0aCBlcnJvcjogJHtmb3JtYXRFcnJvcl9kZWZhdWx0KAogICAgICAgICAgZXJyb3IKICAgICAgICApfQogIHdpdGggcmVzcG9uc2VNZXNzYWdlOiAke0pTT04uc3RyaW5naWZ5KHJlc3BvbnNlTWVzc2FnZSl9YDsKICAgICAgICBwb3N0TWVzc2FnZShyZXNwb25zZU1lc3NhZ2UpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBvbk1lc3NhZ2VFcnJvckhhbmRsZXIoZXZlbnQpIHsKICAgICAgcG9zdE1lc3NhZ2UoewogICAgICAgIGlkOiBldmVudC5kYXRhPy5pZCwKICAgICAgICBlcnJvcjogYHBvc3RNZXNzYWdlIGZhaWxlZCB3aXRoIGVycm9yOiAke0pTT04uc3RyaW5naWZ5KGV2ZW50KX1gCiAgICAgIH0pOwogICAgfQogICAgc2VsZi5vbm1lc3NhZ2UgPSBvbk1lc3NhZ2VIYW5kbGVyOwogICAgc2VsZi5vbm1lc3NhZ2VlcnJvciA9IG9uTWVzc2FnZUVycm9ySGFuZGxlcjsKICAgIHJldHVybiBzZWxmOwogIH0KICB2YXIgY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIuanMiKCkgewogICAgICBpbml0X2Zvcm1hdEVycm9yKCk7CiAgICAgIGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jb21iaW5lR2VvbWV0cnkuanMKICB2YXIgY29tYmluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjb21iaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY29tYmluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjb21iaW5lR2VvbWV0cnkocGFja2VkUGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgcGFyYW1ldGVycyA9IFByaW1pdGl2ZVBpcGVsaW5lX2RlZmF1bHQudW5wYWNrQ29tYmluZUdlb21ldHJ5UGFyYW1ldGVycygKICAgICAgcGFja2VkUGFyYW1ldGVycwogICAgKTsKICAgIGNvbnN0IHJlc3VsdHMgPSBQcmltaXRpdmVQaXBlbGluZV9kZWZhdWx0LmNvbWJpbmVHZW9tZXRyeShwYXJhbWV0ZXJzKTsKICAgIHJldHVybiBQcmltaXRpdmVQaXBlbGluZV9kZWZhdWx0LnBhY2tDb21iaW5lR2VvbWV0cnlSZXN1bHRzKAogICAgICByZXN1bHRzLAogICAgICB0cmFuc2ZlcmFibGVPYmplY3RzCiAgICApOwogIH0KICB2YXIgY29tYmluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY29tYmluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jb21iaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X1ByaW1pdGl2ZVBpcGVsaW5lKCk7CiAgICAgIGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpOwogICAgICBjb21iaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChjb21iaW5lR2VvbWV0cnkpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUuanMKICB2YXIgR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUsIEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQ7CiAgdmFyIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlLmpzIigpIHsKICAgICAgR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUgPSB7CiAgICAgICAgTk9ORTogMCwKICAgICAgICBUT1A6IDEsCiAgICAgICAgQUxMOiAyCiAgICAgIH07CiAgICAgIEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1ZlcnRleEZvcm1hdC5qcwogIGZ1bmN0aW9uIFZlcnRleEZvcm1hdChvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMucG9zaXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnBvc2l0aW9uLCBmYWxzZSk7CiAgICB0aGlzLm5vcm1hbCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubm9ybWFsLCBmYWxzZSk7CiAgICB0aGlzLnN0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zdCwgZmFsc2UpOwogICAgdGhpcy5iaXRhbmdlbnQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmJpdGFuZ2VudCwgZmFsc2UpOwogICAgdGhpcy50YW5nZW50ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy50YW5nZW50LCBmYWxzZSk7CiAgICB0aGlzLmNvbG9yID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5jb2xvciwgZmFsc2UpOwogIH0KICB2YXIgVmVydGV4Rm9ybWF0X2RlZmF1bHQ7CiAgdmFyIGluaXRfVmVydGV4Rm9ybWF0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9WZXJ0ZXhGb3JtYXQuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBWZXJ0ZXhGb3JtYXQuUE9TSVRJT05fT05MWSA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IFZlcnRleEZvcm1hdCh7CiAgICAgICAgICBwb3NpdGlvbjogdHJ1ZQogICAgICAgIH0pCiAgICAgICk7CiAgICAgIFZlcnRleEZvcm1hdC5QT1NJVElPTl9BTkRfTk9STUFMID0gT2JqZWN0LmZyZWV6ZSgKICAgICAgICBuZXcgVmVydGV4Rm9ybWF0KHsKICAgICAgICAgIHBvc2l0aW9uOiB0cnVlLAogICAgICAgICAgbm9ybWFsOiB0cnVlCiAgICAgICAgfSkKICAgICAgKTsKICAgICAgVmVydGV4Rm9ybWF0LlBPU0lUSU9OX05PUk1BTF9BTkRfU1QgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBWZXJ0ZXhGb3JtYXQoewogICAgICAgICAgcG9zaXRpb246IHRydWUsCiAgICAgICAgICBub3JtYWw6IHRydWUsCiAgICAgICAgICBzdDogdHJ1ZQogICAgICAgIH0pCiAgICAgICk7CiAgICAgIFZlcnRleEZvcm1hdC5QT1NJVElPTl9BTkRfU1QgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBWZXJ0ZXhGb3JtYXQoewogICAgICAgICAgcG9zaXRpb246IHRydWUsCiAgICAgICAgICBzdDogdHJ1ZQogICAgICAgIH0pCiAgICAgICk7CiAgICAgIFZlcnRleEZvcm1hdC5QT1NJVElPTl9BTkRfQ09MT1IgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBWZXJ0ZXhGb3JtYXQoewogICAgICAgICAgcG9zaXRpb246IHRydWUsCiAgICAgICAgICBjb2xvcjogdHJ1ZQogICAgICAgIH0pCiAgICAgICk7CiAgICAgIFZlcnRleEZvcm1hdC5BTEwgPSBPYmplY3QuZnJlZXplKAogICAgICAgIG5ldyBWZXJ0ZXhGb3JtYXQoewogICAgICAgICAgcG9zaXRpb246IHRydWUsCiAgICAgICAgICBub3JtYWw6IHRydWUsCiAgICAgICAgICBzdDogdHJ1ZSwKICAgICAgICAgIHRhbmdlbnQ6IHRydWUsCiAgICAgICAgICBiaXRhbmdlbnQ6IHRydWUKICAgICAgICB9KQogICAgICApOwogICAgICBWZXJ0ZXhGb3JtYXQuREVGQVVMVCA9IFZlcnRleEZvcm1hdC5QT1NJVElPTl9OT1JNQUxfQU5EX1NUOwogICAgICBWZXJ0ZXhGb3JtYXQucGFja2VkTGVuZ3RoID0gNjsKICAgICAgVmVydGV4Rm9ybWF0LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLnBvc2l0aW9uID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLm5vcm1hbCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5zdCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS50YW5nZW50ID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLmJpdGFuZ2VudCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUuY29sb3IgPyAxIDogMDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIFZlcnRleEZvcm1hdC51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBWZXJ0ZXhGb3JtYXQoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnBvc2l0aW9uID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICByZXN1bHQubm9ybWFsID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICByZXN1bHQuc3QgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIHJlc3VsdC50YW5nZW50ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICByZXN1bHQuYml0YW5nZW50ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICByZXN1bHQuY29sb3IgPSBhcnJheVtzdGFydGluZ0luZGV4XSA9PT0gMTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBWZXJ0ZXhGb3JtYXQuY2xvbmUgPSBmdW5jdGlvbih2ZXJ0ZXhGb3JtYXQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZlcnRleEZvcm1hdCkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBWZXJ0ZXhGb3JtYXQoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnBvc2l0aW9uID0gdmVydGV4Rm9ybWF0LnBvc2l0aW9uOwogICAgICAgIHJlc3VsdC5ub3JtYWwgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsOwogICAgICAgIHJlc3VsdC5zdCA9IHZlcnRleEZvcm1hdC5zdDsKICAgICAgICByZXN1bHQudGFuZ2VudCA9IHZlcnRleEZvcm1hdC50YW5nZW50OwogICAgICAgIHJlc3VsdC5iaXRhbmdlbnQgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50OwogICAgICAgIHJlc3VsdC5jb2xvciA9IHZlcnRleEZvcm1hdC5jb2xvcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCA9IFZlcnRleEZvcm1hdDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0JveEdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gQm94R2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBtaW4zID0gb3B0aW9ucy5taW5pbXVtOwogICAgY29uc3QgbWF4MyA9IG9wdGlvbnMubWF4aW11bTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWluIiwgbWluMyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1heCIsIG1heDMpOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSkgJiYgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZS5UT1AgaXMgbm90IGEgc3VwcG9ydGVkIG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlIGZvciB0aGlzIGdlb21ldHJ5LiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKTsKICAgIHRoaXMuX21pbmltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobWluMyk7CiAgICB0aGlzLl9tYXhpbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG1heDMpOwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gdmVydGV4Rm9ybWF0OwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUJveEdlb21ldHJ5IjsKICB9CiAgdmFyIGRpZmZTY3JhdGNoLCBzY3JhdGNoTWluLCBzY3JhdGNoTWF4LCBzY3JhdGNoVmVydGV4Rm9ybWF0LCBzY3JhdGNoT3B0aW9ucywgdW5pdEJveEdlb21ldHJ5LCBCb3hHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0JveEdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Cb3hHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgZGlmZlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEJveEdlb21ldHJ5LmZyb21EaW1lbnNpb25zID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IGRpbWVuc2lvbnMgPSBvcHRpb25zLmRpbWVuc2lvbnM7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkaW1lbnNpb25zIiwgZGltZW5zaW9ucyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImRpbWVuc2lvbnMueCIsIGRpbWVuc2lvbnMueCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImRpbWVuc2lvbnMueSIsIGRpbWVuc2lvbnMueSwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImRpbWVuc2lvbnMueiIsIGRpbWVuc2lvbnMueiwgMCk7CiAgICAgICAgY29uc3QgY29ybmVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZGltZW5zaW9ucywgMC41LCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkpOwogICAgICAgIHJldHVybiBuZXcgQm94R2VvbWV0cnkoewogICAgICAgICAgbWluaW11bTogQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShjb3JuZXIsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSksCiAgICAgICAgICBtYXhpbXVtOiBjb3JuZXIsCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IG9wdGlvbnMudmVydGV4Rm9ybWF0LAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBCb3hHZW9tZXRyeS5mcm9tQXhpc0FsaWduZWRCb3VuZGluZ0JveCA9IGZ1bmN0aW9uKGJvdW5kaW5nQm94KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJib3VuZGluZ0JveCIsIGJvdW5kaW5nQm94KTsKICAgICAgICByZXR1cm4gbmV3IEJveEdlb21ldHJ5KHsKICAgICAgICAgIG1pbmltdW06IGJvdW5kaW5nQm94Lm1pbmltdW0sCiAgICAgICAgICBtYXhpbXVtOiBib3VuZGluZ0JveC5tYXhpbXVtCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEJveEdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMTsKICAgICAgQm94R2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX21pbmltdW0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjaygKICAgICAgICAgIHZhbHVlLl9tYXhpbXVtLAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4ICsgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aAogICAgICAgICk7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjaygKICAgICAgICAgIHZhbHVlLl92ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKyAyICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aAogICAgICAgICk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCArIDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hNaW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hNYXggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMgPSB7CiAgICAgICAgbWluaW11bTogc2NyYXRjaE1pbiwKICAgICAgICBtYXhpbXVtOiBzY3JhdGNoTWF4LAogICAgICAgIHZlcnRleEZvcm1hdDogc2NyYXRjaFZlcnRleEZvcm1hdCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBCb3hHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgbWluMyA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hNaW4pOwogICAgICAgIGNvbnN0IG1heDMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4ICsgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCwKICAgICAgICAgIHNjcmF0Y2hNYXgKICAgICAgICApOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCArIDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoLAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdAogICAgICAgICk7CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleCArIDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgcmV0dXJuIG5ldyBCb3hHZW9tZXRyeShzY3JhdGNoT3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fbWluaW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtaW4zLCByZXN1bHQuX21pbmltdW0pOwogICAgICAgIHJlc3VsdC5fbWF4aW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtYXgzLCByZXN1bHQuX21heGltdW0pOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJveEdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oYm94R2VvbWV0cnkpIHsKICAgICAgICBjb25zdCBtaW4zID0gYm94R2VvbWV0cnkuX21pbmltdW07CiAgICAgICAgY29uc3QgbWF4MyA9IGJveEdlb21ldHJ5Ll9tYXhpbXVtOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGJveEdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQ7CiAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMobWluMywgbWF4MykpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgICAgIGxldCBpbmRpY2VzOwogICAgICAgIGxldCBwb3NpdGlvbnM7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbiAmJiAodmVydGV4Rm9ybWF0LnN0IHx8IHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkpIHsKICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgICAgICAgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSg2ICogNCAqIDMpOwogICAgICAgICAgICBwb3NpdGlvbnNbMF0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxXSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzJdID0gbWF4My56OwogICAgICAgICAgICBwb3NpdGlvbnNbM10gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0XSA9IG1pbjMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzVdID0gbWF4My56OwogICAgICAgICAgICBwb3NpdGlvbnNbNl0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s3XSA9IG1heDMueTsKICAgICAgICAgICAgcG9zaXRpb25zWzhdID0gbWF4My56OwogICAgICAgICAgICBwb3NpdGlvbnNbOV0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxMF0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxMV0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxMl0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxM10gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxNF0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxNV0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxNl0gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxN10gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxOF0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxOV0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1syMF0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1syMV0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1syMl0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1syM10gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1syNF0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1syNV0gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1syNl0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1syN10gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1syOF0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1syOV0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1szMF0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1szMV0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1szMl0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1szM10gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1szNF0gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1szNV0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1szNl0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1szN10gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1szOF0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1szOV0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0MF0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0MV0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0Ml0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0M10gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0NF0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0NV0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0Nl0gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0N10gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0OF0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s0OV0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1MF0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1MV0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1Ml0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1M10gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1NF0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1NV0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1Nl0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1N10gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1OF0gPSBtYXgzLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s1OV0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2MF0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2MV0gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2Ml0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2M10gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2NF0gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2NV0gPSBtaW4zLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2Nl0gPSBtYXgzLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2N10gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2OF0gPSBtYXgzLno7CiAgICAgICAgICAgIHBvc2l0aW9uc1s2OV0gPSBtaW4zLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1s3MF0gPSBtaW4zLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1s3MV0gPSBtYXgzLno7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICBjb25zdCBub3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheSg2ICogNCAqIDMpOwogICAgICAgICAgICBub3JtYWxzWzBdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1sxXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMl0gPSAxOwogICAgICAgICAgICBub3JtYWxzWzNdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s0XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNV0gPSAxOwogICAgICAgICAgICBub3JtYWxzWzZdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s3XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbOF0gPSAxOwogICAgICAgICAgICBub3JtYWxzWzldID0gMDsKICAgICAgICAgICAgbm9ybWFsc1sxMF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzExXSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbMTJdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1sxM10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzE0XSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzE1XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMTZdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1sxN10gPSAtMTsKICAgICAgICAgICAgbm9ybWFsc1sxOF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzE5XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMjBdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbMjFdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1syMl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzIzXSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzI0XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbMjVdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1syNl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzI3XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbMjhdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1syOV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzMwXSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbMzFdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1szMl0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzMzXSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbMzRdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1szNV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzM2XSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzM3XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMzhdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1szOV0gPSAtMTsKICAgICAgICAgICAgbm9ybWFsc1s0MF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzQxXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNDJdID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbNDNdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s0NF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzQ1XSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzQ2XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNDddID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s0OF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzQ5XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbNTBdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s1MV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzUyXSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbNTNdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s1NF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzU1XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbNTZdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s1N10gPSAwOwogICAgICAgICAgICBub3JtYWxzWzU4XSA9IDE7CiAgICAgICAgICAgIG5vcm1hbHNbNTldID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s2MF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzYxXSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzYyXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNjNdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s2NF0gPSAtMTsKICAgICAgICAgICAgbm9ybWFsc1s2NV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzY2XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNjddID0gLTE7CiAgICAgICAgICAgIG5vcm1hbHNbNjhdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s2OV0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzcwXSA9IC0xOwogICAgICAgICAgICBub3JtYWxzWzcxXSA9IDA7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBub3JtYWxzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgICBjb25zdCB0ZXhDb29yZHMgPSBuZXcgRmxvYXQzMkFycmF5KDYgKiA0ICogMik7CiAgICAgICAgICAgIHRleENvb3Jkc1swXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1sxXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1syXSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1szXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1s0XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s1XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s2XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1s3XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s4XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s5XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1sxMF0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMTFdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzEyXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1sxM10gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMTRdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzE1XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1sxNl0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMTddID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzE4XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1sxOV0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMjBdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzIxXSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1syMl0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMjNdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzI0XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1syNV0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMjZdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzI3XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1syOF0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMjldID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzMwXSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1szMV0gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMzJdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzMzXSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1szNF0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbMzVdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzM2XSA9IDA7CiAgICAgICAgICAgIHRleENvb3Jkc1szN10gPSAxOwogICAgICAgICAgICB0ZXhDb29yZHNbMzhdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzM5XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s0MF0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbNDFdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzQyXSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s0M10gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbNDRdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzQ1XSA9IDE7CiAgICAgICAgICAgIHRleENvb3Jkc1s0Nl0gPSAwOwogICAgICAgICAgICB0ZXhDb29yZHNbNDddID0gMTsKICAgICAgICAgICAgYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICAgIHZhbHVlczogdGV4Q29vcmRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgIGNvbnN0IHRhbmdlbnRzID0gbmV3IEZsb2F0MzJBcnJheSg2ICogNCAqIDMpOwogICAgICAgICAgICB0YW5nZW50c1swXSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzFdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szXSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzRdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s2XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzddID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbOF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s5XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzEwXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzExXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzEyXSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1sxM10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1sxNF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1sxNV0gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbMTZdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMTddID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMThdID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzE5XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzIwXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzIxXSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1syMl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1syM10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1syNF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1syNV0gPSAxOwogICAgICAgICAgICB0YW5nZW50c1syNl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1syN10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1syOF0gPSAxOwogICAgICAgICAgICB0YW5nZW50c1syOV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szMF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szMV0gPSAxOwogICAgICAgICAgICB0YW5nZW50c1szMl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szM10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szNF0gPSAxOwogICAgICAgICAgICB0YW5nZW50c1szNV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szNl0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1szN10gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbMzhdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMzldID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNDBdID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzQxXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzQyXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzQzXSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1s0NF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s0NV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s0Nl0gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbNDddID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNDhdID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzQ5XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzUwXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzUxXSA9IC0xOwogICAgICAgICAgICB0YW5nZW50c1s1Ml0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s1M10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s1NF0gPSAtMTsKICAgICAgICAgICAgdGFuZ2VudHNbNTVdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNTZdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbNTddID0gLTE7CiAgICAgICAgICAgIHRhbmdlbnRzWzU4XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzU5XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzYwXSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzYxXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzYyXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzYzXSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzY0XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzY1XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzY2XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzY3XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzY4XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzY5XSA9IDE7CiAgICAgICAgICAgIHRhbmdlbnRzWzcwXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzcxXSA9IDA7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogdGFuZ2VudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICBjb25zdCBiaXRhbmdlbnRzID0gbmV3IEZsb2F0MzJBcnJheSg2ICogNCAqIDMpOwogICAgICAgICAgICBiaXRhbmdlbnRzWzBdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzNdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s0XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzZdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s3XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbOF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzldID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxMF0gPSAxOwogICAgICAgICAgICBiaXRhbmdlbnRzWzExXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMTJdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxM10gPSAxOwogICAgICAgICAgICBiaXRhbmdlbnRzWzE0XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMTVdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxNl0gPSAxOwogICAgICAgICAgICBiaXRhbmdlbnRzWzE3XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMThdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1sxOV0gPSAxOwogICAgICAgICAgICBiaXRhbmdlbnRzWzIwXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMjFdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1syMl0gPSAxOwogICAgICAgICAgICBiaXRhbmdlbnRzWzIzXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMjRdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1syNV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzI2XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMjddID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1syOF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzI5XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMzBdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1szMV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzMyXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMzNdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1szNF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzM1XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMzZdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1szN10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzM4XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMzldID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s0MF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzQxXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNDJdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s0M10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzQ0XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNDVdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s0Nl0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzQ3XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNDhdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s0OV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzUwXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNTFdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s1Ml0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzUzXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNTRdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s1NV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzU2XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNTddID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s1OF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzU5XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNjBdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s2MV0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzYyXSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNjNdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s2NF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzY1XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNjZdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s2N10gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzY4XSA9IDE7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNjldID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s3MF0gPSAwOwogICAgICAgICAgICBiaXRhbmdlbnRzWzcxXSA9IDE7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMuYml0YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBiaXRhbmdlbnRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheSg2ICogMiAqIDMpOwogICAgICAgICAgaW5kaWNlc1swXSA9IDA7CiAgICAgICAgICBpbmRpY2VzWzFdID0gMTsKICAgICAgICAgIGluZGljZXNbMl0gPSAyOwogICAgICAgICAgaW5kaWNlc1szXSA9IDA7CiAgICAgICAgICBpbmRpY2VzWzRdID0gMjsKICAgICAgICAgIGluZGljZXNbNV0gPSAzOwogICAgICAgICAgaW5kaWNlc1s2XSA9IDQgKyAyOwogICAgICAgICAgaW5kaWNlc1s3XSA9IDQgKyAxOwogICAgICAgICAgaW5kaWNlc1s4XSA9IDQgKyAwOwogICAgICAgICAgaW5kaWNlc1s5XSA9IDQgKyAzOwogICAgICAgICAgaW5kaWNlc1sxMF0gPSA0ICsgMjsKICAgICAgICAgIGluZGljZXNbMTFdID0gNCArIDA7CiAgICAgICAgICBpbmRpY2VzWzEyXSA9IDggKyAwOwogICAgICAgICAgaW5kaWNlc1sxM10gPSA4ICsgMTsKICAgICAgICAgIGluZGljZXNbMTRdID0gOCArIDI7CiAgICAgICAgICBpbmRpY2VzWzE1XSA9IDggKyAwOwogICAgICAgICAgaW5kaWNlc1sxNl0gPSA4ICsgMjsKICAgICAgICAgIGluZGljZXNbMTddID0gOCArIDM7CiAgICAgICAgICBpbmRpY2VzWzE4XSA9IDEyICsgMjsKICAgICAgICAgIGluZGljZXNbMTldID0gMTIgKyAxOwogICAgICAgICAgaW5kaWNlc1syMF0gPSAxMiArIDA7CiAgICAgICAgICBpbmRpY2VzWzIxXSA9IDEyICsgMzsKICAgICAgICAgIGluZGljZXNbMjJdID0gMTIgKyAyOwogICAgICAgICAgaW5kaWNlc1syM10gPSAxMiArIDA7CiAgICAgICAgICBpbmRpY2VzWzI0XSA9IDE2ICsgMjsKICAgICAgICAgIGluZGljZXNbMjVdID0gMTYgKyAxOwogICAgICAgICAgaW5kaWNlc1syNl0gPSAxNiArIDA7CiAgICAgICAgICBpbmRpY2VzWzI3XSA9IDE2ICsgMzsKICAgICAgICAgIGluZGljZXNbMjhdID0gMTYgKyAyOwogICAgICAgICAgaW5kaWNlc1syOV0gPSAxNiArIDA7CiAgICAgICAgICBpbmRpY2VzWzMwXSA9IDIwICsgMDsKICAgICAgICAgIGluZGljZXNbMzFdID0gMjAgKyAxOwogICAgICAgICAgaW5kaWNlc1szMl0gPSAyMCArIDI7CiAgICAgICAgICBpbmRpY2VzWzMzXSA9IDIwICsgMDsKICAgICAgICAgIGluZGljZXNbMzRdID0gMjAgKyAyOwogICAgICAgICAgaW5kaWNlc1szNV0gPSAyMCArIDM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoOCAqIDMpOwogICAgICAgICAgcG9zaXRpb25zWzBdID0gbWluMy54OwogICAgICAgICAgcG9zaXRpb25zWzFdID0gbWluMy55OwogICAgICAgICAgcG9zaXRpb25zWzJdID0gbWluMy56OwogICAgICAgICAgcG9zaXRpb25zWzNdID0gbWF4My54OwogICAgICAgICAgcG9zaXRpb25zWzRdID0gbWluMy55OwogICAgICAgICAgcG9zaXRpb25zWzVdID0gbWluMy56OwogICAgICAgICAgcG9zaXRpb25zWzZdID0gbWF4My54OwogICAgICAgICAgcG9zaXRpb25zWzddID0gbWF4My55OwogICAgICAgICAgcG9zaXRpb25zWzhdID0gbWluMy56OwogICAgICAgICAgcG9zaXRpb25zWzldID0gbWluMy54OwogICAgICAgICAgcG9zaXRpb25zWzEwXSA9IG1heDMueTsKICAgICAgICAgIHBvc2l0aW9uc1sxMV0gPSBtaW4zLno7CiAgICAgICAgICBwb3NpdGlvbnNbMTJdID0gbWluMy54OwogICAgICAgICAgcG9zaXRpb25zWzEzXSA9IG1pbjMueTsKICAgICAgICAgIHBvc2l0aW9uc1sxNF0gPSBtYXgzLno7CiAgICAgICAgICBwb3NpdGlvbnNbMTVdID0gbWF4My54OwogICAgICAgICAgcG9zaXRpb25zWzE2XSA9IG1pbjMueTsKICAgICAgICAgIHBvc2l0aW9uc1sxN10gPSBtYXgzLno7CiAgICAgICAgICBwb3NpdGlvbnNbMThdID0gbWF4My54OwogICAgICAgICAgcG9zaXRpb25zWzE5XSA9IG1heDMueTsKICAgICAgICAgIHBvc2l0aW9uc1syMF0gPSBtYXgzLno7CiAgICAgICAgICBwb3NpdGlvbnNbMjFdID0gbWluMy54OwogICAgICAgICAgcG9zaXRpb25zWzIyXSA9IG1heDMueTsKICAgICAgICAgIHBvc2l0aW9uc1syM10gPSBtYXgzLno7CiAgICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgICB9KTsKICAgICAgICAgIGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoNiAqIDIgKiAzKTsKICAgICAgICAgIGluZGljZXNbMF0gPSA0OwogICAgICAgICAgaW5kaWNlc1sxXSA9IDU7CiAgICAgICAgICBpbmRpY2VzWzJdID0gNjsKICAgICAgICAgIGluZGljZXNbM10gPSA0OwogICAgICAgICAgaW5kaWNlc1s0XSA9IDY7CiAgICAgICAgICBpbmRpY2VzWzVdID0gNzsKICAgICAgICAgIGluZGljZXNbNl0gPSAxOwogICAgICAgICAgaW5kaWNlc1s3XSA9IDA7CiAgICAgICAgICBpbmRpY2VzWzhdID0gMzsKICAgICAgICAgIGluZGljZXNbOV0gPSAxOwogICAgICAgICAgaW5kaWNlc1sxMF0gPSAzOwogICAgICAgICAgaW5kaWNlc1sxMV0gPSAyOwogICAgICAgICAgaW5kaWNlc1sxMl0gPSAxOwogICAgICAgICAgaW5kaWNlc1sxM10gPSA2OwogICAgICAgICAgaW5kaWNlc1sxNF0gPSA1OwogICAgICAgICAgaW5kaWNlc1sxNV0gPSAxOwogICAgICAgICAgaW5kaWNlc1sxNl0gPSAyOwogICAgICAgICAgaW5kaWNlc1sxN10gPSA2OwogICAgICAgICAgaW5kaWNlc1sxOF0gPSAyOwogICAgICAgICAgaW5kaWNlc1sxOV0gPSAzOwogICAgICAgICAgaW5kaWNlc1syMF0gPSA3OwogICAgICAgICAgaW5kaWNlc1syMV0gPSAyOwogICAgICAgICAgaW5kaWNlc1syMl0gPSA3OwogICAgICAgICAgaW5kaWNlc1syM10gPSA2OwogICAgICAgICAgaW5kaWNlc1syNF0gPSAzOwogICAgICAgICAgaW5kaWNlc1syNV0gPSAwOwogICAgICAgICAgaW5kaWNlc1syNl0gPSA0OwogICAgICAgICAgaW5kaWNlc1syN10gPSAzOwogICAgICAgICAgaW5kaWNlc1syOF0gPSA0OwogICAgICAgICAgaW5kaWNlc1syOV0gPSA3OwogICAgICAgICAgaW5kaWNlc1szMF0gPSAwOwogICAgICAgICAgaW5kaWNlc1szMV0gPSAxOwogICAgICAgICAgaW5kaWNlc1szMl0gPSA1OwogICAgICAgICAgaW5kaWNlc1szM10gPSAwOwogICAgICAgICAgaW5kaWNlc1szNF0gPSA1OwogICAgICAgICAgaW5kaWNlc1szNV0gPSA0OwogICAgICAgIH0KICAgICAgICBjb25zdCBkaWZmID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG1heDMsIG1pbjMsIGRpZmZTY3JhdGNoKTsKICAgICAgICBjb25zdCByYWRpdXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGRpZmYpICogMC41OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYm94R2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGJveEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByYWRpdXMpLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBib3hHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEJveEdlb21ldHJ5LmdldFVuaXRCb3ggPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh1bml0Qm94R2VvbWV0cnkpKSB7CiAgICAgICAgICB1bml0Qm94R2VvbWV0cnkgPSBCb3hHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSgKICAgICAgICAgICAgQm94R2VvbWV0cnkuZnJvbURpbWVuc2lvbnMoewogICAgICAgICAgICAgIGRpbWVuc2lvbnM6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMSwgMSwgMSksCiAgICAgICAgICAgICAgdmVydGV4Rm9ybWF0OiBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5QT1NJVElPTl9PTkxZCiAgICAgICAgICAgIH0pCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5pdEJveEdlb21ldHJ5OwogICAgICB9OwogICAgICBCb3hHZW9tZXRyeV9kZWZhdWx0ID0gQm94R2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVCb3hHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVCb3hHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQm94R2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlQm94R2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUJveEdlb21ldHJ5KGJveEdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBib3hHZW9tZXRyeSA9IEJveEdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGJveEdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIEJveEdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoYm94R2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlQm94R2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVCb3hHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQm94R2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JveEdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBjcmVhdGVCb3hHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQm94R2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Cb3hPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBCb3hPdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBtaW4zID0gb3B0aW9ucy5taW5pbXVtOwogICAgY29uc3QgbWF4MyA9IG9wdGlvbnMubWF4aW11bTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibWluIiwgbWluMyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm1heCIsIG1heDMpOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSkgJiYgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZS5UT1AgaXMgbm90IGEgc3VwcG9ydGVkIG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlIGZvciB0aGlzIGdlb21ldHJ5LiIKICAgICAgKTsKICAgIH0KICAgIHRoaXMuX21pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtaW4zKTsKICAgIHRoaXMuX21heCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtYXgzKTsKICAgIHRoaXMuX29mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkiOwogIH0KICB2YXIgZGlmZlNjcmF0Y2gyLCBzY3JhdGNoTWluMiwgc2NyYXRjaE1heDIsIHNjcmF0Y2hPcHRpb25zMiwgQm94T3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQm94T3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Cb3hPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGRpZmZTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQm94T3V0bGluZUdlb21ldHJ5LmZyb21EaW1lbnNpb25zID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IGRpbWVuc2lvbnMgPSBvcHRpb25zLmRpbWVuc2lvbnM7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkaW1lbnNpb25zIiwgZGltZW5zaW9ucyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImRpbWVuc2lvbnMueCIsIGRpbWVuc2lvbnMueCwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImRpbWVuc2lvbnMueSIsIGRpbWVuc2lvbnMueSwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImRpbWVuc2lvbnMueiIsIGRpbWVuc2lvbnMueiwgMCk7CiAgICAgICAgY29uc3QgY29ybmVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZGltZW5zaW9ucywgMC41LCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkpOwogICAgICAgIHJldHVybiBuZXcgQm94T3V0bGluZUdlb21ldHJ5KHsKICAgICAgICAgIG1pbmltdW06IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoY29ybmVyLCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkpLAogICAgICAgICAgbWF4aW11bTogY29ybmVyLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBCb3hPdXRsaW5lR2VvbWV0cnkuZnJvbUF4aXNBbGlnbmVkQm91bmRpbmdCb3ggPSBmdW5jdGlvbihib3VuZGluZ0JveCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiYm91bmRpbmRCb3giLCBib3VuZGluZ0JveCk7CiAgICAgICAgcmV0dXJuIG5ldyBCb3hPdXRsaW5lR2VvbWV0cnkoewogICAgICAgICAgbWluaW11bTogYm91bmRpbmdCb3gubWluaW11bSwKICAgICAgICAgIG1heGltdW06IGJvdW5kaW5nQm94Lm1heGltdW0KICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQm94T3V0bGluZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMTsKICAgICAgQm94T3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9taW4sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5fbWF4LCBhcnJheSwgc3RhcnRpbmdJbmRleCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICogMl0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsCiAgICAgICAgICAtMQogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoTWluMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1heDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMiA9IHsKICAgICAgICBtaW5pbXVtOiBzY3JhdGNoTWluMiwKICAgICAgICBtYXhpbXVtOiBzY3JhdGNoTWF4MiwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBCb3hPdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IG1pbjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoTWluMik7CiAgICAgICAgY29uc3QgbWF4MyA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoLAogICAgICAgICAgc2NyYXRjaE1heDIKICAgICAgICApOwogICAgICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICogMl07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyLm9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICByZXR1cm4gbmV3IEJveE91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX21pbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtaW4zLCByZXN1bHQuX21pbik7CiAgICAgICAgcmVzdWx0Ll9tYXggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobWF4MywgcmVzdWx0Ll9tYXgpOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3hPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihib3hHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IG1pbjMgPSBib3hHZW9tZXRyeS5fbWluOwogICAgICAgIGNvbnN0IG1heDMgPSBib3hHZW9tZXRyeS5fbWF4OwogICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKG1pbjMsIG1heDMpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KDEyICogMik7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSg4ICogMyk7CiAgICAgICAgcG9zaXRpb25zWzBdID0gbWluMy54OwogICAgICAgIHBvc2l0aW9uc1sxXSA9IG1pbjMueTsKICAgICAgICBwb3NpdGlvbnNbMl0gPSBtaW4zLno7CiAgICAgICAgcG9zaXRpb25zWzNdID0gbWF4My54OwogICAgICAgIHBvc2l0aW9uc1s0XSA9IG1pbjMueTsKICAgICAgICBwb3NpdGlvbnNbNV0gPSBtaW4zLno7CiAgICAgICAgcG9zaXRpb25zWzZdID0gbWF4My54OwogICAgICAgIHBvc2l0aW9uc1s3XSA9IG1heDMueTsKICAgICAgICBwb3NpdGlvbnNbOF0gPSBtaW4zLno7CiAgICAgICAgcG9zaXRpb25zWzldID0gbWluMy54OwogICAgICAgIHBvc2l0aW9uc1sxMF0gPSBtYXgzLnk7CiAgICAgICAgcG9zaXRpb25zWzExXSA9IG1pbjMuejsKICAgICAgICBwb3NpdGlvbnNbMTJdID0gbWluMy54OwogICAgICAgIHBvc2l0aW9uc1sxM10gPSBtaW4zLnk7CiAgICAgICAgcG9zaXRpb25zWzE0XSA9IG1heDMuejsKICAgICAgICBwb3NpdGlvbnNbMTVdID0gbWF4My54OwogICAgICAgIHBvc2l0aW9uc1sxNl0gPSBtaW4zLnk7CiAgICAgICAgcG9zaXRpb25zWzE3XSA9IG1heDMuejsKICAgICAgICBwb3NpdGlvbnNbMThdID0gbWF4My54OwogICAgICAgIHBvc2l0aW9uc1sxOV0gPSBtYXgzLnk7CiAgICAgICAgcG9zaXRpb25zWzIwXSA9IG1heDMuejsKICAgICAgICBwb3NpdGlvbnNbMjFdID0gbWluMy54OwogICAgICAgIHBvc2l0aW9uc1syMl0gPSBtYXgzLnk7CiAgICAgICAgcG9zaXRpb25zWzIzXSA9IG1heDMuejsKICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgfSk7CiAgICAgICAgaW5kaWNlc1swXSA9IDQ7CiAgICAgICAgaW5kaWNlc1sxXSA9IDU7CiAgICAgICAgaW5kaWNlc1syXSA9IDU7CiAgICAgICAgaW5kaWNlc1szXSA9IDY7CiAgICAgICAgaW5kaWNlc1s0XSA9IDY7CiAgICAgICAgaW5kaWNlc1s1XSA9IDc7CiAgICAgICAgaW5kaWNlc1s2XSA9IDc7CiAgICAgICAgaW5kaWNlc1s3XSA9IDQ7CiAgICAgICAgaW5kaWNlc1s4XSA9IDA7CiAgICAgICAgaW5kaWNlc1s5XSA9IDE7CiAgICAgICAgaW5kaWNlc1sxMF0gPSAxOwogICAgICAgIGluZGljZXNbMTFdID0gMjsKICAgICAgICBpbmRpY2VzWzEyXSA9IDI7CiAgICAgICAgaW5kaWNlc1sxM10gPSAzOwogICAgICAgIGluZGljZXNbMTRdID0gMzsKICAgICAgICBpbmRpY2VzWzE1XSA9IDA7CiAgICAgICAgaW5kaWNlc1sxNl0gPSAwOwogICAgICAgIGluZGljZXNbMTddID0gNDsKICAgICAgICBpbmRpY2VzWzE4XSA9IDE7CiAgICAgICAgaW5kaWNlc1sxOV0gPSA1OwogICAgICAgIGluZGljZXNbMjBdID0gMjsKICAgICAgICBpbmRpY2VzWzIxXSA9IDY7CiAgICAgICAgaW5kaWNlc1syMl0gPSAzOwogICAgICAgIGluZGljZXNbMjNdID0gNzsKICAgICAgICBjb25zdCBkaWZmID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG1heDMsIG1pbjMsIGRpZmZTY3JhdGNoMik7CiAgICAgICAgY29uc3QgcmFkaXVzID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShkaWZmKSAqIDAuNTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGJveEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBib3hHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByYWRpdXMpLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBib3hHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEJveE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gQm94T3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5KGJveEdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBib3hHZW9tZXRyeSA9IEJveE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhib3hHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBCb3hPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShib3hHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUJveE91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm94T3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc2VHZW9tZXRyeUxpYnJhcnkuanMKICBmdW5jdGlvbiBwb2ludE9uRWxsaXBzb2lkKHRoZXRhLCByb3RhdGlvbiwgbm9ydGhWZWMsIGVhc3RWZWMsIGFTcXIsIGFiLCBiU3FyLCBtYWcsIHVuaXRQb3MsIHJlc3VsdCkgewogICAgY29uc3QgYXppbXV0aCA9IHRoZXRhICsgcm90YXRpb247CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihlYXN0VmVjLCBNYXRoLmNvcyhhemltdXRoKSwgcm90QXhpcyk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihub3J0aFZlYywgTWF0aC5zaW4oYXppbXV0aCksIHRlbXBWZWMpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyb3RBeGlzLCB0ZW1wVmVjLCByb3RBeGlzKTsKICAgIGxldCBjb3NUaGV0YVNxdWFyZWQgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICBjb3NUaGV0YVNxdWFyZWQgPSBjb3NUaGV0YVNxdWFyZWQgKiBjb3NUaGV0YVNxdWFyZWQ7CiAgICBsZXQgc2luVGhldGFTcXVhcmVkID0gTWF0aC5zaW4odGhldGEpOwogICAgc2luVGhldGFTcXVhcmVkID0gc2luVGhldGFTcXVhcmVkICogc2luVGhldGFTcXVhcmVkOwogICAgY29uc3QgcmFkaXVzID0gYWIgLyBNYXRoLnNxcnQoYlNxciAqIGNvc1RoZXRhU3F1YXJlZCArIGFTcXIgKiBzaW5UaGV0YVNxdWFyZWQpOwogICAgY29uc3QgYW5nbGUgPSByYWRpdXMgLyBtYWc7CiAgICBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZShyb3RBeGlzLCBhbmdsZSwgdW5pdFF1YXQpOwogICAgTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKHVuaXRRdWF0LCByb3RNdHgpOwogICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3Iocm90TXR4LCB1bml0UG9zLCByZXN1bHQpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyZXN1bHQsIHJlc3VsdCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihyZXN1bHQsIG1hZywgcmVzdWx0KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5LCByb3RBeGlzLCB0ZW1wVmVjLCB1bml0UXVhdCwgcm90TXR4LCBzY3JhdGNoQ2FydGVzaWFuMTIsIHNjcmF0Y2hDYXJ0ZXNpYW4yMywgc2NyYXRjaENhcnRlc2lhbjM0LCBzY3JhdGNoTm9ybWFsMiwgdW5pdFBvc1NjcmF0Y2gsIGVhc3RWZWNTY3JhdGNoLCBub3J0aFZlY1NjcmF0Y2gsIEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdDsKICB2YXIgaW5pdF9FbGxpcHNlR2VvbWV0cnlMaWJyYXJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNlR2VvbWV0cnlMaWJyYXJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIEVsbGlwc2VHZW9tZXRyeUxpYnJhcnkgPSB7fTsKICAgICAgcm90QXhpcyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdGVtcFZlYyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdW5pdFF1YXQgPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIHJvdE10eCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjEyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5vcm1hbDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc2VHZW9tZXRyeUxpYnJhcnkucmFpc2VQb3NpdGlvbnNUb0hlaWdodCA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgb3B0aW9ucywgZXh0cnVkZSkgewogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IG9wdGlvbnMuZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IGhlaWdodCA9IG9wdGlvbnMuaGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gb3B0aW9ucy5leHRydWRlZEhlaWdodDsKICAgICAgICBjb25zdCBzaXplID0gZXh0cnVkZSA/IHBvc2l0aW9ucy5sZW5ndGggLyAzICogMiA6IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgICAgIGNvbnN0IGZpbmFsUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplICogMyk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBib3R0b21PZmZzZXQgPSBleHRydWRlID8gbGVuZ3RoIDogMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgICBjb25zdCBpMSA9IGkgKyAxOwogICAgICAgICAgY29uc3QgaTIgPSBpICsgMjsKICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGksIHNjcmF0Y2hDYXJ0ZXNpYW4xMik7CiAgICAgICAgICBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICAgICAgY29uc3QgZXh0cnVkZWRQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbiwgc2NyYXRjaENhcnRlc2lhbjIzKTsKICAgICAgICAgIGNvbnN0IG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBzY3JhdGNoTm9ybWFsMik7CiAgICAgICAgICBjb25zdCBzY2FsZWROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMzQKICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uLCBzY2FsZWROb3JtYWwsIHBvc2l0aW9uKTsKICAgICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG5vcm1hbDIsIGV4dHJ1ZGVkSGVpZ2h0LCBzY2FsZWROb3JtYWwpOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGV4dHJ1ZGVkUG9zaXRpb24sIHNjYWxlZE5vcm1hbCwgZXh0cnVkZWRQb3NpdGlvbik7CiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zW2kgKyBib3R0b21PZmZzZXRdID0gZXh0cnVkZWRQb3NpdGlvbi54OwogICAgICAgICAgICBmaW5hbFBvc2l0aW9uc1tpMSArIGJvdHRvbU9mZnNldF0gPSBleHRydWRlZFBvc2l0aW9uLnk7CiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zW2kyICsgYm90dG9tT2Zmc2V0XSA9IGV4dHJ1ZGVkUG9zaXRpb24uejsKICAgICAgICAgIH0KICAgICAgICAgIGZpbmFsUG9zaXRpb25zW2ldID0gcG9zaXRpb24ueDsKICAgICAgICAgIGZpbmFsUG9zaXRpb25zW2kxXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgICBmaW5hbFBvc2l0aW9uc1tpMl0gPSBwb3NpdGlvbi56OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmluYWxQb3NpdGlvbnM7CiAgICAgIH07CiAgICAgIHVuaXRQb3NTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBlYXN0VmVjU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbm9ydGhWZWNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVFbGxpcHNlUG9zaXRpb25zID0gZnVuY3Rpb24ob3B0aW9ucywgYWRkRmlsbFBvc2l0aW9ucywgYWRkRWRnZVBvc2l0aW9ucykgewogICAgICAgIGNvbnN0IHNlbWlNaW5vckF4aXMgPSBvcHRpb25zLnNlbWlNaW5vckF4aXM7CiAgICAgICAgY29uc3Qgc2VtaU1ham9yQXhpcyA9IG9wdGlvbnMuc2VtaU1ham9yQXhpczsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IG9wdGlvbnMucm90YXRpb247CiAgICAgICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBvcHRpb25zLmdyYW51bGFyaXR5ICogODsKICAgICAgICBjb25zdCBhU3FyID0gc2VtaU1pbm9yQXhpcyAqIHNlbWlNaW5vckF4aXM7CiAgICAgICAgY29uc3QgYlNxciA9IHNlbWlNYWpvckF4aXMgKiBzZW1pTWFqb3JBeGlzOwogICAgICAgIGNvbnN0IGFiID0gc2VtaU1ham9yQXhpcyAqIHNlbWlNaW5vckF4aXM7CiAgICAgICAgY29uc3QgbWFnID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZShjZW50ZXIpOwogICAgICAgIGNvbnN0IHVuaXRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGNlbnRlciwgdW5pdFBvc1NjcmF0Y2gpOwogICAgICAgIGxldCBlYXN0VmVjID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osIGNlbnRlciwgZWFzdFZlY1NjcmF0Y2gpOwogICAgICAgIGVhc3RWZWMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGVhc3RWZWMsIGVhc3RWZWMpOwogICAgICAgIGNvbnN0IG5vcnRoVmVjID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHVuaXRQb3MsIGVhc3RWZWMsIG5vcnRoVmVjU2NyYXRjaCk7CiAgICAgICAgbGV0IG51bVB0cyA9IDEgKyBNYXRoLmNlaWwoTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC8gZ3JhbnVsYXJpdHkpOwogICAgICAgIGNvbnN0IGRlbHRhVGhldGEgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLyAobnVtUHRzIC0gMSk7CiAgICAgICAgbGV0IHRoZXRhID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gbnVtUHRzICogZGVsdGFUaGV0YTsKICAgICAgICBpZiAodGhldGEgPCAwKSB7CiAgICAgICAgICBudW1QdHMgLT0gTWF0aC5jZWlsKE1hdGguYWJzKHRoZXRhKSAvIGRlbHRhVGhldGEpOwogICAgICAgIH0KICAgICAgICBjb25zdCBzaXplID0gMiAqIChudW1QdHMgKiAobnVtUHRzICsgMikpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IGFkZEZpbGxQb3NpdGlvbnMgPyBuZXcgQXJyYXkoc2l6ZSAqIDMpIDogdm9pZCAwOwogICAgICAgIGxldCBwb3NpdGlvbkluZGV4ID0gMDsKICAgICAgICBsZXQgcG9zaXRpb24gPSBzY3JhdGNoQ2FydGVzaWFuMTI7CiAgICAgICAgbGV0IHJlZmxlY3RlZFBvc2l0aW9uID0gc2NyYXRjaENhcnRlc2lhbjIzOwogICAgICAgIGNvbnN0IG91dGVyUG9zaXRpb25zTGVuZ3RoID0gbnVtUHRzICogNCAqIDM7CiAgICAgICAgbGV0IG91dGVyUmlnaHRJbmRleCA9IG91dGVyUG9zaXRpb25zTGVuZ3RoIC0gMTsKICAgICAgICBsZXQgb3V0ZXJMZWZ0SW5kZXggPSAwOwogICAgICAgIGNvbnN0IG91dGVyUG9zaXRpb25zID0gYWRkRWRnZVBvc2l0aW9ucyA/IG5ldyBBcnJheShvdXRlclBvc2l0aW9uc0xlbmd0aCkgOiB2b2lkIDA7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGo7CiAgICAgICAgbGV0IG51bUludGVyaW9yOwogICAgICAgIGxldCB0OwogICAgICAgIGxldCBpbnRlcmlvclBvc2l0aW9uOwogICAgICAgIHRoZXRhID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPOwogICAgICAgIHBvc2l0aW9uID0gcG9pbnRPbkVsbGlwc29pZCgKICAgICAgICAgIHRoZXRhLAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICBub3J0aFZlYywKICAgICAgICAgIGVhc3RWZWMsCiAgICAgICAgICBhU3FyLAogICAgICAgICAgYWIsCiAgICAgICAgICBiU3FyLAogICAgICAgICAgbWFnLAogICAgICAgICAgdW5pdFBvcywKICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBpZiAoYWRkRmlsbFBvc2l0aW9ucykgewogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgICAgIH0KICAgICAgICBpZiAoYWRkRWRnZVBvc2l0aW9ucykgewogICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJSaWdodEluZGV4LS1dID0gcG9zaXRpb24uejsKICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyUmlnaHRJbmRleC0tXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi54OwogICAgICAgIH0KICAgICAgICB0aGV0YSA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIGRlbHRhVGhldGE7CiAgICAgICAgZm9yIChpID0gMTsgaSA8IG51bVB0cyArIDE7ICsraSkgewogICAgICAgICAgcG9zaXRpb24gPSBwb2ludE9uRWxsaXBzb2lkKAogICAgICAgICAgICB0aGV0YSwKICAgICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICAgIG5vcnRoVmVjLAogICAgICAgICAgICBlYXN0VmVjLAogICAgICAgICAgICBhU3FyLAogICAgICAgICAgICBhYiwKICAgICAgICAgICAgYlNxciwKICAgICAgICAgICAgbWFnLAogICAgICAgICAgICB1bml0UG9zLAogICAgICAgICAgICBwb3NpdGlvbgogICAgICAgICAgKTsKICAgICAgICAgIHJlZmxlY3RlZFBvc2l0aW9uID0gcG9pbnRPbkVsbGlwc29pZCgKICAgICAgICAgICAgTWF0aC5QSSAtIHRoZXRhLAogICAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgICAgbm9ydGhWZWMsCiAgICAgICAgICAgIGVhc3RWZWMsCiAgICAgICAgICAgIGFTcXIsCiAgICAgICAgICAgIGFiLAogICAgICAgICAgICBiU3FyLAogICAgICAgICAgICBtYWcsCiAgICAgICAgICAgIHVuaXRQb3MsCiAgICAgICAgICAgIHJlZmxlY3RlZFBvc2l0aW9uCiAgICAgICAgICApOwogICAgICAgICAgaWYgKGFkZEZpbGxQb3NpdGlvbnMpIHsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgICAgICAgbnVtSW50ZXJpb3IgPSAyICogaSArIDI7CiAgICAgICAgICAgIGZvciAoaiA9IDE7IGogPCBudW1JbnRlcmlvciAtIDE7ICsraikgewogICAgICAgICAgICAgIHQgPSBqIC8gKG51bUludGVyaW9yIC0gMSk7CiAgICAgICAgICAgICAgaW50ZXJpb3JQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5sZXJwKAogICAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgICByZWZsZWN0ZWRQb3NpdGlvbiwKICAgICAgICAgICAgICAgIHQsCiAgICAgICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMzQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gaW50ZXJpb3JQb3NpdGlvbi54OwogICAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gaW50ZXJpb3JQb3NpdGlvbi55OwogICAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gaW50ZXJpb3JQb3NpdGlvbi56OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24ueDsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi55OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLno7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYWRkRWRnZVBvc2l0aW9ucykgewogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi56OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi55OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi54OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlckxlZnRJbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLng7CiAgICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyTGVmdEluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24ueTsKICAgICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJMZWZ0SW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi56OwogICAgICAgICAgfQogICAgICAgICAgdGhldGEgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLSAoaSArIDEpICogZGVsdGFUaGV0YTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gbnVtUHRzOyBpID4gMTsgLS1pKSB7CiAgICAgICAgICB0aGV0YSA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIChpIC0gMSkgKiBkZWx0YVRoZXRhOwogICAgICAgICAgcG9zaXRpb24gPSBwb2ludE9uRWxsaXBzb2lkKAogICAgICAgICAgICAtdGhldGEsCiAgICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgICBub3J0aFZlYywKICAgICAgICAgICAgZWFzdFZlYywKICAgICAgICAgICAgYVNxciwKICAgICAgICAgICAgYWIsCiAgICAgICAgICAgIGJTcXIsCiAgICAgICAgICAgIG1hZywKICAgICAgICAgICAgdW5pdFBvcywKICAgICAgICAgICAgcG9zaXRpb24KICAgICAgICAgICk7CiAgICAgICAgICByZWZsZWN0ZWRQb3NpdGlvbiA9IHBvaW50T25FbGxpcHNvaWQoCiAgICAgICAgICAgIHRoZXRhICsgTWF0aC5QSSwKICAgICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICAgIG5vcnRoVmVjLAogICAgICAgICAgICBlYXN0VmVjLAogICAgICAgICAgICBhU3FyLAogICAgICAgICAgICBhYiwKICAgICAgICAgICAgYlNxciwKICAgICAgICAgICAgbWFnLAogICAgICAgICAgICB1bml0UG9zLAogICAgICAgICAgICByZWZsZWN0ZWRQb3NpdGlvbgogICAgICAgICAgKTsKICAgICAgICAgIGlmIChhZGRGaWxsUG9zaXRpb25zKSB7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICAgICAgICAgIG51bUludGVyaW9yID0gMiAqIChpIC0gMSkgKyAyOwogICAgICAgICAgICBmb3IgKGogPSAxOyBqIDwgbnVtSW50ZXJpb3IgLSAxOyArK2opIHsKICAgICAgICAgICAgICB0ID0gaiAvIChudW1JbnRlcmlvciAtIDEpOwogICAgICAgICAgICAgIGludGVyaW9yUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubGVycCgKICAgICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgICAgcmVmbGVjdGVkUG9zaXRpb24sCiAgICAgICAgICAgICAgICB0LAogICAgICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjM0CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IGludGVyaW9yUG9zaXRpb24ueDsKICAgICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IGludGVyaW9yUG9zaXRpb24ueTsKICAgICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IGludGVyaW9yUG9zaXRpb24uejsKICAgICAgICAgICAgfQogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24ueTsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi56OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGFkZEVkZ2VQb3NpdGlvbnMpIHsKICAgICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJSaWdodEluZGV4LS1dID0gcG9zaXRpb24uejsKICAgICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJSaWdodEluZGV4LS1dID0gcG9zaXRpb24ueTsKICAgICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJSaWdodEluZGV4LS1dID0gcG9zaXRpb24ueDsKICAgICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJMZWZ0SW5kZXgrK10gPSByZWZsZWN0ZWRQb3NpdGlvbi54OwogICAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlckxlZnRJbmRleCsrXSA9IHJlZmxlY3RlZFBvc2l0aW9uLnk7CiAgICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyTGVmdEluZGV4KytdID0gcmVmbGVjdGVkUG9zaXRpb24uejsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhldGEgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV087CiAgICAgICAgcG9zaXRpb24gPSBwb2ludE9uRWxsaXBzb2lkKAogICAgICAgICAgLXRoZXRhLAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICBub3J0aFZlYywKICAgICAgICAgIGVhc3RWZWMsCiAgICAgICAgICBhU3FyLAogICAgICAgICAgYWIsCiAgICAgICAgICBiU3FyLAogICAgICAgICAgbWFnLAogICAgICAgICAgdW5pdFBvcywKICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBjb25zdCByID0ge307CiAgICAgICAgaWYgKGFkZEZpbGxQb3NpdGlvbnMpIHsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgICAgIHIucG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgICAgci5udW1QdHMgPSBudW1QdHM7CiAgICAgICAgfQogICAgICAgIGlmIChhZGRFZGdlUG9zaXRpb25zKSB7CiAgICAgICAgICBvdXRlclBvc2l0aW9uc1tvdXRlclJpZ2h0SW5kZXgtLV0gPSBwb3NpdGlvbi56OwogICAgICAgICAgb3V0ZXJQb3NpdGlvbnNbb3V0ZXJSaWdodEluZGV4LS1dID0gcG9zaXRpb24ueTsKICAgICAgICAgIG91dGVyUG9zaXRpb25zW291dGVyUmlnaHRJbmRleC0tXSA9IHBvc2l0aW9uLng7CiAgICAgICAgICByLm91dGVyUG9zaXRpb25zID0gb3V0ZXJQb3NpdGlvbnM7CiAgICAgICAgfQogICAgICAgIHJldHVybiByOwogICAgICB9OwogICAgICBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQgPSBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlJbnN0YW5jZS5qcwogIGZ1bmN0aW9uIEdlb21ldHJ5SW5zdGFuY2Uob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zLmdlb21ldHJ5KSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5nZW9tZXRyeSBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIHRoaXMuZ2VvbWV0cnkgPSBvcHRpb25zLmdlb21ldHJ5OwogICAgdGhpcy5tb2RlbE1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5jbG9uZSgKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5tb2RlbE1hdHJpeCwgTWF0cml4NF9kZWZhdWx0LklERU5USVRZKQogICAgKTsKICAgIHRoaXMuaWQgPSBvcHRpb25zLmlkOwogICAgdGhpcy5waWNrUHJpbWl0aXZlID0gb3B0aW9ucy5waWNrUHJpbWl0aXZlOwogICAgdGhpcy5hdHRyaWJ1dGVzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5hdHRyaWJ1dGVzLCB7fSk7CiAgICB0aGlzLndlc3RIZW1pc3BoZXJlR2VvbWV0cnkgPSB2b2lkIDA7CiAgICB0aGlzLmVhc3RIZW1pc3BoZXJlR2VvbWV0cnkgPSB2b2lkIDA7CiAgfQogIHZhciBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQ7CiAgdmFyIGluaXRfR2VvbWV0cnlJbnN0YW5jZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvbWV0cnlJbnN0YW5jZS5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0cml4NCgpOwogICAgICBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQgPSBHZW9tZXRyeUluc3RhbmNlOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gY29tcHV0ZVRvcEJvdHRvbUF0dHJpYnV0ZXMocG9zaXRpb25zLCBvcHRpb25zLCBleHRydWRlKSB7CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBvcHRpb25zLnZlcnRleEZvcm1hdDsKICAgIGNvbnN0IGNlbnRlciA9IG9wdGlvbnMuY2VudGVyOwogICAgY29uc3Qgc2VtaU1ham9yQXhpcyA9IG9wdGlvbnMuc2VtaU1ham9yQXhpczsKICAgIGNvbnN0IHNlbWlNaW5vckF4aXMgPSBvcHRpb25zLnNlbWlNaW5vckF4aXM7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBvcHRpb25zLmVsbGlwc29pZDsKICAgIGNvbnN0IHN0Um90YXRpb24gPSBvcHRpb25zLnN0Um90YXRpb247CiAgICBjb25zdCBzaXplID0gZXh0cnVkZSA/IHBvc2l0aW9ucy5sZW5ndGggLyAzICogMiA6IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3Qgc2hhZG93Vm9sdW1lID0gb3B0aW9ucy5zaGFkb3dWb2x1bWU7CiAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSB2ZXJ0ZXhGb3JtYXQuc3QgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAyKSA6IHZvaWQgMDsKICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDMpIDogdm9pZCAwOwogICAgY29uc3QgZXh0cnVkZU5vcm1hbHMgPSBzaGFkb3dWb2x1bWUgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAzKSA6IHZvaWQgMDsKICAgIGxldCB0ZXh0dXJlQ29vcmRJbmRleCA9IDA7CiAgICBsZXQgbm9ybWFsMiA9IHNjcmF0Y2hOb3JtYWwzOwogICAgbGV0IHRhbmdlbnQgPSBzY3JhdGNoVGFuZ2VudDsKICAgIGxldCBiaXRhbmdlbnQgPSBzY3JhdGNoQml0YW5nZW50OwogICAgY29uc3QgcHJvamVjdGlvbiA9IG5ldyBHZW9ncmFwaGljUHJvamVjdGlvbl9kZWZhdWx0KGVsbGlwc29pZCk7CiAgICBjb25zdCBwcm9qZWN0ZWRDZW50ZXIgPSBwcm9qZWN0aW9uLnByb2plY3QoCiAgICAgIGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhjZW50ZXIsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMyKSwKICAgICAgcHJvamVjdGVkQ2VudGVyU2NyYXRjaAogICAgKTsKICAgIGNvbnN0IGdlb2RldGljTm9ybWFsID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UoCiAgICAgIGNlbnRlciwKICAgICAgc2NyYXRjaENhcnRlc2lhbjEzCiAgICApOwogICAgZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChnZW9kZXRpY05vcm1hbCwgZ2VvZGV0aWNOb3JtYWwpOwogICAgbGV0IHRleHR1cmVNYXRyaXggPSB0ZXh0dXJlTWF0cml4U2NyYXRjaDsKICAgIGxldCB0YW5nZW50TWF0cml4ID0gdGFuZ2VudE1hdHJpeFNjcmF0Y2g7CiAgICBpZiAoc3RSb3RhdGlvbiAhPT0gMCkgewogICAgICBsZXQgcm90YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICBnZW9kZXRpY05vcm1hbCwKICAgICAgICBzdFJvdGF0aW9uLAogICAgICAgIHF1YXRlcm5pb25TY3JhdGNoCiAgICAgICk7CiAgICAgIHRleHR1cmVNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24ocm90YXRpb24sIHRleHR1cmVNYXRyaXgpOwogICAgICByb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgIGdlb2RldGljTm9ybWFsLAogICAgICAgIC1zdFJvdGF0aW9uLAogICAgICAgIHF1YXRlcm5pb25TY3JhdGNoCiAgICAgICk7CiAgICAgIHRhbmdlbnRNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24ocm90YXRpb24sIHRhbmdlbnRNYXRyaXgpOwogICAgfSBlbHNlIHsKICAgICAgdGV4dHVyZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5jbG9uZShNYXRyaXgzX2RlZmF1bHQuSURFTlRJVFksIHRleHR1cmVNYXRyaXgpOwogICAgICB0YW5nZW50TWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmNsb25lKE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWSwgdGFuZ2VudE1hdHJpeCk7CiAgICB9CiAgICBjb25zdCBtaW5UZXhDb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgIE51bWJlci5QT1NJVElWRV9JTkZJTklUWSwKICAgICAgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLAogICAgICBzY3JhdGNoTWluVGV4Q29vcmQKICAgICk7CiAgICBjb25zdCBtYXhUZXhDb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgIE51bWJlci5ORUdBVElWRV9JTkZJTklUWSwKICAgICAgTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLAogICAgICBzY3JhdGNoTWF4VGV4Q29vcmQKICAgICk7CiAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IGJvdHRvbU9mZnNldCA9IGV4dHJ1ZGUgPyBsZW5ndGggOiAwOwogICAgY29uc3Qgc3RPZmZzZXQgPSBib3R0b21PZmZzZXQgLyAzICogMjsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgY29uc3QgaTEgPSBpICsgMTsKICAgICAgY29uc3QgaTIgPSBpICsgMjsKICAgICAgY29uc3QgcG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaSwgc2NyYXRjaENhcnRlc2lhbjEzKTsKICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgIGNvbnN0IHJvdGF0ZWRQb2ludCA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgICAgdGV4dHVyZU1hdHJpeCwKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjI0CiAgICAgICAgKTsKICAgICAgICBjb25zdCBwcm9qZWN0ZWRQb2ludCA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgICAgIGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhyb3RhdGVkUG9pbnQsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMyKSwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zNQogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHByb2plY3RlZFBvaW50LCBwcm9qZWN0ZWRDZW50ZXIsIHByb2plY3RlZFBvaW50KTsKICAgICAgICB0ZXhDb29yZFNjcmF0Y2gueCA9IChwcm9qZWN0ZWRQb2ludC54ICsgc2VtaU1ham9yQXhpcykgLyAoMiAqIHNlbWlNYWpvckF4aXMpOwogICAgICAgIHRleENvb3JkU2NyYXRjaC55ID0gKHByb2plY3RlZFBvaW50LnkgKyBzZW1pTWlub3JBeGlzKSAvICgyICogc2VtaU1pbm9yQXhpcyk7CiAgICAgICAgbWluVGV4Q29vcmQueCA9IE1hdGgubWluKHRleENvb3JkU2NyYXRjaC54LCBtaW5UZXhDb29yZC54KTsKICAgICAgICBtaW5UZXhDb29yZC55ID0gTWF0aC5taW4odGV4Q29vcmRTY3JhdGNoLnksIG1pblRleENvb3JkLnkpOwogICAgICAgIG1heFRleENvb3JkLnggPSBNYXRoLm1heCh0ZXhDb29yZFNjcmF0Y2gueCwgbWF4VGV4Q29vcmQueCk7CiAgICAgICAgbWF4VGV4Q29vcmQueSA9IE1hdGgubWF4KHRleENvb3JkU2NyYXRjaC55LCBtYXhUZXhDb29yZC55KTsKICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4ICsgc3RPZmZzZXRdID0gdGV4Q29vcmRTY3JhdGNoLng7CiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXggKyAxICsgc3RPZmZzZXRdID0gdGV4Q29vcmRTY3JhdGNoLnk7CiAgICAgICAgfQogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleCsrXSA9IHRleENvb3JkU2NyYXRjaC54OwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleCsrXSA9IHRleENvb3JkU2NyYXRjaC55OwogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgfHwgc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIG5vcm1hbDIpOwogICAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2kgKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIueDsKICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2kxICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLnk7CiAgICAgICAgICBleHRydWRlTm9ybWFsc1tpMiArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi56OwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwgbm9ybWFsMiwgdGFuZ2VudCksCiAgICAgICAgICAgICAgdGFuZ2VudAogICAgICAgICAgICApOwogICAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0YW5nZW50TWF0cml4LCB0YW5nZW50LCB0YW5nZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgIG5vcm1hbHNbaV0gPSBub3JtYWwyLng7CiAgICAgICAgICAgIG5vcm1hbHNbaTFdID0gbm9ybWFsMi55OwogICAgICAgICAgICBub3JtYWxzW2kyXSA9IG5vcm1hbDIuejsKICAgICAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgICAgICBub3JtYWxzW2kgKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIueDsKICAgICAgICAgICAgICBub3JtYWxzW2kxICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLnk7CiAgICAgICAgICAgICAgbm9ybWFsc1tpMiArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi56OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgdGFuZ2VudHNbaV0gPSB0YW5nZW50Lng7CiAgICAgICAgICAgIHRhbmdlbnRzW2kxXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgdGFuZ2VudHNbaTJdID0gdGFuZ2VudC56OwogICAgICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgICAgIHRhbmdlbnRzW2kgKyBib3R0b21PZmZzZXRdID0gLXRhbmdlbnQueDsKICAgICAgICAgICAgICB0YW5nZW50c1tpMSArIGJvdHRvbU9mZnNldF0gPSAtdGFuZ2VudC55OwogICAgICAgICAgICAgIHRhbmdlbnRzW2kyICsgYm90dG9tT2Zmc2V0XSA9IC10YW5nZW50Lno7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIHRhbmdlbnQsIGJpdGFuZ2VudCksCiAgICAgICAgICAgICAgYml0YW5nZW50CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbaV0gPSBiaXRhbmdlbnQueDsKICAgICAgICAgICAgYml0YW5nZW50c1tpMV0gPSBiaXRhbmdlbnQueTsKICAgICAgICAgICAgYml0YW5nZW50c1tpMl0gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2kgKyBib3R0b21PZmZzZXRdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tpMSArIGJvdHRvbU9mZnNldF0gPSBiaXRhbmdlbnQueTsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2kyICsgYm90dG9tT2Zmc2V0XSA9IGJpdGFuZ2VudC56OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIGxlbmd0aCA9IHRleHR1cmVDb29yZGluYXRlcy5sZW5ndGg7CiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgbGVuZ3RoOyBrICs9IDIpIHsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNba10gPSAodGV4dHVyZUNvb3JkaW5hdGVzW2tdIC0gbWluVGV4Q29vcmQueCkgLyAobWF4VGV4Q29vcmQueCAtIG1pblRleENvb3JkLngpOwogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1trICsgMV0gPSAodGV4dHVyZUNvb3JkaW5hdGVzW2sgKyAxXSAtIG1pblRleENvb3JkLnkpIC8gKG1heFRleENvb3JkLnkgLSBtaW5UZXhDb29yZC55KTsKICAgICAgfQogICAgfQogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICBjb25zdCBmaW5hbFBvc2l0aW9ucyA9IEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5yYWlzZVBvc2l0aW9uc1RvSGVpZ2h0KAogICAgICAgIHBvc2l0aW9ucywKICAgICAgICBvcHRpb25zLAogICAgICAgIGV4dHJ1ZGUKICAgICAgKTsKICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGZpbmFsUG9zaXRpb25zCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgdmFsdWVzOiB0ZXh0dXJlQ29vcmRpbmF0ZXMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICBhdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IHRhbmdlbnRzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgIGF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZXh0cnVkZU5vcm1hbHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAoZXh0cnVkZSAmJiBkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgIGxldCBvZmZzZXRBdHRyaWJ1dGUgPSBuZXcgVWludDhBcnJheShzaXplKTsKICAgICAgaWYgKG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKDEsIDAsIHNpemUgLyAyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgIH0KICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgdmFsdWVzOiBvZmZzZXRBdHRyaWJ1dGUKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gYXR0cmlidXRlczsKICB9CiAgZnVuY3Rpb24gdG9wSW5kaWNlcyhudW1QdHMpIHsKICAgIGNvbnN0IGluZGljZXMgPSBuZXcgQXJyYXkoMTIgKiAobnVtUHRzICogKG51bVB0cyArIDEpKSAtIDYpOwogICAgbGV0IGluZGljZXNJbmRleCA9IDA7CiAgICBsZXQgcHJldkluZGV4OwogICAgbGV0IG51bUludGVyaW9yOwogICAgbGV0IHBvc2l0aW9uSW5kZXg7CiAgICBsZXQgaTsKICAgIGxldCBqOwogICAgcHJldkluZGV4ID0gMDsKICAgIHBvc2l0aW9uSW5kZXggPSAxOwogICAgZm9yIChpID0gMDsgaSA8IDM7IGkrKykgewogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXgrKzsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXg7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleDsKICAgIH0KICAgIGZvciAoaSA9IDI7IGkgPCBudW1QdHMgKyAxOyArK2kpIHsKICAgICAgcG9zaXRpb25JbmRleCA9IGkgKiAoaSArIDEpIC0gMTsKICAgICAgcHJldkluZGV4ID0gKGkgLSAxKSAqIGkgLSAxOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXgrKzsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXg7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleDsKICAgICAgbnVtSW50ZXJpb3IgPSAyICogaTsKICAgICAgZm9yIChqID0gMDsgaiA8IG51bUludGVyaW9yIC0gMTsgKytqKSB7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4OwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4Kys7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXg7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4Kys7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXg7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4OwogICAgICB9CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcG9zaXRpb25JbmRleCsrOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4OwogICAgfQogICAgbnVtSW50ZXJpb3IgPSBudW1QdHMgKiAyOwogICAgKytwb3NpdGlvbkluZGV4OwogICAgKytwcmV2SW5kZXg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbnVtSW50ZXJpb3IgLSAxOyArK2kpIHsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4OwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleCsrOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4Kys7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICB9CiAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleCsrOwogICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXg7CiAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXgrKzsKICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4Kys7CiAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICsrcHJldkluZGV4OwogICAgZm9yIChpID0gbnVtUHRzIC0gMTsgaSA+IDE7IC0taSkgewogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleCsrOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4OwogICAgICBudW1JbnRlcmlvciA9IDIgKiBpOwogICAgICBmb3IgKGogPSAwOyBqIDwgbnVtSW50ZXJpb3IgLSAxOyArK2opIHsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXgrKzsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXgrKzsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHByZXZJbmRleDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICAgIH0KICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXgrKzsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwcmV2SW5kZXgrKzsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBwb3NpdGlvbkluZGV4Kys7CiAgICB9CiAgICBmb3IgKGkgPSAwOyBpIDwgMzsgaSsrKSB7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4Kys7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcHJldkluZGV4OwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHBvc2l0aW9uSW5kZXg7CiAgICB9CiAgICByZXR1cm4gaW5kaWNlczsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUVsbGlwc2Uob3B0aW9ucykgewogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBib3VuZGluZ1NwaGVyZUNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBvcHRpb25zLmVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoY2VudGVyLCBib3VuZGluZ1NwaGVyZUNlbnRlciksCiAgICAgIG9wdGlvbnMuaGVpZ2h0LAogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlcgogICAgKTsKICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgY2VudGVyLAogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlciwKICAgICAgYm91bmRpbmdTcGhlcmVDZW50ZXIKICAgICk7CiAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KAogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlciwKICAgICAgb3B0aW9ucy5zZW1pTWFqb3JBeGlzCiAgICApOwogICAgY29uc3QgY2VwID0gRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVFbGxpcHNlUG9zaXRpb25zKAogICAgICBvcHRpb25zLAogICAgICB0cnVlLAogICAgICBmYWxzZQogICAgKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IGNlcC5wb3NpdGlvbnM7CiAgICBjb25zdCBudW1QdHMgPSBjZXAubnVtUHRzOwogICAgY29uc3QgYXR0cmlidXRlcyA9IGNvbXB1dGVUb3BCb3R0b21BdHRyaWJ1dGVzKHBvc2l0aW9ucywgb3B0aW9ucywgZmFsc2UpOwogICAgbGV0IGluZGljZXMgPSB0b3BJbmRpY2VzKG51bVB0cyk7CiAgICBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkocG9zaXRpb25zLmxlbmd0aCAvIDMsIGluZGljZXMpOwogICAgcmV0dXJuIHsKICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVXYWxsQXR0cmlidXRlcyhwb3NpdGlvbnMsIG9wdGlvbnMpIHsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IG9wdGlvbnMudmVydGV4Rm9ybWF0OwogICAgY29uc3QgY2VudGVyID0gb3B0aW9ucy5jZW50ZXI7CiAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gb3B0aW9ucy5zZW1pTWFqb3JBeGlzOwogICAgY29uc3Qgc2VtaU1pbm9yQXhpcyA9IG9wdGlvbnMuc2VtaU1pbm9yQXhpczsKICAgIGNvbnN0IGVsbGlwc29pZCA9IG9wdGlvbnMuZWxsaXBzb2lkOwogICAgY29uc3QgaGVpZ2h0ID0gb3B0aW9ucy5oZWlnaHQ7CiAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQ7CiAgICBjb25zdCBzdFJvdGF0aW9uID0gb3B0aW9ucy5zdFJvdGF0aW9uOwogICAgY29uc3Qgc2l6ZSA9IHBvc2l0aW9ucy5sZW5ndGggLyAzICogMjsKICAgIGNvbnN0IGZpbmFsUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplICogMyk7CiAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSB2ZXJ0ZXhGb3JtYXQuc3QgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAyKSA6IHZvaWQgMDsKICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDMpIDogdm9pZCAwOwogICAgY29uc3Qgc2hhZG93Vm9sdW1lID0gb3B0aW9ucy5zaGFkb3dWb2x1bWU7CiAgICBjb25zdCBleHRydWRlTm9ybWFscyA9IHNoYWRvd1ZvbHVtZSA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDMpIDogdm9pZCAwOwogICAgbGV0IHRleHR1cmVDb29yZEluZGV4ID0gMDsKICAgIGxldCBub3JtYWwyID0gc2NyYXRjaE5vcm1hbDM7CiAgICBsZXQgdGFuZ2VudCA9IHNjcmF0Y2hUYW5nZW50OwogICAgbGV0IGJpdGFuZ2VudCA9IHNjcmF0Y2hCaXRhbmdlbnQ7CiAgICBjb25zdCBwcm9qZWN0aW9uID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoZWxsaXBzb2lkKTsKICAgIGNvbnN0IHByb2plY3RlZENlbnRlciA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGNlbnRlciwgc2NyYXRjaENhcnRvZ3JhcGhpYzIpLAogICAgICBwcm9qZWN0ZWRDZW50ZXJTY3JhdGNoCiAgICApOwogICAgY29uc3QgZ2VvZGV0aWNOb3JtYWwgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZSgKICAgICAgY2VudGVyLAogICAgICBzY3JhdGNoQ2FydGVzaWFuMTMKICAgICk7CiAgICBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGdlb2RldGljTm9ybWFsLCBnZW9kZXRpY05vcm1hbCk7CiAgICBjb25zdCByb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICBnZW9kZXRpY05vcm1hbCwKICAgICAgc3RSb3RhdGlvbiwKICAgICAgcXVhdGVybmlvblNjcmF0Y2gKICAgICk7CiAgICBjb25zdCB0ZXh0dXJlTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKHJvdGF0aW9uLCB0ZXh0dXJlTWF0cml4U2NyYXRjaCk7CiAgICBjb25zdCBtaW5UZXhDb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgIE51bWJlci5QT1NJVElWRV9JTkZJTklUWSwKICAgICAgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLAogICAgICBzY3JhdGNoTWluVGV4Q29vcmQKICAgICk7CiAgICBjb25zdCBtYXhUZXhDb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tRWxlbWVudHMoCiAgICAgIE51bWJlci5ORUdBVElWRV9JTkZJTklUWSwKICAgICAgTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLAogICAgICBzY3JhdGNoTWF4VGV4Q29vcmQKICAgICk7CiAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IHN0T2Zmc2V0ID0gbGVuZ3RoIC8gMyAqIDI7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGNvbnN0IGkxID0gaSArIDE7CiAgICAgIGNvbnN0IGkyID0gaSArIDI7CiAgICAgIGxldCBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpLCBzY3JhdGNoQ2FydGVzaWFuMTMpOwogICAgICBsZXQgZXh0cnVkZWRQb3NpdGlvbjsKICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgIGNvbnN0IHJvdGF0ZWRQb2ludCA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgICAgdGV4dHVyZU1hdHJpeCwKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjI0CiAgICAgICAgKTsKICAgICAgICBjb25zdCBwcm9qZWN0ZWRQb2ludCA9IHByb2plY3Rpb24ucHJvamVjdCgKICAgICAgICAgIGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhyb3RhdGVkUG9pbnQsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMyKSwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zNQogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHByb2plY3RlZFBvaW50LCBwcm9qZWN0ZWRDZW50ZXIsIHByb2plY3RlZFBvaW50KTsKICAgICAgICB0ZXhDb29yZFNjcmF0Y2gueCA9IChwcm9qZWN0ZWRQb2ludC54ICsgc2VtaU1ham9yQXhpcykgLyAoMiAqIHNlbWlNYWpvckF4aXMpOwogICAgICAgIHRleENvb3JkU2NyYXRjaC55ID0gKHByb2plY3RlZFBvaW50LnkgKyBzZW1pTWlub3JBeGlzKSAvICgyICogc2VtaU1pbm9yQXhpcyk7CiAgICAgICAgbWluVGV4Q29vcmQueCA9IE1hdGgubWluKHRleENvb3JkU2NyYXRjaC54LCBtaW5UZXhDb29yZC54KTsKICAgICAgICBtaW5UZXhDb29yZC55ID0gTWF0aC5taW4odGV4Q29vcmRTY3JhdGNoLnksIG1pblRleENvb3JkLnkpOwogICAgICAgIG1heFRleENvb3JkLnggPSBNYXRoLm1heCh0ZXhDb29yZFNjcmF0Y2gueCwgbWF4VGV4Q29vcmQueCk7CiAgICAgICAgbWF4VGV4Q29vcmQueSA9IE1hdGgubWF4KHRleENvb3JkU2NyYXRjaC55LCBtYXhUZXhDb29yZC55KTsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXggKyBzdE9mZnNldF0gPSB0ZXhDb29yZFNjcmF0Y2gueDsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXggKyAxICsgc3RPZmZzZXRdID0gdGV4Q29vcmRTY3JhdGNoLnk7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4KytdID0gdGV4Q29vcmRTY3JhdGNoLng7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4KytdID0gdGV4Q29vcmRTY3JhdGNoLnk7CiAgICAgIH0KICAgICAgcG9zaXRpb24gPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICBleHRydWRlZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCBzY3JhdGNoQ2FydGVzaWFuMjQpOwogICAgICBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICBleHRydWRlTm9ybWFsc1tpICsgbGVuZ3RoXSA9IC1ub3JtYWwyLng7CiAgICAgICAgZXh0cnVkZU5vcm1hbHNbaTEgKyBsZW5ndGhdID0gLW5vcm1hbDIueTsKICAgICAgICBleHRydWRlTm9ybWFsc1tpMiArIGxlbmd0aF0gPSAtbm9ybWFsMi56OwogICAgICB9CiAgICAgIGxldCBzY2FsZWROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICBub3JtYWwyLAogICAgICAgIGhlaWdodCwKICAgICAgICBzY3JhdGNoQ2FydGVzaWFuNAogICAgICApOwogICAgICBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIHNjYWxlZE5vcm1hbCwgcG9zaXRpb24pOwogICAgICBzY2FsZWROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICBub3JtYWwyLAogICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgIHNjYWxlZE5vcm1hbAogICAgICApOwogICAgICBleHRydWRlZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICBleHRydWRlZFBvc2l0aW9uLAogICAgICAgIHNjYWxlZE5vcm1hbCwKICAgICAgICBleHRydWRlZFBvc2l0aW9uCiAgICAgICk7CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgICBmaW5hbFBvc2l0aW9uc1tpICsgbGVuZ3RoXSA9IGV4dHJ1ZGVkUG9zaXRpb24ueDsKICAgICAgICBmaW5hbFBvc2l0aW9uc1tpMSArIGxlbmd0aF0gPSBleHRydWRlZFBvc2l0aW9uLnk7CiAgICAgICAgZmluYWxQb3NpdGlvbnNbaTIgKyBsZW5ndGhdID0gZXh0cnVkZWRQb3NpdGlvbi56OwogICAgICAgIGZpbmFsUG9zaXRpb25zW2ldID0gcG9zaXRpb24ueDsKICAgICAgICBmaW5hbFBvc2l0aW9uc1tpMV0gPSBwb3NpdGlvbi55OwogICAgICAgIGZpbmFsUG9zaXRpb25zW2kyXSA9IHBvc2l0aW9uLno7CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShub3JtYWwyLCBiaXRhbmdlbnQpOwogICAgICAgIGNvbnN0IG5leHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgKGkgKyAzKSAlIGxlbmd0aCwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW40CiAgICAgICAgKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobmV4dCwgcG9zaXRpb24sIG5leHQpOwogICAgICAgIGNvbnN0IGJvdHRvbSA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIGV4dHJ1ZGVkUG9zaXRpb24sCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zNQogICAgICAgICk7CiAgICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoYm90dG9tLCBuZXh0LCBub3JtYWwyKSwKICAgICAgICAgIG5vcm1hbDIKICAgICAgICApOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBub3JtYWxzW2ldID0gbm9ybWFsMi54OwogICAgICAgICAgbm9ybWFsc1tpMV0gPSBub3JtYWwyLnk7CiAgICAgICAgICBub3JtYWxzW2kyXSA9IG5vcm1hbDIuejsKICAgICAgICAgIG5vcm1hbHNbaSArIGxlbmd0aF0gPSBub3JtYWwyLng7CiAgICAgICAgICBub3JtYWxzW2kxICsgbGVuZ3RoXSA9IG5vcm1hbDIueTsKICAgICAgICAgIG5vcm1hbHNbaTIgKyBsZW5ndGhdID0gbm9ybWFsMi56OwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgIHRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoYml0YW5nZW50LCBub3JtYWwyLCB0YW5nZW50KSwKICAgICAgICAgICAgdGFuZ2VudAogICAgICAgICAgKTsKICAgICAgICAgIHRhbmdlbnRzW2ldID0gdGFuZ2VudC54OwogICAgICAgICAgdGFuZ2VudHNbaTFdID0gdGFuZ2VudC55OwogICAgICAgICAgdGFuZ2VudHNbaTJdID0gdGFuZ2VudC56OwogICAgICAgICAgdGFuZ2VudHNbaSArIGxlbmd0aF0gPSB0YW5nZW50Lng7CiAgICAgICAgICB0YW5nZW50c1tpICsgMSArIGxlbmd0aF0gPSB0YW5nZW50Lnk7CiAgICAgICAgICB0YW5nZW50c1tpICsgMiArIGxlbmd0aF0gPSB0YW5nZW50Lno7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBiaXRhbmdlbnRzW2ldID0gYml0YW5nZW50Lng7CiAgICAgICAgICBiaXRhbmdlbnRzW2kxXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgYml0YW5nZW50c1tpMl0gPSBiaXRhbmdlbnQuejsKICAgICAgICAgIGJpdGFuZ2VudHNbaSArIGxlbmd0aF0gPSBiaXRhbmdlbnQueDsKICAgICAgICAgIGJpdGFuZ2VudHNbaTEgKyBsZW5ndGhdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICBiaXRhbmdlbnRzW2kyICsgbGVuZ3RoXSA9IGJpdGFuZ2VudC56OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBsZW5ndGggPSB0ZXh0dXJlQ29vcmRpbmF0ZXMubGVuZ3RoOwogICAgICBmb3IgKGxldCBrID0gMDsgayA8IGxlbmd0aDsgayArPSAyKSB7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW2tdID0gKHRleHR1cmVDb29yZGluYXRlc1trXSAtIG1pblRleENvb3JkLngpIC8gKG1heFRleENvb3JkLnggLSBtaW5UZXhDb29yZC54KTsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbayArIDFdID0gKHRleHR1cmVDb29yZGluYXRlc1trICsgMV0gLSBtaW5UZXhDb29yZC55KSAvIChtYXhUZXhDb29yZC55IC0gbWluVGV4Q29vcmQueSk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGZpbmFsUG9zaXRpb25zCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgdmFsdWVzOiB0ZXh0dXJlQ29vcmRpbmF0ZXMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICBhdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IHRhbmdlbnRzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgIGF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZXh0cnVkZU5vcm1hbHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlKSkgewogICAgICBsZXQgb2Zmc2V0QXR0cmlidXRlID0gbmV3IFVpbnQ4QXJyYXkoc2l6ZSk7CiAgICAgIGlmIChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbCgxLCAwLCBzaXplIC8gMik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICB9CiAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgIHZhbHVlczogb2Zmc2V0QXR0cmlidXRlCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVXYWxsSW5kaWNlcyhwb3NpdGlvbnMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KGxlbmd0aCwgbGVuZ3RoICogNik7CiAgICBsZXQgaW5kZXggPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBjb25zdCBVTCA9IGk7CiAgICAgIGNvbnN0IExMID0gaSArIGxlbmd0aDsKICAgICAgY29uc3QgVVIgPSAoVUwgKyAxKSAlIGxlbmd0aDsKICAgICAgY29uc3QgTFIgPSBVUiArIGxlbmd0aDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVMOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMUjsKICAgIH0KICAgIHJldHVybiBpbmRpY2VzOwogIH0KICBmdW5jdGlvbiBjb21wdXRlRXh0cnVkZWRFbGxpcHNlKG9wdGlvbnMpIHsKICAgIGNvbnN0IGNlbnRlciA9IG9wdGlvbnMuY2VudGVyOwogICAgY29uc3QgZWxsaXBzb2lkID0gb3B0aW9ucy5lbGxpcHNvaWQ7CiAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gb3B0aW9ucy5zZW1pTWFqb3JBeGlzOwogICAgbGV0IHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGNlbnRlciwgc2NyYXRjaENhcnRlc2lhbjEzKSwKICAgICAgb3B0aW9ucy5oZWlnaHQsCiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xMwogICAgKTsKICAgIHRvcEJvdW5kaW5nU3BoZXJlLmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgIGNlbnRlciwKICAgICAgc2NhbGVkTm9ybWFsLAogICAgICB0b3BCb3VuZGluZ1NwaGVyZS5jZW50ZXIKICAgICk7CiAgICB0b3BCb3VuZGluZ1NwaGVyZS5yYWRpdXMgPSBzZW1pTWFqb3JBeGlzOwogICAgc2NhbGVkTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoY2VudGVyLCBzY2FsZWROb3JtYWwpLAogICAgICBvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LAogICAgICBzY2FsZWROb3JtYWwKICAgICk7CiAgICBib3R0b21Cb3VuZGluZ1NwaGVyZS5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICBjZW50ZXIsCiAgICAgIHNjYWxlZE5vcm1hbCwKICAgICAgYm90dG9tQm91bmRpbmdTcGhlcmUuY2VudGVyCiAgICApOwogICAgYm90dG9tQm91bmRpbmdTcGhlcmUucmFkaXVzID0gc2VtaU1ham9yQXhpczsKICAgIGNvbnN0IGNlcCA9IEVsbGlwc2VHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlRWxsaXBzZVBvc2l0aW9ucygKICAgICAgb3B0aW9ucywKICAgICAgdHJ1ZSwKICAgICAgdHJ1ZQogICAgKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IGNlcC5wb3NpdGlvbnM7CiAgICBjb25zdCBudW1QdHMgPSBjZXAubnVtUHRzOwogICAgY29uc3Qgb3V0ZXJQb3NpdGlvbnMgPSBjZXAub3V0ZXJQb3NpdGlvbnM7CiAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5pb24oCiAgICAgIHRvcEJvdW5kaW5nU3BoZXJlLAogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZQogICAgKTsKICAgIGNvbnN0IHRvcEJvdHRvbUF0dHJpYnV0ZXMgPSBjb21wdXRlVG9wQm90dG9tQXR0cmlidXRlcygKICAgICAgcG9zaXRpb25zLAogICAgICBvcHRpb25zLAogICAgICB0cnVlCiAgICApOwogICAgbGV0IGluZGljZXMgPSB0b3BJbmRpY2VzKG51bVB0cyk7CiAgICBjb25zdCBsZW5ndGggPSBpbmRpY2VzLmxlbmd0aDsKICAgIGluZGljZXMubGVuZ3RoID0gbGVuZ3RoICogMjsKICAgIGNvbnN0IHBvc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICBpbmRpY2VzW2kgKyBsZW5ndGhdID0gaW5kaWNlc1tpICsgMl0gKyBwb3NMZW5ndGg7CiAgICAgIGluZGljZXNbaSArIDEgKyBsZW5ndGhdID0gaW5kaWNlc1tpICsgMV0gKyBwb3NMZW5ndGg7CiAgICAgIGluZGljZXNbaSArIDIgKyBsZW5ndGhdID0gaW5kaWNlc1tpXSArIHBvc0xlbmd0aDsKICAgIH0KICAgIGNvbnN0IHRvcEJvdHRvbUluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgcG9zTGVuZ3RoICogMiAvIDMsCiAgICAgIGluZGljZXMKICAgICk7CiAgICBjb25zdCB0b3BCb3R0b21HZW8gPSBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXM6IHRvcEJvdHRvbUF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXM6IHRvcEJvdHRvbUluZGljZXMsCiAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMKICAgIH0pOwogICAgY29uc3Qgd2FsbEF0dHJpYnV0ZXMgPSBjb21wdXRlV2FsbEF0dHJpYnV0ZXMob3V0ZXJQb3NpdGlvbnMsIG9wdGlvbnMpOwogICAgaW5kaWNlcyA9IGNvbXB1dGVXYWxsSW5kaWNlcyhvdXRlclBvc2l0aW9ucyk7CiAgICBjb25zdCB3YWxsSW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBvdXRlclBvc2l0aW9ucy5sZW5ndGggKiAyIC8gMywKICAgICAgaW5kaWNlcwogICAgKTsKICAgIGNvbnN0IHdhbGxHZW8gPSBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXM6IHdhbGxBdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzOiB3YWxsSW5kaWNlcywKICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgfSk7CiAgICBjb25zdCBnZW8gPSBHZW9tZXRyeVBpcGVsaW5lX2RlZmF1bHQuY29tYmluZUluc3RhbmNlcyhbCiAgICAgIG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgIGdlb21ldHJ5OiB0b3BCb3R0b21HZW8KICAgICAgfSksCiAgICAgIG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgIGdlb21ldHJ5OiB3YWxsR2VvCiAgICAgIH0pCiAgICBdKTsKICAgIHJldHVybiB7CiAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICBhdHRyaWJ1dGVzOiBnZW9bMF0uYXR0cmlidXRlcywKICAgICAgaW5kaWNlczogZ2VvWzBdLmluZGljZXMKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVSZWN0YW5nbGUoY2VudGVyLCBzZW1pTWFqb3JBeGlzLCBzZW1pTWlub3JBeGlzLCByb3RhdGlvbiwgZ3JhbnVsYXJpdHksIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICBjb25zdCBjZXAgPSBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUVsbGlwc2VQb3NpdGlvbnMoCiAgICAgIHsKICAgICAgICBjZW50ZXIsCiAgICAgICAgc2VtaU1ham9yQXhpcywKICAgICAgICBzZW1pTWlub3JBeGlzLAogICAgICAgIHJvdGF0aW9uLAogICAgICAgIGdyYW51bGFyaXR5CiAgICAgIH0sCiAgICAgIGZhbHNlLAogICAgICB0cnVlCiAgICApOwogICAgY29uc3QgcG9zaXRpb25zRmxhdCA9IGNlcC5vdXRlclBvc2l0aW9uczsKICAgIGNvbnN0IHBvc2l0aW9uc0NvdW50ID0gcG9zaXRpb25zRmxhdC5sZW5ndGggLyAzOwogICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KHBvc2l0aW9uc0NvdW50KTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zQ291bnQ7ICsraSkgewogICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9uc0ZsYXQsIGkgKiAzKTsKICAgIH0KICAgIGNvbnN0IHJlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmZyb21DYXJ0ZXNpYW5BcnJheShwb3NpdGlvbnMsIGVsbGlwc29pZCwgcmVzdWx0KTsKICAgIGlmIChyZWN0YW5nbGUud2lkdGggPiBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgcmVjdGFuZ2xlLm5vcnRoID0gcmVjdGFuZ2xlLm5vcnRoID4gMCA/IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIE1hdGhfZGVmYXVsdC5FUFNJTE9ONyA6IHJlY3RhbmdsZS5ub3J0aDsKICAgICAgcmVjdGFuZ2xlLnNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoIDwgMCA/IE1hdGhfZGVmYXVsdC5FUFNJTE9ONyAtIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyA6IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgcmVjdGFuZ2xlLmVhc3QgPSBNYXRoX2RlZmF1bHQuUEk7CiAgICAgIHJlY3RhbmdsZS53ZXN0ID0gLU1hdGhfZGVmYXVsdC5QSTsKICAgIH0KICAgIHJldHVybiByZWN0YW5nbGU7CiAgfQogIGZ1bmN0aW9uIEVsbGlwc2VHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IGNlbnRlciA9IG9wdGlvbnMuY2VudGVyOwogICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIGNvbnN0IHNlbWlNYWpvckF4aXMgPSBvcHRpb25zLnNlbWlNYWpvckF4aXM7CiAgICBjb25zdCBzZW1pTWlub3JBeGlzID0gb3B0aW9ucy5zZW1pTWlub3JBeGlzOwogICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKTsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgib3B0aW9ucy5jZW50ZXIiLCBjZW50ZXIpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJvcHRpb25zLnNlbWlNYWpvckF4aXMiLCBzZW1pTWFqb3JBeGlzKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigib3B0aW9ucy5zZW1pTWlub3JBeGlzIiwgc2VtaU1pbm9yQXhpcyk7CiAgICBpZiAoc2VtaU1ham9yQXhpcyA8IHNlbWlNaW5vckF4aXMpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgInNlbWlNYWpvckF4aXMgbXVzdCBiZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gdGhlIHNlbWlNaW5vckF4aXMuIgogICAgICApOwogICAgfQogICAgaWYgKGdyYW51bGFyaXR5IDw9IDApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImdyYW51bGFyaXR5IG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICB9CiAgICBjb25zdCBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmhlaWdodCwgMCk7CiAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICB0aGlzLl9jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyKTsKICAgIHRoaXMuX3NlbWlNYWpvckF4aXMgPSBzZW1pTWFqb3JBeGlzOwogICAgdGhpcy5fc2VtaU1pbm9yQXhpcyA9IHNlbWlNaW5vckF4aXM7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQpOwogICAgdGhpcy5fcm90YXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJvdGF0aW9uLCAwKTsKICAgIHRoaXMuX3N0Um90YXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN0Um90YXRpb24sIDApOwogICAgdGhpcy5faGVpZ2h0ID0gTWF0aC5tYXgoZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0KTsKICAgIHRoaXMuX2V4dHJ1ZGVkSGVpZ2h0ID0gTWF0aC5taW4oZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICB0aGlzLl9zaGFkb3dWb2x1bWUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnNoYWRvd1ZvbHVtZSwgZmFsc2UpOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVFbGxpcHNlR2VvbWV0cnkiOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl9yZWN0YW5nbGUgPSB2b2lkIDA7CiAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzID0gdm9pZCAwOwogIH0KICBmdW5jdGlvbiB0ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzKGVsbGlwc2VHZW9tZXRyeSkgewogICAgY29uc3Qgc3RSb3RhdGlvbiA9IC1lbGxpcHNlR2VvbWV0cnkuX3N0Um90YXRpb247CiAgICBpZiAoc3RSb3RhdGlvbiA9PT0gMCkgewogICAgICByZXR1cm4gWzAsIDAsIDAsIDEsIDEsIDBdOwogICAgfQogICAgY29uc3QgY2VwID0gRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVFbGxpcHNlUG9zaXRpb25zKAogICAgICB7CiAgICAgICAgY2VudGVyOiBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlciwKICAgICAgICBzZW1pTWFqb3JBeGlzOiBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXMsCiAgICAgICAgc2VtaU1pbm9yQXhpczogZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWlub3JBeGlzLAogICAgICAgIHJvdGF0aW9uOiBlbGxpcHNlR2VvbWV0cnkuX3JvdGF0aW9uLAogICAgICAgIGdyYW51bGFyaXR5OiBlbGxpcHNlR2VvbWV0cnkuX2dyYW51bGFyaXR5CiAgICAgIH0sCiAgICAgIGZhbHNlLAogICAgICB0cnVlCiAgICApOwogICAgY29uc3QgcG9zaXRpb25zRmxhdCA9IGNlcC5vdXRlclBvc2l0aW9uczsKICAgIGNvbnN0IHBvc2l0aW9uc0NvdW50ID0gcG9zaXRpb25zRmxhdC5sZW5ndGggLyAzOwogICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KHBvc2l0aW9uc0NvdW50KTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zQ291bnQ7ICsraSkgewogICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9uc0ZsYXQsIGkgKiAzKTsKICAgIH0KICAgIGNvbnN0IGVsbGlwc29pZCA9IGVsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgY29uc3QgYm91bmRpbmdSZWN0YW5nbGUgPSBlbGxpcHNlR2VvbWV0cnkucmVjdGFuZ2xlOwogICAgcmV0dXJuIEdlb21ldHJ5X2RlZmF1bHQuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMoCiAgICAgIHBvc2l0aW9ucywKICAgICAgc3RSb3RhdGlvbiwKICAgICAgZWxsaXBzb2lkLAogICAgICBib3VuZGluZ1JlY3RhbmdsZQogICAgKTsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4xMywgc2NyYXRjaENhcnRlc2lhbjI0LCBzY3JhdGNoQ2FydGVzaWFuMzUsIHNjcmF0Y2hDYXJ0ZXNpYW40LCB0ZXhDb29yZFNjcmF0Y2gsIHRleHR1cmVNYXRyaXhTY3JhdGNoLCB0YW5nZW50TWF0cml4U2NyYXRjaCwgcXVhdGVybmlvblNjcmF0Y2gsIHNjcmF0Y2hOb3JtYWwzLCBzY3JhdGNoVGFuZ2VudCwgc2NyYXRjaEJpdGFuZ2VudCwgc2NyYXRjaENhcnRvZ3JhcGhpYzIsIHByb2plY3RlZENlbnRlclNjcmF0Y2gsIHNjcmF0Y2hNaW5UZXhDb29yZCwgc2NyYXRjaE1heFRleENvb3JkLCBib3VuZGluZ1NwaGVyZUNlbnRlciwgdG9wQm91bmRpbmdTcGhlcmUsIGJvdHRvbUJvdW5kaW5nU3BoZXJlLCBzY3JhdGNoQ2VudGVyMiwgc2NyYXRjaEVsbGlwc29pZCwgc2NyYXRjaFZlcnRleEZvcm1hdDIsIHNjcmF0Y2hPcHRpb25zMywgRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfRWxsaXBzZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNlR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzZUdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5SW5zdGFuY2UoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5UGlwZWxpbmUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjM1ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdGV4Q29vcmRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICB0ZXh0dXJlTWF0cml4U2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgdGFuZ2VudE1hdHJpeFNjcmF0Y2ggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHF1YXRlcm5pb25TY3JhdGNoID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTm9ybWFsMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFRhbmdlbnQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCaXRhbmdlbnQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMyID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHByb2plY3RlZENlbnRlclNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hNaW5UZXhDb29yZCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1heFRleENvb3JkID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdG9wQm91bmRpbmdTcGhlcmUgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZSA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCk7CiAgICAgIEVsbGlwc2VHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgOTsKICAgICAgRWxsaXBzZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9jZW50ZXIsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zZW1pTWFqb3JBeGlzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc2VtaU1pbm9yQXhpczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3JvdGF0aW9uOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc3RSb3RhdGlvbjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2hlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2dyYW51bGFyaXR5OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zaGFkb3dWb2x1bWUgPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDZW50ZXIyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRWxsaXBzb2lkID0gbmV3IEVsbGlwc29pZF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQyID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMyA9IHsKICAgICAgICBjZW50ZXI6IHNjcmF0Y2hDZW50ZXIyLAogICAgICAgIGVsbGlwc29pZDogc2NyYXRjaEVsbGlwc29pZCwKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQyLAogICAgICAgIHNlbWlNYWpvckF4aXM6IHZvaWQgMCwKICAgICAgICBzZW1pTWlub3JBeGlzOiB2b2lkIDAsCiAgICAgICAgcm90YXRpb246IHZvaWQgMCwKICAgICAgICBzdFJvdGF0aW9uOiB2b2lkIDAsCiAgICAgICAgaGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICBleHRydWRlZEhlaWdodDogdm9pZCAwLAogICAgICAgIHNoYWRvd1ZvbHVtZTogdm9pZCAwLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIEVsbGlwc2VHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaENlbnRlcjIpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQyCiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzZW1pTWlub3JBeGlzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc3RSb3RhdGlvbiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNoYWRvd1ZvbHVtZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMzLmhlaWdodCA9IGhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMy5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMzLmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczMuc3RSb3RhdGlvbiA9IHN0Um90YXRpb247CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczMucm90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMy5zZW1pTWFqb3JBeGlzID0gc2VtaU1ham9yQXhpczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMy5zZW1pTWlub3JBeGlzID0gc2VtaU1pbm9yQXhpczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMy5zaGFkb3dWb2x1bWUgPSBzaGFkb3dWb2x1bWU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczMub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgRWxsaXBzZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0Ll9jZW50ZXIpOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLCByZXN1bHQuX2VsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXN1bHQuX3NlbWlNYWpvckF4aXMgPSBzZW1pTWFqb3JBeGlzOwogICAgICAgIHJlc3VsdC5fc2VtaU1pbm9yQXhpcyA9IHNlbWlNaW5vckF4aXM7CiAgICAgICAgcmVzdWx0Ll9yb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICAgIHJlc3VsdC5fc3RSb3RhdGlvbiA9IHN0Um90YXRpb247CiAgICAgICAgcmVzdWx0Ll9oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJlc3VsdC5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICByZXN1bHQuX3NoYWRvd1ZvbHVtZSA9IHNoYWRvd1ZvbHVtZTsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzZUdlb21ldHJ5LmNvbXB1dGVSZWN0YW5nbGUgPSBmdW5jdGlvbihvcHRpb25zLCByZXN1bHQpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBjb25zdCBjZW50ZXIgPSBvcHRpb25zLmNlbnRlcjsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGNvbnN0IHNlbWlNYWpvckF4aXMgPSBvcHRpb25zLnNlbWlNYWpvckF4aXM7CiAgICAgICAgY29uc3Qgc2VtaU1pbm9yQXhpcyA9IG9wdGlvbnMuc2VtaU1pbm9yQXhpczsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICAgICApOwogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yb3RhdGlvbiwgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLmNlbnRlciIsIGNlbnRlcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJvcHRpb25zLnNlbWlNYWpvckF4aXMiLCBzZW1pTWFqb3JBeGlzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm9wdGlvbnMuc2VtaU1pbm9yQXhpcyIsIHNlbWlNaW5vckF4aXMpOwogICAgICAgIGlmIChzZW1pTWFqb3JBeGlzIDwgc2VtaU1pbm9yQXhpcykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJzZW1pTWFqb3JBeGlzIG11c3QgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIHRoZSBzZW1pTWlub3JBeGlzLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChncmFudWxhcml0eSA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZ3JhbnVsYXJpdHkgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbXB1dGVSZWN0YW5nbGUoCiAgICAgICAgICBjZW50ZXIsCiAgICAgICAgICBzZW1pTWFqb3JBeGlzLAogICAgICAgICAgc2VtaU1pbm9yQXhpcywKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNlR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihlbGxpcHNlR2VvbWV0cnkpIHsKICAgICAgICBpZiAoZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWFqb3JBeGlzIDw9IDAgfHwgZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWlub3JBeGlzIDw9IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gZWxsaXBzZUdlb21ldHJ5Ll9oZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGUgPSAhTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgIDAsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjIKICAgICAgICApOwogICAgICAgIGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyID0gZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZSgKICAgICAgICAgIGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyLAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIKICAgICAgICApOwogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICBjZW50ZXI6IGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyLAogICAgICAgICAgc2VtaU1ham9yQXhpczogZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWFqb3JBeGlzLAogICAgICAgICAgc2VtaU1pbm9yQXhpczogZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWlub3JBeGlzLAogICAgICAgICAgZWxsaXBzb2lkOiBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCwKICAgICAgICAgIHJvdGF0aW9uOiBlbGxpcHNlR2VvbWV0cnkuX3JvdGF0aW9uLAogICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgZ3JhbnVsYXJpdHk6IGVsbGlwc2VHZW9tZXRyeS5fZ3JhbnVsYXJpdHksCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IGVsbGlwc2VHZW9tZXRyeS5fdmVydGV4Rm9ybWF0LAogICAgICAgICAgc3RSb3RhdGlvbjogZWxsaXBzZUdlb21ldHJ5Ll9zdFJvdGF0aW9uCiAgICAgICAgfTsKICAgICAgICBsZXQgZ2VvbWV0cnk7CiAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgIG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICAgIG9wdGlvbnMuc2hhZG93Vm9sdW1lID0gZWxsaXBzZUdlb21ldHJ5Ll9zaGFkb3dWb2x1bWU7CiAgICAgICAgICBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9IGVsbGlwc2VHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgZ2VvbWV0cnkgPSBjb21wdXRlRXh0cnVkZWRFbGxpcHNlKG9wdGlvbnMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBnZW9tZXRyeSA9IGNvbXB1dGVFbGxpcHNlKG9wdGlvbnMpOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlbGxpcHNlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGVsbGlwc2VHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IGdlb21ldHJ5LmF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBnZW9tZXRyeS5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogZWxsaXBzZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgRWxsaXBzZUdlb21ldHJ5LmNyZWF0ZVNoYWRvd1ZvbHVtZSA9IGZ1bmN0aW9uKGVsbGlwc2VHZW9tZXRyeSwgbWluSGVpZ2h0RnVuYywgbWF4SGVpZ2h0RnVuYykgewogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZWxsaXBzZUdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBtaW5IZWlnaHQgPSBtaW5IZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IG1heEhlaWdodCA9IG1heEhlaWdodEZ1bmMoZ3JhbnVsYXJpdHksIGVsbGlwc29pZCk7CiAgICAgICAgcmV0dXJuIG5ldyBFbGxpcHNlR2VvbWV0cnkoewogICAgICAgICAgY2VudGVyOiBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlciwKICAgICAgICAgIHNlbWlNYWpvckF4aXM6IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1ham9yQXhpcywKICAgICAgICAgIHNlbWlNaW5vckF4aXM6IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1pbm9yQXhpcywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHJvdGF0aW9uOiBlbGxpcHNlR2VvbWV0cnkuX3JvdGF0aW9uLAogICAgICAgICAgc3RSb3RhdGlvbjogZWxsaXBzZUdlb21ldHJ5Ll9zdFJvdGF0aW9uLAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBleHRydWRlZEhlaWdodDogbWluSGVpZ2h0LAogICAgICAgICAgaGVpZ2h0OiBtYXhIZWlnaHQsCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IFZlcnRleEZvcm1hdF9kZWZhdWx0LlBPU0lUSU9OX09OTFksCiAgICAgICAgICBzaGFkb3dWb2x1bWU6IHRydWUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoRWxsaXBzZUdlb21ldHJ5LnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgcmVjdGFuZ2xlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9yZWN0YW5nbGUpKSB7CiAgICAgICAgICAgICAgdGhpcy5fcmVjdGFuZ2xlID0gY29tcHV0ZVJlY3RhbmdsZSgKICAgICAgICAgICAgICAgIHRoaXMuX2NlbnRlciwKICAgICAgICAgICAgICAgIHRoaXMuX3NlbWlNYWpvckF4aXMsCiAgICAgICAgICAgICAgICB0aGlzLl9zZW1pTWlub3JBeGlzLAogICAgICAgICAgICAgICAgdGhpcy5fcm90YXRpb24sCiAgICAgICAgICAgICAgICB0aGlzLl9ncmFudWxhcml0eSwKICAgICAgICAgICAgICAgIHRoaXMuX2VsbGlwc29pZAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlY3RhbmdsZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEZvciByZW1hcHBpbmcgdGV4dHVyZSBjb29yZGluYXRlcyB3aGVuIHJlbmRlcmluZyBFbGxpcHNlR2VvbWV0cmllcyBhcyBHcm91bmRQcmltaXRpdmVzLgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cykpIHsKICAgICAgICAgICAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzID0gdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cygKICAgICAgICAgICAgICAgIHRoaXMKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0ID0gRWxsaXBzZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2lyY2xlR2VvbWV0cnkuanMKICBmdW5jdGlvbiBDaXJjbGVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHJhZGl1cyA9IG9wdGlvbnMucmFkaXVzOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJyYWRpdXMiLCByYWRpdXMpOwogICAgY29uc3QgZWxsaXBzZUdlb21ldHJ5T3B0aW9ucyA9IHsKICAgICAgY2VudGVyOiBvcHRpb25zLmNlbnRlciwKICAgICAgc2VtaU1ham9yQXhpczogcmFkaXVzLAogICAgICBzZW1pTWlub3JBeGlzOiByYWRpdXMsCiAgICAgIGVsbGlwc29pZDogb3B0aW9ucy5lbGxpcHNvaWQsCiAgICAgIGhlaWdodDogb3B0aW9ucy5oZWlnaHQsCiAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiBvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LAogICAgICBncmFudWxhcml0eTogb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgdmVydGV4Rm9ybWF0OiBvcHRpb25zLnZlcnRleEZvcm1hdCwKICAgICAgc3RSb3RhdGlvbjogb3B0aW9ucy5zdFJvdGF0aW9uLAogICAgICBzaGFkb3dWb2x1bWU6IG9wdGlvbnMuc2hhZG93Vm9sdW1lCiAgICB9OwogICAgdGhpcy5fZWxsaXBzZUdlb21ldHJ5ID0gbmV3IEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0KGVsbGlwc2VHZW9tZXRyeU9wdGlvbnMpOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVDaXJjbGVHZW9tZXRyeSI7CiAgfQogIHZhciBzY3JhdGNoRWxsaXBzZUdlb21ldHJ5LCBzY3JhdGNoT3B0aW9uczQsIENpcmNsZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ2lyY2xlR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NpcmNsZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzZUdlb21ldHJ5KCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIENpcmNsZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgQ2lyY2xlR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgcmV0dXJuIEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc2VHZW9tZXRyeSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzZUdlb21ldHJ5ID0gbmV3IEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICBjZW50ZXI6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICBzZW1pTWFqb3JBeGlzOiAxLAogICAgICAgIHNlbWlNaW5vckF4aXM6IDEKICAgICAgfSk7CiAgICAgIHNjcmF0Y2hPcHRpb25zNCA9IHsKICAgICAgICBjZW50ZXI6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICByYWRpdXM6IHZvaWQgMCwKICAgICAgICBlbGxpcHNvaWQ6IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKSwKICAgICAgICBoZWlnaHQ6IHZvaWQgMCwKICAgICAgICBleHRydWRlZEhlaWdodDogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAsCiAgICAgICAgdmVydGV4Rm9ybWF0OiBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKSwKICAgICAgICBzdFJvdGF0aW9uOiB2b2lkIDAsCiAgICAgICAgc2VtaU1ham9yQXhpczogdm9pZCAwLAogICAgICAgIHNlbWlNaW5vckF4aXM6IHZvaWQgMCwKICAgICAgICBzaGFkb3dWb2x1bWU6IHZvaWQgMAogICAgICB9OwogICAgICBDaXJjbGVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgZWxsaXBzZUdlb21ldHJ5ID0gRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaEVsbGlwc2VHZW9tZXRyeQogICAgICAgICk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgIGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyLAogICAgICAgICAgc2NyYXRjaE9wdGlvbnM0LmNlbnRlcgogICAgICAgICk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LmVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQsCiAgICAgICAgICBzY3JhdGNoT3B0aW9uczQuZWxsaXBzb2lkCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczQuaGVpZ2h0ID0gZWxsaXBzZUdlb21ldHJ5Ll9oZWlnaHQ7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LmV4dHJ1ZGVkSGVpZ2h0ID0gZWxsaXBzZUdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgICAgICBzY3JhdGNoT3B0aW9uczQuZ3JhbnVsYXJpdHkgPSBlbGxpcHNlR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIHNjcmF0Y2hPcHRpb25zNC52ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgIGVsbGlwc2VHZW9tZXRyeS5fdmVydGV4Rm9ybWF0LAogICAgICAgICAgc2NyYXRjaE9wdGlvbnM0LnZlcnRleEZvcm1hdAogICAgICAgICk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LnN0Um90YXRpb24gPSBlbGxpcHNlR2VvbWV0cnkuX3N0Um90YXRpb247CiAgICAgICAgc2NyYXRjaE9wdGlvbnM0LnNoYWRvd1ZvbHVtZSA9IGVsbGlwc2VHZW9tZXRyeS5fc2hhZG93Vm9sdW1lOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNC5yYWRpdXMgPSBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXM7CiAgICAgICAgICByZXR1cm4gbmV3IENpcmNsZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zNCk7CiAgICAgICAgfQogICAgICAgIHNjcmF0Y2hPcHRpb25zNC5zZW1pTWFqb3JBeGlzID0gZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWFqb3JBeGlzOwogICAgICAgIHNjcmF0Y2hPcHRpb25zNC5zZW1pTWlub3JBeGlzID0gZWxsaXBzZUdlb21ldHJ5Ll9zZW1pTWlub3JBeGlzOwogICAgICAgIHJlc3VsdC5fZWxsaXBzZUdlb21ldHJ5ID0gbmV3IEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0KHNjcmF0Y2hPcHRpb25zNCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ2lyY2xlR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihjaXJjbGVHZW9tZXRyeSkgewogICAgICAgIHJldHVybiBFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5KTsKICAgICAgfTsKICAgICAgQ2lyY2xlR2VvbWV0cnkuY3JlYXRlU2hhZG93Vm9sdW1lID0gZnVuY3Rpb24oY2lyY2xlR2VvbWV0cnksIG1pbkhlaWdodEZ1bmMsIG1heEhlaWdodEZ1bmMpIHsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBtaW5IZWlnaHQgPSBtaW5IZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IG1heEhlaWdodCA9IG1heEhlaWdodEZ1bmMoZ3JhbnVsYXJpdHksIGVsbGlwc29pZCk7CiAgICAgICAgcmV0dXJuIG5ldyBDaXJjbGVHZW9tZXRyeSh7CiAgICAgICAgICBjZW50ZXI6IGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2NlbnRlciwKICAgICAgICAgIHJhZGl1czogY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fc2VtaU1ham9yQXhpcywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHN0Um90YXRpb246IGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX3N0Um90YXRpb24sCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiBtaW5IZWlnaHQsCiAgICAgICAgICBoZWlnaHQ6IG1heEhlaWdodCwKICAgICAgICAgIHZlcnRleEZvcm1hdDogVmVydGV4Rm9ybWF0X2RlZmF1bHQuUE9TSVRJT05fT05MWSwKICAgICAgICAgIHNoYWRvd1ZvbHVtZTogdHJ1ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhDaXJjbGVHZW9tZXRyeS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHJlY3RhbmdsZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsbGlwc2VHZW9tZXRyeS5yZWN0YW5nbGU7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBGb3IgcmVtYXBwaW5nIHRleHR1cmUgY29vcmRpbmF0ZXMgd2hlbiByZW5kZXJpbmcgQ2lyY2xlR2VvbWV0cmllcyBhcyBHcm91bmRQcmltaXRpdmVzLgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsbGlwc2VHZW9tZXRyeS50ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIENpcmNsZUdlb21ldHJ5X2RlZmF1bHQgPSBDaXJjbGVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNpcmNsZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUNpcmNsZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVDaXJjbGVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVDaXJjbGVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQ2lyY2xlR2VvbWV0cnkoY2lyY2xlR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGNpcmNsZUdlb21ldHJ5ID0gQ2lyY2xlR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soY2lyY2xlR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICBjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoCiAgICAgIGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2NlbnRlcgogICAgKTsKICAgIGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBjaXJjbGVHZW9tZXRyeS5fZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQKICAgICk7CiAgICByZXR1cm4gQ2lyY2xlR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShjaXJjbGVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVDaXJjbGVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUNpcmNsZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDaXJjbGVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NpcmNsZUdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBjcmVhdGVDaXJjbGVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQ2lyY2xlR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNlT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gY29tcHV0ZUVsbGlwc2UyKG9wdGlvbnMpIHsKICAgIGNvbnN0IGNlbnRlciA9IG9wdGlvbnMuY2VudGVyOwogICAgYm91bmRpbmdTcGhlcmVDZW50ZXIyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIG9wdGlvbnMuZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChjZW50ZXIsIGJvdW5kaW5nU3BoZXJlQ2VudGVyMiksCiAgICAgIG9wdGlvbnMuaGVpZ2h0LAogICAgICBib3VuZGluZ1NwaGVyZUNlbnRlcjIKICAgICk7CiAgICBib3VuZGluZ1NwaGVyZUNlbnRlcjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICBjZW50ZXIsCiAgICAgIGJvdW5kaW5nU3BoZXJlQ2VudGVyMiwKICAgICAgYm91bmRpbmdTcGhlcmVDZW50ZXIyCiAgICApOwogICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgKICAgICAgYm91bmRpbmdTcGhlcmVDZW50ZXIyLAogICAgICBvcHRpb25zLnNlbWlNYWpvckF4aXMKICAgICk7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUVsbGlwc2VQb3NpdGlvbnMoCiAgICAgIG9wdGlvbnMsCiAgICAgIGZhbHNlLAogICAgICB0cnVlCiAgICApLm91dGVyUG9zaXRpb25zOwogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBFbGxpcHNlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucmFpc2VQb3NpdGlvbnNUb0hlaWdodCgKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG9wdGlvbnMsCiAgICAgICAgICBmYWxzZQogICAgICAgICkKICAgICAgfSkKICAgIH0pOwogICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobGVuZ3RoLCBsZW5ndGggKiAyKTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gKGkgKyAxKSAlIGxlbmd0aDsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzCiAgICB9OwogIH0KICBmdW5jdGlvbiBjb21wdXRlRXh0cnVkZWRFbGxpcHNlMihvcHRpb25zKSB7CiAgICBjb25zdCBjZW50ZXIgPSBvcHRpb25zLmNlbnRlcjsKICAgIGNvbnN0IGVsbGlwc29pZCA9IG9wdGlvbnMuZWxsaXBzb2lkOwogICAgY29uc3Qgc2VtaU1ham9yQXhpcyA9IG9wdGlvbnMuc2VtaU1ham9yQXhpczsKICAgIGxldCBzY2FsZWROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChjZW50ZXIsIHNjcmF0Y2hDYXJ0ZXNpYW4xNCksCiAgICAgIG9wdGlvbnMuaGVpZ2h0LAogICAgICBzY3JhdGNoQ2FydGVzaWFuMTQKICAgICk7CiAgICB0b3BCb3VuZGluZ1NwaGVyZTIuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgY2VudGVyLAogICAgICBzY2FsZWROb3JtYWwsCiAgICAgIHRvcEJvdW5kaW5nU3BoZXJlMi5jZW50ZXIKICAgICk7CiAgICB0b3BCb3VuZGluZ1NwaGVyZTIucmFkaXVzID0gc2VtaU1ham9yQXhpczsKICAgIHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGNlbnRlciwgc2NhbGVkTm9ybWFsKSwKICAgICAgb3B0aW9ucy5leHRydWRlZEhlaWdodCwKICAgICAgc2NhbGVkTm9ybWFsCiAgICApOwogICAgYm90dG9tQm91bmRpbmdTcGhlcmUyLmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgIGNlbnRlciwKICAgICAgc2NhbGVkTm9ybWFsLAogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTIuY2VudGVyCiAgICApOwogICAgYm90dG9tQm91bmRpbmdTcGhlcmUyLnJhZGl1cyA9IHNlbWlNYWpvckF4aXM7CiAgICBsZXQgcG9zaXRpb25zID0gRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVFbGxpcHNlUG9zaXRpb25zKAogICAgICBvcHRpb25zLAogICAgICBmYWxzZSwKICAgICAgdHJ1ZQogICAgKS5vdXRlclBvc2l0aW9uczsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoewogICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogRWxsaXBzZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnJhaXNlUG9zaXRpb25zVG9IZWlnaHQoCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBvcHRpb25zLAogICAgICAgICAgdHJ1ZQogICAgICAgICkKICAgICAgfSkKICAgIH0pOwogICAgcG9zaXRpb25zID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5pb24oCiAgICAgIHRvcEJvdW5kaW5nU3BoZXJlMiwKICAgICAgYm90dG9tQm91bmRpbmdTcGhlcmUyCiAgICApOwogICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgbGV0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoKTsKICAgICAgaWYgKG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICAgIGFwcGx5T2Zmc2V0ID0gYXBwbHlPZmZzZXQuZmlsbCgxLCAwLCBsZW5ndGggLyAyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICBhcHBseU9mZnNldCA9IGFwcGx5T2Zmc2V0LmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICB9CiAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgfSk7CiAgICB9CiAgICBsZXQgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5udW1iZXJPZlZlcnRpY2FsTGluZXMsIDE2KTsKICAgIG51bWJlck9mVmVydGljYWxMaW5lcyA9IE1hdGhfZGVmYXVsdC5jbGFtcCgKICAgICAgbnVtYmVyT2ZWZXJ0aWNhbExpbmVzLAogICAgICAwLAogICAgICBsZW5ndGggLyAyCiAgICApOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBsZW5ndGgsCiAgICAgIGxlbmd0aCAqIDIgKyBudW1iZXJPZlZlcnRpY2FsTGluZXMgKiAyCiAgICApOwogICAgbGVuZ3RoIC89IDI7CiAgICBsZXQgaW5kZXggPSAwOwogICAgbGV0IGk7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSAoaSArIDEpICUgbGVuZ3RoOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIGxlbmd0aDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IChpICsgMSkgJSBsZW5ndGggKyBsZW5ndGg7CiAgICB9CiAgICBsZXQgbnVtU2lkZTsKICAgIGlmIChudW1iZXJPZlZlcnRpY2FsTGluZXMgPiAwKSB7CiAgICAgIGNvbnN0IG51bVNpZGVMaW5lcyA9IE1hdGgubWluKG51bWJlck9mVmVydGljYWxMaW5lcywgbGVuZ3RoKTsKICAgICAgbnVtU2lkZSA9IE1hdGgucm91bmQobGVuZ3RoIC8gbnVtU2lkZUxpbmVzKTsKICAgICAgY29uc3QgbWF4SSA9IE1hdGgubWluKG51bVNpZGUgKiBudW1iZXJPZlZlcnRpY2FsTGluZXMsIGxlbmd0aCk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBtYXhJOyBpICs9IG51bVNpZGUpIHsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIGxlbmd0aDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMKICAgIH07CiAgfQogIGZ1bmN0aW9uIEVsbGlwc2VPdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBjZW50ZXIgPSBvcHRpb25zLmNlbnRlcjsKICAgIGNvbnN0IGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gb3B0aW9ucy5zZW1pTWFqb3JBeGlzOwogICAgY29uc3Qgc2VtaU1pbm9yQXhpcyA9IG9wdGlvbnMuc2VtaU1pbm9yQXhpczsKICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjZW50ZXIpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjZW50ZXIgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzZW1pTWFqb3JBeGlzKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgic2VtaU1ham9yQXhpcyBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNlbWlNaW5vckF4aXMpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzZW1pTWlub3JBeGlzIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKHNlbWlNYWpvckF4aXMgPCBzZW1pTWlub3JBeGlzKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJzZW1pTWFqb3JBeGlzIG11c3QgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIHRoZSBzZW1pTWlub3JBeGlzLiIKICAgICAgKTsKICAgIH0KICAgIGlmIChncmFudWxhcml0eSA8PSAwKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJncmFudWxhcml0eSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIpOwogICAgfQogICAgY29uc3QgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlcik7CiAgICB0aGlzLl9zZW1pTWFqb3JBeGlzID0gc2VtaU1ham9yQXhpczsKICAgIHRoaXMuX3NlbWlNaW5vckF4aXMgPSBzZW1pTWlub3JBeGlzOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkKTsKICAgIHRoaXMuX3JvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yb3RhdGlvbiwgMCk7CiAgICB0aGlzLl9oZWlnaHQgPSBNYXRoLm1heChleHRydWRlZEhlaWdodCwgaGVpZ2h0KTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICB0aGlzLl9leHRydWRlZEhlaWdodCA9IE1hdGgubWluKGV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzID0gTWF0aC5tYXgoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubnVtYmVyT2ZWZXJ0aWNhbExpbmVzLCAxNiksCiAgICAgIDAKICAgICk7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeSI7CiAgfQogIHZhciBzY3JhdGNoQ2FydGVzaWFuMTQsIGJvdW5kaW5nU3BoZXJlQ2VudGVyMiwgdG9wQm91bmRpbmdTcGhlcmUyLCBib3R0b21Cb3VuZGluZ1NwaGVyZTIsIHNjcmF0Y2hDZW50ZXIzLCBzY3JhdGNoRWxsaXBzb2lkMiwgc2NyYXRjaE9wdGlvbnM1LCBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfRWxsaXBzZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNlR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYm91bmRpbmdTcGhlcmVDZW50ZXIyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB0b3BCb3VuZGluZ1NwaGVyZTIgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTIgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICBFbGxpcHNlT3V0bGluZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyA4OwogICAgICBFbGxpcHNlT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX2NlbnRlciwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NlbWlNYWpvckF4aXM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zZW1pTWlub3JBeGlzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fcm90YXRpb247CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9oZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaENlbnRlcjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQyID0gbmV3IEVsbGlwc29pZF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zNSA9IHsKICAgICAgICBjZW50ZXI6IHNjcmF0Y2hDZW50ZXIzLAogICAgICAgIGVsbGlwc29pZDogc2NyYXRjaEVsbGlwc29pZDIsCiAgICAgICAgc2VtaU1ham9yQXhpczogdm9pZCAwLAogICAgICAgIHNlbWlNaW5vckF4aXM6IHZvaWQgMCwKICAgICAgICByb3RhdGlvbjogdm9pZCAwLAogICAgICAgIGhlaWdodDogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAsCiAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IHZvaWQgMCwKICAgICAgICBudW1iZXJPZlZlcnRpY2FsTGluZXM6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBFbGxpcHNlT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaENlbnRlcjMpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQyKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBzZW1pTWFqb3JBeGlzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzZW1pTWlub3JBeGlzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG51bWJlck9mVmVydGljYWxMaW5lcyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnM1LmhlaWdodCA9IGhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNS5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM1LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczUucm90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNS5zZW1pTWFqb3JBeGlzID0gc2VtaU1ham9yQXhpczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNS5zZW1pTWlub3JBeGlzID0gc2VtaU1pbm9yQXhpczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNS5udW1iZXJPZlZlcnRpY2FsTGluZXMgPSBudW1iZXJPZlZlcnRpY2FsTGluZXM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczUub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgRWxsaXBzZU91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczUpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX2NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdC5fY2VudGVyKTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fc2VtaU1ham9yQXhpcyA9IHNlbWlNYWpvckF4aXM7CiAgICAgICAgcmVzdWx0Ll9zZW1pTWlub3JBeGlzID0gc2VtaU1pbm9yQXhpczsKICAgICAgICByZXN1bHQuX3JvdGF0aW9uID0gcm90YXRpb247CiAgICAgICAgcmVzdWx0Ll9oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJlc3VsdC5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICByZXN1bHQuX251bWJlck9mVmVydGljYWxMaW5lcyA9IG51bWJlck9mVmVydGljYWxMaW5lczsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzZU91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGVsbGlwc2VHZW9tZXRyeSkgewogICAgICAgIGlmIChlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXMgPD0gMCB8fCBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNaW5vckF4aXMgPD0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBoZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2hlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGVsbGlwc2VHZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZSA9ICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGhlaWdodCwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgMCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMgogICAgICAgICk7CiAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIgPSBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIsCiAgICAgICAgICBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlcgogICAgICAgICk7CiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgICAgIGNlbnRlcjogZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIsCiAgICAgICAgICBzZW1pTWFqb3JBeGlzOiBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXMsCiAgICAgICAgICBzZW1pTWlub3JBeGlzOiBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNaW5vckF4aXMsCiAgICAgICAgICBlbGxpcHNvaWQ6IGVsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkLAogICAgICAgICAgcm90YXRpb246IGVsbGlwc2VHZW9tZXRyeS5fcm90YXRpb24sCiAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICBncmFudWxhcml0eTogZWxsaXBzZUdlb21ldHJ5Ll9ncmFudWxhcml0eSwKICAgICAgICAgIG51bWJlck9mVmVydGljYWxMaW5lczogZWxsaXBzZUdlb21ldHJ5Ll9udW1iZXJPZlZlcnRpY2FsTGluZXMKICAgICAgICB9OwogICAgICAgIGxldCBnZW9tZXRyeTsKICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgb3B0aW9ucy5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPSBlbGxpcHNlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIGdlb21ldHJ5ID0gY29tcHV0ZUV4dHJ1ZGVkRWxsaXBzZTIob3B0aW9ucyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGdlb21ldHJ5ID0gY29tcHV0ZUVsbGlwc2UyKG9wdGlvbnMpOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlbGxpcHNlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGVsbGlwc2VHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXM6IGdlb21ldHJ5LmF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBnZW9tZXRyeS5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBlbGxpcHNlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBFbGxpcHNlT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2lyY2xlT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gQ2lyY2xlT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcmFkaXVzID0gb3B0aW9ucy5yYWRpdXM7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInJhZGl1cyIsIHJhZGl1cyk7CiAgICBjb25zdCBlbGxpcHNlR2VvbWV0cnlPcHRpb25zID0gewogICAgICBjZW50ZXI6IG9wdGlvbnMuY2VudGVyLAogICAgICBzZW1pTWFqb3JBeGlzOiByYWRpdXMsCiAgICAgIHNlbWlNaW5vckF4aXM6IHJhZGl1cywKICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZCwKICAgICAgaGVpZ2h0OiBvcHRpb25zLmhlaWdodCwKICAgICAgZXh0cnVkZWRIZWlnaHQ6IG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsCiAgICAgIGdyYW51bGFyaXR5OiBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBudW1iZXJPZlZlcnRpY2FsTGluZXM6IG9wdGlvbnMubnVtYmVyT2ZWZXJ0aWNhbExpbmVzCiAgICB9OwogICAgdGhpcy5fZWxsaXBzZUdlb21ldHJ5ID0gbmV3IEVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdChlbGxpcHNlR2VvbWV0cnlPcHRpb25zKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5IjsKICB9CiAgdmFyIHNjcmF0Y2hFbGxpcHNlR2VvbWV0cnkyLCBzY3JhdGNoT3B0aW9uczYsIENpcmNsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0NpcmNsZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ2lyY2xlT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBDaXJjbGVPdXRsaW5lR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgQ2lyY2xlT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIHJldHVybiBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQucGFjaygKICAgICAgICAgIHZhbHVlLl9lbGxpcHNlR2VvbWV0cnksCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgKICAgICAgICApOwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzZUdlb21ldHJ5MiA9IG5ldyBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgIGNlbnRlcjogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIHNlbWlNYWpvckF4aXM6IDEsCiAgICAgICAgc2VtaU1pbm9yQXhpczogMQogICAgICB9KTsKICAgICAgc2NyYXRjaE9wdGlvbnM2ID0gewogICAgICAgIGNlbnRlcjogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIHJhZGl1czogdm9pZCAwLAogICAgICAgIGVsbGlwc29pZDogRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpLAogICAgICAgIGhlaWdodDogdm9pZCAwLAogICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICBudW1iZXJPZlZlcnRpY2FsTGluZXM6IHZvaWQgMCwKICAgICAgICBzZW1pTWFqb3JBeGlzOiB2b2lkIDAsCiAgICAgICAgc2VtaU1pbm9yQXhpczogdm9pZCAwCiAgICAgIH07CiAgICAgIENpcmNsZU91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgZWxsaXBzZUdlb21ldHJ5ID0gRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hFbGxpcHNlR2VvbWV0cnkyCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczYuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgICAgZWxsaXBzZUdlb21ldHJ5Ll9jZW50ZXIsCiAgICAgICAgICBzY3JhdGNoT3B0aW9uczYuY2VudGVyCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczYuZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgICAgICBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNi5lbGxpcHNvaWQKICAgICAgICApOwogICAgICAgIHNjcmF0Y2hPcHRpb25zNi5oZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2hlaWdodDsKICAgICAgICBzY3JhdGNoT3B0aW9uczYuZXh0cnVkZWRIZWlnaHQgPSBlbGxpcHNlR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHNjcmF0Y2hPcHRpb25zNi5ncmFudWxhcml0eSA9IGVsbGlwc2VHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnM2Lm51bWJlck9mVmVydGljYWxMaW5lcyA9IGVsbGlwc2VHZW9tZXRyeS5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zNi5yYWRpdXMgPSBlbGxpcHNlR2VvbWV0cnkuX3NlbWlNYWpvckF4aXM7CiAgICAgICAgICByZXR1cm4gbmV3IENpcmNsZU91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczYpOwogICAgICAgIH0KICAgICAgICBzY3JhdGNoT3B0aW9uczYuc2VtaU1ham9yQXhpcyA9IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1ham9yQXhpczsKICAgICAgICBzY3JhdGNoT3B0aW9uczYuc2VtaU1pbm9yQXhpcyA9IGVsbGlwc2VHZW9tZXRyeS5fc2VtaU1pbm9yQXhpczsKICAgICAgICByZXN1bHQuX2VsbGlwc2VHZW9tZXRyeSA9IG5ldyBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQoc2NyYXRjaE9wdGlvbnM2KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDaXJjbGVPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihjaXJjbGVHZW9tZXRyeSkgewogICAgICAgIHJldHVybiBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeSk7CiAgICAgIH07CiAgICAgIENpcmNsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gQ2lyY2xlT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5KGNpcmNsZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBjaXJjbGVHZW9tZXRyeSA9IENpcmNsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhjaXJjbGVHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZSgKICAgICAgY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fY2VudGVyCiAgICApOwogICAgY2lyY2xlR2VvbWV0cnkuX2VsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIGNpcmNsZUdlb21ldHJ5Ll9lbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZAogICAgKTsKICAgIHJldHVybiBDaXJjbGVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShjaXJjbGVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NpcmNsZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9hcnJheVJlbW92ZUR1cGxpY2F0ZXMuanMKICBmdW5jdGlvbiBhcnJheVJlbW92ZUR1cGxpY2F0ZXModmFsdWVzLCBlcXVhbHNFcHNpbG9uLCB3cmFwQXJvdW5kLCByZW1vdmVkSW5kaWNlcykgewogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJlcXVhbHNFcHNpbG9uIiwgZXF1YWxzRXBzaWxvbik7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZXMpKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICB3cmFwQXJvdW5kID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQod3JhcEFyb3VuZCwgZmFsc2UpOwogICAgY29uc3Qgc3RvcmVSZW1vdmVkSW5kaWNlcyA9IGRlZmluZWRfZGVmYXVsdChyZW1vdmVkSW5kaWNlcyk7CiAgICBjb25zdCBsZW5ndGggPSB2YWx1ZXMubGVuZ3RoOwogICAgaWYgKGxlbmd0aCA8IDIpIHsKICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0KICAgIGxldCBpOwogICAgbGV0IHYwMiA9IHZhbHVlc1swXTsKICAgIGxldCB2MTI7CiAgICBsZXQgY2xlYW5lZFZhbHVlczsKICAgIGxldCBsYXN0Q2xlYW5JbmRleCA9IDA7CiAgICBsZXQgcmVtb3ZlZEluZGV4TENJID0gLTE7CiAgICBmb3IgKGkgPSAxOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgdjEyID0gdmFsdWVzW2ldOwogICAgICBpZiAoZXF1YWxzRXBzaWxvbih2MDIsIHYxMiwgcmVtb3ZlRHVwbGljYXRlc0Vwc2lsb24pKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2xlYW5lZFZhbHVlcykpIHsKICAgICAgICAgIGNsZWFuZWRWYWx1ZXMgPSB2YWx1ZXMuc2xpY2UoMCwgaSk7CiAgICAgICAgICBsYXN0Q2xlYW5JbmRleCA9IGkgLSAxOwogICAgICAgICAgcmVtb3ZlZEluZGV4TENJID0gMDsKICAgICAgICB9CiAgICAgICAgaWYgKHN0b3JlUmVtb3ZlZEluZGljZXMpIHsKICAgICAgICAgIHJlbW92ZWRJbmRpY2VzLnB1c2goaSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY2xlYW5lZFZhbHVlcykpIHsKICAgICAgICAgIGNsZWFuZWRWYWx1ZXMucHVzaCh2MTIpOwogICAgICAgICAgbGFzdENsZWFuSW5kZXggPSBpOwogICAgICAgICAgaWYgKHN0b3JlUmVtb3ZlZEluZGljZXMpIHsKICAgICAgICAgICAgcmVtb3ZlZEluZGV4TENJID0gcmVtb3ZlZEluZGljZXMubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2MDIgPSB2MTI7CiAgICAgIH0KICAgIH0KICAgIGlmICh3cmFwQXJvdW5kICYmIGVxdWFsc0Vwc2lsb24odmFsdWVzWzBdLCB2YWx1ZXNbbGVuZ3RoIC0gMV0sIHJlbW92ZUR1cGxpY2F0ZXNFcHNpbG9uKSkgewogICAgICBpZiAoc3RvcmVSZW1vdmVkSW5kaWNlcykgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY2xlYW5lZFZhbHVlcykpIHsKICAgICAgICAgIHJlbW92ZWRJbmRpY2VzLnNwbGljZShyZW1vdmVkSW5kZXhMQ0ksIDAsIGxhc3RDbGVhbkluZGV4KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVtb3ZlZEluZGljZXMucHVzaChsZW5ndGggLSAxKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjbGVhbmVkVmFsdWVzKSkgewogICAgICAgIGNsZWFuZWRWYWx1ZXMubGVuZ3RoIC09IDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2xlYW5lZFZhbHVlcyA9IHZhbHVlcy5zbGljZSgwLCAtMSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQoY2xlYW5lZFZhbHVlcykgPyBjbGVhbmVkVmFsdWVzIDogdmFsdWVzOwogIH0KICB2YXIgcmVtb3ZlRHVwbGljYXRlc0Vwc2lsb24sIGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0OwogIHZhciBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvYXJyYXlSZW1vdmVEdXBsaWNhdGVzLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIHJlbW92ZUR1cGxpY2F0ZXNFcHNpbG9uID0gTWF0aF9kZWZhdWx0LkVQU0lMT04xMDsKICAgICAgYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Cb3VuZGluZ1JlY3RhbmdsZS5qcwogIGZ1bmN0aW9uIEJvdW5kaW5nUmVjdGFuZ2xlKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKICAgIHRoaXMueCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHgsIDApOwogICAgdGhpcy55ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoeSwgMCk7CiAgICB0aGlzLndpZHRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQod2lkdGgsIDApOwogICAgdGhpcy5oZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChoZWlnaHQsIDApOwogIH0KICB2YXIgZGVmYXVsdFByb2plY3Rpb24yLCBmcm9tUmVjdGFuZ2xlTG93ZXJMZWZ0LCBmcm9tUmVjdGFuZ2xlVXBwZXJSaWdodCwgQm91bmRpbmdSZWN0YW5nbGVfZGVmYXVsdDsKICB2YXIgaW5pdF9Cb3VuZGluZ1JlY3RhbmdsZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQm91bmRpbmdSZWN0YW5nbGUuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9HZW9ncmFwaGljUHJvamVjdGlvbigpOwogICAgICBpbml0X0ludGVyc2VjdCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5wYWNrZWRMZW5ndGggPSA0OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUueTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUud2lkdGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5oZWlnaHQ7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQueSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LndpZHRoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGUuZnJvbVBvaW50cyA9IGZ1bmN0aW9uKHBvc2l0aW9ucywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlKCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0LnggPSAwOwogICAgICAgICAgcmVzdWx0LnkgPSAwOwogICAgICAgICAgcmVzdWx0LndpZHRoID0gMDsKICAgICAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgbWluaW11bVggPSBwb3NpdGlvbnNbMF0ueDsKICAgICAgICBsZXQgbWluaW11bVkgPSBwb3NpdGlvbnNbMF0ueTsKICAgICAgICBsZXQgbWF4aW11bVggPSBwb3NpdGlvbnNbMF0ueDsKICAgICAgICBsZXQgbWF4aW11bVkgPSBwb3NpdGlvbnNbMF0ueTsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgY29uc3QgeCA9IHAueDsKICAgICAgICAgIGNvbnN0IHkgPSBwLnk7CiAgICAgICAgICBtaW5pbXVtWCA9IE1hdGgubWluKHgsIG1pbmltdW1YKTsKICAgICAgICAgIG1heGltdW1YID0gTWF0aC5tYXgoeCwgbWF4aW11bVgpOwogICAgICAgICAgbWluaW11bVkgPSBNYXRoLm1pbih5LCBtaW5pbXVtWSk7CiAgICAgICAgICBtYXhpbXVtWSA9IE1hdGgubWF4KHksIG1heGltdW1ZKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnggPSBtaW5pbXVtWDsKICAgICAgICByZXN1bHQueSA9IG1pbmltdW1ZOwogICAgICAgIHJlc3VsdC53aWR0aCA9IG1heGltdW1YIC0gbWluaW11bVg7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IG1heGltdW1ZIC0gbWluaW11bVk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgZGVmYXVsdFByb2plY3Rpb24yID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoKTsKICAgICAgZnJvbVJlY3RhbmdsZUxvd2VyTGVmdCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBmcm9tUmVjdGFuZ2xlVXBwZXJSaWdodCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5mcm9tUmVjdGFuZ2xlID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBwcm9qZWN0aW9uLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdSZWN0YW5nbGUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlKSkgewogICAgICAgICAgcmVzdWx0LnggPSAwOwogICAgICAgICAgcmVzdWx0LnkgPSAwOwogICAgICAgICAgcmVzdWx0LndpZHRoID0gMDsKICAgICAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcHJvamVjdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHByb2plY3Rpb24sIGRlZmF1bHRQcm9qZWN0aW9uMik7CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0ID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgUmVjdGFuZ2xlX2RlZmF1bHQuc291dGh3ZXN0KHJlY3RhbmdsZSwgZnJvbVJlY3RhbmdsZUxvd2VyTGVmdCkKICAgICAgICApOwogICAgICAgIGNvbnN0IHVwcGVyUmlnaHQgPSBwcm9qZWN0aW9uLnByb2plY3QoCiAgICAgICAgICBSZWN0YW5nbGVfZGVmYXVsdC5ub3J0aGVhc3QocmVjdGFuZ2xlLCBmcm9tUmVjdGFuZ2xlVXBwZXJSaWdodCkKICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5zdWJ0cmFjdCh1cHBlclJpZ2h0LCBsb3dlckxlZnQsIHVwcGVyUmlnaHQpOwogICAgICAgIHJlc3VsdC54ID0gbG93ZXJMZWZ0Lng7CiAgICAgICAgcmVzdWx0LnkgPSBsb3dlckxlZnQueTsKICAgICAgICByZXN1bHQud2lkdGggPSB1cHBlclJpZ2h0Lng7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IHVwcGVyUmlnaHQueTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5jbG9uZSA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlKSkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBCb3VuZGluZ1JlY3RhbmdsZSgKICAgICAgICAgICAgcmVjdGFuZ2xlLngsCiAgICAgICAgICAgIHJlY3RhbmdsZS55LAogICAgICAgICAgICByZWN0YW5nbGUud2lkdGgsCiAgICAgICAgICAgIHJlY3RhbmdsZS5oZWlnaHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gcmVjdGFuZ2xlLng7CiAgICAgICAgcmVzdWx0LnkgPSByZWN0YW5nbGUueTsKICAgICAgICByZXN1bHQud2lkdGggPSByZWN0YW5nbGUud2lkdGg7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IHJlY3RhbmdsZS5oZWlnaHQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGUudW5pb24gPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQm91bmRpbmdSZWN0YW5nbGUoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0WCA9IE1hdGgubWluKGxlZnQueCwgcmlnaHQueCk7CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0WSA9IE1hdGgubWluKGxlZnQueSwgcmlnaHQueSk7CiAgICAgICAgY29uc3QgdXBwZXJSaWdodFggPSBNYXRoLm1heChsZWZ0LnggKyBsZWZ0LndpZHRoLCByaWdodC54ICsgcmlnaHQud2lkdGgpOwogICAgICAgIGNvbnN0IHVwcGVyUmlnaHRZID0gTWF0aC5tYXgobGVmdC55ICsgbGVmdC5oZWlnaHQsIHJpZ2h0LnkgKyByaWdodC5oZWlnaHQpOwogICAgICAgIHJlc3VsdC54ID0gbG93ZXJMZWZ0WDsKICAgICAgICByZXN1bHQueSA9IGxvd2VyTGVmdFk7CiAgICAgICAgcmVzdWx0LndpZHRoID0gdXBwZXJSaWdodFggLSBsb3dlckxlZnRYOwogICAgICAgIHJlc3VsdC5oZWlnaHQgPSB1cHBlclJpZ2h0WSAtIGxvd2VyTGVmdFk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGUuZXhwYW5kID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBwb2ludCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicG9pbnQiLCBwb2ludCk7CiAgICAgICAgcmVzdWx0ID0gQm91bmRpbmdSZWN0YW5nbGUuY2xvbmUocmVjdGFuZ2xlLCByZXN1bHQpOwogICAgICAgIGNvbnN0IHdpZHRoID0gcG9pbnQueCAtIHJlc3VsdC54OwogICAgICAgIGNvbnN0IGhlaWdodCA9IHBvaW50LnkgLSByZXN1bHQueTsKICAgICAgICBpZiAod2lkdGggPiByZXN1bHQud2lkdGgpIHsKICAgICAgICAgIHJlc3VsdC53aWR0aCA9IHdpZHRoOwogICAgICAgIH0gZWxzZSBpZiAod2lkdGggPCAwKSB7CiAgICAgICAgICByZXN1bHQud2lkdGggLT0gd2lkdGg7CiAgICAgICAgICByZXN1bHQueCA9IHBvaW50Lng7CiAgICAgICAgfQogICAgICAgIGlmIChoZWlnaHQgPiByZXN1bHQuaGVpZ2h0KSB7CiAgICAgICAgICByZXN1bHQuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIH0gZWxzZSBpZiAoaGVpZ2h0IDwgMCkgewogICAgICAgICAgcmVzdWx0LmhlaWdodCAtPSBoZWlnaHQ7CiAgICAgICAgICByZXN1bHQueSA9IHBvaW50Lnk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlLmludGVyc2VjdCA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBjb25zdCBsZWZ0WCA9IGxlZnQueDsKICAgICAgICBjb25zdCBsZWZ0WSA9IGxlZnQueTsKICAgICAgICBjb25zdCByaWdodFggPSByaWdodC54OwogICAgICAgIGNvbnN0IHJpZ2h0WSA9IHJpZ2h0Lnk7CiAgICAgICAgaWYgKCEobGVmdFggPiByaWdodFggKyByaWdodC53aWR0aCB8fCBsZWZ0WCArIGxlZnQud2lkdGggPCByaWdodFggfHwgbGVmdFkgKyBsZWZ0LmhlaWdodCA8IHJpZ2h0WSB8fCBsZWZ0WSA+IHJpZ2h0WSArIHJpZ2h0LmhlaWdodCkpIHsKICAgICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5JTlRFUlNFQ1RJTkc7CiAgICAgICAgfQogICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5PVVRTSURFOwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBsZWZ0LnggPT09IHJpZ2h0LnggJiYgbGVmdC55ID09PSByaWdodC55ICYmIGxlZnQud2lkdGggPT09IHJpZ2h0LndpZHRoICYmIGxlZnQuaGVpZ2h0ID09PSByaWdodC5oZWlnaHQ7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBCb3VuZGluZ1JlY3RhbmdsZS5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBCb3VuZGluZ1JlY3RhbmdsZS5wcm90b3R5cGUuaW50ZXJzZWN0ID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gQm91bmRpbmdSZWN0YW5nbGUuaW50ZXJzZWN0KHRoaXMsIHJpZ2h0KTsKICAgICAgfTsKICAgICAgQm91bmRpbmdSZWN0YW5nbGUucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIEJvdW5kaW5nUmVjdGFuZ2xlLmVxdWFscyh0aGlzLCByaWdodCk7CiAgICAgIH07CiAgICAgIEJvdW5kaW5nUmVjdGFuZ2xlX2RlZmF1bHQgPSBCb3VuZGluZ1JlY3RhbmdsZTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0F4aXNBbGlnbmVkQm91bmRpbmdCb3guanMKICBmdW5jdGlvbiBBeGlzQWxpZ25lZEJvdW5kaW5nQm94KG1pbmltdW0sIG1heGltdW0sIGNlbnRlcikgewogICAgdGhpcy5taW5pbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG1pbmltdW0sIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSk7CiAgICB0aGlzLm1heGltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZGVmYXVsdFZhbHVlX2RlZmF1bHQobWF4aW11bSwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8pKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNlbnRlcikpIHsKICAgICAgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1pZHBvaW50KHRoaXMubWluaW11bSwgdGhpcy5tYXhpbXVtLCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkpOwogICAgfSBlbHNlIHsKICAgICAgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlcik7CiAgICB9CiAgICB0aGlzLmNlbnRlciA9IGNlbnRlcjsKICB9CiAgdmFyIGludGVyc2VjdFNjcmF0Y2gsIEF4aXNBbGlnbmVkQm91bmRpbmdCb3hfZGVmYXVsdDsKICB2YXIgaW5pdF9BeGlzQWxpZ25lZEJvdW5kaW5nQm94ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9BeGlzQWxpZ25lZEJvdW5kaW5nQm94LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0KCk7CiAgICAgIEF4aXNBbGlnbmVkQm91bmRpbmdCb3guZnJvbUNvcm5lcnMgPSBmdW5jdGlvbihtaW5pbXVtLCBtYXhpbXVtLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm1pbmltdW0iLCBtaW5pbXVtKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm1heGltdW0iLCBtYXhpbXVtKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQubWluaW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShtaW5pbXVtLCByZXN1bHQubWluaW11bSk7CiAgICAgICAgcmVzdWx0Lm1heGltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUobWF4aW11bSwgcmVzdWx0Lm1heGltdW0pOwogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQobWluaW11bSwgbWF4aW11bSwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQXhpc0FsaWduZWRCb3VuZGluZ0JveC5mcm9tUG9pbnRzID0gZnVuY3Rpb24ocG9zaXRpb25zLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveCgpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpIHx8IHBvc2l0aW9ucy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJlc3VsdC5taW5pbXVtID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCByZXN1bHQubWluaW11bSk7CiAgICAgICAgICByZXN1bHQubWF4aW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgcmVzdWx0Lm1heGltdW0pOwogICAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBsZXQgbWluaW11bVggPSBwb3NpdGlvbnNbMF0ueDsKICAgICAgICBsZXQgbWluaW11bVkgPSBwb3NpdGlvbnNbMF0ueTsKICAgICAgICBsZXQgbWluaW11bVogPSBwb3NpdGlvbnNbMF0uejsKICAgICAgICBsZXQgbWF4aW11bVggPSBwb3NpdGlvbnNbMF0ueDsKICAgICAgICBsZXQgbWF4aW11bVkgPSBwb3NpdGlvbnNbMF0ueTsKICAgICAgICBsZXQgbWF4aW11bVogPSBwb3NpdGlvbnNbMF0uejsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBjb25zdCB4ID0gcC54OwogICAgICAgICAgY29uc3QgeSA9IHAueTsKICAgICAgICAgIGNvbnN0IHogPSBwLno7CiAgICAgICAgICBtaW5pbXVtWCA9IE1hdGgubWluKHgsIG1pbmltdW1YKTsKICAgICAgICAgIG1heGltdW1YID0gTWF0aC5tYXgoeCwgbWF4aW11bVgpOwogICAgICAgICAgbWluaW11bVkgPSBNYXRoLm1pbih5LCBtaW5pbXVtWSk7CiAgICAgICAgICBtYXhpbXVtWSA9IE1hdGgubWF4KHksIG1heGltdW1ZKTsKICAgICAgICAgIG1pbmltdW1aID0gTWF0aC5taW4oeiwgbWluaW11bVopOwogICAgICAgICAgbWF4aW11bVogPSBNYXRoLm1heCh6LCBtYXhpbXVtWik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1pbmltdW0gPSByZXN1bHQubWluaW11bTsKICAgICAgICBtaW5pbXVtLnggPSBtaW5pbXVtWDsKICAgICAgICBtaW5pbXVtLnkgPSBtaW5pbXVtWTsKICAgICAgICBtaW5pbXVtLnogPSBtaW5pbXVtWjsKICAgICAgICBjb25zdCBtYXhpbXVtID0gcmVzdWx0Lm1heGltdW07CiAgICAgICAgbWF4aW11bS54ID0gbWF4aW11bVg7CiAgICAgICAgbWF4aW11bS55ID0gbWF4aW11bVk7CiAgICAgICAgbWF4aW11bS56ID0gbWF4aW11bVo7CiAgICAgICAgcmVzdWx0LmNlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5taWRwb2ludChtaW5pbXVtLCBtYXhpbXVtLCByZXN1bHQuY2VudGVyKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBBeGlzQWxpZ25lZEJvdW5kaW5nQm94LmNsb25lID0gZnVuY3Rpb24oYm94LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3gpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEF4aXNBbGlnbmVkQm91bmRpbmdCb3goYm94Lm1pbmltdW0sIGJveC5tYXhpbXVtLCBib3guY2VudGVyKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Lm1pbmltdW0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoYm94Lm1pbmltdW0sIHJlc3VsdC5taW5pbXVtKTsKICAgICAgICByZXN1bHQubWF4aW11bSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShib3gubWF4aW11bSwgcmVzdWx0Lm1heGltdW0pOwogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoYm94LmNlbnRlciwgcmVzdWx0LmNlbnRlcik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQXhpc0FsaWduZWRCb3VuZGluZ0JveC5lcXVhbHMgPSBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgZGVmaW5lZF9kZWZhdWx0KHJpZ2h0KSAmJiBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGxlZnQuY2VudGVyLCByaWdodC5jZW50ZXIpICYmIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMobGVmdC5taW5pbXVtLCByaWdodC5taW5pbXVtKSAmJiBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzKGxlZnQubWF4aW11bSwgcmlnaHQubWF4aW11bSk7CiAgICAgIH07CiAgICAgIGludGVyc2VjdFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEF4aXNBbGlnbmVkQm91bmRpbmdCb3guaW50ZXJzZWN0UGxhbmUgPSBmdW5jdGlvbihib3gsIHBsYW5lKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJib3giLCBib3gpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicGxhbmUiLCBwbGFuZSk7CiAgICAgICAgaW50ZXJzZWN0U2NyYXRjaCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIGJveC5tYXhpbXVtLAogICAgICAgICAgYm94Lm1pbmltdW0sCiAgICAgICAgICBpbnRlcnNlY3RTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBoID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICBpbnRlcnNlY3RTY3JhdGNoLAogICAgICAgICAgMC41LAogICAgICAgICAgaW50ZXJzZWN0U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3Qgbm9ybWFsMiA9IHBsYW5lLm5vcm1hbDsKICAgICAgICBjb25zdCBlID0gaC54ICogTWF0aC5hYnMobm9ybWFsMi54KSArIGgueSAqIE1hdGguYWJzKG5vcm1hbDIueSkgKyBoLnogKiBNYXRoLmFicyhub3JtYWwyLnopOwogICAgICAgIGNvbnN0IHMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGJveC5jZW50ZXIsIG5vcm1hbDIpICsgcGxhbmUuZGlzdGFuY2U7CiAgICAgICAgaWYgKHMgLSBlID4gMCkgewogICAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0LklOU0lERTsKICAgICAgICB9CiAgICAgICAgaWYgKHMgKyBlIDwgMCkgewogICAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0Lk9VVFNJREU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBJbnRlcnNlY3RfZGVmYXVsdC5JTlRFUlNFQ1RJTkc7CiAgICAgIH07CiAgICAgIEF4aXNBbGlnbmVkQm91bmRpbmdCb3gucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIEF4aXNBbGlnbmVkQm91bmRpbmdCb3guY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQXhpc0FsaWduZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuaW50ZXJzZWN0UGxhbmUgPSBmdW5jdGlvbihwbGFuZSkgewogICAgICAgIHJldHVybiBBeGlzQWxpZ25lZEJvdW5kaW5nQm94LmludGVyc2VjdFBsYW5lKHRoaXMsIHBsYW5lKTsKICAgICAgfTsKICAgICAgQXhpc0FsaWduZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gQXhpc0FsaWduZWRCb3VuZGluZ0JveC5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBBeGlzQWxpZ25lZEJvdW5kaW5nQm94X2RlZmF1bHQgPSBBeGlzQWxpZ25lZEJvdW5kaW5nQm94OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkVGFuZ2VudFBsYW5lLmpzCiAgZnVuY3Rpb24gRWxsaXBzb2lkVGFuZ2VudFBsYW5lKG9yaWdpbiwgZWxsaXBzb2lkKSB7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9yaWdpbiIsIG9yaWdpbik7CiAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIG9yaWdpbiA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKG9yaWdpbik7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcmlnaW4pKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcmlnaW4gbXVzdCBub3QgYmUgYXQgdGhlIGNlbnRlciBvZiB0aGUgZWxsaXBzb2lkLiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGVhc3ROb3J0aFVwID0gVHJhbnNmb3Jtc19kZWZhdWx0LmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lKG9yaWdpbiwgZWxsaXBzb2lkKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGVsbGlwc29pZDsKICAgIHRoaXMuX29yaWdpbiA9IG9yaWdpbjsKICAgIHRoaXMuX3hBeGlzID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21DYXJ0ZXNpYW40KAogICAgICBNYXRyaXg0X2RlZmF1bHQuZ2V0Q29sdW1uKGVhc3ROb3J0aFVwLCAwLCBzY3JhdGNoQ2FydDQpCiAgICApOwogICAgdGhpcy5feUF4aXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjQoCiAgICAgIE1hdHJpeDRfZGVmYXVsdC5nZXRDb2x1bW4oZWFzdE5vcnRoVXAsIDEsIHNjcmF0Y2hDYXJ0NCkKICAgICk7CiAgICBjb25zdCBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21DYXJ0ZXNpYW40KAogICAgICBNYXRyaXg0X2RlZmF1bHQuZ2V0Q29sdW1uKGVhc3ROb3J0aFVwLCAyLCBzY3JhdGNoQ2FydDQpCiAgICApOwogICAgdGhpcy5fcGxhbmUgPSBQbGFuZV9kZWZhdWx0LmZyb21Qb2ludE5vcm1hbChvcmlnaW4sIG5vcm1hbDIpOwogIH0KICB2YXIgc2NyYXRjaENhcnQ0LCB0bXAsIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXksIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVDYXJ0ZXNpYW4zLCBwcm9qZWN0UG9pbnRzT250b0VsbGlwc29pZFNjcmF0Y2gsIEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0OwogIHZhciBpbml0X0VsbGlwc29pZFRhbmdlbnRQbGFuZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkVGFuZ2VudFBsYW5lLmpzIigpIHsKICAgICAgaW5pdF9BeGlzQWxpZ25lZEJvdW5kaW5nQm94KCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW40KCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9JbnRlcnNlY3Rpb25UZXN0cygpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9QbGFuZSgpOwogICAgICBpbml0X1JheSgpOwogICAgICBpbml0X1RyYW5zZm9ybXMoKTsKICAgICAgc2NyYXRjaENhcnQ0ID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBvcmlnaW4uCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Q2FydGVzaWFuM30KICAgICAgICAgKi8KICAgICAgICBvcmlnaW46IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9vcmlnaW47CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBwbGFuZSB3aGljaCBpcyB0YW5nZW50IHRvIHRoZSBlbGxpcHNvaWQuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAdHlwZSB7UGxhbmV9CiAgICAgICAgICovCiAgICAgICAgcGxhbmU6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wbGFuZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGxvY2FsIFgtYXhpcyAoZWFzdCkgb2YgdGhlIHRhbmdlbnQgcGxhbmUuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAdHlwZSB7Q2FydGVzaWFuM30KICAgICAgICAgKi8KICAgICAgICB4QXhpczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3hBeGlzOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgbG9jYWwgWS1heGlzIChub3J0aCkgb2YgdGhlIHRhbmdlbnQgcGxhbmUuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAdHlwZSB7Q2FydGVzaWFuM30KICAgICAgICAgKi8KICAgICAgICB5QXhpczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3lBeGlzOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgbG9jYWwgWi1heGlzICh1cCkgb2YgdGhlIHRhbmdlbnQgcGxhbmUuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUKICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKiBAdHlwZSB7Q2FydGVzaWFuM30KICAgICAgICAgKi8KICAgICAgICB6QXhpczogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BsYW5lLm5vcm1hbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICB0bXAgPSBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5mcm9tUG9pbnRzID0gZnVuY3Rpb24oY2FydGVzaWFucywgZWxsaXBzb2lkKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW5zIiwgY2FydGVzaWFucyk7CiAgICAgICAgY29uc3QgYm94ID0gQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0LmZyb21Qb2ludHMoY2FydGVzaWFucywgdG1wKTsKICAgICAgICByZXR1cm4gbmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZShib3guY2VudGVyLCBlbGxpcHNvaWQpOwogICAgICB9OwogICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5ID0gbmV3IFJheV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVDYXJ0ZXNpYW4zID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlLnByb2plY3RQb2ludE9udG9QbGFuZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBjb25zdCByYXkgPSBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5OwogICAgICAgIHJheS5vcmlnaW4gPSBjYXJ0ZXNpYW4xMTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGNhcnRlc2lhbjExLCByYXkuZGlyZWN0aW9uKTsKICAgICAgICBsZXQgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgcmF5LAogICAgICAgICAgdGhpcy5fcGxhbmUsCiAgICAgICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMwogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uUG9pbnQpKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHJheS5kaXJlY3Rpb24sIHJheS5kaXJlY3Rpb24pOwogICAgICAgICAgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgICByYXksCiAgICAgICAgICAgIHRoaXMuX3BsYW5lLAogICAgICAgICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb25Qb2ludCkpIHsKICAgICAgICAgIGNvbnN0IHYzID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICBpbnRlcnNlY3Rpb25Qb2ludCwKICAgICAgICAgICAgdGhpcy5fb3JpZ2luLAogICAgICAgICAgICBpbnRlcnNlY3Rpb25Qb2ludAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHRoaXMuX3hBeGlzLCB2Myk7CiAgICAgICAgICBjb25zdCB5ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0aGlzLl95QXhpcywgdjMpOwogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCh4LCB5KTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC54ID0geDsKICAgICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUucHJvamVjdFBvaW50c09udG9QbGFuZSA9IGZ1bmN0aW9uKGNhcnRlc2lhbnMsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydGVzaWFucyIsIGNhcnRlc2lhbnMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgIH0KICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNhcnRlc2lhbnMubGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLnByb2plY3RQb2ludE9udG9QbGFuZShjYXJ0ZXNpYW5zW2ldLCByZXN1bHRbY291bnRdKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocCkpIHsKICAgICAgICAgICAgcmVzdWx0W2NvdW50XSA9IHA7CiAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sZW5ndGggPSBjb3VudDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlLnByb2plY3RQb2ludFRvTmVhcmVzdE9uUGxhbmUgPSBmdW5jdGlvbihjYXJ0ZXNpYW4xMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW4iLCBjYXJ0ZXNpYW4xMSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCByYXkgPSBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5OwogICAgICAgIHJheS5vcmlnaW4gPSBjYXJ0ZXNpYW4xMTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUodGhpcy5fcGxhbmUubm9ybWFsLCByYXkuZGlyZWN0aW9uKTsKICAgICAgICBsZXQgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgcmF5LAogICAgICAgICAgdGhpcy5fcGxhbmUsCiAgICAgICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMwogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uUG9pbnQpKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHJheS5kaXJlY3Rpb24sIHJheS5kaXJlY3Rpb24pOwogICAgICAgICAgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgICByYXksCiAgICAgICAgICAgIHRoaXMuX3BsYW5lLAogICAgICAgICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBpbnRlcnNlY3Rpb25Qb2ludCwKICAgICAgICAgIHRoaXMuX29yaWdpbiwKICAgICAgICAgIGludGVyc2VjdGlvblBvaW50CiAgICAgICAgKTsKICAgICAgICBjb25zdCB4ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0aGlzLl94QXhpcywgdjMpOwogICAgICAgIGNvbnN0IHkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHRoaXMuX3lBeGlzLCB2Myk7CiAgICAgICAgcmVzdWx0LnggPSB4OwogICAgICAgIHJlc3VsdC55ID0geTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWRUYW5nZW50UGxhbmUucHJvdG90eXBlLnByb2plY3RQb2ludHNUb05lYXJlc3RPblBsYW5lID0gZnVuY3Rpb24oY2FydGVzaWFucywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW5zIiwgY2FydGVzaWFucyk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IGNhcnRlc2lhbnMubGVuZ3RoOwogICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgcmVzdWx0W2ldID0gdGhpcy5wcm9qZWN0UG9pbnRUb05lYXJlc3RPblBsYW5lKGNhcnRlc2lhbnNbaV0sIHJlc3VsdFtpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHByb2plY3RQb2ludHNPbnRvRWxsaXBzb2lkU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgRWxsaXBzb2lkVGFuZ2VudFBsYW5lLnByb3RvdHlwZS5wcm9qZWN0UG9pbnRPbnRvRWxsaXBzb2lkID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gdGhpcy5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IG9yaWdpbiA9IHRoaXMuX29yaWdpbjsKICAgICAgICBjb25zdCB4QXhpcyA9IHRoaXMuX3hBeGlzOwogICAgICAgIGNvbnN0IHlBeGlzID0gdGhpcy5feUF4aXM7CiAgICAgICAgY29uc3QgdG1wMiA9IHByb2plY3RQb2ludHNPbnRvRWxsaXBzb2lkU2NyYXRjaDsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcih4QXhpcywgY2FydGVzaWFuMTEueCwgdG1wMik7CiAgICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChvcmlnaW4sIHRtcDIsIHJlc3VsdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoeUF4aXMsIGNhcnRlc2lhbjExLnksIHRtcDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0LCB0bXAyLCByZXN1bHQpOwogICAgICAgIGVsbGlwc29pZC5zY2FsZVRvR2VvY2VudHJpY1N1cmZhY2UocmVzdWx0LCByZXN1bHQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZS5wcm90b3R5cGUucHJvamVjdFBvaW50c09udG9FbGxpcHNvaWQgPSBmdW5jdGlvbihjYXJ0ZXNpYW5zLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbnMiLCBjYXJ0ZXNpYW5zKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBjYXJ0ZXNpYW5zLmxlbmd0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IGxlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgcmVzdWx0W2ldID0gdGhpcy5wcm9qZWN0UG9pbnRPbnRvRWxsaXBzb2lkKGNhcnRlc2lhbnNbaV0sIHJlc3VsdFtpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0ID0gRWxsaXBzb2lkVGFuZ2VudFBsYW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvT3JpZW50ZWRCb3VuZGluZ0JveC5qcwogIGZ1bmN0aW9uIE9yaWVudGVkQm91bmRpbmdCb3goY2VudGVyLCBoYWxmQXhlcykgewogICAgdGhpcy5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZGVmYXVsdFZhbHVlX2RlZmF1bHQoY2VudGVyLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpOwogICAgdGhpcy5oYWxmQXhlcyA9IE1hdHJpeDNfZGVmYXVsdC5jbG9uZShkZWZhdWx0VmFsdWVfZGVmYXVsdChoYWxmQXhlcywgTWF0cml4M19kZWZhdWx0LlpFUk8pKTsKICB9CiAgZnVuY3Rpb24gZnJvbVBsYW5lRXh0ZW50cyhwbGFuZU9yaWdpbiwgcGxhbmVYQXhpcywgcGxhbmVZQXhpcywgcGxhbmVaQXhpcywgbWluaW11bVgsIG1heGltdW1YLCBtaW5pbXVtWSwgbWF4aW11bVksIG1pbmltdW1aLCBtYXhpbXVtWiwgcmVzdWx0KSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChtaW5pbXVtWCkgfHwgIWRlZmluZWRfZGVmYXVsdChtYXhpbXVtWCkgfHwgIWRlZmluZWRfZGVmYXVsdChtaW5pbXVtWSkgfHwgIWRlZmluZWRfZGVmYXVsdChtYXhpbXVtWSkgfHwgIWRlZmluZWRfZGVmYXVsdChtaW5pbXVtWikgfHwgIWRlZmluZWRfZGVmYXVsdChtYXhpbXVtWikpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgImFsbCBleHRlbnRzIChtaW5pbXVtL21heGltdW0gWC9ZL1opIGFyZSByZXF1aXJlZC4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IG5ldyBPcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICB9CiAgICBjb25zdCBoYWxmQXhlcyA9IHJlc3VsdC5oYWxmQXhlczsKICAgIE1hdHJpeDNfZGVmYXVsdC5zZXRDb2x1bW4oaGFsZkF4ZXMsIDAsIHBsYW5lWEF4aXMsIGhhbGZBeGVzKTsKICAgIE1hdHJpeDNfZGVmYXVsdC5zZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIHBsYW5lWUF4aXMsIGhhbGZBeGVzKTsKICAgIE1hdHJpeDNfZGVmYXVsdC5zZXRDb2x1bW4oaGFsZkF4ZXMsIDIsIHBsYW5lWkF4aXMsIGhhbGZBeGVzKTsKICAgIGxldCBjZW50ZXJPZmZzZXQgPSBzY3JhdGNoT2Zmc2V0OwogICAgY2VudGVyT2Zmc2V0LnggPSAobWluaW11bVggKyBtYXhpbXVtWCkgLyAyOwogICAgY2VudGVyT2Zmc2V0LnkgPSAobWluaW11bVkgKyBtYXhpbXVtWSkgLyAyOwogICAgY2VudGVyT2Zmc2V0LnogPSAobWluaW11bVogKyBtYXhpbXVtWikgLyAyOwogICAgY29uc3Qgc2NhbGUgPSBzY3JhdGNoU2NhbGUyOwogICAgc2NhbGUueCA9IChtYXhpbXVtWCAtIG1pbmltdW1YKSAvIDI7CiAgICBzY2FsZS55ID0gKG1heGltdW1ZIC0gbWluaW11bVkpIC8gMjsKICAgIHNjYWxlLnogPSAobWF4aW11bVogLSBtaW5pbXVtWikgLyAyOwogICAgY29uc3QgY2VudGVyID0gcmVzdWx0LmNlbnRlcjsKICAgIGNlbnRlck9mZnNldCA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKGhhbGZBeGVzLCBjZW50ZXJPZmZzZXQsIGNlbnRlck9mZnNldCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBsYW5lT3JpZ2luLCBjZW50ZXJPZmZzZXQsIGNlbnRlcik7CiAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxlKGhhbGZBeGVzLCBzY2FsZSwgaGFsZkF4ZXMpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4xNSwgc2NyYXRjaENhcnRlc2lhbjI1LCBzY3JhdGNoQ2FydGVzaWFuMzYsIHNjcmF0Y2hDYXJ0ZXNpYW40Miwgc2NyYXRjaENhcnRlc2lhbjUsIHNjcmF0Y2hDYXJ0ZXNpYW42LCBzY3JhdGNoQ292YXJpYW5jZVJlc3VsdCwgc2NyYXRjaEVpZ2VuUmVzdWx0LCBzY3JhdGNoT2Zmc2V0LCBzY3JhdGNoU2NhbGUyLCBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyQ2FydG9ncmFwaGljLCBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyLCBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljTkMsIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVywgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY0NXLCBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljU1csIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTQywgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbk5DLCBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuTlcsIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5DVywgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhblNXLCBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuU0MsIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWROQywgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZE5XLCBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkQ1csIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRTVywgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZFNDLCBzY3JhdGNoUGxhbmVPcmlnaW4sIHNjcmF0Y2hQbGFuZU5vcm1hbCwgc2NyYXRjaFBsYW5lWEF4aXMsIHNjcmF0Y2hIb3Jpem9uQ2FydGVzaWFuLCBzY3JhdGNoSG9yaXpvblByb2plY3RlZCwgc2NyYXRjaE1heFksIHNjcmF0Y2hNaW5ZLCBzY3JhdGNoWiwgc2NyYXRjaFBsYW5lLCBzY3JhdGNoQ2FydGVzaWFuVSwgc2NyYXRjaENhcnRlc2lhblYsIHNjcmF0Y2hDYXJ0ZXNpYW5XLCBzY3JhdGNoVmFsaWRBeGlzMiwgc2NyYXRjaFZhbGlkQXhpczMsIHNjcmF0Y2hQUHJpbWUsIHNjcmF0Y2hDb3JuZXIsIHNjcmF0Y2hUb0NlbnRlciwgc2NyYXRjaFhBeGlzLCBzY3JhdGNoWUF4aXMsIHNjcmF0Y2haQXhpcywgc2NyYXRjaFJvdGF0aW9uU2NhbGUsIHNjcmF0Y2hCb3VuZGluZ1NwaGVyZSwgT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0OwogIHZhciBpbml0X09yaWVudGVkQm91bmRpbmdCb3ggPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL09yaWVudGVkQm91bmRpbmdCb3guanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZFRhbmdlbnRQbGFuZSgpOwogICAgICBpbml0X0ludGVyc2VjdCgpOwogICAgICBpbml0X0ludGVydmFsKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfUGxhbmUoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wYWNrZWRMZW5ndGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgTWF0cml4M19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5jZW50ZXIsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBNYXRyaXgzX2RlZmF1bHQucGFjayh2YWx1ZS5oYWxmQXhlcywgYXJyYXksIHN0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBPcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIE1hdHJpeDNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoLAogICAgICAgICAgcmVzdWx0LmhhbGZBeGVzCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjM2ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuNDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW41ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuNiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENvdmFyaWFuY2VSZXN1bHQgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFaWdlblJlc3VsdCA9IHsKICAgICAgICB1bml0YXJ5OiBuZXcgTWF0cml4M19kZWZhdWx0KCksCiAgICAgICAgZGlhZ29uYWw6IG5ldyBNYXRyaXgzX2RlZmF1bHQoKQogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmZyb21Qb2ludHMgPSBmdW5jdGlvbihwb3NpdGlvbnMsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBPcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmVzdWx0LmhhbGZBeGVzID0gTWF0cml4M19kZWZhdWx0LlpFUk87CiAgICAgICAgICByZXN1bHQuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LlpFUk87CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IG1lYW5Qb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbnNbMF0sIHNjcmF0Y2hDYXJ0ZXNpYW4xNSk7CiAgICAgICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG1lYW5Qb2ludCwgcG9zaXRpb25zW2ldLCBtZWFuUG9pbnQpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpbnZMZW5ndGggPSAxIC8gbGVuZ3RoOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1lYW5Qb2ludCwgaW52TGVuZ3RoLCBtZWFuUG9pbnQpOwogICAgICAgIGxldCBleHggPSAwOwogICAgICAgIGxldCBleHkgPSAwOwogICAgICAgIGxldCBleHogPSAwOwogICAgICAgIGxldCBleXkgPSAwOwogICAgICAgIGxldCBleXogPSAwOwogICAgICAgIGxldCBlenogPSAwOwogICAgICAgIGxldCBwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgcCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwb3NpdGlvbnNbaV0sIG1lYW5Qb2ludCwgc2NyYXRjaENhcnRlc2lhbjI1KTsKICAgICAgICAgIGV4eCArPSBwLnggKiBwLng7CiAgICAgICAgICBleHkgKz0gcC54ICogcC55OwogICAgICAgICAgZXh6ICs9IHAueCAqIHAuejsKICAgICAgICAgIGV5eSArPSBwLnkgKiBwLnk7CiAgICAgICAgICBleXogKz0gcC55ICogcC56OwogICAgICAgICAgZXp6ICs9IHAueiAqIHAuejsKICAgICAgICB9CiAgICAgICAgZXh4ICo9IGludkxlbmd0aDsKICAgICAgICBleHkgKj0gaW52TGVuZ3RoOwogICAgICAgIGV4eiAqPSBpbnZMZW5ndGg7CiAgICAgICAgZXl5ICo9IGludkxlbmd0aDsKICAgICAgICBleXogKj0gaW52TGVuZ3RoOwogICAgICAgIGV6eiAqPSBpbnZMZW5ndGg7CiAgICAgICAgY29uc3QgY292YXJpYW5jZU1hdHJpeCA9IHNjcmF0Y2hDb3ZhcmlhbmNlUmVzdWx0OwogICAgICAgIGNvdmFyaWFuY2VNYXRyaXhbMF0gPSBleHg7CiAgICAgICAgY292YXJpYW5jZU1hdHJpeFsxXSA9IGV4eTsKICAgICAgICBjb3ZhcmlhbmNlTWF0cml4WzJdID0gZXh6OwogICAgICAgIGNvdmFyaWFuY2VNYXRyaXhbM10gPSBleHk7CiAgICAgICAgY292YXJpYW5jZU1hdHJpeFs0XSA9IGV5eTsKICAgICAgICBjb3ZhcmlhbmNlTWF0cml4WzVdID0gZXl6OwogICAgICAgIGNvdmFyaWFuY2VNYXRyaXhbNl0gPSBleHo7CiAgICAgICAgY292YXJpYW5jZU1hdHJpeFs3XSA9IGV5ejsKICAgICAgICBjb3ZhcmlhbmNlTWF0cml4WzhdID0gZXp6OwogICAgICAgIGNvbnN0IGVpZ2VuRGVjb21wb3NpdGlvbiA9IE1hdHJpeDNfZGVmYXVsdC5jb21wdXRlRWlnZW5EZWNvbXBvc2l0aW9uKAogICAgICAgICAgY292YXJpYW5jZU1hdHJpeCwKICAgICAgICAgIHNjcmF0Y2hFaWdlblJlc3VsdAogICAgICAgICk7CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBNYXRyaXgzX2RlZmF1bHQuY2xvbmUoZWlnZW5EZWNvbXBvc2l0aW9uLnVuaXRhcnksIHJlc3VsdC5oYWxmQXhlcyk7CiAgICAgICAgbGV0IHYxMiA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4ocm90YXRpb24sIDAsIHNjcmF0Y2hDYXJ0ZXNpYW40Mik7CiAgICAgICAgbGV0IHYyMiA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4ocm90YXRpb24sIDEsIHNjcmF0Y2hDYXJ0ZXNpYW41KTsKICAgICAgICBsZXQgdjMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKHJvdGF0aW9uLCAyLCBzY3JhdGNoQ2FydGVzaWFuNik7CiAgICAgICAgbGV0IHUxMiA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCB1MjIgPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgdTMgPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBsZXQgbDEgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgICAgIGxldCBsMiA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgICAgbGV0IGwzID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICB1MTIgPSBNYXRoLm1heChDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYxMiwgcCksIHUxMik7CiAgICAgICAgICB1MjIgPSBNYXRoLm1heChDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYyMiwgcCksIHUyMik7CiAgICAgICAgICB1MyA9IE1hdGgubWF4KENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjMsIHApLCB1Myk7CiAgICAgICAgICBsMSA9IE1hdGgubWluKENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodjEyLCBwKSwgbDEpOwogICAgICAgICAgbDIgPSBNYXRoLm1pbihDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHYyMiwgcCksIGwyKTsKICAgICAgICAgIGwzID0gTWF0aC5taW4oQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh2MywgcCksIGwzKTsKICAgICAgICB9CiAgICAgICAgdjEyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIodjEyLCAwLjUgKiAobDEgKyB1MTIpLCB2MTIpOwogICAgICAgIHYyMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHYyMiwgMC41ICogKGwyICsgdTIyKSwgdjIyKTsKICAgICAgICB2MyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHYzLCAwLjUgKiAobDMgKyB1MyksIHYzKTsKICAgICAgICBjb25zdCBjZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHYxMiwgdjIyLCByZXN1bHQuY2VudGVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNlbnRlciwgdjMsIGNlbnRlcik7CiAgICAgICAgY29uc3Qgc2NhbGUgPSBzY3JhdGNoQ2FydGVzaWFuMzY7CiAgICAgICAgc2NhbGUueCA9IHUxMiAtIGwxOwogICAgICAgIHNjYWxlLnkgPSB1MjIgLSBsMjsKICAgICAgICBzY2FsZS56ID0gdTMgLSBsMzsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihzY2FsZSwgMC41LCBzY2FsZSk7CiAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsZShyZXN1bHQuaGFsZkF4ZXMsIHNjYWxlLCByZXN1bHQuaGFsZkF4ZXMpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hPZmZzZXQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hTY2FsZTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hSZWN0YW5nbGVDZW50ZXJDYXJ0b2dyYXBoaWMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZUNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY05DID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljQ1cgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY1NXID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTQyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuTkMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5OVyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbkNXID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuU1cgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5TQyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZE5DID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkTlcgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRDVyA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZFNXID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkU0MgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQbGFuZU9yaWdpbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBsYW5lTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGxhbmVYQXhpcyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEhvcml6b25DYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hIb3Jpem9uUHJvamVjdGVkID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWF4WSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1pblkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2haID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGxhbmUgPSBuZXcgUGxhbmVfZGVmYXVsdChDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLCAwKTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5mcm9tUmVjdGFuZ2xlID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBtaW5pbXVtSGVpZ2h0LCBtYXhpbXVtSGVpZ2h0LCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyZWN0YW5nbGUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlY3RhbmdsZS53aWR0aCA8IDAgfHwgcmVjdGFuZ2xlLndpZHRoID4gTWF0aF9kZWZhdWx0LlRXT19QSSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIlJlY3RhbmdsZSB3aWR0aCBtdXN0IGJlIGJldHdlZW4gMCBhbmQgMiAqIHBpIik7CiAgICAgICAgfQogICAgICAgIGlmIChyZWN0YW5nbGUuaGVpZ2h0IDwgMCB8fCByZWN0YW5nbGUuaGVpZ2h0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiUmVjdGFuZ2xlIGhlaWdodCBtdXN0IGJlIGJldHdlZW4gMCBhbmQgcGkiKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWQpICYmICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGVsbGlwc29pZC5yYWRpaS54LAogICAgICAgICAgZWxsaXBzb2lkLnJhZGlpLnksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjE1CiAgICAgICAgKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJFbGxpcHNvaWQgbXVzdCBiZSBhbiBlbGxpcHNvaWQgb2YgcmV2b2x1dGlvbiAocmFkaWkueCA9PSByYWRpaS55KSIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIG1pbmltdW1IZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChtaW5pbXVtSGVpZ2h0LCAwKTsKICAgICAgICBtYXhpbXVtSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobWF4aW11bUhlaWdodCwgMCk7CiAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgbGV0IG1pblgsIG1heFgsIG1pblksIG1heFksIG1pblosIG1heFosIHBsYW5lOwogICAgICAgIGlmIChyZWN0YW5nbGUud2lkdGggPD0gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICBjb25zdCB0YW5nZW50UG9pbnRDYXJ0b2dyYXBoaWMgPSBSZWN0YW5nbGVfZGVmYXVsdC5jZW50ZXIoCiAgICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgICAgc2NyYXRjaFJlY3RhbmdsZUNlbnRlckNhcnRvZ3JhcGhpYwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHRhbmdlbnRQb2ludCA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgdGFuZ2VudFBvaW50Q2FydG9ncmFwaGljLAogICAgICAgICAgICBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgdGFuZ2VudFBsYW5lID0gbmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0KHRhbmdlbnRQb2ludCwgZWxsaXBzb2lkKTsKICAgICAgICAgIHBsYW5lID0gdGFuZ2VudFBsYW5lLnBsYW5lOwogICAgICAgICAgY29uc3QgbG9uQ2VudGVyID0gdGFuZ2VudFBvaW50Q2FydG9ncmFwaGljLmxvbmdpdHVkZTsKICAgICAgICAgIGNvbnN0IGxhdENlbnRlciA9IHJlY3RhbmdsZS5zb3V0aCA8IDAgJiYgcmVjdGFuZ2xlLm5vcnRoID4gMCA/IDAgOiB0YW5nZW50UG9pbnRDYXJ0b2dyYXBoaWMubGF0aXR1ZGU7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOQyA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgICBsb25DZW50ZXIsCiAgICAgICAgICAgIHJlY3RhbmdsZS5ub3J0aCwKICAgICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY05DCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyQ2FydG9ncmFwaGljTlcgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgICAgcmVjdGFuZ2xlLndlc3QsCiAgICAgICAgICAgIHJlY3RhbmdsZS5ub3J0aCwKICAgICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY05XCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyQ2FydG9ncmFwaGljQ1cgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgICAgcmVjdGFuZ2xlLndlc3QsCiAgICAgICAgICAgIGxhdENlbnRlciwKICAgICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY0NXCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyQ2FydG9ncmFwaGljU1cgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgICAgcmVjdGFuZ2xlLndlc3QsCiAgICAgICAgICAgIHJlY3RhbmdsZS5zb3V0aCwKICAgICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY1NXCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyQ2FydG9ncmFwaGljU0MgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgICAgbG9uQ2VudGVyLAogICAgICAgICAgICByZWN0YW5nbGUuc291dGgsCiAgICAgICAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTQwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHBlcmltZXRlckNhcnRlc2lhbk5DID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOQywKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbk5DCiAgICAgICAgICApOwogICAgICAgICAgbGV0IHBlcmltZXRlckNhcnRlc2lhbk5XID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVywKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbk5XCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyQ2FydGVzaWFuQ1cgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY0NXLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuQ1cKICAgICAgICAgICk7CiAgICAgICAgICBsZXQgcGVyaW1ldGVyQ2FydGVzaWFuU1cgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY1NXLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuU1cKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0ZXNpYW5TQyA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgcGVyaW1ldGVyQ2FydG9ncmFwaGljU0MsCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5TQwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHBlcmltZXRlclByb2plY3RlZE5DID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludFRvTmVhcmVzdE9uUGxhbmUoCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRlc2lhbk5DLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkTkMKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJQcm9qZWN0ZWROVyA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRUb05lYXJlc3RPblBsYW5lKAogICAgICAgICAgICBwZXJpbWV0ZXJDYXJ0ZXNpYW5OVywKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZE5XCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcGVyaW1ldGVyUHJvamVjdGVkQ1cgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50VG9OZWFyZXN0T25QbGFuZSgKICAgICAgICAgICAgcGVyaW1ldGVyQ2FydGVzaWFuQ1csCiAgICAgICAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRDVwogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHBlcmltZXRlclByb2plY3RlZFNXID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludFRvTmVhcmVzdE9uUGxhbmUoCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRlc2lhblNXLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkU1cKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwZXJpbWV0ZXJQcm9qZWN0ZWRTQyA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRUb05lYXJlc3RPblBsYW5lKAogICAgICAgICAgICBwZXJpbWV0ZXJDYXJ0ZXNpYW5TQywKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZFNDCiAgICAgICAgICApOwogICAgICAgICAgbWluWCA9IE1hdGgubWluKAogICAgICAgICAgICBwZXJpbWV0ZXJQcm9qZWN0ZWROVy54LAogICAgICAgICAgICBwZXJpbWV0ZXJQcm9qZWN0ZWRDVy54LAogICAgICAgICAgICBwZXJpbWV0ZXJQcm9qZWN0ZWRTVy54CiAgICAgICAgICApOwogICAgICAgICAgbWF4WCA9IC1taW5YOwogICAgICAgICAgbWF4WSA9IE1hdGgubWF4KHBlcmltZXRlclByb2plY3RlZE5XLnksIHBlcmltZXRlclByb2plY3RlZE5DLnkpOwogICAgICAgICAgbWluWSA9IE1hdGgubWluKHBlcmltZXRlclByb2plY3RlZFNXLnksIHBlcmltZXRlclByb2plY3RlZFNDLnkpOwogICAgICAgICAgcGVyaW1ldGVyQ2FydG9ncmFwaGljTlcuaGVpZ2h0ID0gcGVyaW1ldGVyQ2FydG9ncmFwaGljU1cuaGVpZ2h0ID0gbWluaW11bUhlaWdodDsKICAgICAgICAgIHBlcmltZXRlckNhcnRlc2lhbk5XID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVywKICAgICAgICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbk5XCiAgICAgICAgICApOwogICAgICAgICAgcGVyaW1ldGVyQ2FydGVzaWFuU1cgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY1NXLAogICAgICAgICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuU1cKICAgICAgICAgICk7CiAgICAgICAgICBtaW5aID0gTWF0aC5taW4oCiAgICAgICAgICAgIFBsYW5lX2RlZmF1bHQuZ2V0UG9pbnREaXN0YW5jZShwbGFuZSwgcGVyaW1ldGVyQ2FydGVzaWFuTlcpLAogICAgICAgICAgICBQbGFuZV9kZWZhdWx0LmdldFBvaW50RGlzdGFuY2UocGxhbmUsIHBlcmltZXRlckNhcnRlc2lhblNXKQogICAgICAgICAgKTsKICAgICAgICAgIG1heFogPSBtYXhpbXVtSGVpZ2h0OwogICAgICAgICAgcmV0dXJuIGZyb21QbGFuZUV4dGVudHMoCiAgICAgICAgICAgIHRhbmdlbnRQbGFuZS5vcmlnaW4sCiAgICAgICAgICAgIHRhbmdlbnRQbGFuZS54QXhpcywKICAgICAgICAgICAgdGFuZ2VudFBsYW5lLnlBeGlzLAogICAgICAgICAgICB0YW5nZW50UGxhbmUuekF4aXMsCiAgICAgICAgICAgIG1pblgsCiAgICAgICAgICAgIG1heFgsCiAgICAgICAgICAgIG1pblksCiAgICAgICAgICAgIG1heFksCiAgICAgICAgICAgIG1pblosCiAgICAgICAgICAgIG1heFosCiAgICAgICAgICAgIHJlc3VsdAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZnVsbHlBYm92ZUVxdWF0b3IgPSByZWN0YW5nbGUuc291dGggPiAwOwogICAgICAgIGNvbnN0IGZ1bGx5QmVsb3dFcXVhdG9yID0gcmVjdGFuZ2xlLm5vcnRoIDwgMDsKICAgICAgICBjb25zdCBsYXRpdHVkZU5lYXJlc3RUb0VxdWF0b3IgPSBmdWxseUFib3ZlRXF1YXRvciA/IHJlY3RhbmdsZS5zb3V0aCA6IGZ1bGx5QmVsb3dFcXVhdG9yID8gcmVjdGFuZ2xlLm5vcnRoIDogMDsKICAgICAgICBjb25zdCBjZW50ZXJMb25naXR1ZGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jZW50ZXIoCiAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyQ2FydG9ncmFwaGljCiAgICAgICAgKS5sb25naXR1ZGU7CiAgICAgICAgY29uc3QgcGxhbmVPcmlnaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgICBjZW50ZXJMb25naXR1ZGUsCiAgICAgICAgICBsYXRpdHVkZU5lYXJlc3RUb0VxdWF0b3IsCiAgICAgICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc2NyYXRjaFBsYW5lT3JpZ2luCiAgICAgICAgKTsKICAgICAgICBwbGFuZU9yaWdpbi56ID0gMDsKICAgICAgICBjb25zdCBpc1BvbGUgPSBNYXRoLmFicyhwbGFuZU9yaWdpbi54KSA8IE1hdGhfZGVmYXVsdC5FUFNJTE9OMTAgJiYgTWF0aC5hYnMocGxhbmVPcmlnaW4ueSkgPCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwOwogICAgICAgIGNvbnN0IHBsYW5lTm9ybWFsID0gIWlzUG9sZSA/IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocGxhbmVPcmlnaW4sIHNjcmF0Y2hQbGFuZU5vcm1hbCkgOiBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YOwogICAgICAgIGNvbnN0IHBsYW5lWUF4aXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aOwogICAgICAgIGNvbnN0IHBsYW5lWEF4aXMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgICAgICBwbGFuZU5vcm1hbCwKICAgICAgICAgIHBsYW5lWUF4aXMsCiAgICAgICAgICBzY3JhdGNoUGxhbmVYQXhpcwogICAgICAgICk7CiAgICAgICAgcGxhbmUgPSBQbGFuZV9kZWZhdWx0LmZyb21Qb2ludE5vcm1hbChwbGFuZU9yaWdpbiwgcGxhbmVOb3JtYWwsIHNjcmF0Y2hQbGFuZSk7CiAgICAgICAgY29uc3QgaG9yaXpvbkNhcnRlc2lhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIGNlbnRlckxvbmdpdHVkZSArIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTywKICAgICAgICAgIGxhdGl0dWRlTmVhcmVzdFRvRXF1YXRvciwKICAgICAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzY3JhdGNoSG9yaXpvbkNhcnRlc2lhbgogICAgICAgICk7CiAgICAgICAgbWF4WCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoCiAgICAgICAgICBQbGFuZV9kZWZhdWx0LnByb2plY3RQb2ludE9udG9QbGFuZSgKICAgICAgICAgICAgcGxhbmUsCiAgICAgICAgICAgIGhvcml6b25DYXJ0ZXNpYW4sCiAgICAgICAgICAgIHNjcmF0Y2hIb3Jpem9uUHJvamVjdGVkCiAgICAgICAgICApLAogICAgICAgICAgcGxhbmVYQXhpcwogICAgICAgICk7CiAgICAgICAgbWluWCA9IC1tYXhYOwogICAgICAgIG1heFkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgICAwLAogICAgICAgICAgcmVjdGFuZ2xlLm5vcnRoLAogICAgICAgICAgZnVsbHlCZWxvd0VxdWF0b3IgPyBtaW5pbXVtSGVpZ2h0IDogbWF4aW11bUhlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2hNYXhZCiAgICAgICAgKS56OwogICAgICAgIG1pblkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgICAwLAogICAgICAgICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgICAgICAgZnVsbHlBYm92ZUVxdWF0b3IgPyBtaW5pbXVtSGVpZ2h0IDogbWF4aW11bUhlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHNjcmF0Y2hNaW5ZCiAgICAgICAgKS56OwogICAgICAgIGNvbnN0IGZhclogPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgICByZWN0YW5nbGUuZWFzdCwKICAgICAgICAgIGxhdGl0dWRlTmVhcmVzdFRvRXF1YXRvciwKICAgICAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzY3JhdGNoWgogICAgICAgICk7CiAgICAgICAgbWluWiA9IFBsYW5lX2RlZmF1bHQuZ2V0UG9pbnREaXN0YW5jZShwbGFuZSwgZmFyWik7CiAgICAgICAgbWF4WiA9IDA7CiAgICAgICAgcmV0dXJuIGZyb21QbGFuZUV4dGVudHMoCiAgICAgICAgICBwbGFuZU9yaWdpbiwKICAgICAgICAgIHBsYW5lWEF4aXMsCiAgICAgICAgICBwbGFuZVlBeGlzLAogICAgICAgICAgcGxhbmVOb3JtYWwsCiAgICAgICAgICBtaW5YLAogICAgICAgICAgbWF4WCwKICAgICAgICAgIG1pblksCiAgICAgICAgICBtYXhZLAogICAgICAgICAgbWluWiwKICAgICAgICAgIG1heFosCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmZyb21UcmFuc2Zvcm1hdGlvbiA9IGZ1bmN0aW9uKHRyYW5zZm9ybWF0aW9uLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInRyYW5zZm9ybWF0aW9uIiwgdHJhbnNmb3JtYXRpb24pOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBPcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBNYXRyaXg0X2RlZmF1bHQuZ2V0VHJhbnNsYXRpb24odHJhbnNmb3JtYXRpb24sIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIHJlc3VsdC5oYWxmQXhlcyA9IE1hdHJpeDRfZGVmYXVsdC5nZXRNYXRyaXgzKHRyYW5zZm9ybWF0aW9uLCByZXN1bHQuaGFsZkF4ZXMpOwogICAgICAgIHJlc3VsdC5oYWxmQXhlcyA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgcmVzdWx0LmhhbGZBeGVzLAogICAgICAgICAgMC41LAogICAgICAgICAgcmVzdWx0LmhhbGZBeGVzCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmNsb25lID0gZnVuY3Rpb24oYm94LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3gpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE9yaWVudGVkQm91bmRpbmdCb3goYm94LmNlbnRlciwgYm94LmhhbGZBeGVzKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGJveC5jZW50ZXIsIHJlc3VsdC5jZW50ZXIpOwogICAgICAgIE1hdHJpeDNfZGVmYXVsdC5jbG9uZShib3guaGFsZkF4ZXMsIHJlc3VsdC5oYWxmQXhlcyk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5pbnRlcnNlY3RQbGFuZSA9IGZ1bmN0aW9uKGJveCwgcGxhbmUpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3gpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYm94IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJwbGFuZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2VudGVyID0gYm94LmNlbnRlcjsKICAgICAgICBjb25zdCBub3JtYWwyID0gcGxhbmUubm9ybWFsOwogICAgICAgIGNvbnN0IGhhbGZBeGVzID0gYm94LmhhbGZBeGVzOwogICAgICAgIGNvbnN0IG5vcm1hbFggPSBub3JtYWwyLngsIG5vcm1hbFkgPSBub3JtYWwyLnksIG5vcm1hbFogPSBub3JtYWwyLno7CiAgICAgICAgY29uc3QgcmFkRWZmZWN0aXZlID0gTWF0aC5hYnMoCiAgICAgICAgICBub3JtYWxYICogaGFsZkF4ZXNbTWF0cml4M19kZWZhdWx0LkNPTFVNTjBST1cwXSArIG5vcm1hbFkgKiBoYWxmQXhlc1tNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMFJPVzFdICsgbm9ybWFsWiAqIGhhbGZBeGVzW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4wUk9XMl0KICAgICAgICApICsgTWF0aC5hYnMoCiAgICAgICAgICBub3JtYWxYICogaGFsZkF4ZXNbTWF0cml4M19kZWZhdWx0LkNPTFVNTjFST1cwXSArIG5vcm1hbFkgKiBoYWxmQXhlc1tNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMVJPVzFdICsgbm9ybWFsWiAqIGhhbGZBeGVzW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4xUk9XMl0KICAgICAgICApICsgTWF0aC5hYnMoCiAgICAgICAgICBub3JtYWxYICogaGFsZkF4ZXNbTWF0cml4M19kZWZhdWx0LkNPTFVNTjJST1cwXSArIG5vcm1hbFkgKiBoYWxmQXhlc1tNYXRyaXgzX2RlZmF1bHQuQ09MVU1OMlJPVzFdICsgbm9ybWFsWiAqIGhhbGZBeGVzW01hdHJpeDNfZGVmYXVsdC5DT0xVTU4yUk9XMl0KICAgICAgICApOwogICAgICAgIGNvbnN0IGRpc3RhbmNlVG9QbGFuZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgY2VudGVyKSArIHBsYW5lLmRpc3RhbmNlOwogICAgICAgIGlmIChkaXN0YW5jZVRvUGxhbmUgPD0gLXJhZEVmZmVjdGl2ZSkgewogICAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0Lk9VVFNJREU7CiAgICAgICAgfSBlbHNlIGlmIChkaXN0YW5jZVRvUGxhbmUgPj0gcmFkRWZmZWN0aXZlKSB7CiAgICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuSU5TSURFOwogICAgICAgIH0KICAgICAgICByZXR1cm4gSW50ZXJzZWN0X2RlZmF1bHQuSU5URVJTRUNUSU5HOwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydGVzaWFuVSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhblYgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5XID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVmFsaWRBeGlzMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFZhbGlkQXhpczMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQUHJpbWUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guZGlzdGFuY2VTcXVhcmVkVG8gPSBmdW5jdGlvbihib3gsIGNhcnRlc2lhbjExKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYm94KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImJveCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY2FydGVzaWFuMTEpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY2FydGVzaWFuIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBvZmZzZXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY2FydGVzaWFuMTEsIGJveC5jZW50ZXIsIHNjcmF0Y2hPZmZzZXQpOwogICAgICAgIGNvbnN0IGhhbGZBeGVzID0gYm94LmhhbGZBeGVzOwogICAgICAgIGxldCB1MyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDAsIHNjcmF0Y2hDYXJ0ZXNpYW5VKTsKICAgICAgICBsZXQgdjMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAxLCBzY3JhdGNoQ2FydGVzaWFuVik7CiAgICAgICAgbGV0IHcgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAyLCBzY3JhdGNoQ2FydGVzaWFuVyk7CiAgICAgICAgY29uc3QgdUhhbGYgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHUzKTsKICAgICAgICBjb25zdCB2SGFsZiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUodjMpOwogICAgICAgIGNvbnN0IHdIYWxmID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh3KTsKICAgICAgICBsZXQgdVZhbGlkID0gdHJ1ZTsKICAgICAgICBsZXQgdlZhbGlkID0gdHJ1ZTsKICAgICAgICBsZXQgd1ZhbGlkID0gdHJ1ZTsKICAgICAgICBpZiAodUhhbGYgPiAwKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGl2aWRlQnlTY2FsYXIodTMsIHVIYWxmLCB1Myk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHVWYWxpZCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAodkhhbGYgPiAwKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGl2aWRlQnlTY2FsYXIodjMsIHZIYWxmLCB2Myk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZWYWxpZCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAod0hhbGYgPiAwKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGl2aWRlQnlTY2FsYXIodywgd0hhbGYsIHcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3VmFsaWQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbnVtYmVyT2ZEZWdlbmVyYXRlQXhlcyA9ICF1VmFsaWQgKyAhdlZhbGlkICsgIXdWYWxpZDsKICAgICAgICBsZXQgdmFsaWRBeGlzMTsKICAgICAgICBsZXQgdmFsaWRBeGlzMjsKICAgICAgICBsZXQgdmFsaWRBeGlzMzsKICAgICAgICBpZiAobnVtYmVyT2ZEZWdlbmVyYXRlQXhlcyA9PT0gMSkgewogICAgICAgICAgbGV0IGRlZ2VuZXJhdGVBeGlzID0gdTM7CiAgICAgICAgICB2YWxpZEF4aXMxID0gdjM7CiAgICAgICAgICB2YWxpZEF4aXMyID0gdzsKICAgICAgICAgIGlmICghdlZhbGlkKSB7CiAgICAgICAgICAgIGRlZ2VuZXJhdGVBeGlzID0gdjM7CiAgICAgICAgICAgIHZhbGlkQXhpczEgPSB1MzsKICAgICAgICAgIH0gZWxzZSBpZiAoIXdWYWxpZCkgewogICAgICAgICAgICBkZWdlbmVyYXRlQXhpcyA9IHc7CiAgICAgICAgICAgIHZhbGlkQXhpczIgPSB1MzsKICAgICAgICAgIH0KICAgICAgICAgIHZhbGlkQXhpczMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModmFsaWRBeGlzMSwgdmFsaWRBeGlzMiwgc2NyYXRjaFZhbGlkQXhpczMpOwogICAgICAgICAgaWYgKGRlZ2VuZXJhdGVBeGlzID09PSB1MykgewogICAgICAgICAgICB1MyA9IHZhbGlkQXhpczM7CiAgICAgICAgICB9IGVsc2UgaWYgKGRlZ2VuZXJhdGVBeGlzID09PSB2MykgewogICAgICAgICAgICB2MyA9IHZhbGlkQXhpczM7CiAgICAgICAgICB9IGVsc2UgaWYgKGRlZ2VuZXJhdGVBeGlzID09PSB3KSB7CiAgICAgICAgICAgIHcgPSB2YWxpZEF4aXMzOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAobnVtYmVyT2ZEZWdlbmVyYXRlQXhlcyA9PT0gMikgewogICAgICAgICAgdmFsaWRBeGlzMSA9IHUzOwogICAgICAgICAgaWYgKHZWYWxpZCkgewogICAgICAgICAgICB2YWxpZEF4aXMxID0gdjM7CiAgICAgICAgICB9IGVsc2UgaWYgKHdWYWxpZCkgewogICAgICAgICAgICB2YWxpZEF4aXMxID0gdzsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBjcm9zc1ZlY3RvciA9IENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1k7CiAgICAgICAgICBpZiAoY3Jvc3NWZWN0b3IuZXF1YWxzRXBzaWxvbih2YWxpZEF4aXMxLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjMpKSB7CiAgICAgICAgICAgIGNyb3NzVmVjdG9yID0gQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWDsKICAgICAgICAgIH0KICAgICAgICAgIHZhbGlkQXhpczIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3ModmFsaWRBeGlzMSwgY3Jvc3NWZWN0b3IsIHNjcmF0Y2hWYWxpZEF4aXMyKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUodmFsaWRBeGlzMiwgdmFsaWRBeGlzMik7CiAgICAgICAgICB2YWxpZEF4aXMzID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHZhbGlkQXhpczEsIHZhbGlkQXhpczIsIHNjcmF0Y2hWYWxpZEF4aXMzKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUodmFsaWRBeGlzMywgdmFsaWRBeGlzMyk7CiAgICAgICAgICBpZiAodmFsaWRBeGlzMSA9PT0gdTMpIHsKICAgICAgICAgICAgdjMgPSB2YWxpZEF4aXMyOwogICAgICAgICAgICB3ID0gdmFsaWRBeGlzMzsKICAgICAgICAgIH0gZWxzZSBpZiAodmFsaWRBeGlzMSA9PT0gdjMpIHsKICAgICAgICAgICAgdyA9IHZhbGlkQXhpczI7CiAgICAgICAgICAgIHUzID0gdmFsaWRBeGlzMzsKICAgICAgICAgIH0gZWxzZSBpZiAodmFsaWRBeGlzMSA9PT0gdykgewogICAgICAgICAgICB1MyA9IHZhbGlkQXhpczI7CiAgICAgICAgICAgIHYzID0gdmFsaWRBeGlzMzsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG51bWJlck9mRGVnZW5lcmF0ZUF4ZXMgPT09IDMpIHsKICAgICAgICAgIHUzID0gQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWDsKICAgICAgICAgIHYzID0gQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWTsKICAgICAgICAgIHcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9aOwogICAgICAgIH0KICAgICAgICBjb25zdCBwUHJpbWUgPSBzY3JhdGNoUFByaW1lOwogICAgICAgIHBQcmltZS54ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChvZmZzZXQsIHUzKTsKICAgICAgICBwUHJpbWUueSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3Qob2Zmc2V0LCB2Myk7CiAgICAgICAgcFByaW1lLnogPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG9mZnNldCwgdyk7CiAgICAgICAgbGV0IGRpc3RhbmNlU3F1YXJlZCA9IDA7CiAgICAgICAgbGV0IGQ7CiAgICAgICAgaWYgKHBQcmltZS54IDwgLXVIYWxmKSB7CiAgICAgICAgICBkID0gcFByaW1lLnggKyB1SGFsZjsKICAgICAgICAgIGRpc3RhbmNlU3F1YXJlZCArPSBkICogZDsKICAgICAgICB9IGVsc2UgaWYgKHBQcmltZS54ID4gdUhhbGYpIHsKICAgICAgICAgIGQgPSBwUHJpbWUueCAtIHVIYWxmOwogICAgICAgICAgZGlzdGFuY2VTcXVhcmVkICs9IGQgKiBkOwogICAgICAgIH0KICAgICAgICBpZiAocFByaW1lLnkgPCAtdkhhbGYpIHsKICAgICAgICAgIGQgPSBwUHJpbWUueSArIHZIYWxmOwogICAgICAgICAgZGlzdGFuY2VTcXVhcmVkICs9IGQgKiBkOwogICAgICAgIH0gZWxzZSBpZiAocFByaW1lLnkgPiB2SGFsZikgewogICAgICAgICAgZCA9IHBQcmltZS55IC0gdkhhbGY7CiAgICAgICAgICBkaXN0YW5jZVNxdWFyZWQgKz0gZCAqIGQ7CiAgICAgICAgfQogICAgICAgIGlmIChwUHJpbWUueiA8IC13SGFsZikgewogICAgICAgICAgZCA9IHBQcmltZS56ICsgd0hhbGY7CiAgICAgICAgICBkaXN0YW5jZVNxdWFyZWQgKz0gZCAqIGQ7CiAgICAgICAgfSBlbHNlIGlmIChwUHJpbWUueiA+IHdIYWxmKSB7CiAgICAgICAgICBkID0gcFByaW1lLnogLSB3SGFsZjsKICAgICAgICAgIGRpc3RhbmNlU3F1YXJlZCArPSBkICogZDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRpc3RhbmNlU3F1YXJlZDsKICAgICAgfTsKICAgICAgc2NyYXRjaENvcm5lciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFRvQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmNvbXB1dGVQbGFuZURpc3RhbmNlcyA9IGZ1bmN0aW9uKGJveCwgcG9zaXRpb24sIGRpcmVjdGlvbjIsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJveCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJib3ggaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBvc2l0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkaXJlY3Rpb24yKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRpcmVjdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEludGVydmFsX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgbGV0IG1pbkRpc3QgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbGV0IG1heERpc3QgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgY29uc3QgY2VudGVyID0gYm94LmNlbnRlcjsKICAgICAgICBjb25zdCBoYWxmQXhlcyA9IGJveC5oYWxmQXhlczsKICAgICAgICBjb25zdCB1MyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDAsIHNjcmF0Y2hDYXJ0ZXNpYW5VKTsKICAgICAgICBjb25zdCB2MyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIHNjcmF0Y2hDYXJ0ZXNpYW5WKTsKICAgICAgICBjb25zdCB3ID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMiwgc2NyYXRjaENhcnRlc2lhblcpOwogICAgICAgIGNvbnN0IGNvcm5lciA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodTMsIHYzLCBzY3JhdGNoQ29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgdywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgY2VudGVyLCBjb3JuZXIpOwogICAgICAgIGNvbnN0IHRvQ2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgcG9zaXRpb24sIHNjcmF0Y2hUb0NlbnRlcik7CiAgICAgICAgbGV0IG1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgdG9DZW50ZXIpOwogICAgICAgIG1pbkRpc3QgPSBNYXRoLm1pbihtYWcsIG1pbkRpc3QpOwogICAgICAgIG1heERpc3QgPSBNYXRoLm1heChtYWcsIG1heERpc3QpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2VudGVyLCB1MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgdjMsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgdywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCBwb3NpdGlvbiwgdG9DZW50ZXIpOwogICAgICAgIG1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgdG9DZW50ZXIpOwogICAgICAgIG1pbkRpc3QgPSBNYXRoLm1pbihtYWcsIG1pbkRpc3QpOwogICAgICAgIG1heERpc3QgPSBNYXRoLm1heChtYWcsIG1heERpc3QpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2VudGVyLCB1MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCB2MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgdywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCBwb3NpdGlvbiwgdG9DZW50ZXIpOwogICAgICAgIG1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgdG9DZW50ZXIpOwogICAgICAgIG1pbkRpc3QgPSBNYXRoLm1pbihtYWcsIG1pbkRpc3QpOwogICAgICAgIG1heERpc3QgPSBNYXRoLm1heChtYWcsIG1heERpc3QpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY2VudGVyLCB1MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCB2MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCB3LCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHBvc2l0aW9uLCB0b0NlbnRlcik7CiAgICAgICAgbWFnID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCB0b0NlbnRlcik7CiAgICAgICAgbWluRGlzdCA9IE1hdGgubWluKG1hZywgbWluRGlzdCk7CiAgICAgICAgbWF4RGlzdCA9IE1hdGgubWF4KG1hZywgbWF4RGlzdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNlbnRlciwgdTMsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjb3JuZXIsIHYzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoY29ybmVyLCB3LCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHBvc2l0aW9uLCB0b0NlbnRlcik7CiAgICAgICAgbWFnID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCB0b0NlbnRlcik7CiAgICAgICAgbWluRGlzdCA9IE1hdGgubWluKG1hZywgbWluRGlzdCk7CiAgICAgICAgbWF4RGlzdCA9IE1hdGgubWF4KG1hZywgbWF4RGlzdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNlbnRlciwgdTMsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjb3JuZXIsIHYzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHcsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgcG9zaXRpb24sIHRvQ2VudGVyKTsKICAgICAgICBtYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHRvQ2VudGVyKTsKICAgICAgICBtaW5EaXN0ID0gTWF0aC5taW4obWFnLCBtaW5EaXN0KTsKICAgICAgICBtYXhEaXN0ID0gTWF0aC5tYXgobWFnLCBtYXhEaXN0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY2VudGVyLCB1MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCB2MywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNvcm5lciwgdywgY29ybmVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoY29ybmVyLCBwb3NpdGlvbiwgdG9DZW50ZXIpOwogICAgICAgIG1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgdG9DZW50ZXIpOwogICAgICAgIG1pbkRpc3QgPSBNYXRoLm1pbihtYWcsIG1pbkRpc3QpOwogICAgICAgIG1heERpc3QgPSBNYXRoLm1heChtYWcsIG1heERpc3QpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjZW50ZXIsIHUzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHYzLCBjb3JuZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChjb3JuZXIsIHcsIGNvcm5lcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgcG9zaXRpb24sIHRvQ2VudGVyKTsKICAgICAgICBtYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHRvQ2VudGVyKTsKICAgICAgICBtaW5EaXN0ID0gTWF0aC5taW4obWFnLCBtaW5EaXN0KTsKICAgICAgICBtYXhEaXN0ID0gTWF0aC5tYXgobWFnLCBtYXhEaXN0KTsKICAgICAgICByZXN1bHQuc3RhcnQgPSBtaW5EaXN0OwogICAgICAgIHJlc3VsdC5zdG9wID0gbWF4RGlzdDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoWEF4aXMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hZQXhpcyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFpBeGlzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmNvbXB1dGVDb3JuZXJzID0gZnVuY3Rpb24oYm94LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImJveCIsIGJveCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gWwogICAgICAgICAgICBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgICAgICBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgICAgICBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKQogICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2VudGVyID0gYm94LmNlbnRlcjsKICAgICAgICBjb25zdCBoYWxmQXhlcyA9IGJveC5oYWxmQXhlczsKICAgICAgICBjb25zdCB4QXhpcyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDAsIHNjcmF0Y2hYQXhpcyk7CiAgICAgICAgY29uc3QgeUF4aXMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAxLCBzY3JhdGNoWUF4aXMpOwogICAgICAgIGNvbnN0IHpBeGlzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMiwgc2NyYXRjaFpBeGlzKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyLCByZXN1bHRbMF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbMF0sIHhBeGlzLCByZXN1bHRbMF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbMF0sIHlBeGlzLCByZXN1bHRbMF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbMF0sIHpBeGlzLCByZXN1bHRbMF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdFsxXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFsxXSwgeEF4aXMsIHJlc3VsdFsxXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFsxXSwgeUF4aXMsIHJlc3VsdFsxXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbMV0sIHpBeGlzLCByZXN1bHRbMV0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdFsyXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFsyXSwgeEF4aXMsIHJlc3VsdFsyXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbMl0sIHlBeGlzLCByZXN1bHRbMl0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbMl0sIHpBeGlzLCByZXN1bHRbMl0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdFszXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHJlc3VsdFszXSwgeEF4aXMsIHJlc3VsdFszXSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbM10sIHlBeGlzLCByZXN1bHRbM10pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0WzNdLCB6QXhpcywgcmVzdWx0WzNdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyLCByZXN1bHRbNF0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0WzRdLCB4QXhpcywgcmVzdWx0WzRdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocmVzdWx0WzRdLCB5QXhpcywgcmVzdWx0WzRdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocmVzdWx0WzRdLCB6QXhpcywgcmVzdWx0WzRdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyLCByZXN1bHRbNV0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0WzVdLCB4QXhpcywgcmVzdWx0WzVdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocmVzdWx0WzVdLCB5QXhpcywgcmVzdWx0WzVdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFs1XSwgekF4aXMsIHJlc3VsdFs1XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlciwgcmVzdWx0WzZdKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFs2XSwgeEF4aXMsIHJlc3VsdFs2XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbNl0sIHlBeGlzLCByZXN1bHRbNl0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChyZXN1bHRbNl0sIHpBeGlzLCByZXN1bHRbNl0pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHJlc3VsdFs3XSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyZXN1bHRbN10sIHhBeGlzLCByZXN1bHRbN10pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmVzdWx0WzddLCB5QXhpcywgcmVzdWx0WzddKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdFs3XSwgekF4aXMsIHJlc3VsdFs3XSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgc2NyYXRjaFJvdGF0aW9uU2NhbGUgPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guY29tcHV0ZVRyYW5zZm9ybWF0aW9uID0gZnVuY3Rpb24oYm94LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImJveCIsIGJveCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCB0cmFuc2xhdGlvbjIgPSBib3guY2VudGVyOwogICAgICAgIGNvbnN0IHJvdGF0aW9uU2NhbGUgPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVVuaWZvcm1TY2FsZSgKICAgICAgICAgIGJveC5oYWxmQXhlcywKICAgICAgICAgIDIsCiAgICAgICAgICBzY3JhdGNoUm90YXRpb25TY2FsZQogICAgICAgICk7CiAgICAgICAgcmV0dXJuIE1hdHJpeDRfZGVmYXVsdC5mcm9tUm90YXRpb25UcmFuc2xhdGlvbihyb3RhdGlvblNjYWxlLCB0cmFuc2xhdGlvbjIsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hCb3VuZGluZ1NwaGVyZSA9IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KCk7CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3guaXNPY2NsdWRlZCA9IGZ1bmN0aW9uKGJveCwgb2NjbHVkZXIpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3gpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYm94IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvY2NsdWRlcikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvY2NsdWRlciBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tT3JpZW50ZWRCb3VuZGluZ0JveCgKICAgICAgICAgIGJveCwKICAgICAgICAgIHNjcmF0Y2hCb3VuZGluZ1NwaGVyZQogICAgICAgICk7CiAgICAgICAgcmV0dXJuICFvY2NsdWRlci5pc0JvdW5kaW5nU3BoZXJlVmlzaWJsZShzcGhlcmUpOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LnByb3RvdHlwZS5pbnRlcnNlY3RQbGFuZSA9IGZ1bmN0aW9uKHBsYW5lKSB7CiAgICAgICAgcmV0dXJuIE9yaWVudGVkQm91bmRpbmdCb3guaW50ZXJzZWN0UGxhbmUodGhpcywgcGxhbmUpOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LnByb3RvdHlwZS5kaXN0YW5jZVNxdWFyZWRUbyA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExKSB7CiAgICAgICAgcmV0dXJuIE9yaWVudGVkQm91bmRpbmdCb3guZGlzdGFuY2VTcXVhcmVkVG8odGhpcywgY2FydGVzaWFuMTEpOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LnByb3RvdHlwZS5jb21wdXRlUGxhbmVEaXN0YW5jZXMgPSBmdW5jdGlvbihwb3NpdGlvbiwgZGlyZWN0aW9uMiwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE9yaWVudGVkQm91bmRpbmdCb3guY29tcHV0ZVBsYW5lRGlzdGFuY2VzKAogICAgICAgICAgdGhpcywKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgZGlyZWN0aW9uMiwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gucHJvdG90eXBlLmNvbXB1dGVDb3JuZXJzID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE9yaWVudGVkQm91bmRpbmdCb3guY29tcHV0ZUNvcm5lcnModGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuY29tcHV0ZVRyYW5zZm9ybWF0aW9uID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE9yaWVudGVkQm91bmRpbmdCb3guY29tcHV0ZVRyYW5zZm9ybWF0aW9uKHRoaXMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gucHJvdG90eXBlLmlzT2NjbHVkZWQgPSBmdW5jdGlvbihvY2NsdWRlcikgewogICAgICAgIHJldHVybiBPcmllbnRlZEJvdW5kaW5nQm94LmlzT2NjbHVkZWQodGhpcywgb2NjbHVkZXIpOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94LmVxdWFscyA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWRfZGVmYXVsdChsZWZ0KSAmJiBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMobGVmdC5jZW50ZXIsIHJpZ2h0LmNlbnRlcikgJiYgTWF0cml4M19kZWZhdWx0LmVxdWFscyhsZWZ0LmhhbGZBeGVzLCByaWdodC5oYWxmQXhlcyk7CiAgICAgIH07CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3gucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIE9yaWVudGVkQm91bmRpbmdCb3guY2xvbmUodGhpcywgcmVzdWx0KTsKICAgICAgfTsKICAgICAgT3JpZW50ZWRCb3VuZGluZ0JveC5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ocmlnaHQpIHsKICAgICAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5lcXVhbHModGhpcywgcmlnaHQpOwogICAgICB9OwogICAgICBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQgPSBPcmllbnRlZEJvdW5kaW5nQm94OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LmpzCiAgZnVuY3Rpb24gcHJvamVjdFRvMkQocG9zaXRpb24sIGNlbnRlciwgYXhpczEsIGF4aXMyLCByZXN1bHQpIHsKICAgIGNvbnN0IHYzID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHBvc2l0aW9uLCBjZW50ZXIsIHNjcmF0Y2hJbnRlcnNlY3Rpb25Qb2ludCk7CiAgICBjb25zdCB4ID0gQ2FydGVzaWFuM19kZWZhdWx0LmRvdChheGlzMSwgdjMpOwogICAgY29uc3QgeSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoYXhpczIsIHYzKTsKICAgIHJldHVybiBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHgsIHksIHJlc3VsdCk7CiAgfQogIHZhciBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnksIHNjcmF0Y2hJbnRlcnNlY3Rpb25Qb2ludCwgc2NyYXRjaFhBeGlzMiwgc2NyYXRjaFlBeGlzMiwgc2NyYXRjaFpBeGlzMiwgb2JiU2NyYXRjaCwgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfT3JpZW50ZWRCb3VuZGluZ0JveCgpOwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkgPSB7fTsKICAgICAgc2NyYXRjaEludGVyc2VjdGlvblBvaW50ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoWEF4aXMyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoWUF4aXMyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoWkF4aXMyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBvYmJTY3JhdGNoID0gbmV3IE9yaWVudGVkQm91bmRpbmdCb3hfZGVmYXVsdCgpOwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnkudmFsaWRPdXRsaW5lID0gZnVuY3Rpb24ocG9zaXRpb25zKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgICAgIGNvbnN0IG9yaWVudGVkQm91bmRpbmdCb3ggPSBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQuZnJvbVBvaW50cygKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIG9iYlNjcmF0Y2gKICAgICAgICApOwogICAgICAgIGNvbnN0IGhhbGZBeGVzID0gb3JpZW50ZWRCb3VuZGluZ0JveC5oYWxmQXhlczsKICAgICAgICBjb25zdCB4QXhpcyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDAsIHNjcmF0Y2hYQXhpczIpOwogICAgICAgIGNvbnN0IHlBeGlzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMSwgc2NyYXRjaFlBeGlzMik7CiAgICAgICAgY29uc3QgekF4aXMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAyLCBzY3JhdGNoWkF4aXMyKTsKICAgICAgICBjb25zdCB4TWFnID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh4QXhpcyk7CiAgICAgICAgY29uc3QgeU1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoeUF4aXMpOwogICAgICAgIGNvbnN0IHpNYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHpBeGlzKTsKICAgICAgICByZXR1cm4gISh4TWFnID09PSAwICYmICh5TWFnID09PSAwIHx8IHpNYWcgPT09IDApIHx8IHlNYWcgPT09IDAgJiYgek1hZyA9PT0gMCk7CiAgICAgIH07CiAgICAgIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeS5jb21wdXRlUHJvamVjdFRvMkRBcmd1bWVudHMgPSBmdW5jdGlvbihwb3NpdGlvbnMsIGNlbnRlclJlc3VsdCwgcGxhbmVBeGlzMVJlc3VsdCwgcGxhbmVBeGlzMlJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicG9zaXRpb25zIiwgcG9zaXRpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNlbnRlclJlc3VsdCIsIGNlbnRlclJlc3VsdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwbGFuZUF4aXMxUmVzdWx0IiwgcGxhbmVBeGlzMVJlc3VsdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwbGFuZUF4aXMyUmVzdWx0IiwgcGxhbmVBeGlzMlJlc3VsdCk7CiAgICAgICAgY29uc3Qgb3JpZW50ZWRCb3VuZGluZ0JveCA9IE9yaWVudGVkQm91bmRpbmdCb3hfZGVmYXVsdC5mcm9tUG9pbnRzKAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgb2JiU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgY29uc3QgaGFsZkF4ZXMgPSBvcmllbnRlZEJvdW5kaW5nQm94LmhhbGZBeGVzOwogICAgICAgIGNvbnN0IHhBeGlzID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihoYWxmQXhlcywgMCwgc2NyYXRjaFhBeGlzMik7CiAgICAgICAgY29uc3QgeUF4aXMgPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKGhhbGZBeGVzLCAxLCBzY3JhdGNoWUF4aXMyKTsKICAgICAgICBjb25zdCB6QXhpcyA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4oaGFsZkF4ZXMsIDIsIHNjcmF0Y2haQXhpczIpOwogICAgICAgIGNvbnN0IHhNYWcgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKHhBeGlzKTsKICAgICAgICBjb25zdCB5TWFnID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSh5QXhpcyk7CiAgICAgICAgY29uc3Qgek1hZyA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoekF4aXMpOwogICAgICAgIGNvbnN0IG1pbjMgPSBNYXRoLm1pbih4TWFnLCB5TWFnLCB6TWFnKTsKICAgICAgICBpZiAoeE1hZyA9PT0gMCAmJiAoeU1hZyA9PT0gMCB8fCB6TWFnID09PSAwKSB8fCB5TWFnID09PSAwICYmIHpNYWcgPT09IDApIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgbGV0IHBsYW5lQXhpczE7CiAgICAgICAgbGV0IHBsYW5lQXhpczI7CiAgICAgICAgaWYgKG1pbjMgPT09IHlNYWcgfHwgbWluMyA9PT0gek1hZykgewogICAgICAgICAgcGxhbmVBeGlzMSA9IHhBeGlzOwogICAgICAgIH0KICAgICAgICBpZiAobWluMyA9PT0geE1hZykgewogICAgICAgICAgcGxhbmVBeGlzMSA9IHlBeGlzOwogICAgICAgIH0gZWxzZSBpZiAobWluMyA9PT0gek1hZykgewogICAgICAgICAgcGxhbmVBeGlzMiA9IHlBeGlzOwogICAgICAgIH0KICAgICAgICBpZiAobWluMyA9PT0geE1hZyB8fCBtaW4zID09PSB5TWFnKSB7CiAgICAgICAgICBwbGFuZUF4aXMyID0gekF4aXM7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocGxhbmVBeGlzMSwgcGxhbmVBeGlzMVJlc3VsdCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShwbGFuZUF4aXMyLCBwbGFuZUF4aXMyUmVzdWx0KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUob3JpZW50ZWRCb3VuZGluZ0JveC5jZW50ZXIsIGNlbnRlclJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH07CiAgICAgIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeS5jcmVhdGVQcm9qZWN0UG9pbnRzVG8yREZ1bmN0aW9uID0gZnVuY3Rpb24oY2VudGVyLCBheGlzMSwgYXhpczIpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ocG9zaXRpb25zKSB7CiAgICAgICAgICBjb25zdCBwb3NpdGlvblJlc3VsdHMgPSBuZXcgQXJyYXkocG9zaXRpb25zLmxlbmd0aCk7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBwb3NpdGlvblJlc3VsdHNbaV0gPSBwcm9qZWN0VG8yRChwb3NpdGlvbnNbaV0sIGNlbnRlciwgYXhpczEsIGF4aXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwb3NpdGlvblJlc3VsdHM7CiAgICAgICAgfTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LmNyZWF0ZVByb2plY3RQb2ludFRvMkRGdW5jdGlvbiA9IGZ1bmN0aW9uKGNlbnRlciwgYXhpczEsIGF4aXMyKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHBvc2l0aW9uLCByZXN1bHQpIHsKICAgICAgICAgIHJldHVybiBwcm9qZWN0VG8yRChwb3NpdGlvbiwgY2VudGVyLCBheGlzMSwgYXhpczIsIHJlc3VsdCk7CiAgICAgICAgfTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQgPSBDb3BsYW5hclBvbHlnb25HZW9tZXRyeUxpYnJhcnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9BcmNUeXBlLmpzCiAgdmFyIEFyY1R5cGUsIEFyY1R5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9BcmNUeXBlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9BcmNUeXBlLmpzIigpIHsKICAgICAgQXJjVHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBTdHJhaWdodCBsaW5lIHRoYXQgZG9lcyBub3QgY29uZm9ybSB0byB0aGUgc3VyZmFjZSBvZiB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBOT05FOiAwLAogICAgICAgIC8qKgogICAgICAgICAqIEZvbGxvdyBnZW9kZXNpYyBwYXRoLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBHRU9ERVNJQzogMSwKICAgICAgICAvKioKICAgICAgICAgKiBGb2xsb3cgcmh1bWIgb3IgbG94b2Ryb21lIHBhdGguCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJIVU1COiAyCiAgICAgIH07CiAgICAgIEFyY1R5cGVfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoQXJjVHlwZSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRSaHVtYkxpbmUuanMKICBmdW5jdGlvbiBjYWxjdWxhdGVNKGVsbGlwdGljaXR5LCBtYWpvciwgbGF0aXR1ZGUpIHsKICAgIGlmIChlbGxpcHRpY2l0eSA9PT0gMCkgewogICAgICByZXR1cm4gbWFqb3IgKiBsYXRpdHVkZTsKICAgIH0KICAgIGNvbnN0IGUyID0gZWxsaXB0aWNpdHkgKiBlbGxpcHRpY2l0eTsKICAgIGNvbnN0IGU0ID0gZTIgKiBlMjsKICAgIGNvbnN0IGU2ID0gZTQgKiBlMjsKICAgIGNvbnN0IGU4ID0gZTYgKiBlMjsKICAgIGNvbnN0IGUxMCA9IGU4ICogZTI7CiAgICBjb25zdCBlMTIgPSBlMTAgKiBlMjsKICAgIGNvbnN0IHBoaSA9IGxhdGl0dWRlOwogICAgY29uc3Qgc2luMlBoaSA9IE1hdGguc2luKDIgKiBwaGkpOwogICAgY29uc3Qgc2luNFBoaSA9IE1hdGguc2luKDQgKiBwaGkpOwogICAgY29uc3Qgc2luNlBoaSA9IE1hdGguc2luKDYgKiBwaGkpOwogICAgY29uc3Qgc2luOFBoaSA9IE1hdGguc2luKDggKiBwaGkpOwogICAgY29uc3Qgc2luMTBQaGkgPSBNYXRoLnNpbigxMCAqIHBoaSk7CiAgICBjb25zdCBzaW4xMlBoaSA9IE1hdGguc2luKDEyICogcGhpKTsKICAgIHJldHVybiBtYWpvciAqICgoMSAtIGUyIC8gNCAtIDMgKiBlNCAvIDY0IC0gNSAqIGU2IC8gMjU2IC0gMTc1ICogZTggLyAxNjM4NCAtIDQ0MSAqIGUxMCAvIDY1NTM2IC0gNDg1MSAqIGUxMiAvIDEwNDg1NzYpICogcGhpIC0gKDMgKiBlMiAvIDggKyAzICogZTQgLyAzMiArIDQ1ICogZTYgLyAxMDI0ICsgMTA1ICogZTggLyA0MDk2ICsgMjIwNSAqIGUxMCAvIDEzMTA3MiArIDYyMzcgKiBlMTIgLyA1MjQyODgpICogc2luMlBoaSArICgxNSAqIGU0IC8gMjU2ICsgNDUgKiBlNiAvIDEwMjQgKyA1MjUgKiBlOCAvIDE2Mzg0ICsgMTU3NSAqIGUxMCAvIDY1NTM2ICsgMTU1OTI1ICogZTEyIC8gODM4ODYwOCkgKiBzaW40UGhpIC0gKDM1ICogZTYgLyAzMDcyICsgMTc1ICogZTggLyAxMjI4OCArIDM2NzUgKiBlMTAgLyAyNjIxNDQgKyAxMzQ3NSAqIGUxMiAvIDEwNDg1NzYpICogc2luNlBoaSArICgzMTUgKiBlOCAvIDEzMTA3MiArIDIyMDUgKiBlMTAgLyA1MjQyODggKyA0MzY1OSAqIGUxMiAvIDgzODg2MDgpICogc2luOFBoaSAtICg2OTMgKiBlMTAgLyAxMzEwNzIwICsgNjIzNyAqIGUxMiAvIDUyNDI4ODApICogc2luMTBQaGkgKyAxMDAxICogZTEyIC8gODM4ODYwOCAqIHNpbjEyUGhpKTsKICB9CiAgZnVuY3Rpb24gY2FsY3VsYXRlSW52ZXJzZU0oTSwgZWxsaXB0aWNpdHksIG1ham9yKSB7CiAgICBjb25zdCBkID0gTSAvIG1ham9yOwogICAgaWYgKGVsbGlwdGljaXR5ID09PSAwKSB7CiAgICAgIHJldHVybiBkOwogICAgfQogICAgY29uc3QgZDIgPSBkICogZDsKICAgIGNvbnN0IGQzID0gZDIgKiBkOwogICAgY29uc3QgZDQgPSBkMyAqIGQ7CiAgICBjb25zdCBlID0gZWxsaXB0aWNpdHk7CiAgICBjb25zdCBlMiA9IGUgKiBlOwogICAgY29uc3QgZTQgPSBlMiAqIGUyOwogICAgY29uc3QgZTYgPSBlNCAqIGUyOwogICAgY29uc3QgZTggPSBlNiAqIGUyOwogICAgY29uc3QgZTEwID0gZTggKiBlMjsKICAgIGNvbnN0IGUxMiA9IGUxMCAqIGUyOwogICAgY29uc3Qgc2luMkQgPSBNYXRoLnNpbigyICogZCk7CiAgICBjb25zdCBjb3MyRCA9IE1hdGguY29zKDIgKiBkKTsKICAgIGNvbnN0IHNpbjREID0gTWF0aC5zaW4oNCAqIGQpOwogICAgY29uc3QgY29zNEQgPSBNYXRoLmNvcyg0ICogZCk7CiAgICBjb25zdCBzaW42RCA9IE1hdGguc2luKDYgKiBkKTsKICAgIGNvbnN0IGNvczZEID0gTWF0aC5jb3MoNiAqIGQpOwogICAgY29uc3Qgc2luOEQgPSBNYXRoLnNpbig4ICogZCk7CiAgICBjb25zdCBjb3M4RCA9IE1hdGguY29zKDggKiBkKTsKICAgIGNvbnN0IHNpbjEwRCA9IE1hdGguc2luKDEwICogZCk7CiAgICBjb25zdCBjb3MxMEQgPSBNYXRoLmNvcygxMCAqIGQpOwogICAgY29uc3Qgc2luMTJEID0gTWF0aC5zaW4oMTIgKiBkKTsKICAgIHJldHVybiBkICsgZCAqIGUyIC8gNCArIDcgKiBkICogZTQgLyA2NCArIDE1ICogZCAqIGU2IC8gMjU2ICsgNTc5ICogZCAqIGU4IC8gMTYzODQgKyAxNTE1ICogZCAqIGUxMCAvIDY1NTM2ICsgMTY4MzcgKiBkICogZTEyIC8gMTA0ODU3NiArICgzICogZCAqIGU0IC8gMTYgKyA0NSAqIGQgKiBlNiAvIDI1NiAtIGQgKiAoMzIgKiBkMiAtIDU2MSkgKiBlOCAvIDQwOTYgLSBkICogKDIzMiAqIGQyIC0gMTY3NykgKiBlMTAgLyAxNjM4NCArIGQgKiAoMzk5OTg1IC0gOTA1NjAgKiBkMiArIDUxMiAqIGQ0KSAqIGUxMiAvIDUyNDI4ODApICogY29zMkQgKyAoMjEgKiBkICogZTYgLyAyNTYgKyA0ODMgKiBkICogZTggLyA0MDk2IC0gZCAqICgyMjQgKiBkMiAtIDE5NjkpICogZTEwIC8gMTYzODQgLSBkICogKDMzMTUyICogZDIgLSAxMTI1OTkpICogZTEyIC8gMTA0ODU3NikgKiBjb3M0RCArICgxNTEgKiBkICogZTggLyA0MDk2ICsgNDY4MSAqIGQgKiBlMTAgLyA2NTUzNiArIDE0NzkgKiBkICogZTEyIC8gMTYzODQgLSA0NTMgKiBkMyAqIGUxMiAvIDMyNzY4KSAqIGNvczZEICsgKDEwOTcgKiBkICogZTEwIC8gNjU1MzYgKyA0Mjc4MyAqIGQgKiBlMTIgLyAxMDQ4NTc2KSAqIGNvczhEICsgODAxMSAqIGQgKiBlMTIgLyAxMDQ4NTc2ICogY29zMTBEICsgKDMgKiBlMiAvIDggKyAzICogZTQgLyAxNiArIDIxMyAqIGU2IC8gMjA0OCAtIDMgKiBkMiAqIGU2IC8gNjQgKyAyNTUgKiBlOCAvIDQwOTYgLSAzMyAqIGQyICogZTggLyA1MTIgKyAyMDg2MSAqIGUxMCAvIDUyNDI4OCAtIDMzICogZDIgKiBlMTAgLyA1MTIgKyBkNCAqIGUxMCAvIDEwMjQgKyAyODI3MyAqIGUxMiAvIDEwNDg1NzYgLSA0NzEgKiBkMiAqIGUxMiAvIDgxOTIgKyA5ICogZDQgKiBlMTIgLyA0MDk2KSAqIHNpbjJEICsgKDIxICogZTQgLyAyNTYgKyAyMSAqIGU2IC8gMjU2ICsgNTMzICogZTggLyA4MTkyIC0gMjEgKiBkMiAqIGU4IC8gNTEyICsgMTk3ICogZTEwIC8gNDA5NiAtIDMxNSAqIGQyICogZTEwIC8gNDA5NiArIDU4NDAzOSAqIGUxMiAvIDE2Nzc3MjE2IC0gMTI1MTcgKiBkMiAqIGUxMiAvIDEzMTA3MiArIDcgKiBkNCAqIGUxMiAvIDIwNDgpICogc2luNEQgKyAoMTUxICogZTYgLyA2MTQ0ICsgMTUxICogZTggLyA0MDk2ICsgNTAxOSAqIGUxMCAvIDEzMTA3MiAtIDQ1MyAqIGQyICogZTEwIC8gMTYzODQgKyAyNjk2NSAqIGUxMiAvIDc4NjQzMiAtIDg2MDcgKiBkMiAqIGUxMiAvIDEzMTA3MikgKiBzaW42RCArICgxMDk3ICogZTggLyAxMzEwNzIgKyAxMDk3ICogZTEwIC8gNjU1MzYgKyAyMjU3OTcgKiBlMTIgLyAxMDQ4NTc2MCAtIDEwOTcgKiBkMiAqIGUxMiAvIDY1NTM2KSAqIHNpbjhEICsgKDgwMTEgKiBlMTAgLyAyNjIxNDQwICsgODAxMSAqIGUxMiAvIDEwNDg1NzYpICogc2luMTBEICsgMjkzMzkzICogZTEyIC8gMjUxNjU4MjQwICogc2luMTJEOwogIH0KICBmdW5jdGlvbiBjYWxjdWxhdGVTaWdtYShlbGxpcHRpY2l0eSwgbGF0aXR1ZGUpIHsKICAgIGlmIChlbGxpcHRpY2l0eSA9PT0gMCkgewogICAgICByZXR1cm4gTWF0aC5sb2coTWF0aC50YW4oMC41ICogKE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyArIGxhdGl0dWRlKSkpOwogICAgfQogICAgY29uc3QgZVNpbkwgPSBlbGxpcHRpY2l0eSAqIE1hdGguc2luKGxhdGl0dWRlKTsKICAgIHJldHVybiBNYXRoLmxvZyhNYXRoLnRhbigwLjUgKiAoTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPICsgbGF0aXR1ZGUpKSkgLSBlbGxpcHRpY2l0eSAvIDIgKiBNYXRoLmxvZygoMSArIGVTaW5MKSAvICgxIC0gZVNpbkwpKTsKICB9CiAgZnVuY3Rpb24gY2FsY3VsYXRlSGVhZGluZyhlbGxpcHNvaWRSaHVtYkxpbmUsIGZpcnN0TG9uZ2l0dWRlLCBmaXJzdExhdGl0dWRlLCBzZWNvbmRMb25naXR1ZGUsIHNlY29uZExhdGl0dWRlKSB7CiAgICBjb25zdCBzaWdtYTEgPSBjYWxjdWxhdGVTaWdtYShlbGxpcHNvaWRSaHVtYkxpbmUuX2VsbGlwdGljaXR5LCBmaXJzdExhdGl0dWRlKTsKICAgIGNvbnN0IHNpZ21hMiA9IGNhbGN1bGF0ZVNpZ21hKAogICAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX2VsbGlwdGljaXR5LAogICAgICBzZWNvbmRMYXRpdHVkZQogICAgKTsKICAgIHJldHVybiBNYXRoLmF0YW4yKAogICAgICBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoc2Vjb25kTG9uZ2l0dWRlIC0gZmlyc3RMb25naXR1ZGUpLAogICAgICBzaWdtYTIgLSBzaWdtYTEKICAgICk7CiAgfQogIGZ1bmN0aW9uIGNhbGN1bGF0ZUFyY0xlbmd0aChlbGxpcHNvaWRSaHVtYkxpbmUsIG1ham9yLCBtaW5vciwgZmlyc3RMb25naXR1ZGUsIGZpcnN0TGF0aXR1ZGUsIHNlY29uZExvbmdpdHVkZSwgc2Vjb25kTGF0aXR1ZGUpIHsKICAgIGNvbnN0IGhlYWRpbmcgPSBlbGxpcHNvaWRSaHVtYkxpbmUuX2hlYWRpbmc7CiAgICBjb25zdCBkZWx0YUxvbmdpdHVkZSA9IHNlY29uZExvbmdpdHVkZSAtIGZpcnN0TG9uZ2l0dWRlOwogICAgbGV0IGRpc3RhbmNlID0gMDsKICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgTWF0aC5hYnMoaGVhZGluZyksCiAgICAgIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTywKICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT044CiAgICApKSB7CiAgICAgIGlmIChtYWpvciA9PT0gbWlub3IpIHsKICAgICAgICBkaXN0YW5jZSA9IG1ham9yICogTWF0aC5jb3MoZmlyc3RMYXRpdHVkZSkgKiBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoZGVsdGFMb25naXR1ZGUpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHNpblBoaSA9IE1hdGguc2luKGZpcnN0TGF0aXR1ZGUpOwogICAgICAgIGRpc3RhbmNlID0gbWFqb3IgKiBNYXRoLmNvcyhmaXJzdExhdGl0dWRlKSAqIE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShkZWx0YUxvbmdpdHVkZSkgLyBNYXRoLnNxcnQoMSAtIGVsbGlwc29pZFJodW1iTGluZS5fZWxsaXB0aWNpdHlTcXVhcmVkICogc2luUGhpICogc2luUGhpKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgTTEgPSBjYWxjdWxhdGVNKAogICAgICAgIGVsbGlwc29pZFJodW1iTGluZS5fZWxsaXB0aWNpdHksCiAgICAgICAgbWFqb3IsCiAgICAgICAgZmlyc3RMYXRpdHVkZQogICAgICApOwogICAgICBjb25zdCBNMiA9IGNhbGN1bGF0ZU0oCiAgICAgICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9lbGxpcHRpY2l0eSwKICAgICAgICBtYWpvciwKICAgICAgICBzZWNvbmRMYXRpdHVkZQogICAgICApOwogICAgICBkaXN0YW5jZSA9IChNMiAtIE0xKSAvIE1hdGguY29zKGhlYWRpbmcpOwogICAgfQogICAgcmV0dXJuIE1hdGguYWJzKGRpc3RhbmNlKTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVByb3BlcnRpZXMoZWxsaXBzb2lkUmh1bWJMaW5lLCBzdGFydCwgZW5kLCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IGZpcnN0Q2FydGVzaWFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKHN0YXJ0LCBzY3JhdGNoQ2FydDIpLAogICAgICBzY3JhdGNoQ2FydDEKICAgICk7CiAgICBjb25zdCBsYXN0Q2FydGVzaWFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGVuZCwgc2NyYXRjaENhcnQyKSwKICAgICAgc2NyYXRjaENhcnQyCiAgICApOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoCiAgICAgICJ2YWx1ZSIsCiAgICAgIE1hdGguYWJzKAogICAgICAgIE1hdGguYWJzKENhcnRlc2lhbjNfZGVmYXVsdC5hbmdsZUJldHdlZW4oZmlyc3RDYXJ0ZXNpYW4sIGxhc3RDYXJ0ZXNpYW4pKSAtIE1hdGguUEkKICAgICAgKSwKICAgICAgMC4wMTI1CiAgICApOwogICAgY29uc3QgbWFqb3IgPSBlbGxpcHNvaWQubWF4aW11bVJhZGl1czsKICAgIGNvbnN0IG1pbm9yID0gZWxsaXBzb2lkLm1pbmltdW1SYWRpdXM7CiAgICBjb25zdCBtYWpvclNxdWFyZWQgPSBtYWpvciAqIG1ham9yOwogICAgY29uc3QgbWlub3JTcXVhcmVkID0gbWlub3IgKiBtaW5vcjsKICAgIGVsbGlwc29pZFJodW1iTGluZS5fZWxsaXB0aWNpdHlTcXVhcmVkID0gKG1ham9yU3F1YXJlZCAtIG1pbm9yU3F1YXJlZCkgLyBtYWpvclNxdWFyZWQ7CiAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX2VsbGlwdGljaXR5ID0gTWF0aC5zcXJ0KAogICAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX2VsbGlwdGljaXR5U3F1YXJlZAogICAgKTsKICAgIGVsbGlwc29pZFJodW1iTGluZS5fc3RhcnQgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZSgKICAgICAgc3RhcnQsCiAgICAgIGVsbGlwc29pZFJodW1iTGluZS5fc3RhcnQKICAgICk7CiAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX3N0YXJ0LmhlaWdodCA9IDA7CiAgICBlbGxpcHNvaWRSaHVtYkxpbmUuX2VuZCA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKGVuZCwgZWxsaXBzb2lkUmh1bWJMaW5lLl9lbmQpOwogICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9lbmQuaGVpZ2h0ID0gMDsKICAgIGVsbGlwc29pZFJodW1iTGluZS5faGVhZGluZyA9IGNhbGN1bGF0ZUhlYWRpbmcoCiAgICAgIGVsbGlwc29pZFJodW1iTGluZSwKICAgICAgc3RhcnQubG9uZ2l0dWRlLAogICAgICBzdGFydC5sYXRpdHVkZSwKICAgICAgZW5kLmxvbmdpdHVkZSwKICAgICAgZW5kLmxhdGl0dWRlCiAgICApOwogICAgZWxsaXBzb2lkUmh1bWJMaW5lLl9kaXN0YW5jZSA9IGNhbGN1bGF0ZUFyY0xlbmd0aCgKICAgICAgZWxsaXBzb2lkUmh1bWJMaW5lLAogICAgICBlbGxpcHNvaWQubWF4aW11bVJhZGl1cywKICAgICAgZWxsaXBzb2lkLm1pbmltdW1SYWRpdXMsCiAgICAgIHN0YXJ0LmxvbmdpdHVkZSwKICAgICAgc3RhcnQubGF0aXR1ZGUsCiAgICAgIGVuZC5sb25naXR1ZGUsCiAgICAgIGVuZC5sYXRpdHVkZQogICAgKTsKICB9CiAgZnVuY3Rpb24gaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZShzdGFydCwgaGVhZGluZywgZGlzdGFuY2UsIG1ham9yLCBlbGxpcHRpY2l0eSwgcmVzdWx0KSB7CiAgICBpZiAoZGlzdGFuY2UgPT09IDApIHsKICAgICAgcmV0dXJuIENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKHN0YXJ0LCByZXN1bHQpOwogICAgfQogICAgY29uc3QgZWxsaXB0aWNpdHlTcXVhcmVkID0gZWxsaXB0aWNpdHkgKiBlbGxpcHRpY2l0eTsKICAgIGxldCBsb25naXR1ZGU7CiAgICBsZXQgbGF0aXR1ZGU7CiAgICBsZXQgZGVsdGFMb25naXR1ZGU7CiAgICBpZiAoTWF0aC5hYnMoTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gTWF0aC5hYnMoaGVhZGluZykpID4gTWF0aF9kZWZhdWx0LkVQU0lMT044KSB7CiAgICAgIGNvbnN0IE0xID0gY2FsY3VsYXRlTShlbGxpcHRpY2l0eSwgbWFqb3IsIHN0YXJ0LmxhdGl0dWRlKTsKICAgICAgY29uc3QgZGVsdGFNID0gZGlzdGFuY2UgKiBNYXRoLmNvcyhoZWFkaW5nKTsKICAgICAgY29uc3QgTTIgPSBNMSArIGRlbHRhTTsKICAgICAgbGF0aXR1ZGUgPSBjYWxjdWxhdGVJbnZlcnNlTShNMiwgZWxsaXB0aWNpdHksIG1ham9yKTsKICAgICAgaWYgKE1hdGguYWJzKGhlYWRpbmcpIDwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkgewogICAgICAgIGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShzdGFydC5sb25naXR1ZGUpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHNpZ21hMSA9IGNhbGN1bGF0ZVNpZ21hKGVsbGlwdGljaXR5LCBzdGFydC5sYXRpdHVkZSk7CiAgICAgICAgY29uc3Qgc2lnbWEyID0gY2FsY3VsYXRlU2lnbWEoZWxsaXB0aWNpdHksIGxhdGl0dWRlKTsKICAgICAgICBkZWx0YUxvbmdpdHVkZSA9IE1hdGgudGFuKGhlYWRpbmcpICogKHNpZ21hMiAtIHNpZ21hMSk7CiAgICAgICAgbG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKHN0YXJ0LmxvbmdpdHVkZSArIGRlbHRhTG9uZ2l0dWRlKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgbGF0aXR1ZGUgPSBzdGFydC5sYXRpdHVkZTsKICAgICAgbGV0IGxvY2FsUmFkOwogICAgICBpZiAoZWxsaXB0aWNpdHkgPT09IDApIHsKICAgICAgICBsb2NhbFJhZCA9IG1ham9yICogTWF0aC5jb3Moc3RhcnQubGF0aXR1ZGUpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHNpblBoaSA9IE1hdGguc2luKHN0YXJ0LmxhdGl0dWRlKTsKICAgICAgICBsb2NhbFJhZCA9IG1ham9yICogTWF0aC5jb3Moc3RhcnQubGF0aXR1ZGUpIC8gTWF0aC5zcXJ0KDEgLSBlbGxpcHRpY2l0eVNxdWFyZWQgKiBzaW5QaGkgKiBzaW5QaGkpOwogICAgICB9CiAgICAgIGRlbHRhTG9uZ2l0dWRlID0gZGlzdGFuY2UgLyBsb2NhbFJhZDsKICAgICAgaWYgKGhlYWRpbmcgPiAwKSB7CiAgICAgICAgbG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0Lm5lZ2F0aXZlUGlUb1BpKHN0YXJ0LmxvbmdpdHVkZSArIGRlbHRhTG9uZ2l0dWRlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsb25naXR1ZGUgPSBNYXRoX2RlZmF1bHQubmVnYXRpdmVQaVRvUGkoc3RhcnQubG9uZ2l0dWRlIC0gZGVsdGFMb25naXR1ZGUpOwogICAgICB9CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IGxvbmdpdHVkZTsKICAgICAgcmVzdWx0LmxhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChsb25naXR1ZGUsIGxhdGl0dWRlLCAwKTsKICB9CiAgZnVuY3Rpb24gRWxsaXBzb2lkUmh1bWJMaW5lKHN0YXJ0LCBlbmQsIGVsbGlwc29pZCkgewogICAgY29uc3QgZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgdGhpcy5fZWxsaXBzb2lkID0gZTsKICAgIHRoaXMuX3N0YXJ0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICB0aGlzLl9lbmQgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgIHRoaXMuX2hlYWRpbmcgPSB2b2lkIDA7CiAgICB0aGlzLl9kaXN0YW5jZSA9IHZvaWQgMDsKICAgIHRoaXMuX2VsbGlwdGljaXR5ID0gdm9pZCAwOwogICAgdGhpcy5fZWxsaXB0aWNpdHlTcXVhcmVkID0gdm9pZCAwOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChzdGFydCkgJiYgZGVmaW5lZF9kZWZhdWx0KGVuZCkpIHsKICAgICAgY29tcHV0ZVByb3BlcnRpZXModGhpcywgc3RhcnQsIGVuZCwgZSk7CiAgICB9CiAgfQogIHZhciBzY3JhdGNoQ2FydDEsIHNjcmF0Y2hDYXJ0MiwgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQ7CiAgdmFyIGluaXRfRWxsaXBzb2lkUmh1bWJMaW5lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRSaHVtYkxpbmUuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgc2NyYXRjaENhcnQxID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKEVsbGlwc29pZFJodW1iTGluZS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBlbGxpcHNvaWQuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFJodW1iTGluZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7RWxsaXBzb2lkfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGVsbGlwc29pZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsbGlwc29pZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHN1cmZhY2UgZGlzdGFuY2UgYmV0d2VlbiB0aGUgc3RhcnQgYW5kIGVuZCBwb2ludAogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBzdXJmYWNlRGlzdGFuY2U6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGlzdGFuY2UiLCB0aGlzLl9kaXN0YW5jZSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kaXN0YW5jZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGluaXRpYWwgcGxhbmV0b2RldGljIHBvaW50IG9uIHRoZSBwYXRoLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0NhcnRvZ3JhcGhpY30KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBzdGFydDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXJ0OwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgZmluYWwgcGxhbmV0b2RldGljIHBvaW50IG9uIHRoZSBwYXRoLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0NhcnRvZ3JhcGhpY30KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbmQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbmQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBoZWFkaW5nIGZyb20gdGhlIHN0YXJ0IHBvaW50IHRvIHRoZSBlbmQgcG9pbnQuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZFJodW1iTGluZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGhlYWRpbmc6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGlzdGFuY2UiLCB0aGlzLl9kaXN0YW5jZSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9oZWFkaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIEVsbGlwc29pZFJodW1iTGluZS5mcm9tU3RhcnRIZWFkaW5nRGlzdGFuY2UgPSBmdW5jdGlvbihzdGFydCwgaGVhZGluZywgZGlzdGFuY2UsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJzdGFydCIsIHN0YXJ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImhlYWRpbmciLCBoZWFkaW5nKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRpc3RhbmNlIiwgZGlzdGFuY2UpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbigiZGlzdGFuY2UiLCBkaXN0YW5jZSwgMCk7CiAgICAgICAgY29uc3QgZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGNvbnN0IG1ham9yID0gZS5tYXhpbXVtUmFkaXVzOwogICAgICAgIGNvbnN0IG1pbm9yID0gZS5taW5pbXVtUmFkaXVzOwogICAgICAgIGNvbnN0IG1ham9yU3F1YXJlZCA9IG1ham9yICogbWFqb3I7CiAgICAgICAgY29uc3QgbWlub3JTcXVhcmVkID0gbWlub3IgKiBtaW5vcjsKICAgICAgICBjb25zdCBlbGxpcHRpY2l0eSA9IE1hdGguc3FydCgobWFqb3JTcXVhcmVkIC0gbWlub3JTcXVhcmVkKSAvIG1ham9yU3F1YXJlZCk7CiAgICAgICAgaGVhZGluZyA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShoZWFkaW5nKTsKICAgICAgICBjb25zdCBlbmQgPSBpbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlKAogICAgICAgICAgc3RhcnQsCiAgICAgICAgICBoZWFkaW5nLAogICAgICAgICAgZGlzdGFuY2UsCiAgICAgICAgICBlLm1heGltdW1SYWRpdXMsCiAgICAgICAgICBlbGxpcHRpY2l0eQogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSB8fCBkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkKSAmJiAhZWxsaXBzb2lkLmVxdWFscyhyZXN1bHQuZWxsaXBzb2lkKSkgewogICAgICAgICAgcmV0dXJuIG5ldyBFbGxpcHNvaWRSaHVtYkxpbmUoc3RhcnQsIGVuZCwgZSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5zZXRFbmRQb2ludHMoc3RhcnQsIGVuZCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZS5zZXRFbmRQb2ludHMgPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJzdGFydCIsIHN0YXJ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImVuZCIsIGVuZCk7CiAgICAgICAgY29tcHV0ZVByb3BlcnRpZXModGhpcywgc3RhcnQsIGVuZCwgdGhpcy5fZWxsaXBzb2lkKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZS5pbnRlcnBvbGF0ZVVzaW5nRnJhY3Rpb24gPSBmdW5jdGlvbihmcmFjdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSgKICAgICAgICAgIGZyYWN0aW9uICogdGhpcy5fZGlzdGFuY2UsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWRSaHVtYkxpbmUucHJvdG90eXBlLmludGVycG9sYXRlVXNpbmdTdXJmYWNlRGlzdGFuY2UgPSBmdW5jdGlvbihkaXN0YW5jZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJkaXN0YW5jZSIsIGRpc3RhbmNlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9kaXN0YW5jZSkgfHwgdGhpcy5fZGlzdGFuY2UgPT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiRWxsaXBzb2lkUmh1bWJMaW5lIG11c3QgaGF2ZSBkaXN0aW5jdCBzdGFydCBhbmQgZW5kIHNldC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSgKICAgICAgICAgIHRoaXMuX3N0YXJ0LAogICAgICAgICAgdGhpcy5faGVhZGluZywKICAgICAgICAgIGRpc3RhbmNlLAogICAgICAgICAgdGhpcy5fZWxsaXBzb2lkLm1heGltdW1SYWRpdXMsCiAgICAgICAgICB0aGlzLl9lbGxpcHRpY2l0eSwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFJodW1iTGluZS5wcm90b3R5cGUuZmluZEludGVyc2VjdGlvbldpdGhMb25naXR1ZGUgPSBmdW5jdGlvbihpbnRlcnNlY3Rpb25Mb25naXR1ZGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiaW50ZXJzZWN0aW9uTG9uZ2l0dWRlIiwgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl9kaXN0YW5jZSkgfHwgdGhpcy5fZGlzdGFuY2UgPT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiRWxsaXBzb2lkUmh1bWJMaW5lIG11c3QgaGF2ZSBkaXN0aW5jdCBzdGFydCBhbmQgZW5kIHNldC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHRpY2l0eSA9IHRoaXMuX2VsbGlwdGljaXR5OwogICAgICAgIGNvbnN0IGhlYWRpbmcgPSB0aGlzLl9oZWFkaW5nOwogICAgICAgIGNvbnN0IGFic0hlYWRpbmcgPSBNYXRoLmFicyhoZWFkaW5nKTsKICAgICAgICBjb25zdCBzdGFydCA9IHRoaXMuX3N0YXJ0OwogICAgICAgIGludGVyc2VjdGlvbkxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShpbnRlcnNlY3Rpb25Mb25naXR1ZGUpOwogICAgICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIE1hdGguYWJzKGludGVyc2VjdGlvbkxvbmdpdHVkZSksCiAgICAgICAgICBNYXRoLlBJLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xNAogICAgICAgICkpIHsKICAgICAgICAgIGludGVyc2VjdGlvbkxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5zaWduKHN0YXJ0LmxvbmdpdHVkZSkgKiBNYXRoLlBJOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKE1hdGguYWJzKE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyAtIGFic0hlYWRpbmcpIDw9IE1hdGhfZGVmYXVsdC5FUFNJTE9OOCkgewogICAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IGludGVyc2VjdGlvbkxvbmdpdHVkZTsKICAgICAgICAgIHJlc3VsdC5sYXRpdHVkZSA9IHN0YXJ0LmxhdGl0dWRlOwogICAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0gZWxzZSBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBNYXRoLmFicyhNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLSBhYnNIZWFkaW5nKSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTywKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OOAogICAgICAgICkpIHsKICAgICAgICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgICAgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlLAogICAgICAgICAgICBzdGFydC5sb25naXR1ZGUsCiAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTIKICAgICAgICAgICkpIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC5sb25naXR1ZGUgPSBpbnRlcnNlY3Rpb25Mb25naXR1ZGU7CiAgICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gKiBNYXRoX2RlZmF1bHQuc2lnbihNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLSBoZWFkaW5nKTsKICAgICAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGhpMSA9IHN0YXJ0LmxhdGl0dWRlOwogICAgICAgIGNvbnN0IGVTaW5QaGkxID0gZWxsaXB0aWNpdHkgKiBNYXRoLnNpbihwaGkxKTsKICAgICAgICBjb25zdCBsZWZ0Q29tcG9uZW50ID0gTWF0aC50YW4oMC41ICogKE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyArIHBoaTEpKSAqIE1hdGguZXhwKChpbnRlcnNlY3Rpb25Mb25naXR1ZGUgLSBzdGFydC5sb25naXR1ZGUpIC8gTWF0aC50YW4oaGVhZGluZykpOwogICAgICAgIGNvbnN0IGRlbm9taW5hdG9yID0gKDEgKyBlU2luUGhpMSkgLyAoMSAtIGVTaW5QaGkxKTsKICAgICAgICBsZXQgbmV3UGhpID0gc3RhcnQubGF0aXR1ZGU7CiAgICAgICAgbGV0IHBoaTsKICAgICAgICBkbyB7CiAgICAgICAgICBwaGkgPSBuZXdQaGk7CiAgICAgICAgICBjb25zdCBlU2luUGhpID0gZWxsaXB0aWNpdHkgKiBNYXRoLnNpbihwaGkpOwogICAgICAgICAgY29uc3QgbnVtZXJhdG9yID0gKDEgKyBlU2luUGhpKSAvICgxIC0gZVNpblBoaSk7CiAgICAgICAgICBuZXdQaGkgPSAyICogTWF0aC5hdGFuKAogICAgICAgICAgICBsZWZ0Q29tcG9uZW50ICogTWF0aC5wb3cobnVtZXJhdG9yIC8gZGVub21pbmF0b3IsIGVsbGlwdGljaXR5IC8gMikKICAgICAgICAgICkgLSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV087CiAgICAgICAgfSB3aGlsZSAoIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKG5ld1BoaSwgcGhpLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEyKSk7CiAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IGludGVyc2VjdGlvbkxvbmdpdHVkZTsKICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBuZXdQaGk7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkUmh1bWJMaW5lLnByb3RvdHlwZS5maW5kSW50ZXJzZWN0aW9uV2l0aExhdGl0dWRlID0gZnVuY3Rpb24oaW50ZXJzZWN0aW9uTGF0aXR1ZGUsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigiaW50ZXJzZWN0aW9uTGF0aXR1ZGUiLCBpbnRlcnNlY3Rpb25MYXRpdHVkZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fZGlzdGFuY2UpIHx8IHRoaXMuX2Rpc3RhbmNlID09PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIkVsbGlwc29pZFJodW1iTGluZSBtdXN0IGhhdmUgZGlzdGluY3Qgc3RhcnQgYW5kIGVuZCBzZXQuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXB0aWNpdHkgPSB0aGlzLl9lbGxpcHRpY2l0eTsKICAgICAgICBjb25zdCBoZWFkaW5nID0gdGhpcy5faGVhZGluZzsKICAgICAgICBjb25zdCBzdGFydCA9IHRoaXMuX3N0YXJ0OwogICAgICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIE1hdGguYWJzKGhlYWRpbmcpLAogICAgICAgICAgTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT044CiAgICAgICAgKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBzaWdtYTEgPSBjYWxjdWxhdGVTaWdtYShlbGxpcHRpY2l0eSwgc3RhcnQubGF0aXR1ZGUpOwogICAgICAgIGNvbnN0IHNpZ21hMiA9IGNhbGN1bGF0ZVNpZ21hKGVsbGlwdGljaXR5LCBpbnRlcnNlY3Rpb25MYXRpdHVkZSk7CiAgICAgICAgY29uc3QgZGVsdGFMb25naXR1ZGUgPSBNYXRoLnRhbihoZWFkaW5nKSAqIChzaWdtYTIgLSBzaWdtYTEpOwogICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IE1hdGhfZGVmYXVsdC5uZWdhdGl2ZVBpVG9QaShzdGFydC5sb25naXR1ZGUgKyBkZWx0YUxvbmdpdHVkZSk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQubG9uZ2l0dWRlID0gbG9uZ2l0dWRlOwogICAgICAgICAgcmVzdWx0LmxhdGl0dWRlID0gaW50ZXJzZWN0aW9uTGF0aXR1ZGU7CiAgICAgICAgICByZXN1bHQuaGVpZ2h0ID0gMDsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQobG9uZ2l0dWRlLCBpbnRlcnNlY3Rpb25MYXRpdHVkZSwgMCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0ID0gRWxsaXBzb2lkUmh1bWJMaW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvbkhpZXJhcmNoeS5qcwogIGZ1bmN0aW9uIFBvbHlnb25IaWVyYXJjaHkocG9zaXRpb25zLCBob2xlcykgewogICAgdGhpcy5wb3NpdGlvbnMgPSBkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSA/IHBvc2l0aW9ucyA6IFtdOwogICAgdGhpcy5ob2xlcyA9IGRlZmluZWRfZGVmYXVsdChob2xlcykgPyBob2xlcyA6IFtdOwogIH0KICB2YXIgUG9seWdvbkhpZXJhcmNoeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlnb25IaWVyYXJjaHkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlnb25IaWVyYXJjaHkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgUG9seWdvbkhpZXJhcmNoeV9kZWZhdWx0ID0gUG9seWdvbkhpZXJhcmNoeTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL2VhcmN1dC9zcmMvZWFyY3V0LmpzCiAgdmFyIHJlcXVpcmVfZWFyY3V0ID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL2VhcmN1dC9zcmMvZWFyY3V0LmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBlYXJjdXQyOwogICAgICBtb2R1bGUuZXhwb3J0cy5kZWZhdWx0ID0gZWFyY3V0MjsKICAgICAgZnVuY3Rpb24gZWFyY3V0MihkYXRhLCBob2xlSW5kaWNlcywgZGltKSB7CiAgICAgICAgZGltID0gZGltIHx8IDI7CiAgICAgICAgdmFyIGhhc0hvbGVzID0gaG9sZUluZGljZXMgJiYgaG9sZUluZGljZXMubGVuZ3RoLCBvdXRlckxlbiA9IGhhc0hvbGVzID8gaG9sZUluZGljZXNbMF0gKiBkaW0gOiBkYXRhLmxlbmd0aCwgb3V0ZXJOb2RlID0gbGlua2VkTGlzdChkYXRhLCAwLCBvdXRlckxlbiwgZGltLCB0cnVlKSwgdHJpYW5nbGVzID0gW107CiAgICAgICAgaWYgKCFvdXRlck5vZGUgfHwgb3V0ZXJOb2RlLm5leHQgPT09IG91dGVyTm9kZS5wcmV2KSByZXR1cm4gdHJpYW5nbGVzOwogICAgICAgIHZhciBtaW5YLCBtaW5ZLCBtYXhYLCBtYXhZLCB4LCB5LCBpbnZTaXplOwogICAgICAgIGlmIChoYXNIb2xlcykgb3V0ZXJOb2RlID0gZWxpbWluYXRlSG9sZXMoZGF0YSwgaG9sZUluZGljZXMsIG91dGVyTm9kZSwgZGltKTsKICAgICAgICBpZiAoZGF0YS5sZW5ndGggPiA4MCAqIGRpbSkgewogICAgICAgICAgbWluWCA9IG1heFggPSBkYXRhWzBdOwogICAgICAgICAgbWluWSA9IG1heFkgPSBkYXRhWzFdOwogICAgICAgICAgZm9yICh2YXIgaSA9IGRpbTsgaSA8IG91dGVyTGVuOyBpICs9IGRpbSkgewogICAgICAgICAgICB4ID0gZGF0YVtpXTsKICAgICAgICAgICAgeSA9IGRhdGFbaSArIDFdOwogICAgICAgICAgICBpZiAoeCA8IG1pblgpIG1pblggPSB4OwogICAgICAgICAgICBpZiAoeSA8IG1pblkpIG1pblkgPSB5OwogICAgICAgICAgICBpZiAoeCA+IG1heFgpIG1heFggPSB4OwogICAgICAgICAgICBpZiAoeSA+IG1heFkpIG1heFkgPSB5OwogICAgICAgICAgfQogICAgICAgICAgaW52U2l6ZSA9IE1hdGgubWF4KG1heFggLSBtaW5YLCBtYXhZIC0gbWluWSk7CiAgICAgICAgICBpbnZTaXplID0gaW52U2l6ZSAhPT0gMCA/IDMyNzY3IC8gaW52U2l6ZSA6IDA7CiAgICAgICAgfQogICAgICAgIGVhcmN1dExpbmtlZChvdXRlck5vZGUsIHRyaWFuZ2xlcywgZGltLCBtaW5YLCBtaW5ZLCBpbnZTaXplLCAwKTsKICAgICAgICByZXR1cm4gdHJpYW5nbGVzOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGxpbmtlZExpc3QoZGF0YSwgc3RhcnQsIGVuZCwgZGltLCBjbG9ja3dpc2UpIHsKICAgICAgICB2YXIgaSwgbGFzdDsKICAgICAgICBpZiAoY2xvY2t3aXNlID09PSBzaWduZWRBcmVhKGRhdGEsIHN0YXJ0LCBlbmQsIGRpbSkgPiAwKSB7CiAgICAgICAgICBmb3IgKGkgPSBzdGFydDsgaSA8IGVuZDsgaSArPSBkaW0pIGxhc3QgPSBpbnNlcnROb2RlKGksIGRhdGFbaV0sIGRhdGFbaSArIDFdLCBsYXN0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChpID0gZW5kIC0gZGltOyBpID49IHN0YXJ0OyBpIC09IGRpbSkgbGFzdCA9IGluc2VydE5vZGUoaSwgZGF0YVtpXSwgZGF0YVtpICsgMV0sIGxhc3QpOwogICAgICAgIH0KICAgICAgICBpZiAobGFzdCAmJiBlcXVhbHMobGFzdCwgbGFzdC5uZXh0KSkgewogICAgICAgICAgcmVtb3ZlTm9kZShsYXN0KTsKICAgICAgICAgIGxhc3QgPSBsYXN0Lm5leHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBsYXN0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGZpbHRlclBvaW50cyhzdGFydCwgZW5kKSB7CiAgICAgICAgaWYgKCFzdGFydCkgcmV0dXJuIHN0YXJ0OwogICAgICAgIGlmICghZW5kKSBlbmQgPSBzdGFydDsKICAgICAgICB2YXIgcCA9IHN0YXJ0LCBhZ2FpbjsKICAgICAgICBkbyB7CiAgICAgICAgICBhZ2FpbiA9IGZhbHNlOwogICAgICAgICAgaWYgKCFwLnN0ZWluZXIgJiYgKGVxdWFscyhwLCBwLm5leHQpIHx8IGFyZWEocC5wcmV2LCBwLCBwLm5leHQpID09PSAwKSkgewogICAgICAgICAgICByZW1vdmVOb2RlKHApOwogICAgICAgICAgICBwID0gZW5kID0gcC5wcmV2OwogICAgICAgICAgICBpZiAocCA9PT0gcC5uZXh0KSBicmVhazsKICAgICAgICAgICAgYWdhaW4gPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcCA9IHAubmV4dDsKICAgICAgICAgIH0KICAgICAgICB9IHdoaWxlIChhZ2FpbiB8fCBwICE9PSBlbmQpOwogICAgICAgIHJldHVybiBlbmQ7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZWFyY3V0TGlua2VkKGVhciwgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUsIHBhc3MpIHsKICAgICAgICBpZiAoIWVhcikgcmV0dXJuOwogICAgICAgIGlmICghcGFzcyAmJiBpbnZTaXplKSBpbmRleEN1cnZlKGVhciwgbWluWCwgbWluWSwgaW52U2l6ZSk7CiAgICAgICAgdmFyIHN0b3AgPSBlYXIsIHByZXYsIG5leHQ7CiAgICAgICAgd2hpbGUgKGVhci5wcmV2ICE9PSBlYXIubmV4dCkgewogICAgICAgICAgcHJldiA9IGVhci5wcmV2OwogICAgICAgICAgbmV4dCA9IGVhci5uZXh0OwogICAgICAgICAgaWYgKGludlNpemUgPyBpc0Vhckhhc2hlZChlYXIsIG1pblgsIG1pblksIGludlNpemUpIDogaXNFYXIoZWFyKSkgewogICAgICAgICAgICB0cmlhbmdsZXMucHVzaChwcmV2LmkgLyBkaW0gfCAwKTsKICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goZWFyLmkgLyBkaW0gfCAwKTsKICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2gobmV4dC5pIC8gZGltIHwgMCk7CiAgICAgICAgICAgIHJlbW92ZU5vZGUoZWFyKTsKICAgICAgICAgICAgZWFyID0gbmV4dC5uZXh0OwogICAgICAgICAgICBzdG9wID0gbmV4dC5uZXh0OwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGVhciA9IG5leHQ7CiAgICAgICAgICBpZiAoZWFyID09PSBzdG9wKSB7CiAgICAgICAgICAgIGlmICghcGFzcykgewogICAgICAgICAgICAgIGVhcmN1dExpbmtlZChmaWx0ZXJQb2ludHMoZWFyKSwgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUsIDEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHBhc3MgPT09IDEpIHsKICAgICAgICAgICAgICBlYXIgPSBjdXJlTG9jYWxJbnRlcnNlY3Rpb25zKGZpbHRlclBvaW50cyhlYXIpLCB0cmlhbmdsZXMsIGRpbSk7CiAgICAgICAgICAgICAgZWFyY3V0TGlua2VkKGVhciwgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUsIDIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHBhc3MgPT09IDIpIHsKICAgICAgICAgICAgICBzcGxpdEVhcmN1dChlYXIsIHRyaWFuZ2xlcywgZGltLCBtaW5YLCBtaW5ZLCBpbnZTaXplKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNFYXIoZWFyKSB7CiAgICAgICAgdmFyIGEzID0gZWFyLnByZXYsIGIgPSBlYXIsIGMgPSBlYXIubmV4dDsKICAgICAgICBpZiAoYXJlYShhMywgYiwgYykgPj0gMCkgcmV0dXJuIGZhbHNlOwogICAgICAgIHZhciBheCA9IGEzLngsIGJ4ID0gYi54LCBjeCA9IGMueCwgYXkgPSBhMy55LCBieSA9IGIueSwgY3kgPSBjLnk7CiAgICAgICAgdmFyIHgwID0gYXggPCBieCA/IGF4IDwgY3ggPyBheCA6IGN4IDogYnggPCBjeCA/IGJ4IDogY3gsIHkwID0gYXkgPCBieSA/IGF5IDwgY3kgPyBheSA6IGN5IDogYnkgPCBjeSA/IGJ5IDogY3ksIHgxID0gYXggPiBieCA/IGF4ID4gY3ggPyBheCA6IGN4IDogYnggPiBjeCA/IGJ4IDogY3gsIHkxID0gYXkgPiBieSA/IGF5ID4gY3kgPyBheSA6IGN5IDogYnkgPiBjeSA/IGJ5IDogY3k7CiAgICAgICAgdmFyIHAgPSBjLm5leHQ7CiAgICAgICAgd2hpbGUgKHAgIT09IGEzKSB7CiAgICAgICAgICBpZiAocC54ID49IHgwICYmIHAueCA8PSB4MSAmJiBwLnkgPj0geTAgJiYgcC55IDw9IHkxICYmIHBvaW50SW5UcmlhbmdsZShheCwgYXksIGJ4LCBieSwgY3gsIGN5LCBwLngsIHAueSkgJiYgYXJlYShwLnByZXYsIHAsIHAubmV4dCkgPj0gMCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgcCA9IHAubmV4dDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNFYXJIYXNoZWQoZWFyLCBtaW5YLCBtaW5ZLCBpbnZTaXplKSB7CiAgICAgICAgdmFyIGEzID0gZWFyLnByZXYsIGIgPSBlYXIsIGMgPSBlYXIubmV4dDsKICAgICAgICBpZiAoYXJlYShhMywgYiwgYykgPj0gMCkgcmV0dXJuIGZhbHNlOwogICAgICAgIHZhciBheCA9IGEzLngsIGJ4ID0gYi54LCBjeCA9IGMueCwgYXkgPSBhMy55LCBieSA9IGIueSwgY3kgPSBjLnk7CiAgICAgICAgdmFyIHgwID0gYXggPCBieCA/IGF4IDwgY3ggPyBheCA6IGN4IDogYnggPCBjeCA/IGJ4IDogY3gsIHkwID0gYXkgPCBieSA/IGF5IDwgY3kgPyBheSA6IGN5IDogYnkgPCBjeSA/IGJ5IDogY3ksIHgxID0gYXggPiBieCA/IGF4ID4gY3ggPyBheCA6IGN4IDogYnggPiBjeCA/IGJ4IDogY3gsIHkxID0gYXkgPiBieSA/IGF5ID4gY3kgPyBheSA6IGN5IDogYnkgPiBjeSA/IGJ5IDogY3k7CiAgICAgICAgdmFyIG1pblogPSB6T3JkZXIoeDAsIHkwLCBtaW5YLCBtaW5ZLCBpbnZTaXplKSwgbWF4WiA9IHpPcmRlcih4MSwgeTEsIG1pblgsIG1pblksIGludlNpemUpOwogICAgICAgIHZhciBwID0gZWFyLnByZXZaLCBuID0gZWFyLm5leHRaOwogICAgICAgIHdoaWxlIChwICYmIHAueiA+PSBtaW5aICYmIG4gJiYgbi56IDw9IG1heFopIHsKICAgICAgICAgIGlmIChwLnggPj0geDAgJiYgcC54IDw9IHgxICYmIHAueSA+PSB5MCAmJiBwLnkgPD0geTEgJiYgcCAhPT0gYTMgJiYgcCAhPT0gYyAmJiBwb2ludEluVHJpYW5nbGUoYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgcC54LCBwLnkpICYmIGFyZWEocC5wcmV2LCBwLCBwLm5leHQpID49IDApIHJldHVybiBmYWxzZTsKICAgICAgICAgIHAgPSBwLnByZXZaOwogICAgICAgICAgaWYgKG4ueCA+PSB4MCAmJiBuLnggPD0geDEgJiYgbi55ID49IHkwICYmIG4ueSA8PSB5MSAmJiBuICE9PSBhMyAmJiBuICE9PSBjICYmIHBvaW50SW5UcmlhbmdsZShheCwgYXksIGJ4LCBieSwgY3gsIGN5LCBuLngsIG4ueSkgJiYgYXJlYShuLnByZXYsIG4sIG4ubmV4dCkgPj0gMCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgbiA9IG4ubmV4dFo7CiAgICAgICAgfQogICAgICAgIHdoaWxlIChwICYmIHAueiA+PSBtaW5aKSB7CiAgICAgICAgICBpZiAocC54ID49IHgwICYmIHAueCA8PSB4MSAmJiBwLnkgPj0geTAgJiYgcC55IDw9IHkxICYmIHAgIT09IGEzICYmIHAgIT09IGMgJiYgcG9pbnRJblRyaWFuZ2xlKGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHAueCwgcC55KSAmJiBhcmVhKHAucHJldiwgcCwgcC5uZXh0KSA+PSAwKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICBwID0gcC5wcmV2WjsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKG4gJiYgbi56IDw9IG1heFopIHsKICAgICAgICAgIGlmIChuLnggPj0geDAgJiYgbi54IDw9IHgxICYmIG4ueSA+PSB5MCAmJiBuLnkgPD0geTEgJiYgbiAhPT0gYTMgJiYgbiAhPT0gYyAmJiBwb2ludEluVHJpYW5nbGUoYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgbi54LCBuLnkpICYmIGFyZWEobi5wcmV2LCBuLCBuLm5leHQpID49IDApIHJldHVybiBmYWxzZTsKICAgICAgICAgIG4gPSBuLm5leHRaOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBjdXJlTG9jYWxJbnRlcnNlY3Rpb25zKHN0YXJ0LCB0cmlhbmdsZXMsIGRpbSkgewogICAgICAgIHZhciBwID0gc3RhcnQ7CiAgICAgICAgZG8gewogICAgICAgICAgdmFyIGEzID0gcC5wcmV2LCBiID0gcC5uZXh0Lm5leHQ7CiAgICAgICAgICBpZiAoIWVxdWFscyhhMywgYikgJiYgaW50ZXJzZWN0cyhhMywgcCwgcC5uZXh0LCBiKSAmJiBsb2NhbGx5SW5zaWRlKGEzLCBiKSAmJiBsb2NhbGx5SW5zaWRlKGIsIGEzKSkgewogICAgICAgICAgICB0cmlhbmdsZXMucHVzaChhMy5pIC8gZGltIHwgMCk7CiAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKHAuaSAvIGRpbSB8IDApOwogICAgICAgICAgICB0cmlhbmdsZXMucHVzaChiLmkgLyBkaW0gfCAwKTsKICAgICAgICAgICAgcmVtb3ZlTm9kZShwKTsKICAgICAgICAgICAgcmVtb3ZlTm9kZShwLm5leHQpOwogICAgICAgICAgICBwID0gc3RhcnQgPSBiOwogICAgICAgICAgfQogICAgICAgICAgcCA9IHAubmV4dDsKICAgICAgICB9IHdoaWxlIChwICE9PSBzdGFydCk7CiAgICAgICAgcmV0dXJuIGZpbHRlclBvaW50cyhwKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBzcGxpdEVhcmN1dChzdGFydCwgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUpIHsKICAgICAgICB2YXIgYTMgPSBzdGFydDsKICAgICAgICBkbyB7CiAgICAgICAgICB2YXIgYiA9IGEzLm5leHQubmV4dDsKICAgICAgICAgIHdoaWxlIChiICE9PSBhMy5wcmV2KSB7CiAgICAgICAgICAgIGlmIChhMy5pICE9PSBiLmkgJiYgaXNWYWxpZERpYWdvbmFsKGEzLCBiKSkgewogICAgICAgICAgICAgIHZhciBjID0gc3BsaXRQb2x5Z29uKGEzLCBiKTsKICAgICAgICAgICAgICBhMyA9IGZpbHRlclBvaW50cyhhMywgYTMubmV4dCk7CiAgICAgICAgICAgICAgYyA9IGZpbHRlclBvaW50cyhjLCBjLm5leHQpOwogICAgICAgICAgICAgIGVhcmN1dExpbmtlZChhMywgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUsIDApOwogICAgICAgICAgICAgIGVhcmN1dExpbmtlZChjLCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSwgMCk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGIgPSBiLm5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBhMyA9IGEzLm5leHQ7CiAgICAgICAgfSB3aGlsZSAoYTMgIT09IHN0YXJ0KTsKICAgICAgfQogICAgICBmdW5jdGlvbiBlbGltaW5hdGVIb2xlcyhkYXRhLCBob2xlSW5kaWNlcywgb3V0ZXJOb2RlLCBkaW0pIHsKICAgICAgICB2YXIgcXVldWUgPSBbXSwgaSwgbGVuLCBzdGFydCwgZW5kLCBsaXN0OwogICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGhvbGVJbmRpY2VzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICBzdGFydCA9IGhvbGVJbmRpY2VzW2ldICogZGltOwogICAgICAgICAgZW5kID0gaSA8IGxlbiAtIDEgPyBob2xlSW5kaWNlc1tpICsgMV0gKiBkaW0gOiBkYXRhLmxlbmd0aDsKICAgICAgICAgIGxpc3QgPSBsaW5rZWRMaXN0KGRhdGEsIHN0YXJ0LCBlbmQsIGRpbSwgZmFsc2UpOwogICAgICAgICAgaWYgKGxpc3QgPT09IGxpc3QubmV4dCkgbGlzdC5zdGVpbmVyID0gdHJ1ZTsKICAgICAgICAgIHF1ZXVlLnB1c2goZ2V0TGVmdG1vc3QobGlzdCkpOwogICAgICAgIH0KICAgICAgICBxdWV1ZS5zb3J0KGNvbXBhcmVYKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG91dGVyTm9kZSA9IGVsaW1pbmF0ZUhvbGUocXVldWVbaV0sIG91dGVyTm9kZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvdXRlck5vZGU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY29tcGFyZVgoYTMsIGIpIHsKICAgICAgICByZXR1cm4gYTMueCAtIGIueDsKICAgICAgfQogICAgICBmdW5jdGlvbiBlbGltaW5hdGVIb2xlKGhvbGUsIG91dGVyTm9kZSkgewogICAgICAgIHZhciBicmlkZ2UgPSBmaW5kSG9sZUJyaWRnZShob2xlLCBvdXRlck5vZGUpOwogICAgICAgIGlmICghYnJpZGdlKSB7CiAgICAgICAgICByZXR1cm4gb3V0ZXJOb2RlOwogICAgICAgIH0KICAgICAgICB2YXIgYnJpZGdlUmV2ZXJzZSA9IHNwbGl0UG9seWdvbihicmlkZ2UsIGhvbGUpOwogICAgICAgIGZpbHRlclBvaW50cyhicmlkZ2VSZXZlcnNlLCBicmlkZ2VSZXZlcnNlLm5leHQpOwogICAgICAgIHJldHVybiBmaWx0ZXJQb2ludHMoYnJpZGdlLCBicmlkZ2UubmV4dCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZmluZEhvbGVCcmlkZ2UoaG9sZSwgb3V0ZXJOb2RlKSB7CiAgICAgICAgdmFyIHAgPSBvdXRlck5vZGUsIGh4ID0gaG9sZS54LCBoeSA9IGhvbGUueSwgcXggPSAtSW5maW5pdHksIG07CiAgICAgICAgZG8gewogICAgICAgICAgaWYgKGh5IDw9IHAueSAmJiBoeSA+PSBwLm5leHQueSAmJiBwLm5leHQueSAhPT0gcC55KSB7CiAgICAgICAgICAgIHZhciB4ID0gcC54ICsgKGh5IC0gcC55KSAqIChwLm5leHQueCAtIHAueCkgLyAocC5uZXh0LnkgLSBwLnkpOwogICAgICAgICAgICBpZiAoeCA8PSBoeCAmJiB4ID4gcXgpIHsKICAgICAgICAgICAgICBxeCA9IHg7CiAgICAgICAgICAgICAgbSA9IHAueCA8IHAubmV4dC54ID8gcCA6IHAubmV4dDsKICAgICAgICAgICAgICBpZiAoeCA9PT0gaHgpIHJldHVybiBtOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwID0gcC5uZXh0OwogICAgICAgIH0gd2hpbGUgKHAgIT09IG91dGVyTm9kZSk7CiAgICAgICAgaWYgKCFtKSByZXR1cm4gbnVsbDsKICAgICAgICB2YXIgc3RvcCA9IG0sIG14ID0gbS54LCBteSA9IG0ueSwgdGFuTWluID0gSW5maW5pdHksIHRhbjsKICAgICAgICBwID0gbTsKICAgICAgICBkbyB7CiAgICAgICAgICBpZiAoaHggPj0gcC54ICYmIHAueCA+PSBteCAmJiBoeCAhPT0gcC54ICYmIHBvaW50SW5UcmlhbmdsZShoeSA8IG15ID8gaHggOiBxeCwgaHksIG14LCBteSwgaHkgPCBteSA/IHF4IDogaHgsIGh5LCBwLngsIHAueSkpIHsKICAgICAgICAgICAgdGFuID0gTWF0aC5hYnMoaHkgLSBwLnkpIC8gKGh4IC0gcC54KTsKICAgICAgICAgICAgaWYgKGxvY2FsbHlJbnNpZGUocCwgaG9sZSkgJiYgKHRhbiA8IHRhbk1pbiB8fCB0YW4gPT09IHRhbk1pbiAmJiAocC54ID4gbS54IHx8IHAueCA9PT0gbS54ICYmIHNlY3RvckNvbnRhaW5zU2VjdG9yKG0sIHApKSkpIHsKICAgICAgICAgICAgICBtID0gcDsKICAgICAgICAgICAgICB0YW5NaW4gPSB0YW47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHAgPSBwLm5leHQ7CiAgICAgICAgfSB3aGlsZSAocCAhPT0gc3RvcCk7CiAgICAgICAgcmV0dXJuIG07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2VjdG9yQ29udGFpbnNTZWN0b3IobSwgcCkgewogICAgICAgIHJldHVybiBhcmVhKG0ucHJldiwgbSwgcC5wcmV2KSA8IDAgJiYgYXJlYShwLm5leHQsIG0sIG0ubmV4dCkgPCAwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGluZGV4Q3VydmUoc3RhcnQsIG1pblgsIG1pblksIGludlNpemUpIHsKICAgICAgICB2YXIgcCA9IHN0YXJ0OwogICAgICAgIGRvIHsKICAgICAgICAgIGlmIChwLnogPT09IDApIHAueiA9IHpPcmRlcihwLngsIHAueSwgbWluWCwgbWluWSwgaW52U2l6ZSk7CiAgICAgICAgICBwLnByZXZaID0gcC5wcmV2OwogICAgICAgICAgcC5uZXh0WiA9IHAubmV4dDsKICAgICAgICAgIHAgPSBwLm5leHQ7CiAgICAgICAgfSB3aGlsZSAocCAhPT0gc3RhcnQpOwogICAgICAgIHAucHJldloubmV4dFogPSBudWxsOwogICAgICAgIHAucHJldlogPSBudWxsOwogICAgICAgIHNvcnRMaW5rZWQocCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc29ydExpbmtlZChsaXN0KSB7CiAgICAgICAgdmFyIGksIHAsIHEsIGUsIHRhaWwsIG51bU1lcmdlcywgcFNpemUsIHFTaXplLCBpblNpemUgPSAxOwogICAgICAgIGRvIHsKICAgICAgICAgIHAgPSBsaXN0OwogICAgICAgICAgbGlzdCA9IG51bGw7CiAgICAgICAgICB0YWlsID0gbnVsbDsKICAgICAgICAgIG51bU1lcmdlcyA9IDA7CiAgICAgICAgICB3aGlsZSAocCkgewogICAgICAgICAgICBudW1NZXJnZXMrKzsKICAgICAgICAgICAgcSA9IHA7CiAgICAgICAgICAgIHBTaXplID0gMDsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGluU2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgcFNpemUrKzsKICAgICAgICAgICAgICBxID0gcS5uZXh0WjsKICAgICAgICAgICAgICBpZiAoIXEpIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHFTaXplID0gaW5TaXplOwogICAgICAgICAgICB3aGlsZSAocFNpemUgPiAwIHx8IHFTaXplID4gMCAmJiBxKSB7CiAgICAgICAgICAgICAgaWYgKHBTaXplICE9PSAwICYmIChxU2l6ZSA9PT0gMCB8fCAhcSB8fCBwLnogPD0gcS56KSkgewogICAgICAgICAgICAgICAgZSA9IHA7CiAgICAgICAgICAgICAgICBwID0gcC5uZXh0WjsKICAgICAgICAgICAgICAgIHBTaXplLS07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGUgPSBxOwogICAgICAgICAgICAgICAgcSA9IHEubmV4dFo7CiAgICAgICAgICAgICAgICBxU2l6ZS0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodGFpbCkgdGFpbC5uZXh0WiA9IGU7CiAgICAgICAgICAgICAgZWxzZSBsaXN0ID0gZTsKICAgICAgICAgICAgICBlLnByZXZaID0gdGFpbDsKICAgICAgICAgICAgICB0YWlsID0gZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwID0gcTsKICAgICAgICAgIH0KICAgICAgICAgIHRhaWwubmV4dFogPSBudWxsOwogICAgICAgICAgaW5TaXplICo9IDI7CiAgICAgICAgfSB3aGlsZSAobnVtTWVyZ2VzID4gMSk7CiAgICAgICAgcmV0dXJuIGxpc3Q7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gek9yZGVyKHgsIHksIG1pblgsIG1pblksIGludlNpemUpIHsKICAgICAgICB4ID0gKHggLSBtaW5YKSAqIGludlNpemUgfCAwOwogICAgICAgIHkgPSAoeSAtIG1pblkpICogaW52U2l6ZSB8IDA7CiAgICAgICAgeCA9ICh4IHwgeCA8PCA4KSAmIDE2NzExOTM1OwogICAgICAgIHggPSAoeCB8IHggPDwgNCkgJiAyNTI2NDUxMzU7CiAgICAgICAgeCA9ICh4IHwgeCA8PCAyKSAmIDg1ODk5MzQ1OTsKICAgICAgICB4ID0gKHggfCB4IDw8IDEpICYgMTQzMTY1NTc2NTsKICAgICAgICB5ID0gKHkgfCB5IDw8IDgpICYgMTY3MTE5MzU7CiAgICAgICAgeSA9ICh5IHwgeSA8PCA0KSAmIDI1MjY0NTEzNTsKICAgICAgICB5ID0gKHkgfCB5IDw8IDIpICYgODU4OTkzNDU5OwogICAgICAgIHkgPSAoeSB8IHkgPDwgMSkgJiAxNDMxNjU1NzY1OwogICAgICAgIHJldHVybiB4IHwgeSA8PCAxOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGdldExlZnRtb3N0KHN0YXJ0KSB7CiAgICAgICAgdmFyIHAgPSBzdGFydCwgbGVmdG1vc3QgPSBzdGFydDsKICAgICAgICBkbyB7CiAgICAgICAgICBpZiAocC54IDwgbGVmdG1vc3QueCB8fCBwLnggPT09IGxlZnRtb3N0LnggJiYgcC55IDwgbGVmdG1vc3QueSkgbGVmdG1vc3QgPSBwOwogICAgICAgICAgcCA9IHAubmV4dDsKICAgICAgICB9IHdoaWxlIChwICE9PSBzdGFydCk7CiAgICAgICAgcmV0dXJuIGxlZnRtb3N0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBvaW50SW5UcmlhbmdsZShheCwgYXksIGJ4LCBieSwgY3gsIGN5LCBweCwgcHkpIHsKICAgICAgICByZXR1cm4gKGN4IC0gcHgpICogKGF5IC0gcHkpID49IChheCAtIHB4KSAqIChjeSAtIHB5KSAmJiAoYXggLSBweCkgKiAoYnkgLSBweSkgPj0gKGJ4IC0gcHgpICogKGF5IC0gcHkpICYmIChieCAtIHB4KSAqIChjeSAtIHB5KSA+PSAoY3ggLSBweCkgKiAoYnkgLSBweSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNWYWxpZERpYWdvbmFsKGEzLCBiKSB7CiAgICAgICAgcmV0dXJuIGEzLm5leHQuaSAhPT0gYi5pICYmIGEzLnByZXYuaSAhPT0gYi5pICYmICFpbnRlcnNlY3RzUG9seWdvbihhMywgYikgJiYgLy8gZG9uZXMndCBpbnRlcnNlY3Qgb3RoZXIgZWRnZXMKICAgICAgICAobG9jYWxseUluc2lkZShhMywgYikgJiYgbG9jYWxseUluc2lkZShiLCBhMykgJiYgbWlkZGxlSW5zaWRlKGEzLCBiKSAmJiAvLyBsb2NhbGx5IHZpc2libGUKICAgICAgICAoYXJlYShhMy5wcmV2LCBhMywgYi5wcmV2KSB8fCBhcmVhKGEzLCBiLnByZXYsIGIpKSB8fCAvLyBkb2VzIG5vdCBjcmVhdGUgb3Bwb3NpdGUtZmFjaW5nIHNlY3RvcnMKICAgICAgICBlcXVhbHMoYTMsIGIpICYmIGFyZWEoYTMucHJldiwgYTMsIGEzLm5leHQpID4gMCAmJiBhcmVhKGIucHJldiwgYiwgYi5uZXh0KSA+IDApOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFyZWEocCwgcSwgcikgewogICAgICAgIHJldHVybiAocS55IC0gcC55KSAqIChyLnggLSBxLngpIC0gKHEueCAtIHAueCkgKiAoci55IC0gcS55KTsKICAgICAgfQogICAgICBmdW5jdGlvbiBlcXVhbHMocDEsIHAyKSB7CiAgICAgICAgcmV0dXJuIHAxLnggPT09IHAyLnggJiYgcDEueSA9PT0gcDIueTsKICAgICAgfQogICAgICBmdW5jdGlvbiBpbnRlcnNlY3RzKHAxLCBxMTIsIHAyLCBxMjIpIHsKICAgICAgICB2YXIgbzEgPSBzaWduMihhcmVhKHAxLCBxMTIsIHAyKSk7CiAgICAgICAgdmFyIG8yID0gc2lnbjIoYXJlYShwMSwgcTEyLCBxMjIpKTsKICAgICAgICB2YXIgbzMgPSBzaWduMihhcmVhKHAyLCBxMjIsIHAxKSk7CiAgICAgICAgdmFyIG80ID0gc2lnbjIoYXJlYShwMiwgcTIyLCBxMTIpKTsKICAgICAgICBpZiAobzEgIT09IG8yICYmIG8zICE9PSBvNCkgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKG8xID09PSAwICYmIG9uU2VnbWVudChwMSwgcDIsIHExMikpIHJldHVybiB0cnVlOwogICAgICAgIGlmIChvMiA9PT0gMCAmJiBvblNlZ21lbnQocDEsIHEyMiwgcTEyKSkgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKG8zID09PSAwICYmIG9uU2VnbWVudChwMiwgcDEsIHEyMikpIHJldHVybiB0cnVlOwogICAgICAgIGlmIChvNCA9PT0gMCAmJiBvblNlZ21lbnQocDIsIHExMiwgcTIyKSkgcmV0dXJuIHRydWU7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIG9uU2VnbWVudChwLCBxLCByKSB7CiAgICAgICAgcmV0dXJuIHEueCA8PSBNYXRoLm1heChwLngsIHIueCkgJiYgcS54ID49IE1hdGgubWluKHAueCwgci54KSAmJiBxLnkgPD0gTWF0aC5tYXgocC55LCByLnkpICYmIHEueSA+PSBNYXRoLm1pbihwLnksIHIueSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc2lnbjIobnVtKSB7CiAgICAgICAgcmV0dXJuIG51bSA+IDAgPyAxIDogbnVtIDwgMCA/IC0xIDogMDsKICAgICAgfQogICAgICBmdW5jdGlvbiBpbnRlcnNlY3RzUG9seWdvbihhMywgYikgewogICAgICAgIHZhciBwID0gYTM7CiAgICAgICAgZG8gewogICAgICAgICAgaWYgKHAuaSAhPT0gYTMuaSAmJiBwLm5leHQuaSAhPT0gYTMuaSAmJiBwLmkgIT09IGIuaSAmJiBwLm5leHQuaSAhPT0gYi5pICYmIGludGVyc2VjdHMocCwgcC5uZXh0LCBhMywgYikpIHJldHVybiB0cnVlOwogICAgICAgICAgcCA9IHAubmV4dDsKICAgICAgICB9IHdoaWxlIChwICE9PSBhMyk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGxvY2FsbHlJbnNpZGUoYTMsIGIpIHsKICAgICAgICByZXR1cm4gYXJlYShhMy5wcmV2LCBhMywgYTMubmV4dCkgPCAwID8gYXJlYShhMywgYiwgYTMubmV4dCkgPj0gMCAmJiBhcmVhKGEzLCBhMy5wcmV2LCBiKSA+PSAwIDogYXJlYShhMywgYiwgYTMucHJldikgPCAwIHx8IGFyZWEoYTMsIGEzLm5leHQsIGIpIDwgMDsKICAgICAgfQogICAgICBmdW5jdGlvbiBtaWRkbGVJbnNpZGUoYTMsIGIpIHsKICAgICAgICB2YXIgcCA9IGEzLCBpbnNpZGUgPSBmYWxzZSwgcHggPSAoYTMueCArIGIueCkgLyAyLCBweSA9IChhMy55ICsgYi55KSAvIDI7CiAgICAgICAgZG8gewogICAgICAgICAgaWYgKHAueSA+IHB5ICE9PSBwLm5leHQueSA+IHB5ICYmIHAubmV4dC55ICE9PSBwLnkgJiYgcHggPCAocC5uZXh0LnggLSBwLngpICogKHB5IC0gcC55KSAvIChwLm5leHQueSAtIHAueSkgKyBwLngpCiAgICAgICAgICAgIGluc2lkZSA9ICFpbnNpZGU7CiAgICAgICAgICBwID0gcC5uZXh0OwogICAgICAgIH0gd2hpbGUgKHAgIT09IGEzKTsKICAgICAgICByZXR1cm4gaW5zaWRlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNwbGl0UG9seWdvbihhMywgYikgewogICAgICAgIHZhciBhMjIgPSBuZXcgTm9kZShhMy5pLCBhMy54LCBhMy55KSwgYjIgPSBuZXcgTm9kZShiLmksIGIueCwgYi55KSwgYW4gPSBhMy5uZXh0LCBicCA9IGIucHJldjsKICAgICAgICBhMy5uZXh0ID0gYjsKICAgICAgICBiLnByZXYgPSBhMzsKICAgICAgICBhMjIubmV4dCA9IGFuOwogICAgICAgIGFuLnByZXYgPSBhMjI7CiAgICAgICAgYjIubmV4dCA9IGEyMjsKICAgICAgICBhMjIucHJldiA9IGIyOwogICAgICAgIGJwLm5leHQgPSBiMjsKICAgICAgICBiMi5wcmV2ID0gYnA7CiAgICAgICAgcmV0dXJuIGIyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGluc2VydE5vZGUoaSwgeCwgeSwgbGFzdCkgewogICAgICAgIHZhciBwID0gbmV3IE5vZGUoaSwgeCwgeSk7CiAgICAgICAgaWYgKCFsYXN0KSB7CiAgICAgICAgICBwLnByZXYgPSBwOwogICAgICAgICAgcC5uZXh0ID0gcDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcC5uZXh0ID0gbGFzdC5uZXh0OwogICAgICAgICAgcC5wcmV2ID0gbGFzdDsKICAgICAgICAgIGxhc3QubmV4dC5wcmV2ID0gcDsKICAgICAgICAgIGxhc3QubmV4dCA9IHA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJlbW92ZU5vZGUocCkgewogICAgICAgIHAubmV4dC5wcmV2ID0gcC5wcmV2OwogICAgICAgIHAucHJldi5uZXh0ID0gcC5uZXh0OwogICAgICAgIGlmIChwLnByZXZaKSBwLnByZXZaLm5leHRaID0gcC5uZXh0WjsKICAgICAgICBpZiAocC5uZXh0WikgcC5uZXh0Wi5wcmV2WiA9IHAucHJldlo7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gTm9kZShpLCB4LCB5KSB7CiAgICAgICAgdGhpcy5pID0gaTsKICAgICAgICB0aGlzLnggPSB4OwogICAgICAgIHRoaXMueSA9IHk7CiAgICAgICAgdGhpcy5wcmV2ID0gbnVsbDsKICAgICAgICB0aGlzLm5leHQgPSBudWxsOwogICAgICAgIHRoaXMueiA9IDA7CiAgICAgICAgdGhpcy5wcmV2WiA9IG51bGw7CiAgICAgICAgdGhpcy5uZXh0WiA9IG51bGw7CiAgICAgICAgdGhpcy5zdGVpbmVyID0gZmFsc2U7CiAgICAgIH0KICAgICAgZWFyY3V0Mi5kZXZpYXRpb24gPSBmdW5jdGlvbihkYXRhLCBob2xlSW5kaWNlcywgZGltLCB0cmlhbmdsZXMpIHsKICAgICAgICB2YXIgaGFzSG9sZXMgPSBob2xlSW5kaWNlcyAmJiBob2xlSW5kaWNlcy5sZW5ndGg7CiAgICAgICAgdmFyIG91dGVyTGVuID0gaGFzSG9sZXMgPyBob2xlSW5kaWNlc1swXSAqIGRpbSA6IGRhdGEubGVuZ3RoOwogICAgICAgIHZhciBwb2x5Z29uQXJlYSA9IE1hdGguYWJzKHNpZ25lZEFyZWEoZGF0YSwgMCwgb3V0ZXJMZW4sIGRpbSkpOwogICAgICAgIGlmIChoYXNIb2xlcykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGhvbGVJbmRpY2VzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IGhvbGVJbmRpY2VzW2ldICogZGltOwogICAgICAgICAgICB2YXIgZW5kID0gaSA8IGxlbiAtIDEgPyBob2xlSW5kaWNlc1tpICsgMV0gKiBkaW0gOiBkYXRhLmxlbmd0aDsKICAgICAgICAgICAgcG9seWdvbkFyZWEgLT0gTWF0aC5hYnMoc2lnbmVkQXJlYShkYXRhLCBzdGFydCwgZW5kLCBkaW0pKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHRyaWFuZ2xlc0FyZWEgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCB0cmlhbmdsZXMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIHZhciBhMyA9IHRyaWFuZ2xlc1tpXSAqIGRpbTsKICAgICAgICAgIHZhciBiID0gdHJpYW5nbGVzW2kgKyAxXSAqIGRpbTsKICAgICAgICAgIHZhciBjID0gdHJpYW5nbGVzW2kgKyAyXSAqIGRpbTsKICAgICAgICAgIHRyaWFuZ2xlc0FyZWEgKz0gTWF0aC5hYnMoCiAgICAgICAgICAgIChkYXRhW2EzXSAtIGRhdGFbY10pICogKGRhdGFbYiArIDFdIC0gZGF0YVthMyArIDFdKSAtIChkYXRhW2EzXSAtIGRhdGFbYl0pICogKGRhdGFbYyArIDFdIC0gZGF0YVthMyArIDFdKQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBvbHlnb25BcmVhID09PSAwICYmIHRyaWFuZ2xlc0FyZWEgPT09IDAgPyAwIDogTWF0aC5hYnMoKHRyaWFuZ2xlc0FyZWEgLSBwb2x5Z29uQXJlYSkgLyBwb2x5Z29uQXJlYSk7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIHNpZ25lZEFyZWEoZGF0YSwgc3RhcnQsIGVuZCwgZGltKSB7CiAgICAgICAgdmFyIHN1bSA9IDA7CiAgICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0LCBqID0gZW5kIC0gZGltOyBpIDwgZW5kOyBpICs9IGRpbSkgewogICAgICAgICAgc3VtICs9IChkYXRhW2pdIC0gZGF0YVtpXSkgKiAoZGF0YVtpICsgMV0gKyBkYXRhW2ogKyAxXSk7CiAgICAgICAgICBqID0gaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN1bTsKICAgICAgfQogICAgICBlYXJjdXQyLmZsYXR0ZW4gPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgdmFyIGRpbSA9IGRhdGFbMF1bMF0ubGVuZ3RoLCByZXN1bHQgPSB7IHZlcnRpY2VzOiBbXSwgaG9sZXM6IFtdLCBkaW1lbnNpb25zOiBkaW0gfSwgaG9sZUluZGV4ID0gMDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZGF0YVtpXS5sZW5ndGg7IGorKykgewogICAgICAgICAgICBmb3IgKHZhciBkID0gMDsgZCA8IGRpbTsgZCsrKSByZXN1bHQudmVydGljZXMucHVzaChkYXRhW2ldW2pdW2RdKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpID4gMCkgewogICAgICAgICAgICBob2xlSW5kZXggKz0gZGF0YVtpIC0gMV0ubGVuZ3RoOwogICAgICAgICAgICByZXN1bHQuaG9sZXMucHVzaChob2xlSW5kZXgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2luZGluZ09yZGVyLmpzCiAgdmFyIFdpbmRpbmdPcmRlciwgV2luZGluZ09yZGVyX2RlZmF1bHQ7CiAgdmFyIGluaXRfV2luZGluZ09yZGVyID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9XaW5kaW5nT3JkZXIuanMiKCkgewogICAgICBpbml0X1dlYkdMQ29uc3RhbnRzKCk7CiAgICAgIFdpbmRpbmdPcmRlciA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBWZXJ0aWNlcyBhcmUgaW4gY2xvY2t3aXNlIG9yZGVyLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBDTE9DS1dJU0U6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ1csCiAgICAgICAgLyoqCiAgICAgICAgICogVmVydGljZXMgYXJlIGluIGNvdW50ZXItY2xvY2t3aXNlIG9yZGVyLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBDT1VOVEVSX0NMT0NLV0lTRTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DQ1cKICAgICAgfTsKICAgICAgV2luZGluZ09yZGVyLnZhbGlkYXRlID0gZnVuY3Rpb24od2luZGluZ09yZGVyKSB7CiAgICAgICAgcmV0dXJuIHdpbmRpbmdPcmRlciA9PT0gV2luZGluZ09yZGVyLkNMT0NLV0lTRSB8fCB3aW5kaW5nT3JkZXIgPT09IFdpbmRpbmdPcmRlci5DT1VOVEVSX0NMT0NLV0lTRTsKICAgICAgfTsKICAgICAgV2luZGluZ09yZGVyX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKFdpbmRpbmdPcmRlcik7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5Z29uUGlwZWxpbmUuanMKICB2YXIgaW1wb3J0X2VhcmN1dCwgc2NhbGVUb0dlb2RldGljSGVpZ2h0Tiwgc2NhbGVUb0dlb2RldGljSGVpZ2h0UCwgUG9seWdvblBpcGVsaW5lLCBzdWJkaXZpc2lvblYwU2NyYXRjaCwgc3ViZGl2aXNpb25WMVNjcmF0Y2gsIHN1YmRpdmlzaW9uVjJTY3JhdGNoLCBzdWJkaXZpc2lvblMwU2NyYXRjaCwgc3ViZGl2aXNpb25TMVNjcmF0Y2gsIHN1YmRpdmlzaW9uUzJTY3JhdGNoLCBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gsIHN1YmRpdmlzaW9uVDBTY3JhdGNoLCBzdWJkaXZpc2lvblQxU2NyYXRjaCwgc3ViZGl2aXNpb25UMlNjcmF0Y2gsIHN1YmRpdmlzaW9uVGV4Y29vcmRNaWRTY3JhdGNoLCBzdWJkaXZpc2lvbkMwU2NyYXRjaCwgc3ViZGl2aXNpb25DMVNjcmF0Y2gsIHN1YmRpdmlzaW9uQzJTY3JhdGNoLCBzdWJkaXZpc2lvbkNhcnRvZ3JhcGhpY1NjcmF0Y2gsIFBvbHlnb25QaXBlbGluZV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlnb25QaXBlbGluZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvblBpcGVsaW5lLmpzIigpIHsKICAgICAgaW1wb3J0X2VhcmN1dCA9IF9fdG9FU00ocmVxdWlyZV9lYXJjdXQoKSwgMSk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZFJodW1iTGluZSgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1dpbmRpbmdPcmRlcigpOwogICAgICBzY2FsZVRvR2VvZGV0aWNIZWlnaHROID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY2FsZVRvR2VvZGV0aWNIZWlnaHRQID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBQb2x5Z29uUGlwZWxpbmUgPSB7fTsKICAgICAgUG9seWdvblBpcGVsaW5lLmNvbXB1dGVBcmVhMkQgPSBmdW5jdGlvbihwb3NpdGlvbnMpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoCiAgICAgICAgICAicG9zaXRpb25zLmxlbmd0aCIsCiAgICAgICAgICBwb3NpdGlvbnMubGVuZ3RoLAogICAgICAgICAgMwogICAgICAgICk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgYXJlYSA9IDA7CiAgICAgICAgZm9yIChsZXQgaTAgPSBsZW5ndGggLSAxLCBpMSA9IDA7IGkxIDwgbGVuZ3RoOyBpMCA9IGkxKyspIHsKICAgICAgICAgIGNvbnN0IHYwMiA9IHBvc2l0aW9uc1tpMF07CiAgICAgICAgICBjb25zdCB2MTIgPSBwb3NpdGlvbnNbaTFdOwogICAgICAgICAgYXJlYSArPSB2MDIueCAqIHYxMi55IC0gdjEyLnggKiB2MDIueTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFyZWEgKiAwLjU7CiAgICAgIH07CiAgICAgIFBvbHlnb25QaXBlbGluZS5jb21wdXRlV2luZGluZ09yZGVyMkQgPSBmdW5jdGlvbihwb3NpdGlvbnMpIHsKICAgICAgICBjb25zdCBhcmVhID0gUG9seWdvblBpcGVsaW5lLmNvbXB1dGVBcmVhMkQocG9zaXRpb25zKTsKICAgICAgICByZXR1cm4gYXJlYSA+IDAgPyBXaW5kaW5nT3JkZXJfZGVmYXVsdC5DT1VOVEVSX0NMT0NLV0lTRSA6IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNMT0NLV0lTRTsKICAgICAgfTsKICAgICAgUG9seWdvblBpcGVsaW5lLnRyaWFuZ3VsYXRlID0gZnVuY3Rpb24ocG9zaXRpb25zLCBob2xlcykgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgicG9zaXRpb25zIiwgcG9zaXRpb25zKTsKICAgICAgICBjb25zdCBmbGF0dGVuZWRQb3NpdGlvbnMgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFja0FycmF5KHBvc2l0aW9ucyk7CiAgICAgICAgcmV0dXJuICgwLCBpbXBvcnRfZWFyY3V0LmRlZmF1bHQpKGZsYXR0ZW5lZFBvc2l0aW9ucywgaG9sZXMsIDIpOwogICAgICB9OwogICAgICBzdWJkaXZpc2lvblYwU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25WMVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uVjJTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvblMwU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25TMVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uUzJTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvbk1pZFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uVDBTY3JhdGNoID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpc2lvblQxU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25UMlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHN1YmRpdmlzaW9uVGV4Y29vcmRNaWRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBQb2x5Z29uUGlwZWxpbmUuY29tcHV0ZVN1YmRpdmlzaW9uID0gZnVuY3Rpb24oZWxsaXBzb2lkLCBwb3NpdGlvbnMsIGluZGljZXMsIHRleGNvb3JkcywgZ3JhbnVsYXJpdHkpIHsKICAgICAgICBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGdyYW51bGFyaXR5LCBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFKTsKICAgICAgICBjb25zdCBoYXNUZXhjb29yZHMgPSBkZWZpbmVkX2RlZmF1bHQodGV4Y29vcmRzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImVsbGlwc29pZCIsIGVsbGlwc29pZCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiaW5kaWNlcyIsIGluZGljZXMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJpbmRpY2VzLmxlbmd0aCIsIGluZGljZXMubGVuZ3RoLCAzKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZXF1YWxzKCJpbmRpY2VzLmxlbmd0aCAlIDMiLCAiMCIsIGluZGljZXMubGVuZ3RoICUgMywgMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuKCJncmFudWxhcml0eSIsIGdyYW51bGFyaXR5LCAwKTsKICAgICAgICBjb25zdCB0cmlhbmdsZXMgPSBpbmRpY2VzLnNsaWNlKDApOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3Qgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGggKiAzKTsKICAgICAgICBjb25zdCBzdWJkaXZpZGVkVGV4Y29vcmRzID0gbmV3IEFycmF5KGxlbmd0aCAqIDIpOwogICAgICAgIGxldCBxID0gMDsKICAgICAgICBsZXQgcCA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBpdGVtID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1txKytdID0gaXRlbS54OwogICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1txKytdID0gaXRlbS55OwogICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1txKytdID0gaXRlbS56OwogICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICBjb25zdCB0ZXhjb29yZEl0ZW0gPSB0ZXhjb29yZHNbaV07CiAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHNbcCsrXSA9IHRleGNvb3JkSXRlbS54OwogICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzW3ArK10gPSB0ZXhjb29yZEl0ZW0ueTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3Qgc3ViZGl2aWRlZEluZGljZXMgPSBbXTsKICAgICAgICBjb25zdCBlZGdlcyA9IHt9OwogICAgICAgIGNvbnN0IHJhZGl1cyA9IGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzOwogICAgICAgIGNvbnN0IG1pbkRpc3RhbmNlID0gTWF0aF9kZWZhdWx0LmNob3JkTGVuZ3RoKGdyYW51bGFyaXR5LCByYWRpdXMpOwogICAgICAgIGNvbnN0IG1pbkRpc3RhbmNlU3FyZCA9IG1pbkRpc3RhbmNlICogbWluRGlzdGFuY2U7CiAgICAgICAgd2hpbGUgKHRyaWFuZ2xlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICBjb25zdCBpMiA9IHRyaWFuZ2xlcy5wb3AoKTsKICAgICAgICAgIGNvbnN0IGkxID0gdHJpYW5nbGVzLnBvcCgpOwogICAgICAgICAgY29uc3QgaTAgPSB0cmlhbmdsZXMucG9wKCk7CiAgICAgICAgICBjb25zdCB2MDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgICBpMCAqIDMsCiAgICAgICAgICAgIHN1YmRpdmlzaW9uVjBTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgdjEyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgICAgaTEgKiAzLAogICAgICAgICAgICBzdWJkaXZpc2lvblYxU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHYyMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICAgIGkyICogMywKICAgICAgICAgICAgc3ViZGl2aXNpb25WMlNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBsZXQgdDAsIHQxLCB0MjsKICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgdDAgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMsCiAgICAgICAgICAgICAgaTAgKiAyLAogICAgICAgICAgICAgIHN1YmRpdmlzaW9uVDBTY3JhdGNoCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHQxID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLAogICAgICAgICAgICAgIGkxICogMiwKICAgICAgICAgICAgICBzdWJkaXZpc2lvblQxU2NyYXRjaAogICAgICAgICAgICApOwogICAgICAgICAgICB0MiA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3JkcywKICAgICAgICAgICAgICBpMiAqIDIsCiAgICAgICAgICAgICAgc3ViZGl2aXNpb25UMlNjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHMwID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUodjAyLCBzdWJkaXZpc2lvblMwU2NyYXRjaCksCiAgICAgICAgICAgIHJhZGl1cywKICAgICAgICAgICAgc3ViZGl2aXNpb25TMFNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBzMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHYxMiwgc3ViZGl2aXNpb25TMVNjcmF0Y2gpLAogICAgICAgICAgICByYWRpdXMsCiAgICAgICAgICAgIHN1YmRpdmlzaW9uUzFTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgczIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh2MjIsIHN1YmRpdmlzaW9uUzJTY3JhdGNoKSwKICAgICAgICAgICAgcmFkaXVzLAogICAgICAgICAgICBzdWJkaXZpc2lvblMyU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IGcwID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZVNxdWFyZWQoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChzMCwgczEsIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCkKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBnMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoczEsIHMyLCBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gpCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgZzIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZCgKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHMyLCBzMCwgc3ViZGl2aXNpb25NaWRTY3JhdGNoKQogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IG1heDMgPSBNYXRoLm1heChnMCwgZzEsIGcyKTsKICAgICAgICAgIGxldCBlZGdlOwogICAgICAgICAgbGV0IG1pZDsKICAgICAgICAgIGxldCBtaWRUZXhjb29yZDsKICAgICAgICAgIGlmIChtYXgzID4gbWluRGlzdGFuY2VTcXJkKSB7CiAgICAgICAgICAgIGlmIChnMCA9PT0gbWF4MykgewogICAgICAgICAgICAgIGVkZ2UgPSBgJHtNYXRoLm1pbihpMCwgaTEpfSAke01hdGgubWF4KGkwLCBpMSl9YDsKICAgICAgICAgICAgICBpID0gZWRnZXNbZWRnZV07CiAgICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaSkpIHsKICAgICAgICAgICAgICAgIG1pZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodjAyLCB2MTIsIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCk7CiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihtaWQsIDAuNSwgbWlkKTsKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMucHVzaChtaWQueCwgbWlkLnksIG1pZC56KTsKICAgICAgICAgICAgICAgIGkgPSBzdWJkaXZpZGVkUG9zaXRpb25zLmxlbmd0aCAvIDMgLSAxOwogICAgICAgICAgICAgICAgZWRnZXNbZWRnZV0gPSBpOwogICAgICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgICAgICBtaWRUZXhjb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5hZGQodDAsIHQxLCBzdWJkaXZpc2lvblRleGNvb3JkTWlkU2NyYXRjaCk7CiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1pZFRleGNvb3JkLCAwLjUsIG1pZFRleGNvb3JkKTsKICAgICAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkcy5wdXNoKG1pZFRleGNvb3JkLngsIG1pZFRleGNvb3JkLnkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpMCwgaSwgaTIpOwogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGksIGkxLCBpMik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZzEgPT09IG1heDMpIHsKICAgICAgICAgICAgICBlZGdlID0gYCR7TWF0aC5taW4oaTEsIGkyKX0gJHtNYXRoLm1heChpMSwgaTIpfWA7CiAgICAgICAgICAgICAgaSA9IGVkZ2VzW2VkZ2VdOwogICAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGkpKSB7CiAgICAgICAgICAgICAgICBtaWQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHYxMiwgdjIyLCBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gpOwogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobWlkLCAwLjUsIG1pZCk7CiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLnB1c2gobWlkLngsIG1pZC55LCBtaWQueik7CiAgICAgICAgICAgICAgICBpID0gc3ViZGl2aWRlZFBvc2l0aW9ucy5sZW5ndGggLyAzIC0gMTsKICAgICAgICAgICAgICAgIGVkZ2VzW2VkZ2VdID0gaTsKICAgICAgICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgICAgICAgbWlkVGV4Y29vcmQgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuYWRkKHQxLCB0Miwgc3ViZGl2aXNpb25UZXhjb29yZE1pZFNjcmF0Y2gpOwogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihtaWRUZXhjb29yZCwgMC41LCBtaWRUZXhjb29yZCk7CiAgICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMucHVzaChtaWRUZXhjb29yZC54LCBtaWRUZXhjb29yZC55KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaTEsIGksIGkwKTsKICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpLCBpMiwgaTApOwogICAgICAgICAgICB9IGVsc2UgaWYgKGcyID09PSBtYXgzKSB7CiAgICAgICAgICAgICAgZWRnZSA9IGAke01hdGgubWluKGkyLCBpMCl9ICR7TWF0aC5tYXgoaTIsIGkwKX1gOwogICAgICAgICAgICAgIGkgPSBlZGdlc1tlZGdlXTsKICAgICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpKSkgewogICAgICAgICAgICAgICAgbWlkID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCh2MjIsIHYwMiwgc3ViZGl2aXNpb25NaWRTY3JhdGNoKTsKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1pZCwgMC41LCBtaWQpOwogICAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucy5wdXNoKG1pZC54LCBtaWQueSwgbWlkLnopOwogICAgICAgICAgICAgICAgaSA9IHN1YmRpdmlkZWRQb3NpdGlvbnMubGVuZ3RoIC8gMyAtIDE7CiAgICAgICAgICAgICAgICBlZGdlc1tlZGdlXSA9IGk7CiAgICAgICAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgICAgICAgIG1pZFRleGNvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmFkZCh0MiwgdDAsIHN1YmRpdmlzaW9uVGV4Y29vcmRNaWRTY3JhdGNoKTsKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobWlkVGV4Y29vcmQsIDAuNSwgbWlkVGV4Y29vcmQpOwogICAgICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLnB1c2gobWlkVGV4Y29vcmQueCwgbWlkVGV4Y29vcmQueSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGkyLCBpLCBpMSk7CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaSwgaTAsIGkxKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3ViZGl2aWRlZEluZGljZXMucHVzaChpMCk7CiAgICAgICAgICAgIHN1YmRpdmlkZWRJbmRpY2VzLnB1c2goaTEpOwogICAgICAgICAgICBzdWJkaXZpZGVkSW5kaWNlcy5wdXNoKGkyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cnlPcHRpb25zID0gewogICAgICAgICAgYXR0cmlidXRlczogewogICAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogc3ViZGl2aWRlZFBvc2l0aW9ucwogICAgICAgICAgICB9KQogICAgICAgICAgfSwKICAgICAgICAgIGluZGljZXM6IHN1YmRpdmlkZWRJbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgICAgIH07CiAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgZ2VvbWV0cnlPcHRpb25zLmF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICB2YWx1ZXM6IHN1YmRpdmlkZWRUZXhjb29yZHMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoZ2VvbWV0cnlPcHRpb25zKTsKICAgICAgfTsKICAgICAgc3ViZGl2aXNpb25DMFNjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25DMVNjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25DMlNjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc3ViZGl2aXNpb25DYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25QaXBlbGluZS5jb21wdXRlUmh1bWJMaW5lU3ViZGl2aXNpb24gPSBmdW5jdGlvbihlbGxpcHNvaWQsIHBvc2l0aW9ucywgaW5kaWNlcywgdGV4Y29vcmRzLCBncmFudWxhcml0eSkgewogICAgICAgIGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZ3JhbnVsYXJpdHksIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUpOwogICAgICAgIGNvbnN0IGhhc1RleGNvb3JkcyA9IGRlZmluZWRfZGVmYXVsdCh0ZXhjb29yZHMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZWxsaXBzb2lkIiwgZWxsaXBzb2lkKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJpbmRpY2VzIiwgaW5kaWNlcyk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoImluZGljZXMubGVuZ3RoIiwgaW5kaWNlcy5sZW5ndGgsIDMpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5lcXVhbHMoImluZGljZXMubGVuZ3RoICUgMyIsICIwIiwgaW5kaWNlcy5sZW5ndGggJSAzLCAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW4oImdyYW51bGFyaXR5IiwgZ3JhbnVsYXJpdHksIDApOwogICAgICAgIGNvbnN0IHRyaWFuZ2xlcyA9IGluZGljZXMuc2xpY2UoMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBzdWJkaXZpZGVkUG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCAqIDMpOwogICAgICAgIGNvbnN0IHN1YmRpdmlkZWRUZXhjb29yZHMgPSBuZXcgQXJyYXkobGVuZ3RoICogMik7CiAgICAgICAgbGV0IHEgPSAwOwogICAgICAgIGxldCBwID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGl0ZW0gPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW3ErK10gPSBpdGVtLng7CiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW3ErK10gPSBpdGVtLnk7CiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW3ErK10gPSBpdGVtLno7CiAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgIGNvbnN0IHRleGNvb3JkSXRlbSA9IHRleGNvb3Jkc1tpXTsKICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkc1twKytdID0gdGV4Y29vcmRJdGVtLng7CiAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHNbcCsrXSA9IHRleGNvb3JkSXRlbS55OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBzdWJkaXZpZGVkSW5kaWNlcyA9IFtdOwogICAgICAgIGNvbnN0IGVkZ2VzID0ge307CiAgICAgICAgY29uc3QgcmFkaXVzID0gZWxsaXBzb2lkLm1heGltdW1SYWRpdXM7CiAgICAgICAgY29uc3QgbWluRGlzdGFuY2UgPSBNYXRoX2RlZmF1bHQuY2hvcmRMZW5ndGgoZ3JhbnVsYXJpdHksIHJhZGl1cyk7CiAgICAgICAgY29uc3Qgcmh1bWIwID0gbmV3IEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0KHZvaWQgMCwgdm9pZCAwLCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IHJodW1iMSA9IG5ldyBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdCh2b2lkIDAsIHZvaWQgMCwgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCByaHVtYjIgPSBuZXcgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQodm9pZCAwLCB2b2lkIDAsIGVsbGlwc29pZCk7CiAgICAgICAgd2hpbGUgKHRyaWFuZ2xlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICBjb25zdCBpMiA9IHRyaWFuZ2xlcy5wb3AoKTsKICAgICAgICAgIGNvbnN0IGkxID0gdHJpYW5nbGVzLnBvcCgpOwogICAgICAgICAgY29uc3QgaTAgPSB0cmlhbmdsZXMucG9wKCk7CiAgICAgICAgICBjb25zdCB2MDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgICBpMCAqIDMsCiAgICAgICAgICAgIHN1YmRpdmlzaW9uVjBTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgdjEyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgICAgaTEgKiAzLAogICAgICAgICAgICBzdWJkaXZpc2lvblYxU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHYyMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICAgIGkyICogMywKICAgICAgICAgICAgc3ViZGl2aXNpb25WMlNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBsZXQgdDAsIHQxLCB0MjsKICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgdDAgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMsCiAgICAgICAgICAgICAgaTAgKiAyLAogICAgICAgICAgICAgIHN1YmRpdmlzaW9uVDBTY3JhdGNoCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHQxID0gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLAogICAgICAgICAgICAgIGkxICogMiwKICAgICAgICAgICAgICBzdWJkaXZpc2lvblQxU2NyYXRjaAogICAgICAgICAgICApOwogICAgICAgICAgICB0MiA9IENhcnRlc2lhbjJfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3JkcywKICAgICAgICAgICAgICBpMiAqIDIsCiAgICAgICAgICAgICAgc3ViZGl2aXNpb25UMlNjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGMwID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHYwMiwgc3ViZGl2aXNpb25DMFNjcmF0Y2gpOwogICAgICAgICAgY29uc3QgYzEgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWModjEyLCBzdWJkaXZpc2lvbkMxU2NyYXRjaCk7CiAgICAgICAgICBjb25zdCBjMiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyh2MjIsIHN1YmRpdmlzaW9uQzJTY3JhdGNoKTsKICAgICAgICAgIHJodW1iMC5zZXRFbmRQb2ludHMoYzAsIGMxKTsKICAgICAgICAgIGNvbnN0IGcwID0gcmh1bWIwLnN1cmZhY2VEaXN0YW5jZTsKICAgICAgICAgIHJodW1iMS5zZXRFbmRQb2ludHMoYzEsIGMyKTsKICAgICAgICAgIGNvbnN0IGcxID0gcmh1bWIxLnN1cmZhY2VEaXN0YW5jZTsKICAgICAgICAgIHJodW1iMi5zZXRFbmRQb2ludHMoYzIsIGMwKTsKICAgICAgICAgIGNvbnN0IGcyID0gcmh1bWIyLnN1cmZhY2VEaXN0YW5jZTsKICAgICAgICAgIGNvbnN0IG1heDMgPSBNYXRoLm1heChnMCwgZzEsIGcyKTsKICAgICAgICAgIGxldCBlZGdlOwogICAgICAgICAgbGV0IG1pZDsKICAgICAgICAgIGxldCBtaWRIZWlnaHQ7CiAgICAgICAgICBsZXQgbWlkQ2FydGVzaWFuMzsKICAgICAgICAgIGxldCBtaWRUZXhjb29yZDsKICAgICAgICAgIGlmIChtYXgzID4gbWluRGlzdGFuY2UpIHsKICAgICAgICAgICAgaWYgKGcwID09PSBtYXgzKSB7CiAgICAgICAgICAgICAgZWRnZSA9IGAke01hdGgubWluKGkwLCBpMSl9ICR7TWF0aC5tYXgoaTAsIGkxKX1gOwogICAgICAgICAgICAgIGkgPSBlZGdlc1tlZGdlXTsKICAgICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpKSkgewogICAgICAgICAgICAgICAgbWlkID0gcmh1bWIwLmludGVycG9sYXRlVXNpbmdGcmFjdGlvbigKICAgICAgICAgICAgICAgICAgMC41LAogICAgICAgICAgICAgICAgICBzdWJkaXZpc2lvbkNhcnRvZ3JhcGhpY1NjcmF0Y2gKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBtaWRIZWlnaHQgPSAoYzAuaGVpZ2h0ICsgYzEuaGVpZ2h0KSAqIDAuNTsKICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgICAgICAgICAgIG1pZC5sb25naXR1ZGUsCiAgICAgICAgICAgICAgICAgIG1pZC5sYXRpdHVkZSwKICAgICAgICAgICAgICAgICAgbWlkSGVpZ2h0LAogICAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICAgIHN1YmRpdmlzaW9uTWlkU2NyYXRjaAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMucHVzaCgKICAgICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMy54LAogICAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zLnksCiAgICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMuegogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGkgPSBzdWJkaXZpZGVkUG9zaXRpb25zLmxlbmd0aCAvIDMgLSAxOwogICAgICAgICAgICAgICAgZWRnZXNbZWRnZV0gPSBpOwogICAgICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgICAgICBtaWRUZXhjb29yZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5hZGQodDAsIHQxLCBzdWJkaXZpc2lvblRleGNvb3JkTWlkU2NyYXRjaCk7CiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG1pZFRleGNvb3JkLCAwLjUsIG1pZFRleGNvb3JkKTsKICAgICAgICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkcy5wdXNoKG1pZFRleGNvb3JkLngsIG1pZFRleGNvb3JkLnkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpMCwgaSwgaTIpOwogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGksIGkxLCBpMik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZzEgPT09IG1heDMpIHsKICAgICAgICAgICAgICBlZGdlID0gYCR7TWF0aC5taW4oaTEsIGkyKX0gJHtNYXRoLm1heChpMSwgaTIpfWA7CiAgICAgICAgICAgICAgaSA9IGVkZ2VzW2VkZ2VdOwogICAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGkpKSB7CiAgICAgICAgICAgICAgICBtaWQgPSByaHVtYjEuaW50ZXJwb2xhdGVVc2luZ0ZyYWN0aW9uKAogICAgICAgICAgICAgICAgICAwLjUsCiAgICAgICAgICAgICAgICAgIHN1YmRpdmlzaW9uQ2FydG9ncmFwaGljU2NyYXRjaAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIG1pZEhlaWdodCA9IChjMS5oZWlnaHQgKyBjMi5oZWlnaHQpICogMC41OwogICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgICAgICAgICAgbWlkLmxvbmdpdHVkZSwKICAgICAgICAgICAgICAgICAgbWlkLmxhdGl0dWRlLAogICAgICAgICAgICAgICAgICBtaWRIZWlnaHQsCiAgICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgICAgc3ViZGl2aXNpb25NaWRTY3JhdGNoCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucy5wdXNoKAogICAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zLngsCiAgICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMueSwKICAgICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMy56CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaSA9IHN1YmRpdmlkZWRQb3NpdGlvbnMubGVuZ3RoIC8gMyAtIDE7CiAgICAgICAgICAgICAgICBlZGdlc1tlZGdlXSA9IGk7CiAgICAgICAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgICAgICAgIG1pZFRleGNvb3JkID0gQ2FydGVzaWFuMl9kZWZhdWx0LmFkZCh0MSwgdDIsIHN1YmRpdmlzaW9uVGV4Y29vcmRNaWRTY3JhdGNoKTsKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobWlkVGV4Y29vcmQsIDAuNSwgbWlkVGV4Y29vcmQpOwogICAgICAgICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLnB1c2gobWlkVGV4Y29vcmQueCwgbWlkVGV4Y29vcmQueSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRyaWFuZ2xlcy5wdXNoKGkxLCBpLCBpMCk7CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaSwgaTIsIGkwKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChnMiA9PT0gbWF4MykgewogICAgICAgICAgICAgIGVkZ2UgPSBgJHtNYXRoLm1pbihpMiwgaTApfSAke01hdGgubWF4KGkyLCBpMCl9YDsKICAgICAgICAgICAgICBpID0gZWRnZXNbZWRnZV07CiAgICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaSkpIHsKICAgICAgICAgICAgICAgIG1pZCA9IHJodW1iMi5pbnRlcnBvbGF0ZVVzaW5nRnJhY3Rpb24oCiAgICAgICAgICAgICAgICAgIDAuNSwKICAgICAgICAgICAgICAgICAgc3ViZGl2aXNpb25DYXJ0b2dyYXBoaWNTY3JhdGNoCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgbWlkSGVpZ2h0ID0gKGMyLmhlaWdodCArIGMwLmhlaWdodCkgKiAwLjU7CiAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgICAgICAgICAgICBtaWQubG9uZ2l0dWRlLAogICAgICAgICAgICAgICAgICBtaWQubGF0aXR1ZGUsCiAgICAgICAgICAgICAgICAgIG1pZEhlaWdodCwKICAgICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgICBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLnB1c2goCiAgICAgICAgICAgICAgICAgIG1pZENhcnRlc2lhbjMueCwKICAgICAgICAgICAgICAgICAgbWlkQ2FydGVzaWFuMy55LAogICAgICAgICAgICAgICAgICBtaWRDYXJ0ZXNpYW4zLnoKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpID0gc3ViZGl2aWRlZFBvc2l0aW9ucy5sZW5ndGggLyAzIC0gMTsKICAgICAgICAgICAgICAgIGVkZ2VzW2VkZ2VdID0gaTsKICAgICAgICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgICAgICAgbWlkVGV4Y29vcmQgPSBDYXJ0ZXNpYW4yX2RlZmF1bHQuYWRkKHQyLCB0MCwgc3ViZGl2aXNpb25UZXhjb29yZE1pZFNjcmF0Y2gpOwogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihtaWRUZXhjb29yZCwgMC41LCBtaWRUZXhjb29yZCk7CiAgICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMucHVzaChtaWRUZXhjb29yZC54LCBtaWRUZXhjb29yZC55KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJpYW5nbGVzLnB1c2goaTIsIGksIGkxKTsKICAgICAgICAgICAgICB0cmlhbmdsZXMucHVzaChpLCBpMCwgaTEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdWJkaXZpZGVkSW5kaWNlcy5wdXNoKGkwKTsKICAgICAgICAgICAgc3ViZGl2aWRlZEluZGljZXMucHVzaChpMSk7CiAgICAgICAgICAgIHN1YmRpdmlkZWRJbmRpY2VzLnB1c2goaTIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyeU9wdGlvbnMgPSB7CiAgICAgICAgICBhdHRyaWJ1dGVzOiB7CiAgICAgICAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBzdWJkaXZpZGVkUG9zaXRpb25zCiAgICAgICAgICAgIH0pCiAgICAgICAgICB9LAogICAgICAgICAgaW5kaWNlczogc3ViZGl2aWRlZEluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTCiAgICAgICAgfTsKICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICBnZW9tZXRyeU9wdGlvbnMuYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgICAgIHZhbHVlczogc3ViZGl2aWRlZFRleGNvb3JkcwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdChnZW9tZXRyeU9wdGlvbnMpOwogICAgICB9OwogICAgICBQb2x5Z29uUGlwZWxpbmUuc2NhbGVUb0dlb2RldGljSGVpZ2h0ID0gZnVuY3Rpb24ocG9zaXRpb25zLCBoZWlnaHQsIGVsbGlwc29pZCwgc2NhbGVUb1N1cmZhY2U0KSB7CiAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgbGV0IG4gPSBzY2FsZVRvR2VvZGV0aWNIZWlnaHROOwogICAgICAgIGxldCBwID0gc2NhbGVUb0dlb2RldGljSGVpZ2h0UDsKICAgICAgICBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChoZWlnaHQsIDApOwogICAgICAgIHNjYWxlVG9TdXJmYWNlNCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHNjYWxlVG9TdXJmYWNlNCwgdHJ1ZSk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpKSB7CiAgICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaSwgcCk7CiAgICAgICAgICAgIGlmIChzY2FsZVRvU3VyZmFjZTQpIHsKICAgICAgICAgICAgICBwID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UocCwgcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhlaWdodCAhPT0gMCkgewogICAgICAgICAgICAgIG4gPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHAsIG4pOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG4sIGhlaWdodCwgbik7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwLCBuLCBwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBwLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgMV0gPSBwLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgMl0gPSBwLno7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBwb3NpdGlvbnM7CiAgICAgIH07CiAgICAgIFBvbHlnb25QaXBlbGluZV9kZWZhdWx0ID0gUG9seWdvblBpcGVsaW5lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUXVldWUuanMKICBmdW5jdGlvbiBRdWV1ZSgpIHsKICAgIHRoaXMuX2FycmF5ID0gW107CiAgICB0aGlzLl9vZmZzZXQgPSAwOwogICAgdGhpcy5fbGVuZ3RoID0gMDsKICB9CiAgdmFyIFF1ZXVlX2RlZmF1bHQ7CiAgdmFyIGluaXRfUXVldWUgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1F1ZXVlLmpzIigpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoUXVldWUucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGxlbmd0aCBvZiB0aGUgcXVldWUuCiAgICAgICAgICoKICAgICAgICAgKiBAbWVtYmVyb2YgUXVldWUucHJvdG90eXBlCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGxlbmd0aDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xlbmd0aDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBRdWV1ZS5wcm90b3R5cGUuZW5xdWV1ZSA9IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICB0aGlzLl9hcnJheS5wdXNoKGl0ZW0pOwogICAgICAgIHRoaXMuX2xlbmd0aCsrOwogICAgICB9OwogICAgICBRdWV1ZS5wcm90b3R5cGUuZGVxdWV1ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLl9sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGFycmF5ID0gdGhpcy5fYXJyYXk7CiAgICAgICAgbGV0IG9mZnNldCA9IHRoaXMuX29mZnNldDsKICAgICAgICBjb25zdCBpdGVtID0gYXJyYXlbb2Zmc2V0XTsKICAgICAgICBhcnJheVtvZmZzZXRdID0gdm9pZCAwOwogICAgICAgIG9mZnNldCsrOwogICAgICAgIGlmIChvZmZzZXQgPiAxMCAmJiBvZmZzZXQgKiAyID4gYXJyYXkubGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLl9hcnJheSA9IGFycmF5LnNsaWNlKG9mZnNldCk7CiAgICAgICAgICBvZmZzZXQgPSAwOwogICAgICAgIH0KICAgICAgICB0aGlzLl9vZmZzZXQgPSBvZmZzZXQ7CiAgICAgICAgdGhpcy5fbGVuZ3RoLS07CiAgICAgICAgcmV0dXJuIGl0ZW07CiAgICAgIH07CiAgICAgIFF1ZXVlLnByb3RvdHlwZS5wZWVrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuX2xlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuX2FycmF5W3RoaXMuX29mZnNldF07CiAgICAgIH07CiAgICAgIFF1ZXVlLnByb3RvdHlwZS5jb250YWlucyA9IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICByZXR1cm4gdGhpcy5fYXJyYXkuaW5kZXhPZihpdGVtKSAhPT0gLTE7CiAgICAgIH07CiAgICAgIFF1ZXVlLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuX2FycmF5Lmxlbmd0aCA9IHRoaXMuX29mZnNldCA9IHRoaXMuX2xlbmd0aCA9IDA7CiAgICAgIH07CiAgICAgIFF1ZXVlLnByb3RvdHlwZS5zb3J0ID0gZnVuY3Rpb24oY29tcGFyZUZ1bmN0aW9uKSB7CiAgICAgICAgaWYgKHRoaXMuX29mZnNldCA+IDApIHsKICAgICAgICAgIHRoaXMuX2FycmF5ID0gdGhpcy5fYXJyYXkuc2xpY2UodGhpcy5fb2Zmc2V0KTsKICAgICAgICAgIHRoaXMuX29mZnNldCA9IDA7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2FycmF5LnNvcnQoY29tcGFyZUZ1bmN0aW9uKTsKICAgICAgfTsKICAgICAgUXVldWVfZGVmYXVsdCA9IFF1ZXVlOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvbkdlb21ldHJ5TGlicmFyeS5qcwogIGZ1bmN0aW9uIGdldFBvaW50QXREaXN0YW5jZTJEKHAwLCBwMSwgZGlzdGFuY2UsIGxlbmd0aCkgewogICAgQ2FydGVzaWFuMl9kZWZhdWx0LnN1YnRyYWN0KHAxLCBwMCwgZGlzdGFuY2UyRFNjcmF0Y2gpOwogICAgQ2FydGVzaWFuMl9kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIGRpc3RhbmNlMkRTY3JhdGNoLAogICAgICBkaXN0YW5jZSAvIGxlbmd0aCwKICAgICAgZGlzdGFuY2UyRFNjcmF0Y2gKICAgICk7CiAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuYWRkKHAwLCBkaXN0YW5jZTJEU2NyYXRjaCwgZGlzdGFuY2UyRFNjcmF0Y2gpOwogICAgcmV0dXJuIFtkaXN0YW5jZTJEU2NyYXRjaC54LCBkaXN0YW5jZTJEU2NyYXRjaC55XTsKICB9CiAgZnVuY3Rpb24gZ2V0UG9pbnRBdERpc3RhbmNlKHAwLCBwMSwgZGlzdGFuY2UsIGxlbmd0aCkgewogICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAxLCBwMCwgZGlzdGFuY2VTY3JhdGNoNCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgZGlzdGFuY2VTY3JhdGNoNCwKICAgICAgZGlzdGFuY2UgLyBsZW5ndGgsCiAgICAgIGRpc3RhbmNlU2NyYXRjaDQKICAgICk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHAwLCBkaXN0YW5jZVNjcmF0Y2g0LCBkaXN0YW5jZVNjcmF0Y2g0KTsKICAgIHJldHVybiBbZGlzdGFuY2VTY3JhdGNoNC54LCBkaXN0YW5jZVNjcmF0Y2g0LnksIGRpc3RhbmNlU2NyYXRjaDQuel07CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVFcXVhdG9ySW50ZXJzZWN0aW9uUmh1bWIoc3RhcnQsIGVuZCwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBjMCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhzdGFydCwgc2NyYXRjaENhcnRvZ3JhcGhpYzApOwogICAgY29uc3QgYzEgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoZW5kLCBzY3JhdGNoQ2FydG9ncmFwaGljMSk7CiAgICBpZiAoTWF0aC5zaWduKGMwLmxhdGl0dWRlKSA9PT0gTWF0aC5zaWduKGMxLmxhdGl0dWRlKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBzY3JhdGNoUmh1bWJMaW5lLnNldEVuZFBvaW50cyhjMCwgYzEpOwogICAgY29uc3QgaW50ZXJzZWN0aW9uID0gc2NyYXRjaFJodW1iTGluZS5maW5kSW50ZXJzZWN0aW9uV2l0aExhdGl0dWRlKAogICAgICAwLAogICAgICBzY3JhdGNoUmh1bWJJbnRlcnNlY3Rpb24KICAgICk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb24pKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGxldCBtaW5Mb25naXR1ZGUgPSBNYXRoLm1pbihjMC5sb25naXR1ZGUsIGMxLmxvbmdpdHVkZSk7CiAgICBsZXQgbWF4TG9uZ2l0dWRlID0gTWF0aC5tYXgoYzAubG9uZ2l0dWRlLCBjMS5sb25naXR1ZGUpOwogICAgaWYgKE1hdGguYWJzKG1heExvbmdpdHVkZSAtIG1pbkxvbmdpdHVkZSkgPiBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgY29uc3Qgc3dhcDIgPSBtaW5Mb25naXR1ZGU7CiAgICAgIG1pbkxvbmdpdHVkZSA9IG1heExvbmdpdHVkZTsKICAgICAgbWF4TG9uZ2l0dWRlID0gc3dhcDI7CiAgICB9CiAgICBpZiAoaW50ZXJzZWN0aW9uLmxvbmdpdHVkZSA8IG1pbkxvbmdpdHVkZSB8fCBpbnRlcnNlY3Rpb24ubG9uZ2l0dWRlID4gbWF4TG9uZ2l0dWRlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHJldHVybiBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oaW50ZXJzZWN0aW9uKTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUVxdWF0b3JJbnRlcnNlY3Rpb24oc3RhcnQsIGVuZCwgZWxsaXBzb2lkLCBhcmNUeXBlKSB7CiAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgIHJldHVybiBjb21wdXRlRXF1YXRvckludGVyc2VjdGlvblJodW1iKHN0YXJ0LCBlbmQsIGVsbGlwc29pZCk7CiAgICB9CiAgICBjb25zdCBpbnRlcnNlY3Rpb24gPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LmxpbmVTZWdtZW50UGxhbmUoCiAgICAgIHN0YXJ0LAogICAgICBlbmQsCiAgICAgIFBsYW5lX2RlZmF1bHQuT1JJR0lOX1hZX1BMQU5FCiAgICApOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICByZXR1cm4gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UoaW50ZXJzZWN0aW9uLCBpbnRlcnNlY3Rpb24pOwogIH0KICBmdW5jdGlvbiBjb21wdXRlRWRnZXNPblBsYW5lKHBvc2l0aW9ucywgZWxsaXBzb2lkLCBhcmNUeXBlKSB7CiAgICBjb25zdCBlZGdlc09uUGxhbmUgPSBbXTsKICAgIGxldCBzdGFydFBvaW50LCBlbmRQb2ludCwgdHlwZSwgbmV4dCwgaW50ZXJzZWN0aW9uLCBpID0gMDsKICAgIHdoaWxlIChpIDwgcG9zaXRpb25zLmxlbmd0aCkgewogICAgICBzdGFydFBvaW50ID0gcG9zaXRpb25zW2ldOwogICAgICBlbmRQb2ludCA9IHBvc2l0aW9uc1soaSArIDEpICUgcG9zaXRpb25zLmxlbmd0aF07CiAgICAgIHR5cGUgPSBNYXRoX2RlZmF1bHQuc2lnbihzdGFydFBvaW50LnopOwogICAgICBuZXh0ID0gTWF0aF9kZWZhdWx0LnNpZ24oZW5kUG9pbnQueik7CiAgICAgIGNvbnN0IGdldExvbmdpdHVkZSA9IChwb3NpdGlvbikgPT4gewogICAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMzCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gY2FydG9ncmFwaGljMi5sb25naXR1ZGU7CiAgICAgIH07CiAgICAgIGlmICh0eXBlID09PSAwKSB7CiAgICAgICAgZWRnZXNPblBsYW5lLnB1c2goewogICAgICAgICAgcG9zaXRpb246IGksCiAgICAgICAgICB0eXBlLAogICAgICAgICAgdmlzaXRlZDogZmFsc2UsCiAgICAgICAgICBuZXh0LAogICAgICAgICAgdGhldGE6IGdldExvbmdpdHVkZShzdGFydFBvaW50KQogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKG5leHQgIT09IDApIHsKICAgICAgICBpbnRlcnNlY3Rpb24gPSBjb21wdXRlRXF1YXRvckludGVyc2VjdGlvbigKICAgICAgICAgIHN0YXJ0UG9pbnQsCiAgICAgICAgICBlbmRQb2ludCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIGFyY1R5cGUKICAgICAgICApOwogICAgICAgICsraTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb24pKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgcG9zaXRpb25zLnNwbGljZShpLCAwLCBpbnRlcnNlY3Rpb24pOwogICAgICAgIGVkZ2VzT25QbGFuZS5wdXNoKHsKICAgICAgICAgIHBvc2l0aW9uOiBpLAogICAgICAgICAgdHlwZSwKICAgICAgICAgIHZpc2l0ZWQ6IGZhbHNlLAogICAgICAgICAgbmV4dCwKICAgICAgICAgIHRoZXRhOiBnZXRMb25naXR1ZGUoaW50ZXJzZWN0aW9uKQogICAgICAgIH0pOwogICAgICB9CiAgICAgICsraTsKICAgIH0KICAgIHJldHVybiBlZGdlc09uUGxhbmU7CiAgfQogIGZ1bmN0aW9uIHdpcmVQb2x5Z29uKHBvbHlnb25zLCBwb2x5Z29uSW5kZXgsIHBvc2l0aW9ucywgZWRnZXNPblBsYW5lLCB0b0RlbGV0ZSwgc3RhcnRJbmRleCwgYWJvdmVQbGFuZSkgewogICAgY29uc3QgcG9seWdvbjIgPSBbXTsKICAgIGxldCBpID0gc3RhcnRJbmRleDsKICAgIGNvbnN0IGdldE1hdGNoaW5nRWRnZSA9IChpMikgPT4gKGVkZ2UpID0+IGVkZ2UucG9zaXRpb24gPT09IGkyOwogICAgY29uc3QgcG9seWdvbnNUb1dpcmUgPSBbXTsKICAgIGRvIHsKICAgICAgY29uc3QgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07CiAgICAgIHBvbHlnb24yLnB1c2gocG9zaXRpb24pOwogICAgICBjb25zdCBlZGdlSW5kZXggPSBlZGdlc09uUGxhbmUuZmluZEluZGV4KGdldE1hdGNoaW5nRWRnZShpKSk7CiAgICAgIGNvbnN0IGVkZ2UgPSBlZGdlc09uUGxhbmVbZWRnZUluZGV4XTsKICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZWRnZSkpIHsKICAgICAgICArK2k7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgeyB2aXNpdGVkOiBoYXNCZWVuVmlzaXRlZCwgdHlwZSwgbmV4dCB9ID0gZWRnZTsKICAgICAgZWRnZS52aXNpdGVkID0gdHJ1ZTsKICAgICAgaWYgKHR5cGUgPT09IDApIHsKICAgICAgICBpZiAobmV4dCA9PT0gMCkgewogICAgICAgICAgY29uc3QgcHJldmlvdXNFZGdlID0gZWRnZXNPblBsYW5lW2VkZ2VJbmRleCAtIChhYm92ZVBsYW5lID8gMSA6IC0xKV07CiAgICAgICAgICBpZiAocHJldmlvdXNFZGdlPy5wb3NpdGlvbiA9PT0gaSArIDEpIHsKICAgICAgICAgICAgcHJldmlvdXNFZGdlLnZpc2l0ZWQgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgKytpOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFoYXNCZWVuVmlzaXRlZCAmJiBhYm92ZVBsYW5lICYmIG5leHQgPiAwIHx8IHN0YXJ0SW5kZXggPT09IGkgJiYgIWFib3ZlUGxhbmUgJiYgbmV4dCA8IDApIHsKICAgICAgICAgICsraTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBmb2xsb3dFZGdlID0gYWJvdmVQbGFuZSA/IHR5cGUgPj0gMCA6IHR5cGUgPD0gMDsKICAgICAgaWYgKCFmb2xsb3dFZGdlKSB7CiAgICAgICAgKytpOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmICghaGFzQmVlblZpc2l0ZWQpIHsKICAgICAgICBwb2x5Z29uc1RvV2lyZS5wdXNoKGkpOwogICAgICB9CiAgICAgIGNvbnN0IG5leHRFZGdlSW5kZXggPSBlZGdlSW5kZXggKyAoYWJvdmVQbGFuZSA/IDEgOiAtMSk7CiAgICAgIGNvbnN0IG5leHRFZGdlID0gZWRnZXNPblBsYW5lW25leHRFZGdlSW5kZXhdOwogICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChuZXh0RWRnZSkpIHsKICAgICAgICArK2k7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaSA9IG5leHRFZGdlLnBvc2l0aW9uOwogICAgfSB3aGlsZSAoaSA8IHBvc2l0aW9ucy5sZW5ndGggJiYgaSA+PSAwICYmIGkgIT09IHN0YXJ0SW5kZXggJiYgcG9seWdvbjIubGVuZ3RoIDwgcG9zaXRpb25zLmxlbmd0aCk7CiAgICBwb2x5Z29ucy5zcGxpY2UocG9seWdvbkluZGV4LCB0b0RlbGV0ZSwgcG9seWdvbjIpOwogICAgZm9yIChjb25zdCBpbmRleCBvZiBwb2x5Z29uc1RvV2lyZSkgewogICAgICBwb2x5Z29uSW5kZXggPSB3aXJlUG9seWdvbigKICAgICAgICBwb2x5Z29ucywKICAgICAgICArK3BvbHlnb25JbmRleCwKICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgZWRnZXNPblBsYW5lLAogICAgICAgIDAsCiAgICAgICAgaW5kZXgsCiAgICAgICAgIWFib3ZlUGxhbmUKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBwb2x5Z29uSW5kZXg7CiAgfQogIHZhciBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LCBkaXN0YW5jZTJEU2NyYXRjaCwgZGlzdGFuY2VTY3JhdGNoNCwgc2NyYXRjaENhcnRvZ3JhcGhpYzAsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxLCBzY3JhdGNoQ2FydG9ncmFwaGljMjIsIHNjcmF0Y2hDYXJ0ZXNpYW4wLCBzY3JhdGNoUmh1bWJMaW5lLCBzY2FsZVRvR2VvZGV0aWNIZWlnaHROMSwgc2NhbGVUb0dlb2RldGljSGVpZ2h0TjIsIHNjYWxlVG9HZW9kZXRpY0hlaWdodFAxLCBzY2FsZVRvR2VvZGV0aWNIZWlnaHRQMiwgc2NyYXRjaFJodW1iSW50ZXJzZWN0aW9uLCBzY3JhdGNoQ2FydG9ncmFwaGljMywgY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlQ2FydGVzaWFuMiwgY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlQ2FydGVzaWFuMywgY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlUXVhdGVybmlvbiwgY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlTWF0cml4MywgY29tcHV0ZVdhbGxUZXhjb29yZHNTdWJkaXZpZGVkLCBjb21wdXRlV2FsbEluZGljZXNTdWJkaXZpZGVkLCBwMVNjcmF0Y2gyLCBwMlNjcmF0Y2gyLCBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUG9seWdvbkdlb21ldHJ5TGlicmFyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvbkdlb21ldHJ5TGlicmFyeS5qcyIoKSB7CiAgICAgIGluaXRfQXJjVHlwZSgpOwogICAgICBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcygpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkUmh1bWJMaW5lKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5UGlwZWxpbmUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfSW50ZXJzZWN0aW9uVGVzdHMoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X1BsYW5lKCk7CiAgICAgIGluaXRfUG9seWdvbkhpZXJhcmNoeSgpOwogICAgICBpbml0X1BvbHlnb25QaXBlbGluZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfUXVldWUoKTsKICAgICAgaW5pdF9XaW5kaW5nT3JkZXIoKTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeSA9IHt9OwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVIaWVyYXJjaHlQYWNrZWRMZW5ndGggPSBmdW5jdGlvbihwb2x5Z29uSGllcmFyY2h5LCBDYXJ0ZXNpYW5YKSB7CiAgICAgICAgbGV0IG51bUNvbXBvbmVudHMgPSAwOwogICAgICAgIGNvbnN0IHN0YWNrID0gW3BvbHlnb25IaWVyYXJjaHldOwogICAgICAgIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7CiAgICAgICAgICBjb25zdCBoaWVyYXJjaHkgPSBzdGFjay5wb3AoKTsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhpZXJhcmNoeSkpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBudW1Db21wb25lbnRzICs9IDI7CiAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBoaWVyYXJjaHkucG9zaXRpb25zOwogICAgICAgICAgY29uc3QgaG9sZXMgPSBoaWVyYXJjaHkuaG9sZXM7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgJiYgcG9zaXRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgbnVtQ29tcG9uZW50cyArPSBwb3NpdGlvbnMubGVuZ3RoICogQ2FydGVzaWFuWC5wYWNrZWRMZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGhvbGVzKSkgewogICAgICAgICAgICBjb25zdCBsZW5ndGggPSBob2xlcy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICBzdGFjay5wdXNoKGhvbGVzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVtQ29tcG9uZW50czsKICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5wYWNrUG9seWdvbkhpZXJhcmNoeSA9IGZ1bmN0aW9uKHBvbHlnb25IaWVyYXJjaHksIGFycmF5LCBzdGFydGluZ0luZGV4LCBDYXJ0ZXNpYW5YKSB7CiAgICAgICAgY29uc3Qgc3RhY2sgPSBbcG9seWdvbkhpZXJhcmNoeV07CiAgICAgICAgd2hpbGUgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IGhpZXJhcmNoeSA9IHN0YWNrLnBvcCgpOwogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaGllcmFyY2h5KSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IGhpZXJhcmNoeS5wb3NpdGlvbnM7CiAgICAgICAgICBjb25zdCBob2xlcyA9IGhpZXJhcmNoeS5ob2xlczsKICAgICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSA/IHBvc2l0aW9ucy5sZW5ndGggOiAwOwogICAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGRlZmluZWRfZGVmYXVsdChob2xlcykgPyBob2xlcy5sZW5ndGggOiAwOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpKSB7CiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuWC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgICAgICBDYXJ0ZXNpYW5YLnBhY2socG9zaXRpb25zW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaG9sZXMpKSB7CiAgICAgICAgICAgIGNvbnN0IGhvbGVzTGVuZ3RoID0gaG9sZXMubGVuZ3RoOwogICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGhvbGVzTGVuZ3RoOyArK2opIHsKICAgICAgICAgICAgICBzdGFjay5wdXNoKGhvbGVzW2pdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RhcnRpbmdJbmRleDsKICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS51bnBhY2tQb2x5Z29uSGllcmFyY2h5ID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIENhcnRlc2lhblgpIHsKICAgICAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGhvbGVzTGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkocG9zaXRpb25zTGVuZ3RoKTsKICAgICAgICBjb25zdCBob2xlcyA9IGhvbGVzTGVuZ3RoID4gMCA/IG5ldyBBcnJheShob2xlc0xlbmd0aCkgOiB2b2lkIDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW5YLnBhY2tlZExlbmd0aCkgewogICAgICAgICAgcG9zaXRpb25zW2ldID0gQ2FydGVzaWFuWC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGhvbGVzTGVuZ3RoOyArK2opIHsKICAgICAgICAgIGhvbGVzW2pdID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeS51bnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgICBhcnJheSwKICAgICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgICAgQ2FydGVzaWFuWAogICAgICAgICAgKTsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggPSBob2xlc1tqXS5zdGFydGluZ0luZGV4OwogICAgICAgICAgZGVsZXRlIGhvbGVzW2pdLnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBob2xlcywKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgKICAgICAgICB9OwogICAgICB9OwogICAgICBkaXN0YW5jZTJEU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgZGlzdGFuY2VTY3JhdGNoNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVMaW5lQ291bnQgPSBmdW5jdGlvbihwMCwgcDEsIG1pbkRpc3RhbmNlKSB7CiAgICAgICAgY29uc3QgZGlzdGFuY2UgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGlzdGFuY2UocDAsIHAxKTsKICAgICAgICBjb25zdCBuID0gZGlzdGFuY2UgLyBtaW5EaXN0YW5jZTsKICAgICAgICBjb25zdCBjb3VudERpdmlkZSA9IE1hdGgubWF4KDAsIE1hdGguY2VpbChNYXRoX2RlZmF1bHQubG9nMihuKSkpOwogICAgICAgIHJldHVybiBNYXRoLnBvdygyLCBjb3VudERpdmlkZSk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMyMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFJodW1iTGluZSA9IG5ldyBFbGxpcHNvaWRSaHVtYkxpbmVfZGVmYXVsdCgpOwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZVJodW1iTGluZUNvdW50ID0gZnVuY3Rpb24oZWxsaXBzb2lkLCBwMCwgcDEsIG1pbkRpc3RhbmNlKSB7CiAgICAgICAgY29uc3QgYzAgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDAsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwKTsKICAgICAgICBjb25zdCBjMSA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMSwgc2NyYXRjaENhcnRvZ3JhcGhpYzEpOwogICAgICAgIGNvbnN0IHJodW1iID0gbmV3IEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0KGMwLCBjMSwgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBuID0gcmh1bWIuc3VyZmFjZURpc3RhbmNlIC8gbWluRGlzdGFuY2U7CiAgICAgICAgY29uc3QgY291bnREaXZpZGUgPSBNYXRoLm1heCgwLCBNYXRoLmNlaWwoTWF0aF9kZWZhdWx0LmxvZzIobikpKTsKICAgICAgICByZXR1cm4gTWF0aC5wb3coMiwgY291bnREaXZpZGUpOwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZVRleGNvb3JkTGluZSA9IGZ1bmN0aW9uKHQwLCB0MSwgcDAsIHAxLCBtaW5EaXN0YW5jZSwgcmVzdWx0KSB7CiAgICAgICAgY29uc3Qgc3ViZGl2aXNpb25zID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVMaW5lQ291bnQoCiAgICAgICAgICBwMCwKICAgICAgICAgIHAxLAogICAgICAgICAgbWluRGlzdGFuY2UKICAgICAgICApOwogICAgICAgIGNvbnN0IGxlbmd0aDJEID0gQ2FydGVzaWFuMl9kZWZhdWx0LmRpc3RhbmNlKHQwLCB0MSk7CiAgICAgICAgY29uc3QgZGlzdGFuY2VCZXR3ZWVuQ29vcmRzID0gbGVuZ3RoMkQgLyBzdWJkaXZpc2lvbnM7CiAgICAgICAgY29uc3QgdGV4Y29vcmRzID0gcmVzdWx0OwogICAgICAgIHRleGNvb3Jkcy5sZW5ndGggPSBzdWJkaXZpc2lvbnMgKiAyOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdWJkaXZpc2lvbnM7IGkrKykgewogICAgICAgICAgY29uc3QgdCA9IGdldFBvaW50QXREaXN0YW5jZTJEKHQwLCB0MSwgaSAqIGRpc3RhbmNlQmV0d2VlbkNvb3JkcywgbGVuZ3RoMkQpOwogICAgICAgICAgdGV4Y29vcmRzW2luZGV4KytdID0gdFswXTsKICAgICAgICAgIHRleGNvb3Jkc1tpbmRleCsrXSA9IHRbMV07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0ZXhjb29yZHM7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlTGluZSA9IGZ1bmN0aW9uKHAwLCBwMSwgbWluRGlzdGFuY2UsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IG51bVZlcnRpY2VzID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zdWJkaXZpZGVMaW5lQ291bnQoCiAgICAgICAgICBwMCwKICAgICAgICAgIHAxLAogICAgICAgICAgbWluRGlzdGFuY2UKICAgICAgICApOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kaXN0YW5jZShwMCwgcDEpOwogICAgICAgIGNvbnN0IGRpc3RhbmNlQmV0d2VlblZlcnRpY2VzID0gbGVuZ3RoIC8gbnVtVmVydGljZXM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHJlc3VsdDsKICAgICAgICBwb3NpdGlvbnMubGVuZ3RoID0gbnVtVmVydGljZXMgKiAzOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwID0gZ2V0UG9pbnRBdERpc3RhbmNlKHAwLCBwMSwgaSAqIGRpc3RhbmNlQmV0d2VlblZlcnRpY2VzLCBsZW5ndGgpOwogICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcFswXTsKICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHBbMV07CiAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBwWzJdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcG9zaXRpb25zOwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZVRleGNvb3JkUmh1bWJMaW5lID0gZnVuY3Rpb24odDAsIHQxLCBlbGxpcHNvaWQsIHAwLCBwMSwgbWluRGlzdGFuY2UsIHJlc3VsdCkgewogICAgICAgIGNvbnN0IGMwID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAwLCBzY3JhdGNoQ2FydG9ncmFwaGljMCk7CiAgICAgICAgY29uc3QgYzEgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDEsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxKTsKICAgICAgICBzY3JhdGNoUmh1bWJMaW5lLnNldEVuZFBvaW50cyhjMCwgYzEpOwogICAgICAgIGNvbnN0IG4gPSBzY3JhdGNoUmh1bWJMaW5lLnN1cmZhY2VEaXN0YW5jZSAvIG1pbkRpc3RhbmNlOwogICAgICAgIGNvbnN0IGNvdW50RGl2aWRlID0gTWF0aC5tYXgoMCwgTWF0aC5jZWlsKE1hdGhfZGVmYXVsdC5sb2cyKG4pKSk7CiAgICAgICAgY29uc3Qgc3ViZGl2aXNpb25zID0gTWF0aC5wb3coMiwgY291bnREaXZpZGUpOwogICAgICAgIGNvbnN0IGxlbmd0aDJEID0gQ2FydGVzaWFuMl9kZWZhdWx0LmRpc3RhbmNlKHQwLCB0MSk7CiAgICAgICAgY29uc3QgZGlzdGFuY2VCZXR3ZWVuQ29vcmRzID0gbGVuZ3RoMkQgLyBzdWJkaXZpc2lvbnM7CiAgICAgICAgY29uc3QgdGV4Y29vcmRzID0gcmVzdWx0OwogICAgICAgIHRleGNvb3Jkcy5sZW5ndGggPSBzdWJkaXZpc2lvbnMgKiAyOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdWJkaXZpc2lvbnM7IGkrKykgewogICAgICAgICAgY29uc3QgdCA9IGdldFBvaW50QXREaXN0YW5jZTJEKHQwLCB0MSwgaSAqIGRpc3RhbmNlQmV0d2VlbkNvb3JkcywgbGVuZ3RoMkQpOwogICAgICAgICAgdGV4Y29vcmRzW2luZGV4KytdID0gdFswXTsKICAgICAgICAgIHRleGNvb3Jkc1tpbmRleCsrXSA9IHRbMV07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0ZXhjb29yZHM7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlUmh1bWJMaW5lID0gZnVuY3Rpb24oZWxsaXBzb2lkLCBwMCwgcDEsIG1pbkRpc3RhbmNlLCByZXN1bHQpIHsKICAgICAgICBjb25zdCBjMCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMCwgc2NyYXRjaENhcnRvZ3JhcGhpYzApOwogICAgICAgIGNvbnN0IGMxID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAxLCBzY3JhdGNoQ2FydG9ncmFwaGljMSk7CiAgICAgICAgY29uc3Qgcmh1bWIgPSBuZXcgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQoYzAsIGMxLCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IG4gPSByaHVtYi5zdXJmYWNlRGlzdGFuY2UgLyBtaW5EaXN0YW5jZTsKICAgICAgICBjb25zdCBjb3VudERpdmlkZSA9IE1hdGgubWF4KDAsIE1hdGguY2VpbChNYXRoX2RlZmF1bHQubG9nMihuKSkpOwogICAgICAgIGNvbnN0IG51bVZlcnRpY2VzID0gTWF0aC5wb3coMiwgY291bnREaXZpZGUpOwogICAgICAgIGNvbnN0IGRpc3RhbmNlQmV0d2VlblZlcnRpY2VzID0gcmh1bWIuc3VyZmFjZURpc3RhbmNlIC8gbnVtVmVydGljZXM7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHJlc3VsdDsKICAgICAgICBwb3NpdGlvbnMubGVuZ3RoID0gbnVtVmVydGljZXMgKiAzOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgaSsrKSB7CiAgICAgICAgICBjb25zdCBjID0gcmh1bWIuaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSgKICAgICAgICAgICAgaSAqIGRpc3RhbmNlQmV0d2VlblZlcnRpY2VzLAogICAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMjIKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBwID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGMsIHNjcmF0Y2hDYXJ0ZXNpYW4wKTsKICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHAueDsKICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHAueTsKICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHAuejsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBvc2l0aW9uczsKICAgICAgfTsKICAgICAgc2NhbGVUb0dlb2RldGljSGVpZ2h0TjEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjYWxlVG9HZW9kZXRpY0hlaWdodE4yID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY2FsZVRvR2VvZGV0aWNIZWlnaHRQMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NhbGVUb0dlb2RldGljSGVpZ2h0UDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc2NhbGVUb0dlb2RldGljSGVpZ2h0RXh0cnVkZWQgPSBmdW5jdGlvbihnZW9tZXRyeSwgbWF4SGVpZ2h0LCBtaW5IZWlnaHQsIGVsbGlwc29pZCwgcGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgICBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChlbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICBjb25zdCBuMSA9IHNjYWxlVG9HZW9kZXRpY0hlaWdodE4xOwogICAgICAgIGxldCBuMiA9IHNjYWxlVG9HZW9kZXRpY0hlaWdodE4yOwogICAgICAgIGNvbnN0IHAgPSBzY2FsZVRvR2VvZGV0aWNIZWlnaHRQMTsKICAgICAgICBsZXQgcDIgPSBzY2FsZVRvR2VvZGV0aWNIZWlnaHRQMjsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5KSAmJiBkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnkuYXR0cmlidXRlcykgJiYgZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24pKSB7CiAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyAyOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgaSwgcCk7CiAgICAgICAgICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocCwgbjEpOwogICAgICAgICAgICBwMiA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHAsIHAyKTsKICAgICAgICAgICAgbjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuMSwgbWluSGVpZ2h0LCBuMik7CiAgICAgICAgICAgIG4yID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwMiwgbjIsIG4yKTsKICAgICAgICAgICAgcG9zaXRpb25zW2kgKyBsZW5ndGhdID0gbjIueDsKICAgICAgICAgICAgcG9zaXRpb25zW2kgKyAxICsgbGVuZ3RoXSA9IG4yLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgMiArIGxlbmd0aF0gPSBuMi56OwogICAgICAgICAgICBpZiAocGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgICAgICAgICBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwLCBwMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbjIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihuMSwgbWF4SGVpZ2h0LCBuMik7CiAgICAgICAgICAgIG4yID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwMiwgbjIsIG4yKTsKICAgICAgICAgICAgcG9zaXRpb25zW2ldID0gbjIueDsKICAgICAgICAgICAgcG9zaXRpb25zW2kgKyAxXSA9IG4yLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgMl0gPSBuMi56OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VvbWV0cnk7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkucG9seWdvbk91dGxpbmVzRnJvbUhpZXJhcmNoeSA9IGZ1bmN0aW9uKHBvbHlnb25IaWVyYXJjaHksIHNjYWxlVG9FbGxpcHNvaWRTdXJmYWNlLCBlbGxpcHNvaWQpIHsKICAgICAgICBjb25zdCBwb2x5Z29ucyA9IFtdOwogICAgICAgIGNvbnN0IHF1ZXVlID0gbmV3IFF1ZXVlX2RlZmF1bHQoKTsKICAgICAgICBxdWV1ZS5lbnF1ZXVlKHBvbHlnb25IaWVyYXJjaHkpOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBqOwogICAgICAgIGxldCBsZW5ndGg7CiAgICAgICAgd2hpbGUgKHF1ZXVlLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgY29uc3Qgb3V0ZXJOb2RlID0gcXVldWUuZGVxdWV1ZSgpOwogICAgICAgICAgbGV0IG91dGVyUmluZyA9IG91dGVyTm9kZS5wb3NpdGlvbnM7CiAgICAgICAgICBpZiAoc2NhbGVUb0VsbGlwc29pZFN1cmZhY2UpIHsKICAgICAgICAgICAgbGVuZ3RoID0gb3V0ZXJSaW5nLmxlbmd0aDsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2Uob3V0ZXJSaW5nW2ldLCBvdXRlclJpbmdbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBvdXRlclJpbmcgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgICAgb3V0ZXJSaW5nLAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbiwKICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgKTsKICAgICAgICAgIGlmIChvdXRlclJpbmcubGVuZ3RoIDwgMykgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IG51bUNoaWxkcmVuID0gb3V0ZXJOb2RlLmhvbGVzID8gb3V0ZXJOb2RlLmhvbGVzLmxlbmd0aCA6IDA7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtQ2hpbGRyZW47IGkrKykgewogICAgICAgICAgICBjb25zdCBob2xlID0gb3V0ZXJOb2RlLmhvbGVzW2ldOwogICAgICAgICAgICBsZXQgaG9sZVBvc2l0aW9ucyA9IGhvbGUucG9zaXRpb25zOwogICAgICAgICAgICBpZiAoc2NhbGVUb0VsbGlwc29pZFN1cmZhY2UpIHsKICAgICAgICAgICAgICBsZW5ndGggPSBob2xlUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbGVuZ3RoOyArK2opIHsKICAgICAgICAgICAgICAgIGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKGhvbGVQb3NpdGlvbnNbal0sIGhvbGVQb3NpdGlvbnNbal0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBob2xlUG9zaXRpb25zID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgICAgICAgICAgaG9sZVBvc2l0aW9ucywKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbiwKICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIChob2xlUG9zaXRpb25zLmxlbmd0aCA8IDMpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwb2x5Z29ucy5wdXNoKGhvbGVQb3NpdGlvbnMpOwogICAgICAgICAgICBsZXQgbnVtR3JhbmRjaGlsZHJlbiA9IDA7CiAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaG9sZS5ob2xlcykpIHsKICAgICAgICAgICAgICBudW1HcmFuZGNoaWxkcmVuID0gaG9sZS5ob2xlcy5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IG51bUdyYW5kY2hpbGRyZW47IGorKykgewogICAgICAgICAgICAgIHF1ZXVlLmVucXVldWUoaG9sZS5ob2xlc1tqXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBvbHlnb25zLnB1c2gob3V0ZXJSaW5nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBvbHlnb25zOwogICAgICB9OwogICAgICBzY3JhdGNoUmh1bWJJbnRlcnNlY3Rpb24gPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeS5zcGxpdFBvbHlnb25zT25FcXVhdG9yID0gZnVuY3Rpb24ob3V0ZXJSaW5ncywgZWxsaXBzb2lkLCBhcmNUeXBlLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnNwbGljZSgwLCAwLCAuLi5vdXRlclJpbmdzKTsKICAgICAgICByZXN1bHQubGVuZ3RoID0gb3V0ZXJSaW5ncy5sZW5ndGg7CiAgICAgICAgbGV0IGN1cnJlbnRQb2x5Z29uID0gMDsKICAgICAgICB3aGlsZSAoY3VycmVudFBvbHlnb24gPCByZXN1bHQubGVuZ3RoKSB7CiAgICAgICAgICBjb25zdCBvdXRlclJpbmcgPSByZXN1bHRbY3VycmVudFBvbHlnb25dOwogICAgICAgICAgY29uc3QgcG9zaXRpb25zID0gb3V0ZXJSaW5nLnNsaWNlKCk7CiAgICAgICAgICBpZiAob3V0ZXJSaW5nLmxlbmd0aCA8IDMpIHsKICAgICAgICAgICAgcmVzdWx0W2N1cnJlbnRQb2x5Z29uXSA9IHBvc2l0aW9uczsKICAgICAgICAgICAgKytjdXJyZW50UG9seWdvbjsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBlZGdlc09uUGxhbmUgPSBjb21wdXRlRWRnZXNPblBsYW5lKHBvc2l0aW9ucywgZWxsaXBzb2lkLCBhcmNUeXBlKTsKICAgICAgICAgIGlmIChwb3NpdGlvbnMubGVuZ3RoID09PSBvdXRlclJpbmcubGVuZ3RoIHx8IGVkZ2VzT25QbGFuZS5sZW5ndGggPD0gMSkgewogICAgICAgICAgICByZXN1bHRbY3VycmVudFBvbHlnb25dID0gcG9zaXRpb25zOwogICAgICAgICAgICArK2N1cnJlbnRQb2x5Z29uOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGVkZ2VzT25QbGFuZS5zb3J0KChhMywgYikgPT4gewogICAgICAgICAgICByZXR1cm4gYTMudGhldGEgLSBiLnRoZXRhOwogICAgICAgICAgfSk7CiAgICAgICAgICBjb25zdCBub3J0aCA9IHBvc2l0aW9uc1swXS56ID49IDA7CiAgICAgICAgICBjdXJyZW50UG9seWdvbiA9IHdpcmVQb2x5Z29uKAogICAgICAgICAgICByZXN1bHQsCiAgICAgICAgICAgIGN1cnJlbnRQb2x5Z29uLAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIGVkZ2VzT25QbGFuZSwKICAgICAgICAgICAgMSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgbm9ydGgKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkucG9seWdvbnNGcm9tSGllcmFyY2h5ID0gZnVuY3Rpb24ocG9seWdvbkhpZXJhcmNoeSwga2VlcER1cGxpY2F0ZXMsIHByb2plY3RQb2ludHNUbzJELCBzY2FsZVRvRWxsaXBzb2lkU3VyZmFjZSwgZWxsaXBzb2lkLCBzcGxpdFBvbHlnb25zKSB7CiAgICAgICAgY29uc3QgaGllcmFyY2h5ID0gW107CiAgICAgICAgY29uc3QgcG9seWdvbnMgPSBbXTsKICAgICAgICBjb25zdCBxdWV1ZSA9IG5ldyBRdWV1ZV9kZWZhdWx0KCk7CiAgICAgICAgcXVldWUuZW5xdWV1ZShwb2x5Z29uSGllcmFyY2h5KTsKICAgICAgICBsZXQgc3BsaXQgPSBkZWZpbmVkX2RlZmF1bHQoc3BsaXRQb2x5Z29ucyk7CiAgICAgICAgd2hpbGUgKHF1ZXVlLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgY29uc3Qgb3V0ZXJOb2RlID0gcXVldWUuZGVxdWV1ZSgpOwogICAgICAgICAgbGV0IG91dGVyUmluZyA9IG91dGVyTm9kZS5wb3NpdGlvbnM7CiAgICAgICAgICBjb25zdCBob2xlcyA9IG91dGVyTm9kZS5ob2xlczsKICAgICAgICAgIGxldCBpOwogICAgICAgICAgbGV0IGxlbmd0aDsKICAgICAgICAgIGlmIChzY2FsZVRvRWxsaXBzb2lkU3VyZmFjZSkgewogICAgICAgICAgICBsZW5ndGggPSBvdXRlclJpbmcubGVuZ3RoOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShvdXRlclJpbmdbaV0sIG91dGVyUmluZ1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICgha2VlcER1cGxpY2F0ZXMpIHsKICAgICAgICAgICAgb3V0ZXJSaW5nID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgICAgICAgICAgb3V0ZXJSaW5nLAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uLAogICAgICAgICAgICAgIHRydWUKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChvdXRlclJpbmcubGVuZ3RoIDwgMykgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBwb3NpdGlvbnMyRCA9IHByb2plY3RQb2ludHNUbzJEKG91dGVyUmluZyk7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMyRCkpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBob2xlSW5kaWNlcyA9IFtdOwogICAgICAgICAgbGV0IG9yaWdpbmFsV2luZGluZ09yZGVyID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVdpbmRpbmdPcmRlcjJEKAogICAgICAgICAgICBwb3NpdGlvbnMyRAogICAgICAgICAgKTsKICAgICAgICAgIGlmIChvcmlnaW5hbFdpbmRpbmdPcmRlciA9PT0gV2luZGluZ09yZGVyX2RlZmF1bHQuQ0xPQ0tXSVNFKSB7CiAgICAgICAgICAgIHBvc2l0aW9uczJELnJldmVyc2UoKTsKICAgICAgICAgICAgb3V0ZXJSaW5nID0gb3V0ZXJSaW5nLnNsaWNlKCkucmV2ZXJzZSgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNwbGl0KSB7CiAgICAgICAgICAgIHNwbGl0ID0gZmFsc2U7CiAgICAgICAgICAgIGxldCBwb2x5Z29uczIgPSBbb3V0ZXJSaW5nXTsKICAgICAgICAgICAgcG9seWdvbnMyID0gc3BsaXRQb2x5Z29ucyhwb2x5Z29uczIsIHBvbHlnb25zMik7CiAgICAgICAgICAgIGlmIChwb2x5Z29uczIubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgIGZvciAoY29uc3QgcG9zaXRpb25zMiBvZiBwb2x5Z29uczIpIHsKICAgICAgICAgICAgICAgIHF1ZXVlLmVucXVldWUobmV3IFBvbHlnb25IaWVyYXJjaHlfZGVmYXVsdChwb3NpdGlvbnMyLCBob2xlcykpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbGV0IHBvc2l0aW9ucyA9IG91dGVyUmluZy5zbGljZSgpOwogICAgICAgICAgY29uc3QgbnVtQ2hpbGRyZW4gPSBkZWZpbmVkX2RlZmF1bHQoaG9sZXMpID8gaG9sZXMubGVuZ3RoIDogMDsKICAgICAgICAgIGNvbnN0IHBvbHlnb25Ib2xlcyA9IFtdOwogICAgICAgICAgbGV0IGo7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtQ2hpbGRyZW47IGkrKykgewogICAgICAgICAgICBjb25zdCBob2xlID0gaG9sZXNbaV07CiAgICAgICAgICAgIGxldCBob2xlUG9zaXRpb25zID0gaG9sZS5wb3NpdGlvbnM7CiAgICAgICAgICAgIGlmIChzY2FsZVRvRWxsaXBzb2lkU3VyZmFjZSkgewogICAgICAgICAgICAgIGxlbmd0aCA9IGhvbGVQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBsZW5ndGg7ICsraikgewogICAgICAgICAgICAgICAgZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UoaG9sZVBvc2l0aW9uc1tqXSwgaG9sZVBvc2l0aW9uc1tqXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgha2VlcER1cGxpY2F0ZXMpIHsKICAgICAgICAgICAgICBob2xlUG9zaXRpb25zID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgICAgICAgICAgICBob2xlUG9zaXRpb25zLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24sCiAgICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaG9sZVBvc2l0aW9ucy5sZW5ndGggPCAzKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgaG9sZVBvc2l0aW9uczJEID0gcHJvamVjdFBvaW50c1RvMkQoaG9sZVBvc2l0aW9ucyk7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGhvbGVQb3NpdGlvbnMyRCkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvcmlnaW5hbFdpbmRpbmdPcmRlciA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVXaW5kaW5nT3JkZXIyRCgKICAgICAgICAgICAgICBob2xlUG9zaXRpb25zMkQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKG9yaWdpbmFsV2luZGluZ09yZGVyID09PSBXaW5kaW5nT3JkZXJfZGVmYXVsdC5DTE9DS1dJU0UpIHsKICAgICAgICAgICAgICBob2xlUG9zaXRpb25zMkQucmV2ZXJzZSgpOwogICAgICAgICAgICAgIGhvbGVQb3NpdGlvbnMgPSBob2xlUG9zaXRpb25zLnNsaWNlKCkucmV2ZXJzZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBvbHlnb25Ib2xlcy5wdXNoKGhvbGVQb3NpdGlvbnMpOwogICAgICAgICAgICBob2xlSW5kaWNlcy5wdXNoKHBvc2l0aW9ucy5sZW5ndGgpOwogICAgICAgICAgICBwb3NpdGlvbnMgPSBwb3NpdGlvbnMuY29uY2F0KGhvbGVQb3NpdGlvbnMpOwogICAgICAgICAgICBwb3NpdGlvbnMyRCA9IHBvc2l0aW9uczJELmNvbmNhdChob2xlUG9zaXRpb25zMkQpOwogICAgICAgICAgICBsZXQgbnVtR3JhbmRjaGlsZHJlbiA9IDA7CiAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaG9sZS5ob2xlcykpIHsKICAgICAgICAgICAgICBudW1HcmFuZGNoaWxkcmVuID0gaG9sZS5ob2xlcy5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IG51bUdyYW5kY2hpbGRyZW47IGorKykgewogICAgICAgICAgICAgIHF1ZXVlLmVucXVldWUoaG9sZS5ob2xlc1tqXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGhpZXJhcmNoeS5wdXNoKHsKICAgICAgICAgICAgb3V0ZXJSaW5nLAogICAgICAgICAgICBob2xlczogcG9seWdvbkhvbGVzCiAgICAgICAgICB9KTsKICAgICAgICAgIHBvbHlnb25zLnB1c2goewogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIHBvc2l0aW9uczJELAogICAgICAgICAgICBob2xlczogaG9sZUluZGljZXMKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgaGllcmFyY2h5LAogICAgICAgICAgcG9seWdvbnMKICAgICAgICB9OwogICAgICB9OwogICAgICBjb21wdXRlQm91bmRpbmdSZWN0YW5nbGVDYXJ0ZXNpYW4yID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBjb21wdXRlQm91bmRpbmdSZWN0YW5nbGVDYXJ0ZXNpYW4zID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjb21wdXRlQm91bmRpbmdSZWN0YW5nbGVRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBjb21wdXRlQm91bmRpbmdSZWN0YW5nbGVNYXRyaXgzID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZSA9IGZ1bmN0aW9uKHBsYW5lTm9ybWFsLCBwcm9qZWN0UG9pbnRUbzJELCBwb3NpdGlvbnMsIGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgcGxhbmVOb3JtYWwsCiAgICAgICAgICBhbmdsZSwKICAgICAgICAgIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZVF1YXRlcm5pb24KICAgICAgICApOwogICAgICAgIGNvbnN0IHRleHR1cmVNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24oCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZU1hdHJpeDMKICAgICAgICApOwogICAgICAgIGxldCBtaW5YID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIGxldCBtYXhYID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgIGxldCBtaW5ZID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIGxldCBtYXhZID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgcCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBjb21wdXRlQm91bmRpbmdSZWN0YW5nbGVDYXJ0ZXNpYW4zCiAgICAgICAgICApOwogICAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IodGV4dHVyZU1hdHJpeCwgcCwgcCk7CiAgICAgICAgICBjb25zdCBzdCA9IHByb2plY3RQb2ludFRvMkQocCwgY29tcHV0ZUJvdW5kaW5nUmVjdGFuZ2xlQ2FydGVzaWFuMik7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN0KSkgewogICAgICAgICAgICBtaW5YID0gTWF0aC5taW4obWluWCwgc3QueCk7CiAgICAgICAgICAgIG1heFggPSBNYXRoLm1heChtYXhYLCBzdC54KTsKICAgICAgICAgICAgbWluWSA9IE1hdGgubWluKG1pblksIHN0LnkpOwogICAgICAgICAgICBtYXhZID0gTWF0aC5tYXgobWF4WSwgc3QueSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0gbWluWDsKICAgICAgICByZXN1bHQueSA9IG1pblk7CiAgICAgICAgcmVzdWx0LndpZHRoID0gbWF4WCAtIG1pblg7CiAgICAgICAgcmVzdWx0LmhlaWdodCA9IG1heFkgLSBtaW5ZOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zID0gZnVuY3Rpb24oZWxsaXBzb2lkLCBwb2x5Z29uMiwgdGV4dHVyZUNvb3JkaW5hdGVzLCBncmFudWxhcml0eSwgcGVyUG9zaXRpb25IZWlnaHQsIHZlcnRleEZvcm1hdCwgYXJjVHlwZSkgewogICAgICAgIGxldCBpbmRpY2VzID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQudHJpYW5ndWxhdGUocG9seWdvbjIucG9zaXRpb25zMkQsIHBvbHlnb24yLmhvbGVzKTsKICAgICAgICBpZiAoaW5kaWNlcy5sZW5ndGggPCAzKSB7CiAgICAgICAgICBpbmRpY2VzID0gWzAsIDEsIDJdOwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBwb2x5Z29uMi5wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgaGFzVGV4Y29vcmRzID0gZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcyk7CiAgICAgICAgY29uc3QgdGV4Y29vcmRzID0gaGFzVGV4Y29vcmRzID8gdGV4dHVyZUNvb3JkaW5hdGVzLnBvc2l0aW9ucyA6IHZvaWQgMDsKICAgICAgICBpZiAocGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICBjb25zdCBmbGF0dGVuZWRQb3NpdGlvbnMgPSBuZXcgQXJyYXkobGVuZ3RoICogMyk7CiAgICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCBwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgICBmbGF0dGVuZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwLng7CiAgICAgICAgICAgIGZsYXR0ZW5lZFBvc2l0aW9uc1tpbmRleCsrXSA9IHAueTsKICAgICAgICAgICAgZmxhdHRlbmVkUG9zaXRpb25zW2luZGV4KytdID0gcC56OwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgZ2VvbWV0cnlPcHRpb25zID0gewogICAgICAgICAgICBhdHRyaWJ1dGVzOiB7CiAgICAgICAgICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgICB2YWx1ZXM6IGZsYXR0ZW5lZFBvc2l0aW9ucwogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoaGFzVGV4Y29vcmRzKSB7CiAgICAgICAgICAgIGdlb21ldHJ5T3B0aW9ucy5hdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgICAgICAgdmFsdWVzOiBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFja0FycmF5KHRleGNvb3JkcykKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBHZW9tZXRyeV9kZWZhdWx0KGdlb21ldHJ5T3B0aW9ucyk7CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICByZXR1cm4gR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVOb3JtYWwoZ2VvbWV0cnkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdlb21ldHJ5OwogICAgICAgIH0KICAgICAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgICByZXR1cm4gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVN1YmRpdmlzaW9uKAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgaW5kaWNlcywKICAgICAgICAgICAgdGV4Y29vcmRzLAogICAgICAgICAgICBncmFudWxhcml0eQogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICAgICAgcmV0dXJuIFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVSaHVtYkxpbmVTdWJkaXZpc2lvbigKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAgIHRleGNvb3JkcywKICAgICAgICAgICAgZ3JhbnVsYXJpdHkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9OwogICAgICBjb21wdXRlV2FsbFRleGNvb3Jkc1N1YmRpdmlkZWQgPSBbXTsKICAgICAgY29tcHV0ZVdhbGxJbmRpY2VzU3ViZGl2aWRlZCA9IFtdOwogICAgICBwMVNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwMlNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVXYWxsR2VvbWV0cnkgPSBmdW5jdGlvbihwb3NpdGlvbnMsIHRleHR1cmVDb29yZGluYXRlcywgZWxsaXBzb2lkLCBncmFudWxhcml0eSwgcGVyUG9zaXRpb25IZWlnaHQsIGFyY1R5cGUpIHsKICAgICAgICBsZXQgZWRnZVBvc2l0aW9uczsKICAgICAgICBsZXQgdG9wRWRnZUxlbmd0aDsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgcDE7CiAgICAgICAgbGV0IHAyOwogICAgICAgIGxldCB0MTsKICAgICAgICBsZXQgdDI7CiAgICAgICAgbGV0IGVkZ2VUZXhjb29yZHM7CiAgICAgICAgbGV0IHRvcEVkZ2VUZXhjb29yZExlbmd0aDsKICAgICAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGxldCB0ZXh0dXJlSW5kZXggPSAwOwogICAgICAgIGNvbnN0IGhhc1RleGNvb3JkcyA9IGRlZmluZWRfZGVmYXVsdCh0ZXh0dXJlQ29vcmRpbmF0ZXMpOwogICAgICAgIGNvbnN0IHRleGNvb3JkcyA9IGhhc1RleGNvb3JkcyA/IHRleHR1cmVDb29yZGluYXRlcy5wb3NpdGlvbnMgOiB2b2lkIDA7CiAgICAgICAgaWYgKCFwZXJQb3NpdGlvbkhlaWdodCkgewogICAgICAgICAgY29uc3QgbWluRGlzdGFuY2UgPSBNYXRoX2RlZmF1bHQuY2hvcmRMZW5ndGgoCiAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICBlbGxpcHNvaWQubWF4aW11bVJhZGl1cwogICAgICAgICAgKTsKICAgICAgICAgIGxldCBudW1WZXJ0aWNlcyA9IDA7CiAgICAgICAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIG51bVZlcnRpY2VzICs9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlTGluZUNvdW50KAogICAgICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICAgICAgcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdLAogICAgICAgICAgICAgICAgbWluRGlzdGFuY2UKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBudW1WZXJ0aWNlcyArPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZVJodW1iTGluZUNvdW50KAogICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICAgICAgcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdLAogICAgICAgICAgICAgICAgbWluRGlzdGFuY2UKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0b3BFZGdlTGVuZ3RoID0gKG51bVZlcnRpY2VzICsgbGVuZ3RoKSAqIDM7CiAgICAgICAgICBlZGdlUG9zaXRpb25zID0gbmV3IEFycmF5KHRvcEVkZ2VMZW5ndGggKiAyKTsKICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgdG9wRWRnZVRleGNvb3JkTGVuZ3RoID0gKG51bVZlcnRpY2VzICsgbGVuZ3RoKSAqIDI7CiAgICAgICAgICAgIGVkZ2VUZXhjb29yZHMgPSBuZXcgQXJyYXkodG9wRWRnZVRleGNvb3JkTGVuZ3RoICogMik7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcDEgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICAgIHAyID0gcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdOwogICAgICAgICAgICBsZXQgdGVtcFBvc2l0aW9uczsKICAgICAgICAgICAgbGV0IHRlbXBUZXhjb29yZHM7CiAgICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgICB0MSA9IHRleGNvb3Jkc1tpXTsKICAgICAgICAgICAgICB0MiA9IHRleGNvb3Jkc1soaSArIDEpICUgbGVuZ3RoXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgICAgICAgdGVtcFBvc2l0aW9ucyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnkuc3ViZGl2aWRlTGluZSgKICAgICAgICAgICAgICAgIHAxLAogICAgICAgICAgICAgICAgcDIsCiAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZSwKICAgICAgICAgICAgICAgIGNvbXB1dGVXYWxsSW5kaWNlc1N1YmRpdmlkZWQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgICAgIHRlbXBUZXhjb29yZHMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZVRleGNvb3JkTGluZSgKICAgICAgICAgICAgICAgICAgdDEsCiAgICAgICAgICAgICAgICAgIHQyLAogICAgICAgICAgICAgICAgICBwMSwKICAgICAgICAgICAgICAgICAgcDIsCiAgICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICAgICAgICBjb21wdXRlV2FsbFRleGNvb3Jkc1N1YmRpdmlkZWQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICAgICAgICAgIHRlbXBQb3NpdGlvbnMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZVJodW1iTGluZSgKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgIHAxLAogICAgICAgICAgICAgICAgcDIsCiAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZSwKICAgICAgICAgICAgICAgIGNvbXB1dGVXYWxsSW5kaWNlc1N1YmRpdmlkZWQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgICAgIHRlbXBUZXhjb29yZHMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5LnN1YmRpdmlkZVRleGNvb3JkUmh1bWJMaW5lKAogICAgICAgICAgICAgICAgICB0MSwKICAgICAgICAgICAgICAgICAgdDIsCiAgICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgICAgcDEsCiAgICAgICAgICAgICAgICAgIHAyLAogICAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZSwKICAgICAgICAgICAgICAgICAgY29tcHV0ZVdhbGxUZXhjb29yZHNTdWJkaXZpZGVkCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCB0ZW1wUG9zaXRpb25zTGVuZ3RoID0gdGVtcFBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGVtcFBvc2l0aW9uc0xlbmd0aDsgKytqLCArK2luZGV4KSB7CiAgICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleF0gPSB0ZW1wUG9zaXRpb25zW2pdOwogICAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXggKyB0b3BFZGdlTGVuZ3RoXSA9IHRlbXBQb3NpdGlvbnNbal07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleF0gPSBwMi54OwogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4ICsgdG9wRWRnZUxlbmd0aF0gPSBwMi54OwogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4XSA9IHAyLnk7CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXggKyB0b3BFZGdlTGVuZ3RoXSA9IHAyLnk7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXhdID0gcDIuejsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleCArIHRvcEVkZ2VMZW5ndGhdID0gcDIuejsKICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICAgIGNvbnN0IHRlbXBUZXhjb29yZHNMZW5ndGggPSB0ZW1wVGV4Y29vcmRzLmxlbmd0aDsKICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IHRlbXBUZXhjb29yZHNMZW5ndGg7ICsraywgKyt0ZXh0dXJlSW5kZXgpIHsKICAgICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4XSA9IHRlbXBUZXhjb29yZHNba107CiAgICAgICAgICAgICAgICBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleCArIHRvcEVkZ2VUZXhjb29yZExlbmd0aF0gPSB0ZW1wVGV4Y29vcmRzW2tdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleF0gPSB0Mi54OwogICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4ICsgdG9wRWRnZVRleGNvb3JkTGVuZ3RoXSA9IHQyLng7CiAgICAgICAgICAgICAgKyt0ZXh0dXJlSW5kZXg7CiAgICAgICAgICAgICAgZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXhdID0gdDIueTsKICAgICAgICAgICAgICBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleCArIHRvcEVkZ2VUZXhjb29yZExlbmd0aF0gPSB0Mi55OwogICAgICAgICAgICAgICsrdGV4dHVyZUluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRvcEVkZ2VMZW5ndGggPSBsZW5ndGggKiAzICogMjsKICAgICAgICAgIGVkZ2VQb3NpdGlvbnMgPSBuZXcgQXJyYXkodG9wRWRnZUxlbmd0aCAqIDIpOwogICAgICAgICAgaWYgKGhhc1RleGNvb3JkcykgewogICAgICAgICAgICB0b3BFZGdlVGV4Y29vcmRMZW5ndGggPSBsZW5ndGggKiAyICogMjsKICAgICAgICAgICAgZWRnZVRleGNvb3JkcyA9IG5ldyBBcnJheSh0b3BFZGdlVGV4Y29vcmRMZW5ndGggKiAyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBwMSA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgICAgcDIgPSBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF07CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXhdID0gZWRnZVBvc2l0aW9uc1tpbmRleCArIHRvcEVkZ2VMZW5ndGhdID0gcDEueDsKICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleF0gPSBlZGdlUG9zaXRpb25zW2luZGV4ICsgdG9wRWRnZUxlbmd0aF0gPSBwMS55OwogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4XSA9IGVkZ2VQb3NpdGlvbnNbaW5kZXggKyB0b3BFZGdlTGVuZ3RoXSA9IHAxLno7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIGVkZ2VQb3NpdGlvbnNbaW5kZXhdID0gZWRnZVBvc2l0aW9uc1tpbmRleCArIHRvcEVkZ2VMZW5ndGhdID0gcDIueDsKICAgICAgICAgICAgKytpbmRleDsKICAgICAgICAgICAgZWRnZVBvc2l0aW9uc1tpbmRleF0gPSBlZGdlUG9zaXRpb25zW2luZGV4ICsgdG9wRWRnZUxlbmd0aF0gPSBwMi55OwogICAgICAgICAgICArK2luZGV4OwogICAgICAgICAgICBlZGdlUG9zaXRpb25zW2luZGV4XSA9IGVkZ2VQb3NpdGlvbnNbaW5kZXggKyB0b3BFZGdlTGVuZ3RoXSA9IHAyLno7CiAgICAgICAgICAgICsraW5kZXg7CiAgICAgICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgICAgICB0MSA9IHRleGNvb3Jkc1tpXTsKICAgICAgICAgICAgICB0MiA9IHRleGNvb3Jkc1soaSArIDEpICUgbGVuZ3RoXTsKICAgICAgICAgICAgICBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleF0gPSBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleCArIHRvcEVkZ2VUZXhjb29yZExlbmd0aF0gPSB0MS54OwogICAgICAgICAgICAgICsrdGV4dHVyZUluZGV4OwogICAgICAgICAgICAgIGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4XSA9IGVkZ2VUZXhjb29yZHNbdGV4dHVyZUluZGV4ICsgdG9wRWRnZVRleGNvb3JkTGVuZ3RoXSA9IHQxLnk7CiAgICAgICAgICAgICAgKyt0ZXh0dXJlSW5kZXg7CiAgICAgICAgICAgICAgZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXhdID0gZWRnZVRleGNvb3Jkc1t0ZXh0dXJlSW5kZXggKyB0b3BFZGdlVGV4Y29vcmRMZW5ndGhdID0gdDIueDsKICAgICAgICAgICAgICArK3RleHR1cmVJbmRleDsKICAgICAgICAgICAgICBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleF0gPSBlZGdlVGV4Y29vcmRzW3RleHR1cmVJbmRleCArIHRvcEVkZ2VUZXhjb29yZExlbmd0aF0gPSB0Mi55OwogICAgICAgICAgICAgICsrdGV4dHVyZUluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxlbmd0aCA9IGVkZ2VQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgICAgIGxlbmd0aCAvIDMsCiAgICAgICAgICBsZW5ndGggLSBwb3NpdGlvbnMubGVuZ3RoICogNgogICAgICAgICk7CiAgICAgICAgbGV0IGVkZ2VJbmRleCA9IDA7CiAgICAgICAgbGVuZ3RoIC89IDY7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBVTCA9IGk7CiAgICAgICAgICBjb25zdCBVUiA9IFVMICsgMTsKICAgICAgICAgIGNvbnN0IExMID0gVUwgKyBsZW5ndGg7CiAgICAgICAgICBjb25zdCBMUiA9IExMICsgMTsKICAgICAgICAgIHAxID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShlZGdlUG9zaXRpb25zLCBVTCAqIDMsIHAxU2NyYXRjaDIpOwogICAgICAgICAgcDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGVkZ2VQb3NpdGlvbnMsIFVSICogMywgcDJTY3JhdGNoMik7CiAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICAgIHAxLAogICAgICAgICAgICBwMiwKICAgICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCwKICAgICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xMAogICAgICAgICAgKSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gVUw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IExMOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBVUjsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gVVI7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IExMOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBMUjsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cnlPcHRpb25zID0gewogICAgICAgICAgYXR0cmlidXRlczogbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KHsKICAgICAgICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IGVkZ2VQb3NpdGlvbnMKICAgICAgICAgICAgfSkKICAgICAgICAgIH0pLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMKICAgICAgICB9OwogICAgICAgIGlmIChoYXNUZXhjb29yZHMpIHsKICAgICAgICAgIGdlb21ldHJ5T3B0aW9ucy5hdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICAgICAgdmFsdWVzOiBlZGdlVGV4Y29vcmRzCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgR2VvbWV0cnlfZGVmYXVsdChnZW9tZXRyeU9wdGlvbnMpOwogICAgICAgIHJldHVybiBnZW9tZXRyeTsKICAgICAgfTsKICAgICAgUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvcGxhbmFyUG9seWdvbkdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gY3JlYXRlR2VvbWV0cnlGcm9tUG9seWdvbihwb2x5Z29uMiwgdmVydGV4Rm9ybWF0LCBib3VuZGluZ1JlY3RhbmdsZSwgc3RSb3RhdGlvbiwgaGFyZGNvZGVkVGV4dHVyZUNvb3JkaW5hdGVzLCBwcm9qZWN0UG9pbnRUbzJELCBub3JtYWwyLCB0YW5nZW50LCBiaXRhbmdlbnQpIHsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IHBvbHlnb24yLnBvc2l0aW9uczsKICAgIGxldCBpbmRpY2VzID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQudHJpYW5ndWxhdGUocG9seWdvbjIucG9zaXRpb25zMkQsIHBvbHlnb24yLmhvbGVzKTsKICAgIGlmIChpbmRpY2VzLmxlbmd0aCA8IDMpIHsKICAgICAgaW5kaWNlcyA9IFswLCAxLCAyXTsKICAgIH0KICAgIGNvbnN0IG5ld0luZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgcG9zaXRpb25zLmxlbmd0aCwKICAgICAgaW5kaWNlcy5sZW5ndGgKICAgICk7CiAgICBuZXdJbmRpY2VzLnNldChpbmRpY2VzKTsKICAgIGxldCB0ZXh0dXJlTWF0cml4ID0gdGV4dHVyZU1hdHJpeFNjcmF0Y2gyOwogICAgaWYgKHN0Um90YXRpb24gIT09IDApIHsKICAgICAgbGV0IHJvdGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmZyb21BeGlzQW5nbGUoCiAgICAgICAgbm9ybWFsMiwKICAgICAgICBzdFJvdGF0aW9uLAogICAgICAgIHF1YXRlcm5pb25TY3JhdGNoMgogICAgICApOwogICAgICB0ZXh0dXJlTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKHJvdGF0aW9uLCB0ZXh0dXJlTWF0cml4KTsKICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICByb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgIC1zdFJvdGF0aW9uLAogICAgICAgICAgcXVhdGVybmlvblNjcmF0Y2gyCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0YW5nZW50Um90YXRpb24gPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24oCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIHRhbmdlbnRSb3RhdGlvblNjcmF0Y2gKICAgICAgICApOwogICAgICAgIHRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IodGFuZ2VudFJvdGF0aW9uLCB0YW5nZW50LCB0YW5nZW50KSwKICAgICAgICAgIHRhbmdlbnQKICAgICAgICApOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBiaXRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Mobm9ybWFsMiwgdGFuZ2VudCwgYml0YW5nZW50KSwKICAgICAgICAgICAgYml0YW5nZW50CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGV4dHVyZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5jbG9uZShNYXRyaXgzX2RlZmF1bHQuSURFTlRJVFksIHRleHR1cmVNYXRyaXgpOwogICAgfQogICAgY29uc3Qgc3RPcmlnaW4gPSB0ZXh0dXJlQ29vcmRpbmF0ZXNPcmlnaW47CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIHN0T3JpZ2luLnggPSBib3VuZGluZ1JlY3RhbmdsZS54OwogICAgICBzdE9yaWdpbi55ID0gYm91bmRpbmdSZWN0YW5nbGUueTsKICAgIH0KICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICBjb25zdCBzaXplID0gbGVuZ3RoICogMzsKICAgIGNvbnN0IGZsYXRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHNpemUpOwogICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUpIDogdm9pZCAwOwogICAgY29uc3QgdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSkgOiB2b2lkIDA7CiAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSkgOiB2b2lkIDA7CiAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSB2ZXJ0ZXhGb3JtYXQuc3QgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCAqIDIpIDogdm9pZCAwOwogICAgbGV0IHBvc2l0aW9uSW5kZXggPSAwOwogICAgbGV0IG5vcm1hbEluZGV4ID0gMDsKICAgIGxldCBiaXRhbmdlbnRJbmRleCA9IDA7CiAgICBsZXQgdGFuZ2VudEluZGV4ID0gMDsKICAgIGxldCBzdEluZGV4ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcG9zaXRpb24gPSBwb3NpdGlvbnNbaV07CiAgICAgIGZsYXRQb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgIGZsYXRQb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgIGZsYXRQb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGhhcmRjb2RlZFRleHR1cmVDb29yZGluYXRlcykgJiYgaGFyZGNvZGVkVGV4dHVyZUNvb3JkaW5hdGVzLnBvc2l0aW9ucy5sZW5ndGggPT09IGxlbmd0aCkgewogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBoYXJkY29kZWRUZXh0dXJlQ29vcmRpbmF0ZXMucG9zaXRpb25zW2ldLng7CiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IGhhcmRjb2RlZFRleHR1cmVDb29yZGluYXRlcy5wb3NpdGlvbnNbaV0ueTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgcCA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKAogICAgICAgICAgICB0ZXh0dXJlTWF0cml4LAogICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgc2NyYXRjaFBvc2l0aW9uCiAgICAgICAgICApOwogICAgICAgICAgY29uc3Qgc3QgPSBwcm9qZWN0UG9pbnRUbzJEKHAsIHN0U2NyYXRjaCk7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuc3VidHJhY3Qoc3QsIHN0T3JpZ2luLCBzdCk7CiAgICAgICAgICBjb25zdCBzdHggPSBNYXRoX2RlZmF1bHQuY2xhbXAoc3QueCAvIGJvdW5kaW5nUmVjdGFuZ2xlLndpZHRoLCAwLCAxKTsKICAgICAgICAgIGNvbnN0IHN0eSA9IE1hdGhfZGVmYXVsdC5jbGFtcChzdC55IC8gYm91bmRpbmdSZWN0YW5nbGUuaGVpZ2h0LCAwLCAxKTsKICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gc3R4OwogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzdHk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi55OwogICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lno7CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgfQogICAgfQogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogZmxhdFBvc2l0aW9ucwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBub3JtYWxzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgIGF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogdGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgIHZhbHVlczogdGV4dHVyZUNvb3JkaW5hdGVzCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgYXR0cmlidXRlcywKICAgICAgaW5kaWNlczogbmV3SW5kaWNlcywKICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IG9wdGlvbnMucG9seWdvbkhpZXJhcmNoeTsKICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlcyA9IG9wdGlvbnMudGV4dHVyZUNvb3JkaW5hdGVzOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLnBvbHlnb25IaWVyYXJjaHkiLCBwb2x5Z29uSGllcmFyY2h5KTsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKTsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCk7CiAgICB0aGlzLl9wb2x5Z29uSGllcmFyY2h5ID0gcG9seWdvbkhpZXJhcmNoeTsKICAgIHRoaXMuX3N0Um90YXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnN0Um90YXRpb24sIDApOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoCiAgICAgIGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCkKICAgICk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5IjsKICAgIHRoaXMuX3RleHR1cmVDb29yZGluYXRlcyA9IHRleHR1cmVDb29yZGluYXRlczsKICAgIHRoaXMucGFja2VkTGVuZ3RoID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVIaWVyYXJjaHlQYWNrZWRMZW5ndGgoCiAgICAgIHBvbHlnb25IaWVyYXJjaHksCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdAogICAgKSArIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIChkZWZpbmVkX2RlZmF1bHQodGV4dHVyZUNvb3JkaW5hdGVzKSA/IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlSGllcmFyY2h5UGFja2VkTGVuZ3RoKAogICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXMsCiAgICAgIENhcnRlc2lhbjJfZGVmYXVsdAogICAgKSA6IDEpICsgMjsKICB9CiAgdmFyIHNjcmF0Y2hQb3NpdGlvbiwgc2NyYXRjaEJSLCBzdFNjcmF0Y2gsIHRleHR1cmVDb29yZGluYXRlc09yaWdpbiwgc2NyYXRjaE5vcm1hbDQsIHNjcmF0Y2hUYW5nZW50Miwgc2NyYXRjaEJpdGFuZ2VudDIsIGNlbnRlclNjcmF0Y2gsIGF4aXMxU2NyYXRjaCwgYXhpczJTY3JhdGNoLCBxdWF0ZXJuaW9uU2NyYXRjaDIsIHRleHR1cmVNYXRyaXhTY3JhdGNoMiwgdGFuZ2VudFJvdGF0aW9uU2NyYXRjaCwgc3VyZmFjZU5vcm1hbFNjcmF0Y2gsIHNjcmF0Y2hFbGxpcHNvaWQzLCBzY3JhdGNoVmVydGV4Rm9ybWF0Mywgc2NyYXRjaE9wdGlvbnM3LCBDb3BsYW5hclBvbHlnb25HZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0NvcGxhbmFyUG9seWdvbkdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3BsYW5hclBvbHlnb25HZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQm91bmRpbmdSZWN0YW5nbGUoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X0NvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlJbnN0YW5jZSgpOwogICAgICBpbml0X0dlb21ldHJ5UGlwZWxpbmUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9Qb2x5Z29uR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgc2NyYXRjaFBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQlIgPSBuZXcgQm91bmRpbmdSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBzdFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIHRleHR1cmVDb29yZGluYXRlc09yaWdpbiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5vcm1hbDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hUYW5nZW50MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEJpdGFuZ2VudDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNlbnRlclNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGF4aXMxU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYXhpczJTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBxdWF0ZXJuaW9uU2NyYXRjaDIgPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIHRleHR1cmVNYXRyaXhTY3JhdGNoMiA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgdGFuZ2VudFJvdGF0aW9uU2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgc3VyZmFjZU5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5LmZyb21Qb3NpdGlvbnMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLnBvc2l0aW9ucyIsIG9wdGlvbnMucG9zaXRpb25zKTsKICAgICAgICBjb25zdCBuZXdPcHRpb25zID0gewogICAgICAgICAgcG9seWdvbkhpZXJhcmNoeTogewogICAgICAgICAgICBwb3NpdGlvbnM6IG9wdGlvbnMucG9zaXRpb25zCiAgICAgICAgICB9LAogICAgICAgICAgdmVydGV4Rm9ybWF0OiBvcHRpb25zLnZlcnRleEZvcm1hdCwKICAgICAgICAgIHN0Um90YXRpb246IG9wdGlvbnMuc3RSb3RhdGlvbiwKICAgICAgICAgIGVsbGlwc29pZDogb3B0aW9ucy5lbGxpcHNvaWQsCiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXM6IG9wdGlvbnMudGV4dHVyZUNvb3JkaW5hdGVzCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gbmV3IENvcGxhbmFyUG9seWdvbkdlb21ldHJ5KG5ld09wdGlvbnMpOwogICAgICB9OwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgdmFsdWUuX3BvbHlnb25IaWVyYXJjaHksCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICAgICApOwogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2sodmFsdWUuX3ZlcnRleEZvcm1hdCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc3RSb3RhdGlvbjsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHZhbHVlLl90ZXh0dXJlQ29vcmRpbmF0ZXMpKSB7CiAgICAgICAgICBzdGFydGluZ0luZGV4ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgICB2YWx1ZS5fdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgICAgICBhcnJheSwKICAgICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0CiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gLTE7CiAgICAgICAgfQogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5wYWNrZWRMZW5ndGg7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkMyA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDMgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnM3ID0gewogICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHt9CiAgICAgIH07CiAgICAgIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnVucGFja1BvbHlnb25IaWVyYXJjaHkoCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBwb2x5Z29uSGllcmFyY2h5LnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgZGVsZXRlIHBvbHlnb25IaWVyYXJjaHkuc3RhcnRpbmdJbmRleDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQzKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MwogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3Qgc3RSb3RhdGlvbiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gYXJyYXlbc3RhcnRpbmdJbmRleF0gPT09IC0xID8gdm9pZCAwIDogUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnVucGFja1BvbHlnb25IaWVyYXJjaHkoCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQKICAgICAgICApOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGV4dHVyZUNvb3JkaW5hdGVzKSkgewogICAgICAgICAgc3RhcnRpbmdJbmRleCA9IHRleHR1cmVDb29yZGluYXRlcy5zdGFydGluZ0luZGV4OwogICAgICAgICAgZGVsZXRlIHRleHR1cmVDb29yZGluYXRlcy5zdGFydGluZ0luZGV4OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdGFydGluZ0luZGV4Kys7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBhY2tlZExlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENvcGxhbmFyUG9seWdvbkdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zNyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25IaWVyYXJjaHk7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCwgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQpOwogICAgICAgIHJlc3VsdC5fc3RSb3RhdGlvbiA9IHN0Um90YXRpb247CiAgICAgICAgcmVzdWx0Ll90ZXh0dXJlQ29vcmRpbmF0ZXMgPSB0ZXh0dXJlQ29vcmRpbmF0ZXM7CiAgICAgICAgcmVzdWx0LnBhY2tlZExlbmd0aCA9IHBhY2tlZExlbmd0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHBvbHlnb25HZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IHBvbHlnb25HZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGNvbnN0IHBvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uR2VvbWV0cnkuX3BvbHlnb25IaWVyYXJjaHk7CiAgICAgICAgY29uc3Qgc3RSb3RhdGlvbiA9IHBvbHlnb25HZW9tZXRyeS5fc3RSb3RhdGlvbjsKICAgICAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSBwb2x5Z29uR2VvbWV0cnkuX3RleHR1cmVDb29yZGluYXRlczsKICAgICAgICBjb25zdCBoYXNUZXh0dXJlQ29vcmRpbmF0ZXMgPSBkZWZpbmVkX2RlZmF1bHQodGV4dHVyZUNvb3JkaW5hdGVzKTsKICAgICAgICBsZXQgb3V0ZXJQb3NpdGlvbnMgPSBwb2x5Z29uSGllcmFyY2h5LnBvc2l0aW9uczsKICAgICAgICBvdXRlclBvc2l0aW9ucyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICAgICAgb3V0ZXJQb3NpdGlvbnMsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbiwKICAgICAgICAgIHRydWUKICAgICAgICApOwogICAgICAgIGlmIChvdXRlclBvc2l0aW9ucy5sZW5ndGggPCAzKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGxldCBub3JtYWwyID0gc2NyYXRjaE5vcm1hbDQ7CiAgICAgICAgbGV0IHRhbmdlbnQgPSBzY3JhdGNoVGFuZ2VudDI7CiAgICAgICAgbGV0IGJpdGFuZ2VudCA9IHNjcmF0Y2hCaXRhbmdlbnQyOwogICAgICAgIGxldCBheGlzMSA9IGF4aXMxU2NyYXRjaDsKICAgICAgICBjb25zdCBheGlzMiA9IGF4aXMyU2NyYXRjaDsKICAgICAgICBjb25zdCB2YWxpZEdlb21ldHJ5ID0gQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVByb2plY3RUbzJEQXJndW1lbnRzKAogICAgICAgICAgb3V0ZXJQb3NpdGlvbnMsCiAgICAgICAgICBjZW50ZXJTY3JhdGNoLAogICAgICAgICAgYXhpczEsCiAgICAgICAgICBheGlzMgogICAgICAgICk7CiAgICAgICAgaWYgKCF2YWxpZEdlb21ldHJ5KSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGF4aXMxLCBheGlzMiwgbm9ybWFsMik7CiAgICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgaWYgKCFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIGNlbnRlclNjcmF0Y2gsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9ONgogICAgICAgICkpIHsKICAgICAgICAgIGNvbnN0IHN1cmZhY2VOb3JtYWwgPSBwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICAgIGNlbnRlclNjcmF0Y2gsCiAgICAgICAgICAgIHN1cmZhY2VOb3JtYWxTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgc3VyZmFjZU5vcm1hbCkgPCAwKSB7CiAgICAgICAgICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgICAgICBheGlzMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoYXhpczEsIGF4aXMxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgcHJvamVjdFBvaW50cyA9IENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNyZWF0ZVByb2plY3RQb2ludHNUbzJERnVuY3Rpb24oCiAgICAgICAgICBjZW50ZXJTY3JhdGNoLAogICAgICAgICAgYXhpczEsCiAgICAgICAgICBheGlzMgogICAgICAgICk7CiAgICAgICAgY29uc3QgcHJvamVjdFBvaW50ID0gQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY3JlYXRlUHJvamVjdFBvaW50VG8yREZ1bmN0aW9uKAogICAgICAgICAgY2VudGVyU2NyYXRjaCwKICAgICAgICAgIGF4aXMxLAogICAgICAgICAgYXhpczIKICAgICAgICApOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShheGlzMSwgdGFuZ2VudCk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBiaXRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoYXhpczIsIGJpdGFuZ2VudCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlc3VsdHMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucG9seWdvbnNGcm9tSGllcmFyY2h5KAogICAgICAgICAgcG9seWdvbkhpZXJhcmNoeSwKICAgICAgICAgIGhhc1RleHR1cmVDb29yZGluYXRlcywKICAgICAgICAgIHByb2plY3RQb2ludHMsCiAgICAgICAgICBmYWxzZQogICAgICAgICk7CiAgICAgICAgY29uc3QgaGllcmFyY2h5ID0gcmVzdWx0cy5oaWVyYXJjaHk7CiAgICAgICAgY29uc3QgcG9seWdvbnMgPSByZXN1bHRzLnBvbHlnb25zOwogICAgICAgIGNvbnN0IGR1bW15RnVuY3Rpb24gPSBmdW5jdGlvbihpZGVudGl0eSkgewogICAgICAgICAgcmV0dXJuIGlkZW50aXR5OwogICAgICAgIH07CiAgICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVQb2x5Z29ucyA9IGhhc1RleHR1cmVDb29yZGluYXRlcyA/IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wb2x5Z29uc0Zyb21IaWVyYXJjaHkoCiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXMsCiAgICAgICAgICB0cnVlLAogICAgICAgICAgZHVtbXlGdW5jdGlvbiwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKS5wb2x5Z29ucyA6IHZvaWQgMDsKICAgICAgICBpZiAoaGllcmFyY2h5Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBvdXRlclBvc2l0aW9ucyA9IGhpZXJhcmNoeVswXS5vdXRlclJpbmc7CiAgICAgICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21Qb2ludHMob3V0ZXJQb3NpdGlvbnMpOwogICAgICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZSgKICAgICAgICAgIG5vcm1hbDIsCiAgICAgICAgICBwcm9qZWN0UG9pbnQsCiAgICAgICAgICBvdXRlclBvc2l0aW9ucywKICAgICAgICAgIHN0Um90YXRpb24sCiAgICAgICAgICBzY3JhdGNoQlIKICAgICAgICApOwogICAgICAgIGNvbnN0IGdlb21ldHJpZXMgPSBbXTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvbHlnb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBnZW9tZXRyeUluc3RhbmNlID0gbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgICAgIGdlb21ldHJ5OiBjcmVhdGVHZW9tZXRyeUZyb21Qb2x5Z29uKAogICAgICAgICAgICAgIHBvbHlnb25zW2ldLAogICAgICAgICAgICAgIHZlcnRleEZvcm1hdCwKICAgICAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZSwKICAgICAgICAgICAgICBzdFJvdGF0aW9uLAogICAgICAgICAgICAgIGhhc1RleHR1cmVDb29yZGluYXRlcyA/IHRleHR1cmVDb29yZGluYXRlUG9seWdvbnNbaV0gOiB2b2lkIDAsCiAgICAgICAgICAgICAgcHJvamVjdFBvaW50LAogICAgICAgICAgICAgIG5vcm1hbDIsCiAgICAgICAgICAgICAgdGFuZ2VudCwKICAgICAgICAgICAgICBiaXRhbmdlbnQKICAgICAgICAgICAgKQogICAgICAgICAgfSk7CiAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goZ2VvbWV0cnlJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmNvbWJpbmVJbnN0YW5jZXMoZ2VvbWV0cmllcylbMF07CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBuZXcgRmxvYXQ2NEFycmF5KAogICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMKICAgICAgICApOwogICAgICAgIGdlb21ldHJ5LmluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCAvIDMsCiAgICAgICAgICBnZW9tZXRyeS5pbmRpY2VzCiAgICAgICAgKTsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICBpZiAoIXZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgZGVsZXRlIGF0dHJpYnV0ZXMucG9zaXRpb247CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlczogZ2VvbWV0cnkuaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBDb3BsYW5hclBvbHlnb25HZW9tZXRyeV9kZWZhdWx0ID0gQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeS5qcwogIHZhciBjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5KHBvbHlnb25HZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcG9seWdvbkdlb21ldHJ5ID0gQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlfZGVmYXVsdC51bnBhY2socG9seWdvbkdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIENvcGxhbmFyUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkocG9seWdvbkdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Db3BsYW5hclBvbHlnb25HZW9tZXRyeSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zKHBvc2l0aW9ucykgewogICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IGZsYXRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCAqIDMpOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KGxlbmd0aCwgbGVuZ3RoICogMik7CiAgICBsZXQgcG9zaXRpb25JbmRleCA9IDA7CiAgICBsZXQgaW5kZXggPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBjb25zdCBwb3NpdGlvbiA9IHBvc2l0aW9uc1tpXTsKICAgICAgZmxhdFBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgZmxhdFBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgZmxhdFBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gcG9zaXRpb24uejsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSAoaSArIDEpICUgbGVuZ3RoOwogICAgfQogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgIHBvc2l0aW9uOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBmbGF0UG9zaXRpb25zCiAgICAgIH0pCiAgICB9KTsKICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMsCiAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUwogICAgfSk7CiAgfQogIGZ1bmN0aW9uIENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHBvbHlnb25IaWVyYXJjaHkgPSBvcHRpb25zLnBvbHlnb25IaWVyYXJjaHk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSIsIHBvbHlnb25IaWVyYXJjaHkpOwogICAgdGhpcy5fcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25IaWVyYXJjaHk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeSI7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlSGllcmFyY2h5UGFja2VkTGVuZ3RoKAogICAgICBwb2x5Z29uSGllcmFyY2h5LAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICkgKyAxOwogIH0KICB2YXIgc2NyYXRjaE9wdGlvbnM4LCBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Db3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X0NvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlJbnN0YW5jZSgpOwogICAgICBpbml0X0dlb21ldHJ5UGlwZWxpbmUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfUG9seWdvbkdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmZyb21Qb3NpdGlvbnMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLnBvc2l0aW9ucyIsIG9wdGlvbnMucG9zaXRpb25zKTsKICAgICAgICBjb25zdCBuZXdPcHRpb25zID0gewogICAgICAgICAgcG9seWdvbkhpZXJhcmNoeTogewogICAgICAgICAgICBwb3NpdGlvbnM6IG9wdGlvbnMucG9zaXRpb25zCiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gbmV3IENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeShuZXdPcHRpb25zKTsKICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucGFja1BvbHlnb25IaWVyYXJjaHkoCiAgICAgICAgICB2YWx1ZS5fcG9seWdvbkhpZXJhcmNoeSwKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdAogICAgICAgICk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5wYWNrZWRMZW5ndGg7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoT3B0aW9uczggPSB7CiAgICAgICAgcG9seWdvbkhpZXJhcmNoeToge30KICAgICAgfTsKICAgICAgQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnVucGFja1BvbHlnb25IaWVyYXJjaHkoCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBwb2x5Z29uSGllcmFyY2h5LnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgZGVsZXRlIHBvbHlnb25IaWVyYXJjaHkuc3RhcnRpbmdJbmRleDsKICAgICAgICBjb25zdCBwYWNrZWRMZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zOCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25IaWVyYXJjaHk7CiAgICAgICAgcmVzdWx0LnBhY2tlZExlbmd0aCA9IHBhY2tlZExlbmd0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihwb2x5Z29uR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gcG9seWdvbkdlb21ldHJ5Ll9wb2x5Z29uSGllcmFyY2h5OwogICAgICAgIGxldCBvdXRlclBvc2l0aW9ucyA9IHBvbHlnb25IaWVyYXJjaHkucG9zaXRpb25zOwogICAgICAgIG91dGVyUG9zaXRpb25zID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgICAgICBvdXRlclBvc2l0aW9ucywKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uLAogICAgICAgICAgdHJ1ZQogICAgICAgICk7CiAgICAgICAgaWYgKG91dGVyUG9zaXRpb25zLmxlbmd0aCA8IDMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgaXNWYWxpZCA9IENvcGxhbmFyUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnZhbGlkT3V0bGluZShvdXRlclBvc2l0aW9ucyk7CiAgICAgICAgaWYgKCFpc1ZhbGlkKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCBwb2x5Z29ucyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wb2x5Z29uT3V0bGluZXNGcm9tSGllcmFyY2h5KAogICAgICAgICAgcG9seWdvbkhpZXJhcmNoeSwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBpZiAocG9seWdvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBjb25zdCBnZW9tZXRyaWVzID0gW107CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb2x5Z29ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgZ2VvbWV0cnlJbnN0YW5jZSA9IG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgICAgICBnZW9tZXRyeTogY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zKHBvbHlnb25zW2ldKQogICAgICAgICAgfSk7CiAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goZ2VvbWV0cnlJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmNvbWJpbmVJbnN0YW5jZXMoZ2VvbWV0cmllcylbMF07CiAgICAgICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21Qb2ludHMocG9seWdvbkhpZXJhcmNoeS5wb3NpdGlvbnMpOwogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzOiBnZW9tZXRyeS5hdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlczogZ2VvbWV0cnkuaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeShwb2x5Z29uR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHBvbHlnb25HZW9tZXRyeSA9IENvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICBwb2x5Z29uR2VvbWV0cnksCiAgICAgICAgb2Zmc2V0CiAgICAgICk7CiAgICB9CiAgICBwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBvbHlnb25HZW9tZXRyeS5fZWxsaXBzb2lkKTsKICAgIHJldHVybiBDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShwb2x5Z29uR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0NvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3JuZXJUeXBlLmpzCiAgdmFyIENvcm5lclR5cGUsIENvcm5lclR5cGVfZGVmYXVsdDsKICB2YXIgaW5pdF9Db3JuZXJUeXBlID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3JuZXJUeXBlLmpzIigpIHsKICAgICAgQ29ybmVyVHlwZSA9IHsKICAgICAgICAvKioKICAgICAgICAgKiA8aW1nIHNyYz0iSW1hZ2VzL0Nvcm5lclR5cGVSb3VuZGVkLnBuZyIgc3R5bGU9InZlcnRpY2FsLWFsaWduOiBtaWRkbGU7IiB3aWR0aD0iMTg2IiBoZWlnaHQ9IjE4OSIgLz4KICAgICAgICAgKgogICAgICAgICAqIENvcm5lciBoYXMgYSBzbW9vdGggZWRnZS4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJPVU5ERUQ6IDAsCiAgICAgICAgLyoqCiAgICAgICAgICogPGltZyBzcmM9IkltYWdlcy9Db3JuZXJUeXBlTWl0ZXJlZC5wbmciIHN0eWxlPSJ2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlOyIgd2lkdGg9IjE4NiIgaGVpZ2h0PSIxODkiIC8+CiAgICAgICAgICoKICAgICAgICAgKiBDb3JuZXIgcG9pbnQgaXMgdGhlIGludGVyc2VjdGlvbiBvZiBhZGphY2VudCBlZGdlcy4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE1JVEVSRUQ6IDEsCiAgICAgICAgLyoqCiAgICAgICAgICogPGltZyBzcmM9IkltYWdlcy9Db3JuZXJUeXBlQmV2ZWxlZC5wbmciIHN0eWxlPSJ2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlOyIgd2lkdGg9IjE4NiIgaGVpZ2h0PSIxODkiIC8+CiAgICAgICAgICoKICAgICAgICAgKiBDb3JuZXIgaXMgY2xpcHBlZC4KICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEJFVkVMRUQ6IDIKICAgICAgfTsKICAgICAgQ29ybmVyVHlwZV9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShDb3JuZXJUeXBlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZEdlb2Rlc2ljLmpzCiAgZnVuY3Rpb24gc2V0Q29uc3RhbnRzKGVsbGlwc29pZEdlb2Rlc2ljMikgewogICAgY29uc3QgdVNxdWFyZWQgPSBlbGxpcHNvaWRHZW9kZXNpYzIuX3VTcXVhcmVkOwogICAgY29uc3QgYTMgPSBlbGxpcHNvaWRHZW9kZXNpYzIuX2VsbGlwc29pZC5tYXhpbXVtUmFkaXVzOwogICAgY29uc3QgYiA9IGVsbGlwc29pZEdlb2Rlc2ljMi5fZWxsaXBzb2lkLm1pbmltdW1SYWRpdXM7CiAgICBjb25zdCBmID0gKGEzIC0gYikgLyBhMzsKICAgIGNvbnN0IGNvc2luZUhlYWRpbmcgPSBNYXRoLmNvcyhlbGxpcHNvaWRHZW9kZXNpYzIuX3N0YXJ0SGVhZGluZyk7CiAgICBjb25zdCBzaW5lSGVhZGluZyA9IE1hdGguc2luKGVsbGlwc29pZEdlb2Rlc2ljMi5fc3RhcnRIZWFkaW5nKTsKICAgIGNvbnN0IHRhblUgPSAoMSAtIGYpICogTWF0aC50YW4oZWxsaXBzb2lkR2VvZGVzaWMyLl9zdGFydC5sYXRpdHVkZSk7CiAgICBjb25zdCBjb3NpbmVVID0gMSAvIE1hdGguc3FydCgxICsgdGFuVSAqIHRhblUpOwogICAgY29uc3Qgc2luZVUgPSBjb3NpbmVVICogdGFuVTsKICAgIGNvbnN0IHNpZ21hID0gTWF0aC5hdGFuMih0YW5VLCBjb3NpbmVIZWFkaW5nKTsKICAgIGNvbnN0IHNpbmVBbHBoYSA9IGNvc2luZVUgKiBzaW5lSGVhZGluZzsKICAgIGNvbnN0IHNpbmVTcXVhcmVkQWxwaGEgPSBzaW5lQWxwaGEgKiBzaW5lQWxwaGE7CiAgICBjb25zdCBjb3NpbmVTcXVhcmVkQWxwaGEgPSAxIC0gc2luZVNxdWFyZWRBbHBoYTsKICAgIGNvbnN0IGNvc2luZUFscGhhID0gTWF0aC5zcXJ0KGNvc2luZVNxdWFyZWRBbHBoYSk7CiAgICBjb25zdCB1Mk92ZXI0ID0gdVNxdWFyZWQgLyA0OwogICAgY29uc3QgdTRPdmVyMTYgPSB1Mk92ZXI0ICogdTJPdmVyNDsKICAgIGNvbnN0IHU2T3ZlcjY0ID0gdTRPdmVyMTYgKiB1Mk92ZXI0OwogICAgY29uc3QgdThPdmVyMjU2ID0gdTRPdmVyMTYgKiB1NE92ZXIxNjsKICAgIGNvbnN0IGEwID0gMSArIHUyT3ZlcjQgLSAzICogdTRPdmVyMTYgLyA0ICsgNSAqIHU2T3ZlcjY0IC8gNCAtIDE3NSAqIHU4T3ZlcjI1NiAvIDY0OwogICAgY29uc3QgYTEgPSAxIC0gdTJPdmVyNCArIDE1ICogdTRPdmVyMTYgLyA4IC0gMzUgKiB1Nk92ZXI2NCAvIDg7CiAgICBjb25zdCBhMjIgPSAxIC0gMyAqIHUyT3ZlcjQgKyAzNSAqIHU0T3ZlcjE2IC8gNDsKICAgIGNvbnN0IGEzMiA9IDEgLSA1ICogdTJPdmVyNDsKICAgIGNvbnN0IGRpc3RhbmNlUmF0aW8gPSBhMCAqIHNpZ21hIC0gYTEgKiBNYXRoLnNpbigyICogc2lnbWEpICogdTJPdmVyNCAvIDIgLSBhMjIgKiBNYXRoLnNpbig0ICogc2lnbWEpICogdTRPdmVyMTYgLyAxNiAtIGEzMiAqIE1hdGguc2luKDYgKiBzaWdtYSkgKiB1Nk92ZXI2NCAvIDQ4IC0gTWF0aC5zaW4oOCAqIHNpZ21hKSAqIDUgKiB1OE92ZXIyNTYgLyA1MTI7CiAgICBjb25zdCBjb25zdGFudHMgPSBlbGxpcHNvaWRHZW9kZXNpYzIuX2NvbnN0YW50czsKICAgIGNvbnN0YW50cy5hID0gYTM7CiAgICBjb25zdGFudHMuYiA9IGI7CiAgICBjb25zdGFudHMuZiA9IGY7CiAgICBjb25zdGFudHMuY29zaW5lSGVhZGluZyA9IGNvc2luZUhlYWRpbmc7CiAgICBjb25zdGFudHMuc2luZUhlYWRpbmcgPSBzaW5lSGVhZGluZzsKICAgIGNvbnN0YW50cy50YW5VID0gdGFuVTsKICAgIGNvbnN0YW50cy5jb3NpbmVVID0gY29zaW5lVTsKICAgIGNvbnN0YW50cy5zaW5lVSA9IHNpbmVVOwogICAgY29uc3RhbnRzLnNpZ21hID0gc2lnbWE7CiAgICBjb25zdGFudHMuc2luZUFscGhhID0gc2luZUFscGhhOwogICAgY29uc3RhbnRzLnNpbmVTcXVhcmVkQWxwaGEgPSBzaW5lU3F1YXJlZEFscGhhOwogICAgY29uc3RhbnRzLmNvc2luZVNxdWFyZWRBbHBoYSA9IGNvc2luZVNxdWFyZWRBbHBoYTsKICAgIGNvbnN0YW50cy5jb3NpbmVBbHBoYSA9IGNvc2luZUFscGhhOwogICAgY29uc3RhbnRzLnUyT3ZlcjQgPSB1Mk92ZXI0OwogICAgY29uc3RhbnRzLnU0T3ZlcjE2ID0gdTRPdmVyMTY7CiAgICBjb25zdGFudHMudTZPdmVyNjQgPSB1Nk92ZXI2NDsKICAgIGNvbnN0YW50cy51OE92ZXIyNTYgPSB1OE92ZXIyNTY7CiAgICBjb25zdGFudHMuYTAgPSBhMDsKICAgIGNvbnN0YW50cy5hMSA9IGExOwogICAgY29uc3RhbnRzLmEyID0gYTIyOwogICAgY29uc3RhbnRzLmEzID0gYTMyOwogICAgY29uc3RhbnRzLmRpc3RhbmNlUmF0aW8gPSBkaXN0YW5jZVJhdGlvOwogIH0KICBmdW5jdGlvbiBjb21wdXRlQyhmLCBjb3NpbmVTcXVhcmVkQWxwaGEpIHsKICAgIHJldHVybiBmICogY29zaW5lU3F1YXJlZEFscGhhICogKDQgKyBmICogKDQgLSAzICogY29zaW5lU3F1YXJlZEFscGhhKSkgLyAxNjsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZURlbHRhTGFtYmRhKGYsIHNpbmVBbHBoYSwgY29zaW5lU3F1YXJlZEFscGhhLCBzaWdtYSwgc2luZVNpZ21hLCBjb3NpbmVTaWdtYSwgY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50KSB7CiAgICBjb25zdCBDID0gY29tcHV0ZUMoZiwgY29zaW5lU3F1YXJlZEFscGhhKTsKICAgIHJldHVybiAoMSAtIEMpICogZiAqIHNpbmVBbHBoYSAqIChzaWdtYSArIEMgKiBzaW5lU2lnbWEgKiAoY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50ICsgQyAqIGNvc2luZVNpZ21hICogKDIgKiBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQgKiBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQgLSAxKSkpOwogIH0KICBmdW5jdGlvbiB2aW5jZW50eUludmVyc2VGb3JtdWxhKGVsbGlwc29pZEdlb2Rlc2ljMiwgbWFqb3IsIG1pbm9yLCBmaXJzdExvbmdpdHVkZSwgZmlyc3RMYXRpdHVkZSwgc2Vjb25kTG9uZ2l0dWRlLCBzZWNvbmRMYXRpdHVkZSkgewogICAgY29uc3QgZWZmID0gKG1ham9yIC0gbWlub3IpIC8gbWFqb3I7CiAgICBjb25zdCBsID0gc2Vjb25kTG9uZ2l0dWRlIC0gZmlyc3RMb25naXR1ZGU7CiAgICBjb25zdCB1MTIgPSBNYXRoLmF0YW4oKDEgLSBlZmYpICogTWF0aC50YW4oZmlyc3RMYXRpdHVkZSkpOwogICAgY29uc3QgdTIyID0gTWF0aC5hdGFuKCgxIC0gZWZmKSAqIE1hdGgudGFuKHNlY29uZExhdGl0dWRlKSk7CiAgICBjb25zdCBjb3NpbmVVMSA9IE1hdGguY29zKHUxMik7CiAgICBjb25zdCBzaW5lVTEgPSBNYXRoLnNpbih1MTIpOwogICAgY29uc3QgY29zaW5lVTIgPSBNYXRoLmNvcyh1MjIpOwogICAgY29uc3Qgc2luZVUyID0gTWF0aC5zaW4odTIyKTsKICAgIGNvbnN0IGNjID0gY29zaW5lVTEgKiBjb3NpbmVVMjsKICAgIGNvbnN0IGNzID0gY29zaW5lVTEgKiBzaW5lVTI7CiAgICBjb25zdCBzcyA9IHNpbmVVMSAqIHNpbmVVMjsKICAgIGNvbnN0IHNjID0gc2luZVUxICogY29zaW5lVTI7CiAgICBsZXQgbGFtYmRhID0gbDsKICAgIGxldCBsYW1iZGFEb3QgPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgbGV0IGNvc2luZUxhbWJkYSA9IE1hdGguY29zKGxhbWJkYSk7CiAgICBsZXQgc2luZUxhbWJkYSA9IE1hdGguc2luKGxhbWJkYSk7CiAgICBsZXQgc2lnbWE7CiAgICBsZXQgY29zaW5lU2lnbWE7CiAgICBsZXQgc2luZVNpZ21hOwogICAgbGV0IGNvc2luZVNxdWFyZWRBbHBoYTsKICAgIGxldCBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQ7CiAgICBkbyB7CiAgICAgIGNvc2luZUxhbWJkYSA9IE1hdGguY29zKGxhbWJkYSk7CiAgICAgIHNpbmVMYW1iZGEgPSBNYXRoLnNpbihsYW1iZGEpOwogICAgICBjb25zdCB0ZW1wID0gY3MgLSBzYyAqIGNvc2luZUxhbWJkYTsKICAgICAgc2luZVNpZ21hID0gTWF0aC5zcXJ0KAogICAgICAgIGNvc2luZVUyICogY29zaW5lVTIgKiBzaW5lTGFtYmRhICogc2luZUxhbWJkYSArIHRlbXAgKiB0ZW1wCiAgICAgICk7CiAgICAgIGNvc2luZVNpZ21hID0gc3MgKyBjYyAqIGNvc2luZUxhbWJkYTsKICAgICAgc2lnbWEgPSBNYXRoLmF0YW4yKHNpbmVTaWdtYSwgY29zaW5lU2lnbWEpOwogICAgICBsZXQgc2luZUFscGhhOwogICAgICBpZiAoc2luZVNpZ21hID09PSAwKSB7CiAgICAgICAgc2luZUFscGhhID0gMDsKICAgICAgICBjb3NpbmVTcXVhcmVkQWxwaGEgPSAxOwogICAgICB9IGVsc2UgewogICAgICAgIHNpbmVBbHBoYSA9IGNjICogc2luZUxhbWJkYSAvIHNpbmVTaWdtYTsKICAgICAgICBjb3NpbmVTcXVhcmVkQWxwaGEgPSAxIC0gc2luZUFscGhhICogc2luZUFscGhhOwogICAgICB9CiAgICAgIGxhbWJkYURvdCA9IGxhbWJkYTsKICAgICAgY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50ID0gY29zaW5lU2lnbWEgLSAyICogc3MgLyBjb3NpbmVTcXVhcmVkQWxwaGE7CiAgICAgIGlmICghaXNGaW5pdGUoY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50KSkgewogICAgICAgIGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCA9IDA7CiAgICAgIH0KICAgICAgbGFtYmRhID0gbCArIGNvbXB1dGVEZWx0YUxhbWJkYSgKICAgICAgICBlZmYsCiAgICAgICAgc2luZUFscGhhLAogICAgICAgIGNvc2luZVNxdWFyZWRBbHBoYSwKICAgICAgICBzaWdtYSwKICAgICAgICBzaW5lU2lnbWEsCiAgICAgICAgY29zaW5lU2lnbWEsCiAgICAgICAgY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50CiAgICAgICk7CiAgICB9IHdoaWxlIChNYXRoLmFicyhsYW1iZGEgLSBsYW1iZGFEb3QpID4gTWF0aF9kZWZhdWx0LkVQU0lMT04xMik7CiAgICBjb25zdCB1U3F1YXJlZCA9IGNvc2luZVNxdWFyZWRBbHBoYSAqIChtYWpvciAqIG1ham9yIC0gbWlub3IgKiBtaW5vcikgLyAobWlub3IgKiBtaW5vcik7CiAgICBjb25zdCBBID0gMSArIHVTcXVhcmVkICogKDQwOTYgKyB1U3F1YXJlZCAqICh1U3F1YXJlZCAqICgzMjAgLSAxNzUgKiB1U3F1YXJlZCkgLSA3NjgpKSAvIDE2Mzg0OwogICAgY29uc3QgQiA9IHVTcXVhcmVkICogKDI1NiArIHVTcXVhcmVkICogKHVTcXVhcmVkICogKDc0IC0gNDcgKiB1U3F1YXJlZCkgLSAxMjgpKSAvIDEwMjQ7CiAgICBjb25zdCBjb3NpbmVTcXVhcmVkVHdpY2VTaWdtYU1pZHBvaW50ID0gY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50ICogY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50OwogICAgY29uc3QgZGVsdGFTaWdtYSA9IEIgKiBzaW5lU2lnbWEgKiAoY29zaW5lVHdpY2VTaWdtYU1pZHBvaW50ICsgQiAqIChjb3NpbmVTaWdtYSAqICgyICogY29zaW5lU3F1YXJlZFR3aWNlU2lnbWFNaWRwb2ludCAtIDEpIC0gQiAqIGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCAqICg0ICogc2luZVNpZ21hICogc2luZVNpZ21hIC0gMykgKiAoNCAqIGNvc2luZVNxdWFyZWRUd2ljZVNpZ21hTWlkcG9pbnQgLSAzKSAvIDYpIC8gNCk7CiAgICBjb25zdCBkaXN0YW5jZSA9IG1pbm9yICogQSAqIChzaWdtYSAtIGRlbHRhU2lnbWEpOwogICAgY29uc3Qgc3RhcnRIZWFkaW5nID0gTWF0aC5hdGFuMigKICAgICAgY29zaW5lVTIgKiBzaW5lTGFtYmRhLAogICAgICBjcyAtIHNjICogY29zaW5lTGFtYmRhCiAgICApOwogICAgY29uc3QgZW5kSGVhZGluZyA9IE1hdGguYXRhbjIoY29zaW5lVTEgKiBzaW5lTGFtYmRhLCBjcyAqIGNvc2luZUxhbWJkYSAtIHNjKTsKICAgIGVsbGlwc29pZEdlb2Rlc2ljMi5fZGlzdGFuY2UgPSBkaXN0YW5jZTsKICAgIGVsbGlwc29pZEdlb2Rlc2ljMi5fc3RhcnRIZWFkaW5nID0gc3RhcnRIZWFkaW5nOwogICAgZWxsaXBzb2lkR2VvZGVzaWMyLl9lbmRIZWFkaW5nID0gZW5kSGVhZGluZzsKICAgIGVsbGlwc29pZEdlb2Rlc2ljMi5fdVNxdWFyZWQgPSB1U3F1YXJlZDsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVByb3BlcnRpZXMyKGVsbGlwc29pZEdlb2Rlc2ljMiwgc3RhcnQsIGVuZCwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBmaXJzdENhcnRlc2lhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgIGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihzdGFydCwgc2NyYXRjaENhcnQyMiksCiAgICAgIHNjcmF0Y2hDYXJ0MTIKICAgICk7CiAgICBjb25zdCBsYXN0Q2FydGVzaWFuID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGVuZCwgc2NyYXRjaENhcnQyMiksCiAgICAgIHNjcmF0Y2hDYXJ0MjIKICAgICk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIuZ3JlYXRlclRoYW5PckVxdWFscygKICAgICAgInZhbHVlIiwKICAgICAgTWF0aC5hYnMoCiAgICAgICAgTWF0aC5hYnMoQ2FydGVzaWFuM19kZWZhdWx0LmFuZ2xlQmV0d2VlbihmaXJzdENhcnRlc2lhbiwgbGFzdENhcnRlc2lhbikpIC0gTWF0aC5QSQogICAgICApLAogICAgICAwLjAxMjUKICAgICk7CiAgICB2aW5jZW50eUludmVyc2VGb3JtdWxhKAogICAgICBlbGxpcHNvaWRHZW9kZXNpYzIsCiAgICAgIGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzLAogICAgICBlbGxpcHNvaWQubWluaW11bVJhZGl1cywKICAgICAgc3RhcnQubG9uZ2l0dWRlLAogICAgICBzdGFydC5sYXRpdHVkZSwKICAgICAgZW5kLmxvbmdpdHVkZSwKICAgICAgZW5kLmxhdGl0dWRlCiAgICApOwogICAgZWxsaXBzb2lkR2VvZGVzaWMyLl9zdGFydCA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKAogICAgICBzdGFydCwKICAgICAgZWxsaXBzb2lkR2VvZGVzaWMyLl9zdGFydAogICAgKTsKICAgIGVsbGlwc29pZEdlb2Rlc2ljMi5fZW5kID0gQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoZW5kLCBlbGxpcHNvaWRHZW9kZXNpYzIuX2VuZCk7CiAgICBlbGxpcHNvaWRHZW9kZXNpYzIuX3N0YXJ0LmhlaWdodCA9IDA7CiAgICBlbGxpcHNvaWRHZW9kZXNpYzIuX2VuZC5oZWlnaHQgPSAwOwogICAgc2V0Q29uc3RhbnRzKGVsbGlwc29pZEdlb2Rlc2ljMik7CiAgfQogIGZ1bmN0aW9uIEVsbGlwc29pZEdlb2Rlc2ljKHN0YXJ0LCBlbmQsIGVsbGlwc29pZCkgewogICAgY29uc3QgZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgdGhpcy5fZWxsaXBzb2lkID0gZTsKICAgIHRoaXMuX3N0YXJ0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICB0aGlzLl9lbmQgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgIHRoaXMuX2NvbnN0YW50cyA9IHt9OwogICAgdGhpcy5fc3RhcnRIZWFkaW5nID0gdm9pZCAwOwogICAgdGhpcy5fZW5kSGVhZGluZyA9IHZvaWQgMDsKICAgIHRoaXMuX2Rpc3RhbmNlID0gdm9pZCAwOwogICAgdGhpcy5fdVNxdWFyZWQgPSB2b2lkIDA7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN0YXJ0KSAmJiBkZWZpbmVkX2RlZmF1bHQoZW5kKSkgewogICAgICBjb21wdXRlUHJvcGVydGllczIodGhpcywgc3RhcnQsIGVuZCwgZSk7CiAgICB9CiAgfQogIHZhciBzY3JhdGNoQ2FydDEyLCBzY3JhdGNoQ2FydDIyLCBFbGxpcHNvaWRHZW9kZXNpY19kZWZhdWx0OwogIHZhciBpbml0X0VsbGlwc29pZEdlb2Rlc2ljID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRHZW9kZXNpYy5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgc2NyYXRjaENhcnQxMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnQyMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoRWxsaXBzb2lkR2VvZGVzaWMucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgZWxsaXBzb2lkLgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7RWxsaXBzb2lkfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGVsbGlwc29pZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsbGlwc29pZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHN1cmZhY2UgZGlzdGFuY2UgYmV0d2VlbiB0aGUgc3RhcnQgYW5kIGVuZCBwb2ludAogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHN1cmZhY2VEaXN0YW5jZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJkaXN0YW5jZSIsIHRoaXMuX2Rpc3RhbmNlKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2Rpc3RhbmNlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgaW5pdGlhbCBwbGFuZXRvZGV0aWMgcG9pbnQgb24gdGhlIHBhdGguCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZEdlb2Rlc2ljLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDYXJ0b2dyYXBoaWN9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgc3RhcnQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zdGFydDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGZpbmFsIHBsYW5ldG9kZXRpYyBwb2ludCBvbiB0aGUgcGF0aC4KICAgICAgICAgKiBAbWVtYmVyb2YgRWxsaXBzb2lkR2VvZGVzaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0NhcnRvZ3JhcGhpY30KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlbmQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbmQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBoZWFkaW5nIGF0IHRoZSBpbml0aWFsIHBvaW50LgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHN0YXJ0SGVhZGluZzogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJkaXN0YW5jZSIsIHRoaXMuX2Rpc3RhbmNlKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXJ0SGVhZGluZzsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGhlYWRpbmcgYXQgdGhlIGZpbmFsIHBvaW50LgogICAgICAgICAqIEBtZW1iZXJvZiBFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIGVuZEhlYWRpbmc6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiZGlzdGFuY2UiLCB0aGlzLl9kaXN0YW5jZSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbmRIZWFkaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIEVsbGlwc29pZEdlb2Rlc2ljLnByb3RvdHlwZS5zZXRFbmRQb2ludHMgPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJzdGFydCIsIHN0YXJ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImVuZCIsIGVuZCk7CiAgICAgICAgY29tcHV0ZVByb3BlcnRpZXMyKHRoaXMsIHN0YXJ0LCBlbmQsIHRoaXMuX2VsbGlwc29pZCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZEdlb2Rlc2ljLnByb3RvdHlwZS5pbnRlcnBvbGF0ZVVzaW5nRnJhY3Rpb24gPSBmdW5jdGlvbihmcmFjdGlvbiwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSgKICAgICAgICAgIHRoaXMuX2Rpc3RhbmNlICogZnJhY3Rpb24sCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWRHZW9kZXNpYy5wcm90b3R5cGUuaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSA9IGZ1bmN0aW9uKGRpc3RhbmNlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImRpc3RhbmNlIiwgdGhpcy5fZGlzdGFuY2UpOwogICAgICAgIGNvbnN0IGNvbnN0YW50cyA9IHRoaXMuX2NvbnN0YW50czsKICAgICAgICBjb25zdCBzID0gY29uc3RhbnRzLmRpc3RhbmNlUmF0aW8gKyBkaXN0YW5jZSAvIGNvbnN0YW50cy5iOwogICAgICAgIGNvbnN0IGNvc2luZTJTID0gTWF0aC5jb3MoMiAqIHMpOwogICAgICAgIGNvbnN0IGNvc2luZTRTID0gTWF0aC5jb3MoNCAqIHMpOwogICAgICAgIGNvbnN0IGNvc2luZTZTID0gTWF0aC5jb3MoNiAqIHMpOwogICAgICAgIGNvbnN0IHNpbmUyUyA9IE1hdGguc2luKDIgKiBzKTsKICAgICAgICBjb25zdCBzaW5lNFMgPSBNYXRoLnNpbig0ICogcyk7CiAgICAgICAgY29uc3Qgc2luZTZTID0gTWF0aC5zaW4oNiAqIHMpOwogICAgICAgIGNvbnN0IHNpbmU4UyA9IE1hdGguc2luKDggKiBzKTsKICAgICAgICBjb25zdCBzMiA9IHMgKiBzOwogICAgICAgIGNvbnN0IHMzID0gcyAqIHMyOwogICAgICAgIGNvbnN0IHU4T3ZlcjI1NiA9IGNvbnN0YW50cy51OE92ZXIyNTY7CiAgICAgICAgY29uc3QgdTJPdmVyNCA9IGNvbnN0YW50cy51Mk92ZXI0OwogICAgICAgIGNvbnN0IHU2T3ZlcjY0ID0gY29uc3RhbnRzLnU2T3ZlcjY0OwogICAgICAgIGNvbnN0IHU0T3ZlcjE2ID0gY29uc3RhbnRzLnU0T3ZlcjE2OwogICAgICAgIGxldCBzaWdtYSA9IDIgKiBzMyAqIHU4T3ZlcjI1NiAqIGNvc2luZTJTIC8gMyArIHMgKiAoMSAtIHUyT3ZlcjQgKyA3ICogdTRPdmVyMTYgLyA0IC0gMTUgKiB1Nk92ZXI2NCAvIDQgKyA1NzkgKiB1OE92ZXIyNTYgLyA2NCAtICh1NE92ZXIxNiAtIDE1ICogdTZPdmVyNjQgLyA0ICsgMTg3ICogdThPdmVyMjU2IC8gMTYpICogY29zaW5lMlMgLSAoNSAqIHU2T3ZlcjY0IC8gNCAtIDExNSAqIHU4T3ZlcjI1NiAvIDE2KSAqIGNvc2luZTRTIC0gMjkgKiB1OE92ZXIyNTYgKiBjb3NpbmU2UyAvIDE2KSArICh1Mk92ZXI0IC8gMiAtIHU0T3ZlcjE2ICsgNzEgKiB1Nk92ZXI2NCAvIDMyIC0gODUgKiB1OE92ZXIyNTYgLyAxNikgKiBzaW5lMlMgKyAoNSAqIHU0T3ZlcjE2IC8gMTYgLSA1ICogdTZPdmVyNjQgLyA0ICsgMzgzICogdThPdmVyMjU2IC8gOTYpICogc2luZTRTIC0gczIgKiAoKHU2T3ZlcjY0IC0gMTEgKiB1OE92ZXIyNTYgLyAyKSAqIHNpbmUyUyArIDUgKiB1OE92ZXIyNTYgKiBzaW5lNFMgLyAyKSArICgyOSAqIHU2T3ZlcjY0IC8gOTYgLSAyOSAqIHU4T3ZlcjI1NiAvIDE2KSAqIHNpbmU2UyArIDUzOSAqIHU4T3ZlcjI1NiAqIHNpbmU4UyAvIDE1MzY7CiAgICAgICAgY29uc3QgdGhldGEgPSBNYXRoLmFzaW4oTWF0aC5zaW4oc2lnbWEpICogY29uc3RhbnRzLmNvc2luZUFscGhhKTsKICAgICAgICBjb25zdCBsYXRpdHVkZSA9IE1hdGguYXRhbihjb25zdGFudHMuYSAvIGNvbnN0YW50cy5iICogTWF0aC50YW4odGhldGEpKTsKICAgICAgICBzaWdtYSA9IHNpZ21hIC0gY29uc3RhbnRzLnNpZ21hOwogICAgICAgIGNvbnN0IGNvc2luZVR3aWNlU2lnbWFNaWRwb2ludCA9IE1hdGguY29zKDIgKiBjb25zdGFudHMuc2lnbWEgKyBzaWdtYSk7CiAgICAgICAgY29uc3Qgc2luZVNpZ21hID0gTWF0aC5zaW4oc2lnbWEpOwogICAgICAgIGNvbnN0IGNvc2luZVNpZ21hID0gTWF0aC5jb3Moc2lnbWEpOwogICAgICAgIGNvbnN0IGNjID0gY29uc3RhbnRzLmNvc2luZVUgKiBjb3NpbmVTaWdtYTsKICAgICAgICBjb25zdCBzcyA9IGNvbnN0YW50cy5zaW5lVSAqIHNpbmVTaWdtYTsKICAgICAgICBjb25zdCBsYW1iZGEgPSBNYXRoLmF0YW4yKAogICAgICAgICAgc2luZVNpZ21hICogY29uc3RhbnRzLnNpbmVIZWFkaW5nLAogICAgICAgICAgY2MgLSBzcyAqIGNvbnN0YW50cy5jb3NpbmVIZWFkaW5nCiAgICAgICAgKTsKICAgICAgICBjb25zdCBsID0gbGFtYmRhIC0gY29tcHV0ZURlbHRhTGFtYmRhKAogICAgICAgICAgY29uc3RhbnRzLmYsCiAgICAgICAgICBjb25zdGFudHMuc2luZUFscGhhLAogICAgICAgICAgY29uc3RhbnRzLmNvc2luZVNxdWFyZWRBbHBoYSwKICAgICAgICAgIHNpZ21hLAogICAgICAgICAgc2luZVNpZ21hLAogICAgICAgICAgY29zaW5lU2lnbWEsCiAgICAgICAgICBjb3NpbmVUd2ljZVNpZ21hTWlkcG9pbnQKICAgICAgICApOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0LmxvbmdpdHVkZSA9IHRoaXMuX3N0YXJ0LmxvbmdpdHVkZSArIGw7CiAgICAgICAgICByZXN1bHQubGF0aXR1ZGUgPSBsYXRpdHVkZTsKICAgICAgICAgIHJlc3VsdC5oZWlnaHQgPSAwOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCh0aGlzLl9zdGFydC5sb25naXR1ZGUgKyBsLCBsYXRpdHVkZSwgMCk7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZEdlb2Rlc2ljX2RlZmF1bHQgPSBFbGxpcHNvaWRHZW9kZXNpYzsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlsaW5lUGlwZWxpbmUuanMKICBmdW5jdGlvbiBzdWJkaXZpZGVIZWlnaHRzKG51bVBvaW50cywgaDAsIGgxKSB7CiAgICBjb25zdCBoZWlnaHRzID0gc3ViZGl2aWRlSGVpZ2h0c1NjcmF0Y2hBcnJheTsKICAgIGhlaWdodHMubGVuZ3RoID0gbnVtUG9pbnRzOwogICAgbGV0IGk7CiAgICBpZiAoaDAgPT09IGgxKSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1Qb2ludHM7IGkrKykgewogICAgICAgIGhlaWdodHNbaV0gPSBoMDsKICAgICAgfQogICAgICByZXR1cm4gaGVpZ2h0czsKICAgIH0KICAgIGNvbnN0IGRIZWlnaHQgPSBoMSAtIGgwOwogICAgY29uc3QgaGVpZ2h0UGVyVmVydGV4ID0gZEhlaWdodCAvIG51bVBvaW50czsKICAgIGZvciAoaSA9IDA7IGkgPCBudW1Qb2ludHM7IGkrKykgewogICAgICBjb25zdCBoID0gaDAgKyBpICogaGVpZ2h0UGVyVmVydGV4OwogICAgICBoZWlnaHRzW2ldID0gaDsKICAgIH0KICAgIHJldHVybiBoZWlnaHRzOwogIH0KICBmdW5jdGlvbiBnZW5lcmF0ZUNhcnRlc2lhbkFyYyhwMCwgcDEsIG1pbkRpc3RhbmNlLCBlbGxpcHNvaWQsIGgwLCBoMSwgYXJyYXksIG9mZnNldCkgewogICAgY29uc3QgZmlyc3QgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwMCwgc2NhbGVGaXJzdCk7CiAgICBjb25zdCBsYXN0ID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UocDEsIHNjYWxlTGFzdCk7CiAgICBjb25zdCBudW1Qb2ludHMgPSBQb2x5bGluZVBpcGVsaW5lLm51bWJlck9mUG9pbnRzKHAwLCBwMSwgbWluRGlzdGFuY2UpOwogICAgY29uc3Qgc3RhcnQgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoZmlyc3QsIGNhcnRvMSk7CiAgICBjb25zdCBlbmQgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMobGFzdCwgY2FydG8yKTsKICAgIGNvbnN0IGhlaWdodHMgPSBzdWJkaXZpZGVIZWlnaHRzKG51bVBvaW50cywgaDAsIGgxKTsKICAgIGVsbGlwc29pZEdlb2Rlc2ljLnNldEVuZFBvaW50cyhzdGFydCwgZW5kKTsKICAgIGNvbnN0IHN1cmZhY2VEaXN0YW5jZUJldHdlZW5Qb2ludHMgPSBlbGxpcHNvaWRHZW9kZXNpYy5zdXJmYWNlRGlzdGFuY2UgLyBudW1Qb2ludHM7CiAgICBsZXQgaW5kZXggPSBvZmZzZXQ7CiAgICBzdGFydC5oZWlnaHQgPSBoMDsKICAgIGxldCBjYXJ0ID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKHN0YXJ0LCBjYXJ0ZXNpYW4pOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soY2FydCwgYXJyYXksIGluZGV4KTsKICAgIGluZGV4ICs9IDM7CiAgICBmb3IgKGxldCBpID0gMTsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgIGNvbnN0IGNhcnRvID0gZWxsaXBzb2lkR2VvZGVzaWMuaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSgKICAgICAgICBpICogc3VyZmFjZURpc3RhbmNlQmV0d2VlblBvaW50cywKICAgICAgICBjYXJ0bzIKICAgICAgKTsKICAgICAgY2FydG8uaGVpZ2h0ID0gaGVpZ2h0c1tpXTsKICAgICAgY2FydCA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjYXJ0bywgY2FydGVzaWFuKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soY2FydCwgYXJyYXksIGluZGV4KTsKICAgICAgaW5kZXggKz0gMzsKICAgIH0KICAgIHJldHVybiBpbmRleDsKICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVDYXJ0ZXNpYW5SaHVtYkFyYyhwMCwgcDEsIGdyYW51bGFyaXR5LCBlbGxpcHNvaWQsIGgwLCBoMSwgYXJyYXksIG9mZnNldCkgewogICAgY29uc3Qgc3RhcnQgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDAsIGNhcnRvMSk7CiAgICBjb25zdCBlbmQgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDEsIGNhcnRvMik7CiAgICBjb25zdCBudW1Qb2ludHMgPSBQb2x5bGluZVBpcGVsaW5lLm51bWJlck9mUG9pbnRzUmh1bWJMaW5lKAogICAgICBzdGFydCwKICAgICAgZW5kLAogICAgICBncmFudWxhcml0eQogICAgKTsKICAgIHN0YXJ0LmhlaWdodCA9IDA7CiAgICBlbmQuaGVpZ2h0ID0gMDsKICAgIGNvbnN0IGhlaWdodHMgPSBzdWJkaXZpZGVIZWlnaHRzKG51bVBvaW50cywgaDAsIGgxKTsKICAgIGlmICghZWxsaXBzb2lkUmh1bWIuZWxsaXBzb2lkLmVxdWFscyhlbGxpcHNvaWQpKSB7CiAgICAgIGVsbGlwc29pZFJodW1iID0gbmV3IEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0KHZvaWQgMCwgdm9pZCAwLCBlbGxpcHNvaWQpOwogICAgfQogICAgZWxsaXBzb2lkUmh1bWIuc2V0RW5kUG9pbnRzKHN0YXJ0LCBlbmQpOwogICAgY29uc3Qgc3VyZmFjZURpc3RhbmNlQmV0d2VlblBvaW50cyA9IGVsbGlwc29pZFJodW1iLnN1cmZhY2VEaXN0YW5jZSAvIG51bVBvaW50czsKICAgIGxldCBpbmRleCA9IG9mZnNldDsKICAgIHN0YXJ0LmhlaWdodCA9IGgwOwogICAgbGV0IGNhcnQgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oc3RhcnQsIGNhcnRlc2lhbik7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjYXJ0LCBhcnJheSwgaW5kZXgpOwogICAgaW5kZXggKz0gMzsKICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgY29uc3QgY2FydG8gPSBlbGxpcHNvaWRSaHVtYi5pbnRlcnBvbGF0ZVVzaW5nU3VyZmFjZURpc3RhbmNlKAogICAgICAgIGkgKiBzdXJmYWNlRGlzdGFuY2VCZXR3ZWVuUG9pbnRzLAogICAgICAgIGNhcnRvMgogICAgICApOwogICAgICBjYXJ0by5oZWlnaHQgPSBoZWlnaHRzW2ldOwogICAgICBjYXJ0ID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGNhcnRvLCBjYXJ0ZXNpYW4pOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjYXJ0LCBhcnJheSwgaW5kZXgpOwogICAgICBpbmRleCArPSAzOwogICAgfQogICAgcmV0dXJuIGluZGV4OwogIH0KICB2YXIgUG9seWxpbmVQaXBlbGluZSwgY2FydG9TY3JhdGNoLCB3cmFwTG9uZ2l0dWRlSW52ZXJzTWF0cml4LCB3cmFwTG9uZ2l0dWRlT3JpZ2luLCB3cmFwTG9uZ2l0dWRlWFpOb3JtYWwsIHdyYXBMb25naXR1ZGVYWlBsYW5lLCB3cmFwTG9uZ2l0dWRlWVpOb3JtYWwsIHdyYXBMb25naXR1ZGVZWlBsYW5lLCB3cmFwTG9uZ2l0dWRlSW50ZXJzZWN0aW9uLCB3cmFwTG9uZ2l0dWRlT2Zmc2V0LCBzdWJkaXZpZGVIZWlnaHRzU2NyYXRjaEFycmF5LCBjYXJ0bzEsIGNhcnRvMiwgY2FydGVzaWFuLCBzY2FsZUZpcnN0LCBzY2FsZUxhc3QsIGVsbGlwc29pZEdlb2Rlc2ljLCBlbGxpcHNvaWRSaHVtYiwgc2NyYXRjaENhcnRvZ3JhcGhpYzAyLCBzY3JhdGNoQ2FydG9ncmFwaGljMTIsIFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdDsKICB2YXIgaW5pdF9Qb2x5bGluZVBpcGVsaW5lID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZVBpcGVsaW5lLmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkR2VvZGVzaWMoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRSaHVtYkxpbmUoKTsKICAgICAgaW5pdF9JbnRlcnNlY3Rpb25UZXN0cygpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfUGxhbmUoKTsKICAgICAgUG9seWxpbmVQaXBlbGluZSA9IHt9OwogICAgICBQb2x5bGluZVBpcGVsaW5lLm51bWJlck9mUG9pbnRzID0gZnVuY3Rpb24ocDAsIHAxLCBtaW5EaXN0YW5jZSkgewogICAgICAgIGNvbnN0IGRpc3RhbmNlID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpc3RhbmNlKHAwLCBwMSk7CiAgICAgICAgcmV0dXJuIE1hdGguY2VpbChkaXN0YW5jZSAvIG1pbkRpc3RhbmNlKTsKICAgICAgfTsKICAgICAgUG9seWxpbmVQaXBlbGluZS5udW1iZXJPZlBvaW50c1JodW1iTGluZSA9IGZ1bmN0aW9uKHAwLCBwMSwgZ3JhbnVsYXJpdHkpIHsKICAgICAgICBjb25zdCByYWRpYW5zRGlzdGFuY2VTcXVhcmVkID0gTWF0aC5wb3cocDAubG9uZ2l0dWRlIC0gcDEubG9uZ2l0dWRlLCAyKSArIE1hdGgucG93KHAwLmxhdGl0dWRlIC0gcDEubGF0aXR1ZGUsIDIpOwogICAgICAgIHJldHVybiBNYXRoLm1heCgKICAgICAgICAgIDEsCiAgICAgICAgICBNYXRoLmNlaWwoTWF0aC5zcXJ0KHJhZGlhbnNEaXN0YW5jZVNxdWFyZWQgLyAoZ3JhbnVsYXJpdHkgKiBncmFudWxhcml0eSkpKQogICAgICAgICk7CiAgICAgIH07CiAgICAgIGNhcnRvU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBQb2x5bGluZVBpcGVsaW5lLmV4dHJhY3RIZWlnaHRzID0gZnVuY3Rpb24ocG9zaXRpb25zLCBlbGxpcHNvaWQpIHsKICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IGhlaWdodHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgaGVpZ2h0c1tpXSA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwLCBjYXJ0b1NjcmF0Y2gpLmhlaWdodDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGhlaWdodHM7CiAgICAgIH07CiAgICAgIHdyYXBMb25naXR1ZGVJbnZlcnNNYXRyaXggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIHdyYXBMb25naXR1ZGVPcmlnaW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHdyYXBMb25naXR1ZGVYWk5vcm1hbCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgd3JhcExvbmdpdHVkZVhaUGxhbmUgPSBuZXcgUGxhbmVfZGVmYXVsdChDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLCAwKTsKICAgICAgd3JhcExvbmdpdHVkZVlaTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB3cmFwTG9uZ2l0dWRlWVpQbGFuZSA9IG5ldyBQbGFuZV9kZWZhdWx0KENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsIDApOwogICAgICB3cmFwTG9uZ2l0dWRlSW50ZXJzZWN0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB3cmFwTG9uZ2l0dWRlT2Zmc2V0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdWJkaXZpZGVIZWlnaHRzU2NyYXRjaEFycmF5ID0gW107CiAgICAgIGNhcnRvMSA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBjYXJ0bzIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY2FsZUZpcnN0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY2FsZUxhc3QgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGVsbGlwc29pZEdlb2Rlc2ljID0gbmV3IEVsbGlwc29pZEdlb2Rlc2ljX2RlZmF1bHQoKTsKICAgICAgZWxsaXBzb2lkUmh1bWIgPSBuZXcgRWxsaXBzb2lkUmh1bWJMaW5lX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVQaXBlbGluZS53cmFwTG9uZ2l0dWRlID0gZnVuY3Rpb24ocG9zaXRpb25zLCBtb2RlbE1hdHJpeCkgewogICAgICAgIGNvbnN0IGNhcnRlc2lhbnMgPSBbXTsKICAgICAgICBjb25zdCBzZWdtZW50cyA9IFtdOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSAmJiBwb3NpdGlvbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgbW9kZWxNYXRyaXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChtb2RlbE1hdHJpeCwgTWF0cml4NF9kZWZhdWx0LklERU5USVRZKTsKICAgICAgICAgIGNvbnN0IGludmVyc2VNb2RlbE1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oCiAgICAgICAgICAgIG1vZGVsTWF0cml4LAogICAgICAgICAgICB3cmFwTG9uZ2l0dWRlSW52ZXJzTWF0cml4CiAgICAgICAgICApOwogICAgICAgICAgY29uc3Qgb3JpZ2luID0gTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludCgKICAgICAgICAgICAgaW52ZXJzZU1vZGVsTWF0cml4LAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywKICAgICAgICAgICAgd3JhcExvbmdpdHVkZU9yaWdpbgogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHh6Tm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludEFzVmVjdG9yKAogICAgICAgICAgICAgIGludmVyc2VNb2RlbE1hdHJpeCwKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9ZLAogICAgICAgICAgICAgIHdyYXBMb25naXR1ZGVYWk5vcm1hbAogICAgICAgICAgICApLAogICAgICAgICAgICB3cmFwTG9uZ2l0dWRlWFpOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB4elBsYW5lMiA9IFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50Tm9ybWFsKAogICAgICAgICAgICBvcmlnaW4sCiAgICAgICAgICAgIHh6Tm9ybWFsLAogICAgICAgICAgICB3cmFwTG9uZ2l0dWRlWFpQbGFuZQogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHl6Tm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludEFzVmVjdG9yKAogICAgICAgICAgICAgIGludmVyc2VNb2RlbE1hdHJpeCwKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuVU5JVF9YLAogICAgICAgICAgICAgIHdyYXBMb25naXR1ZGVZWk5vcm1hbAogICAgICAgICAgICApLAogICAgICAgICAgICB3cmFwTG9uZ2l0dWRlWVpOb3JtYWwKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCB5elBsYW5lID0gUGxhbmVfZGVmYXVsdC5mcm9tUG9pbnROb3JtYWwoCiAgICAgICAgICAgIG9yaWdpbiwKICAgICAgICAgICAgeXpOb3JtYWwsCiAgICAgICAgICAgIHdyYXBMb25naXR1ZGVZWlBsYW5lCiAgICAgICAgICApOwogICAgICAgICAgbGV0IGNvdW50ID0gMTsKICAgICAgICAgIGNhcnRlc2lhbnMucHVzaChDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb25zWzBdKSk7CiAgICAgICAgICBsZXQgcHJldiA9IGNhcnRlc2lhbnNbMF07CiAgICAgICAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBjb25zdCBjdXIgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICAgIGlmIChQbGFuZV9kZWZhdWx0LmdldFBvaW50RGlzdGFuY2UoeXpQbGFuZSwgcHJldikgPCAwIHx8IFBsYW5lX2RlZmF1bHQuZ2V0UG9pbnREaXN0YW5jZSh5elBsYW5lLCBjdXIpIDwgMCkgewogICAgICAgICAgICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IEludGVyc2VjdGlvblRlc3RzX2RlZmF1bHQubGluZVNlZ21lbnRQbGFuZSgKICAgICAgICAgICAgICAgIHByZXYsCiAgICAgICAgICAgICAgICBjdXIsCiAgICAgICAgICAgICAgICB4elBsYW5lMiwKICAgICAgICAgICAgICAgIHdyYXBMb25naXR1ZGVJbnRlcnNlY3Rpb24KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSkgewogICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgICAgICAgIHh6Tm9ybWFsLAogICAgICAgICAgICAgICAgICA1ZS05LAogICAgICAgICAgICAgICAgICB3cmFwTG9uZ2l0dWRlT2Zmc2V0CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgaWYgKFBsYW5lX2RlZmF1bHQuZ2V0UG9pbnREaXN0YW5jZSh4elBsYW5lMiwgcHJldikgPCAwKSB7CiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUob2Zmc2V0LCBvZmZzZXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FydGVzaWFucy5wdXNoKAogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGludGVyc2VjdGlvbiwgb2Zmc2V0LCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCkpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaChjb3VudCArIDEpOwogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShvZmZzZXQsIG9mZnNldCk7CiAgICAgICAgICAgICAgICBjYXJ0ZXNpYW5zLnB1c2goCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoaW50ZXJzZWN0aW9uLCBvZmZzZXQsIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBjb3VudCA9IDE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhcnRlc2lhbnMucHVzaChDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb25zW2ldKSk7CiAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgIHByZXYgPSBjdXI7CiAgICAgICAgICB9CiAgICAgICAgICBzZWdtZW50cy5wdXNoKGNvdW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHBvc2l0aW9uczogY2FydGVzaWFucywKICAgICAgICAgIGxlbmd0aHM6IHNlZ21lbnRzCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgUG9seWxpbmVQaXBlbGluZS5nZW5lcmF0ZUFyYyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zKSkgewogICAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICAgIH0KICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5wb3NpdGlvbnMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICBsZXQgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgICAgIGNvbnN0IGhhc0hlaWdodEFycmF5ID0gQXJyYXkuaXNBcnJheShoZWlnaHQpOwogICAgICAgIGlmIChsZW5ndGggPCAxKSB7CiAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgfSBlbHNlIGlmIChsZW5ndGggPT09IDEpIHsKICAgICAgICAgIGNvbnN0IHAgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3NpdGlvbnNbMF0sIHNjYWxlRmlyc3QpOwogICAgICAgICAgaGVpZ2h0ID0gaGFzSGVpZ2h0QXJyYXkgPyBoZWlnaHRbMF0gOiBoZWlnaHQ7CiAgICAgICAgICBpZiAoaGVpZ2h0ICE9PSAwKSB7CiAgICAgICAgICAgIGNvbnN0IG4gPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHAsIGNhcnRlc2lhbik7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG4sIGhlaWdodCwgbik7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocCwgbiwgcCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gW3AueCwgcC55LCBwLnpdOwogICAgICAgIH0KICAgICAgICBsZXQgbWluRGlzdGFuY2UgPSBvcHRpb25zLm1pbkRpc3RhbmNlOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG1pbkRpc3RhbmNlKSkgewogICAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgICAgICAgKTsKICAgICAgICAgIG1pbkRpc3RhbmNlID0gTWF0aF9kZWZhdWx0LmNob3JkTGVuZ3RoKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQubWF4aW11bVJhZGl1cyk7CiAgICAgICAgfQogICAgICAgIGxldCBudW1Qb2ludHMgPSAwOwogICAgICAgIGxldCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgIG51bVBvaW50cyArPSBQb2x5bGluZVBpcGVsaW5lLm51bWJlck9mUG9pbnRzKAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgMV0sCiAgICAgICAgICAgIG1pbkRpc3RhbmNlCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBhcnJheUxlbmd0aCA9IChudW1Qb2ludHMgKyAxKSAqIDM7CiAgICAgICAgY29uc3QgbmV3UG9zaXRpb25zID0gbmV3IEFycmF5KGFycmF5TGVuZ3RoKTsKICAgICAgICBsZXQgb2Zmc2V0ID0gMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICBjb25zdCBwMCA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgIGNvbnN0IHAxID0gcG9zaXRpb25zW2kgKyAxXTsKICAgICAgICAgIGNvbnN0IGgwID0gaGFzSGVpZ2h0QXJyYXkgPyBoZWlnaHRbaV0gOiBoZWlnaHQ7CiAgICAgICAgICBjb25zdCBoMSA9IGhhc0hlaWdodEFycmF5ID8gaGVpZ2h0W2kgKyAxXSA6IGhlaWdodDsKICAgICAgICAgIG9mZnNldCA9IGdlbmVyYXRlQ2FydGVzaWFuQXJjKAogICAgICAgICAgICBwMCwKICAgICAgICAgICAgcDEsCiAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIGgwLAogICAgICAgICAgICBoMSwKICAgICAgICAgICAgbmV3UG9zaXRpb25zLAogICAgICAgICAgICBvZmZzZXQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHN1YmRpdmlkZUhlaWdodHNTY3JhdGNoQXJyYXkubGVuZ3RoID0gMDsKICAgICAgICBjb25zdCBsYXN0UG9pbnQgPSBwb3NpdGlvbnNbbGVuZ3RoIC0gMV07CiAgICAgICAgY29uc3QgY2FydG8gPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMobGFzdFBvaW50LCBjYXJ0bzEpOwogICAgICAgIGNhcnRvLmhlaWdodCA9IGhhc0hlaWdodEFycmF5ID8gaGVpZ2h0W2xlbmd0aCAtIDFdIDogaGVpZ2h0OwogICAgICAgIGNvbnN0IGNhcnQgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oY2FydG8sIGNhcnRlc2lhbik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soY2FydCwgbmV3UG9zaXRpb25zLCBhcnJheUxlbmd0aCAtIDMpOwogICAgICAgIHJldHVybiBuZXdQb3NpdGlvbnM7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMwMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMTIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVQaXBlbGluZS5nZW5lcmF0ZVJodW1iQXJjID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMpKSB7CiAgICAgICAgICBvcHRpb25zID0ge307CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvc2l0aW9ucyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGxldCBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmhlaWdodCwgMCk7CiAgICAgICAgY29uc3QgaGFzSGVpZ2h0QXJyYXkgPSBBcnJheS5pc0FycmF5KGhlaWdodCk7CiAgICAgICAgaWYgKGxlbmd0aCA8IDEpIHsKICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gMSkgewogICAgICAgICAgY29uc3QgcCA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHBvc2l0aW9uc1swXSwgc2NhbGVGaXJzdCk7CiAgICAgICAgICBoZWlnaHQgPSBoYXNIZWlnaHRBcnJheSA/IGhlaWdodFswXSA6IGhlaWdodDsKICAgICAgICAgIGlmIChoZWlnaHQgIT09IDApIHsKICAgICAgICAgICAgY29uc3QgbiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocCwgY2FydGVzaWFuKTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobiwgaGVpZ2h0LCBuKTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwLCBuLCBwKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbcC54LCBwLnksIHAuel07CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgICAgICk7CiAgICAgICAgbGV0IG51bVBvaW50cyA9IDA7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGMwID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgcG9zaXRpb25zWzBdLAogICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzAyCiAgICAgICAgKTsKICAgICAgICBsZXQgYzE7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgYzEgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgMV0sCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxMgogICAgICAgICAgKTsKICAgICAgICAgIG51bVBvaW50cyArPSBQb2x5bGluZVBpcGVsaW5lLm51bWJlck9mUG9pbnRzUmh1bWJMaW5lKGMwLCBjMSwgZ3JhbnVsYXJpdHkpOwogICAgICAgICAgYzAgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZShjMSwgc2NyYXRjaENhcnRvZ3JhcGhpYzAyKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXJyYXlMZW5ndGggPSAobnVtUG9pbnRzICsgMSkgKiAzOwogICAgICAgIGNvbnN0IG5ld1Bvc2l0aW9ucyA9IG5ldyBBcnJheShhcnJheUxlbmd0aCk7CiAgICAgICAgbGV0IG9mZnNldCA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgY29uc3QgcDAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBjb25zdCBwMSA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgICAgICBjb25zdCBoMCA9IGhhc0hlaWdodEFycmF5ID8gaGVpZ2h0W2ldIDogaGVpZ2h0OwogICAgICAgICAgY29uc3QgaDEgPSBoYXNIZWlnaHRBcnJheSA/IGhlaWdodFtpICsgMV0gOiBoZWlnaHQ7CiAgICAgICAgICBvZmZzZXQgPSBnZW5lcmF0ZUNhcnRlc2lhblJodW1iQXJjKAogICAgICAgICAgICBwMCwKICAgICAgICAgICAgcDEsCiAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIGgwLAogICAgICAgICAgICBoMSwKICAgICAgICAgICAgbmV3UG9zaXRpb25zLAogICAgICAgICAgICBvZmZzZXQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHN1YmRpdmlkZUhlaWdodHNTY3JhdGNoQXJyYXkubGVuZ3RoID0gMDsKICAgICAgICBjb25zdCBsYXN0UG9pbnQgPSBwb3NpdGlvbnNbbGVuZ3RoIC0gMV07CiAgICAgICAgY29uc3QgY2FydG8gPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMobGFzdFBvaW50LCBjYXJ0bzEpOwogICAgICAgIGNhcnRvLmhlaWdodCA9IGhhc0hlaWdodEFycmF5ID8gaGVpZ2h0W2xlbmd0aCAtIDFdIDogaGVpZ2h0OwogICAgICAgIGNvbnN0IGNhcnQgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oY2FydG8sIGNhcnRlc2lhbik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soY2FydCwgbmV3UG9zaXRpb25zLCBhcnJheUxlbmd0aCAtIDMpOwogICAgICAgIHJldHVybiBuZXdQb3NpdGlvbnM7CiAgICAgIH07CiAgICAgIFBvbHlsaW5lUGlwZWxpbmUuZ2VuZXJhdGVDYXJ0ZXNpYW5BcmMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgbnVtYmVyQXJyYXkgPSBQb2x5bGluZVBpcGVsaW5lLmdlbmVyYXRlQXJjKG9wdGlvbnMpOwogICAgICAgIGNvbnN0IHNpemUgPSBudW1iZXJBcnJheS5sZW5ndGggLyAzOwogICAgICAgIGNvbnN0IG5ld1Bvc2l0aW9ucyA9IG5ldyBBcnJheShzaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNpemU7IGkrKykgewogICAgICAgICAgbmV3UG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhudW1iZXJBcnJheSwgaSAqIDMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3UG9zaXRpb25zOwogICAgICB9OwogICAgICBQb2x5bGluZVBpcGVsaW5lLmdlbmVyYXRlQ2FydGVzaWFuUmh1bWJBcmMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgY29uc3QgbnVtYmVyQXJyYXkgPSBQb2x5bGluZVBpcGVsaW5lLmdlbmVyYXRlUmh1bWJBcmMob3B0aW9ucyk7CiAgICAgICAgY29uc3Qgc2l6ZSA9IG51bWJlckFycmF5Lmxlbmd0aCAvIDM7CiAgICAgICAgY29uc3QgbmV3UG9zaXRpb25zID0gbmV3IEFycmF5KHNpemUpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7CiAgICAgICAgICBuZXdQb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKG51bWJlckFycmF5LCBpICogMyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdQb3NpdGlvbnM7CiAgICAgIH07CiAgICAgIFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdCA9IFBvbHlsaW5lUGlwZWxpbmU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9vbmVUaW1lV2FybmluZy5qcwogIGZ1bmN0aW9uIG9uZVRpbWVXYXJuaW5nKGlkZW50aWZpZXIsIG1lc3NhZ2UpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGlkZW50aWZpZXIpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJpZGVudGlmaWVyIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQod2FybmluZ3NbaWRlbnRpZmllcl0pKSB7CiAgICAgIHdhcm5pbmdzW2lkZW50aWZpZXJdID0gdHJ1ZTsKICAgICAgY29uc29sZS53YXJuKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG1lc3NhZ2UsIGlkZW50aWZpZXIpKTsKICAgIH0KICB9CiAgdmFyIHdhcm5pbmdzLCBvbmVUaW1lV2FybmluZ19kZWZhdWx0OwogIHZhciBpbml0X29uZVRpbWVXYXJuaW5nID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9vbmVUaW1lV2FybmluZy5qcyIoKSB7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIHdhcm5pbmdzID0ge307CiAgICAgIG9uZVRpbWVXYXJuaW5nLmdlb21ldHJ5T3V0bGluZXMgPSAiRW50aXR5IGdlb21ldHJ5IG91dGxpbmVzIGFyZSB1bnN1cHBvcnRlZCBvbiB0ZXJyYWluLiBPdXRsaW5lcyB3aWxsIGJlIGRpc2FibGVkLiBUbyBlbmFibGUgb3V0bGluZXMsIGRpc2FibGUgZ2VvbWV0cnkgdGVycmFpbiBjbGFtcGluZyBieSBleHBsaWNpdGx5IHNldHRpbmcgaGVpZ2h0IHRvIDAuIjsKICAgICAgb25lVGltZVdhcm5pbmcuZ2VvbWV0cnlaSW5kZXggPSAiRW50aXR5IGdlb21ldHJ5IHdpdGggekluZGV4IGFyZSB1bnN1cHBvcnRlZCB3aGVuIGhlaWdodCBvciBleHRydWRlZEhlaWdodCBhcmUgZGVmaW5lZC4gIHpJbmRleCB3aWxsIGJlIGlnbm9yZWQiOwogICAgICBvbmVUaW1lV2FybmluZy5nZW9tZXRyeUhlaWdodFJlZmVyZW5jZSA9ICJFbnRpdHkgY29ycmlkb3IsIGVsbGlwc2UsIHBvbHlnb24gb3IgcmVjdGFuZ2xlIHdpdGggaGVpZ2h0UmVmZXJlbmNlIG11c3QgYWxzbyBoYXZlIGEgZGVmaW5lZCBoZWlnaHQuICBoZWlnaHRSZWZlcmVuY2Ugd2lsbCBiZSBpZ25vcmVkIjsKICAgICAgb25lVGltZVdhcm5pbmcuZ2VvbWV0cnlFeHRydWRlZEhlaWdodFJlZmVyZW5jZSA9ICJFbnRpdHkgY29ycmlkb3IsIGVsbGlwc2UsIHBvbHlnb24gb3IgcmVjdGFuZ2xlIHdpdGggZXh0cnVkZWRIZWlnaHRSZWZlcmVuY2UgbXVzdCBhbHNvIGhhdmUgYSBkZWZpbmVkIGV4dHJ1ZGVkSGVpZ2h0LiAgZXh0cnVkZWRIZWlnaHRSZWZlcmVuY2Ugd2lsbCBiZSBpZ25vcmVkIjsKICAgICAgb25lVGltZVdhcm5pbmdfZGVmYXVsdCA9IG9uZVRpbWVXYXJuaW5nOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnkuanMKICBmdW5jdGlvbiBzY2FsZVRvU3VyZmFjZShwb3NpdGlvbnMsIGVsbGlwc29pZCkgewogICAgY29uc3QgaGVpZ2h0cyA9IG5ldyBBcnJheShwb3NpdGlvbnMubGVuZ3RoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHBvcyA9IHBvc2l0aW9uc1tpXTsKICAgICAgY2FydG9ncmFwaGljID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHBvcywgY2FydG9ncmFwaGljKTsKICAgICAgaGVpZ2h0c1tpXSA9IGNhcnRvZ3JhcGhpYy5oZWlnaHQ7CiAgICAgIHBvc2l0aW9uc1tpXSA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHBvcywgcG9zKTsKICAgIH0KICAgIHJldHVybiBoZWlnaHRzOwogIH0KICBmdW5jdGlvbiBzdWJkaXZpZGVIZWlnaHRzMihwb2ludHMsIGgwLCBoMSwgZ3JhbnVsYXJpdHkpIHsKICAgIGNvbnN0IHAwID0gcG9pbnRzWzBdOwogICAgY29uc3QgcDEgPSBwb2ludHNbMV07CiAgICBjb25zdCBhbmdsZUJldHdlZW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYW5nbGVCZXR3ZWVuKHAwLCBwMSk7CiAgICBjb25zdCBudW1Qb2ludHMgPSBNYXRoLmNlaWwoYW5nbGVCZXR3ZWVuIC8gZ3JhbnVsYXJpdHkpOwogICAgY29uc3QgaGVpZ2h0cyA9IG5ldyBBcnJheShudW1Qb2ludHMpOwogICAgbGV0IGk7CiAgICBpZiAoaDAgPT09IGgxKSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1Qb2ludHM7IGkrKykgewogICAgICAgIGhlaWdodHNbaV0gPSBoMDsKICAgICAgfQogICAgICBoZWlnaHRzLnB1c2goaDEpOwogICAgICByZXR1cm4gaGVpZ2h0czsKICAgIH0KICAgIGNvbnN0IGRIZWlnaHQgPSBoMSAtIGgwOwogICAgY29uc3QgaGVpZ2h0UGVyVmVydGV4ID0gZEhlaWdodCAvIG51bVBvaW50czsKICAgIGZvciAoaSA9IDE7IGkgPCBudW1Qb2ludHM7IGkrKykgewogICAgICBjb25zdCBoID0gaDAgKyBpICogaGVpZ2h0UGVyVmVydGV4OwogICAgICBoZWlnaHRzW2ldID0gaDsKICAgIH0KICAgIGhlaWdodHNbMF0gPSBoMDsKICAgIGhlaWdodHMucHVzaChoMSk7CiAgICByZXR1cm4gaGVpZ2h0czsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVJvdGF0aW9uQW5nbGUoc3RhcnQsIGVuZCwgcG9zaXRpb24sIGVsbGlwc29pZCkgewogICAgY29uc3QgdGFuZ2VudFBsYW5lID0gbmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0KHBvc2l0aW9uLCBlbGxpcHNvaWQpOwogICAgY29uc3QgbmV4dCA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRPbnRvUGxhbmUoCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIHN0YXJ0LCBuZXh0U2NyYXRjaCksCiAgICAgIG5leHRTY3JhdGNoCiAgICApOwogICAgY29uc3QgcHJldiA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRPbnRvUGxhbmUoCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIGVuZCwgcHJldlNjcmF0Y2gpLAogICAgICBwcmV2U2NyYXRjaAogICAgKTsKICAgIGNvbnN0IGFuZ2xlID0gQ2FydGVzaWFuMl9kZWZhdWx0LmFuZ2xlQmV0d2VlbihuZXh0LCBwcmV2KTsKICAgIHJldHVybiBwcmV2LnggKiBuZXh0LnkgLSBwcmV2LnkgKiBuZXh0LnggPj0gMCA/IC1hbmdsZSA6IGFuZ2xlOwogIH0KICBmdW5jdGlvbiBhZGRQb3NpdGlvbihjZW50ZXIsIGxlZnQsIHNoYXBlLCBmaW5hbFBvc2l0aW9ucywgZWxsaXBzb2lkLCBoZWlnaHQsIHhTY2FsYXIsIHJlcGVhdCkgewogICAgbGV0IHdlc3QgPSB3ZXN0U2NyYXRjaDsKICAgIGxldCBmaW5hbFBvc2l0aW9uID0gZmluYWxQb3NTY3JhdGNoOwogICAgdHJhbnNmb3JtID0gVHJhbnNmb3Jtc19kZWZhdWx0LmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lKGNlbnRlciwgZWxsaXBzb2lkLCB0cmFuc2Zvcm0pOwogICAgd2VzdCA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnRBc1ZlY3Rvcih0cmFuc2Zvcm0sIG5lZ2F0aXZlWCwgd2VzdCk7CiAgICB3ZXN0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh3ZXN0LCB3ZXN0KTsKICAgIGNvbnN0IGFuZ2xlID0gY29tcHV0ZVJvdGF0aW9uQW5nbGUod2VzdCwgbGVmdCwgY2VudGVyLCBlbGxpcHNvaWQpOwogICAgcm90YXRpb25aID0gTWF0cml4M19kZWZhdWx0LmZyb21Sb3RhdGlvblooYW5nbGUsIHJvdGF0aW9uWik7CiAgICBoZWlnaHRDYXJ0ZXNpYW4ueiA9IGhlaWdodDsKICAgIHRyYW5zZm9ybSA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseVRyYW5zZm9ybWF0aW9uKAogICAgICB0cmFuc2Zvcm0sCiAgICAgIE1hdHJpeDRfZGVmYXVsdC5mcm9tUm90YXRpb25UcmFuc2xhdGlvbihyb3RhdGlvblosIGhlaWdodENhcnRlc2lhbiwgdHJhbnNsYXRpb24pLAogICAgICB0cmFuc2Zvcm0KICAgICk7CiAgICBjb25zdCBzY2FsZSA9IHNjYWxlTWF0cml4OwogICAgc2NhbGVbMF0gPSB4U2NhbGFyOwogICAgZm9yIChsZXQgaiA9IDA7IGogPCByZXBlYXQ7IGorKykgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNoYXBlLmxlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgZmluYWxQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoc2hhcGUsIGksIGZpbmFsUG9zaXRpb24pOwogICAgICAgIGZpbmFsUG9zaXRpb24gPSBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcigKICAgICAgICAgIHNjYWxlLAogICAgICAgICAgZmluYWxQb3NpdGlvbiwKICAgICAgICAgIGZpbmFsUG9zaXRpb24KICAgICAgICApOwogICAgICAgIGZpbmFsUG9zaXRpb24gPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KAogICAgICAgICAgdHJhbnNmb3JtLAogICAgICAgICAgZmluYWxQb3NpdGlvbiwKICAgICAgICAgIGZpbmFsUG9zaXRpb24KICAgICAgICApOwogICAgICAgIGZpbmFsUG9zaXRpb25zLnB1c2goZmluYWxQb3NpdGlvbi54LCBmaW5hbFBvc2l0aW9uLnksIGZpbmFsUG9zaXRpb24ueik7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmaW5hbFBvc2l0aW9uczsKICB9CiAgZnVuY3Rpb24gYWRkUG9zaXRpb25zKGNlbnRlcnMsIGxlZnQsIHNoYXBlLCBmaW5hbFBvc2l0aW9ucywgZWxsaXBzb2lkLCBoZWlnaHRzLCB4U2NhbGFyKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNlbnRlcnMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgY29uc3QgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShjZW50ZXJzLCBpLCBjZW50ZXJTY3JhdGNoMik7CiAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb24oCiAgICAgICAgY2VudGVyLAogICAgICAgIGxlZnQsCiAgICAgICAgc2hhcGUsCiAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIGhlaWdodHNbaSAvIDNdLAogICAgICAgIHhTY2FsYXIsCiAgICAgICAgMQogICAgICApOwogICAgfQogICAgcmV0dXJuIGZpbmFsUG9zaXRpb25zOwogIH0KICBmdW5jdGlvbiBjb252ZXJ0U2hhcGVUbzNERHVwbGljYXRlKHNoYXBlMkQsIGJvdW5kaW5nUmVjdGFuZ2xlKSB7CiAgICBjb25zdCBsZW5ndGggPSBzaGFwZTJELmxlbmd0aDsKICAgIGNvbnN0IHNoYXBlID0gbmV3IEFycmF5KGxlbmd0aCAqIDYpOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGNvbnN0IHhPZmZzZXQgPSBib3VuZGluZ1JlY3RhbmdsZS54ICsgYm91bmRpbmdSZWN0YW5nbGUud2lkdGggLyAyOwogICAgY29uc3QgeU9mZnNldCA9IGJvdW5kaW5nUmVjdGFuZ2xlLnkgKyBib3VuZGluZ1JlY3RhbmdsZS5oZWlnaHQgLyAyOwogICAgbGV0IHBvaW50ID0gc2hhcGUyRFswXTsKICAgIHNoYXBlW2luZGV4KytdID0gcG9pbnQueCAtIHhPZmZzZXQ7CiAgICBzaGFwZVtpbmRleCsrXSA9IDA7CiAgICBzaGFwZVtpbmRleCsrXSA9IHBvaW50LnkgLSB5T2Zmc2V0OwogICAgZm9yIChsZXQgaSA9IDE7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBwb2ludCA9IHNoYXBlMkRbaV07CiAgICAgIGNvbnN0IHggPSBwb2ludC54IC0geE9mZnNldDsKICAgICAgY29uc3QgeiA9IHBvaW50LnkgLSB5T2Zmc2V0OwogICAgICBzaGFwZVtpbmRleCsrXSA9IHg7CiAgICAgIHNoYXBlW2luZGV4KytdID0gMDsKICAgICAgc2hhcGVbaW5kZXgrK10gPSB6OwogICAgICBzaGFwZVtpbmRleCsrXSA9IHg7CiAgICAgIHNoYXBlW2luZGV4KytdID0gMDsKICAgICAgc2hhcGVbaW5kZXgrK10gPSB6OwogICAgfQogICAgcG9pbnQgPSBzaGFwZTJEWzBdOwogICAgc2hhcGVbaW5kZXgrK10gPSBwb2ludC54IC0geE9mZnNldDsKICAgIHNoYXBlW2luZGV4KytdID0gMDsKICAgIHNoYXBlW2luZGV4KytdID0gcG9pbnQueSAtIHlPZmZzZXQ7CiAgICByZXR1cm4gc2hhcGU7CiAgfQogIGZ1bmN0aW9uIGNvbnZlcnRTaGFwZVRvM0Qoc2hhcGUyRCwgYm91bmRpbmdSZWN0YW5nbGUpIHsKICAgIGNvbnN0IGxlbmd0aCA9IHNoYXBlMkQubGVuZ3RoOwogICAgY29uc3Qgc2hhcGUgPSBuZXcgQXJyYXkobGVuZ3RoICogMyk7CiAgICBsZXQgaW5kZXggPSAwOwogICAgY29uc3QgeE9mZnNldCA9IGJvdW5kaW5nUmVjdGFuZ2xlLnggKyBib3VuZGluZ1JlY3RhbmdsZS53aWR0aCAvIDI7CiAgICBjb25zdCB5T2Zmc2V0ID0gYm91bmRpbmdSZWN0YW5nbGUueSArIGJvdW5kaW5nUmVjdGFuZ2xlLmhlaWdodCAvIDI7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHNoYXBlW2luZGV4KytdID0gc2hhcGUyRFtpXS54IC0geE9mZnNldDsKICAgICAgc2hhcGVbaW5kZXgrK10gPSAwOwogICAgICBzaGFwZVtpbmRleCsrXSA9IHNoYXBlMkRbaV0ueSAtIHlPZmZzZXQ7CiAgICB9CiAgICByZXR1cm4gc2hhcGU7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVSb3VuZENvcm5lcihwaXZvdCwgc3RhcnRQb2ludCwgZW5kUG9pbnQsIGNvcm5lclR5cGUsIGxlZnRJc091dHNpZGUsIGVsbGlwc29pZCwgZmluYWxQb3NpdGlvbnMsIHNoYXBlLCBoZWlnaHQsIGR1cGxpY2F0ZVBvaW50cykgewogICAgY29uc3QgYW5nbGUgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYW5nbGVCZXR3ZWVuKAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qoc3RhcnRQb2ludCwgcGl2b3QsIHNjcmF0Y2gxKSwKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGVuZFBvaW50LCBwaXZvdCwgc2NyYXRjaDIpCiAgICApOwogICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuQkVWRUxFRCA/IDAgOiBNYXRoLmNlaWwoYW5nbGUgLyBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKDUpKTsKICAgIGxldCBtOwogICAgaWYgKGxlZnRJc091dHNpZGUpIHsKICAgICAgbSA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbigKICAgICAgICBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUocGl2b3QsIHNjcmF0Y2gxKSwKICAgICAgICAgIGFuZ2xlIC8gKGdyYW51bGFyaXR5ICsgMSksCiAgICAgICAgICBxdWF0ZXJpb24KICAgICAgICApLAogICAgICAgIHJvdE1hdHJpeAogICAgICApOwogICAgfSBlbHNlIHsKICAgICAgbSA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbigKICAgICAgICBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZShwaXZvdCwgYW5nbGUgLyAoZ3JhbnVsYXJpdHkgKyAxKSwgcXVhdGVyaW9uKSwKICAgICAgICByb3RNYXRyaXgKICAgICAgKTsKICAgIH0KICAgIGxldCBsZWZ0OwogICAgbGV0IHN1cmZhY2VQb2ludDsKICAgIHN0YXJ0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoc3RhcnRQb2ludCwgc3RhcnRQb2ludFNjcmF0Y2gpOwogICAgaWYgKGdyYW51bGFyaXR5ID4gMCkgewogICAgICBjb25zdCByZXBlYXQgPSBkdXBsaWNhdGVQb2ludHMgPyAyIDogMTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBncmFudWxhcml0eTsgaSsrKSB7CiAgICAgICAgc3RhcnRQb2ludCA9IE1hdHJpeDNfZGVmYXVsdC5tdWx0aXBseUJ5VmVjdG9yKG0sIHN0YXJ0UG9pbnQsIHN0YXJ0UG9pbnQpOwogICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qoc3RhcnRQb2ludCwgcGl2b3QsIHNjcmF0Y2gxKTsKICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShsZWZ0LCBsZWZ0KTsKICAgICAgICBpZiAoIWxlZnRJc091dHNpZGUpIHsKICAgICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGxlZnQsIGxlZnQpOwogICAgICAgIH0KICAgICAgICBzdXJmYWNlUG9pbnQgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShzdGFydFBvaW50LCBzY3JhdGNoMik7CiAgICAgICAgZmluYWxQb3NpdGlvbnMgPSBhZGRQb3NpdGlvbigKICAgICAgICAgIHN1cmZhY2VQb2ludCwKICAgICAgICAgIGxlZnQsCiAgICAgICAgICBzaGFwZSwKICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgMSwKICAgICAgICAgIHJlcGVhdAogICAgICAgICk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qoc3RhcnRQb2ludCwgcGl2b3QsIHNjcmF0Y2gxKTsKICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobGVmdCwgbGVmdCk7CiAgICAgIGlmICghbGVmdElzT3V0c2lkZSkgewogICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGxlZnQsIGxlZnQpOwogICAgICB9CiAgICAgIHN1cmZhY2VQb2ludCA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHN0YXJ0UG9pbnQsIHNjcmF0Y2gyKTsKICAgICAgZmluYWxQb3NpdGlvbnMgPSBhZGRQb3NpdGlvbigKICAgICAgICBzdXJmYWNlUG9pbnQsCiAgICAgICAgbGVmdCwKICAgICAgICBzaGFwZSwKICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgaGVpZ2h0LAogICAgICAgIDEsCiAgICAgICAgMQogICAgICApOwogICAgICBlbmRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbmRQb2ludCwgc3RhcnRQb2ludFNjcmF0Y2gpOwogICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGVuZFBvaW50LCBwaXZvdCwgc2NyYXRjaDEpOwogICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShsZWZ0LCBsZWZ0KTsKICAgICAgaWYgKCFsZWZ0SXNPdXRzaWRlKSB7CiAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUobGVmdCwgbGVmdCk7CiAgICAgIH0KICAgICAgc3VyZmFjZVBvaW50ID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UoZW5kUG9pbnQsIHNjcmF0Y2gyKTsKICAgICAgZmluYWxQb3NpdGlvbnMgPSBhZGRQb3NpdGlvbigKICAgICAgICBzdXJmYWNlUG9pbnQsCiAgICAgICAgbGVmdCwKICAgICAgICBzaGFwZSwKICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgaGVpZ2h0LAogICAgICAgIDEsCiAgICAgICAgMQogICAgICApOwogICAgfQogICAgcmV0dXJuIGZpbmFsUG9zaXRpb25zOwogIH0KICB2YXIgc2NyYXRjaDJBcnJheSwgc2NyYXRjaENhcnRlc2lhbjE2LCBzY3JhdGNoQ2FydGVzaWFuMjYsIHNjcmF0Y2hDYXJ0ZXNpYW4zNywgc2NyYXRjaENhcnRlc2lhbjQzLCBzY3JhdGNoQ2FydGVzaWFuNTIsIHNjcmF0Y2hDYXJ0ZXNpYW42Miwgc2NyYXRjaENhcnRlc2lhbjcsIHNjcmF0Y2hDYXJ0ZXNpYW44LCBzY3JhdGNoQ2FydGVzaWFuOSwgc2NyYXRjaDEsIHNjcmF0Y2gyLCBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeSwgY2FydG9ncmFwaGljLCBuZXh0U2NyYXRjaCwgcHJldlNjcmF0Y2gsIG5lZ2F0aXZlWCwgdHJhbnNmb3JtLCB0cmFuc2xhdGlvbiwgcm90YXRpb25aLCBzY2FsZU1hdHJpeCwgd2VzdFNjcmF0Y2gsIGZpbmFsUG9zU2NyYXRjaCwgaGVpZ2h0Q2FydGVzaWFuLCBjZW50ZXJTY3JhdGNoMiwgcXVhdGVyaW9uLCBzdGFydFBvaW50U2NyYXRjaCwgcm90TWF0cml4LCBzY3JhdGNoRm9yd2FyZFByb2plY3Rpb24sIHNjcmF0Y2hCYWNrd2FyZFByb2plY3Rpb24sIFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRlc2lhbjQoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9Db3JuZXJUeXBlKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkVGFuZ2VudFBsYW5lKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfUG9seWxpbmVQaXBlbGluZSgpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgaW5pdF9UcmFuc2Zvcm1zKCk7CiAgICAgIGluaXRfb25lVGltZVdhcm5pbmcoKTsKICAgICAgc2NyYXRjaDJBcnJheSA9IFtuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKV07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xNiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjI2ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMzcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW40MyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjUyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuNjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW43ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuOCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2gxID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnkgPSB7fTsKICAgICAgY2FydG9ncmFwaGljID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIG5leHRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwcmV2U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbmVnYXRpdmVYID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgtMSwgMCwgMCk7CiAgICAgIHRyYW5zZm9ybSA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgdHJhbnNsYXRpb24gPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIHJvdGF0aW9uWiA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgc2NhbGVNYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuSURFTlRJVFkuY2xvbmUoKTsKICAgICAgd2VzdFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZpbmFsUG9zU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgaGVpZ2h0Q2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjZW50ZXJTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcXVhdGVyaW9uID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBzdGFydFBvaW50U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcm90TWF0cml4ID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeS5yZW1vdmVEdXBsaWNhdGVzRnJvbVNoYXBlID0gZnVuY3Rpb24oc2hhcGVQb3NpdGlvbnMpIHsKICAgICAgICBjb25zdCBsZW5ndGggPSBzaGFwZVBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgY2xlYW5lZFBvc2l0aW9ucyA9IFtdOwogICAgICAgIGZvciAobGV0IGkwID0gbGVuZ3RoIC0gMSwgaTEgPSAwOyBpMSA8IGxlbmd0aDsgaTAgPSBpMSsrKSB7CiAgICAgICAgICBjb25zdCB2MDIgPSBzaGFwZVBvc2l0aW9uc1tpMF07CiAgICAgICAgICBjb25zdCB2MTIgPSBzaGFwZVBvc2l0aW9uc1tpMV07CiAgICAgICAgICBpZiAoIUNhcnRlc2lhbjJfZGVmYXVsdC5lcXVhbHModjAyLCB2MTIpKSB7CiAgICAgICAgICAgIGNsZWFuZWRQb3NpdGlvbnMucHVzaCh2MTIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gY2xlYW5lZFBvc2l0aW9uczsKICAgICAgfTsKICAgICAgUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnkuYW5nbGVJc0dyZWF0ZXJUaGFuUGkgPSBmdW5jdGlvbihmb3J3YXJkLCBiYWNrd2FyZCwgcG9zaXRpb24sIGVsbGlwc29pZCkgewogICAgICAgIGNvbnN0IHRhbmdlbnRQbGFuZSA9IG5ldyBFbGxpcHNvaWRUYW5nZW50UGxhbmVfZGVmYXVsdChwb3NpdGlvbiwgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBuZXh0ID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludE9udG9QbGFuZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIGZvcndhcmQsIG5leHRTY3JhdGNoKSwKICAgICAgICAgIG5leHRTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBwcmV2ID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludE9udG9QbGFuZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIGJhY2t3YXJkLCBwcmV2U2NyYXRjaCksCiAgICAgICAgICBwcmV2U2NyYXRjaAogICAgICAgICk7CiAgICAgICAgcmV0dXJuIHByZXYueCAqIG5leHQueSAtIHByZXYueSAqIG5leHQueCA+PSAwOwogICAgICB9OwogICAgICBzY3JhdGNoRm9yd2FyZFByb2plY3Rpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCYWNrd2FyZFByb2plY3Rpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVQb3NpdGlvbnMgPSBmdW5jdGlvbihwb3NpdGlvbnMsIHNoYXBlMkQsIGJvdW5kaW5nUmVjdGFuZ2xlLCBnZW9tZXRyeSwgZHVwbGljYXRlUG9pbnRzKSB7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gZ2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBoZWlnaHRzID0gc2NhbGVUb1N1cmZhY2UocG9zaXRpb25zLCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZ2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGNvcm5lclR5cGUgPSBnZW9tZXRyeS5fY29ybmVyVHlwZTsKICAgICAgICBjb25zdCBzaGFwZUZvclNpZGVzID0gZHVwbGljYXRlUG9pbnRzID8gY29udmVydFNoYXBlVG8zRER1cGxpY2F0ZShzaGFwZTJELCBib3VuZGluZ1JlY3RhbmdsZSkgOiBjb252ZXJ0U2hhcGVUbzNEKHNoYXBlMkQsIGJvdW5kaW5nUmVjdGFuZ2xlKTsKICAgICAgICBjb25zdCBzaGFwZUZvckVuZHMgPSBkdXBsaWNhdGVQb2ludHMgPyBjb252ZXJ0U2hhcGVUbzNEKHNoYXBlMkQsIGJvdW5kaW5nUmVjdGFuZ2xlKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBoZWlnaHRPZmZzZXQgPSBib3VuZGluZ1JlY3RhbmdsZS5oZWlnaHQgLyAyOwogICAgICAgIGNvbnN0IHdpZHRoID0gYm91bmRpbmdSZWN0YW5nbGUud2lkdGggLyAyOwogICAgICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBmaW5hbFBvc2l0aW9ucyA9IFtdOwogICAgICAgIGxldCBlbmRzID0gZHVwbGljYXRlUG9pbnRzID8gW10gOiB2b2lkIDA7CiAgICAgICAgbGV0IGZvcndhcmQgPSBzY3JhdGNoQ2FydGVzaWFuMTY7CiAgICAgICAgbGV0IGJhY2t3YXJkID0gc2NyYXRjaENhcnRlc2lhbjI2OwogICAgICAgIGxldCBjb3JuZXJEaXJlY3Rpb24gPSBzY3JhdGNoQ2FydGVzaWFuMzc7CiAgICAgICAgbGV0IHN1cmZhY2VOb3JtYWwgPSBzY3JhdGNoQ2FydGVzaWFuNDM7CiAgICAgICAgbGV0IHBpdm90ID0gc2NyYXRjaENhcnRlc2lhbjUyOwogICAgICAgIGxldCBzdGFydCA9IHNjcmF0Y2hDYXJ0ZXNpYW42MjsKICAgICAgICBsZXQgZW5kID0gc2NyYXRjaENhcnRlc2lhbjc7CiAgICAgICAgbGV0IGxlZnQgPSBzY3JhdGNoQ2FydGVzaWFuODsKICAgICAgICBsZXQgcHJldmlvdXNQb3NpdGlvbiA9IHNjcmF0Y2hDYXJ0ZXNpYW45OwogICAgICAgIGxldCBwb3NpdGlvbiA9IHBvc2l0aW9uc1swXTsKICAgICAgICBsZXQgbmV4dFBvc2l0aW9uID0gcG9zaXRpb25zWzFdOwogICAgICAgIHN1cmZhY2VOb3JtYWwgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBzdXJmYWNlTm9ybWFsKTsKICAgICAgICBmb3J3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5leHRQb3NpdGlvbiwgcG9zaXRpb24sIGZvcndhcmQpOwogICAgICAgIGZvcndhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGZvcndhcmQsIGZvcndhcmQpOwogICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Moc3VyZmFjZU5vcm1hbCwgZm9yd2FyZCwgbGVmdCk7CiAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobGVmdCwgbGVmdCk7CiAgICAgICAgbGV0IGgwID0gaGVpZ2h0c1swXTsKICAgICAgICBsZXQgaDEgPSBoZWlnaHRzWzFdOwogICAgICAgIGlmIChkdXBsaWNhdGVQb2ludHMpIHsKICAgICAgICAgIGVuZHMgPSBhZGRQb3NpdGlvbigKICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgIGxlZnQsCiAgICAgICAgICAgIHNoYXBlRm9yRW5kcywKICAgICAgICAgICAgZW5kcywKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBoMCArIGhlaWdodE9mZnNldCwKICAgICAgICAgICAgMSwKICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcHJldmlvdXNQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbiwgcHJldmlvdXNQb3NpdGlvbik7CiAgICAgICAgcG9zaXRpb24gPSBuZXh0UG9zaXRpb247CiAgICAgICAgYmFja3dhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGZvcndhcmQsIGJhY2t3YXJkKTsKICAgICAgICBsZXQgc3ViZGl2aWRlZEhlaWdodHM7CiAgICAgICAgbGV0IHN1YmRpdmlkZWRQb3NpdGlvbnM7CiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHJlcGVhdCA9IGR1cGxpY2F0ZVBvaW50cyA/IDIgOiAxOwogICAgICAgICAgbmV4dFBvc2l0aW9uID0gcG9zaXRpb25zW2kgKyAxXTsKICAgICAgICAgIGlmIChwb3NpdGlvbi5lcXVhbHMobmV4dFBvc2l0aW9uKSkgewogICAgICAgICAgICBvbmVUaW1lV2FybmluZ19kZWZhdWx0KAogICAgICAgICAgICAgICJQb3NpdGlvbnMgYXJlIHRvbyBjbG9zZSBhbmQgYXJlIGNvbnNpZGVyZWQgZXF1aXZhbGVudCB3aXRoIHJvdW5kaW5nIGVycm9yLiIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBmb3J3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5leHRQb3NpdGlvbiwgcG9zaXRpb24sIGZvcndhcmQpOwogICAgICAgICAgZm9yd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZm9yd2FyZCwgZm9yd2FyZCk7CiAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGZvcndhcmQsIGJhY2t3YXJkLCBjb3JuZXJEaXJlY3Rpb24pOwogICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShjb3JuZXJEaXJlY3Rpb24sIGNvcm5lckRpcmVjdGlvbik7CiAgICAgICAgICBzdXJmYWNlTm9ybWFsID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgc3VyZmFjZU5vcm1hbCk7CiAgICAgICAgICBjb25zdCBmb3J3YXJkUHJvamVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICBzdXJmYWNlTm9ybWFsLAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGZvcndhcmQsIHN1cmZhY2VOb3JtYWwpLAogICAgICAgICAgICBzY3JhdGNoRm9yd2FyZFByb2plY3Rpb24KICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoZm9yd2FyZCwgZm9yd2FyZFByb2plY3Rpb24sIGZvcndhcmRQcm9qZWN0aW9uKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZm9yd2FyZFByb2plY3Rpb24sIGZvcndhcmRQcm9qZWN0aW9uKTsKICAgICAgICAgIGNvbnN0IGJhY2t3YXJkUHJvamVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICBzdXJmYWNlTm9ybWFsLAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGJhY2t3YXJkLCBzdXJmYWNlTm9ybWFsKSwKICAgICAgICAgICAgc2NyYXRjaEJhY2t3YXJkUHJvamVjdGlvbgogICAgICAgICAgKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChiYWNrd2FyZCwgYmFja3dhcmRQcm9qZWN0aW9uLCBiYWNrd2FyZFByb2plY3Rpb24pOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShiYWNrd2FyZFByb2plY3Rpb24sIGJhY2t3YXJkUHJvamVjdGlvbik7CiAgICAgICAgICBjb25zdCBkb0Nvcm5lciA9ICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgICAgTWF0aC5hYnMoQ2FydGVzaWFuM19kZWZhdWx0LmRvdChmb3J3YXJkUHJvamVjdGlvbiwgYmFja3dhcmRQcm9qZWN0aW9uKSksCiAgICAgICAgICAgIDEsCiAgICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9ONwogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkb0Nvcm5lcikgewogICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgIHN1cmZhY2VOb3JtYWwsCiAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgICAgICAgICBzdXJmYWNlTm9ybWFsLAogICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiwKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24KICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShjb3JuZXJEaXJlY3Rpb24sIGNvcm5lckRpcmVjdGlvbik7CiAgICAgICAgICAgIGNvbnN0IHNjYWxhciA9IDEgLyBNYXRoLm1heCgKICAgICAgICAgICAgICAwLjI1LAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoY29ybmVyRGlyZWN0aW9uLCBiYWNrd2FyZCwgc2NyYXRjaDEpCiAgICAgICAgICAgICAgKQogICAgICAgICAgICApOwogICAgICAgICAgICBjb25zdCBsZWZ0SXNPdXRzaWRlID0gUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnkuYW5nbGVJc0dyZWF0ZXJUaGFuUGkoCiAgICAgICAgICAgICAgZm9yd2FyZCwKICAgICAgICAgICAgICBiYWNrd2FyZCwKICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGxlZnRJc091dHNpZGUpIHsKICAgICAgICAgICAgICBwaXZvdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24sCiAgICAgICAgICAgICAgICAgIHNjYWxhciAqIHdpZHRoLAogICAgICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24KICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBwaXZvdAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc3RhcnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgcGl2b3QsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCB3aWR0aCwgc3RhcnQpLAogICAgICAgICAgICAgICAgc3RhcnQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHNjcmF0Y2gyQXJyYXlbMF0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocHJldmlvdXNQb3NpdGlvbiwgc2NyYXRjaDJBcnJheVswXSk7CiAgICAgICAgICAgICAgc2NyYXRjaDJBcnJheVsxXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShzdGFydCwgc2NyYXRjaDJBcnJheVsxXSk7CiAgICAgICAgICAgICAgc3ViZGl2aWRlZEhlaWdodHMgPSBzdWJkaXZpZGVIZWlnaHRzMigKICAgICAgICAgICAgICAgIHNjcmF0Y2gyQXJyYXksCiAgICAgICAgICAgICAgICBoMCArIGhlaWdodE9mZnNldCwKICAgICAgICAgICAgICAgIGgxICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgICAgICAgZ3JhbnVsYXJpdHkKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVBcmMoewogICAgICAgICAgICAgICAgcG9zaXRpb25zOiBzY3JhdGNoMkFycmF5LAogICAgICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBmaW5hbFBvc2l0aW9ucyA9IGFkZFBvc2l0aW9ucygKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICBsZWZ0LAogICAgICAgICAgICAgICAgc2hhcGVGb3JTaWRlcywKICAgICAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgc3ViZGl2aWRlZEhlaWdodHMsCiAgICAgICAgICAgICAgICAxCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHN1cmZhY2VOb3JtYWwsIGZvcndhcmQsIGxlZnQpOwogICAgICAgICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGxlZnQsIGxlZnQpOwogICAgICAgICAgICAgIGVuZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBwaXZvdCwKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHdpZHRoLCBlbmQpLAogICAgICAgICAgICAgICAgZW5kCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQgfHwgY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LkJFVkVMRUQpIHsKICAgICAgICAgICAgICAgIGNvbXB1dGVSb3VuZENvcm5lcigKICAgICAgICAgICAgICAgICAgcGl2b3QsCiAgICAgICAgICAgICAgICAgIHN0YXJ0LAogICAgICAgICAgICAgICAgICBlbmQsCiAgICAgICAgICAgICAgICAgIGNvcm5lclR5cGUsCiAgICAgICAgICAgICAgICAgIGxlZnRJc091dHNpZGUsCiAgICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICAgIHNoYXBlRm9yU2lkZXMsCiAgICAgICAgICAgICAgICAgIGgxICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgICAgICAgICBkdXBsaWNhdGVQb2ludHMKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoY29ybmVyRGlyZWN0aW9uLCBjb3JuZXJEaXJlY3Rpb24pOwogICAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMgPSBhZGRQb3NpdGlvbigKICAgICAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiwKICAgICAgICAgICAgICAgICAgc2hhcGVGb3JTaWRlcywKICAgICAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgICAgaDEgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgICAgICAgIHNjYWxhciwKICAgICAgICAgICAgICAgICAgcmVwZWF0CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c1Bvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGVuZCwgcHJldmlvdXNQb3NpdGlvbik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcGl2b3QgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uLAogICAgICAgICAgICAgICAgICBzY2FsYXIgKiB3aWR0aCwKICAgICAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgcGl2b3QKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHN0YXJ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIHBpdm90LAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgLXdpZHRoLCBzdGFydCksCiAgICAgICAgICAgICAgICBzdGFydAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc2NyYXRjaDJBcnJheVswXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwcmV2aW91c1Bvc2l0aW9uLCBzY3JhdGNoMkFycmF5WzBdKTsKICAgICAgICAgICAgICBzY3JhdGNoMkFycmF5WzFdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHN0YXJ0LCBzY3JhdGNoMkFycmF5WzFdKTsKICAgICAgICAgICAgICBzdWJkaXZpZGVkSGVpZ2h0cyA9IHN1YmRpdmlkZUhlaWdodHMyKAogICAgICAgICAgICAgICAgc2NyYXRjaDJBcnJheSwKICAgICAgICAgICAgICAgIGgwICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgICAgICAgaDEgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICAgICAgICBncmFudWxhcml0eQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYyh7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnM6IHNjcmF0Y2gyQXJyYXksCiAgICAgICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb25zKAogICAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgICAgICAgIGxlZnQsCiAgICAgICAgICAgICAgICBzaGFwZUZvclNpZGVzLAogICAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICBzdWJkaXZpZGVkSGVpZ2h0cywKICAgICAgICAgICAgICAgIDEKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Moc3VyZmFjZU5vcm1hbCwgZm9yd2FyZCwgbGVmdCk7CiAgICAgICAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobGVmdCwgbGVmdCk7CiAgICAgICAgICAgICAgZW5kID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIHBpdm90LAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgLXdpZHRoLCBlbmQpLAogICAgICAgICAgICAgICAgZW5kCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQgfHwgY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LkJFVkVMRUQpIHsKICAgICAgICAgICAgICAgIGNvbXB1dGVSb3VuZENvcm5lcigKICAgICAgICAgICAgICAgICAgcGl2b3QsCiAgICAgICAgICAgICAgICAgIHN0YXJ0LAogICAgICAgICAgICAgICAgICBlbmQsCiAgICAgICAgICAgICAgICAgIGNvcm5lclR5cGUsCiAgICAgICAgICAgICAgICAgIGxlZnRJc091dHNpZGUsCiAgICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICAgIHNoYXBlRm9yU2lkZXMsCiAgICAgICAgICAgICAgICAgIGgxICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgICAgICAgICBkdXBsaWNhdGVQb2ludHMKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb24oCiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24sCiAgICAgICAgICAgICAgICAgIHNoYXBlRm9yU2lkZXMsCiAgICAgICAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICAgIGgxICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgICAgICAgICBzY2FsYXIsCiAgICAgICAgICAgICAgICAgIHJlcGVhdAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJldmlvdXNQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbmQsIHByZXZpb3VzUG9zaXRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJhY2t3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShmb3J3YXJkLCBiYWNrd2FyZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmaW5hbFBvc2l0aW9ucyA9IGFkZFBvc2l0aW9uKAogICAgICAgICAgICAgIHByZXZpb3VzUG9zaXRpb24sCiAgICAgICAgICAgICAgbGVmdCwKICAgICAgICAgICAgICBzaGFwZUZvclNpZGVzLAogICAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICBoMCArIGhlaWdodE9mZnNldCwKICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgIDEKICAgICAgICAgICAgKTsKICAgICAgICAgICAgcHJldmlvdXNQb3NpdGlvbiA9IHBvc2l0aW9uOwogICAgICAgICAgfQogICAgICAgICAgaDAgPSBoMTsKICAgICAgICAgIGgxID0gaGVpZ2h0c1tpICsgMV07CiAgICAgICAgICBwb3NpdGlvbiA9IG5leHRQb3NpdGlvbjsKICAgICAgICB9CiAgICAgICAgc2NyYXRjaDJBcnJheVswXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwcmV2aW91c1Bvc2l0aW9uLCBzY3JhdGNoMkFycmF5WzBdKTsKICAgICAgICBzY3JhdGNoMkFycmF5WzFdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCBzY3JhdGNoMkFycmF5WzFdKTsKICAgICAgICBzdWJkaXZpZGVkSGVpZ2h0cyA9IHN1YmRpdmlkZUhlaWdodHMyKAogICAgICAgICAgc2NyYXRjaDJBcnJheSwKICAgICAgICAgIGgwICsgaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgaDEgKyBoZWlnaHRPZmZzZXQsCiAgICAgICAgICBncmFudWxhcml0eQogICAgICAgICk7CiAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYyh7CiAgICAgICAgICBwb3NpdGlvbnM6IHNjcmF0Y2gyQXJyYXksCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGVsbGlwc29pZAogICAgICAgIH0pOwogICAgICAgIGZpbmFsUG9zaXRpb25zID0gYWRkUG9zaXRpb25zKAogICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgIGxlZnQsCiAgICAgICAgICBzaGFwZUZvclNpZGVzLAogICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzdWJkaXZpZGVkSGVpZ2h0cywKICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIGlmIChkdXBsaWNhdGVQb2ludHMpIHsKICAgICAgICAgIGVuZHMgPSBhZGRQb3NpdGlvbigKICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgIGxlZnQsCiAgICAgICAgICAgIHNoYXBlRm9yRW5kcywKICAgICAgICAgICAgZW5kcywKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBoMSArIGhlaWdodE9mZnNldCwKICAgICAgICAgICAgMSwKICAgICAgICAgICAgMQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgbGVuZ3RoID0gZmluYWxQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IHBvc0xlbmd0aCA9IGR1cGxpY2F0ZVBvaW50cyA/IGxlbmd0aCArIGVuZHMubGVuZ3RoIDogbGVuZ3RoOwogICAgICAgIGNvbnN0IGNvbWJpbmVkUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShwb3NMZW5ndGgpOwogICAgICAgIGNvbWJpbmVkUG9zaXRpb25zLnNldChmaW5hbFBvc2l0aW9ucyk7CiAgICAgICAgaWYgKGR1cGxpY2F0ZVBvaW50cykgewogICAgICAgICAgY29tYmluZWRQb3NpdGlvbnMuc2V0KGVuZHMsIGxlbmd0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb21iaW5lZFBvc2l0aW9uczsKICAgICAgfTsKICAgICAgUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdCA9IFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnkuanMKICBmdW5jdGlvbiBjb21wdXRlUm91bmRDb3JuZXIyKGNvcm5lclBvaW50LCBzdGFydFBvaW50LCBlbmRQb2ludCwgY29ybmVyVHlwZSwgbGVmdElzT3V0c2lkZSkgewogICAgY29uc3QgYW5nbGUgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYW5nbGVCZXR3ZWVuKAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qoc3RhcnRQb2ludCwgY29ybmVyUG9pbnQsIHNjcmF0Y2gxMiksCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChlbmRQb2ludCwgY29ybmVyUG9pbnQsIHNjcmF0Y2gyMikKICAgICk7CiAgICBjb25zdCBncmFudWxhcml0eSA9IGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5CRVZFTEVEID8gMSA6IE1hdGguY2VpbChhbmdsZSAvIE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoNSkpICsgMTsKICAgIGNvbnN0IHNpemUgPSBncmFudWxhcml0eSAqIDM7CiAgICBjb25zdCBhcnJheSA9IG5ldyBBcnJheShzaXplKTsKICAgIGFycmF5W3NpemUgLSAzXSA9IGVuZFBvaW50Lng7CiAgICBhcnJheVtzaXplIC0gMl0gPSBlbmRQb2ludC55OwogICAgYXJyYXlbc2l6ZSAtIDFdID0gZW5kUG9pbnQuejsKICAgIGxldCBtOwogICAgaWYgKGxlZnRJc091dHNpZGUpIHsKICAgICAgbSA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbigKICAgICAgICBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoY29ybmVyUG9pbnQsIHNjcmF0Y2gxMiksCiAgICAgICAgICBhbmdsZSAvIGdyYW51bGFyaXR5LAogICAgICAgICAgcXVhdGVyaW9uMgogICAgICAgICksCiAgICAgICAgcm90TWF0cml4MgogICAgICApOwogICAgfSBlbHNlIHsKICAgICAgbSA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbigKICAgICAgICBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZShjb3JuZXJQb2ludCwgYW5nbGUgLyBncmFudWxhcml0eSwgcXVhdGVyaW9uMiksCiAgICAgICAgcm90TWF0cml4MgogICAgICApOwogICAgfQogICAgbGV0IGluZGV4ID0gMDsKICAgIHN0YXJ0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoc3RhcnRQb2ludCwgc2NyYXRjaDEyKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ3JhbnVsYXJpdHk7IGkrKykgewogICAgICBzdGFydFBvaW50ID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IobSwgc3RhcnRQb2ludCwgc3RhcnRQb2ludCk7CiAgICAgIGFycmF5W2luZGV4KytdID0gc3RhcnRQb2ludC54OwogICAgICBhcnJheVtpbmRleCsrXSA9IHN0YXJ0UG9pbnQueTsKICAgICAgYXJyYXlbaW5kZXgrK10gPSBzdGFydFBvaW50Lno7CiAgICB9CiAgICByZXR1cm4gYXJyYXk7CiAgfQogIGZ1bmN0aW9uIGFkZEVuZENhcHMoY2FsY3VsYXRlZFBvc2l0aW9ucykgewogICAgbGV0IGNvcm5lclBvaW50ID0gY2FydGVzaWFuMTsKICAgIGxldCBzdGFydFBvaW50ID0gY2FydGVzaWFuMjsKICAgIGxldCBlbmRQb2ludCA9IGNhcnRlc2lhbjM7CiAgICBsZXQgbGVmdEVkZ2UgPSBjYWxjdWxhdGVkUG9zaXRpb25zWzFdOwogICAgc3RhcnRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgIGNhbGN1bGF0ZWRQb3NpdGlvbnNbMV0sCiAgICAgIGxlZnRFZGdlLmxlbmd0aCAtIDMsCiAgICAgIHN0YXJ0UG9pbnQKICAgICk7CiAgICBlbmRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoY2FsY3VsYXRlZFBvc2l0aW9uc1swXSwgMCwgZW5kUG9pbnQpOwogICAgY29ybmVyUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQoc3RhcnRQb2ludCwgZW5kUG9pbnQsIGNvcm5lclBvaW50KTsKICAgIGNvbnN0IGZpcnN0RW5kQ2FwID0gY29tcHV0ZVJvdW5kQ29ybmVyMigKICAgICAgY29ybmVyUG9pbnQsCiAgICAgIHN0YXJ0UG9pbnQsCiAgICAgIGVuZFBvaW50LAogICAgICBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCwKICAgICAgZmFsc2UKICAgICk7CiAgICBjb25zdCBsZW5ndGggPSBjYWxjdWxhdGVkUG9zaXRpb25zLmxlbmd0aCAtIDE7CiAgICBjb25zdCByaWdodEVkZ2UgPSBjYWxjdWxhdGVkUG9zaXRpb25zW2xlbmd0aCAtIDFdOwogICAgbGVmdEVkZ2UgPSBjYWxjdWxhdGVkUG9zaXRpb25zW2xlbmd0aF07CiAgICBzdGFydFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgcmlnaHRFZGdlLAogICAgICByaWdodEVkZ2UubGVuZ3RoIC0gMywKICAgICAgc3RhcnRQb2ludAogICAgKTsKICAgIGVuZFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShsZWZ0RWRnZSwgMCwgZW5kUG9pbnQpOwogICAgY29ybmVyUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWlkcG9pbnQoc3RhcnRQb2ludCwgZW5kUG9pbnQsIGNvcm5lclBvaW50KTsKICAgIGNvbnN0IGxhc3RFbmRDYXAgPSBjb21wdXRlUm91bmRDb3JuZXIyKAogICAgICBjb3JuZXJQb2ludCwKICAgICAgc3RhcnRQb2ludCwKICAgICAgZW5kUG9pbnQsCiAgICAgIENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVELAogICAgICBmYWxzZQogICAgKTsKICAgIHJldHVybiBbZmlyc3RFbmRDYXAsIGxhc3RFbmRDYXBdOwogIH0KICBmdW5jdGlvbiBjb21wdXRlTWl0ZXJlZENvcm5lcihwb3NpdGlvbiwgbGVmdENvcm5lckRpcmVjdGlvbiwgbGFzdFBvaW50LCBsZWZ0SXNPdXRzaWRlKSB7CiAgICBsZXQgY29ybmVyUG9pbnQgPSBzY3JhdGNoMTI7CiAgICBpZiAobGVmdElzT3V0c2lkZSkgewogICAgICBjb3JuZXJQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIGxlZnRDb3JuZXJEaXJlY3Rpb24sIGNvcm5lclBvaW50KTsKICAgIH0gZWxzZSB7CiAgICAgIGxlZnRDb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKAogICAgICAgIGxlZnRDb3JuZXJEaXJlY3Rpb24sCiAgICAgICAgbGVmdENvcm5lckRpcmVjdGlvbgogICAgICApOwogICAgICBjb3JuZXJQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIGxlZnRDb3JuZXJEaXJlY3Rpb24sIGNvcm5lclBvaW50KTsKICAgIH0KICAgIHJldHVybiBbCiAgICAgIGNvcm5lclBvaW50LngsCiAgICAgIGNvcm5lclBvaW50LnksCiAgICAgIGNvcm5lclBvaW50LnosCiAgICAgIGxhc3RQb2ludC54LAogICAgICBsYXN0UG9pbnQueSwKICAgICAgbGFzdFBvaW50LnoKICAgIF07CiAgfQogIGZ1bmN0aW9uIGFkZFNoaWZ0ZWRQb3NpdGlvbnMocG9zaXRpb25zLCBsZWZ0LCBzY2FsYXIsIGNhbGN1bGF0ZWRQb3NpdGlvbnMpIHsKICAgIGNvbnN0IHJpZ2h0UG9zaXRpb25zID0gbmV3IEFycmF5KHBvc2l0aW9ucy5sZW5ndGgpOwogICAgY29uc3QgbGVmdFBvc2l0aW9ucyA9IG5ldyBBcnJheShwb3NpdGlvbnMubGVuZ3RoKTsKICAgIGNvbnN0IHNjYWxlZExlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCBzY2FsYXIsIHNjcmF0Y2gxMik7CiAgICBjb25zdCBzY2FsZWRSaWdodCA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoc2NhbGVkTGVmdCwgc2NyYXRjaDIyKTsKICAgIGxldCByaWdodEluZGV4ID0gMDsKICAgIGxldCBsZWZ0SW5kZXggPSBwb3NpdGlvbnMubGVuZ3RoIC0gMTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zLmxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGNvbnN0IHBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpLCBzY3JhdGNoMyk7CiAgICAgIGNvbnN0IHJpZ2h0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3MsIHNjYWxlZFJpZ2h0LCBzY3JhdGNoNCk7CiAgICAgIHJpZ2h0UG9zaXRpb25zW3JpZ2h0SW5kZXgrK10gPSByaWdodFBvcy54OwogICAgICByaWdodFBvc2l0aW9uc1tyaWdodEluZGV4KytdID0gcmlnaHRQb3MueTsKICAgICAgcmlnaHRQb3NpdGlvbnNbcmlnaHRJbmRleCsrXSA9IHJpZ2h0UG9zLno7CiAgICAgIGNvbnN0IGxlZnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvcywgc2NhbGVkTGVmdCwgc2NyYXRjaDQpOwogICAgICBsZWZ0UG9zaXRpb25zW2xlZnRJbmRleC0tXSA9IGxlZnRQb3MuejsKICAgICAgbGVmdFBvc2l0aW9uc1tsZWZ0SW5kZXgtLV0gPSBsZWZ0UG9zLnk7CiAgICAgIGxlZnRQb3NpdGlvbnNbbGVmdEluZGV4LS1dID0gbGVmdFBvcy54OwogICAgfQogICAgY2FsY3VsYXRlZFBvc2l0aW9ucy5wdXNoKHJpZ2h0UG9zaXRpb25zLCBsZWZ0UG9zaXRpb25zKTsKICAgIHJldHVybiBjYWxjdWxhdGVkUG9zaXRpb25zOwogIH0KICB2YXIgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnksIHNjcmF0Y2gxMiwgc2NyYXRjaDIyLCBzY3JhdGNoMywgc2NyYXRjaDQsIHNjYWxlQXJyYXkyLCBjYXJ0ZXNpYW4xLCBjYXJ0ZXNpYW4yLCBjYXJ0ZXNpYW4zLCBjYXJ0ZXNpYW40LCBjYXJ0ZXNpYW41LCBjYXJ0ZXNpYW42LCBjYXJ0ZXNpYW43LCBjYXJ0ZXNpYW44LCBjYXJ0ZXNpYW45LCBjYXJ0ZXNpYW4xMCwgcXVhdGVyaW9uMiwgcm90TWF0cml4Miwgc2NyYXRjaEZvcndhcmRQcm9qZWN0aW9uMiwgc2NyYXRjaEJhY2t3YXJkUHJvamVjdGlvbjIsIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29ybmVyVHlwZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X1BvbHlsaW5lUGlwZWxpbmUoKTsKICAgICAgaW5pdF9Qb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnkgPSB7fTsKICAgICAgc2NyYXRjaDEyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoMjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2gzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NhbGVBcnJheTIgPSBbbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCldOwogICAgICBjYXJ0ZXNpYW4xID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4yID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4zID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW40ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW41ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW42ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW43ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW44ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW45ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4xMCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcXVhdGVyaW9uMiA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgcm90TWF0cml4MiA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnkuYWRkQXR0cmlidXRlID0gZnVuY3Rpb24oYXR0cmlidXRlLCB2YWx1ZSwgZnJvbnQsIGJhY2spIHsKICAgICAgICBjb25zdCB4ID0gdmFsdWUueDsKICAgICAgICBjb25zdCB5ID0gdmFsdWUueTsKICAgICAgICBjb25zdCB6ID0gdmFsdWUuejsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGZyb250KSkgewogICAgICAgICAgYXR0cmlidXRlW2Zyb250XSA9IHg7CiAgICAgICAgICBhdHRyaWJ1dGVbZnJvbnQgKyAxXSA9IHk7CiAgICAgICAgICBhdHRyaWJ1dGVbZnJvbnQgKyAyXSA9IHo7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYmFjaykpIHsKICAgICAgICAgIGF0dHJpYnV0ZVtiYWNrXSA9IHo7CiAgICAgICAgICBhdHRyaWJ1dGVbYmFjayAtIDFdID0geTsKICAgICAgICAgIGF0dHJpYnV0ZVtiYWNrIC0gMl0gPSB4OwogICAgICAgIH0KICAgICAgfTsKICAgICAgc2NyYXRjaEZvcndhcmRQcm9qZWN0aW9uMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEJhY2t3YXJkUHJvamVjdGlvbjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVQb3NpdGlvbnMgPSBmdW5jdGlvbihwYXJhbXMpIHsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IHBhcmFtcy5ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBwYXJhbXMucG9zaXRpb25zOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHBhcmFtcy5lbGxpcHNvaWQ7CiAgICAgICAgY29uc3Qgd2lkdGggPSBwYXJhbXMud2lkdGggLyAyOwogICAgICAgIGNvbnN0IGNvcm5lclR5cGUgPSBwYXJhbXMuY29ybmVyVHlwZTsKICAgICAgICBjb25zdCBzYXZlQXR0cmlidXRlcyA9IHBhcmFtcy5zYXZlQXR0cmlidXRlczsKICAgICAgICBsZXQgbm9ybWFsMiA9IGNhcnRlc2lhbjE7CiAgICAgICAgbGV0IGZvcndhcmQgPSBjYXJ0ZXNpYW4yOwogICAgICAgIGxldCBiYWNrd2FyZCA9IGNhcnRlc2lhbjM7CiAgICAgICAgbGV0IGxlZnQgPSBjYXJ0ZXNpYW40OwogICAgICAgIGxldCBjb3JuZXJEaXJlY3Rpb24gPSBjYXJ0ZXNpYW41OwogICAgICAgIGxldCBzdGFydFBvaW50ID0gY2FydGVzaWFuNjsKICAgICAgICBsZXQgcHJldmlvdXNQb3MgPSBjYXJ0ZXNpYW43OwogICAgICAgIGxldCByaWdodFBvcyA9IGNhcnRlc2lhbjg7CiAgICAgICAgbGV0IGxlZnRQb3MgPSBjYXJ0ZXNpYW45OwogICAgICAgIGxldCBjZW50ZXIgPSBjYXJ0ZXNpYW4xMDsKICAgICAgICBsZXQgY2FsY3VsYXRlZFBvc2l0aW9ucyA9IFtdOwogICAgICAgIGNvbnN0IGNhbGN1bGF0ZWRMZWZ0cyA9IHNhdmVBdHRyaWJ1dGVzID8gW10gOiB2b2lkIDA7CiAgICAgICAgY29uc3QgY2FsY3VsYXRlZE5vcm1hbHMgPSBzYXZlQXR0cmlidXRlcyA/IFtdIDogdm9pZCAwOwogICAgICAgIGxldCBwb3NpdGlvbiA9IHBvc2l0aW9uc1swXTsKICAgICAgICBsZXQgbmV4dFBvc2l0aW9uID0gcG9zaXRpb25zWzFdOwogICAgICAgIGZvcndhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5leHRQb3NpdGlvbiwgcG9zaXRpb24sIGZvcndhcmQpLAogICAgICAgICAgZm9yd2FyZAogICAgICAgICk7CiAgICAgICAgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIG5vcm1hbDIpOwogICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCBmb3J3YXJkLCBsZWZ0KSwgbGVmdCk7CiAgICAgICAgaWYgKHNhdmVBdHRyaWJ1dGVzKSB7CiAgICAgICAgICBjYWxjdWxhdGVkTGVmdHMucHVzaChsZWZ0LngsIGxlZnQueSwgbGVmdC56KTsKICAgICAgICAgIGNhbGN1bGF0ZWROb3JtYWxzLnB1c2gobm9ybWFsMi54LCBub3JtYWwyLnksIG5vcm1hbDIueik7CiAgICAgICAgfQogICAgICAgIHByZXZpb3VzUG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCBwcmV2aW91c1Bvcyk7CiAgICAgICAgcG9zaXRpb24gPSBuZXh0UG9zaXRpb247CiAgICAgICAgYmFja3dhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGZvcndhcmQsIGJhY2t3YXJkKTsKICAgICAgICBsZXQgc3ViZGl2aWRlZFBvc2l0aW9uczsKICAgICAgICBjb25zdCBjb3JuZXJzID0gW107CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgICBuZXh0UG9zaXRpb24gPSBwb3NpdGlvbnNbaSArIDFdOwogICAgICAgICAgZm9yd2FyZCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChuZXh0UG9zaXRpb24sIHBvc2l0aW9uLCBmb3J3YXJkKSwKICAgICAgICAgICAgZm9yd2FyZAogICAgICAgICAgKTsKICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoZm9yd2FyZCwgYmFja3dhcmQsIGNvcm5lckRpcmVjdGlvbiksCiAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbgogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IGZvcndhcmRQcm9qZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgICAgIG5vcm1hbDIsCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZm9yd2FyZCwgbm9ybWFsMiksCiAgICAgICAgICAgIHNjcmF0Y2hGb3J3YXJkUHJvamVjdGlvbjIKICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoZm9yd2FyZCwgZm9yd2FyZFByb2plY3Rpb24sIGZvcndhcmRQcm9qZWN0aW9uKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZm9yd2FyZFByb2plY3Rpb24sIGZvcndhcmRQcm9qZWN0aW9uKTsKICAgICAgICAgIGNvbnN0IGJhY2t3YXJkUHJvamVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGJhY2t3YXJkLCBub3JtYWwyKSwKICAgICAgICAgICAgc2NyYXRjaEJhY2t3YXJkUHJvamVjdGlvbjIKICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoYmFja3dhcmQsIGJhY2t3YXJkUHJvamVjdGlvbiwgYmFja3dhcmRQcm9qZWN0aW9uKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoYmFja3dhcmRQcm9qZWN0aW9uLCBiYWNrd2FyZFByb2plY3Rpb24pOwogICAgICAgICAgY29uc3QgZG9Db3JuZXIgPSAhTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICAgIE1hdGguYWJzKENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZm9yd2FyZFByb2plY3Rpb24sIGJhY2t3YXJkUHJvamVjdGlvbikpLAogICAgICAgICAgICAxLAogICAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjcKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZG9Db3JuZXIpIHsKICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKAogICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiwKICAgICAgICAgICAgICBub3JtYWwyLAogICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbgogICAgICAgICAgICApOwogICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24sCiAgICAgICAgICAgICAgY29ybmVyRGlyZWN0aW9uCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoY29ybmVyRGlyZWN0aW9uLCBjb3JuZXJEaXJlY3Rpb24pOwogICAgICAgICAgICBjb25zdCBzY2FsYXIgPSB3aWR0aCAvIE1hdGgubWF4KAogICAgICAgICAgICAgIDAuMjUsCiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhjb3JuZXJEaXJlY3Rpb24sIGJhY2t3YXJkLCBzY3JhdGNoMTIpCiAgICAgICAgICAgICAgKQogICAgICAgICAgICApOwogICAgICAgICAgICBjb25zdCBsZWZ0SXNPdXRzaWRlID0gUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hbmdsZUlzR3JlYXRlclRoYW5QaSgKICAgICAgICAgICAgICBmb3J3YXJkLAogICAgICAgICAgICAgIGJhY2t3YXJkLAogICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICAgICApOwogICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24sCiAgICAgICAgICAgICAgc2NhbGFyLAogICAgICAgICAgICAgIGNvcm5lckRpcmVjdGlvbgogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAobGVmdElzT3V0c2lkZSkgewogICAgICAgICAgICAgIHJpZ2h0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgY29ybmVyRGlyZWN0aW9uLCByaWdodFBvcyk7CiAgICAgICAgICAgICAgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIHJpZ2h0UG9zLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgd2lkdGgsIGNlbnRlciksCiAgICAgICAgICAgICAgICBjZW50ZXIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGxlZnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgICAgICAgcmlnaHRQb3MsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCB3aWR0aCAqIDIsIGxlZnRQb3MpLAogICAgICAgICAgICAgICAgbGVmdFBvcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgc2NhbGVBcnJheTJbMF0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocHJldmlvdXNQb3MsIHNjYWxlQXJyYXkyWzBdKTsKICAgICAgICAgICAgICBzY2FsZUFycmF5MlsxXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShjZW50ZXIsIHNjYWxlQXJyYXkyWzFdKTsKICAgICAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uczogc2NhbGVBcnJheTIsCiAgICAgICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGNhbGN1bGF0ZWRQb3NpdGlvbnMgPSBhZGRTaGlmdGVkUG9zaXRpb25zKAogICAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucywKICAgICAgICAgICAgICAgIGxlZnQsCiAgICAgICAgICAgICAgICB3aWR0aCwKICAgICAgICAgICAgICAgIGNhbGN1bGF0ZWRQb3NpdGlvbnMKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChzYXZlQXR0cmlidXRlcykgewogICAgICAgICAgICAgICAgY2FsY3VsYXRlZExlZnRzLnB1c2gobGVmdC54LCBsZWZ0LnksIGxlZnQueik7CiAgICAgICAgICAgICAgICBjYWxjdWxhdGVkTm9ybWFscy5wdXNoKG5vcm1hbDIueCwgbm9ybWFsMi55LCBub3JtYWwyLnopOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzdGFydFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGxlZnRQb3MsIHN0YXJ0UG9pbnQpOwogICAgICAgICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIGZvcndhcmQsIGxlZnQpLAogICAgICAgICAgICAgICAgbGVmdAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgbGVmdFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICByaWdodFBvcywKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHdpZHRoICogMiwgbGVmdFBvcyksCiAgICAgICAgICAgICAgICBsZWZ0UG9zCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBwcmV2aW91c1BvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICByaWdodFBvcywKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGxlZnQsIHdpZHRoLCBwcmV2aW91c1BvcyksCiAgICAgICAgICAgICAgICBwcmV2aW91c1BvcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEIHx8IGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5CRVZFTEVEKSB7CiAgICAgICAgICAgICAgICBjb3JuZXJzLnB1c2goewogICAgICAgICAgICAgICAgICBsZWZ0UG9zaXRpb25zOiBjb21wdXRlUm91bmRDb3JuZXIyKAogICAgICAgICAgICAgICAgICAgIHJpZ2h0UG9zLAogICAgICAgICAgICAgICAgICAgIHN0YXJ0UG9pbnQsCiAgICAgICAgICAgICAgICAgICAgbGVmdFBvcywKICAgICAgICAgICAgICAgICAgICBjb3JuZXJUeXBlLAogICAgICAgICAgICAgICAgICAgIGxlZnRJc091dHNpZGUKICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvcm5lcnMucHVzaCh7CiAgICAgICAgICAgICAgICAgIGxlZnRQb3NpdGlvbnM6IGNvbXB1dGVNaXRlcmVkQ29ybmVyKAogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoY29ybmVyRGlyZWN0aW9uLCBjb3JuZXJEaXJlY3Rpb24pLAogICAgICAgICAgICAgICAgICAgIGxlZnRQb3MsCiAgICAgICAgICAgICAgICAgICAgbGVmdElzT3V0c2lkZQogICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbGVmdFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIGNvcm5lckRpcmVjdGlvbiwgbGVmdFBvcyk7CiAgICAgICAgICAgICAgY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIGxlZnRQb3MsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKAogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCB3aWR0aCwgY2VudGVyKSwKICAgICAgICAgICAgICAgICAgY2VudGVyCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgY2VudGVyCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICByaWdodFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgd2lkdGggKiAyLCByaWdodFBvcyksCiAgICAgICAgICAgICAgICAgIHJpZ2h0UG9zCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgcmlnaHRQb3MKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHNjYWxlQXJyYXkyWzBdID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHByZXZpb3VzUG9zLCBzY2FsZUFycmF5MlswXSk7CiAgICAgICAgICAgICAgc2NhbGVBcnJheTJbMV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2VudGVyLCBzY2FsZUFycmF5MlsxXSk7CiAgICAgICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYyh7CiAgICAgICAgICAgICAgICBwb3NpdGlvbnM6IHNjYWxlQXJyYXkyLAogICAgICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBjYWxjdWxhdGVkUG9zaXRpb25zID0gYWRkU2hpZnRlZFBvc2l0aW9ucygKICAgICAgICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICBsZWZ0LAogICAgICAgICAgICAgICAgd2lkdGgsCiAgICAgICAgICAgICAgICBjYWxjdWxhdGVkUG9zaXRpb25zCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoc2F2ZUF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgICAgIGNhbGN1bGF0ZWRMZWZ0cy5wdXNoKGxlZnQueCwgbGVmdC55LCBsZWZ0LnopOwogICAgICAgICAgICAgICAgY2FsY3VsYXRlZE5vcm1hbHMucHVzaChub3JtYWwyLngsIG5vcm1hbDIueSwgbm9ybWFsMi56KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3RhcnRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShyaWdodFBvcywgc3RhcnRQb2ludCk7CiAgICAgICAgICAgICAgbGVmdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Mobm9ybWFsMiwgZm9yd2FyZCwgbGVmdCksCiAgICAgICAgICAgICAgICBsZWZ0CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICByaWdodFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICAgICAgICBsZWZ0UG9zLAogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIobGVmdCwgd2lkdGggKiAyLCByaWdodFBvcyksCiAgICAgICAgICAgICAgICAgIHJpZ2h0UG9zCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgcmlnaHRQb3MKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHByZXZpb3VzUG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZCgKICAgICAgICAgICAgICAgIGxlZnRQb3MsCiAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKAogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihsZWZ0LCB3aWR0aCwgcHJldmlvdXNQb3MpLAogICAgICAgICAgICAgICAgICBwcmV2aW91c1BvcwogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIHByZXZpb3VzUG9zCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQgfHwgY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LkJFVkVMRUQpIHsKICAgICAgICAgICAgICAgIGNvcm5lcnMucHVzaCh7CiAgICAgICAgICAgICAgICAgIHJpZ2h0UG9zaXRpb25zOiBjb21wdXRlUm91bmRDb3JuZXIyKAogICAgICAgICAgICAgICAgICAgIGxlZnRQb3MsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRQb2ludCwKICAgICAgICAgICAgICAgICAgICByaWdodFBvcywKICAgICAgICAgICAgICAgICAgICBjb3JuZXJUeXBlLAogICAgICAgICAgICAgICAgICAgIGxlZnRJc091dHNpZGUKICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvcm5lcnMucHVzaCh7CiAgICAgICAgICAgICAgICAgIHJpZ2h0UG9zaXRpb25zOiBjb21wdXRlTWl0ZXJlZENvcm5lcigKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgICAgICBjb3JuZXJEaXJlY3Rpb24sCiAgICAgICAgICAgICAgICAgICAgcmlnaHRQb3MsCiAgICAgICAgICAgICAgICAgICAgbGVmdElzT3V0c2lkZQogICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYmFja3dhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKGZvcndhcmQsIGJhY2t3YXJkKTsKICAgICAgICAgIH0KICAgICAgICAgIHBvc2l0aW9uID0gbmV4dFBvc2l0aW9uOwogICAgICAgIH0KICAgICAgICBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgc2NhbGVBcnJheTJbMF0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocHJldmlvdXNQb3MsIHNjYWxlQXJyYXkyWzBdKTsKICAgICAgICBzY2FsZUFycmF5MlsxXSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbiwgc2NhbGVBcnJheTJbMV0pOwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVBcmMoewogICAgICAgICAgcG9zaXRpb25zOiBzY2FsZUFycmF5MiwKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgfSk7CiAgICAgICAgY2FsY3VsYXRlZFBvc2l0aW9ucyA9IGFkZFNoaWZ0ZWRQb3NpdGlvbnMoCiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgICAgbGVmdCwKICAgICAgICAgIHdpZHRoLAogICAgICAgICAgY2FsY3VsYXRlZFBvc2l0aW9ucwogICAgICAgICk7CiAgICAgICAgaWYgKHNhdmVBdHRyaWJ1dGVzKSB7CiAgICAgICAgICBjYWxjdWxhdGVkTGVmdHMucHVzaChsZWZ0LngsIGxlZnQueSwgbGVmdC56KTsKICAgICAgICAgIGNhbGN1bGF0ZWROb3JtYWxzLnB1c2gobm9ybWFsMi54LCBub3JtYWwyLnksIG5vcm1hbDIueik7CiAgICAgICAgfQogICAgICAgIGxldCBlbmRQb3NpdGlvbnM7CiAgICAgICAgaWYgKGNvcm5lclR5cGUgPT09IENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEKSB7CiAgICAgICAgICBlbmRQb3NpdGlvbnMgPSBhZGRFbmRDYXBzKGNhbGN1bGF0ZWRQb3NpdGlvbnMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgcG9zaXRpb25zOiBjYWxjdWxhdGVkUG9zaXRpb25zLAogICAgICAgICAgY29ybmVycywKICAgICAgICAgIGxlZnRzOiBjYWxjdWxhdGVkTGVmdHMsCiAgICAgICAgICBub3JtYWxzOiBjYWxjdWxhdGVkTm9ybWFscywKICAgICAgICAgIGVuZFBvc2l0aW9ucwogICAgICAgIH07CiAgICAgIH07CiAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQgPSBDb3JyaWRvckdlb21ldHJ5TGlicmFyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvcnJpZG9yR2VvbWV0cnkuanMKICBmdW5jdGlvbiBzY2FsZVRvU3VyZmFjZTIocG9zaXRpb25zLCBlbGxpcHNvaWQpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgIHBvc2l0aW9uc1tpXSA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKHBvc2l0aW9uc1tpXSwgcG9zaXRpb25zW2ldKTsKICAgIH0KICAgIHJldHVybiBwb3NpdGlvbnM7CiAgfQogIGZ1bmN0aW9uIGFkZE5vcm1hbHMoYXR0ciwgbm9ybWFsMiwgbGVmdCwgZnJvbnQsIGJhY2ssIHZlcnRleEZvcm1hdCkgewogICAgY29uc3Qgbm9ybWFscyA9IGF0dHIubm9ybWFsczsKICAgIGNvbnN0IHRhbmdlbnRzID0gYXR0ci50YW5nZW50czsKICAgIGNvbnN0IGJpdGFuZ2VudHMgPSBhdHRyLmJpdGFuZ2VudHM7CiAgICBjb25zdCBmb3J3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGxlZnQsIG5vcm1hbDIsIHNjcmF0Y2gxMyksCiAgICAgIHNjcmF0Y2gxMwogICAgKTsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKG5vcm1hbHMsIG5vcm1hbDIsIGZyb250LCBiYWNrKTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSh0YW5nZW50cywgZm9yd2FyZCwgZnJvbnQsIGJhY2spOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoYml0YW5nZW50cywgbGVmdCwgZnJvbnQsIGJhY2spOwogICAgfQogIH0KICBmdW5jdGlvbiBjb21iaW5lMihjb21wdXRlZFBvc2l0aW9ucywgdmVydGV4Rm9ybWF0LCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IGNvbXB1dGVkUG9zaXRpb25zLnBvc2l0aW9uczsKICAgIGNvbnN0IGNvcm5lcnMgPSBjb21wdXRlZFBvc2l0aW9ucy5jb3JuZXJzOwogICAgY29uc3QgZW5kUG9zaXRpb25zID0gY29tcHV0ZWRQb3NpdGlvbnMuZW5kUG9zaXRpb25zOwogICAgY29uc3QgY29tcHV0ZWRMZWZ0cyA9IGNvbXB1dGVkUG9zaXRpb25zLmxlZnRzOwogICAgY29uc3QgY29tcHV0ZWROb3JtYWxzID0gY29tcHV0ZWRQb3NpdGlvbnMubm9ybWFsczsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgIGxldCBjb3JuZXI7CiAgICBsZXQgbGVmdENvdW50ID0gMDsKICAgIGxldCByaWdodENvdW50ID0gMDsKICAgIGxldCBpOwogICAgbGV0IGluZGljZXNMZW5ndGggPSAwOwogICAgbGV0IGxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBwb3NpdGlvbnMubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgbGVuZ3RoID0gcG9zaXRpb25zW2ldLmxlbmd0aCAtIDM7CiAgICAgIGxlZnRDb3VudCArPSBsZW5ndGg7CiAgICAgIGluZGljZXNMZW5ndGggKz0gbGVuZ3RoICogMjsKICAgICAgcmlnaHRDb3VudCArPSBwb3NpdGlvbnNbaSArIDFdLmxlbmd0aCAtIDM7CiAgICB9CiAgICBsZWZ0Q291bnQgKz0gMzsKICAgIHJpZ2h0Q291bnQgKz0gMzsKICAgIGZvciAoaSA9IDA7IGkgPCBjb3JuZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvcm5lciA9IGNvcm5lcnNbaV07CiAgICAgIGNvbnN0IGxlZnRTaWRlID0gY29ybmVyc1tpXS5sZWZ0UG9zaXRpb25zOwogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGxlZnRTaWRlKSkgewogICAgICAgIGxlbmd0aCA9IGxlZnRTaWRlLmxlbmd0aDsKICAgICAgICBsZWZ0Q291bnQgKz0gbGVuZ3RoOwogICAgICAgIGluZGljZXNMZW5ndGggKz0gbGVuZ3RoOwogICAgICB9IGVsc2UgewogICAgICAgIGxlbmd0aCA9IGNvcm5lcnNbaV0ucmlnaHRQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIHJpZ2h0Q291bnQgKz0gbGVuZ3RoOwogICAgICAgIGluZGljZXNMZW5ndGggKz0gbGVuZ3RoOwogICAgICB9CiAgICB9CiAgICBjb25zdCBhZGRFbmRQb3NpdGlvbnMgPSBkZWZpbmVkX2RlZmF1bHQoZW5kUG9zaXRpb25zKTsKICAgIGxldCBlbmRQb3NpdGlvbkxlbmd0aDsKICAgIGlmIChhZGRFbmRQb3NpdGlvbnMpIHsKICAgICAgZW5kUG9zaXRpb25MZW5ndGggPSBlbmRQb3NpdGlvbnNbMF0ubGVuZ3RoIC0gMzsKICAgICAgbGVmdENvdW50ICs9IGVuZFBvc2l0aW9uTGVuZ3RoOwogICAgICByaWdodENvdW50ICs9IGVuZFBvc2l0aW9uTGVuZ3RoOwogICAgICBlbmRQb3NpdGlvbkxlbmd0aCAvPSAzOwogICAgICBpbmRpY2VzTGVuZ3RoICs9IGVuZFBvc2l0aW9uTGVuZ3RoICogNjsKICAgIH0KICAgIGNvbnN0IHNpemUgPSBsZWZ0Q291bnQgKyByaWdodENvdW50OwogICAgY29uc3QgZmluYWxQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHNpemUpOwogICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUpIDogdm9pZCAwOwogICAgY29uc3QgdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSkgOiB2b2lkIDA7CiAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSkgOiB2b2lkIDA7CiAgICBjb25zdCBhdHRyID0gewogICAgICBub3JtYWxzLAogICAgICB0YW5nZW50cywKICAgICAgYml0YW5nZW50cwogICAgfTsKICAgIGxldCBmcm9udCA9IDA7CiAgICBsZXQgYmFjayA9IHNpemUgLSAxOwogICAgbGV0IFVMLCBMTCwgVVIsIExSOwogICAgbGV0IG5vcm1hbDIgPSBjYXJ0ZXNpYW4xMjsKICAgIGxldCBsZWZ0ID0gY2FydGVzaWFuMjI7CiAgICBsZXQgcmlnaHRQb3MsIGxlZnRQb3M7CiAgICBjb25zdCBoYWxmTGVuZ3RoID0gZW5kUG9zaXRpb25MZW5ndGggLyAyOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KHNpemUgLyAzLCBpbmRpY2VzTGVuZ3RoKTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBpZiAoYWRkRW5kUG9zaXRpb25zKSB7CiAgICAgIGxlZnRQb3MgPSBjYXJ0ZXNpYW4zMjsKICAgICAgcmlnaHRQb3MgPSBjYXJ0ZXNpYW40MjsKICAgICAgY29uc3QgZmlyc3RFbmRQb3NpdGlvbnMgPSBlbmRQb3NpdGlvbnNbMF07CiAgICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGNvbXB1dGVkTm9ybWFscywgMCwgbm9ybWFsMik7CiAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGNvbXB1dGVkTGVmdHMsIDAsIGxlZnQpOwogICAgICBmb3IgKGkgPSAwOyBpIDwgaGFsZkxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGVmdFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBmaXJzdEVuZFBvc2l0aW9ucywKICAgICAgICAgIChoYWxmTGVuZ3RoIC0gMSAtIGkpICogMywKICAgICAgICAgIGxlZnRQb3MKICAgICAgICApOwogICAgICAgIHJpZ2h0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIGZpcnN0RW5kUG9zaXRpb25zLAogICAgICAgICAgKGhhbGZMZW5ndGggKyBpKSAqIDMsCiAgICAgICAgICByaWdodFBvcwogICAgICAgICk7CiAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoZmluYWxQb3NpdGlvbnMsIHJpZ2h0UG9zLCBmcm9udCk7CiAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgIGxlZnRQb3MsCiAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICBiYWNrCiAgICAgICAgKTsKICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCBiYWNrLCB2ZXJ0ZXhGb3JtYXQpOwogICAgICAgIExMID0gZnJvbnQgLyAzOwogICAgICAgIExSID0gTEwgKyAxOwogICAgICAgIFVMID0gKGJhY2sgLSAyKSAvIDM7CiAgICAgICAgVVIgPSBVTCAtIDE7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTFI7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICBiYWNrIC09IDM7CiAgICAgIH0KICAgIH0KICAgIGxldCBwb3NJbmRleCA9IDA7CiAgICBsZXQgY29tcEluZGV4ID0gMDsKICAgIGxldCByaWdodEVkZ2UgPSBwb3NpdGlvbnNbcG9zSW5kZXgrK107CiAgICBsZXQgbGVmdEVkZ2UgPSBwb3NpdGlvbnNbcG9zSW5kZXgrK107CiAgICBmaW5hbFBvc2l0aW9ucy5zZXQocmlnaHRFZGdlLCBmcm9udCk7CiAgICBmaW5hbFBvc2l0aW9ucy5zZXQobGVmdEVkZ2UsIGJhY2sgLSBsZWZ0RWRnZS5sZW5ndGggKyAxKTsKICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGNvbXB1dGVkTGVmdHMsIGNvbXBJbmRleCwgbGVmdCk7CiAgICBsZXQgcmlnaHROb3JtYWw7CiAgICBsZXQgbGVmdE5vcm1hbDsKICAgIGxlbmd0aCA9IGxlZnRFZGdlLmxlbmd0aCAtIDM7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgcmlnaHROb3JtYWwgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKAogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocmlnaHRFZGdlLCBpLCBzY3JhdGNoMTMpLAogICAgICAgIHNjcmF0Y2gxMwogICAgICApOwogICAgICBsZWZ0Tm9ybWFsID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGxlZnRFZGdlLCBsZW5ndGggLSBpLCBzY3JhdGNoMjMpLAogICAgICAgIHNjcmF0Y2gyMwogICAgICApOwogICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJpZ2h0Tm9ybWFsLCBsZWZ0Tm9ybWFsLCBub3JtYWwyKSwKICAgICAgICBub3JtYWwyCiAgICAgICk7CiAgICAgIGFkZE5vcm1hbHMoYXR0ciwgbm9ybWFsMiwgbGVmdCwgZnJvbnQsIGJhY2ssIHZlcnRleEZvcm1hdCk7CiAgICAgIExMID0gZnJvbnQgLyAzOwogICAgICBMUiA9IExMICsgMTsKICAgICAgVUwgPSAoYmFjayAtIDIpIC8gMzsKICAgICAgVVIgPSBVTCAtIDE7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVTDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gTFI7CiAgICAgIGZyb250ICs9IDM7CiAgICAgIGJhY2sgLT0gMzsKICAgIH0KICAgIHJpZ2h0Tm9ybWFsID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShyaWdodEVkZ2UsIGxlbmd0aCwgc2NyYXRjaDEzKSwKICAgICAgc2NyYXRjaDEzCiAgICApOwogICAgbGVmdE5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobGVmdEVkZ2UsIGxlbmd0aCwgc2NyYXRjaDIzKSwKICAgICAgc2NyYXRjaDIzCiAgICApOwogICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocmlnaHROb3JtYWwsIGxlZnROb3JtYWwsIG5vcm1hbDIpLAogICAgICBub3JtYWwyCiAgICApOwogICAgY29tcEluZGV4ICs9IDM7CiAgICBmb3IgKGkgPSAwOyBpIDwgY29ybmVycy5sZW5ndGg7IGkrKykgewogICAgICBsZXQgajsKICAgICAgY29ybmVyID0gY29ybmVyc1tpXTsKICAgICAgY29uc3QgbCA9IGNvcm5lci5sZWZ0UG9zaXRpb25zOwogICAgICBjb25zdCByID0gY29ybmVyLnJpZ2h0UG9zaXRpb25zOwogICAgICBsZXQgcGl2b3Q7CiAgICAgIGxldCBzdGFydDsKICAgICAgbGV0IG91dHNpZGVQb2ludCA9IGNhcnRlc2lhbjYyOwogICAgICBsZXQgcHJldmlvdXNQb2ludCA9IGNhcnRlc2lhbjMyOwogICAgICBsZXQgbmV4dFBvaW50ID0gY2FydGVzaWFuNDI7CiAgICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGNvbXB1dGVkTm9ybWFscywgY29tcEluZGV4LCBub3JtYWwyKTsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChsKSkgewogICAgICAgIGFkZE5vcm1hbHMoYXR0ciwgbm9ybWFsMiwgbGVmdCwgdm9pZCAwLCBiYWNrLCB2ZXJ0ZXhGb3JtYXQpOwogICAgICAgIGJhY2sgLT0gMzsKICAgICAgICBwaXZvdCA9IExSOwogICAgICAgIHN0YXJ0ID0gVVI7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IGwubGVuZ3RoIC8gMzsgaisrKSB7CiAgICAgICAgICBvdXRzaWRlUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGwsIGogKiAzLCBvdXRzaWRlUG9pbnQpOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHBpdm90OwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHN0YXJ0IC0gaiAtIDE7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gc3RhcnQgLSBqOwogICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICBvdXRzaWRlUG9pbnQsCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgYmFjawogICAgICAgICAgKTsKICAgICAgICAgIHByZXZpb3VzUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgKHN0YXJ0IC0gaiAtIDEpICogMywKICAgICAgICAgICAgcHJldmlvdXNQb2ludAogICAgICAgICAgKTsKICAgICAgICAgIG5leHRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZmluYWxQb3NpdGlvbnMsIHBpdm90ICogMywgbmV4dFBvaW50KTsKICAgICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocHJldmlvdXNQb2ludCwgbmV4dFBvaW50LCBsZWZ0KSwKICAgICAgICAgICAgbGVmdAogICAgICAgICAgKTsKICAgICAgICAgIGFkZE5vcm1hbHMoYXR0ciwgbm9ybWFsMiwgbGVmdCwgdm9pZCAwLCBiYWNrLCB2ZXJ0ZXhGb3JtYXQpOwogICAgICAgICAgYmFjayAtPSAzOwogICAgICAgIH0KICAgICAgICBvdXRzaWRlUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICBwaXZvdCAqIDMsCiAgICAgICAgICBvdXRzaWRlUG9pbnQKICAgICAgICApOwogICAgICAgIHByZXZpb3VzUG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGZpbmFsUG9zaXRpb25zLCBzdGFydCAqIDMsIHByZXZpb3VzUG9pbnQpLAogICAgICAgICAgb3V0c2lkZVBvaW50LAogICAgICAgICAgcHJldmlvdXNQb2ludAogICAgICAgICk7CiAgICAgICAgbmV4dFBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShmaW5hbFBvc2l0aW9ucywgKHN0YXJ0IC0gaikgKiAzLCBuZXh0UG9pbnQpLAogICAgICAgICAgb3V0c2lkZVBvaW50LAogICAgICAgICAgbmV4dFBvaW50CiAgICAgICAgKTsKICAgICAgICBsZWZ0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocHJldmlvdXNQb2ludCwgbmV4dFBvaW50LCBsZWZ0KSwKICAgICAgICAgIGxlZnQKICAgICAgICApOwogICAgICAgIGFkZE5vcm1hbHMoYXR0ciwgbm9ybWFsMiwgbGVmdCwgZnJvbnQsIHZvaWQgMCwgdmVydGV4Rm9ybWF0KTsKICAgICAgICBmcm9udCArPSAzOwogICAgICB9IGVsc2UgewogICAgICAgIGFkZE5vcm1hbHMoYXR0ciwgbm9ybWFsMiwgbGVmdCwgZnJvbnQsIHZvaWQgMCwgdmVydGV4Rm9ybWF0KTsKICAgICAgICBmcm9udCArPSAzOwogICAgICAgIHBpdm90ID0gVVI7CiAgICAgICAgc3RhcnQgPSBMUjsKICAgICAgICBmb3IgKGogPSAwOyBqIDwgci5sZW5ndGggLyAzOyBqKyspIHsKICAgICAgICAgIG91dHNpZGVQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkociwgaiAqIDMsIG91dHNpZGVQb2ludCk7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gcGl2b3Q7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gc3RhcnQgKyBqOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHN0YXJ0ICsgaiArIDE7CiAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgIG91dHNpZGVQb2ludCwKICAgICAgICAgICAgZnJvbnQKICAgICAgICAgICk7CiAgICAgICAgICBwcmV2aW91c1BvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgIHBpdm90ICogMywKICAgICAgICAgICAgcHJldmlvdXNQb2ludAogICAgICAgICAgKTsKICAgICAgICAgIG5leHRQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgICAoc3RhcnQgKyBqKSAqIDMsCiAgICAgICAgICAgIG5leHRQb2ludAogICAgICAgICAgKTsKICAgICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocHJldmlvdXNQb2ludCwgbmV4dFBvaW50LCBsZWZ0KSwKICAgICAgICAgICAgbGVmdAogICAgICAgICAgKTsKICAgICAgICAgIGFkZE5vcm1hbHMoYXR0ciwgbm9ybWFsMiwgbGVmdCwgZnJvbnQsIHZvaWQgMCwgdmVydGV4Rm9ybWF0KTsKICAgICAgICAgIGZyb250ICs9IDM7CiAgICAgICAgfQogICAgICAgIG91dHNpZGVQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgIHBpdm90ICogMywKICAgICAgICAgIG91dHNpZGVQb2ludAogICAgICAgICk7CiAgICAgICAgcHJldmlvdXNQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoZmluYWxQb3NpdGlvbnMsIChzdGFydCArIGopICogMywgcHJldmlvdXNQb2ludCksCiAgICAgICAgICBvdXRzaWRlUG9pbnQsCiAgICAgICAgICBwcmV2aW91c1BvaW50CiAgICAgICAgKTsKICAgICAgICBuZXh0UG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGZpbmFsUG9zaXRpb25zLCBzdGFydCAqIDMsIG5leHRQb2ludCksCiAgICAgICAgICBvdXRzaWRlUG9pbnQsCiAgICAgICAgICBuZXh0UG9pbnQKICAgICAgICApOwogICAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5leHRQb2ludCwgcHJldmlvdXNQb2ludCwgbGVmdCksIGxlZnQpLAogICAgICAgICAgbGVmdAogICAgICAgICk7CiAgICAgICAgYWRkTm9ybWFscyhhdHRyLCBub3JtYWwyLCBsZWZ0LCB2b2lkIDAsIGJhY2ssIHZlcnRleEZvcm1hdCk7CiAgICAgICAgYmFjayAtPSAzOwogICAgICB9CiAgICAgIHJpZ2h0RWRnZSA9IHBvc2l0aW9uc1twb3NJbmRleCsrXTsKICAgICAgbGVmdEVkZ2UgPSBwb3NpdGlvbnNbcG9zSW5kZXgrK107CiAgICAgIHJpZ2h0RWRnZS5zcGxpY2UoMCwgMyk7CiAgICAgIGxlZnRFZGdlLnNwbGljZShsZWZ0RWRnZS5sZW5ndGggLSAzLCAzKTsKICAgICAgZmluYWxQb3NpdGlvbnMuc2V0KHJpZ2h0RWRnZSwgZnJvbnQpOwogICAgICBmaW5hbFBvc2l0aW9ucy5zZXQobGVmdEVkZ2UsIGJhY2sgLSBsZWZ0RWRnZS5sZW5ndGggKyAxKTsKICAgICAgbGVuZ3RoID0gbGVmdEVkZ2UubGVuZ3RoIC0gMzsKICAgICAgY29tcEluZGV4ICs9IDM7CiAgICAgIGxlZnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGNvbXB1dGVkTGVmdHMsIGNvbXBJbmRleCwgbGVmdCk7CiAgICAgIGZvciAoaiA9IDA7IGogPCBsZWZ0RWRnZS5sZW5ndGg7IGogKz0gMykgewogICAgICAgIHJpZ2h0Tm9ybWFsID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocmlnaHRFZGdlLCBqLCBzY3JhdGNoMTMpLAogICAgICAgICAgc2NyYXRjaDEzCiAgICAgICAgKTsKICAgICAgICBsZWZ0Tm9ybWFsID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobGVmdEVkZ2UsIGxlbmd0aCAtIGosIHNjcmF0Y2gyMyksCiAgICAgICAgICBzY3JhdGNoMjMKICAgICAgICApOwogICAgICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChyaWdodE5vcm1hbCwgbGVmdE5vcm1hbCwgbm9ybWFsMiksCiAgICAgICAgICBub3JtYWwyCiAgICAgICAgKTsKICAgICAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCBiYWNrLCB2ZXJ0ZXhGb3JtYXQpOwogICAgICAgIExSID0gZnJvbnQgLyAzOwogICAgICAgIExMID0gTFIgLSAxOwogICAgICAgIFVSID0gKGJhY2sgLSAyKSAvIDM7CiAgICAgICAgVUwgPSBVUiArIDE7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTFI7CiAgICAgICAgZnJvbnQgKz0gMzsKICAgICAgICBiYWNrIC09IDM7CiAgICAgIH0KICAgICAgZnJvbnQgLT0gMzsKICAgICAgYmFjayArPSAzOwogICAgfQogICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgIGNvbXB1dGVkTm9ybWFscywKICAgICAgY29tcHV0ZWROb3JtYWxzLmxlbmd0aCAtIDMsCiAgICAgIG5vcm1hbDIKICAgICk7CiAgICBhZGROb3JtYWxzKGF0dHIsIG5vcm1hbDIsIGxlZnQsIGZyb250LCBiYWNrLCB2ZXJ0ZXhGb3JtYXQpOwogICAgaWYgKGFkZEVuZFBvc2l0aW9ucykgewogICAgICBmcm9udCArPSAzOwogICAgICBiYWNrIC09IDM7CiAgICAgIGxlZnRQb3MgPSBjYXJ0ZXNpYW4zMjsKICAgICAgcmlnaHRQb3MgPSBjYXJ0ZXNpYW40MjsKICAgICAgY29uc3QgbGFzdEVuZFBvc2l0aW9ucyA9IGVuZFBvc2l0aW9uc1sxXTsKICAgICAgZm9yIChpID0gMDsgaSA8IGhhbGZMZW5ndGg7IGkrKykgewogICAgICAgIGxlZnRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgbGFzdEVuZFBvc2l0aW9ucywKICAgICAgICAgIChlbmRQb3NpdGlvbkxlbmd0aCAtIGkgLSAxKSAqIDMsCiAgICAgICAgICBsZWZ0UG9zCiAgICAgICAgKTsKICAgICAgICByaWdodFBvcyA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobGFzdEVuZFBvc2l0aW9ucywgaSAqIDMsIHJpZ2h0UG9zKTsKICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgbGVmdFBvcywKICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgIGJhY2sKICAgICAgICApOwogICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKGZpbmFsUG9zaXRpb25zLCByaWdodFBvcywgZnJvbnQpOwogICAgICAgIGFkZE5vcm1hbHMoYXR0ciwgbm9ybWFsMiwgbGVmdCwgZnJvbnQsIGJhY2ssIHZlcnRleEZvcm1hdCk7CiAgICAgICAgTFIgPSBmcm9udCAvIDM7CiAgICAgICAgTEwgPSBMUiAtIDE7CiAgICAgICAgVVIgPSAoYmFjayAtIDIpIC8gMzsKICAgICAgICBVTCA9IFVSICsgMTsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMUjsKICAgICAgICBmcm9udCArPSAzOwogICAgICAgIGJhY2sgLT0gMzsKICAgICAgfQogICAgfQogICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICB2YWx1ZXM6IGZpbmFsUG9zaXRpb25zCiAgICB9KTsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgY29uc3Qgc3QgPSBuZXcgRmxvYXQzMkFycmF5KHNpemUgLyAzICogMik7CiAgICAgIGxldCByaWdodFN0OwogICAgICBsZXQgbGVmdFN0OwogICAgICBsZXQgc3RJbmRleCA9IDA7CiAgICAgIGlmIChhZGRFbmRQb3NpdGlvbnMpIHsKICAgICAgICBsZWZ0Q291bnQgLz0gMzsKICAgICAgICByaWdodENvdW50IC89IDM7CiAgICAgICAgY29uc3QgdGhldGEgPSBNYXRoLlBJIC8gKGVuZFBvc2l0aW9uTGVuZ3RoICsgMSk7CiAgICAgICAgbGVmdFN0ID0gMSAvIChsZWZ0Q291bnQgLSBlbmRQb3NpdGlvbkxlbmd0aCArIDEpOwogICAgICAgIHJpZ2h0U3QgPSAxIC8gKHJpZ2h0Q291bnQgLSBlbmRQb3NpdGlvbkxlbmd0aCArIDEpOwogICAgICAgIGxldCBhMzsKICAgICAgICBjb25zdCBoYWxmRW5kUG9zID0gZW5kUG9zaXRpb25MZW5ndGggLyAyOwogICAgICAgIGZvciAoaSA9IGhhbGZFbmRQb3MgKyAxOyBpIDwgZW5kUG9zaXRpb25MZW5ndGggKyAxOyBpKyspIHsKICAgICAgICAgIGEzID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPICsgdGhldGEgKiBpOwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IHJpZ2h0U3QgKiAoMSArIE1hdGguY29zKGEzKSk7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gMC41ICogKDEgKyBNYXRoLnNpbihhMykpOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAxOyBpIDwgcmlnaHRDb3VudCAtIGVuZFBvc2l0aW9uTGVuZ3RoICsgMTsgaSsrKSB7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gaSAqIHJpZ2h0U3Q7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gMDsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gZW5kUG9zaXRpb25MZW5ndGg7IGkgPiBoYWxmRW5kUG9zOyBpLS0pIHsKICAgICAgICAgIGEzID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gaSAqIHRoZXRhOwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IDEgLSByaWdodFN0ICogKDEgKyBNYXRoLmNvcyhhMykpOwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IDAuNSAqICgxICsgTWF0aC5zaW4oYTMpKTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gaGFsZkVuZFBvczsgaSA+IDA7IGktLSkgewogICAgICAgICAgYTMgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gLSB0aGV0YSAqIGk7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gMSAtIGxlZnRTdCAqICgxICsgTWF0aC5jb3MoYTMpKTsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAwLjUgKiAoMSArIE1hdGguc2luKGEzKSk7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IGxlZnRDb3VudCAtIGVuZFBvc2l0aW9uTGVuZ3RoOyBpID4gMDsgaS0tKSB7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gaSAqIGxlZnRTdDsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAxOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAxOyBpIDwgaGFsZkVuZFBvcyArIDE7IGkrKykgewogICAgICAgICAgYTMgPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gKyB0aGV0YSAqIGk7CiAgICAgICAgICBzdFtzdEluZGV4KytdID0gbGVmdFN0ICogKDEgKyBNYXRoLmNvcyhhMykpOwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IDAuNSAqICgxICsgTWF0aC5zaW4oYTMpKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGVmdENvdW50IC89IDM7CiAgICAgICAgcmlnaHRDb3VudCAvPSAzOwogICAgICAgIGxlZnRTdCA9IDEgLyAobGVmdENvdW50IC0gMSk7CiAgICAgICAgcmlnaHRTdCA9IDEgLyAocmlnaHRDb3VudCAtIDEpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCByaWdodENvdW50OyBpKyspIHsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSBpICogcmlnaHRTdDsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAwOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSBsZWZ0Q291bnQ7IGkgPiAwOyBpLS0pIHsKICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSAoaSAtIDEpICogbGVmdFN0OwogICAgICAgICAgc3Rbc3RJbmRleCsrXSA9IDE7CiAgICAgICAgfQogICAgICB9CiAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICB2YWx1ZXM6IHN0CiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgYXR0cmlidXRlcy5ub3JtYWwgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGF0dHIubm9ybWFscwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICBhdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGF0dHIudGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogYXR0ci5iaXRhbmdlbnRzCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgYXR0cmlidXRlcywKICAgICAgaW5kaWNlcwogICAgfTsKICB9CiAgZnVuY3Rpb24gZXh0cnVkZWRBdHRyaWJ1dGVzKGF0dHJpYnV0ZXMsIHZlcnRleEZvcm1hdCkgewogICAgaWYgKCF2ZXJ0ZXhGb3JtYXQubm9ybWFsICYmICF2ZXJ0ZXhGb3JtYXQudGFuZ2VudCAmJiAhdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCAmJiAhdmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIHJldHVybiBhdHRyaWJ1dGVzOwogICAgfQogICAgY29uc3QgcG9zaXRpb25zID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICBsZXQgdG9wTm9ybWFsczsKICAgIGxldCB0b3BCaXRhbmdlbnRzOwogICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICB0b3BOb3JtYWxzID0gYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzOwogICAgICB0b3BCaXRhbmdlbnRzID0gYXR0cmlidXRlcy5iaXRhbmdlbnQudmFsdWVzOwogICAgfQogICAgY29uc3Qgc2l6ZSA9IGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCAvIDE4OwogICAgY29uc3QgdGhyZWVTaXplID0gc2l6ZSAqIDM7CiAgICBjb25zdCB0d29TaXplID0gc2l6ZSAqIDI7CiAgICBjb25zdCBzaXhTaXplID0gdGhyZWVTaXplICogMjsKICAgIGxldCBpOwogICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICBjb25zdCBub3JtYWxzID0gdmVydGV4Rm9ybWF0Lm5vcm1hbCA/IG5ldyBGbG9hdDMyQXJyYXkodGhyZWVTaXplICogNikgOiB2b2lkIDA7CiAgICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KHRocmVlU2l6ZSAqIDYpIDogdm9pZCAwOwogICAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkodGhyZWVTaXplICogNikgOiB2b2lkIDA7CiAgICAgIGxldCB0b3BQb3NpdGlvbiA9IGNhcnRlc2lhbjEyOwogICAgICBsZXQgYm90dG9tUG9zaXRpb24gPSBjYXJ0ZXNpYW4yMjsKICAgICAgbGV0IHByZXZpb3VzUG9zaXRpb24gPSBjYXJ0ZXNpYW4zMjsKICAgICAgbGV0IG5vcm1hbDIgPSBjYXJ0ZXNpYW40MjsKICAgICAgbGV0IHRhbmdlbnQgPSBjYXJ0ZXNpYW41MjsKICAgICAgbGV0IGJpdGFuZ2VudCA9IGNhcnRlc2lhbjYyOwogICAgICBsZXQgYXR0ckluZGV4ID0gc2l4U2l6ZTsKICAgICAgZm9yIChpID0gMDsgaSA8IHRocmVlU2l6ZTsgaSArPSAzKSB7CiAgICAgICAgY29uc3QgYXR0ckluZGV4T2Zmc2V0ID0gYXR0ckluZGV4ICsgc2l4U2l6ZTsKICAgICAgICB0b3BQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpLCB0b3BQb3NpdGlvbik7CiAgICAgICAgYm90dG9tUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgaSArIHRocmVlU2l6ZSwKICAgICAgICAgIGJvdHRvbVBvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBwcmV2aW91c1Bvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIChpICsgMykgJSB0aHJlZVNpemUsCiAgICAgICAgICBwcmV2aW91c1Bvc2l0aW9uCiAgICAgICAgKTsKICAgICAgICBib3R0b21Qb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIGJvdHRvbVBvc2l0aW9uLAogICAgICAgICAgdG9wUG9zaXRpb24sCiAgICAgICAgICBib3R0b21Qb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgcHJldmlvdXNQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgICAgIHByZXZpb3VzUG9zaXRpb24sCiAgICAgICAgICB0b3BQb3NpdGlvbiwKICAgICAgICAgIHByZXZpb3VzUG9zaXRpb24KICAgICAgICApOwogICAgICAgIG5vcm1hbDIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGJvdHRvbVBvc2l0aW9uLCBwcmV2aW91c1Bvc2l0aW9uLCBub3JtYWwyKSwKICAgICAgICAgIG5vcm1hbDIKICAgICAgICApOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZShub3JtYWxzLCBub3JtYWwyLCBhdHRySW5kZXhPZmZzZXQpOwogICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgIG5vcm1hbHMsCiAgICAgICAgICAgIG5vcm1hbDIsCiAgICAgICAgICAgIGF0dHJJbmRleE9mZnNldCArIDMKICAgICAgICAgICk7CiAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZShub3JtYWxzLCBub3JtYWwyLCBhdHRySW5kZXgpOwogICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUobm9ybWFscywgbm9ybWFsMiwgYXR0ckluZGV4ICsgMyk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBiaXRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHRvcE5vcm1hbHMsIGksIGJpdGFuZ2VudCk7CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgICBiaXRhbmdlbnRzLAogICAgICAgICAgICAgIGJpdGFuZ2VudCwKICAgICAgICAgICAgICBhdHRySW5kZXhPZmZzZXQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgYml0YW5nZW50cywKICAgICAgICAgICAgICBiaXRhbmdlbnQsCiAgICAgICAgICAgICAgYXR0ckluZGV4T2Zmc2V0ICsgMwogICAgICAgICAgICApOwogICAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgICBiaXRhbmdlbnRzLAogICAgICAgICAgICAgIGJpdGFuZ2VudCwKICAgICAgICAgICAgICBhdHRySW5kZXgKICAgICAgICAgICAgKTsKICAgICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgYml0YW5nZW50cywKICAgICAgICAgICAgICBiaXRhbmdlbnQsCiAgICAgICAgICAgICAgYXR0ckluZGV4ICsgMwogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgIHRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhiaXRhbmdlbnQsIG5vcm1hbDIsIHRhbmdlbnQpLAogICAgICAgICAgICAgIHRhbmdlbnQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgdGFuZ2VudHMsCiAgICAgICAgICAgICAgdGFuZ2VudCwKICAgICAgICAgICAgICBhdHRySW5kZXhPZmZzZXQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgdGFuZ2VudHMsCiAgICAgICAgICAgICAgdGFuZ2VudCwKICAgICAgICAgICAgICBhdHRySW5kZXhPZmZzZXQgKyAzCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKHRhbmdlbnRzLCB0YW5nZW50LCBhdHRySW5kZXgpOwogICAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgICAgICB0YW5nZW50LAogICAgICAgICAgICAgIGF0dHJJbmRleCArIDMKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYXR0ckluZGV4ICs9IDY7CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICBub3JtYWxzLnNldCh0b3BOb3JtYWxzKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhyZWVTaXplOyBpICs9IDMpIHsKICAgICAgICAgIG5vcm1hbHNbaSArIHRocmVlU2l6ZV0gPSAtdG9wTm9ybWFsc1tpXTsKICAgICAgICAgIG5vcm1hbHNbaSArIHRocmVlU2l6ZSArIDFdID0gLXRvcE5vcm1hbHNbaSArIDFdOwogICAgICAgICAgbm9ybWFsc1tpICsgdGhyZWVTaXplICsgMl0gPSAtdG9wTm9ybWFsc1tpICsgMl07CiAgICAgICAgfQogICAgICAgIGF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlcyA9IG5vcm1hbHM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYXR0cmlidXRlcy5ub3JtYWwgPSB2b2lkIDA7CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICBiaXRhbmdlbnRzLnNldCh0b3BCaXRhbmdlbnRzKTsKICAgICAgICBiaXRhbmdlbnRzLnNldCh0b3BCaXRhbmdlbnRzLCB0aHJlZVNpemUpOwogICAgICAgIGF0dHJpYnV0ZXMuYml0YW5nZW50LnZhbHVlcyA9IGJpdGFuZ2VudHM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSB2b2lkIDA7CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgY29uc3QgdG9wVGFuZ2VudHMgPSBhdHRyaWJ1dGVzLnRhbmdlbnQudmFsdWVzOwogICAgICAgIHRhbmdlbnRzLnNldCh0b3BUYW5nZW50cyk7CiAgICAgICAgdGFuZ2VudHMuc2V0KHRvcFRhbmdlbnRzLCB0aHJlZVNpemUpOwogICAgICAgIGF0dHJpYnV0ZXMudGFuZ2VudC52YWx1ZXMgPSB0YW5nZW50czsKICAgICAgfQogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICBjb25zdCB0b3BTdCA9IGF0dHJpYnV0ZXMuc3QudmFsdWVzOwogICAgICBjb25zdCBzdCA9IG5ldyBGbG9hdDMyQXJyYXkodHdvU2l6ZSAqIDYpOwogICAgICBzdC5zZXQodG9wU3QpOwogICAgICBzdC5zZXQodG9wU3QsIHR3b1NpemUpOwogICAgICBsZXQgaW5kZXggPSB0d29TaXplICogMjsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCAyOyBqKyspIHsKICAgICAgICBzdFtpbmRleCsrXSA9IHRvcFN0WzBdOwogICAgICAgIHN0W2luZGV4KytdID0gdG9wU3RbMV07CiAgICAgICAgZm9yIChpID0gMjsgaSA8IHR3b1NpemU7IGkgKz0gMikgewogICAgICAgICAgY29uc3QgcyA9IHRvcFN0W2ldOwogICAgICAgICAgY29uc3QgdCA9IHRvcFN0W2kgKyAxXTsKICAgICAgICAgIHN0W2luZGV4KytdID0gczsKICAgICAgICAgIHN0W2luZGV4KytdID0gdDsKICAgICAgICAgIHN0W2luZGV4KytdID0gczsKICAgICAgICAgIHN0W2luZGV4KytdID0gdDsKICAgICAgICB9CiAgICAgICAgc3RbaW5kZXgrK10gPSB0b3BTdFswXTsKICAgICAgICBzdFtpbmRleCsrXSA9IHRvcFN0WzFdOwogICAgICB9CiAgICAgIGF0dHJpYnV0ZXMuc3QudmFsdWVzID0gc3Q7CiAgICB9CiAgICByZXR1cm4gYXR0cmlidXRlczsKICB9CiAgZnVuY3Rpb24gYWRkV2FsbFBvc2l0aW9ucyhwb3NpdGlvbnMsIGluZGV4LCB3YWxsUG9zaXRpb25zKSB7CiAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0gcG9zaXRpb25zWzBdOwogICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHBvc2l0aW9uc1sxXTsKICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSBwb3NpdGlvbnNbMl07CiAgICBmb3IgKGxldCBpID0gMzsgaSA8IHBvc2l0aW9ucy5sZW5ndGg7IGkgKz0gMykgewogICAgICBjb25zdCB4ID0gcG9zaXRpb25zW2ldOwogICAgICBjb25zdCB5ID0gcG9zaXRpb25zW2kgKyAxXTsKICAgICAgY29uc3QgeiA9IHBvc2l0aW9uc1tpICsgMl07CiAgICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSB4OwogICAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0geTsKICAgICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHo7CiAgICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSB4OwogICAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0geTsKICAgICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHo7CiAgICB9CiAgICB3YWxsUG9zaXRpb25zW2luZGV4KytdID0gcG9zaXRpb25zWzBdOwogICAgd2FsbFBvc2l0aW9uc1tpbmRleCsrXSA9IHBvc2l0aW9uc1sxXTsKICAgIHdhbGxQb3NpdGlvbnNbaW5kZXgrK10gPSBwb3NpdGlvbnNbMl07CiAgICByZXR1cm4gd2FsbFBvc2l0aW9uczsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVBvc2l0aW9uc0V4dHJ1ZGVkKHBhcmFtcywgdmVydGV4Rm9ybWF0KSB7CiAgICBjb25zdCB0b3BWZXJ0ZXhGb3JtYXQgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoewogICAgICBwb3NpdGlvbjogdmVydGV4Rm9ybWF0LnBvc2l0aW9uLAogICAgICBub3JtYWw6IHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCB8fCBwYXJhbXMuc2hhZG93Vm9sdW1lLAogICAgICB0YW5nZW50OiB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCwKICAgICAgYml0YW5nZW50OiB2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQsCiAgICAgIHN0OiB2ZXJ0ZXhGb3JtYXQuc3QKICAgIH0pOwogICAgY29uc3QgZWxsaXBzb2lkID0gcGFyYW1zLmVsbGlwc29pZDsKICAgIGNvbnN0IGNvbXB1dGVkUG9zaXRpb25zID0gQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKHBhcmFtcyk7CiAgICBjb25zdCBhdHRyID0gY29tYmluZTIoY29tcHV0ZWRQb3NpdGlvbnMsIHRvcFZlcnRleEZvcm1hdCwgZWxsaXBzb2lkKTsKICAgIGNvbnN0IGhlaWdodCA9IHBhcmFtcy5oZWlnaHQ7CiAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IHBhcmFtcy5leHRydWRlZEhlaWdodDsKICAgIGxldCBhdHRyaWJ1dGVzID0gYXR0ci5hdHRyaWJ1dGVzOwogICAgY29uc3QgaW5kaWNlcyA9IGF0dHIuaW5kaWNlczsKICAgIGxldCBwb3NpdGlvbnMgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3QgbmV3UG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGggKiA2KTsKICAgIGxldCBleHRydWRlZFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkobGVuZ3RoKTsKICAgIGV4dHJ1ZGVkUG9zaXRpb25zLnNldChwb3NpdGlvbnMpOwogICAgbGV0IHdhbGxQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCAqIDQpOwogICAgcG9zaXRpb25zID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICBwb3NpdGlvbnMsCiAgICAgIGhlaWdodCwKICAgICAgZWxsaXBzb2lkCiAgICApOwogICAgd2FsbFBvc2l0aW9ucyA9IGFkZFdhbGxQb3NpdGlvbnMocG9zaXRpb25zLCAwLCB3YWxsUG9zaXRpb25zKTsKICAgIGV4dHJ1ZGVkUG9zaXRpb25zID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICBleHRydWRlZFBvc2l0aW9ucywKICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgIGVsbGlwc29pZAogICAgKTsKICAgIHdhbGxQb3NpdGlvbnMgPSBhZGRXYWxsUG9zaXRpb25zKAogICAgICBleHRydWRlZFBvc2l0aW9ucywKICAgICAgbGVuZ3RoICogMiwKICAgICAgd2FsbFBvc2l0aW9ucwogICAgKTsKICAgIG5ld1Bvc2l0aW9ucy5zZXQocG9zaXRpb25zKTsKICAgIG5ld1Bvc2l0aW9ucy5zZXQoZXh0cnVkZWRQb3NpdGlvbnMsIGxlbmd0aCk7CiAgICBuZXdQb3NpdGlvbnMuc2V0KHdhbGxQb3NpdGlvbnMsIGxlbmd0aCAqIDIpOwogICAgYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBuZXdQb3NpdGlvbnM7CiAgICBhdHRyaWJ1dGVzID0gZXh0cnVkZWRBdHRyaWJ1dGVzKGF0dHJpYnV0ZXMsIHZlcnRleEZvcm1hdCk7CiAgICBsZXQgaTsKICAgIGNvbnN0IHNpemUgPSBsZW5ndGggLyAzOwogICAgaWYgKHBhcmFtcy5zaGFkb3dWb2x1bWUpIHsKICAgICAgY29uc3QgdG9wTm9ybWFscyA9IGF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlczsKICAgICAgbGVuZ3RoID0gdG9wTm9ybWFscy5sZW5ndGg7CiAgICAgIGxldCBleHRydWRlTm9ybWFscyA9IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoICogNik7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHRvcE5vcm1hbHNbaV0gPSAtdG9wTm9ybWFsc1tpXTsKICAgICAgfQogICAgICBleHRydWRlTm9ybWFscy5zZXQodG9wTm9ybWFscywgbGVuZ3RoKTsKICAgICAgZXh0cnVkZU5vcm1hbHMgPSBhZGRXYWxsUG9zaXRpb25zKHRvcE5vcm1hbHMsIGxlbmd0aCAqIDQsIGV4dHJ1ZGVOb3JtYWxzKTsKICAgICAgYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBleHRydWRlTm9ybWFscwogICAgICB9KTsKICAgICAgaWYgKCF2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgYXR0cmlidXRlcy5ub3JtYWwgPSB2b2lkIDA7CiAgICAgIH0KICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocGFyYW1zLm9mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgbGV0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkoc2l6ZSAqIDYpOwogICAgICBpZiAocGFyYW1zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgICBhcHBseU9mZnNldCA9IGFwcGx5T2Zmc2V0LmZpbGwoMSwgMCwgc2l6ZSkuZmlsbCgxLCBzaXplICogMiwgc2l6ZSAqIDQpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0VmFsdWUgPSBwYXJhbXMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICBhcHBseU9mZnNldCA9IGFwcGx5T2Zmc2V0LmZpbGwoYXBwbHlPZmZzZXRWYWx1ZSk7CiAgICAgIH0KICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IGlMZW5ndGggPSBpbmRpY2VzLmxlbmd0aDsKICAgIGNvbnN0IHR3b1NpemUgPSBzaXplICsgc2l6ZTsKICAgIGNvbnN0IG5ld0luZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgbmV3UG9zaXRpb25zLmxlbmd0aCAvIDMsCiAgICAgIGlMZW5ndGggKiAyICsgdHdvU2l6ZSAqIDMKICAgICk7CiAgICBuZXdJbmRpY2VzLnNldChpbmRpY2VzKTsKICAgIGxldCBpbmRleCA9IGlMZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgaUxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGNvbnN0IHYwMiA9IGluZGljZXNbaV07CiAgICAgIGNvbnN0IHYxMiA9IGluZGljZXNbaSArIDFdOwogICAgICBjb25zdCB2MjIgPSBpbmRpY2VzW2kgKyAyXTsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IHYyMiArIHNpemU7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSB2MTIgKyBzaXplOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gdjAyICsgc2l6ZTsKICAgIH0KICAgIGxldCBVTCwgTEwsIFVSLCBMUjsKICAgIGZvciAoaSA9IDA7IGkgPCB0d29TaXplOyBpICs9IDIpIHsKICAgICAgVUwgPSBpICsgdHdvU2l6ZTsKICAgICAgTEwgPSBVTCArIHR3b1NpemU7CiAgICAgIFVSID0gVUwgKyAxOwogICAgICBMUiA9IExMICsgMTsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IFVMOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgbmV3SW5kaWNlc1tpbmRleCsrXSA9IFVSOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSBMUjsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXM6IG5ld0luZGljZXMKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVPZmZzZXRQb2ludHMocG9zaXRpb24xLCBwb3NpdGlvbjIsIGVsbGlwc29pZCwgaGFsZldpZHRoLCBtaW4zLCBtYXgzKSB7CiAgICBjb25zdCBkaXJlY3Rpb24yID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICBwb3NpdGlvbjIsCiAgICAgIHBvc2l0aW9uMSwKICAgICAgc2NyYXRjaENhcnRlc2lhbjE3CiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShkaXJlY3Rpb24yLCBkaXJlY3Rpb24yKTsKICAgIGNvbnN0IG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uMSwgc2NyYXRjaENhcnRlc2lhbjI3KTsKICAgIGNvbnN0IG9mZnNldERpcmVjdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcygKICAgICAgZGlyZWN0aW9uMiwKICAgICAgbm9ybWFsMiwKICAgICAgc2NyYXRjaENhcnRlc2lhbjE3CiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIob2Zmc2V0RGlyZWN0aW9uLCBoYWxmV2lkdGgsIG9mZnNldERpcmVjdGlvbik7CiAgICBsZXQgbWluTGF0ID0gbWluMy5sYXRpdHVkZTsKICAgIGxldCBtaW5Mb24gPSBtaW4zLmxvbmdpdHVkZTsKICAgIGxldCBtYXhMYXQgPSBtYXgzLmxhdGl0dWRlOwogICAgbGV0IG1heExvbiA9IG1heDMubG9uZ2l0dWRlOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbjEsIG9mZnNldERpcmVjdGlvbiwgc2NyYXRjaENhcnRlc2lhbjI3KTsKICAgIGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhzY3JhdGNoQ2FydGVzaWFuMjcsIHNjcmF0Y2hDYXJ0b2dyYXBoaWM0KTsKICAgIGxldCBsYXQgPSBzY3JhdGNoQ2FydG9ncmFwaGljNC5sYXRpdHVkZTsKICAgIGxldCBsb24gPSBzY3JhdGNoQ2FydG9ncmFwaGljNC5sb25naXR1ZGU7CiAgICBtaW5MYXQgPSBNYXRoLm1pbihtaW5MYXQsIGxhdCk7CiAgICBtaW5Mb24gPSBNYXRoLm1pbihtaW5Mb24sIGxvbik7CiAgICBtYXhMYXQgPSBNYXRoLm1heChtYXhMYXQsIGxhdCk7CiAgICBtYXhMb24gPSBNYXRoLm1heChtYXhMb24sIGxvbik7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocG9zaXRpb24xLCBvZmZzZXREaXJlY3Rpb24sIHNjcmF0Y2hDYXJ0ZXNpYW4yNyk7CiAgICBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoc2NyYXRjaENhcnRlc2lhbjI3LCBzY3JhdGNoQ2FydG9ncmFwaGljNCk7CiAgICBsYXQgPSBzY3JhdGNoQ2FydG9ncmFwaGljNC5sYXRpdHVkZTsKICAgIGxvbiA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWM0LmxvbmdpdHVkZTsKICAgIG1pbkxhdCA9IE1hdGgubWluKG1pbkxhdCwgbGF0KTsKICAgIG1pbkxvbiA9IE1hdGgubWluKG1pbkxvbiwgbG9uKTsKICAgIG1heExhdCA9IE1hdGgubWF4KG1heExhdCwgbGF0KTsKICAgIG1heExvbiA9IE1hdGgubWF4KG1heExvbiwgbG9uKTsKICAgIG1pbjMubGF0aXR1ZGUgPSBtaW5MYXQ7CiAgICBtaW4zLmxvbmdpdHVkZSA9IG1pbkxvbjsKICAgIG1heDMubGF0aXR1ZGUgPSBtYXhMYXQ7CiAgICBtYXgzLmxvbmdpdHVkZSA9IG1heExvbjsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVJlY3RhbmdsZTIocG9zaXRpb25zLCBlbGxpcHNvaWQsIHdpZHRoLCBjb3JuZXJUeXBlLCByZXN1bHQpIHsKICAgIHBvc2l0aW9ucyA9IHNjYWxlVG9TdXJmYWNlMihwb3NpdGlvbnMsIGVsbGlwc29pZCk7CiAgICBjb25zdCBjbGVhblBvc2l0aW9ucyA9IGFycmF5UmVtb3ZlRHVwbGljYXRlc19kZWZhdWx0KAogICAgICBwb3NpdGlvbnMsCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uCiAgICApOwogICAgY29uc3QgbGVuZ3RoID0gY2xlYW5Qb3NpdGlvbnMubGVuZ3RoOwogICAgaWYgKGxlbmd0aCA8IDIgfHwgd2lkdGggPD0gMCkgewogICAgICByZXR1cm4gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICB9CiAgICBjb25zdCBoYWxmV2lkdGggPSB3aWR0aCAqIDAuNTsKICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubGF0aXR1ZGUgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxvbmdpdHVkZSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubGF0aXR1ZGUgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxvbmdpdHVkZSA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIGxldCBsYXQsIGxvbjsKICAgIGlmIChjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCkgewogICAgICBjb25zdCBmaXJzdCA9IGNsZWFuUG9zaXRpb25zWzBdOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoZmlyc3QsIGNsZWFuUG9zaXRpb25zWzFdLCBzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0KTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0LCBzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0KTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgICAgc2NyYXRjaENhcnRlc2lhbk9mZnNldCwKICAgICAgICBoYWxmV2lkdGgsCiAgICAgICAgc2NyYXRjaENhcnRlc2lhbk9mZnNldAogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGZpcnN0LCBzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0LCBzY3JhdGNoQ2FydGVzaWFuRW5kcyk7CiAgICAgIGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICBzY3JhdGNoQ2FydGVzaWFuRW5kcywKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNAogICAgICApOwogICAgICBsYXQgPSBzY3JhdGNoQ2FydG9ncmFwaGljNC5sYXRpdHVkZTsKICAgICAgbG9uID0gc2NyYXRjaENhcnRvZ3JhcGhpYzQubG9uZ2l0dWRlOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxhdGl0dWRlID0gTWF0aC5taW4oCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sYXRpdHVkZSwKICAgICAgICBsYXQKICAgICAgKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sb25naXR1ZGUgPSBNYXRoLm1pbigKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxvbmdpdHVkZSwKICAgICAgICBsb24KICAgICAgKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sYXRpdHVkZSA9IE1hdGgubWF4KAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubGF0aXR1ZGUsCiAgICAgICAgbGF0CiAgICAgICk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgubG9uZ2l0dWRlID0gTWF0aC5tYXgoCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sb25naXR1ZGUsCiAgICAgICAgbG9uCiAgICAgICk7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aCAtIDE7ICsraSkgewogICAgICBjb21wdXRlT2Zmc2V0UG9pbnRzKAogICAgICAgIGNsZWFuUG9zaXRpb25zW2ldLAogICAgICAgIGNsZWFuUG9zaXRpb25zW2kgKyAxXSwKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgaGFsZldpZHRoLAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4sCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heAogICAgICApOwogICAgfQogICAgY29uc3QgbGFzdCA9IGNsZWFuUG9zaXRpb25zW2xlbmd0aCAtIDFdOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGxhc3QsIGNsZWFuUG9zaXRpb25zW2xlbmd0aCAtIDJdLCBzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoc2NyYXRjaENhcnRlc2lhbk9mZnNldCwgc2NyYXRjaENhcnRlc2lhbk9mZnNldCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgc2NyYXRjaENhcnRlc2lhbk9mZnNldCwKICAgICAgaGFsZldpZHRoLAogICAgICBzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0CiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChsYXN0LCBzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0LCBzY3JhdGNoQ2FydGVzaWFuRW5kcyk7CiAgICBjb21wdXRlT2Zmc2V0UG9pbnRzKAogICAgICBsYXN0LAogICAgICBzY3JhdGNoQ2FydGVzaWFuRW5kcywKICAgICAgZWxsaXBzb2lkLAogICAgICBoYWxmV2lkdGgsCiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4sCiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXgKICAgICk7CiAgICBpZiAoY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQpIHsKICAgICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5FbmRzLAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM0CiAgICAgICk7CiAgICAgIGxhdCA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWM0LmxhdGl0dWRlOwogICAgICBsb24gPSBzY3JhdGNoQ2FydG9ncmFwaGljNC5sb25naXR1ZGU7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubGF0aXR1ZGUgPSBNYXRoLm1pbigKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxhdGl0dWRlLAogICAgICAgIGxhdAogICAgICApOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluLmxvbmdpdHVkZSA9IE1hdGgubWluKAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubG9uZ2l0dWRlLAogICAgICAgIGxvbgogICAgICApOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxhdGl0dWRlID0gTWF0aC5tYXgoCiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sYXRpdHVkZSwKICAgICAgICBsYXQKICAgICAgKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sb25naXR1ZGUgPSBNYXRoLm1heCgKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxvbmdpdHVkZSwKICAgICAgICBsb24KICAgICAgKTsKICAgIH0KICAgIGNvbnN0IHJlY3RhbmdsZSA9IGRlZmluZWRfZGVmYXVsdChyZXN1bHQpID8gcmVzdWx0IDogbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICByZWN0YW5nbGUubm9ydGggPSBzY3JhdGNoQ2FydG9ncmFwaGljTWF4LmxhdGl0dWRlOwogICAgcmVjdGFuZ2xlLnNvdXRoID0gc2NyYXRjaENhcnRvZ3JhcGhpY01pbi5sYXRpdHVkZTsKICAgIHJlY3RhbmdsZS5lYXN0ID0gc2NyYXRjaENhcnRvZ3JhcGhpY01heC5sb25naXR1ZGU7CiAgICByZWN0YW5nbGUud2VzdCA9IHNjcmF0Y2hDYXJ0b2dyYXBoaWNNaW4ubG9uZ2l0dWRlOwogICAgcmV0dXJuIHJlY3RhbmdsZTsKICB9CiAgZnVuY3Rpb24gQ29ycmlkb3JHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgY29uc3Qgd2lkdGggPSBvcHRpb25zLndpZHRoOwogICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLnBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMud2lkdGgiLCB3aWR0aCk7CiAgICBjb25zdCBoZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmhlaWdodCwgMCk7CiAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICB0aGlzLl9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KQogICAgKTsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCkKICAgICk7CiAgICB0aGlzLl93aWR0aCA9IHdpZHRoOwogICAgdGhpcy5faGVpZ2h0ID0gTWF0aC5tYXgoaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICB0aGlzLl9leHRydWRlZEhlaWdodCA9IE1hdGgubWluKGhlaWdodCwgZXh0cnVkZWRIZWlnaHQpOwogICAgdGhpcy5fY29ybmVyVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY29ybmVyVHlwZSwgQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIHRoaXMuX3NoYWRvd1ZvbHVtZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc2hhZG93Vm9sdW1lLCBmYWxzZSk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZUNvcnJpZG9yR2VvbWV0cnkiOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl9yZWN0YW5nbGUgPSB2b2lkIDA7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IDEgKyBwb3NpdGlvbnMubGVuZ3RoICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDc7CiAgfQogIHZhciBjYXJ0ZXNpYW4xMiwgY2FydGVzaWFuMjIsIGNhcnRlc2lhbjMyLCBjYXJ0ZXNpYW40MiwgY2FydGVzaWFuNTIsIGNhcnRlc2lhbjYyLCBzY3JhdGNoMTMsIHNjcmF0Y2gyMywgc2NyYXRjaENhcnRlc2lhbjE3LCBzY3JhdGNoQ2FydGVzaWFuMjcsIHNjcmF0Y2hDYXJ0b2dyYXBoaWM0LCBzY3JhdGNoQ2FydGVzaWFuT2Zmc2V0LCBzY3JhdGNoQ2FydGVzaWFuRW5kcywgc2NyYXRjaENhcnRvZ3JhcGhpY01pbiwgc2NyYXRjaENhcnRvZ3JhcGhpY01heCwgc2NyYXRjaEVsbGlwc29pZDQsIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ0LCBzY3JhdGNoT3B0aW9uczksIENvcnJpZG9yR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Db3JyaWRvckdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3JyaWRvckdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9hcnJheVJlbW92ZUR1cGxpY2F0ZXMoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfQ29ybmVyVHlwZSgpOwogICAgICBpbml0X0NvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBjYXJ0ZXNpYW4xMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuMjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjMyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW40MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuNTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjYyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoMTMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2gyMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjE3ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMjcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5PZmZzZXQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW5FbmRzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljTWluID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNNYXggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgQ29ycmlkb3JHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2YWx1ZS5fcG9zaXRpb25zOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3dpZHRoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5faGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9jb3JuZXJUeXBlOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zaGFkb3dWb2x1bWUgPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQ0ID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0NCA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczkgPSB7CiAgICAgICAgcG9zaXRpb25zOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkNCwKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ0LAogICAgICAgIHdpZHRoOiB2b2lkIDAsCiAgICAgICAgaGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IHZvaWQgMCwKICAgICAgICBjb3JuZXJUeXBlOiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICBzaGFkb3dWb2x1bWU6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBDb3JyaWRvckdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgcG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDQpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ0CiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB3aWR0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgY29ybmVyVHlwZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNoYWRvd1ZvbHVtZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnM5LnBvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zOS53aWR0aCA9IHdpZHRoOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM5LmhlaWdodCA9IGhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zOS5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM5LmNvcm5lclR5cGUgPSBjb3JuZXJUeXBlOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM5LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczkuc2hhZG93Vm9sdW1lID0gc2hhZG93Vm9sdW1lOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnM5Lm9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICByZXR1cm4gbmV3IENvcnJpZG9yR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnM5KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCwgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQpOwogICAgICAgIHJlc3VsdC5fd2lkdGggPSB3aWR0aDsKICAgICAgICByZXN1bHQuX2hlaWdodCA9IGhlaWdodDsKICAgICAgICByZXN1bHQuX2V4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9jb3JuZXJUeXBlID0gY29ybmVyVHlwZTsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmVzdWx0Ll9zaGFkb3dWb2x1bWUgPSBzaGFkb3dWb2x1bWU7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvcnJpZG9yR2VvbWV0cnkuY29tcHV0ZVJlY3RhbmdsZSA9IGZ1bmN0aW9uKG9wdGlvbnMsIHJlc3VsdCkgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgICAgIGNvbnN0IHdpZHRoID0gb3B0aW9ucy53aWR0aDsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMucG9zaXRpb25zIiwgcG9zaXRpb25zKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMud2lkdGgiLCB3aWR0aCk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgICAgICBjb25zdCBjb3JuZXJUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5jb3JuZXJUeXBlLCBDb3JuZXJUeXBlX2RlZmF1bHQuUk9VTkRFRCk7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVSZWN0YW5nbGUyKHBvc2l0aW9ucywgZWxsaXBzb2lkLCB3aWR0aCwgY29ybmVyVHlwZSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQ29ycmlkb3JHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGNvcnJpZG9yR2VvbWV0cnkpIHsKICAgICAgICBsZXQgcG9zaXRpb25zID0gY29ycmlkb3JHZW9tZXRyeS5fcG9zaXRpb25zOwogICAgICAgIGNvbnN0IHdpZHRoID0gY29ycmlkb3JHZW9tZXRyeS5fd2lkdGg7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gY29ycmlkb3JHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIHBvc2l0aW9ucyA9IHNjYWxlVG9TdXJmYWNlMihwb3NpdGlvbnMsIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3QgY2xlYW5Qb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uCiAgICAgICAgKTsKICAgICAgICBpZiAoY2xlYW5Qb3NpdGlvbnMubGVuZ3RoIDwgMiB8fCB3aWR0aCA8PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGhlaWdodCA9IGNvcnJpZG9yR2VvbWV0cnkuX2hlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGNvcnJpZG9yR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGUgPSAhTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgIDAsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjIKICAgICAgICApOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGNvcnJpZG9yR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBwb3NpdGlvbnM6IGNsZWFuUG9zaXRpb25zLAogICAgICAgICAgd2lkdGgsCiAgICAgICAgICBjb3JuZXJUeXBlOiBjb3JyaWRvckdlb21ldHJ5Ll9jb3JuZXJUeXBlLAogICAgICAgICAgZ3JhbnVsYXJpdHk6IGNvcnJpZG9yR2VvbWV0cnkuX2dyYW51bGFyaXR5LAogICAgICAgICAgc2F2ZUF0dHJpYnV0ZXM6IHRydWUKICAgICAgICB9OwogICAgICAgIGxldCBhdHRyOwogICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICBwYXJhbXMuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgICAgcGFyYW1zLmV4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgICBwYXJhbXMuc2hhZG93Vm9sdW1lID0gY29ycmlkb3JHZW9tZXRyeS5fc2hhZG93Vm9sdW1lOwogICAgICAgICAgcGFyYW1zLm9mZnNldEF0dHJpYnV0ZSA9IGNvcnJpZG9yR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIGF0dHIgPSBjb21wdXRlUG9zaXRpb25zRXh0cnVkZWQocGFyYW1zLCB2ZXJ0ZXhGb3JtYXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBjb21wdXRlZFBvc2l0aW9ucyA9IENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9ucyhwYXJhbXMpOwogICAgICAgICAgYXR0ciA9IGNvbWJpbmUyKGNvbXB1dGVkUG9zaXRpb25zLCB2ZXJ0ZXhGb3JtYXQsIGVsbGlwc29pZCk7CiAgICAgICAgICBhdHRyLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICAgICAgICBhdHRyLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLAogICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29ycmlkb3JHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgICBjb25zdCBhcHBseU9mZnNldFZhbHVlID0gY29ycmlkb3JHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gYXR0ci5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcy5sZW5ndGg7CiAgICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChhcHBseU9mZnNldFZhbHVlKTsKICAgICAgICAgICAgYXR0ci5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gYXR0ci5hdHRyaWJ1dGVzOwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMoCiAgICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgIDMKICAgICAgICApOwogICAgICAgIGlmICghdmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgICAgICBhdHRyLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXM6IGF0dHIuaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogY29ycmlkb3JHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIENvcnJpZG9yR2VvbWV0cnkuY3JlYXRlU2hhZG93Vm9sdW1lID0gZnVuY3Rpb24oY29ycmlkb3JHZW9tZXRyeSwgbWluSGVpZ2h0RnVuYywgbWF4SGVpZ2h0RnVuYykgewogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gY29ycmlkb3JHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gY29ycmlkb3JHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IG1pbkhlaWdodCA9IG1pbkhlaWdodEZ1bmMoZ3JhbnVsYXJpdHksIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3QgbWF4SGVpZ2h0ID0gbWF4SGVpZ2h0RnVuYyhncmFudWxhcml0eSwgZWxsaXBzb2lkKTsKICAgICAgICByZXR1cm4gbmV3IENvcnJpZG9yR2VvbWV0cnkoewogICAgICAgICAgcG9zaXRpb25zOiBjb3JyaWRvckdlb21ldHJ5Ll9wb3NpdGlvbnMsCiAgICAgICAgICB3aWR0aDogY29ycmlkb3JHZW9tZXRyeS5fd2lkdGgsCiAgICAgICAgICBjb3JuZXJUeXBlOiBjb3JyaWRvckdlb21ldHJ5Ll9jb3JuZXJUeXBlLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBleHRydWRlZEhlaWdodDogbWluSGVpZ2h0LAogICAgICAgICAgaGVpZ2h0OiBtYXhIZWlnaHQsCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IFZlcnRleEZvcm1hdF9kZWZhdWx0LlBPU0lUSU9OX09OTFksCiAgICAgICAgICBzaGFkb3dWb2x1bWU6IHRydWUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoQ29ycmlkb3JHZW9tZXRyeS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHJlY3RhbmdsZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fcmVjdGFuZ2xlKSkgewogICAgICAgICAgICAgIHRoaXMuX3JlY3RhbmdsZSA9IGNvbXB1dGVSZWN0YW5nbGUyKAogICAgICAgICAgICAgICAgdGhpcy5fcG9zaXRpb25zLAogICAgICAgICAgICAgICAgdGhpcy5fZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgdGhpcy5fd2lkdGgsCiAgICAgICAgICAgICAgICB0aGlzLl9jb3JuZXJUeXBlCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5fcmVjdGFuZ2xlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogRm9yIHJlbWFwcGluZyB0ZXh0dXJlIGNvb3JkaW5hdGVzIHdoZW4gcmVuZGVyaW5nIENvcnJpZG9yR2VvbWV0cmllcyBhcyBHcm91bmRQcmltaXRpdmVzLgogICAgICAgICAqCiAgICAgICAgICogQ29ycmlkb3JzIGRvbid0IHN1cHBvcnQgc3RSb3RhdGlvbiwKICAgICAgICAgKiBzbyBqdXN0IHJldHVybiB0aGUgY29ybmVycyBvZiB0aGUgb3JpZ2luYWwgc3lzdGVtLgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIFswLCAwLCAwLCAxLCAxLCAwXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBDb3JyaWRvckdlb21ldHJ5X2RlZmF1bHQgPSBDb3JyaWRvckdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ29ycmlkb3JHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVDb3JyaWRvckdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVDb3JyaWRvckdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnkoY29ycmlkb3JHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgY29ycmlkb3JHZW9tZXRyeSA9IENvcnJpZG9yR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soY29ycmlkb3JHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIGNvcnJpZG9yR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGNvcnJpZG9yR2VvbWV0cnkuX2VsbGlwc29pZCk7CiAgICByZXR1cm4gQ29ycmlkb3JHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGNvcnJpZG9yR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlQ29ycmlkb3JHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUNvcnJpZG9yR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUNvcnJpZG9yR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0NvcnJpZG9yR2VvbWV0cnkoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Db3JyaWRvck91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIHNjYWxlVG9TdXJmYWNlMyhwb3NpdGlvbnMsIGVsbGlwc29pZCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgcG9zaXRpb25zW2ldID0gZWxsaXBzb2lkLnNjYWxlVG9HZW9kZXRpY1N1cmZhY2UocG9zaXRpb25zW2ldLCBwb3NpdGlvbnNbaV0pOwogICAgfQogICAgcmV0dXJuIHBvc2l0aW9uczsKICB9CiAgZnVuY3Rpb24gY29tYmluZTMoY29tcHV0ZWRQb3NpdGlvbnMsIGNvcm5lclR5cGUpIHsKICAgIGNvbnN0IHdhbGxJbmRpY2VzID0gW107CiAgICBjb25zdCBwb3NpdGlvbnMgPSBjb21wdXRlZFBvc2l0aW9ucy5wb3NpdGlvbnM7CiAgICBjb25zdCBjb3JuZXJzID0gY29tcHV0ZWRQb3NpdGlvbnMuY29ybmVyczsKICAgIGNvbnN0IGVuZFBvc2l0aW9ucyA9IGNvbXB1dGVkUG9zaXRpb25zLmVuZFBvc2l0aW9uczsKICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgIGxldCBjb3JuZXI7CiAgICBsZXQgbGVmdENvdW50ID0gMDsKICAgIGxldCByaWdodENvdW50ID0gMDsKICAgIGxldCBpOwogICAgbGV0IGluZGljZXNMZW5ndGggPSAwOwogICAgbGV0IGxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBwb3NpdGlvbnMubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgbGVuZ3RoID0gcG9zaXRpb25zW2ldLmxlbmd0aCAtIDM7CiAgICAgIGxlZnRDb3VudCArPSBsZW5ndGg7CiAgICAgIGluZGljZXNMZW5ndGggKz0gbGVuZ3RoIC8gMyAqIDQ7CiAgICAgIHJpZ2h0Q291bnQgKz0gcG9zaXRpb25zW2kgKyAxXS5sZW5ndGggLSAzOwogICAgfQogICAgbGVmdENvdW50ICs9IDM7CiAgICByaWdodENvdW50ICs9IDM7CiAgICBmb3IgKGkgPSAwOyBpIDwgY29ybmVycy5sZW5ndGg7IGkrKykgewogICAgICBjb3JuZXIgPSBjb3JuZXJzW2ldOwogICAgICBjb25zdCBsZWZ0U2lkZSA9IGNvcm5lcnNbaV0ubGVmdFBvc2l0aW9uczsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChsZWZ0U2lkZSkpIHsKICAgICAgICBsZW5ndGggPSBsZWZ0U2lkZS5sZW5ndGg7CiAgICAgICAgbGVmdENvdW50ICs9IGxlbmd0aDsKICAgICAgICBpbmRpY2VzTGVuZ3RoICs9IGxlbmd0aCAvIDMgKiAyOwogICAgICB9IGVsc2UgewogICAgICAgIGxlbmd0aCA9IGNvcm5lcnNbaV0ucmlnaHRQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIHJpZ2h0Q291bnQgKz0gbGVuZ3RoOwogICAgICAgIGluZGljZXNMZW5ndGggKz0gbGVuZ3RoIC8gMyAqIDI7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGFkZEVuZFBvc2l0aW9ucyA9IGRlZmluZWRfZGVmYXVsdChlbmRQb3NpdGlvbnMpOwogICAgbGV0IGVuZFBvc2l0aW9uTGVuZ3RoOwogICAgaWYgKGFkZEVuZFBvc2l0aW9ucykgewogICAgICBlbmRQb3NpdGlvbkxlbmd0aCA9IGVuZFBvc2l0aW9uc1swXS5sZW5ndGggLSAzOwogICAgICBsZWZ0Q291bnQgKz0gZW5kUG9zaXRpb25MZW5ndGg7CiAgICAgIHJpZ2h0Q291bnQgKz0gZW5kUG9zaXRpb25MZW5ndGg7CiAgICAgIGVuZFBvc2l0aW9uTGVuZ3RoIC89IDM7CiAgICAgIGluZGljZXNMZW5ndGggKz0gZW5kUG9zaXRpb25MZW5ndGggKiA0OwogICAgfQogICAgY29uc3Qgc2l6ZSA9IGxlZnRDb3VudCArIHJpZ2h0Q291bnQ7CiAgICBjb25zdCBmaW5hbFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSk7CiAgICBsZXQgZnJvbnQgPSAwOwogICAgbGV0IGJhY2sgPSBzaXplIC0gMTsKICAgIGxldCBVTCwgTEwsIFVSLCBMUjsKICAgIGxldCByaWdodFBvcywgbGVmdFBvczsKICAgIGNvbnN0IGhhbGZMZW5ndGggPSBlbmRQb3NpdGlvbkxlbmd0aCAvIDI7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoc2l6ZSAvIDMsIGluZGljZXNMZW5ndGggKyA0KTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBpbmRpY2VzW2luZGV4KytdID0gZnJvbnQgLyAzOwogICAgaW5kaWNlc1tpbmRleCsrXSA9IChiYWNrIC0gMikgLyAzOwogICAgaWYgKGFkZEVuZFBvc2l0aW9ucykgewogICAgICB3YWxsSW5kaWNlcy5wdXNoKGZyb250IC8gMyk7CiAgICAgIGxlZnRQb3MgPSBjYXJ0ZXNpYW4xMzsKICAgICAgcmlnaHRQb3MgPSBjYXJ0ZXNpYW4yMzsKICAgICAgY29uc3QgZmlyc3RFbmRQb3NpdGlvbnMgPSBlbmRQb3NpdGlvbnNbMF07CiAgICAgIGZvciAoaSA9IDA7IGkgPCBoYWxmTGVuZ3RoOyBpKyspIHsKICAgICAgICBsZWZ0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIGZpcnN0RW5kUG9zaXRpb25zLAogICAgICAgICAgKGhhbGZMZW5ndGggLSAxIC0gaSkgKiAzLAogICAgICAgICAgbGVmdFBvcwogICAgICAgICk7CiAgICAgICAgcmlnaHRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgZmlyc3RFbmRQb3NpdGlvbnMsCiAgICAgICAgICAoaGFsZkxlbmd0aCArIGkpICogMywKICAgICAgICAgIHJpZ2h0UG9zCiAgICAgICAgKTsKICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZShmaW5hbFBvc2l0aW9ucywgcmlnaHRQb3MsIGZyb250KTsKICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgIGZpbmFsUG9zaXRpb25zLAogICAgICAgICAgbGVmdFBvcywKICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgIGJhY2sKICAgICAgICApOwogICAgICAgIExMID0gZnJvbnQgLyAzOwogICAgICAgIExSID0gTEwgKyAxOwogICAgICAgIFVMID0gKGJhY2sgLSAyKSAvIDM7CiAgICAgICAgVVIgPSBVTCAtIDE7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgICAgIGZyb250ICs9IDM7CiAgICAgICAgYmFjayAtPSAzOwogICAgICB9CiAgICB9CiAgICBsZXQgcG9zSW5kZXggPSAwOwogICAgbGV0IHJpZ2h0RWRnZSA9IHBvc2l0aW9uc1twb3NJbmRleCsrXTsKICAgIGxldCBsZWZ0RWRnZSA9IHBvc2l0aW9uc1twb3NJbmRleCsrXTsKICAgIGZpbmFsUG9zaXRpb25zLnNldChyaWdodEVkZ2UsIGZyb250KTsKICAgIGZpbmFsUG9zaXRpb25zLnNldChsZWZ0RWRnZSwgYmFjayAtIGxlZnRFZGdlLmxlbmd0aCArIDEpOwogICAgbGVuZ3RoID0gbGVmdEVkZ2UubGVuZ3RoIC0gMzsKICAgIHdhbGxJbmRpY2VzLnB1c2goZnJvbnQgLyAzLCAoYmFjayAtIDIpIC8gMyk7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgTEwgPSBmcm9udCAvIDM7CiAgICAgIExSID0gTEwgKyAxOwogICAgICBVTCA9IChiYWNrIC0gMikgLyAzOwogICAgICBVUiA9IFVMIC0gMTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVMOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMTDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgICBmcm9udCArPSAzOwogICAgICBiYWNrIC09IDM7CiAgICB9CiAgICBmb3IgKGkgPSAwOyBpIDwgY29ybmVycy5sZW5ndGg7IGkrKykgewogICAgICBsZXQgajsKICAgICAgY29ybmVyID0gY29ybmVyc1tpXTsKICAgICAgY29uc3QgbCA9IGNvcm5lci5sZWZ0UG9zaXRpb25zOwogICAgICBjb25zdCByID0gY29ybmVyLnJpZ2h0UG9zaXRpb25zOwogICAgICBsZXQgc3RhcnQ7CiAgICAgIGxldCBvdXRzaWRlUG9pbnQgPSBjYXJ0ZXNpYW4zMzsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChsKSkgewogICAgICAgIGJhY2sgLT0gMzsKICAgICAgICBzdGFydCA9IFVSOwogICAgICAgIHdhbGxJbmRpY2VzLnB1c2goTFIpOwogICAgICAgIGZvciAoaiA9IDA7IGogPCBsLmxlbmd0aCAvIDM7IGorKykgewogICAgICAgICAgb3V0c2lkZVBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShsLCBqICogMywgb3V0c2lkZVBvaW50KTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBzdGFydCAtIGogLSAxOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHN0YXJ0IC0gajsKICAgICAgICAgIENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuYWRkQXR0cmlidXRlKAogICAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgICAgb3V0c2lkZVBvaW50LAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIGJhY2sKICAgICAgICAgICk7CiAgICAgICAgICBiYWNrIC09IDM7CiAgICAgICAgfQogICAgICAgIHdhbGxJbmRpY2VzLnB1c2goc3RhcnQgLSBNYXRoLmZsb29yKGwubGVuZ3RoIC8gNikpOwogICAgICAgIGlmIChjb3JuZXJUeXBlID09PSBDb3JuZXJUeXBlX2RlZmF1bHQuQkVWRUxFRCkgewogICAgICAgICAgd2FsbEluZGljZXMucHVzaCgoYmFjayAtIDIpIC8gMyArIDEpOwogICAgICAgIH0KICAgICAgICBmcm9udCArPSAzOwogICAgICB9IGVsc2UgewogICAgICAgIGZyb250ICs9IDM7CiAgICAgICAgc3RhcnQgPSBMUjsKICAgICAgICB3YWxsSW5kaWNlcy5wdXNoKFVSKTsKICAgICAgICBmb3IgKGogPSAwOyBqIDwgci5sZW5ndGggLyAzOyBqKyspIHsKICAgICAgICAgIG91dHNpZGVQb2ludCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkociwgaiAqIDMsIG91dHNpZGVQb2ludCk7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gc3RhcnQgKyBqOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHN0YXJ0ICsgaiArIDE7CiAgICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgZmluYWxQb3NpdGlvbnMsCiAgICAgICAgICAgIG91dHNpZGVQb2ludCwKICAgICAgICAgICAgZnJvbnQKICAgICAgICAgICk7CiAgICAgICAgICBmcm9udCArPSAzOwogICAgICAgIH0KICAgICAgICB3YWxsSW5kaWNlcy5wdXNoKHN0YXJ0ICsgTWF0aC5mbG9vcihyLmxlbmd0aCAvIDYpKTsKICAgICAgICBpZiAoY29ybmVyVHlwZSA9PT0gQ29ybmVyVHlwZV9kZWZhdWx0LkJFVkVMRUQpIHsKICAgICAgICAgIHdhbGxJbmRpY2VzLnB1c2goZnJvbnQgLyAzIC0gMSk7CiAgICAgICAgfQogICAgICAgIGJhY2sgLT0gMzsKICAgICAgfQogICAgICByaWdodEVkZ2UgPSBwb3NpdGlvbnNbcG9zSW5kZXgrK107CiAgICAgIGxlZnRFZGdlID0gcG9zaXRpb25zW3Bvc0luZGV4KytdOwogICAgICByaWdodEVkZ2Uuc3BsaWNlKDAsIDMpOwogICAgICBsZWZ0RWRnZS5zcGxpY2UobGVmdEVkZ2UubGVuZ3RoIC0gMywgMyk7CiAgICAgIGZpbmFsUG9zaXRpb25zLnNldChyaWdodEVkZ2UsIGZyb250KTsKICAgICAgZmluYWxQb3NpdGlvbnMuc2V0KGxlZnRFZGdlLCBiYWNrIC0gbGVmdEVkZ2UubGVuZ3RoICsgMSk7CiAgICAgIGxlbmd0aCA9IGxlZnRFZGdlLmxlbmd0aCAtIDM7CiAgICAgIGZvciAoaiA9IDA7IGogPCBsZWZ0RWRnZS5sZW5ndGg7IGogKz0gMykgewogICAgICAgIExSID0gZnJvbnQgLyAzOwogICAgICAgIExMID0gTFIgLSAxOwogICAgICAgIFVSID0gKGJhY2sgLSAyKSAvIDM7CiAgICAgICAgVUwgPSBVUiArIDE7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IFVMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVUjsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gTEw7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExSOwogICAgICAgIGZyb250ICs9IDM7CiAgICAgICAgYmFjayAtPSAzOwogICAgICB9CiAgICAgIGZyb250IC09IDM7CiAgICAgIGJhY2sgKz0gMzsKICAgICAgd2FsbEluZGljZXMucHVzaChmcm9udCAvIDMsIChiYWNrIC0gMikgLyAzKTsKICAgIH0KICAgIGlmIChhZGRFbmRQb3NpdGlvbnMpIHsKICAgICAgZnJvbnQgKz0gMzsKICAgICAgYmFjayAtPSAzOwogICAgICBsZWZ0UG9zID0gY2FydGVzaWFuMTM7CiAgICAgIHJpZ2h0UG9zID0gY2FydGVzaWFuMjM7CiAgICAgIGNvbnN0IGxhc3RFbmRQb3NpdGlvbnMgPSBlbmRQb3NpdGlvbnNbMV07CiAgICAgIGZvciAoaSA9IDA7IGkgPCBoYWxmTGVuZ3RoOyBpKyspIHsKICAgICAgICBsZWZ0UG9zID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgIGxhc3RFbmRQb3NpdGlvbnMsCiAgICAgICAgICAoZW5kUG9zaXRpb25MZW5ndGggLSBpIC0gMSkgKiAzLAogICAgICAgICAgbGVmdFBvcwogICAgICAgICk7CiAgICAgICAgcmlnaHRQb3MgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGxhc3RFbmRQb3NpdGlvbnMsIGkgKiAzLCByaWdodFBvcyk7CiAgICAgICAgQ29ycmlkb3JHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5hZGRBdHRyaWJ1dGUoCiAgICAgICAgICBmaW5hbFBvc2l0aW9ucywKICAgICAgICAgIGxlZnRQb3MsCiAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICBiYWNrCiAgICAgICAgKTsKICAgICAgICBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmFkZEF0dHJpYnV0ZShmaW5hbFBvc2l0aW9ucywgcmlnaHRQb3MsIGZyb250KTsKICAgICAgICBMUiA9IGZyb250IC8gMzsKICAgICAgICBMTCA9IExSIC0gMTsKICAgICAgICBVUiA9IChiYWNrIC0gMikgLyAzOwogICAgICAgIFVMID0gVVIgKyAxOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBVTDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gVVI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IExMOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBMUjsKICAgICAgICBmcm9udCArPSAzOwogICAgICAgIGJhY2sgLT0gMzsKICAgICAgfQogICAgICB3YWxsSW5kaWNlcy5wdXNoKGZyb250IC8gMyk7CiAgICB9IGVsc2UgewogICAgICB3YWxsSW5kaWNlcy5wdXNoKGZyb250IC8gMywgKGJhY2sgLSAyKSAvIDMpOwogICAgfQogICAgaW5kaWNlc1tpbmRleCsrXSA9IGZyb250IC8gMzsKICAgIGluZGljZXNbaW5kZXgrK10gPSAoYmFjayAtIDIpIC8gMzsKICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgdmFsdWVzOiBmaW5hbFBvc2l0aW9ucwogICAgfSk7CiAgICByZXR1cm4gewogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzLAogICAgICB3YWxsSW5kaWNlcwogICAgfTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZVBvc2l0aW9uc0V4dHJ1ZGVkMihwYXJhbXMpIHsKICAgIGNvbnN0IGVsbGlwc29pZCA9IHBhcmFtcy5lbGxpcHNvaWQ7CiAgICBjb25zdCBjb21wdXRlZFBvc2l0aW9ucyA9IENvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9ucyhwYXJhbXMpOwogICAgY29uc3QgYXR0ciA9IGNvbWJpbmUzKGNvbXB1dGVkUG9zaXRpb25zLCBwYXJhbXMuY29ybmVyVHlwZSk7CiAgICBjb25zdCB3YWxsSW5kaWNlcyA9IGF0dHIud2FsbEluZGljZXM7CiAgICBjb25zdCBoZWlnaHQgPSBwYXJhbXMuaGVpZ2h0OwogICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBwYXJhbXMuZXh0cnVkZWRIZWlnaHQ7CiAgICBjb25zdCBhdHRyaWJ1dGVzID0gYXR0ci5hdHRyaWJ1dGVzOwogICAgY29uc3QgaW5kaWNlcyA9IGF0dHIuaW5kaWNlczsKICAgIGxldCBwb3NpdGlvbnMgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgbGV0IGV4dHJ1ZGVkUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGgpOwogICAgZXh0cnVkZWRQb3NpdGlvbnMuc2V0KHBvc2l0aW9ucyk7CiAgICBjb25zdCBuZXdQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KGxlbmd0aCAqIDIpOwogICAgcG9zaXRpb25zID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICBwb3NpdGlvbnMsCiAgICAgIGhlaWdodCwKICAgICAgZWxsaXBzb2lkCiAgICApOwogICAgZXh0cnVkZWRQb3NpdGlvbnMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgIGV4dHJ1ZGVkUG9zaXRpb25zLAogICAgICBleHRydWRlZEhlaWdodCwKICAgICAgZWxsaXBzb2lkCiAgICApOwogICAgbmV3UG9zaXRpb25zLnNldChwb3NpdGlvbnMpOwogICAgbmV3UG9zaXRpb25zLnNldChleHRydWRlZFBvc2l0aW9ucywgbGVuZ3RoKTsKICAgIGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gbmV3UG9zaXRpb25zOwogICAgbGVuZ3RoIC89IDM7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBhcmFtcy5vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgIGxldCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAqIDIpOwogICAgICBpZiAocGFyYW1zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgICBhcHBseU9mZnNldCA9IGFwcGx5T2Zmc2V0LmZpbGwoMSwgMCwgbGVuZ3RoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBhcHBseU9mZnNldFZhbHVlID0gcGFyYW1zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgYXBwbHlPZmZzZXQgPSBhcHBseU9mZnNldC5maWxsKGFwcGx5T2Zmc2V0VmFsdWUpOwogICAgICB9CiAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgfSk7CiAgICB9CiAgICBsZXQgaTsKICAgIGNvbnN0IGlMZW5ndGggPSBpbmRpY2VzLmxlbmd0aDsKICAgIGNvbnN0IG5ld0luZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgbmV3UG9zaXRpb25zLmxlbmd0aCAvIDMsCiAgICAgIChpTGVuZ3RoICsgd2FsbEluZGljZXMubGVuZ3RoKSAqIDIKICAgICk7CiAgICBuZXdJbmRpY2VzLnNldChpbmRpY2VzKTsKICAgIGxldCBpbmRleCA9IGlMZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgaUxlbmd0aDsgaSArPSAyKSB7CiAgICAgIGNvbnN0IHYwMiA9IGluZGljZXNbaV07CiAgICAgIGNvbnN0IHYxMiA9IGluZGljZXNbaSArIDFdOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gdjAyICsgbGVuZ3RoOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gdjEyICsgbGVuZ3RoOwogICAgfQogICAgbGV0IFVMLCBMTDsKICAgIGZvciAoaSA9IDA7IGkgPCB3YWxsSW5kaWNlcy5sZW5ndGg7IGkrKykgewogICAgICBVTCA9IHdhbGxJbmRpY2VzW2ldOwogICAgICBMTCA9IFVMICsgbGVuZ3RoOwogICAgICBuZXdJbmRpY2VzW2luZGV4KytdID0gVUw7CiAgICAgIG5ld0luZGljZXNbaW5kZXgrK10gPSBMTDsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXM6IG5ld0luZGljZXMKICAgIH07CiAgfQogIGZ1bmN0aW9uIENvcnJpZG9yT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb3NpdGlvbnM7CiAgICBjb25zdCB3aWR0aCA9IG9wdGlvbnMud2lkdGg7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMucG9zaXRpb25zIiwgcG9zaXRpb25zKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigib3B0aW9ucy53aWR0aCIsIHdpZHRoKTsKICAgIGNvbnN0IGhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0LCAwKTsKICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5leHRydWRlZEhlaWdodCwgaGVpZ2h0KTsKICAgIHRoaXMuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpCiAgICApOwogICAgdGhpcy5fd2lkdGggPSB3aWR0aDsKICAgIHRoaXMuX2hlaWdodCA9IE1hdGgubWF4KGhlaWdodCwgZXh0cnVkZWRIZWlnaHQpOwogICAgdGhpcy5fZXh0cnVkZWRIZWlnaHQgPSBNYXRoLm1pbihoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgIHRoaXMuX2Nvcm5lclR5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNvcm5lclR5cGUsIENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEKTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkiOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSAxICsgcG9zaXRpb25zLmxlbmd0aCAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyA2OwogIH0KICB2YXIgY2FydGVzaWFuMTMsIGNhcnRlc2lhbjIzLCBjYXJ0ZXNpYW4zMywgc2NyYXRjaEVsbGlwc29pZDUsIHNjcmF0Y2hPcHRpb25zMTAsIENvcnJpZG9yT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvcnJpZG9yT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9hcnJheVJlbW92ZUR1cGxpY2F0ZXMoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfQ29ybmVyVHlwZSgpOwogICAgICBpbml0X0NvcnJpZG9yR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBjYXJ0ZXNpYW4xMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2FydGVzaWFuMjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjMzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBDb3JyaWRvck91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2YWx1ZS5fcG9zaXRpb25zOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3dpZHRoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5faGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9jb3JuZXJUeXBlOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkNSA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxMCA9IHsKICAgICAgICBwb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgICBlbGxpcHNvaWQ6IHNjcmF0Y2hFbGxpcHNvaWQ1LAogICAgICAgIHdpZHRoOiB2b2lkIDAsCiAgICAgICAgaGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IHZvaWQgMCwKICAgICAgICBjb3JuZXJUeXBlOiB2b2lkIDAsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBDb3JyaWRvck91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQ1KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB3aWR0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgY29ybmVyVHlwZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTAucG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMC53aWR0aCA9IHdpZHRoOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEwLmV4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEwLmNvcm5lclR5cGUgPSBjb3JuZXJUeXBlOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMC5ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMC5vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgcmV0dXJuIG5ldyBDb3JyaWRvck91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczEwKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX3dpZHRoID0gd2lkdGg7CiAgICAgICAgcmVzdWx0Ll9oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fY29ybmVyVHlwZSA9IGNvcm5lclR5cGU7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb3JyaWRvck91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5KSB7CiAgICAgICAgbGV0IHBvc2l0aW9ucyA9IGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3Qgd2lkdGggPSBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fd2lkdGg7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBwb3NpdGlvbnMgPSBzY2FsZVRvU3VyZmFjZTMocG9zaXRpb25zLCBlbGxpcHNvaWQpOwogICAgICAgIGNvbnN0IGNsZWFuUG9zaXRpb25zID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbgogICAgICAgICk7CiAgICAgICAgaWYgKGNsZWFuUG9zaXRpb25zLmxlbmd0aCA8IDIgfHwgd2lkdGggPD0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBoZWlnaHQgPSBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5faGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGUgPSAhTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgIDAsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjIKICAgICAgICApOwogICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHBvc2l0aW9uczogY2xlYW5Qb3NpdGlvbnMsCiAgICAgICAgICB3aWR0aCwKICAgICAgICAgIGNvcm5lclR5cGU6IGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9jb3JuZXJUeXBlLAogICAgICAgICAgZ3JhbnVsYXJpdHk6IGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9ncmFudWxhcml0eSwKICAgICAgICAgIHNhdmVBdHRyaWJ1dGVzOiBmYWxzZQogICAgICAgIH07CiAgICAgICAgbGV0IGF0dHI7CiAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgIHBhcmFtcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgICBwYXJhbXMuZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICAgIHBhcmFtcy5vZmZzZXRBdHRyaWJ1dGUgPSBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgYXR0ciA9IGNvbXB1dGVQb3NpdGlvbnNFeHRydWRlZDIocGFyYW1zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgY29tcHV0ZWRQb3NpdGlvbnMgPSBDb3JyaWRvckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMocGFyYW1zKTsKICAgICAgICAgIGF0dHIgPSBjb21iaW5lMyhjb21wdXRlZFBvc2l0aW9ucywgcGFyYW1zLmNvcm5lclR5cGUpOwogICAgICAgICAgYXR0ci5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgICAgICAgYXR0ci5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGF0dHIuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgICBhdHRyLmF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBhdHRyLmF0dHJpYnV0ZXM7CiAgICAgICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcygKICAgICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLAogICAgICAgICAgdm9pZCAwLAogICAgICAgICAgMwogICAgICAgICk7CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBhdHRyLmluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBDb3JyaWRvck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5KGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBjb3JyaWRvck91dGxpbmVHZW9tZXRyeSA9IENvcnJpZG9yT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgIGNvcnJpZG9yT3V0bGluZUdlb21ldHJ5LAogICAgICAgIG9mZnNldAogICAgICApOwogICAgfQogICAgY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBjb3JyaWRvck91dGxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkCiAgICApOwogICAgcmV0dXJuIENvcnJpZG9yT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoY29ycmlkb3JPdXRsaW5lR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0NvcnJpZG9yT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBjcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DeWxpbmRlckdlb21ldHJ5TGlicmFyeS5qcwogIHZhciBDeWxpbmRlckdlb21ldHJ5TGlicmFyeSwgQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdDsKICB2YXIgaW5pdF9DeWxpbmRlckdlb21ldHJ5TGlicmFyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnkuanMiKCkgewogICAgICBpbml0X01hdGgoKTsKICAgICAgQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnkgPSB7fTsKICAgICAgQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnkuY29tcHV0ZVBvc2l0aW9ucyA9IGZ1bmN0aW9uKGxlbmd0aCwgdG9wUmFkaXVzLCBib3R0b21SYWRpdXMsIHNsaWNlcywgZmlsbCkgewogICAgICAgIGNvbnN0IHRvcFogPSBsZW5ndGggKiAwLjU7CiAgICAgICAgY29uc3QgYm90dG9tWiA9IC10b3BaOwogICAgICAgIGNvbnN0IHR3b1NsaWNlID0gc2xpY2VzICsgc2xpY2VzOwogICAgICAgIGNvbnN0IHNpemUgPSBmaWxsID8gMiAqIHR3b1NsaWNlIDogdHdvU2xpY2U7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplICogMyk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICBsZXQgdGJJbmRleCA9IDA7CiAgICAgICAgY29uc3QgYm90dG9tT2Zmc2V0ID0gZmlsbCA/IHR3b1NsaWNlICogMyA6IDA7CiAgICAgICAgY29uc3QgdG9wT2Zmc2V0ID0gZmlsbCA/ICh0d29TbGljZSArIHNsaWNlcykgKiAzIDogc2xpY2VzICogMzsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VzOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGFuZ2xlID0gaSAvIHNsaWNlcyAqIE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICBjb25zdCB4ID0gTWF0aC5jb3MoYW5nbGUpOwogICAgICAgICAgY29uc3QgeSA9IE1hdGguc2luKGFuZ2xlKTsKICAgICAgICAgIGNvbnN0IGJvdHRvbVggPSB4ICogYm90dG9tUmFkaXVzOwogICAgICAgICAgY29uc3QgYm90dG9tWSA9IHkgKiBib3R0b21SYWRpdXM7CiAgICAgICAgICBjb25zdCB0b3BYID0geCAqIHRvcFJhZGl1czsKICAgICAgICAgIGNvbnN0IHRvcFkgPSB5ICogdG9wUmFkaXVzOwogICAgICAgICAgcG9zaXRpb25zW3RiSW5kZXggKyBib3R0b21PZmZzZXRdID0gYm90dG9tWDsKICAgICAgICAgIHBvc2l0aW9uc1t0YkluZGV4ICsgYm90dG9tT2Zmc2V0ICsgMV0gPSBib3R0b21ZOwogICAgICAgICAgcG9zaXRpb25zW3RiSW5kZXggKyBib3R0b21PZmZzZXQgKyAyXSA9IGJvdHRvbVo7CiAgICAgICAgICBwb3NpdGlvbnNbdGJJbmRleCArIHRvcE9mZnNldF0gPSB0b3BYOwogICAgICAgICAgcG9zaXRpb25zW3RiSW5kZXggKyB0b3BPZmZzZXQgKyAxXSA9IHRvcFk7CiAgICAgICAgICBwb3NpdGlvbnNbdGJJbmRleCArIHRvcE9mZnNldCArIDJdID0gdG9wWjsKICAgICAgICAgIHRiSW5kZXggKz0gMzsKICAgICAgICAgIGlmIChmaWxsKSB7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IGJvdHRvbVg7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IGJvdHRvbVk7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IGJvdHRvbVo7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHRvcFg7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHRvcFk7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHRvcFo7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBwb3NpdGlvbnM7CiAgICAgIH07CiAgICAgIEN5bGluZGVyR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQgPSBDeWxpbmRlckdlb21ldHJ5TGlicmFyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0N5bGluZGVyR2VvbWV0cnkuanMKICBmdW5jdGlvbiBDeWxpbmRlckdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgbGVuZ3RoID0gb3B0aW9ucy5sZW5ndGg7CiAgICBjb25zdCB0b3BSYWRpdXMgPSBvcHRpb25zLnRvcFJhZGl1czsKICAgIGNvbnN0IGJvdHRvbVJhZGl1cyA9IG9wdGlvbnMuYm90dG9tUmFkaXVzOwogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy52ZXJ0ZXhGb3JtYXQsIFZlcnRleEZvcm1hdF9kZWZhdWx0LkRFRkFVTFQpOwogICAgY29uc3Qgc2xpY2VzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zbGljZXMsIDEyOCk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChsZW5ndGgpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLmxlbmd0aCBtdXN0IGJlIGRlZmluZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0b3BSYWRpdXMpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnRvcFJhZGl1cyBtdXN0IGJlIGRlZmluZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3R0b21SYWRpdXMpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLmJvdHRvbVJhZGl1cyBtdXN0IGJlIGRlZmluZWQuIik7CiAgICB9CiAgICBpZiAoc2xpY2VzIDwgMykgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5zbGljZXMgbXVzdCBiZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gMy4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlKSAmJiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5UT1ApIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIkdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlLlRPUCBpcyBub3QgYSBzdXBwb3J0ZWQgb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgZm9yIHRoaXMgZ2VvbWV0cnkuIgogICAgICApOwogICAgfQogICAgdGhpcy5fbGVuZ3RoID0gbGVuZ3RoOwogICAgdGhpcy5fdG9wUmFkaXVzID0gdG9wUmFkaXVzOwogICAgdGhpcy5fYm90dG9tUmFkaXVzID0gYm90dG9tUmFkaXVzOwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0KTsKICAgIHRoaXMuX3NsaWNlcyA9IHNsaWNlczsKICAgIHRoaXMuX29mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVDeWxpbmRlckdlb21ldHJ5IjsKICB9CiAgdmFyIHJhZGl1c1NjcmF0Y2gsIG5vcm1hbFNjcmF0Y2gzLCBiaXRhbmdlbnRTY3JhdGNoLCB0YW5nZW50U2NyYXRjaCwgcG9zaXRpb25TY3JhdGNoLCBzY3JhdGNoVmVydGV4Rm9ybWF0NSwgc2NyYXRjaE9wdGlvbnMxMSwgdW5pdEN5bGluZGVyR2VvbWV0cnksIEN5bGluZGVyR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9DeWxpbmRlckdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DeWxpbmRlckdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9DeWxpbmRlckdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICByYWRpdXNTY3JhdGNoID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBub3JtYWxTY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYml0YW5nZW50U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdGFuZ2VudFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHBvc2l0aW9uU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgQ3lsaW5kZXJHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyA1OwogICAgICBDeWxpbmRlckdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9sZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl90b3BSYWRpdXM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ib3R0b21SYWRpdXM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zbGljZXM7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCh2YWx1ZS5fb2Zmc2V0QXR0cmlidXRlLCAtMSk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0NSA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczExID0gewogICAgICAgIHZlcnRleEZvcm1hdDogc2NyYXRjaFZlcnRleEZvcm1hdDUsCiAgICAgICAgbGVuZ3RoOiB2b2lkIDAsCiAgICAgICAgdG9wUmFkaXVzOiB2b2lkIDAsCiAgICAgICAgYm90dG9tUmFkaXVzOiB2b2lkIDAsCiAgICAgICAgc2xpY2VzOiB2b2lkIDAsCiAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiB2b2lkIDAKICAgICAgfTsKICAgICAgQ3lsaW5kZXJHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ1CiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHRvcFJhZGl1cyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgYm90dG9tUmFkaXVzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzbGljZXMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTEubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMS50b3BSYWRpdXMgPSB0b3BSYWRpdXM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczExLmJvdHRvbVJhZGl1cyA9IGJvdHRvbVJhZGl1czsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTEuc2xpY2VzID0gc2xpY2VzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMS5vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgcmV0dXJuIG5ldyBDeWxpbmRlckdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMTEpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCwgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQpOwogICAgICAgIHJlc3VsdC5fbGVuZ3RoID0gbGVuZ3RoOwogICAgICAgIHJlc3VsdC5fdG9wUmFkaXVzID0gdG9wUmFkaXVzOwogICAgICAgIHJlc3VsdC5fYm90dG9tUmFkaXVzID0gYm90dG9tUmFkaXVzOwogICAgICAgIHJlc3VsdC5fc2xpY2VzID0gc2xpY2VzOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDeWxpbmRlckdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oY3lsaW5kZXJHZW9tZXRyeSkgewogICAgICAgIGxldCBsZW5ndGggPSBjeWxpbmRlckdlb21ldHJ5Ll9sZW5ndGg7CiAgICAgICAgY29uc3QgdG9wUmFkaXVzID0gY3lsaW5kZXJHZW9tZXRyeS5fdG9wUmFkaXVzOwogICAgICAgIGNvbnN0IGJvdHRvbVJhZGl1cyA9IGN5bGluZGVyR2VvbWV0cnkuX2JvdHRvbVJhZGl1czsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBjeWxpbmRlckdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQ7CiAgICAgICAgY29uc3Qgc2xpY2VzID0gY3lsaW5kZXJHZW9tZXRyeS5fc2xpY2VzOwogICAgICAgIGlmIChsZW5ndGggPD0gMCB8fCB0b3BSYWRpdXMgPCAwIHx8IGJvdHRvbVJhZGl1cyA8IDAgfHwgdG9wUmFkaXVzID09PSAwICYmIGJvdHRvbVJhZGl1cyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB0d29TbGljZXMgPSBzbGljZXMgKyBzbGljZXM7CiAgICAgICAgY29uc3QgdGhyZWVTbGljZXMgPSBzbGljZXMgKyB0d29TbGljZXM7CiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSB0d29TbGljZXMgKyB0d29TbGljZXM7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gQ3lsaW5kZXJHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKAogICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgdG9wUmFkaXVzLAogICAgICAgICAgYm90dG9tUmFkaXVzLAogICAgICAgICAgc2xpY2VzLAogICAgICAgICAgdHJ1ZQogICAgICAgICk7CiAgICAgICAgY29uc3Qgc3QgPSB2ZXJ0ZXhGb3JtYXQuc3QgPyBuZXcgRmxvYXQzMkFycmF5KG51bVZlcnRpY2VzICogMikgOiB2b2lkIDA7CiAgICAgICAgY29uc3Qgbm9ybWFscyA9IHZlcnRleEZvcm1hdC5ub3JtYWwgPyBuZXcgRmxvYXQzMkFycmF5KG51bVZlcnRpY2VzICogMykgOiB2b2lkIDA7CiAgICAgICAgY29uc3QgdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkobnVtVmVydGljZXMgKiAzKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkobnVtVmVydGljZXMgKiAzKSA6IHZvaWQgMDsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBjb21wdXRlTm9ybWFsID0gdmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50OwogICAgICAgIGlmIChjb21wdXRlTm9ybWFsKSB7CiAgICAgICAgICBjb25zdCBjb21wdXRlVGFuZ2VudCA9IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQ7CiAgICAgICAgICBsZXQgbm9ybWFsSW5kZXggPSAwOwogICAgICAgICAgbGV0IHRhbmdlbnRJbmRleCA9IDA7CiAgICAgICAgICBsZXQgYml0YW5nZW50SW5kZXggPSAwOwogICAgICAgICAgY29uc3QgdGhldGEgPSBNYXRoLmF0YW4yKGJvdHRvbVJhZGl1cyAtIHRvcFJhZGl1cywgbGVuZ3RoKTsKICAgICAgICAgIGNvbnN0IG5vcm1hbDIgPSBub3JtYWxTY3JhdGNoMzsKICAgICAgICAgIG5vcm1hbDIueiA9IE1hdGguc2luKHRoZXRhKTsKICAgICAgICAgIGNvbnN0IG5vcm1hbFNjYWxlMiA9IE1hdGguY29zKHRoZXRhKTsKICAgICAgICAgIGxldCB0YW5nZW50ID0gdGFuZ2VudFNjcmF0Y2g7CiAgICAgICAgICBsZXQgYml0YW5nZW50ID0gYml0YW5nZW50U2NyYXRjaDsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZXM7IGkrKykgewogICAgICAgICAgICBjb25zdCBhbmdsZSA9IGkgLyBzbGljZXMgKiBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgICBjb25zdCB4ID0gbm9ybWFsU2NhbGUyICogTWF0aC5jb3MoYW5nbGUpOwogICAgICAgICAgICBjb25zdCB5ID0gbm9ybWFsU2NhbGUyICogTWF0aC5zaW4oYW5nbGUpOwogICAgICAgICAgICBpZiAoY29tcHV0ZU5vcm1hbCkgewogICAgICAgICAgICAgIG5vcm1hbDIueCA9IHg7CiAgICAgICAgICAgICAgbm9ybWFsMi55ID0geTsKICAgICAgICAgICAgICBpZiAoY29tcHV0ZVRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIHRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwgbm9ybWFsMiwgdGFuZ2VudCksCiAgICAgICAgICAgICAgICAgIHRhbmdlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi54OwogICAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueTsKICAgICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi54OwogICAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueTsKICAgICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC55OwogICAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC56OwogICAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC55OwogICAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC56OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICAgICAgYml0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIHRhbmdlbnQsIGJpdGFuZ2VudCksCiAgICAgICAgICAgICAgICAgIGJpdGFuZ2VudAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueDsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueTsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueDsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueTsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZXM7IGkrKykgewogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSAwOwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSAwOwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSAtMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSAxOwogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IDA7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSAwOwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSAtMTsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsaWNlczsgaSsrKSB7CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IDA7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IDA7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gMTsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSAwOwogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gMDsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gMTsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBudW1JbmRpY2VzID0gMTIgKiBzbGljZXMgLSAxMjsKICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtVmVydGljZXMsIG51bUluZGljZXMpOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgbGV0IGogPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzbGljZXMgLSAxOyBpKyspIHsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyAyOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyAzOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGo7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaiArIDM7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaiArIDE7CiAgICAgICAgICBqICs9IDI7CiAgICAgICAgfQogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0d29TbGljZXMgLSAyOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSAwOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSAxOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0d29TbGljZXMgLSAyOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSAxOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0d29TbGljZXMgLSAxOwogICAgICAgIGZvciAoaSA9IDE7IGkgPCBzbGljZXMgLSAxOyBpKyspIHsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0d29TbGljZXMgKyBpICsgMTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0d29TbGljZXMgKyBpOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHR3b1NsaWNlczsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMTsgaSA8IHNsaWNlcyAtIDE7IGkrKykgewogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRocmVlU2xpY2VzOwogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRocmVlU2xpY2VzICsgaTsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0aHJlZVNsaWNlcyArIGkgKyAxOwogICAgICAgIH0KICAgICAgICBsZXQgdGV4dHVyZUNvb3JkSW5kZXggPSAwOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIGNvbnN0IHJhZCA9IE1hdGgubWF4KHRvcFJhZGl1cywgYm90dG9tUmFkaXVzKTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGkgKiAzLCBwb3NpdGlvblNjcmF0Y2gpOwogICAgICAgICAgICBzdFt0ZXh0dXJlQ29vcmRJbmRleCsrXSA9IChwb3NpdGlvbi54ICsgcmFkKSAvICgyICogcmFkKTsKICAgICAgICAgICAgc3RbdGV4dHVyZUNvb3JkSW5kZXgrK10gPSAocG9zaXRpb24ueSArIHJhZCkgLyAoMiAqIHJhZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiBub3JtYWxzCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLnRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHRhbmdlbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGF0dHJpYnV0ZXMuYml0YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiBiaXRhbmdlbnRzCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgICAgIHZhbHVlczogc3QKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByYWRpdXNTY3JhdGNoLnggPSBsZW5ndGggKiAwLjU7CiAgICAgICAgcmFkaXVzU2NyYXRjaC55ID0gTWF0aC5tYXgoYm90dG9tUmFkaXVzLCB0b3BSYWRpdXMpOwogICAgICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdC5tYWduaXR1ZGUocmFkaXVzU2NyYXRjaCkKICAgICAgICApOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY3lsaW5kZXJHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gY3lsaW5kZXJHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LlRSSUFOR0xFUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBjeWxpbmRlckdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgQ3lsaW5kZXJHZW9tZXRyeS5nZXRVbml0Q3lsaW5kZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh1bml0Q3lsaW5kZXJHZW9tZXRyeSkpIHsKICAgICAgICAgIHVuaXRDeWxpbmRlckdlb21ldHJ5ID0gQ3lsaW5kZXJHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSgKICAgICAgICAgICAgbmV3IEN5bGluZGVyR2VvbWV0cnkoewogICAgICAgICAgICAgIHRvcFJhZGl1czogMSwKICAgICAgICAgICAgICBib3R0b21SYWRpdXM6IDEsCiAgICAgICAgICAgICAgbGVuZ3RoOiAxLAogICAgICAgICAgICAgIHZlcnRleEZvcm1hdDogVmVydGV4Rm9ybWF0X2RlZmF1bHQuUE9TSVRJT05fT05MWQogICAgICAgICAgICB9KQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVuaXRDeWxpbmRlckdlb21ldHJ5OwogICAgICB9OwogICAgICBDeWxpbmRlckdlb21ldHJ5X2RlZmF1bHQgPSBDeWxpbmRlckdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVDeWxpbmRlckdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVDeWxpbmRlckdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUN5bGluZGVyR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUN5bGluZGVyR2VvbWV0cnkoY3lsaW5kZXJHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgY3lsaW5kZXJHZW9tZXRyeSA9IEN5bGluZGVyR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soY3lsaW5kZXJHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJldHVybiBDeWxpbmRlckdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoY3lsaW5kZXJHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVDeWxpbmRlckdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ3lsaW5kZXJHZW9tZXRyeSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0N5bGluZGVyT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBsZW5ndGggPSBvcHRpb25zLmxlbmd0aDsKICAgIGNvbnN0IHRvcFJhZGl1cyA9IG9wdGlvbnMudG9wUmFkaXVzOwogICAgY29uc3QgYm90dG9tUmFkaXVzID0gb3B0aW9ucy5ib3R0b21SYWRpdXM7CiAgICBjb25zdCBzbGljZXMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnNsaWNlcywgMTI4KTsKICAgIGNvbnN0IG51bWJlck9mVmVydGljYWxMaW5lcyA9IE1hdGgubWF4KAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm51bWJlck9mVmVydGljYWxMaW5lcywgMTYpLAogICAgICAwCiAgICApOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJvcHRpb25zLnBvc2l0aW9ucyIsIGxlbmd0aCk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIm9wdGlvbnMudG9wUmFkaXVzIiwgdG9wUmFkaXVzKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigib3B0aW9ucy5ib3R0b21SYWRpdXMiLCBib3R0b21SYWRpdXMpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmdyZWF0ZXJUaGFuT3JFcXVhbHMoIm9wdGlvbnMuc2xpY2VzIiwgc2xpY2VzLCAzKTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUpICYmIG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAiR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUuVE9QIGlzIG5vdCBhIHN1cHBvcnRlZCBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSBmb3IgdGhpcyBnZW9tZXRyeS4iCiAgICAgICk7CiAgICB9CiAgICB0aGlzLl9sZW5ndGggPSBsZW5ndGg7CiAgICB0aGlzLl90b3BSYWRpdXMgPSB0b3BSYWRpdXM7CiAgICB0aGlzLl9ib3R0b21SYWRpdXMgPSBib3R0b21SYWRpdXM7CiAgICB0aGlzLl9zbGljZXMgPSBzbGljZXM7CiAgICB0aGlzLl9udW1iZXJPZlZlcnRpY2FsTGluZXMgPSBudW1iZXJPZlZlcnRpY2FsTGluZXM7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkiOwogIH0KICB2YXIgcmFkaXVzU2NyYXRjaDIsIHNjcmF0Y2hPcHRpb25zMTIsIEN5bGluZGVyT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0N5bGluZGVyT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X0N5bGluZGVyR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgcmFkaXVzU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIEN5bGluZGVyT3V0bGluZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IDY7CiAgICAgIEN5bGluZGVyT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fdG9wUmFkaXVzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fYm90dG9tUmFkaXVzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc2xpY2VzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbnVtYmVyT2ZWZXJ0aWNhbExpbmVzOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaE9wdGlvbnMxMiA9IHsKICAgICAgICBsZW5ndGg6IHZvaWQgMCwKICAgICAgICB0b3BSYWRpdXM6IHZvaWQgMCwKICAgICAgICBib3R0b21SYWRpdXM6IHZvaWQgMCwKICAgICAgICBzbGljZXM6IHZvaWQgMCwKICAgICAgICBudW1iZXJPZlZlcnRpY2FsTGluZXM6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBDeWxpbmRlck91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCB0b3BSYWRpdXMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGJvdHRvbVJhZGl1cyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc2xpY2VzID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBudW1iZXJPZlZlcnRpY2FsTGluZXMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTIubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMi50b3BSYWRpdXMgPSB0b3BSYWRpdXM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEyLmJvdHRvbVJhZGl1cyA9IGJvdHRvbVJhZGl1czsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTIuc2xpY2VzID0gc2xpY2VzOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMi5udW1iZXJPZlZlcnRpY2FsTGluZXMgPSBudW1iZXJPZlZlcnRpY2FsTGluZXM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEyLm9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICByZXR1cm4gbmV3IEN5bGluZGVyT3V0bGluZUdlb21ldHJ5KHNjcmF0Y2hPcHRpb25zMTIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX2xlbmd0aCA9IGxlbmd0aDsKICAgICAgICByZXN1bHQuX3RvcFJhZGl1cyA9IHRvcFJhZGl1czsKICAgICAgICByZXN1bHQuX2JvdHRvbVJhZGl1cyA9IGJvdHRvbVJhZGl1czsKICAgICAgICByZXN1bHQuX3NsaWNlcyA9IHNsaWNlczsKICAgICAgICByZXN1bHQuX251bWJlck9mVmVydGljYWxMaW5lcyA9IG51bWJlck9mVmVydGljYWxMaW5lczsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihjeWxpbmRlckdlb21ldHJ5KSB7CiAgICAgICAgbGV0IGxlbmd0aCA9IGN5bGluZGVyR2VvbWV0cnkuX2xlbmd0aDsKICAgICAgICBjb25zdCB0b3BSYWRpdXMgPSBjeWxpbmRlckdlb21ldHJ5Ll90b3BSYWRpdXM7CiAgICAgICAgY29uc3QgYm90dG9tUmFkaXVzID0gY3lsaW5kZXJHZW9tZXRyeS5fYm90dG9tUmFkaXVzOwogICAgICAgIGNvbnN0IHNsaWNlcyA9IGN5bGluZGVyR2VvbWV0cnkuX3NsaWNlczsKICAgICAgICBjb25zdCBudW1iZXJPZlZlcnRpY2FsTGluZXMgPSBjeWxpbmRlckdlb21ldHJ5Ll9udW1iZXJPZlZlcnRpY2FsTGluZXM7CiAgICAgICAgaWYgKGxlbmd0aCA8PSAwIHx8IHRvcFJhZGl1cyA8IDAgfHwgYm90dG9tUmFkaXVzIDwgMCB8fCB0b3BSYWRpdXMgPT09IDAgJiYgYm90dG9tUmFkaXVzID09PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IG51bVZlcnRpY2VzID0gc2xpY2VzICogMjsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBDeWxpbmRlckdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMoCiAgICAgICAgICBsZW5ndGgsCiAgICAgICAgICB0b3BSYWRpdXMsCiAgICAgICAgICBib3R0b21SYWRpdXMsCiAgICAgICAgICBzbGljZXMsCiAgICAgICAgICBmYWxzZQogICAgICAgICk7CiAgICAgICAgbGV0IG51bUluZGljZXMgPSBzbGljZXMgKiAyOwogICAgICAgIGxldCBudW1TaWRlOwogICAgICAgIGlmIChudW1iZXJPZlZlcnRpY2FsTGluZXMgPiAwKSB7CiAgICAgICAgICBjb25zdCBudW1TaWRlTGluZXMgPSBNYXRoLm1pbihudW1iZXJPZlZlcnRpY2FsTGluZXMsIHNsaWNlcyk7CiAgICAgICAgICBudW1TaWRlID0gTWF0aC5yb3VuZChzbGljZXMgLyBudW1TaWRlTGluZXMpOwogICAgICAgICAgbnVtSW5kaWNlcyArPSBudW1TaWRlTGluZXM7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShudW1WZXJ0aWNlcywgbnVtSW5kaWNlcyAqIDIpOwogICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsaWNlcyAtIDE7IGkrKykgewogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIDE7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIHNsaWNlczsKICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgMSArIHNsaWNlczsKICAgICAgICB9CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHNsaWNlcyAtIDE7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IDA7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHNsaWNlcyArIHNsaWNlcyAtIDE7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHNsaWNlczsKICAgICAgICBpZiAobnVtYmVyT2ZWZXJ0aWNhbExpbmVzID4gMCkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsaWNlczsgaSArPSBudW1TaWRlKSB7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIHNsaWNlczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICB9KTsKICAgICAgICByYWRpdXNTY3JhdGNoMi54ID0gbGVuZ3RoICogMC41OwogICAgICAgIHJhZGl1c1NjcmF0Y2gyLnkgPSBNYXRoLm1heChib3R0b21SYWRpdXMsIHRvcFJhZGl1cyk7CiAgICAgICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0Lm1hZ25pdHVkZShyYWRpdXNTY3JhdGNoMikKICAgICAgICApOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY3lsaW5kZXJHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gY3lsaW5kZXJHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgIGNvbnN0IGFwcGx5T2Zmc2V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoIC8gMykuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgICAgICBhdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IGN5bGluZGVyR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBDeWxpbmRlck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5KGN5bGluZGVyR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGN5bGluZGVyR2VvbWV0cnkgPSBDeWxpbmRlck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhjeWxpbmRlckdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIEN5bGluZGVyT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoY3lsaW5kZXJHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUVsbGlwc2VHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVFbGxpcHNlR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUVsbGlwc2VHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUVsbGlwc2VHZW9tZXRyeShlbGxpcHNlR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGVsbGlwc2VHZW9tZXRyeSA9IEVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhlbGxpcHNlR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICBlbGxpcHNlR2VvbWV0cnkuX2NlbnRlciA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbGxpcHNlR2VvbWV0cnkuX2NlbnRlcik7CiAgICBlbGxpcHNlR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkKTsKICAgIHJldHVybiBFbGxpcHNlR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShlbGxpcHNlR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlRWxsaXBzZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlRWxsaXBzZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVFbGxpcHNlR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzZUdlb21ldHJ5KCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGNyZWF0ZUVsbGlwc2VHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlRWxsaXBzZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnkoZWxsaXBzZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBlbGxpcHNlR2VvbWV0cnkgPSBFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGVsbGlwc2VHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGVsbGlwc2VHZW9tZXRyeS5fY2VudGVyKTsKICAgIGVsbGlwc2VHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzZUdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmV0dXJuIEVsbGlwc2VPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShlbGxpcHNlR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkR2VvbWV0cnkuanMKICBmdW5jdGlvbiBFbGxpcHNvaWRHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHJhZGlpID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yYWRpaSwgZGVmYXVsdFJhZGlpKTsKICAgIGNvbnN0IGlubmVyUmFkaWkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmlubmVyUmFkaWksIHJhZGlpKTsKICAgIGNvbnN0IG1pbmltdW1DbG9jayA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWluaW11bUNsb2NrLCAwKTsKICAgIGNvbnN0IG1heGltdW1DbG9jayA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWF4aW11bUNsb2NrLCBNYXRoX2RlZmF1bHQuVFdPX1BJKTsKICAgIGNvbnN0IG1pbmltdW1Db25lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5taW5pbXVtQ29uZSwgMCk7CiAgICBjb25zdCBtYXhpbXVtQ29uZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWF4aW11bUNvbmUsIE1hdGhfZGVmYXVsdC5QSSk7CiAgICBjb25zdCBzdGFja1BhcnRpdGlvbnMgPSBNYXRoLnJvdW5kKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc3RhY2tQYXJ0aXRpb25zLCA2NCkpOwogICAgY29uc3Qgc2xpY2VQYXJ0aXRpb25zID0gTWF0aC5yb3VuZChkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnNsaWNlUGFydGl0aW9ucywgNjQpKTsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKTsKICAgIGlmIChzbGljZVBhcnRpdGlvbnMgPCAzKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcHRpb25zLnNsaWNlUGFydGl0aW9ucyBjYW5ub3QgYmUgbGVzcyB0aGFuIHRocmVlLiIKICAgICAgKTsKICAgIH0KICAgIGlmIChzdGFja1BhcnRpdGlvbnMgPCAzKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcHRpb25zLnN0YWNrUGFydGl0aW9ucyBjYW5ub3QgYmUgbGVzcyB0aGFuIHRocmVlLiIKICAgICAgKTsKICAgIH0KICAgIHRoaXMuX3JhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHJhZGlpKTsKICAgIHRoaXMuX2lubmVyUmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoaW5uZXJSYWRpaSk7CiAgICB0aGlzLl9taW5pbXVtQ2xvY2sgPSBtaW5pbXVtQ2xvY2s7CiAgICB0aGlzLl9tYXhpbXVtQ2xvY2sgPSBtYXhpbXVtQ2xvY2s7CiAgICB0aGlzLl9taW5pbXVtQ29uZSA9IG1pbmltdW1Db25lOwogICAgdGhpcy5fbWF4aW11bUNvbmUgPSBtYXhpbXVtQ29uZTsKICAgIHRoaXMuX3N0YWNrUGFydGl0aW9ucyA9IHN0YWNrUGFydGl0aW9uczsKICAgIHRoaXMuX3NsaWNlUGFydGl0aW9ucyA9IHNsaWNlUGFydGl0aW9uczsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCk7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnkiOwogIH0KICB2YXIgc2NyYXRjaFBvc2l0aW9uMiwgc2NyYXRjaE5vcm1hbDUsIHNjcmF0Y2hUYW5nZW50Mywgc2NyYXRjaEJpdGFuZ2VudDMsIHNjcmF0Y2hOb3JtYWxTVCwgZGVmYXVsdFJhZGlpLCBjb3MsIHNpbiwgc2NyYXRjaFJhZGlpLCBzY3JhdGNoSW5uZXJSYWRpaSwgc2NyYXRjaFZlcnRleEZvcm1hdDYsIHNjcmF0Y2hPcHRpb25zMTMsIHVuaXRFbGxpcHNvaWRHZW9tZXRyeSwgRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9FbGxpcHNvaWRHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRWxsaXBzb2lkR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBzY3JhdGNoUG9zaXRpb24yID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTm9ybWFsNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFRhbmdlbnQzID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQml0YW5nZW50MyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5vcm1hbFNUID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBkZWZhdWx0UmFkaWkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KDEsIDEsIDEpOwogICAgICBjb3MgPSBNYXRoLmNvczsKICAgICAgc2luID0gTWF0aC5zaW47CiAgICAgIEVsbGlwc29pZEdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgNzsKICAgICAgRWxsaXBzb2lkR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5fcmFkaWksIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX2lubmVyUmFkaWksIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9taW5pbXVtQ2xvY2s7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9tYXhpbXVtQ2xvY2s7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9taW5pbXVtQ29uZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX21heGltdW1Db25lOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc3RhY2tQYXJ0aXRpb25zOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fc2xpY2VQYXJ0aXRpb25zOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaFJhZGlpID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoSW5uZXJSYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDYgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxMyA9IHsKICAgICAgICByYWRpaTogc2NyYXRjaFJhZGlpLAogICAgICAgIGlubmVyUmFkaWk6IHNjcmF0Y2hJbm5lclJhZGlpLAogICAgICAgIHZlcnRleEZvcm1hdDogc2NyYXRjaFZlcnRleEZvcm1hdDYsCiAgICAgICAgbWluaW11bUNsb2NrOiB2b2lkIDAsCiAgICAgICAgbWF4aW11bUNsb2NrOiB2b2lkIDAsCiAgICAgICAgbWluaW11bUNvbmU6IHZvaWQgMCwKICAgICAgICBtYXhpbXVtQ29uZTogdm9pZCAwLAogICAgICAgIHN0YWNrUGFydGl0aW9uczogdm9pZCAwLAogICAgICAgIHNsaWNlUGFydGl0aW9uczogdm9pZCAwLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIEVsbGlwc29pZEdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoUmFkaWkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBpbm5lclJhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaElubmVyUmFkaWkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0NgogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgbWluaW11bUNsb2NrID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBtYXhpbXVtQ2xvY2sgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG1pbmltdW1Db25lID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBtYXhpbXVtQ29uZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc3RhY2tQYXJ0aXRpb25zID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzbGljZVBhcnRpdGlvbnMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTMubWluaW11bUNsb2NrID0gbWluaW11bUNsb2NrOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMy5tYXhpbXVtQ2xvY2sgPSBtYXhpbXVtQ2xvY2s7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEzLm1pbmltdW1Db25lID0gbWluaW11bUNvbmU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEzLm1heGltdW1Db25lID0gbWF4aW11bUNvbmU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczEzLnN0YWNrUGFydGl0aW9ucyA9IHN0YWNrUGFydGl0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTMuc2xpY2VQYXJ0aXRpb25zID0gc2xpY2VQYXJ0aXRpb25zOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxMy5vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgcmV0dXJuIG5ldyBFbGxpcHNvaWRHZW9tZXRyeShzY3JhdGNoT3B0aW9uczEzKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9yYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShyYWRpaSwgcmVzdWx0Ll9yYWRpaSk7CiAgICAgICAgcmVzdWx0Ll9pbm5lclJhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGlubmVyUmFkaWksIHJlc3VsdC5faW5uZXJSYWRpaSk7CiAgICAgICAgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQsIHJlc3VsdC5fdmVydGV4Rm9ybWF0KTsKICAgICAgICByZXN1bHQuX21pbmltdW1DbG9jayA9IG1pbmltdW1DbG9jazsKICAgICAgICByZXN1bHQuX21heGltdW1DbG9jayA9IG1heGltdW1DbG9jazsKICAgICAgICByZXN1bHQuX21pbmltdW1Db25lID0gbWluaW11bUNvbmU7CiAgICAgICAgcmVzdWx0Ll9tYXhpbXVtQ29uZSA9IG1heGltdW1Db25lOwogICAgICAgIHJlc3VsdC5fc3RhY2tQYXJ0aXRpb25zID0gc3RhY2tQYXJ0aXRpb25zOwogICAgICAgIHJlc3VsdC5fc2xpY2VQYXJ0aXRpb25zID0gc2xpY2VQYXJ0aXRpb25zOwogICAgICAgIHJlc3VsdC5fb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBFbGxpcHNvaWRHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGVsbGlwc29pZEdlb21ldHJ5KSB7CiAgICAgICAgY29uc3QgcmFkaWkgPSBlbGxpcHNvaWRHZW9tZXRyeS5fcmFkaWk7CiAgICAgICAgaWYgKHJhZGlpLnggPD0gMCB8fCByYWRpaS55IDw9IDAgfHwgcmFkaWkueiA8PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGlubmVyUmFkaWkgPSBlbGxpcHNvaWRHZW9tZXRyeS5faW5uZXJSYWRpaTsKICAgICAgICBpZiAoaW5uZXJSYWRpaS54IDw9IDAgfHwgaW5uZXJSYWRpaS55IDw9IDAgfHwgaW5uZXJSYWRpaS56IDw9IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWluaW11bUNsb2NrID0gZWxsaXBzb2lkR2VvbWV0cnkuX21pbmltdW1DbG9jazsKICAgICAgICBjb25zdCBtYXhpbXVtQ2xvY2sgPSBlbGxpcHNvaWRHZW9tZXRyeS5fbWF4aW11bUNsb2NrOwogICAgICAgIGNvbnN0IG1pbmltdW1Db25lID0gZWxsaXBzb2lkR2VvbWV0cnkuX21pbmltdW1Db25lOwogICAgICAgIGNvbnN0IG1heGltdW1Db25lID0gZWxsaXBzb2lkR2VvbWV0cnkuX21heGltdW1Db25lOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGVsbGlwc29pZEdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQ7CiAgICAgICAgbGV0IHNsaWNlUGFydGl0aW9ucyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9zbGljZVBhcnRpdGlvbnMgKyAxOwogICAgICAgIGxldCBzdGFja1BhcnRpdGlvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc3RhY2tQYXJ0aXRpb25zICsgMTsKICAgICAgICBzbGljZVBhcnRpdGlvbnMgPSBNYXRoLnJvdW5kKAogICAgICAgICAgc2xpY2VQYXJ0aXRpb25zICogTWF0aC5hYnMobWF4aW11bUNsb2NrIC0gbWluaW11bUNsb2NrKSAvIE1hdGhfZGVmYXVsdC5UV09fUEkKICAgICAgICApOwogICAgICAgIHN0YWNrUGFydGl0aW9ucyA9IE1hdGgucm91bmQoCiAgICAgICAgICBzdGFja1BhcnRpdGlvbnMgKiBNYXRoLmFicyhtYXhpbXVtQ29uZSAtIG1pbmltdW1Db25lKSAvIE1hdGhfZGVmYXVsdC5QSQogICAgICAgICk7CiAgICAgICAgaWYgKHNsaWNlUGFydGl0aW9ucyA8IDIpIHsKICAgICAgICAgIHNsaWNlUGFydGl0aW9ucyA9IDI7CiAgICAgICAgfQogICAgICAgIGlmIChzdGFja1BhcnRpdGlvbnMgPCAyKSB7CiAgICAgICAgICBzdGFja1BhcnRpdGlvbnMgPSAyOwogICAgICAgIH0KICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgajsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGNvbnN0IHBoaXMgPSBbbWluaW11bUNvbmVdOwogICAgICAgIGNvbnN0IHRoZXRhcyA9IFttaW5pbXVtQ2xvY2tdOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzdGFja1BhcnRpdGlvbnM7IGkrKykgewogICAgICAgICAgcGhpcy5wdXNoKAogICAgICAgICAgICBtaW5pbXVtQ29uZSArIGkgKiAobWF4aW11bUNvbmUgLSBtaW5pbXVtQ29uZSkgLyAoc3RhY2tQYXJ0aXRpb25zIC0gMSkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHBoaXMucHVzaChtYXhpbXVtQ29uZSk7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IHNsaWNlUGFydGl0aW9uczsgaisrKSB7CiAgICAgICAgICB0aGV0YXMucHVzaCgKICAgICAgICAgICAgbWluaW11bUNsb2NrICsgaiAqIChtYXhpbXVtQ2xvY2sgLSBtaW5pbXVtQ2xvY2spIC8gKHNsaWNlUGFydGl0aW9ucyAtIDEpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICB0aGV0YXMucHVzaChtYXhpbXVtQ2xvY2spOwogICAgICAgIGNvbnN0IG51bVBoaXMgPSBwaGlzLmxlbmd0aDsKICAgICAgICBjb25zdCBudW1UaGV0YXMgPSB0aGV0YXMubGVuZ3RoOwogICAgICAgIGxldCBleHRyYUluZGljZXMgPSAwOwogICAgICAgIGxldCB2ZXJ0ZXhNdWx0aXBsaWVyID0gMTsKICAgICAgICBjb25zdCBoYXNJbm5lclN1cmZhY2UgPSBpbm5lclJhZGlpLnggIT09IHJhZGlpLnggfHwgaW5uZXJSYWRpaS55ICE9PSByYWRpaS55IHx8IGlubmVyUmFkaWkueiAhPT0gcmFkaWkuejsKICAgICAgICBsZXQgaXNUb3BPcGVuID0gZmFsc2U7CiAgICAgICAgbGV0IGlzQm90T3BlbiA9IGZhbHNlOwogICAgICAgIGxldCBpc0Nsb2NrT3BlbiA9IGZhbHNlOwogICAgICAgIGlmIChoYXNJbm5lclN1cmZhY2UpIHsKICAgICAgICAgIHZlcnRleE11bHRpcGxpZXIgPSAyOwogICAgICAgICAgaWYgKG1pbmltdW1Db25lID4gMCkgewogICAgICAgICAgICBpc1RvcE9wZW4gPSB0cnVlOwogICAgICAgICAgICBleHRyYUluZGljZXMgKz0gc2xpY2VQYXJ0aXRpb25zIC0gMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChtYXhpbXVtQ29uZSA8IE1hdGguUEkpIHsKICAgICAgICAgICAgaXNCb3RPcGVuID0gdHJ1ZTsKICAgICAgICAgICAgZXh0cmFJbmRpY2VzICs9IHNsaWNlUGFydGl0aW9ucyAtIDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoKG1heGltdW1DbG9jayAtIG1pbmltdW1DbG9jaykgJSBNYXRoX2RlZmF1bHQuVFdPX1BJKSB7CiAgICAgICAgICAgIGlzQ2xvY2tPcGVuID0gdHJ1ZTsKICAgICAgICAgICAgZXh0cmFJbmRpY2VzICs9IChzdGFja1BhcnRpdGlvbnMgLSAxKSAqIDIgKyAxOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXh0cmFJbmRpY2VzICs9IDE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZlcnRleENvdW50ID0gbnVtVGhldGFzICogbnVtUGhpcyAqIHZlcnRleE11bHRpcGxpZXI7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSh2ZXJ0ZXhDb3VudCAqIDMpOwogICAgICAgIGNvbnN0IGlzSW5uZXIgPSBuZXcgQXJyYXkodmVydGV4Q291bnQpLmZpbGwoZmFsc2UpOwogICAgICAgIGNvbnN0IG5lZ2F0ZU5vcm1hbCA9IG5ldyBBcnJheSh2ZXJ0ZXhDb3VudCkuZmlsbChmYWxzZSk7CiAgICAgICAgY29uc3QgaW5kZXhDb3VudCA9IHNsaWNlUGFydGl0aW9ucyAqIHN0YWNrUGFydGl0aW9ucyAqIHZlcnRleE11bHRpcGxpZXI7CiAgICAgICAgY29uc3QgbnVtSW5kaWNlcyA9IDYgKiAoaW5kZXhDb3VudCArIGV4dHJhSW5kaWNlcyArIDEgLSAoc2xpY2VQYXJ0aXRpb25zICsgc3RhY2tQYXJ0aXRpb25zKSAqIHZlcnRleE11bHRpcGxpZXIpOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShpbmRleENvdW50LCBudW1JbmRpY2VzKTsKICAgICAgICBjb25zdCBub3JtYWxzID0gdmVydGV4Rm9ybWF0Lm5vcm1hbCA/IG5ldyBGbG9hdDMyQXJyYXkodmVydGV4Q291bnQgKiAzKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheSh2ZXJ0ZXhDb3VudCAqIDMpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheSh2ZXJ0ZXhDb3VudCAqIDMpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IHN0ID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheSh2ZXJ0ZXhDb3VudCAqIDIpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IHNpblBoaSA9IG5ldyBBcnJheShudW1QaGlzKTsKICAgICAgICBjb25zdCBjb3NQaGkgPSBuZXcgQXJyYXkobnVtUGhpcyk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bVBoaXM7IGkrKykgewogICAgICAgICAgc2luUGhpW2ldID0gc2luKHBoaXNbaV0pOwogICAgICAgICAgY29zUGhpW2ldID0gY29zKHBoaXNbaV0pOwogICAgICAgIH0KICAgICAgICBjb25zdCBzaW5UaGV0YSA9IG5ldyBBcnJheShudW1UaGV0YXMpOwogICAgICAgIGNvbnN0IGNvc1RoZXRhID0gbmV3IEFycmF5KG51bVRoZXRhcyk7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IG51bVRoZXRhczsgaisrKSB7CiAgICAgICAgICBjb3NUaGV0YVtqXSA9IGNvcyh0aGV0YXNbal0pOwogICAgICAgICAgc2luVGhldGFbal0gPSBzaW4odGhldGFzW2pdKTsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bVBoaXM7IGkrKykgewogICAgICAgICAgZm9yIChqID0gMDsgaiA8IG51bVRoZXRhczsgaisrKSB7CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHJhZGlpLnggKiBzaW5QaGlbaV0gKiBjb3NUaGV0YVtqXTsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcmFkaWkueSAqIHNpblBoaVtpXSAqIHNpblRoZXRhW2pdOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSByYWRpaS56ICogY29zUGhpW2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZXQgdmVydGV4SW5kZXggPSB2ZXJ0ZXhDb3VudCAvIDI7CiAgICAgICAgaWYgKGhhc0lubmVyU3VyZmFjZSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IG51bVBoaXM7IGkrKykgewogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbnVtVGhldGFzOyBqKyspIHsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnggKiBzaW5QaGlbaV0gKiBjb3NUaGV0YVtqXTsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnkgKiBzaW5QaGlbaV0gKiBzaW5UaGV0YVtqXTsKICAgICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSBpbm5lclJhZGlpLnogKiBjb3NQaGlbaV07CiAgICAgICAgICAgICAgaXNJbm5lclt2ZXJ0ZXhJbmRleF0gPSB0cnVlOwogICAgICAgICAgICAgIGlmIChpID4gMCAmJiBpICE9PSBudW1QaGlzIC0gMSAmJiBqICE9PSAwICYmIGogIT09IG51bVRoZXRhcyAtIDEpIHsKICAgICAgICAgICAgICAgIG5lZ2F0ZU5vcm1hbFt2ZXJ0ZXhJbmRleF0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2ZXJ0ZXhJbmRleCsrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGluZGV4ID0gMDsKICAgICAgICBsZXQgdG9wT2Zmc2V0OwogICAgICAgIGxldCBib3R0b21PZmZzZXQ7CiAgICAgICAgZm9yIChpID0gMTsgaSA8IG51bVBoaXMgLSAyOyBpKyspIHsKICAgICAgICAgIHRvcE9mZnNldCA9IGkgKiBudW1UaGV0YXM7CiAgICAgICAgICBib3R0b21PZmZzZXQgPSAoaSArIDEpICogbnVtVGhldGFzOwogICAgICAgICAgZm9yIChqID0gMTsgaiA8IG51bVRoZXRhcyAtIDI7IGorKykgewogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gYm90dG9tT2Zmc2V0ICsgajsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGJvdHRvbU9mZnNldCArIGogKyAxOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wT2Zmc2V0ICsgaiArIDE7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBib3R0b21PZmZzZXQgKyBqOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wT2Zmc2V0ICsgaiArIDE7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0b3BPZmZzZXQgKyBqOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaGFzSW5uZXJTdXJmYWNlKSB7CiAgICAgICAgICBjb25zdCBvZmZzZXQgPSBudW1QaGlzICogbnVtVGhldGFzOwogICAgICAgICAgZm9yIChpID0gMTsgaSA8IG51bVBoaXMgLSAyOyBpKyspIHsKICAgICAgICAgICAgdG9wT2Zmc2V0ID0gb2Zmc2V0ICsgaSAqIG51bVRoZXRhczsKICAgICAgICAgICAgYm90dG9tT2Zmc2V0ID0gb2Zmc2V0ICsgKGkgKyAxKSAqIG51bVRoZXRhczsKICAgICAgICAgICAgZm9yIChqID0gMTsgaiA8IG51bVRoZXRhcyAtIDI7IGorKykgewogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBib3R0b21PZmZzZXQgKyBqOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0b3BPZmZzZXQgKyBqOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0b3BPZmZzZXQgKyBqICsgMTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gYm90dG9tT2Zmc2V0ICsgajsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdG9wT2Zmc2V0ICsgaiArIDE7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGJvdHRvbU9mZnNldCArIGogKyAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCBvdXRlck9mZnNldDsKICAgICAgICBsZXQgaW5uZXJPZmZzZXQ7CiAgICAgICAgaWYgKGhhc0lubmVyU3VyZmFjZSkgewogICAgICAgICAgaWYgKGlzVG9wT3BlbikgewogICAgICAgICAgICBpbm5lck9mZnNldCA9IG51bVBoaXMgKiBudW1UaGV0YXM7CiAgICAgICAgICAgIGZvciAoaSA9IDE7IGkgPCBudW1UaGV0YXMgLSAyOyBpKyspIHsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIDE7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0ICsgaSArIDE7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0ICsgaSArIDE7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0ICsgaTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQm90T3BlbikgewogICAgICAgICAgICBvdXRlck9mZnNldCA9IG51bVBoaXMgKiBudW1UaGV0YXMgLSBudW1UaGV0YXM7CiAgICAgICAgICAgIGlubmVyT2Zmc2V0ID0gbnVtUGhpcyAqIG51bVRoZXRhcyAqIHZlcnRleE11bHRpcGxpZXIgLSBudW1UaGV0YXM7CiAgICAgICAgICAgIGZvciAoaSA9IDE7IGkgPCBudW1UaGV0YXMgLSAyOyBpKyspIHsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb3V0ZXJPZmZzZXQgKyBpICsgMTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb3V0ZXJPZmZzZXQgKyBpOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldCArIGk7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgaSArIDE7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0ICsgaTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQgKyBpICsgMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaXNDbG9ja09wZW4pIHsKICAgICAgICAgIGZvciAoaSA9IDE7IGkgPCBudW1QaGlzIC0gMjsgaSsrKSB7CiAgICAgICAgICAgIGlubmVyT2Zmc2V0ID0gbnVtVGhldGFzICogbnVtUGhpcyArIG51bVRoZXRhcyAqIGk7CiAgICAgICAgICAgIG91dGVyT2Zmc2V0ID0gbnVtVGhldGFzICogaTsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0OwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb3V0ZXJPZmZzZXQgKyBudW1UaGV0YXM7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvdXRlck9mZnNldDsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0OwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQgKyBudW1UaGV0YXM7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvdXRlck9mZnNldCArIG51bVRoZXRhczsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoaSA9IDE7IGkgPCBudW1QaGlzIC0gMjsgaSsrKSB7CiAgICAgICAgICAgIGlubmVyT2Zmc2V0ID0gbnVtVGhldGFzICogbnVtUGhpcyArIG51bVRoZXRhcyAqIChpICsgMSkgLSAxOwogICAgICAgICAgICBvdXRlck9mZnNldCA9IG51bVRoZXRhcyAqIChpICsgMSkgLSAxOwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb3V0ZXJPZmZzZXQgKyBudW1UaGV0YXM7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldDsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0OwogICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb3V0ZXJPZmZzZXQgKyBudW1UaGV0YXM7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldCArIG51bVRoZXRhczsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGlubmVyT2Zmc2V0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGxldCBzdEluZGV4ID0gMDsKICAgICAgICBsZXQgbm9ybWFsSW5kZXggPSAwOwogICAgICAgIGxldCB0YW5nZW50SW5kZXggPSAwOwogICAgICAgIGxldCBiaXRhbmdlbnRJbmRleCA9IDA7CiAgICAgICAgY29uc3QgdmVydGV4Q291bnRIYWxmID0gdmVydGV4Q291bnQgLyAyOwogICAgICAgIGxldCBlbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkT3V0ZXIgPSBFbGxpcHNvaWRfZGVmYXVsdC5mcm9tQ2FydGVzaWFuMyhyYWRpaSk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkSW5uZXIgPSBFbGxpcHNvaWRfZGVmYXVsdC5mcm9tQ2FydGVzaWFuMyhpbm5lclJhZGlpKTsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0IHx8IHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHZlcnRleENvdW50OyBpKyspIHsKICAgICAgICAgICAgZWxsaXBzb2lkID0gaXNJbm5lcltpXSA/IGVsbGlwc29pZElubmVyIDogZWxsaXBzb2lkT3V0ZXI7CiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIGkgKiAzLCBzY3JhdGNoUG9zaXRpb24yKTsKICAgICAgICAgICAgY29uc3Qgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIHNjcmF0Y2hOb3JtYWw1KTsKICAgICAgICAgICAgaWYgKG5lZ2F0ZU5vcm1hbFtpXSkgewogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUobm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgICAgIGNvbnN0IG5vcm1hbFNUID0gQ2FydGVzaWFuMl9kZWZhdWx0Lm5lZ2F0ZShub3JtYWwyLCBzY3JhdGNoTm9ybWFsU1QpOwogICAgICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSBNYXRoLmF0YW4yKG5vcm1hbFNULnksIG5vcm1hbFNULngpIC8gTWF0aF9kZWZhdWx0LlRXT19QSSArIDAuNTsKICAgICAgICAgICAgICBzdFtzdEluZGV4KytdID0gTWF0aC5hc2luKG5vcm1hbDIueikgLyBNYXRoLlBJICsgMC41OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi55OwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICBjb25zdCB0YW5nZW50ID0gc2NyYXRjaFRhbmdlbnQzOwogICAgICAgICAgICAgIGxldCB0YW5nZXRPZmZzZXQgPSAwOwogICAgICAgICAgICAgIGxldCB1bml0OwogICAgICAgICAgICAgIGlmIChpc0lubmVyW2ldKSB7CiAgICAgICAgICAgICAgICB0YW5nZXRPZmZzZXQgPSB2ZXJ0ZXhDb3VudEhhbGY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghaXNUb3BPcGVuICYmIGkgPj0gdGFuZ2V0T2Zmc2V0ICYmIGkgPCB0YW5nZXRPZmZzZXQgKyBudW1UaGV0YXMgKiAyKSB7CiAgICAgICAgICAgICAgICB1bml0ID0gQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdW5pdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1o7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh1bml0LCBub3JtYWwyLCB0YW5nZW50KTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHRhbmdlbnQsIHRhbmdlbnQpOwogICAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC55OwogICAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC56OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICAgICAgY29uc3QgYml0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKG5vcm1hbDIsIHRhbmdlbnQsIHNjcmF0Y2hCaXRhbmdlbnQzKTsKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoYml0YW5nZW50LCBiaXRhbmdlbnQpOwogICAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC54OwogICAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC56OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgICAgICAgdmFsdWVzOiBzdAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBub3JtYWxzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMudGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogdGFuZ2VudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWRHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlKSkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIGNvbnN0IG9mZnNldFZhbHVlID0gZWxsaXBzb2lkR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tRWxsaXBzb2lkKGVsbGlwc29pZE91dGVyKSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogZWxsaXBzb2lkR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBFbGxpcHNvaWRHZW9tZXRyeS5nZXRVbml0RWxsaXBzb2lkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodW5pdEVsbGlwc29pZEdlb21ldHJ5KSkgewogICAgICAgICAgdW5pdEVsbGlwc29pZEdlb21ldHJ5ID0gRWxsaXBzb2lkR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkoCiAgICAgICAgICAgIG5ldyBFbGxpcHNvaWRHZW9tZXRyeSh7CiAgICAgICAgICAgICAgcmFkaWk6IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMSwgMSwgMSksCiAgICAgICAgICAgICAgdmVydGV4Rm9ybWF0OiBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5QT1NJVElPTl9PTkxZCiAgICAgICAgICAgIH0pCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5pdEVsbGlwc29pZEdlb21ldHJ5OwogICAgICB9OwogICAgICBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0ID0gRWxsaXBzb2lkR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVFbGxpcHNvaWRHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVFbGxpcHNvaWRHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5KGVsbGlwc29pZEdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBlbGxpcHNvaWRHZW9tZXRyeSA9IEVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKGVsbGlwc29pZEdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIEVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoZWxsaXBzb2lkR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVFbGxpcHNvaWRHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRHZW9tZXRyeSgpOwogICAgICBjcmVhdGVFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCByYWRpaSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucmFkaWksIGRlZmF1bHRSYWRpaTIpOwogICAgY29uc3QgaW5uZXJSYWRpaSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaW5uZXJSYWRpaSwgcmFkaWkpOwogICAgY29uc3QgbWluaW11bUNsb2NrID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5taW5pbXVtQ2xvY2ssIDApOwogICAgY29uc3QgbWF4aW11bUNsb2NrID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5tYXhpbXVtQ2xvY2ssIE1hdGhfZGVmYXVsdC5UV09fUEkpOwogICAgY29uc3QgbWluaW11bUNvbmUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1pbmltdW1Db25lLCAwKTsKICAgIGNvbnN0IG1heGltdW1Db25lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5tYXhpbXVtQ29uZSwgTWF0aF9kZWZhdWx0LlBJKTsKICAgIGNvbnN0IHN0YWNrUGFydGl0aW9ucyA9IE1hdGgucm91bmQoZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zdGFja1BhcnRpdGlvbnMsIDEwKSk7CiAgICBjb25zdCBzbGljZVBhcnRpdGlvbnMgPSBNYXRoLnJvdW5kKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc2xpY2VQYXJ0aXRpb25zLCA4KSk7CiAgICBjb25zdCBzdWJkaXZpc2lvbnMgPSBNYXRoLnJvdW5kKGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc3ViZGl2aXNpb25zLCAxMjgpKTsKICAgIGlmIChzdGFja1BhcnRpdGlvbnMgPCAxKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnN0YWNrUGFydGl0aW9ucyBjYW5ub3QgYmUgbGVzcyB0aGFuIDEiKTsKICAgIH0KICAgIGlmIChzbGljZVBhcnRpdGlvbnMgPCAwKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnNsaWNlUGFydGl0aW9ucyBjYW5ub3QgYmUgbGVzcyB0aGFuIDAiKTsKICAgIH0KICAgIGlmIChzdWJkaXZpc2lvbnMgPCAwKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcHRpb25zLnN1YmRpdmlzaW9ucyBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byB6ZXJvLiIKICAgICAgKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUpICYmIG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAiR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUuVE9QIGlzIG5vdCBhIHN1cHBvcnRlZCBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSBmb3IgdGhpcyBnZW9tZXRyeS4iCiAgICAgICk7CiAgICB9CiAgICB0aGlzLl9yYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShyYWRpaSk7CiAgICB0aGlzLl9pbm5lclJhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGlubmVyUmFkaWkpOwogICAgdGhpcy5fbWluaW11bUNsb2NrID0gbWluaW11bUNsb2NrOwogICAgdGhpcy5fbWF4aW11bUNsb2NrID0gbWF4aW11bUNsb2NrOwogICAgdGhpcy5fbWluaW11bUNvbmUgPSBtaW5pbXVtQ29uZTsKICAgIHRoaXMuX21heGltdW1Db25lID0gbWF4aW11bUNvbmU7CiAgICB0aGlzLl9zdGFja1BhcnRpdGlvbnMgPSBzdGFja1BhcnRpdGlvbnM7CiAgICB0aGlzLl9zbGljZVBhcnRpdGlvbnMgPSBzbGljZVBhcnRpdGlvbnM7CiAgICB0aGlzLl9zdWJkaXZpc2lvbnMgPSBzdWJkaXZpc2lvbnM7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5IjsKICB9CiAgdmFyIGRlZmF1bHRSYWRpaTIsIGNvczIsIHNpbjIsIHNjcmF0Y2hSYWRpaTIsIHNjcmF0Y2hJbm5lclJhZGlpMiwgc2NyYXRjaE9wdGlvbnMxNCwgRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGRlZmF1bHRSYWRpaTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KDEsIDEsIDEpOwogICAgICBjb3MyID0gTWF0aC5jb3M7CiAgICAgIHNpbjIgPSBNYXRoLnNpbjsKICAgICAgRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IDIgKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgODsKICAgICAgRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmFsdWUuX3JhZGlpLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9pbm5lclJhZGlpLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbWluaW11bUNsb2NrOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbWF4aW11bUNsb2NrOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fbWluaW11bUNvbmU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9tYXhpbXVtQ29uZTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N0YWNrUGFydGl0aW9uczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NsaWNlUGFydGl0aW9uczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N1YmRpdmlzaW9uczsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hSYWRpaTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hJbm5lclJhZGlpMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxNCA9IHsKICAgICAgICByYWRpaTogc2NyYXRjaFJhZGlpMiwKICAgICAgICBpbm5lclJhZGlpOiBzY3JhdGNoSW5uZXJSYWRpaTIsCiAgICAgICAgbWluaW11bUNsb2NrOiB2b2lkIDAsCiAgICAgICAgbWF4aW11bUNsb2NrOiB2b2lkIDAsCiAgICAgICAgbWluaW11bUNvbmU6IHZvaWQgMCwKICAgICAgICBtYXhpbXVtQ29uZTogdm9pZCAwLAogICAgICAgIHN0YWNrUGFydGl0aW9uczogdm9pZCAwLAogICAgICAgIHNsaWNlUGFydGl0aW9uczogdm9pZCAwLAogICAgICAgIHN1YmRpdmlzaW9uczogdm9pZCAwLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IHJhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaFJhZGlpMik7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGlubmVyUmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoSW5uZXJSYWRpaTIpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBtaW5pbXVtQ2xvY2sgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG1heGltdW1DbG9jayA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgbWluaW11bUNvbmUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG1heGltdW1Db25lID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzdGFja1BhcnRpdGlvbnMgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNsaWNlUGFydGl0aW9ucyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc3ViZGl2aXNpb25zID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE0Lm1pbmltdW1DbG9jayA9IG1pbmltdW1DbG9jazsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTQubWF4aW11bUNsb2NrID0gbWF4aW11bUNsb2NrOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNC5taW5pbXVtQ29uZSA9IG1pbmltdW1Db25lOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNC5tYXhpbXVtQ29uZSA9IG1heGltdW1Db25lOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNC5zdGFja1BhcnRpdGlvbnMgPSBzdGFja1BhcnRpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE0LnNsaWNlUGFydGl0aW9ucyA9IHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTQuc3ViZGl2aXNpb25zID0gc3ViZGl2aXNpb25zOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNC5vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgcmV0dXJuIG5ldyBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMxNCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocmFkaWksIHJlc3VsdC5fcmFkaWkpOwogICAgICAgIHJlc3VsdC5faW5uZXJSYWRpaSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShpbm5lclJhZGlpLCByZXN1bHQuX2lubmVyUmFkaWkpOwogICAgICAgIHJlc3VsdC5fbWluaW11bUNsb2NrID0gbWluaW11bUNsb2NrOwogICAgICAgIHJlc3VsdC5fbWF4aW11bUNsb2NrID0gbWF4aW11bUNsb2NrOwogICAgICAgIHJlc3VsdC5fbWluaW11bUNvbmUgPSBtaW5pbXVtQ29uZTsKICAgICAgICByZXN1bHQuX21heGltdW1Db25lID0gbWF4aW11bUNvbmU7CiAgICAgICAgcmVzdWx0Ll9zdGFja1BhcnRpdGlvbnMgPSBzdGFja1BhcnRpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9zbGljZVBhcnRpdGlvbnMgPSBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9zdWJkaXZpc2lvbnMgPSBzdWJkaXZpc2lvbnM7CiAgICAgICAgcmVzdWx0Ll9vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEVsbGlwc29pZE91dGxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKGVsbGlwc29pZEdlb21ldHJ5KSB7CiAgICAgICAgY29uc3QgcmFkaWkgPSBlbGxpcHNvaWRHZW9tZXRyeS5fcmFkaWk7CiAgICAgICAgaWYgKHJhZGlpLnggPD0gMCB8fCByYWRpaS55IDw9IDAgfHwgcmFkaWkueiA8PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGlubmVyUmFkaWkgPSBlbGxpcHNvaWRHZW9tZXRyeS5faW5uZXJSYWRpaTsKICAgICAgICBpZiAoaW5uZXJSYWRpaS54IDw9IDAgfHwgaW5uZXJSYWRpaS55IDw9IDAgfHwgaW5uZXJSYWRpaS56IDw9IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWluaW11bUNsb2NrID0gZWxsaXBzb2lkR2VvbWV0cnkuX21pbmltdW1DbG9jazsKICAgICAgICBjb25zdCBtYXhpbXVtQ2xvY2sgPSBlbGxpcHNvaWRHZW9tZXRyeS5fbWF4aW11bUNsb2NrOwogICAgICAgIGNvbnN0IG1pbmltdW1Db25lID0gZWxsaXBzb2lkR2VvbWV0cnkuX21pbmltdW1Db25lOwogICAgICAgIGNvbnN0IG1heGltdW1Db25lID0gZWxsaXBzb2lkR2VvbWV0cnkuX21heGltdW1Db25lOwogICAgICAgIGNvbnN0IHN1YmRpdmlzaW9ucyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9zdWJkaXZpc2lvbnM7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjMocmFkaWkpOwogICAgICAgIGxldCBzbGljZVBhcnRpdGlvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc2xpY2VQYXJ0aXRpb25zICsgMTsKICAgICAgICBsZXQgc3RhY2tQYXJ0aXRpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuX3N0YWNrUGFydGl0aW9ucyArIDE7CiAgICAgICAgc2xpY2VQYXJ0aXRpb25zID0gTWF0aC5yb3VuZCgKICAgICAgICAgIHNsaWNlUGFydGl0aW9ucyAqIE1hdGguYWJzKG1heGltdW1DbG9jayAtIG1pbmltdW1DbG9jaykgLyBNYXRoX2RlZmF1bHQuVFdPX1BJCiAgICAgICAgKTsKICAgICAgICBzdGFja1BhcnRpdGlvbnMgPSBNYXRoLnJvdW5kKAogICAgICAgICAgc3RhY2tQYXJ0aXRpb25zICogTWF0aC5hYnMobWF4aW11bUNvbmUgLSBtaW5pbXVtQ29uZSkgLyBNYXRoX2RlZmF1bHQuUEkKICAgICAgICApOwogICAgICAgIGlmIChzbGljZVBhcnRpdGlvbnMgPCAyKSB7CiAgICAgICAgICBzbGljZVBhcnRpdGlvbnMgPSAyOwogICAgICAgIH0KICAgICAgICBpZiAoc3RhY2tQYXJ0aXRpb25zIDwgMikgewogICAgICAgICAgc3RhY2tQYXJ0aXRpb25zID0gMjsKICAgICAgICB9CiAgICAgICAgbGV0IGV4dHJhSW5kaWNlcyA9IDA7CiAgICAgICAgbGV0IHZlcnRleE11bHRpcGxpZXIgPSAxOwogICAgICAgIGNvbnN0IGhhc0lubmVyU3VyZmFjZSA9IGlubmVyUmFkaWkueCAhPT0gcmFkaWkueCB8fCBpbm5lclJhZGlpLnkgIT09IHJhZGlpLnkgfHwgaW5uZXJSYWRpaS56ICE9PSByYWRpaS56OwogICAgICAgIGxldCBpc1RvcE9wZW4gPSBmYWxzZTsKICAgICAgICBsZXQgaXNCb3RPcGVuID0gZmFsc2U7CiAgICAgICAgaWYgKGhhc0lubmVyU3VyZmFjZSkgewogICAgICAgICAgdmVydGV4TXVsdGlwbGllciA9IDI7CiAgICAgICAgICBpZiAobWluaW11bUNvbmUgPiAwKSB7CiAgICAgICAgICAgIGlzVG9wT3BlbiA9IHRydWU7CiAgICAgICAgICAgIGV4dHJhSW5kaWNlcyArPSBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWF4aW11bUNvbmUgPCBNYXRoLlBJKSB7CiAgICAgICAgICAgIGlzQm90T3BlbiA9IHRydWU7CiAgICAgICAgICAgIGV4dHJhSW5kaWNlcyArPSBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZlcnRleENvdW50ID0gc3ViZGl2aXNpb25zICogdmVydGV4TXVsdGlwbGllciAqIChzdGFja1BhcnRpdGlvbnMgKyBzbGljZVBhcnRpdGlvbnMpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkodmVydGV4Q291bnQgKiAzKTsKICAgICAgICBjb25zdCBudW1JbmRpY2VzID0gMiAqICh2ZXJ0ZXhDb3VudCArIGV4dHJhSW5kaWNlcyAtIChzbGljZVBhcnRpdGlvbnMgKyBzdGFja1BhcnRpdGlvbnMpICogdmVydGV4TXVsdGlwbGllcik7CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KHZlcnRleENvdW50LCBudW1JbmRpY2VzKTsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgajsKICAgICAgICBsZXQgdGhldGE7CiAgICAgICAgbGV0IHBoaTsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGNvbnN0IHNpblBoaSA9IG5ldyBBcnJheShzdGFja1BhcnRpdGlvbnMpOwogICAgICAgIGNvbnN0IGNvc1BoaSA9IG5ldyBBcnJheShzdGFja1BhcnRpdGlvbnMpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzdGFja1BhcnRpdGlvbnM7IGkrKykgewogICAgICAgICAgcGhpID0gbWluaW11bUNvbmUgKyBpICogKG1heGltdW1Db25lIC0gbWluaW11bUNvbmUpIC8gKHN0YWNrUGFydGl0aW9ucyAtIDEpOwogICAgICAgICAgc2luUGhpW2ldID0gc2luMihwaGkpOwogICAgICAgICAgY29zUGhpW2ldID0gY29zMihwaGkpOwogICAgICAgIH0KICAgICAgICBjb25zdCBzaW5UaGV0YSA9IG5ldyBBcnJheShzdWJkaXZpc2lvbnMpOwogICAgICAgIGNvbnN0IGNvc1RoZXRhID0gbmV3IEFycmF5KHN1YmRpdmlzaW9ucyk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHN1YmRpdmlzaW9uczsgaSsrKSB7CiAgICAgICAgICB0aGV0YSA9IG1pbmltdW1DbG9jayArIGkgKiAobWF4aW11bUNsb2NrIC0gbWluaW11bUNsb2NrKSAvIChzdWJkaXZpc2lvbnMgLSAxKTsKICAgICAgICAgIHNpblRoZXRhW2ldID0gc2luMih0aGV0YSk7CiAgICAgICAgICBjb3NUaGV0YVtpXSA9IGNvczIodGhldGEpOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc3RhY2tQYXJ0aXRpb25zOyBpKyspIHsKICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBzdWJkaXZpc2lvbnM7IGorKykgewogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSByYWRpaS54ICogc2luUGhpW2ldICogY29zVGhldGFbal07CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHJhZGlpLnkgKiBzaW5QaGlbaV0gKiBzaW5UaGV0YVtqXTsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcmFkaWkueiAqIGNvc1BoaVtpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGhhc0lubmVyU3VyZmFjZSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHN0YWNrUGFydGl0aW9uczsgaSsrKSB7CiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBzdWJkaXZpc2lvbnM7IGorKykgewogICAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IGlubmVyUmFkaWkueCAqIHNpblBoaVtpXSAqIGNvc1RoZXRhW2pdOwogICAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IGlubmVyUmFkaWkueSAqIHNpblBoaVtpXSAqIHNpblRoZXRhW2pdOwogICAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IGlubmVyUmFkaWkueiAqIGNvc1BoaVtpXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzaW5QaGkubGVuZ3RoID0gc3ViZGl2aXNpb25zOwogICAgICAgIGNvc1BoaS5sZW5ndGggPSBzdWJkaXZpc2lvbnM7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHN1YmRpdmlzaW9uczsgaSsrKSB7CiAgICAgICAgICBwaGkgPSBtaW5pbXVtQ29uZSArIGkgKiAobWF4aW11bUNvbmUgLSBtaW5pbXVtQ29uZSkgLyAoc3ViZGl2aXNpb25zIC0gMSk7CiAgICAgICAgICBzaW5QaGlbaV0gPSBzaW4yKHBoaSk7CiAgICAgICAgICBjb3NQaGlbaV0gPSBjb3MyKHBoaSk7CiAgICAgICAgfQogICAgICAgIHNpblRoZXRhLmxlbmd0aCA9IHNsaWNlUGFydGl0aW9uczsKICAgICAgICBjb3NUaGV0YS5sZW5ndGggPSBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsaWNlUGFydGl0aW9uczsgaSsrKSB7CiAgICAgICAgICB0aGV0YSA9IG1pbmltdW1DbG9jayArIGkgKiAobWF4aW11bUNsb2NrIC0gbWluaW11bUNsb2NrKSAvIChzbGljZVBhcnRpdGlvbnMgLSAxKTsKICAgICAgICAgIHNpblRoZXRhW2ldID0gc2luMih0aGV0YSk7CiAgICAgICAgICBjb3NUaGV0YVtpXSA9IGNvczIodGhldGEpOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc3ViZGl2aXNpb25zOyBpKyspIHsKICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBzbGljZVBhcnRpdGlvbnM7IGorKykgewogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXgrK10gPSByYWRpaS54ICogc2luUGhpW2ldICogY29zVGhldGFbal07CiAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IHJhZGlpLnkgKiBzaW5QaGlbaV0gKiBzaW5UaGV0YVtqXTsKICAgICAgICAgICAgcG9zaXRpb25zW2luZGV4KytdID0gcmFkaWkueiAqIGNvc1BoaVtpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGhhc0lubmVyU3VyZmFjZSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHN1YmRpdmlzaW9uczsgaSsrKSB7CiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBzbGljZVBhcnRpdGlvbnM7IGorKykgewogICAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IGlubmVyUmFkaWkueCAqIHNpblBoaVtpXSAqIGNvc1RoZXRhW2pdOwogICAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IGlubmVyUmFkaWkueSAqIHNpblBoaVtpXSAqIHNpblRoZXRhW2pdOwogICAgICAgICAgICAgIHBvc2l0aW9uc1tpbmRleCsrXSA9IGlubmVyUmFkaWkueiAqIGNvc1BoaVtpXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpbmRleCA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHN0YWNrUGFydGl0aW9ucyAqIHZlcnRleE11bHRpcGxpZXI7IGkrKykgewogICAgICAgICAgY29uc3QgdG9wT2Zmc2V0ID0gaSAqIHN1YmRpdmlzaW9uczsKICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBzdWJkaXZpc2lvbnMgLSAxOyBqKyspIHsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRvcE9mZnNldCArIGo7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0b3BPZmZzZXQgKyBqICsgMTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IG9mZnNldCA9IHN0YWNrUGFydGl0aW9ucyAqIHN1YmRpdmlzaW9ucyAqIHZlcnRleE11bHRpcGxpZXI7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsaWNlUGFydGl0aW9uczsgaSsrKSB7CiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgc3ViZGl2aXNpb25zIC0gMTsgaisrKSB7CiAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBvZmZzZXQgKyBpICsgaiAqIHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG9mZnNldCArIGkgKyAoaiArIDEpICogc2xpY2VQYXJ0aXRpb25zOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaGFzSW5uZXJTdXJmYWNlKSB7CiAgICAgICAgICBvZmZzZXQgPSBzdGFja1BhcnRpdGlvbnMgKiBzdWJkaXZpc2lvbnMgKiB2ZXJ0ZXhNdWx0aXBsaWVyICsgc2xpY2VQYXJ0aXRpb25zICogc3ViZGl2aXNpb25zOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsaWNlUGFydGl0aW9uczsgaSsrKSB7CiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBzdWJkaXZpc2lvbnMgLSAxOyBqKyspIHsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb2Zmc2V0ICsgaSArIGogKiBzbGljZVBhcnRpdGlvbnM7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG9mZnNldCArIGkgKyAoaiArIDEpICogc2xpY2VQYXJ0aXRpb25zOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChoYXNJbm5lclN1cmZhY2UpIHsKICAgICAgICAgIGxldCBvdXRlck9mZnNldCA9IHN0YWNrUGFydGl0aW9ucyAqIHN1YmRpdmlzaW9ucyAqIHZlcnRleE11bHRpcGxpZXI7CiAgICAgICAgICBsZXQgaW5uZXJPZmZzZXQgPSBvdXRlck9mZnNldCArIHN1YmRpdmlzaW9ucyAqIHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgIGlmIChpc1RvcE9wZW4pIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsaWNlUGFydGl0aW9uczsgaSsrKSB7CiAgICAgICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IG91dGVyT2Zmc2V0ICsgaTsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaW5uZXJPZmZzZXQgKyBpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNCb3RPcGVuKSB7CiAgICAgICAgICAgIG91dGVyT2Zmc2V0ICs9IHN1YmRpdmlzaW9ucyAqIHNsaWNlUGFydGl0aW9ucyAtIHNsaWNlUGFydGl0aW9uczsKICAgICAgICAgICAgaW5uZXJPZmZzZXQgKz0gc3ViZGl2aXNpb25zICogc2xpY2VQYXJ0aXRpb25zIC0gc2xpY2VQYXJ0aXRpb25zOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2xpY2VQYXJ0aXRpb25zOyBpKyspIHsKICAgICAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gb3V0ZXJPZmZzZXQgKyBpOwogICAgICAgICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpbm5lck9mZnNldCArIGk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgICB9KQogICAgICAgIH0pOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IGVsbGlwc29pZEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgIGF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgIHZhbHVlczogYXBwbHlPZmZzZXQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tRWxsaXBzb2lkKGVsbGlwc29pZCksCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IGVsbGlwc29pZEdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkoZWxsaXBzb2lkR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChlbGxpcHNvaWRHZW9tZXRyeS5idWZmZXIsIG9mZnNldCkpIHsKICAgICAgZWxsaXBzb2lkR2VvbWV0cnkgPSBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soCiAgICAgICAgZWxsaXBzb2lkR2VvbWV0cnksCiAgICAgICAgb2Zmc2V0CiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoZWxsaXBzb2lkR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9DdWxsaW5nVm9sdW1lLmpzCiAgZnVuY3Rpb24gQ3VsbGluZ1ZvbHVtZShwbGFuZXMpIHsKICAgIHRoaXMucGxhbmVzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQocGxhbmVzLCBbXSk7CiAgfQogIHZhciBmYWNlcywgc2NyYXRjaFBsYW5lQ2VudGVyLCBzY3JhdGNoUGxhbmVOb3JtYWwyLCBzY3JhdGNoUGxhbmUyLCBDdWxsaW5nVm9sdW1lX2RlZmF1bHQ7CiAgdmFyIGluaXRfQ3VsbGluZ1ZvbHVtZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ3VsbGluZ1ZvbHVtZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRlc2lhbjQoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9JbnRlcnNlY3QoKTsKICAgICAgaW5pdF9QbGFuZSgpOwogICAgICBmYWNlcyA9IFtuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpXTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1gsIGZhY2VzWzBdKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1ksIGZhY2VzWzFdKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osIGZhY2VzWzJdKTsKICAgICAgc2NyYXRjaFBsYW5lQ2VudGVyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGxhbmVOb3JtYWwyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGxhbmUyID0gbmV3IFBsYW5lX2RlZmF1bHQobmV3IENhcnRlc2lhbjNfZGVmYXVsdCgxLCAwLCAwKSwgMCk7CiAgICAgIEN1bGxpbmdWb2x1bWUuZnJvbUJvdW5kaW5nU3BoZXJlID0gZnVuY3Rpb24oYm91bmRpbmdTcGhlcmUsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJvdW5kaW5nU3BoZXJlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImJvdW5kaW5nU3BoZXJlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ3VsbGluZ1ZvbHVtZSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZW5ndGggPSBmYWNlcy5sZW5ndGg7CiAgICAgICAgY29uc3QgcGxhbmVzID0gcmVzdWx0LnBsYW5lczsKICAgICAgICBwbGFuZXMubGVuZ3RoID0gMiAqIGxlbmd0aDsKICAgICAgICBjb25zdCBjZW50ZXIgPSBib3VuZGluZ1NwaGVyZS5jZW50ZXI7CiAgICAgICAgY29uc3QgcmFkaXVzID0gYm91bmRpbmdTcGhlcmUucmFkaXVzOwogICAgICAgIGxldCBwbGFuZUluZGV4ID0gMDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjb25zdCBmYWNlTm9ybWFsID0gZmFjZXNbaV07CiAgICAgICAgICBsZXQgcGxhbmUwID0gcGxhbmVzW3BsYW5lSW5kZXhdOwogICAgICAgICAgbGV0IHBsYW5lMSA9IHBsYW5lc1twbGFuZUluZGV4ICsgMV07CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZTApKSB7CiAgICAgICAgICAgIHBsYW5lMCA9IHBsYW5lc1twbGFuZUluZGV4XSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lMSkpIHsKICAgICAgICAgICAgcGxhbmUxID0gcGxhbmVzW3BsYW5lSW5kZXggKyAxXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGZhY2VOb3JtYWwsIC1yYWRpdXMsIHNjcmF0Y2hQbGFuZUNlbnRlcik7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGNlbnRlciwgc2NyYXRjaFBsYW5lQ2VudGVyLCBzY3JhdGNoUGxhbmVDZW50ZXIpOwogICAgICAgICAgcGxhbmUwLnggPSBmYWNlTm9ybWFsLng7CiAgICAgICAgICBwbGFuZTAueSA9IGZhY2VOb3JtYWwueTsKICAgICAgICAgIHBsYW5lMC56ID0gZmFjZU5vcm1hbC56OwogICAgICAgICAgcGxhbmUwLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChmYWNlTm9ybWFsLCBzY3JhdGNoUGxhbmVDZW50ZXIpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZmFjZU5vcm1hbCwgcmFkaXVzLCBzY3JhdGNoUGxhbmVDZW50ZXIpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjZW50ZXIsIHNjcmF0Y2hQbGFuZUNlbnRlciwgc2NyYXRjaFBsYW5lQ2VudGVyKTsKICAgICAgICAgIHBsYW5lMS54ID0gLWZhY2VOb3JtYWwueDsKICAgICAgICAgIHBsYW5lMS55ID0gLWZhY2VOb3JtYWwueTsKICAgICAgICAgIHBsYW5lMS56ID0gLWZhY2VOb3JtYWwuejsKICAgICAgICAgIHBsYW5lMS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QoCiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoZmFjZU5vcm1hbCwgc2NyYXRjaFBsYW5lTm9ybWFsMiksCiAgICAgICAgICAgIHNjcmF0Y2hQbGFuZUNlbnRlcgogICAgICAgICAgKTsKICAgICAgICAgIHBsYW5lSW5kZXggKz0gMjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ3VsbGluZ1ZvbHVtZS5wcm90b3R5cGUuY29tcHV0ZVZpc2liaWxpdHkgPSBmdW5jdGlvbihib3VuZGluZ1ZvbHVtZSkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGJvdW5kaW5nVm9sdW1lKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImJvdW5kaW5nVm9sdW1lIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwbGFuZXMgPSB0aGlzLnBsYW5lczsKICAgICAgICBsZXQgaW50ZXJzZWN0aW5nID0gZmFsc2U7CiAgICAgICAgZm9yIChsZXQgayA9IDAsIGxlbiA9IHBsYW5lcy5sZW5ndGg7IGsgPCBsZW47ICsraykgewogICAgICAgICAgY29uc3QgcmVzdWx0ID0gYm91bmRpbmdWb2x1bWUuaW50ZXJzZWN0UGxhbmUoCiAgICAgICAgICAgIFBsYW5lX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjQocGxhbmVzW2tdLCBzY3JhdGNoUGxhbmUyKQogICAgICAgICAgKTsKICAgICAgICAgIGlmIChyZXN1bHQgPT09IEludGVyc2VjdF9kZWZhdWx0Lk9VVFNJREUpIHsKICAgICAgICAgICAgcmV0dXJuIEludGVyc2VjdF9kZWZhdWx0Lk9VVFNJREU7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3VsdCA9PT0gSW50ZXJzZWN0X2RlZmF1bHQuSU5URVJTRUNUSU5HKSB7CiAgICAgICAgICAgIGludGVyc2VjdGluZyA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbnRlcnNlY3RpbmcgPyBJbnRlcnNlY3RfZGVmYXVsdC5JTlRFUlNFQ1RJTkcgOiBJbnRlcnNlY3RfZGVmYXVsdC5JTlNJREU7CiAgICAgIH07CiAgICAgIEN1bGxpbmdWb2x1bWUucHJvdG90eXBlLmNvbXB1dGVWaXNpYmlsaXR5V2l0aFBsYW5lTWFzayA9IGZ1bmN0aW9uKGJvdW5kaW5nVm9sdW1lLCBwYXJlbnRQbGFuZU1hc2spIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChib3VuZGluZ1ZvbHVtZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJib3VuZGluZ1ZvbHVtZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGFyZW50UGxhbmVNYXNrKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBhcmVudFBsYW5lTWFzayBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHBhcmVudFBsYW5lTWFzayA9PT0gQ3VsbGluZ1ZvbHVtZS5NQVNLX09VVFNJREUgfHwgcGFyZW50UGxhbmVNYXNrID09PSBDdWxsaW5nVm9sdW1lLk1BU0tfSU5TSURFKSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50UGxhbmVNYXNrOwogICAgICAgIH0KICAgICAgICBsZXQgbWFzayA9IEN1bGxpbmdWb2x1bWUuTUFTS19JTlNJREU7CiAgICAgICAgY29uc3QgcGxhbmVzID0gdGhpcy5wbGFuZXM7CiAgICAgICAgZm9yIChsZXQgayA9IDAsIGxlbiA9IHBsYW5lcy5sZW5ndGg7IGsgPCBsZW47ICsraykgewogICAgICAgICAgY29uc3QgZmxhZyA9IGsgPCAzMSA/IDEgPDwgayA6IDA7CiAgICAgICAgICBpZiAoayA8IDMxICYmIChwYXJlbnRQbGFuZU1hc2sgJiBmbGFnKSA9PT0gMCkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGJvdW5kaW5nVm9sdW1lLmludGVyc2VjdFBsYW5lKAogICAgICAgICAgICBQbGFuZV9kZWZhdWx0LmZyb21DYXJ0ZXNpYW40KHBsYW5lc1trXSwgc2NyYXRjaFBsYW5lMikKICAgICAgICAgICk7CiAgICAgICAgICBpZiAocmVzdWx0ID09PSBJbnRlcnNlY3RfZGVmYXVsdC5PVVRTSURFKSB7CiAgICAgICAgICAgIHJldHVybiBDdWxsaW5nVm9sdW1lLk1BU0tfT1VUU0lERTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzdWx0ID09PSBJbnRlcnNlY3RfZGVmYXVsdC5JTlRFUlNFQ1RJTkcpIHsKICAgICAgICAgICAgbWFzayB8PSBmbGFnOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWFzazsKICAgICAgfTsKICAgICAgQ3VsbGluZ1ZvbHVtZS5NQVNLX09VVFNJREUgPSA0Mjk0OTY3Mjk1OwogICAgICBDdWxsaW5nVm9sdW1lLk1BU0tfSU5TSURFID0gMDsKICAgICAgQ3VsbGluZ1ZvbHVtZS5NQVNLX0lOREVURVJNSU5BVEUgPSAyMTQ3NDgzNjQ3OwogICAgICBDdWxsaW5nVm9sdW1lX2RlZmF1bHQgPSBDdWxsaW5nVm9sdW1lOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bS5qcwogIGZ1bmN0aW9uIE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0ob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICB0aGlzLmxlZnQgPSBvcHRpb25zLmxlZnQ7CiAgICB0aGlzLl9sZWZ0ID0gdm9pZCAwOwogICAgdGhpcy5yaWdodCA9IG9wdGlvbnMucmlnaHQ7CiAgICB0aGlzLl9yaWdodCA9IHZvaWQgMDsKICAgIHRoaXMudG9wID0gb3B0aW9ucy50b3A7CiAgICB0aGlzLl90b3AgPSB2b2lkIDA7CiAgICB0aGlzLmJvdHRvbSA9IG9wdGlvbnMuYm90dG9tOwogICAgdGhpcy5fYm90dG9tID0gdm9pZCAwOwogICAgdGhpcy5uZWFyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5uZWFyLCAxKTsKICAgIHRoaXMuX25lYXIgPSB0aGlzLm5lYXI7CiAgICB0aGlzLmZhciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZmFyLCA1ZTgpOwogICAgdGhpcy5fZmFyID0gdGhpcy5mYXI7CiAgICB0aGlzLl9jdWxsaW5nVm9sdW1lID0gbmV3IEN1bGxpbmdWb2x1bWVfZGVmYXVsdCgpOwogICAgdGhpcy5fb3J0aG9ncmFwaGljTWF0cml4ID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogIH0KICBmdW5jdGlvbiB1cGRhdGUoZnJ1c3R1bSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5yaWdodCkgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLmxlZnQpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS50b3ApIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5ib3R0b20pIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5uZWFyKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0uZmFyKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAicmlnaHQsIGxlZnQsIHRvcCwgYm90dG9tLCBuZWFyLCBvciBmYXIgcGFyYW1ldGVycyBhcmUgbm90IHNldC4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoZnJ1c3R1bS50b3AgIT09IGZydXN0dW0uX3RvcCB8fCBmcnVzdHVtLmJvdHRvbSAhPT0gZnJ1c3R1bS5fYm90dG9tIHx8IGZydXN0dW0ubGVmdCAhPT0gZnJ1c3R1bS5fbGVmdCB8fCBmcnVzdHVtLnJpZ2h0ICE9PSBmcnVzdHVtLl9yaWdodCB8fCBmcnVzdHVtLm5lYXIgIT09IGZydXN0dW0uX25lYXIgfHwgZnJ1c3R1bS5mYXIgIT09IGZydXN0dW0uX2ZhcikgewogICAgICBpZiAoZnJ1c3R1bS5sZWZ0ID4gZnJ1c3R1bS5yaWdodCkgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJyaWdodCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBsZWZ0LiIpOwogICAgICB9CiAgICAgIGlmIChmcnVzdHVtLmJvdHRvbSA+IGZydXN0dW0udG9wKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInRvcCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBib3R0b20uIik7CiAgICAgIH0KICAgICAgaWYgKGZydXN0dW0ubmVhciA8PSAwIHx8IGZydXN0dW0ubmVhciA+IGZydXN0dW0uZmFyKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAibmVhciBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvIGFuZCBsZXNzIHRoYW4gZmFyLiIKICAgICAgICApOwogICAgICB9CiAgICAgIGZydXN0dW0uX2xlZnQgPSBmcnVzdHVtLmxlZnQ7CiAgICAgIGZydXN0dW0uX3JpZ2h0ID0gZnJ1c3R1bS5yaWdodDsKICAgICAgZnJ1c3R1bS5fdG9wID0gZnJ1c3R1bS50b3A7CiAgICAgIGZydXN0dW0uX2JvdHRvbSA9IGZydXN0dW0uYm90dG9tOwogICAgICBmcnVzdHVtLl9uZWFyID0gZnJ1c3R1bS5uZWFyOwogICAgICBmcnVzdHVtLl9mYXIgPSBmcnVzdHVtLmZhcjsKICAgICAgZnJ1c3R1bS5fb3J0aG9ncmFwaGljTWF0cml4ID0gTWF0cml4NF9kZWZhdWx0LmNvbXB1dGVPcnRob2dyYXBoaWNPZmZDZW50ZXIoCiAgICAgICAgZnJ1c3R1bS5sZWZ0LAogICAgICAgIGZydXN0dW0ucmlnaHQsCiAgICAgICAgZnJ1c3R1bS5ib3R0b20sCiAgICAgICAgZnJ1c3R1bS50b3AsCiAgICAgICAgZnJ1c3R1bS5uZWFyLAogICAgICAgIGZydXN0dW0uZmFyLAogICAgICAgIGZydXN0dW0uX29ydGhvZ3JhcGhpY01hdHJpeAogICAgICApOwogICAgfQogIH0KICB2YXIgZ2V0UGxhbmVzUmlnaHQsIGdldFBsYW5lc05lYXJDZW50ZXIsIGdldFBsYW5lc1BvaW50LCBuZWdhdGVTY3JhdGNoLCBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtX2RlZmF1bHQ7CiAgdmFyIGluaXRfT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRlc2lhbjQoKTsKICAgICAgaW5pdF9DdWxsaW5nVm9sdW1lKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBvcnRob2dyYXBoaWMgcHJvamVjdGlvbiBtYXRyaXggY29tcHV0ZWQgZnJvbSB0aGUgdmlldyBmcnVzdHVtLgogICAgICAgICAqIEBtZW1iZXJvZiBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtNYXRyaXg0fQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHByb2plY3Rpb25NYXRyaXg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZSh0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29ydGhvZ3JhcGhpY01hdHJpeDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBnZXRQbGFuZXNSaWdodCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZ2V0UGxhbmVzTmVhckNlbnRlciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZ2V0UGxhbmVzUG9pbnQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG5lZ2F0ZVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlLmNvbXB1dGVDdWxsaW5nVm9sdW1lID0gZnVuY3Rpb24ocG9zaXRpb24sIGRpcmVjdGlvbjIsIHVwKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb24pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicG9zaXRpb24gaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRpcmVjdGlvbjIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZGlyZWN0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh1cCkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ1cCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGxhbmVzID0gdGhpcy5fY3VsbGluZ1ZvbHVtZS5wbGFuZXM7CiAgICAgICAgY29uc3QgdCA9IHRoaXMudG9wOwogICAgICAgIGNvbnN0IGIgPSB0aGlzLmJvdHRvbTsKICAgICAgICBjb25zdCByID0gdGhpcy5yaWdodDsKICAgICAgICBjb25zdCBsID0gdGhpcy5sZWZ0OwogICAgICAgIGNvbnN0IG4gPSB0aGlzLm5lYXI7CiAgICAgICAgY29uc3QgZiA9IHRoaXMuZmFyOwogICAgICAgIGNvbnN0IHJpZ2h0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGRpcmVjdGlvbjIsIHVwLCBnZXRQbGFuZXNSaWdodCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyaWdodCwgcmlnaHQpOwogICAgICAgIGNvbnN0IG5lYXJDZW50ZXIgPSBnZXRQbGFuZXNOZWFyQ2VudGVyOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGRpcmVjdGlvbjIsIG4sIG5lYXJDZW50ZXIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocG9zaXRpb24sIG5lYXJDZW50ZXIsIG5lYXJDZW50ZXIpOwogICAgICAgIGNvbnN0IHBvaW50ID0gZ2V0UGxhbmVzUG9pbnQ7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIocmlnaHQsIGwsIHBvaW50KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5lYXJDZW50ZXIsIHBvaW50LCBwb2ludCk7CiAgICAgICAgbGV0IHBsYW5lID0gcGxhbmVzWzBdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgcGxhbmUgPSBwbGFuZXNbMF0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHBsYW5lLnggPSByaWdodC54OwogICAgICAgIHBsYW5lLnkgPSByaWdodC55OwogICAgICAgIHBsYW5lLnogPSByaWdodC56OwogICAgICAgIHBsYW5lLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChyaWdodCwgcG9pbnQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHJpZ2h0LCByLCBwb2ludCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChuZWFyQ2VudGVyLCBwb2ludCwgcG9pbnQpOwogICAgICAgIHBsYW5lID0gcGxhbmVzWzFdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgcGxhbmUgPSBwbGFuZXNbMV0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHBsYW5lLnggPSAtcmlnaHQueDsKICAgICAgICBwbGFuZS55ID0gLXJpZ2h0Lnk7CiAgICAgICAgcGxhbmUueiA9IC1yaWdodC56OwogICAgICAgIHBsYW5lLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHJpZ2h0LCBuZWdhdGVTY3JhdGNoKSwgcG9pbnQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHVwLCBiLCBwb2ludCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChuZWFyQ2VudGVyLCBwb2ludCwgcG9pbnQpOwogICAgICAgIHBsYW5lID0gcGxhbmVzWzJdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgcGxhbmUgPSBwbGFuZXNbMl0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHBsYW5lLnggPSB1cC54OwogICAgICAgIHBsYW5lLnkgPSB1cC55OwogICAgICAgIHBsYW5lLnogPSB1cC56OwogICAgICAgIHBsYW5lLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh1cCwgcG9pbnQpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHVwLCB0LCBwb2ludCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChuZWFyQ2VudGVyLCBwb2ludCwgcG9pbnQpOwogICAgICAgIHBsYW5lID0gcGxhbmVzWzNdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgcGxhbmUgPSBwbGFuZXNbM10gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHBsYW5lLnggPSAtdXAueDsKICAgICAgICBwbGFuZS55ID0gLXVwLnk7CiAgICAgICAgcGxhbmUueiA9IC11cC56OwogICAgICAgIHBsYW5lLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHVwLCBuZWdhdGVTY3JhdGNoKSwgcG9pbnQpOwogICAgICAgIHBsYW5lID0gcGxhbmVzWzRdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgcGxhbmUgPSBwbGFuZXNbNF0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHBsYW5lLnggPSBkaXJlY3Rpb24yLng7CiAgICAgICAgcGxhbmUueSA9IGRpcmVjdGlvbjIueTsKICAgICAgICBwbGFuZS56ID0gZGlyZWN0aW9uMi56OwogICAgICAgIHBsYW5lLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChkaXJlY3Rpb24yLCBuZWFyQ2VudGVyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihkaXJlY3Rpb24yLCBmLCBwb2ludCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgcG9pbnQsIHBvaW50KTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1s1XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzVdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gLWRpcmVjdGlvbjIueDsKICAgICAgICBwbGFuZS55ID0gLWRpcmVjdGlvbjIueTsKICAgICAgICBwbGFuZS56ID0gLWRpcmVjdGlvbjIuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QoQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShkaXJlY3Rpb24yLCBuZWdhdGVTY3JhdGNoKSwgcG9pbnQpOwogICAgICAgIHJldHVybiB0aGlzLl9jdWxsaW5nVm9sdW1lOwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZS5nZXRQaXhlbERpbWVuc2lvbnMgPSBmdW5jdGlvbihkcmF3aW5nQnVmZmVyV2lkdGgsIGRyYXdpbmdCdWZmZXJIZWlnaHQsIGRpc3RhbmNlLCBwaXhlbFJhdGlvLCByZXN1bHQpIHsKICAgICAgICB1cGRhdGUodGhpcyk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZHJhd2luZ0J1ZmZlcldpZHRoKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGRyYXdpbmdCdWZmZXJIZWlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIkJvdGggZHJhd2luZ0J1ZmZlcldpZHRoIGFuZCBkcmF3aW5nQnVmZmVySGVpZ2h0IGFyZSByZXF1aXJlZC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoZHJhd2luZ0J1ZmZlcldpZHRoIDw9IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkcmF3aW5nQnVmZmVyV2lkdGggbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRyYXdpbmdCdWZmZXJIZWlnaHQgPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRyYXdpbmdCdWZmZXJIZWlnaHQgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGlzdGFuY2UpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZGlzdGFuY2UgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBpeGVsUmF0aW8pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicGl4ZWxSYXRpbyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKHBpeGVsUmF0aW8gPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBpeGVsUmF0aW8gbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIkEgcmVzdWx0IG9iamVjdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZnJ1c3R1bVdpZHRoID0gdGhpcy5yaWdodCAtIHRoaXMubGVmdDsKICAgICAgICBjb25zdCBmcnVzdHVtSGVpZ2h0ID0gdGhpcy50b3AgLSB0aGlzLmJvdHRvbTsKICAgICAgICBjb25zdCBwaXhlbFdpZHRoID0gcGl4ZWxSYXRpbyAqIGZydXN0dW1XaWR0aCAvIGRyYXdpbmdCdWZmZXJXaWR0aDsKICAgICAgICBjb25zdCBwaXhlbEhlaWdodCA9IHBpeGVsUmF0aW8gKiBmcnVzdHVtSGVpZ2h0IC8gZHJhd2luZ0J1ZmZlckhlaWdodDsKICAgICAgICByZXN1bHQueCA9IHBpeGVsV2lkdGg7CiAgICAgICAgcmVzdWx0LnkgPSBwaXhlbEhlaWdodDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5sZWZ0ID0gdGhpcy5sZWZ0OwogICAgICAgIHJlc3VsdC5yaWdodCA9IHRoaXMucmlnaHQ7CiAgICAgICAgcmVzdWx0LnRvcCA9IHRoaXMudG9wOwogICAgICAgIHJlc3VsdC5ib3R0b20gPSB0aGlzLmJvdHRvbTsKICAgICAgICByZXN1bHQubmVhciA9IHRoaXMubmVhcjsKICAgICAgICByZXN1bHQuZmFyID0gdGhpcy5mYXI7CiAgICAgICAgcmVzdWx0Ll9sZWZ0ID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fcmlnaHQgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll90b3AgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9ib3R0b20gPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9uZWFyID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fZmFyID0gdm9pZCAwOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgcmV0dXJuIGRlZmluZWRfZGVmYXVsdChvdGhlcikgJiYgb3RoZXIgaW5zdGFuY2VvZiBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtICYmIHRoaXMucmlnaHQgPT09IG90aGVyLnJpZ2h0ICYmIHRoaXMubGVmdCA9PT0gb3RoZXIubGVmdCAmJiB0aGlzLnRvcCA9PT0gb3RoZXIudG9wICYmIHRoaXMuYm90dG9tID09PSBvdGhlci5ib3R0b20gJiYgdGhpcy5uZWFyID09PSBvdGhlci5uZWFyICYmIHRoaXMuZmFyID09PSBvdGhlci5mYXI7CiAgICAgIH07CiAgICAgIE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihvdGhlciwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICByZXR1cm4gb3RoZXIgPT09IHRoaXMgfHwgZGVmaW5lZF9kZWZhdWx0KG90aGVyKSAmJiBvdGhlciBpbnN0YW5jZW9mIE9ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0gJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLnJpZ2h0LAogICAgICAgICAgb3RoZXIucmlnaHQsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5sZWZ0LAogICAgICAgICAgb3RoZXIubGVmdCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLnRvcCwKICAgICAgICAgIG90aGVyLnRvcCwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLmJvdHRvbSwKICAgICAgICAgIG90aGVyLmJvdHRvbSwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLm5lYXIsCiAgICAgICAgICBvdGhlci5uZWFyLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMuZmFyLAogICAgICAgICAgb3RoZXIuZmFyLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bV9kZWZhdWx0ID0gT3J0aG9ncmFwaGljT2ZmQ2VudGVyRnJ1c3R1bTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL09ydGhvZ3JhcGhpY0ZydXN0dW0uanMKICBmdW5jdGlvbiBPcnRob2dyYXBoaWNGcnVzdHVtKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bSA9IG5ldyBPcnRob2dyYXBoaWNPZmZDZW50ZXJGcnVzdHVtX2RlZmF1bHQoKTsKICAgIHRoaXMud2lkdGggPSBvcHRpb25zLndpZHRoOwogICAgdGhpcy5fd2lkdGggPSB2b2lkIDA7CiAgICB0aGlzLmFzcGVjdFJhdGlvID0gb3B0aW9ucy5hc3BlY3RSYXRpbzsKICAgIHRoaXMuX2FzcGVjdFJhdGlvID0gdm9pZCAwOwogICAgdGhpcy5uZWFyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5uZWFyLCAxKTsKICAgIHRoaXMuX25lYXIgPSB0aGlzLm5lYXI7CiAgICB0aGlzLmZhciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZmFyLCA1ZTgpOwogICAgdGhpcy5fZmFyID0gdGhpcy5mYXI7CiAgfQogIGZ1bmN0aW9uIHVwZGF0ZTIoZnJ1c3R1bSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS53aWR0aCkgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLmFzcGVjdFJhdGlvKSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0ubmVhcikgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLmZhcikpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIndpZHRoLCBhc3BlY3RSYXRpbywgbmVhciwgb3IgZmFyIHBhcmFtZXRlcnMgYXJlIG5vdCBzZXQuIgogICAgICApOwogICAgfQogICAgY29uc3QgZiA9IGZydXN0dW0uX29mZkNlbnRlckZydXN0dW07CiAgICBpZiAoZnJ1c3R1bS53aWR0aCAhPT0gZnJ1c3R1bS5fd2lkdGggfHwgZnJ1c3R1bS5hc3BlY3RSYXRpbyAhPT0gZnJ1c3R1bS5fYXNwZWN0UmF0aW8gfHwgZnJ1c3R1bS5uZWFyICE9PSBmcnVzdHVtLl9uZWFyIHx8IGZydXN0dW0uZmFyICE9PSBmcnVzdHVtLl9mYXIpIHsKICAgICAgaWYgKGZydXN0dW0uYXNwZWN0UmF0aW8gPCAwKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFzcGVjdFJhdGlvIG11c3QgYmUgcG9zaXRpdmUuIik7CiAgICAgIH0KICAgICAgaWYgKGZydXN0dW0ubmVhciA8IDAgfHwgZnJ1c3R1bS5uZWFyID4gZnJ1c3R1bS5mYXIpIHsKICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICJuZWFyIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8gYW5kIGxlc3MgdGhhbiBmYXIuIgogICAgICAgICk7CiAgICAgIH0KICAgICAgZnJ1c3R1bS5fYXNwZWN0UmF0aW8gPSBmcnVzdHVtLmFzcGVjdFJhdGlvOwogICAgICBmcnVzdHVtLl93aWR0aCA9IGZydXN0dW0ud2lkdGg7CiAgICAgIGZydXN0dW0uX25lYXIgPSBmcnVzdHVtLm5lYXI7CiAgICAgIGZydXN0dW0uX2ZhciA9IGZydXN0dW0uZmFyOwogICAgICBjb25zdCByYXRpbyA9IDEgLyBmcnVzdHVtLmFzcGVjdFJhdGlvOwogICAgICBmLnJpZ2h0ID0gZnJ1c3R1bS53aWR0aCAqIDAuNTsKICAgICAgZi5sZWZ0ID0gLWYucmlnaHQ7CiAgICAgIGYudG9wID0gcmF0aW8gKiBmLnJpZ2h0OwogICAgICBmLmJvdHRvbSA9IC1mLnRvcDsKICAgICAgZi5uZWFyID0gZnJ1c3R1bS5uZWFyOwogICAgICBmLmZhciA9IGZydXN0dW0uZmFyOwogICAgfQogIH0KICB2YXIgT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0OwogIHZhciBpbml0X09ydGhvZ3JhcGhpY0ZydXN0dW0gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL09ydGhvZ3JhcGhpY0ZydXN0dW0uanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X09ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW0oKTsKICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bS5wYWNrZWRMZW5ndGggPSA0OwogICAgICBPcnRob2dyYXBoaWNGcnVzdHVtLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS53aWR0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuYXNwZWN0UmF0aW87CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLm5lYXI7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5mYXI7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNGcnVzdHVtLnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgT3J0aG9ncmFwaGljRnJ1c3R1bSgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQud2lkdGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5hc3BlY3RSYXRpbyA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0Lm5lYXIgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5mYXIgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhPcnRob2dyYXBoaWNGcnVzdHVtLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIG9ydGhvZ3JhcGhpYyBwcm9qZWN0aW9uIG1hdHJpeCBjb21wdXRlZCBmcm9tIHRoZSB2aWV3IGZydXN0dW0uCiAgICAgICAgICogQG1lbWJlcm9mIE9ydGhvZ3JhcGhpY0ZydXN0dW0ucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge01hdHJpeDR9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgcHJvamVjdGlvbk1hdHJpeDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlMih0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29mZkNlbnRlckZydXN0dW0ucHJvamVjdGlvbk1hdHJpeDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIG9ydGhvZ3JhcGhpYyBwcm9qZWN0aW9uIG1hdHJpeCBjb21wdXRlZCBmcm9tIHRoZSB2aWV3IGZydXN0dW0uCiAgICAgICAgICogQG1lbWJlcm9mIE9ydGhvZ3JhcGhpY0ZydXN0dW0ucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge09ydGhvZ3JhcGhpY09mZkNlbnRlckZydXN0dW19CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICBvZmZDZW50ZXJGcnVzdHVtOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGUyKHRoaXMpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBPcnRob2dyYXBoaWNGcnVzdHVtLnByb3RvdHlwZS5jb21wdXRlQ3VsbGluZ1ZvbHVtZSA9IGZ1bmN0aW9uKHBvc2l0aW9uLCBkaXJlY3Rpb24yLCB1cCkgewogICAgICAgIHVwZGF0ZTIodGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX29mZkNlbnRlckZydXN0dW0uY29tcHV0ZUN1bGxpbmdWb2x1bWUocG9zaXRpb24sIGRpcmVjdGlvbjIsIHVwKTsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bS5wcm90b3R5cGUuZ2V0UGl4ZWxEaW1lbnNpb25zID0gZnVuY3Rpb24oZHJhd2luZ0J1ZmZlcldpZHRoLCBkcmF3aW5nQnVmZmVySGVpZ2h0LCBkaXN0YW5jZSwgcGl4ZWxSYXRpbywgcmVzdWx0KSB7CiAgICAgICAgdXBkYXRlMih0aGlzKTsKICAgICAgICByZXR1cm4gdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5nZXRQaXhlbERpbWVuc2lvbnMoCiAgICAgICAgICBkcmF3aW5nQnVmZmVyV2lkdGgsCiAgICAgICAgICBkcmF3aW5nQnVmZmVySGVpZ2h0LAogICAgICAgICAgZGlzdGFuY2UsCiAgICAgICAgICBwaXhlbFJhdGlvLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bS5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgT3J0aG9ncmFwaGljRnJ1c3R1bSgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuYXNwZWN0UmF0aW8gPSB0aGlzLmFzcGVjdFJhdGlvOwogICAgICAgIHJlc3VsdC53aWR0aCA9IHRoaXMud2lkdGg7CiAgICAgICAgcmVzdWx0Lm5lYXIgPSB0aGlzLm5lYXI7CiAgICAgICAgcmVzdWx0LmZhciA9IHRoaXMuZmFyOwogICAgICAgIHJlc3VsdC5fYXNwZWN0UmF0aW8gPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll93aWR0aCA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX25lYXIgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9mYXIgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5jbG9uZShyZXN1bHQuX29mZkNlbnRlckZydXN0dW0pOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW0ucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uKG90aGVyKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3RoZXIpIHx8ICEob3RoZXIgaW5zdGFuY2VvZiBPcnRob2dyYXBoaWNGcnVzdHVtKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB1cGRhdGUyKHRoaXMpOwogICAgICAgIHVwZGF0ZTIob3RoZXIpOwogICAgICAgIHJldHVybiB0aGlzLndpZHRoID09PSBvdGhlci53aWR0aCAmJiB0aGlzLmFzcGVjdFJhdGlvID09PSBvdGhlci5hc3BlY3RSYXRpbyAmJiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLmVxdWFscyhvdGhlci5fb2ZmQ2VudGVyRnJ1c3R1bSk7CiAgICAgIH07CiAgICAgIE9ydGhvZ3JhcGhpY0ZydXN0dW0ucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihvdGhlciwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvdGhlcikgfHwgIShvdGhlciBpbnN0YW5jZW9mIE9ydGhvZ3JhcGhpY0ZydXN0dW0pKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHVwZGF0ZTIodGhpcyk7CiAgICAgICAgdXBkYXRlMihvdGhlcik7CiAgICAgICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy53aWR0aCwKICAgICAgICAgIG90aGVyLndpZHRoLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMuYXNwZWN0UmF0aW8sCiAgICAgICAgICBvdGhlci5hc3BlY3RSYXRpbywKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgb3RoZXIuX29mZkNlbnRlckZydXN0dW0sCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApOwogICAgICB9OwogICAgICBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQgPSBPcnRob2dyYXBoaWNGcnVzdHVtOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtLmpzCiAgZnVuY3Rpb24gUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgdGhpcy5sZWZ0ID0gb3B0aW9ucy5sZWZ0OwogICAgdGhpcy5fbGVmdCA9IHZvaWQgMDsKICAgIHRoaXMucmlnaHQgPSBvcHRpb25zLnJpZ2h0OwogICAgdGhpcy5fcmlnaHQgPSB2b2lkIDA7CiAgICB0aGlzLnRvcCA9IG9wdGlvbnMudG9wOwogICAgdGhpcy5fdG9wID0gdm9pZCAwOwogICAgdGhpcy5ib3R0b20gPSBvcHRpb25zLmJvdHRvbTsKICAgIHRoaXMuX2JvdHRvbSA9IHZvaWQgMDsKICAgIHRoaXMubmVhciA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubmVhciwgMSk7CiAgICB0aGlzLl9uZWFyID0gdGhpcy5uZWFyOwogICAgdGhpcy5mYXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmZhciwgNWU4KTsKICAgIHRoaXMuX2ZhciA9IHRoaXMuZmFyOwogICAgdGhpcy5fY3VsbGluZ1ZvbHVtZSA9IG5ldyBDdWxsaW5nVm9sdW1lX2RlZmF1bHQoKTsKICAgIHRoaXMuX3BlcnNwZWN0aXZlTWF0cml4ID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgdGhpcy5faW5maW5pdGVQZXJzcGVjdGl2ZSA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICB9CiAgZnVuY3Rpb24gdXBkYXRlMyhmcnVzdHVtKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLnJpZ2h0KSB8fCAhZGVmaW5lZF9kZWZhdWx0KGZydXN0dW0ubGVmdCkgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLnRvcCkgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLmJvdHRvbSkgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLm5lYXIpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5mYXIpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJyaWdodCwgbGVmdCwgdG9wLCBib3R0b20sIG5lYXIsIG9yIGZhciBwYXJhbWV0ZXJzIGFyZSBub3Qgc2V0LiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IHQgPSBmcnVzdHVtLnRvcDsKICAgIGNvbnN0IGIgPSBmcnVzdHVtLmJvdHRvbTsKICAgIGNvbnN0IHIgPSBmcnVzdHVtLnJpZ2h0OwogICAgY29uc3QgbCA9IGZydXN0dW0ubGVmdDsKICAgIGNvbnN0IG4gPSBmcnVzdHVtLm5lYXI7CiAgICBjb25zdCBmID0gZnJ1c3R1bS5mYXI7CiAgICBpZiAodCAhPT0gZnJ1c3R1bS5fdG9wIHx8IGIgIT09IGZydXN0dW0uX2JvdHRvbSB8fCBsICE9PSBmcnVzdHVtLl9sZWZ0IHx8IHIgIT09IGZydXN0dW0uX3JpZ2h0IHx8IG4gIT09IGZydXN0dW0uX25lYXIgfHwgZiAhPT0gZnJ1c3R1bS5fZmFyKSB7CiAgICAgIGlmIChmcnVzdHVtLm5lYXIgPD0gMCB8fCBmcnVzdHVtLm5lYXIgPiBmcnVzdHVtLmZhcikgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgIm5lYXIgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVybyBhbmQgbGVzcyB0aGFuIGZhci4iCiAgICAgICAgKTsKICAgICAgfQogICAgICBmcnVzdHVtLl9sZWZ0ID0gbDsKICAgICAgZnJ1c3R1bS5fcmlnaHQgPSByOwogICAgICBmcnVzdHVtLl90b3AgPSB0OwogICAgICBmcnVzdHVtLl9ib3R0b20gPSBiOwogICAgICBmcnVzdHVtLl9uZWFyID0gbjsKICAgICAgZnJ1c3R1bS5fZmFyID0gZjsKICAgICAgZnJ1c3R1bS5fcGVyc3BlY3RpdmVNYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQuY29tcHV0ZVBlcnNwZWN0aXZlT2ZmQ2VudGVyKAogICAgICAgIGwsCiAgICAgICAgciwKICAgICAgICBiLAogICAgICAgIHQsCiAgICAgICAgbiwKICAgICAgICBmLAogICAgICAgIGZydXN0dW0uX3BlcnNwZWN0aXZlTWF0cml4CiAgICAgICk7CiAgICAgIGZydXN0dW0uX2luZmluaXRlUGVyc3BlY3RpdmUgPSBNYXRyaXg0X2RlZmF1bHQuY29tcHV0ZUluZmluaXRlUGVyc3BlY3RpdmVPZmZDZW50ZXIoCiAgICAgICAgbCwKICAgICAgICByLAogICAgICAgIGIsCiAgICAgICAgdCwKICAgICAgICBuLAogICAgICAgIGZydXN0dW0uX2luZmluaXRlUGVyc3BlY3RpdmUKICAgICAgKTsKICAgIH0KICB9CiAgdmFyIGdldFBsYW5lc1JpZ2h0MiwgZ2V0UGxhbmVzTmVhckNlbnRlcjIsIGdldFBsYW5lc0ZhckNlbnRlciwgZ2V0UGxhbmVzTm9ybWFsLCBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW1fZGVmYXVsdDsKICB2YXIgaW5pdF9QZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRlc2lhbjQoKTsKICAgICAgaW5pdF9DdWxsaW5nVm9sdW1lKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHBlcnNwZWN0aXZlIHByb2plY3Rpb24gbWF0cml4IGNvbXB1dGVkIGZyb20gdGhlIHZpZXcgZnJ1c3R1bS4KICAgICAgICAgKiBAbWVtYmVyb2YgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtNYXRyaXg0fQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqCiAgICAgICAgICogQHNlZSBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0jaW5maW5pdGVQcm9qZWN0aW9uTWF0cml4CiAgICAgICAgICovCiAgICAgICAgcHJvamVjdGlvbk1hdHJpeDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlMyh0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BlcnNwZWN0aXZlTWF0cml4OwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgcGVyc3BlY3RpdmUgcHJvamVjdGlvbiBtYXRyaXggY29tcHV0ZWQgZnJvbSB0aGUgdmlldyBmcnVzdHVtIHdpdGggYW4gaW5maW5pdGUgZmFyIHBsYW5lLgogICAgICAgICAqIEBtZW1iZXJvZiBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0ucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge01hdHJpeDR9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICoKICAgICAgICAgKiBAc2VlIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bSNwcm9qZWN0aW9uTWF0cml4CiAgICAgICAgICovCiAgICAgICAgaW5maW5pdGVQcm9qZWN0aW9uTWF0cml4OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGUzKHRoaXMpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5faW5maW5pdGVQZXJzcGVjdGl2ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBnZXRQbGFuZXNSaWdodDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGdldFBsYW5lc05lYXJDZW50ZXIyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBnZXRQbGFuZXNGYXJDZW50ZXIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGdldFBsYW5lc05vcm1hbCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZS5jb21wdXRlQ3VsbGluZ1ZvbHVtZSA9IGZ1bmN0aW9uKHBvc2l0aW9uLCBkaXJlY3Rpb24yLCB1cCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9uKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBvc2l0aW9uIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChkaXJlY3Rpb24yKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRpcmVjdGlvbiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodXApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidXAgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBsYW5lcyA9IHRoaXMuX2N1bGxpbmdWb2x1bWUucGxhbmVzOwogICAgICAgIGNvbnN0IHQgPSB0aGlzLnRvcDsKICAgICAgICBjb25zdCBiID0gdGhpcy5ib3R0b207CiAgICAgICAgY29uc3QgciA9IHRoaXMucmlnaHQ7CiAgICAgICAgY29uc3QgbCA9IHRoaXMubGVmdDsKICAgICAgICBjb25zdCBuID0gdGhpcy5uZWFyOwogICAgICAgIGNvbnN0IGYgPSB0aGlzLmZhcjsKICAgICAgICBjb25zdCByaWdodCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhkaXJlY3Rpb24yLCB1cCwgZ2V0UGxhbmVzUmlnaHQyKTsKICAgICAgICBjb25zdCBuZWFyQ2VudGVyID0gZ2V0UGxhbmVzTmVhckNlbnRlcjI7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoZGlyZWN0aW9uMiwgbiwgbmVhckNlbnRlcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgbmVhckNlbnRlciwgbmVhckNlbnRlcik7CiAgICAgICAgY29uc3QgZmFyQ2VudGVyID0gZ2V0UGxhbmVzRmFyQ2VudGVyOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKGRpcmVjdGlvbjIsIGYsIGZhckNlbnRlcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgZmFyQ2VudGVyLCBmYXJDZW50ZXIpOwogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBnZXRQbGFuZXNOb3JtYWw7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIocmlnaHQsIGwsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobmVhckNlbnRlciwgbm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5vcm1hbDIsIHBvc2l0aW9uLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCB1cCwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBsZXQgcGxhbmUgPSBwbGFuZXNbMF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1swXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IG5vcm1hbDIueDsKICAgICAgICBwbGFuZS55ID0gbm9ybWFsMi55OwogICAgICAgIHBsYW5lLnogPSBub3JtYWwyLno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIHBvc2l0aW9uKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihyaWdodCwgciwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChuZWFyQ2VudGVyLCBub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3Qobm9ybWFsMiwgcG9zaXRpb24sIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyh1cCwgbm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1sxXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzFdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gbm9ybWFsMi54OwogICAgICAgIHBsYW5lLnkgPSBub3JtYWwyLnk7CiAgICAgICAgcGxhbmUueiA9IG5vcm1hbDIuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgcG9zaXRpb24pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKHVwLCBiLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG5lYXJDZW50ZXIsIG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChub3JtYWwyLCBwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHJpZ2h0LCBub3JtYWwyLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKG5vcm1hbDIsIG5vcm1hbDIpOwogICAgICAgIHBsYW5lID0gcGxhbmVzWzJdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBsYW5lKSkgewogICAgICAgICAgcGxhbmUgPSBwbGFuZXNbMl0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIHBsYW5lLnggPSBub3JtYWwyLng7CiAgICAgICAgcGxhbmUueSA9IG5vcm1hbDIueTsKICAgICAgICBwbGFuZS56ID0gbm9ybWFsMi56OwogICAgICAgIHBsYW5lLncgPSAtQ2FydGVzaWFuM19kZWZhdWx0LmRvdChub3JtYWwyLCBwb3NpdGlvbik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIodXAsIHQsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQobmVhckNlbnRlciwgbm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5vcm1hbDIsIHBvc2l0aW9uLCBub3JtYWwyKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3Mobm9ybWFsMiwgcmlnaHQsIG5vcm1hbDIpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUobm9ybWFsMiwgbm9ybWFsMik7CiAgICAgICAgcGxhbmUgPSBwbGFuZXNbM107CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocGxhbmUpKSB7CiAgICAgICAgICBwbGFuZSA9IHBsYW5lc1szXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgcGxhbmUueCA9IG5vcm1hbDIueDsKICAgICAgICBwbGFuZS55ID0gbm9ybWFsMi55OwogICAgICAgIHBsYW5lLnogPSBub3JtYWwyLno7CiAgICAgICAgcGxhbmUudyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KG5vcm1hbDIsIHBvc2l0aW9uKTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1s0XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzRdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gZGlyZWN0aW9uMi54OwogICAgICAgIHBsYW5lLnkgPSBkaXJlY3Rpb24yLnk7CiAgICAgICAgcGxhbmUueiA9IGRpcmVjdGlvbjIuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMiwgbmVhckNlbnRlcik7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShkaXJlY3Rpb24yLCBub3JtYWwyKTsKICAgICAgICBwbGFuZSA9IHBsYW5lc1s1XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwbGFuZSkpIHsKICAgICAgICAgIHBsYW5lID0gcGxhbmVzWzVdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBwbGFuZS54ID0gbm9ybWFsMi54OwogICAgICAgIHBsYW5lLnkgPSBub3JtYWwyLnk7CiAgICAgICAgcGxhbmUueiA9IG5vcm1hbDIuejsKICAgICAgICBwbGFuZS53ID0gLUNhcnRlc2lhbjNfZGVmYXVsdC5kb3Qobm9ybWFsMiwgZmFyQ2VudGVyKTsKICAgICAgICByZXR1cm4gdGhpcy5fY3VsbGluZ1ZvbHVtZTsKICAgICAgfTsKICAgICAgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZS5nZXRQaXhlbERpbWVuc2lvbnMgPSBmdW5jdGlvbihkcmF3aW5nQnVmZmVyV2lkdGgsIGRyYXdpbmdCdWZmZXJIZWlnaHQsIGRpc3RhbmNlLCBwaXhlbFJhdGlvLCByZXN1bHQpIHsKICAgICAgICB1cGRhdGUzKHRoaXMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRyYXdpbmdCdWZmZXJXaWR0aCkgfHwgIWRlZmluZWRfZGVmYXVsdChkcmF3aW5nQnVmZmVySGVpZ2h0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJCb3RoIGRyYXdpbmdCdWZmZXJXaWR0aCBhbmQgZHJhd2luZ0J1ZmZlckhlaWdodCBhcmUgcmVxdWlyZWQuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRyYXdpbmdCdWZmZXJXaWR0aCA8PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiZHJhd2luZ0J1ZmZlcldpZHRoIG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICAgICAgfQogICAgICAgIGlmIChkcmF3aW5nQnVmZmVySGVpZ2h0IDw9IDApIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJkcmF3aW5nQnVmZmVySGVpZ2h0IG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGRpc3RhbmNlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImRpc3RhbmNlIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwaXhlbFJhdGlvKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBpeGVsUmF0aW8gaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKHBpeGVsUmF0aW8gPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInBpeGVsUmF0aW8gbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIkEgcmVzdWx0IG9iamVjdCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW52ZXJzZU5lYXIgPSAxIC8gdGhpcy5uZWFyOwogICAgICAgIGxldCB0YW5UaGV0YSA9IHRoaXMudG9wICogaW52ZXJzZU5lYXI7CiAgICAgICAgY29uc3QgcGl4ZWxIZWlnaHQgPSAyICogcGl4ZWxSYXRpbyAqIGRpc3RhbmNlICogdGFuVGhldGEgLyBkcmF3aW5nQnVmZmVySGVpZ2h0OwogICAgICAgIHRhblRoZXRhID0gdGhpcy5yaWdodCAqIGludmVyc2VOZWFyOwogICAgICAgIGNvbnN0IHBpeGVsV2lkdGggPSAyICogcGl4ZWxSYXRpbyAqIGRpc3RhbmNlICogdGFuVGhldGEgLyBkcmF3aW5nQnVmZmVyV2lkdGg7CiAgICAgICAgcmVzdWx0LnggPSBwaXhlbFdpZHRoOwogICAgICAgIHJlc3VsdC55ID0gcGl4ZWxIZWlnaHQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0oKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnJpZ2h0ID0gdGhpcy5yaWdodDsKICAgICAgICByZXN1bHQubGVmdCA9IHRoaXMubGVmdDsKICAgICAgICByZXN1bHQudG9wID0gdGhpcy50b3A7CiAgICAgICAgcmVzdWx0LmJvdHRvbSA9IHRoaXMuYm90dG9tOwogICAgICAgIHJlc3VsdC5uZWFyID0gdGhpcy5uZWFyOwogICAgICAgIHJlc3VsdC5mYXIgPSB0aGlzLmZhcjsKICAgICAgICByZXN1bHQuX2xlZnQgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9yaWdodCA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX3RvcCA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX2JvdHRvbSA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX25lYXIgPSB2b2lkIDA7CiAgICAgICAgcmVzdWx0Ll9mYXIgPSB2b2lkIDA7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihvdGhlcikgewogICAgICAgIHJldHVybiBkZWZpbmVkX2RlZmF1bHQob3RoZXIpICYmIG90aGVyIGluc3RhbmNlb2YgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtICYmIHRoaXMucmlnaHQgPT09IG90aGVyLnJpZ2h0ICYmIHRoaXMubGVmdCA9PT0gb3RoZXIubGVmdCAmJiB0aGlzLnRvcCA9PT0gb3RoZXIudG9wICYmIHRoaXMuYm90dG9tID09PSBvdGhlci5ib3R0b20gJiYgdGhpcy5uZWFyID09PSBvdGhlci5uZWFyICYmIHRoaXMuZmFyID09PSBvdGhlci5mYXI7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bS5wcm90b3R5cGUuZXF1YWxzRXBzaWxvbiA9IGZ1bmN0aW9uKG90aGVyLCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgICAgIHJldHVybiBvdGhlciA9PT0gdGhpcyB8fCBkZWZpbmVkX2RlZmF1bHQob3RoZXIpICYmIG90aGVyIGluc3RhbmNlb2YgUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5yaWdodCwKICAgICAgICAgIG90aGVyLnJpZ2h0LAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHRoaXMubGVmdCwKICAgICAgICAgIG90aGVyLmxlZnQsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy50b3AsCiAgICAgICAgICBvdGhlci50b3AsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5ib3R0b20sCiAgICAgICAgICBvdGhlci5ib3R0b20sCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5uZWFyLAogICAgICAgICAgb3RoZXIubmVhciwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICB0aGlzLmZhciwKICAgICAgICAgIG90aGVyLmZhciwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICk7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlT2ZmQ2VudGVyRnJ1c3R1bV9kZWZhdWx0ID0gUGVyc3BlY3RpdmVPZmZDZW50ZXJGcnVzdHVtOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUGVyc3BlY3RpdmVGcnVzdHVtLmpzCiAgZnVuY3Rpb24gUGVyc3BlY3RpdmVGcnVzdHVtKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bSA9IG5ldyBQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW1fZGVmYXVsdCgpOwogICAgdGhpcy5mb3YgPSBvcHRpb25zLmZvdjsKICAgIHRoaXMuX2ZvdiA9IHZvaWQgMDsKICAgIHRoaXMuX2ZvdnkgPSB2b2lkIDA7CiAgICB0aGlzLl9zc2VEZW5vbWluYXRvciA9IHZvaWQgMDsKICAgIHRoaXMuYXNwZWN0UmF0aW8gPSBvcHRpb25zLmFzcGVjdFJhdGlvOwogICAgdGhpcy5fYXNwZWN0UmF0aW8gPSB2b2lkIDA7CiAgICB0aGlzLm5lYXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm5lYXIsIDEpOwogICAgdGhpcy5fbmVhciA9IHRoaXMubmVhcjsKICAgIHRoaXMuZmFyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5mYXIsIDVlOCk7CiAgICB0aGlzLl9mYXIgPSB0aGlzLmZhcjsKICAgIHRoaXMueE9mZnNldCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMueE9mZnNldCwgMCk7CiAgICB0aGlzLl94T2Zmc2V0ID0gdGhpcy54T2Zmc2V0OwogICAgdGhpcy55T2Zmc2V0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy55T2Zmc2V0LCAwKTsKICAgIHRoaXMuX3lPZmZzZXQgPSB0aGlzLnlPZmZzZXQ7CiAgfQogIGZ1bmN0aW9uIHVwZGF0ZTQoZnJ1c3R1bSkgewogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5mb3YpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5hc3BlY3RSYXRpbykgfHwgIWRlZmluZWRfZGVmYXVsdChmcnVzdHVtLm5lYXIpIHx8ICFkZWZpbmVkX2RlZmF1bHQoZnJ1c3R1bS5mYXIpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJmb3YsIGFzcGVjdFJhdGlvLCBuZWFyLCBvciBmYXIgcGFyYW1ldGVycyBhcmUgbm90IHNldC4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBmID0gZnJ1c3R1bS5fb2ZmQ2VudGVyRnJ1c3R1bTsKICAgIGlmIChmcnVzdHVtLmZvdiAhPT0gZnJ1c3R1bS5fZm92IHx8IGZydXN0dW0uYXNwZWN0UmF0aW8gIT09IGZydXN0dW0uX2FzcGVjdFJhdGlvIHx8IGZydXN0dW0ubmVhciAhPT0gZnJ1c3R1bS5fbmVhciB8fCBmcnVzdHVtLmZhciAhPT0gZnJ1c3R1bS5fZmFyIHx8IGZydXN0dW0ueE9mZnNldCAhPT0gZnJ1c3R1bS5feE9mZnNldCB8fCBmcnVzdHVtLnlPZmZzZXQgIT09IGZydXN0dW0uX3lPZmZzZXQpIHsKICAgICAgaWYgKGZydXN0dW0uZm92IDwgMCB8fCBmcnVzdHVtLmZvdiA+PSBNYXRoLlBJKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImZvdiBtdXN0IGJlIGluIHRoZSByYW5nZSBbMCwgUEkpLiIpOwogICAgICB9CiAgICAgIGlmIChmcnVzdHVtLmFzcGVjdFJhdGlvIDwgMCkgewogICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhc3BlY3RSYXRpbyBtdXN0IGJlIHBvc2l0aXZlLiIpOwogICAgICB9CiAgICAgIGlmIChmcnVzdHVtLm5lYXIgPCAwIHx8IGZydXN0dW0ubmVhciA+IGZydXN0dW0uZmFyKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAibmVhciBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvIGFuZCBsZXNzIHRoYW4gZmFyLiIKICAgICAgICApOwogICAgICB9CiAgICAgIGZydXN0dW0uX2FzcGVjdFJhdGlvID0gZnJ1c3R1bS5hc3BlY3RSYXRpbzsKICAgICAgZnJ1c3R1bS5fZm92ID0gZnJ1c3R1bS5mb3Y7CiAgICAgIGZydXN0dW0uX2ZvdnkgPSBmcnVzdHVtLmFzcGVjdFJhdGlvIDw9IDEgPyBmcnVzdHVtLmZvdiA6IE1hdGguYXRhbihNYXRoLnRhbihmcnVzdHVtLmZvdiAqIDAuNSkgLyBmcnVzdHVtLmFzcGVjdFJhdGlvKSAqIDI7CiAgICAgIGZydXN0dW0uX25lYXIgPSBmcnVzdHVtLm5lYXI7CiAgICAgIGZydXN0dW0uX2ZhciA9IGZydXN0dW0uZmFyOwogICAgICBmcnVzdHVtLl9zc2VEZW5vbWluYXRvciA9IDIgKiBNYXRoLnRhbigwLjUgKiBmcnVzdHVtLl9mb3Z5KTsKICAgICAgZnJ1c3R1bS5feE9mZnNldCA9IGZydXN0dW0ueE9mZnNldDsKICAgICAgZnJ1c3R1bS5feU9mZnNldCA9IGZydXN0dW0ueU9mZnNldDsKICAgICAgZi50b3AgPSBmcnVzdHVtLm5lYXIgKiBNYXRoLnRhbigwLjUgKiBmcnVzdHVtLl9mb3Z5KTsKICAgICAgZi5ib3R0b20gPSAtZi50b3A7CiAgICAgIGYucmlnaHQgPSBmcnVzdHVtLmFzcGVjdFJhdGlvICogZi50b3A7CiAgICAgIGYubGVmdCA9IC1mLnJpZ2h0OwogICAgICBmLm5lYXIgPSBmcnVzdHVtLm5lYXI7CiAgICAgIGYuZmFyID0gZnJ1c3R1bS5mYXI7CiAgICAgIGYucmlnaHQgKz0gZnJ1c3R1bS54T2Zmc2V0OwogICAgICBmLmxlZnQgKz0gZnJ1c3R1bS54T2Zmc2V0OwogICAgICBmLnRvcCArPSBmcnVzdHVtLnlPZmZzZXQ7CiAgICAgIGYuYm90dG9tICs9IGZydXN0dW0ueU9mZnNldDsKICAgIH0KICB9CiAgdmFyIFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0OwogIHZhciBpbml0X1BlcnNwZWN0aXZlRnJ1c3R1bSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUGVyc3BlY3RpdmVGcnVzdHVtLmpzIigpIHsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9QZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW0oKTsKICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtLnBhY2tlZExlbmd0aCA9IDY7CiAgICAgIFBlcnNwZWN0aXZlRnJ1c3R1bS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuZm92OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5hc3BlY3RSYXRpbzsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUubmVhcjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuZmFyOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS54T2Zmc2V0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUueU9mZnNldDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlRnJ1c3R1bS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFBlcnNwZWN0aXZlRnJ1c3R1bSgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuZm92ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuYXNwZWN0UmF0aW8gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5uZWFyID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQuZmFyID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICByZXN1bHQueE9mZnNldCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LnlPZmZzZXQgPSBhcnJheVtzdGFydGluZ0luZGV4XTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhQZXJzcGVjdGl2ZUZydXN0dW0ucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgcGVyc3BlY3RpdmUgcHJvamVjdGlvbiBtYXRyaXggY29tcHV0ZWQgZnJvbSB0aGUgdmlldyBmcnVzdHVtLgogICAgICAgICAqIEBtZW1iZXJvZiBQZXJzcGVjdGl2ZUZydXN0dW0ucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge01hdHJpeDR9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICoKICAgICAgICAgKiBAc2VlIFBlcnNwZWN0aXZlRnJ1c3R1bSNpbmZpbml0ZVByb2plY3Rpb25NYXRyaXgKICAgICAgICAgKi8KICAgICAgICBwcm9qZWN0aW9uTWF0cml4OiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGU0KHRoaXMpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5wcm9qZWN0aW9uTWF0cml4OwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIHBlcnNwZWN0aXZlIHByb2plY3Rpb24gbWF0cml4IGNvbXB1dGVkIGZyb20gdGhlIHZpZXcgZnJ1c3R1bSB3aXRoIGFuIGluZmluaXRlIGZhciBwbGFuZS4KICAgICAgICAgKiBAbWVtYmVyb2YgUGVyc3BlY3RpdmVGcnVzdHVtLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtNYXRyaXg0fQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqCiAgICAgICAgICogQHNlZSBQZXJzcGVjdGl2ZUZydXN0dW0jcHJvamVjdGlvbk1hdHJpeAogICAgICAgICAqLwogICAgICAgIGluZmluaXRlUHJvamVjdGlvbk1hdHJpeDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlNCh0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX29mZkNlbnRlckZydXN0dW0uaW5maW5pdGVQcm9qZWN0aW9uTWF0cml4OwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgYW5nbGUgb2YgdGhlIHZlcnRpY2FsIGZpZWxkIG9mIHZpZXcsIGluIHJhZGlhbnMuCiAgICAgICAgICogQG1lbWJlcm9mIFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqIEBkZWZhdWx0IHVuZGVmaW5lZAogICAgICAgICAqLwogICAgICAgIGZvdnk6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZTQodGhpcyk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9mb3Z5OwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICBzc2VEZW5vbWluYXRvcjogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlNCh0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NzZURlbm9taW5hdG9yOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyB0aGUgb3J0aG9ncmFwaGljIHByb2plY3Rpb24gbWF0cml4IGNvbXB1dGVkIGZyb20gdGhlIHZpZXcgZnJ1c3R1bS4KICAgICAgICAgKiBAbWVtYmVyb2YgUGVyc3BlY3RpdmVGcnVzdHVtLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtQZXJzcGVjdGl2ZU9mZkNlbnRlckZydXN0dW19CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICBvZmZDZW50ZXJGcnVzdHVtOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGU0KHRoaXMpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBQZXJzcGVjdGl2ZUZydXN0dW0ucHJvdG90eXBlLmNvbXB1dGVDdWxsaW5nVm9sdW1lID0gZnVuY3Rpb24ocG9zaXRpb24sIGRpcmVjdGlvbjIsIHVwKSB7CiAgICAgICAgdXBkYXRlNCh0aGlzKTsKICAgICAgICByZXR1cm4gdGhpcy5fb2ZmQ2VudGVyRnJ1c3R1bS5jb21wdXRlQ3VsbGluZ1ZvbHVtZShwb3NpdGlvbiwgZGlyZWN0aW9uMiwgdXApOwogICAgICB9OwogICAgICBQZXJzcGVjdGl2ZUZydXN0dW0ucHJvdG90eXBlLmdldFBpeGVsRGltZW5zaW9ucyA9IGZ1bmN0aW9uKGRyYXdpbmdCdWZmZXJXaWR0aCwgZHJhd2luZ0J1ZmZlckhlaWdodCwgZGlzdGFuY2UsIHBpeGVsUmF0aW8sIHJlc3VsdCkgewogICAgICAgIHVwZGF0ZTQodGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX29mZkNlbnRlckZydXN0dW0uZ2V0UGl4ZWxEaW1lbnNpb25zKAogICAgICAgICAgZHJhd2luZ0J1ZmZlcldpZHRoLAogICAgICAgICAgZHJhd2luZ0J1ZmZlckhlaWdodCwKICAgICAgICAgIGRpc3RhbmNlLAogICAgICAgICAgcGl4ZWxSYXRpbywKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlRnJ1c3R1bS5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUGVyc3BlY3RpdmVGcnVzdHVtKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5hc3BlY3RSYXRpbyA9IHRoaXMuYXNwZWN0UmF0aW87CiAgICAgICAgcmVzdWx0LmZvdiA9IHRoaXMuZm92OwogICAgICAgIHJlc3VsdC5uZWFyID0gdGhpcy5uZWFyOwogICAgICAgIHJlc3VsdC5mYXIgPSB0aGlzLmZhcjsKICAgICAgICByZXN1bHQuX2FzcGVjdFJhdGlvID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fZm92ID0gdm9pZCAwOwogICAgICAgIHJlc3VsdC5fbmVhciA9IHZvaWQgMDsKICAgICAgICByZXN1bHQuX2ZhciA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLmNsb25lKHJlc3VsdC5fb2ZmQ2VudGVyRnJ1c3R1bSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbihvdGhlcikgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG90aGVyKSB8fCAhKG90aGVyIGluc3RhbmNlb2YgUGVyc3BlY3RpdmVGcnVzdHVtKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB1cGRhdGU0KHRoaXMpOwogICAgICAgIHVwZGF0ZTQob3RoZXIpOwogICAgICAgIHJldHVybiB0aGlzLmZvdiA9PT0gb3RoZXIuZm92ICYmIHRoaXMuYXNwZWN0UmF0aW8gPT09IG90aGVyLmFzcGVjdFJhdGlvICYmIHRoaXMuX29mZkNlbnRlckZydXN0dW0uZXF1YWxzKG90aGVyLl9vZmZDZW50ZXJGcnVzdHVtKTsKICAgICAgfTsKICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtLnByb3RvdHlwZS5lcXVhbHNFcHNpbG9uID0gZnVuY3Rpb24ob3RoZXIsIHJlbGF0aXZlRXBzaWxvbiwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3RoZXIpIHx8ICEob3RoZXIgaW5zdGFuY2VvZiBQZXJzcGVjdGl2ZUZydXN0dW0pKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHVwZGF0ZTQodGhpcyk7CiAgICAgICAgdXBkYXRlNChvdGhlcik7CiAgICAgICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5mb3YsCiAgICAgICAgICBvdGhlci5mb3YsCiAgICAgICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICAgICApICYmIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgdGhpcy5hc3BlY3RSYXRpbywKICAgICAgICAgIG90aGVyLmFzcGVjdFJhdGlvLAogICAgICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICAgICAgKSAmJiB0aGlzLl9vZmZDZW50ZXJGcnVzdHVtLmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBvdGhlci5fb2ZmQ2VudGVyRnJ1c3R1bSwKICAgICAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgICAgIGFic29sdXRlRXBzaWxvbgogICAgICAgICk7CiAgICAgIH07CiAgICAgIFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0ID0gUGVyc3BlY3RpdmVGcnVzdHVtOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRnJ1c3R1bUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gRnJ1c3R1bUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucyIsIG9wdGlvbnMpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zLmZydXN0dW0iLCBvcHRpb25zLmZydXN0dW0pOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zLm9yaWdpbiIsIG9wdGlvbnMub3JpZ2luKTsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucy5vcmllbnRhdGlvbiIsIG9wdGlvbnMub3JpZW50YXRpb24pOwogICAgY29uc3QgZnJ1c3R1bSA9IG9wdGlvbnMuZnJ1c3R1bTsKICAgIGNvbnN0IG9yaWVudGF0aW9uID0gb3B0aW9ucy5vcmllbnRhdGlvbjsKICAgIGNvbnN0IG9yaWdpbiA9IG9wdGlvbnMub3JpZ2luOwogICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy52ZXJ0ZXhGb3JtYXQsIFZlcnRleEZvcm1hdF9kZWZhdWx0LkRFRkFVTFQpOwogICAgY29uc3QgZHJhd05lYXJQbGFuZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuX2RyYXdOZWFyUGxhbmUsIHRydWUpOwogICAgbGV0IGZydXN0dW1UeXBlOwogICAgbGV0IGZydXN0dW1QYWNrZWRMZW5ndGg7CiAgICBpZiAoZnJ1c3R1bSBpbnN0YW5jZW9mIFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0KSB7CiAgICAgIGZydXN0dW1UeXBlID0gUEVSU1BFQ1RJVkU7CiAgICAgIGZydXN0dW1QYWNrZWRMZW5ndGggPSBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICB9IGVsc2UgaWYgKGZydXN0dW0gaW5zdGFuY2VvZiBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQpIHsKICAgICAgZnJ1c3R1bVR5cGUgPSBPUlRIT0dSQVBISUM7CiAgICAgIGZydXN0dW1QYWNrZWRMZW5ndGggPSBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgfQogICAgdGhpcy5fZnJ1c3R1bVR5cGUgPSBmcnVzdHVtVHlwZTsKICAgIHRoaXMuX2ZydXN0dW0gPSBmcnVzdHVtLmNsb25lKCk7CiAgICB0aGlzLl9vcmlnaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUob3JpZ2luKTsKICAgIHRoaXMuX29yaWVudGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmNsb25lKG9yaWVudGF0aW9uKTsKICAgIHRoaXMuX2RyYXdOZWFyUGxhbmUgPSBkcmF3TmVhclBsYW5lOwogICAgdGhpcy5fdmVydGV4Rm9ybWF0ID0gdmVydGV4Rm9ybWF0OwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVGcnVzdHVtR2VvbWV0cnkiOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSAyICsgZnJ1c3R1bVBhY2tlZExlbmd0aCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBRdWF0ZXJuaW9uX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogIH0KICBmdW5jdGlvbiBnZXRBdHRyaWJ1dGVzKG9mZnNldCwgbm9ybWFscywgdGFuZ2VudHMsIGJpdGFuZ2VudHMsIHN0LCBub3JtYWwyLCB0YW5nZW50LCBiaXRhbmdlbnQpIHsKICAgIGNvbnN0IHN0T2Zmc2V0ID0gb2Zmc2V0IC8gMyAqIDI7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7ICsraSkgewogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG5vcm1hbHMpKSB7CiAgICAgICAgbm9ybWFsc1tvZmZzZXRdID0gbm9ybWFsMi54OwogICAgICAgIG5vcm1hbHNbb2Zmc2V0ICsgMV0gPSBub3JtYWwyLnk7CiAgICAgICAgbm9ybWFsc1tvZmZzZXQgKyAyXSA9IG5vcm1hbDIuejsKICAgICAgfQogICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRhbmdlbnRzKSkgewogICAgICAgIHRhbmdlbnRzW29mZnNldF0gPSB0YW5nZW50Lng7CiAgICAgICAgdGFuZ2VudHNbb2Zmc2V0ICsgMV0gPSB0YW5nZW50Lnk7CiAgICAgICAgdGFuZ2VudHNbb2Zmc2V0ICsgMl0gPSB0YW5nZW50Lno7CiAgICAgIH0KICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChiaXRhbmdlbnRzKSkgewogICAgICAgIGJpdGFuZ2VudHNbb2Zmc2V0XSA9IGJpdGFuZ2VudC54OwogICAgICAgIGJpdGFuZ2VudHNbb2Zmc2V0ICsgMV0gPSBiaXRhbmdlbnQueTsKICAgICAgICBiaXRhbmdlbnRzW29mZnNldCArIDJdID0gYml0YW5nZW50Lno7CiAgICAgIH0KICAgICAgb2Zmc2V0ICs9IDM7CiAgICB9CiAgICBzdFtzdE9mZnNldF0gPSAwOwogICAgc3Rbc3RPZmZzZXQgKyAxXSA9IDA7CiAgICBzdFtzdE9mZnNldCArIDJdID0gMTsKICAgIHN0W3N0T2Zmc2V0ICsgM10gPSAwOwogICAgc3Rbc3RPZmZzZXQgKyA0XSA9IDE7CiAgICBzdFtzdE9mZnNldCArIDVdID0gMTsKICAgIHN0W3N0T2Zmc2V0ICsgNl0gPSAwOwogICAgc3Rbc3RPZmZzZXQgKyA3XSA9IDE7CiAgfQogIHZhciBQRVJTUEVDVElWRSwgT1JUSE9HUkFQSElDLCBzY3JhdGNoUGFja1BlcnNwZWN0aXZlLCBzY3JhdGNoUGFja09ydGhvZ3JhcGhpYywgc2NyYXRjaFBhY2tRdWF0ZXJuaW9uLCBzY3JhdGNoUGFja29yaWdpbiwgc2NyYXRjaFZlcnRleEZvcm1hdDcsIHNjcmF0Y2hSb3RhdGlvbk1hdHJpeCwgc2NyYXRjaFZpZXdNYXRyaXgsIHNjcmF0Y2hJbnZlcnNlTWF0cml4LCBzY3JhdGNoWERpcmVjdGlvbiwgc2NyYXRjaFlEaXJlY3Rpb24sIHNjcmF0Y2haRGlyZWN0aW9uLCBzY3JhdGNoTmVnYXRpdmVYLCBzY3JhdGNoTmVnYXRpdmVZLCBzY3JhdGNoTmVnYXRpdmVaLCBmcnVzdHVtU3BsaXRzLCBmcnVzdHVtQ29ybmVyc05EQywgc2NyYXRjaEZydXN0dW1Db3JuZXJzLCBGcnVzdHVtR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9GcnVzdHVtR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ZydXN0dW1HZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuNCgpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfT3J0aG9ncmFwaGljRnJ1c3R1bSgpOwogICAgICBpbml0X1BlcnNwZWN0aXZlRnJ1c3R1bSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9RdWF0ZXJuaW9uKCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIFBFUlNQRUNUSVZFID0gMDsKICAgICAgT1JUSE9HUkFQSElDID0gMTsKICAgICAgRnJ1c3R1bUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGZydXN0dW1UeXBlID0gdmFsdWUuX2ZydXN0dW1UeXBlOwogICAgICAgIGNvbnN0IGZydXN0dW0gPSB2YWx1ZS5fZnJ1c3R1bTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gZnJ1c3R1bVR5cGU7CiAgICAgICAgaWYgKGZydXN0dW1UeXBlID09PSBQRVJTUEVDVElWRSkgewogICAgICAgICAgUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQucGFjayhmcnVzdHVtLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgICBzdGFydGluZ0luZGV4ICs9IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0LnBhY2soZnJ1c3R1bSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgICAgc3RhcnRpbmdJbmRleCArPSBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIH0KICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2YWx1ZS5fb3JpZ2luLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIFF1YXRlcm5pb25fZGVmYXVsdC5wYWNrKHZhbHVlLl9vcmllbnRhdGlvbiwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gUXVhdGVybmlvbl9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9kcmF3TmVhclBsYW5lID8gMSA6IDA7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoUGFja1BlcnNwZWN0aXZlID0gbmV3IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQYWNrT3J0aG9ncmFwaGljID0gbmV3IE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUGFja1F1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQYWNrb3JpZ2luID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0NyA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBGcnVzdHVtR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IGZydXN0dW1UeXBlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBsZXQgZnJ1c3R1bTsKICAgICAgICBpZiAoZnJ1c3R1bVR5cGUgPT09IFBFUlNQRUNUSVZFKSB7CiAgICAgICAgICBmcnVzdHVtID0gUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICBhcnJheSwKICAgICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgICAgc2NyYXRjaFBhY2tQZXJzcGVjdGl2ZQogICAgICAgICAgKTsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcnVzdHVtID0gT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgYXJyYXksCiAgICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICAgIHNjcmF0Y2hQYWNrT3J0aG9ncmFwaGljCiAgICAgICAgICApOwogICAgICAgICAgc3RhcnRpbmdJbmRleCArPSBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIH0KICAgICAgICBjb25zdCBvcmlnaW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoUGFja29yaWdpbik7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IG9yaWVudGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hQYWNrUXVhdGVybmlvbgogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBRdWF0ZXJuaW9uX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ3CiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBkcmF3TmVhclBsYW5lID0gYXJyYXlbc3RhcnRpbmdJbmRleF0gPT09IDE7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBGcnVzdHVtR2VvbWV0cnkoewogICAgICAgICAgICBmcnVzdHVtLAogICAgICAgICAgICBvcmlnaW4sCiAgICAgICAgICAgIG9yaWVudGF0aW9uLAogICAgICAgICAgICB2ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICAgIF9kcmF3TmVhclBsYW5lOiBkcmF3TmVhclBsYW5lCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZnJ1c3R1bVJlc3VsdCA9IGZydXN0dW1UeXBlID09PSByZXN1bHQuX2ZydXN0dW1UeXBlID8gcmVzdWx0Ll9mcnVzdHVtIDogdm9pZCAwOwogICAgICAgIHJlc3VsdC5fZnJ1c3R1bSA9IGZydXN0dW0uY2xvbmUoZnJ1c3R1bVJlc3VsdCk7CiAgICAgICAgcmVzdWx0Ll9mcnVzdHVtVHlwZSA9IGZydXN0dW1UeXBlOwogICAgICAgIHJlc3VsdC5fb3JpZ2luID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG9yaWdpbiwgcmVzdWx0Ll9vcmlnaW4pOwogICAgICAgIHJlc3VsdC5fb3JpZW50YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuY2xvbmUob3JpZW50YXRpb24sIHJlc3VsdC5fb3JpZW50YXRpb24pOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9kcmF3TmVhclBsYW5lID0gZHJhd05lYXJQbGFuZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoUm90YXRpb25NYXRyaXggPSBuZXcgTWF0cml4M19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hWaWV3TWF0cml4ID0gbmV3IE1hdHJpeDRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoSW52ZXJzZU1hdHJpeCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFhEaXJlY3Rpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hZRGlyZWN0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoWkRpcmVjdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5lZ2F0aXZlWCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5lZ2F0aXZlWSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5lZ2F0aXZlWiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZnJ1c3R1bVNwbGl0cyA9IG5ldyBBcnJheSgzKTsKICAgICAgZnJ1c3R1bUNvcm5lcnNOREMgPSBuZXcgQXJyYXkoNCk7CiAgICAgIGZydXN0dW1Db3JuZXJzTkRDWzBdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgtMSwgLTEsIDEsIDEpOwogICAgICBmcnVzdHVtQ29ybmVyc05EQ1sxXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoMSwgLTEsIDEsIDEpOwogICAgICBmcnVzdHVtQ29ybmVyc05EQ1syXSA9IG5ldyBDYXJ0ZXNpYW40X2RlZmF1bHQoMSwgMSwgMSwgMSk7CiAgICAgIGZydXN0dW1Db3JuZXJzTkRDWzNdID0gbmV3IENhcnRlc2lhbjRfZGVmYXVsdCgtMSwgMSwgMSwgMSk7CiAgICAgIHNjcmF0Y2hGcnVzdHVtQ29ybmVycyA9IG5ldyBBcnJheSg0KTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyArK2kpIHsKICAgICAgICBzY3JhdGNoRnJ1c3R1bUNvcm5lcnNbaV0gPSBuZXcgQ2FydGVzaWFuNF9kZWZhdWx0KCk7CiAgICAgIH0KICAgICAgRnJ1c3R1bUdlb21ldHJ5Ll9jb21wdXRlTmVhckZhclBsYW5lcyA9IGZ1bmN0aW9uKG9yaWdpbiwgb3JpZW50YXRpb24sIGZydXN0dW1UeXBlLCBmcnVzdHVtLCBwb3NpdGlvbnMsIHhEaXJlY3Rpb24sIHlEaXJlY3Rpb24sIHpEaXJlY3Rpb24pIHsKICAgICAgICBjb25zdCByb3RhdGlvbk1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbigKICAgICAgICAgIG9yaWVudGF0aW9uLAogICAgICAgICAgc2NyYXRjaFJvdGF0aW9uTWF0cml4CiAgICAgICAgKTsKICAgICAgICBsZXQgeCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHhEaXJlY3Rpb24sIHNjcmF0Y2hYRGlyZWN0aW9uKTsKICAgICAgICBsZXQgeSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHlEaXJlY3Rpb24sIHNjcmF0Y2hZRGlyZWN0aW9uKTsKICAgICAgICBsZXQgeiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHpEaXJlY3Rpb24sIHNjcmF0Y2haRGlyZWN0aW9uKTsKICAgICAgICB4ID0gTWF0cml4M19kZWZhdWx0LmdldENvbHVtbihyb3RhdGlvbk1hdHJpeCwgMCwgeCk7CiAgICAgICAgeSA9IE1hdHJpeDNfZGVmYXVsdC5nZXRDb2x1bW4ocm90YXRpb25NYXRyaXgsIDEsIHkpOwogICAgICAgIHogPSBNYXRyaXgzX2RlZmF1bHQuZ2V0Q29sdW1uKHJvdGF0aW9uTWF0cml4LCAyLCB6KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHgsIHgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoeSwgeSk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh6LCB6KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHgsIHgpOwogICAgICAgIGNvbnN0IHZpZXcgPSBNYXRyaXg0X2RlZmF1bHQuY29tcHV0ZVZpZXcob3JpZ2luLCB6LCB5LCB4LCBzY3JhdGNoVmlld01hdHJpeCk7CiAgICAgICAgbGV0IGludmVyc2VWaWV3OwogICAgICAgIGxldCBpbnZlcnNlVmlld1Byb2plY3Rpb247CiAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IGZydXN0dW0ucHJvamVjdGlvbk1hdHJpeDsKICAgICAgICBpZiAoZnJ1c3R1bVR5cGUgPT09IFBFUlNQRUNUSVZFKSB7CiAgICAgICAgICBjb25zdCB2aWV3UHJvamVjdGlvbiA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseSgKICAgICAgICAgICAgcHJvamVjdGlvbiwKICAgICAgICAgICAgdmlldywKICAgICAgICAgICAgc2NyYXRjaEludmVyc2VNYXRyaXgKICAgICAgICAgICk7CiAgICAgICAgICBpbnZlcnNlVmlld1Byb2plY3Rpb24gPSBNYXRyaXg0X2RlZmF1bHQuaW52ZXJzZSgKICAgICAgICAgICAgdmlld1Byb2plY3Rpb24sCiAgICAgICAgICAgIHNjcmF0Y2hJbnZlcnNlTWF0cml4CiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpbnZlcnNlVmlldyA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24odmlldywgc2NyYXRjaEludmVyc2VNYXRyaXgpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGludmVyc2VWaWV3UHJvamVjdGlvbikpIHsKICAgICAgICAgIGZydXN0dW1TcGxpdHNbMF0gPSBmcnVzdHVtLm5lYXI7CiAgICAgICAgICBmcnVzdHVtU3BsaXRzWzFdID0gZnJ1c3R1bS5mYXI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZydXN0dW1TcGxpdHNbMF0gPSAwOwogICAgICAgICAgZnJ1c3R1bVNwbGl0c1sxXSA9IGZydXN0dW0ubmVhcjsKICAgICAgICAgIGZydXN0dW1TcGxpdHNbMl0gPSBmcnVzdHVtLmZhcjsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyOyArK2kpIHsKICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgNDsgKytqKSB7CiAgICAgICAgICAgIGxldCBjb3JuZXIgPSBDYXJ0ZXNpYW40X2RlZmF1bHQuY2xvbmUoCiAgICAgICAgICAgICAgZnJ1c3R1bUNvcm5lcnNORENbal0sCiAgICAgICAgICAgICAgc2NyYXRjaEZydXN0dW1Db3JuZXJzW2pdCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGludmVyc2VWaWV3UHJvamVjdGlvbikpIHsKICAgICAgICAgICAgICBjb25zdCBvZmZDZW50ZXJGcnVzdHVtID0gZnJ1c3R1bS5vZmZDZW50ZXJGcnVzdHVtOwogICAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2ZmQ2VudGVyRnJ1c3R1bSkpIHsKICAgICAgICAgICAgICAgIGZydXN0dW0gPSBvZmZDZW50ZXJGcnVzdHVtOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCBuZWFyID0gZnJ1c3R1bVNwbGl0c1tpXTsKICAgICAgICAgICAgICBjb25zdCBmYXIgPSBmcnVzdHVtU3BsaXRzW2kgKyAxXTsKICAgICAgICAgICAgICBjb3JuZXIueCA9IChjb3JuZXIueCAqIChmcnVzdHVtLnJpZ2h0IC0gZnJ1c3R1bS5sZWZ0KSArIGZydXN0dW0ubGVmdCArIGZydXN0dW0ucmlnaHQpICogMC41OwogICAgICAgICAgICAgIGNvcm5lci55ID0gKGNvcm5lci55ICogKGZydXN0dW0udG9wIC0gZnJ1c3R1bS5ib3R0b20pICsgZnJ1c3R1bS5ib3R0b20gKyBmcnVzdHVtLnRvcCkgKiAwLjU7CiAgICAgICAgICAgICAgY29ybmVyLnogPSAoY29ybmVyLnogKiAobmVhciAtIGZhcikgLSBuZWFyIC0gZmFyKSAqIDAuNTsKICAgICAgICAgICAgICBjb3JuZXIudyA9IDE7CiAgICAgICAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoaW52ZXJzZVZpZXcsIGNvcm5lciwgY29ybmVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb3JuZXIgPSBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcigKICAgICAgICAgICAgICAgIGludmVyc2VWaWV3UHJvamVjdGlvbiwKICAgICAgICAgICAgICAgIGNvcm5lciwKICAgICAgICAgICAgICAgIGNvcm5lcgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgY29uc3QgdyA9IDEgLyBjb3JuZXIudzsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihjb3JuZXIsIHcsIGNvcm5lcik7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGNvcm5lciwgb3JpZ2luLCBjb3JuZXIpOwogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoY29ybmVyLCBjb3JuZXIpOwogICAgICAgICAgICAgIGNvbnN0IGZhYyA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoeiwgY29ybmVyKTsKICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihjb3JuZXIsIGZydXN0dW1TcGxpdHNbaV0gLyBmYWMsIGNvcm5lcik7CiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChjb3JuZXIsIG9yaWdpbiwgY29ybmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwb3NpdGlvbnNbMTIgKiBpICsgaiAqIDNdID0gY29ybmVyLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxMiAqIGkgKyBqICogMyArIDFdID0gY29ybmVyLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1sxMiAqIGkgKyBqICogMyArIDJdID0gY29ybmVyLno7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgICBGcnVzdHVtR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihmcnVzdHVtR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCBmcnVzdHVtVHlwZSA9IGZydXN0dW1HZW9tZXRyeS5fZnJ1c3R1bVR5cGU7CiAgICAgICAgY29uc3QgZnJ1c3R1bSA9IGZydXN0dW1HZW9tZXRyeS5fZnJ1c3R1bTsKICAgICAgICBjb25zdCBvcmlnaW4gPSBmcnVzdHVtR2VvbWV0cnkuX29yaWdpbjsKICAgICAgICBjb25zdCBvcmllbnRhdGlvbiA9IGZydXN0dW1HZW9tZXRyeS5fb3JpZW50YXRpb247CiAgICAgICAgY29uc3QgZHJhd05lYXJQbGFuZSA9IGZydXN0dW1HZW9tZXRyeS5fZHJhd05lYXJQbGFuZTsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBmcnVzdHVtR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBjb25zdCBudW1iZXJPZlBsYW5lcyA9IGRyYXdOZWFyUGxhbmUgPyA2IDogNTsKICAgICAgICBsZXQgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSgzICogNCAqIDYpOwogICAgICAgIEZydXN0dW1HZW9tZXRyeS5fY29tcHV0ZU5lYXJGYXJQbGFuZXMoCiAgICAgICAgICBvcmlnaW4sCiAgICAgICAgICBvcmllbnRhdGlvbiwKICAgICAgICAgIGZydXN0dW1UeXBlLAogICAgICAgICAgZnJ1c3R1bSwKICAgICAgICAgIHBvc2l0aW9ucwogICAgICAgICk7CiAgICAgICAgbGV0IG9mZnNldCA9IDMgKiA0ICogMjsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0XSA9IHBvc2l0aW9uc1szICogNF07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDFdID0gcG9zaXRpb25zWzMgKiA0ICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDJdID0gcG9zaXRpb25zWzMgKiA0ICsgMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDNdID0gcG9zaXRpb25zWzBdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA0XSA9IHBvc2l0aW9uc1sxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNV0gPSBwb3NpdGlvbnNbMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDZdID0gcG9zaXRpb25zWzMgKiAzXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgN10gPSBwb3NpdGlvbnNbMyAqIDMgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgOF0gPSBwb3NpdGlvbnNbMyAqIDMgKyAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgOV0gPSBwb3NpdGlvbnNbMyAqIDddOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxMF0gPSBwb3NpdGlvbnNbMyAqIDcgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMTFdID0gcG9zaXRpb25zWzMgKiA3ICsgMl07CiAgICAgICAgb2Zmc2V0ICs9IDMgKiA0OwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXRdID0gcG9zaXRpb25zWzMgKiA1XTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMV0gPSBwb3NpdGlvbnNbMyAqIDUgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMl0gPSBwb3NpdGlvbnNbMyAqIDUgKyAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgM10gPSBwb3NpdGlvbnNbM107CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDRdID0gcG9zaXRpb25zWzMgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgNV0gPSBwb3NpdGlvbnNbMyArIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA2XSA9IHBvc2l0aW9uc1swXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgN10gPSBwb3NpdGlvbnNbMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDhdID0gcG9zaXRpb25zWzJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA5XSA9IHBvc2l0aW9uc1szICogNF07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDEwXSA9IHBvc2l0aW9uc1szICogNCArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxMV0gPSBwb3NpdGlvbnNbMyAqIDQgKyAyXTsKICAgICAgICBvZmZzZXQgKz0gMyAqIDQ7CiAgICAgICAgcG9zaXRpb25zW29mZnNldF0gPSBwb3NpdGlvbnNbM107CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDFdID0gcG9zaXRpb25zWzMgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMl0gPSBwb3NpdGlvbnNbMyArIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAzXSA9IHBvc2l0aW9uc1szICogNV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDRdID0gcG9zaXRpb25zWzMgKiA1ICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDVdID0gcG9zaXRpb25zWzMgKiA1ICsgMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDZdID0gcG9zaXRpb25zWzMgKiA2XTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgN10gPSBwb3NpdGlvbnNbMyAqIDYgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgOF0gPSBwb3NpdGlvbnNbMyAqIDYgKyAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgOV0gPSBwb3NpdGlvbnNbMyAqIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyAxMF0gPSBwb3NpdGlvbnNbMyAqIDIgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMTFdID0gcG9zaXRpb25zWzMgKiAyICsgMl07CiAgICAgICAgb2Zmc2V0ICs9IDMgKiA0OwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXRdID0gcG9zaXRpb25zWzMgKiAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMV0gPSBwb3NpdGlvbnNbMyAqIDIgKyAxXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMl0gPSBwb3NpdGlvbnNbMyAqIDIgKyAyXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgM10gPSBwb3NpdGlvbnNbMyAqIDZdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA0XSA9IHBvc2l0aW9uc1szICogNiArIDFdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA1XSA9IHBvc2l0aW9uc1szICogNiArIDJdOwogICAgICAgIHBvc2l0aW9uc1tvZmZzZXQgKyA2XSA9IHBvc2l0aW9uc1szICogN107CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDddID0gcG9zaXRpb25zWzMgKiA3ICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDhdID0gcG9zaXRpb25zWzMgKiA3ICsgMl07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDldID0gcG9zaXRpb25zWzMgKiAzXTsKICAgICAgICBwb3NpdGlvbnNbb2Zmc2V0ICsgMTBdID0gcG9zaXRpb25zWzMgKiAzICsgMV07CiAgICAgICAgcG9zaXRpb25zW29mZnNldCArIDExXSA9IHBvc2l0aW9uc1szICogMyArIDJdOwogICAgICAgIGlmICghZHJhd05lYXJQbGFuZSkgewogICAgICAgICAgcG9zaXRpb25zID0gcG9zaXRpb25zLnN1YmFycmF5KDMgKiA0KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgICB9KQogICAgICAgIH0pOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodmVydGV4Rm9ybWF0Lm5vcm1hbCkgfHwgZGVmaW5lZF9kZWZhdWx0KHZlcnRleEZvcm1hdC50YW5nZW50KSB8fCBkZWZpbmVkX2RlZmF1bHQodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgfHwgZGVmaW5lZF9kZWZhdWx0KHZlcnRleEZvcm1hdC5zdCkpIHsKICAgICAgICAgIGNvbnN0IG5vcm1hbHMgPSBkZWZpbmVkX2RlZmF1bHQodmVydGV4Rm9ybWF0Lm5vcm1hbCkgPyBuZXcgRmxvYXQzMkFycmF5KDMgKiA0ICogbnVtYmVyT2ZQbGFuZXMpIDogdm9pZCAwOwogICAgICAgICAgY29uc3QgdGFuZ2VudHMgPSBkZWZpbmVkX2RlZmF1bHQodmVydGV4Rm9ybWF0LnRhbmdlbnQpID8gbmV3IEZsb2F0MzJBcnJheSgzICogNCAqIG51bWJlck9mUGxhbmVzKSA6IHZvaWQgMDsKICAgICAgICAgIGNvbnN0IGJpdGFuZ2VudHMgPSBkZWZpbmVkX2RlZmF1bHQodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgPyBuZXcgRmxvYXQzMkFycmF5KDMgKiA0ICogbnVtYmVyT2ZQbGFuZXMpIDogdm9pZCAwOwogICAgICAgICAgY29uc3Qgc3QgPSBkZWZpbmVkX2RlZmF1bHQodmVydGV4Rm9ybWF0LnN0KSA/IG5ldyBGbG9hdDMyQXJyYXkoMiAqIDQgKiBudW1iZXJPZlBsYW5lcykgOiB2b2lkIDA7CiAgICAgICAgICBjb25zdCB4ID0gc2NyYXRjaFhEaXJlY3Rpb247CiAgICAgICAgICBjb25zdCB5ID0gc2NyYXRjaFlEaXJlY3Rpb247CiAgICAgICAgICBjb25zdCB6ID0gc2NyYXRjaFpEaXJlY3Rpb247CiAgICAgICAgICBjb25zdCBuZWdhdGl2ZVgyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSh4LCBzY3JhdGNoTmVnYXRpdmVYKTsKICAgICAgICAgIGNvbnN0IG5lZ2F0aXZlWSA9IENhcnRlc2lhbjNfZGVmYXVsdC5uZWdhdGUoeSwgc2NyYXRjaE5lZ2F0aXZlWSk7CiAgICAgICAgICBjb25zdCBuZWdhdGl2ZVogPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHosIHNjcmF0Y2hOZWdhdGl2ZVopOwogICAgICAgICAgb2Zmc2V0ID0gMDsKICAgICAgICAgIGlmIChkcmF3TmVhclBsYW5lKSB7CiAgICAgICAgICAgIGdldEF0dHJpYnV0ZXMob2Zmc2V0LCBub3JtYWxzLCB0YW5nZW50cywgYml0YW5nZW50cywgc3QsIG5lZ2F0aXZlWiwgeCwgeSk7CiAgICAgICAgICAgIG9mZnNldCArPSAzICogNDsKICAgICAgICAgIH0KICAgICAgICAgIGdldEF0dHJpYnV0ZXMob2Zmc2V0LCBub3JtYWxzLCB0YW5nZW50cywgYml0YW5nZW50cywgc3QsIHosIG5lZ2F0aXZlWDIsIHkpOwogICAgICAgICAgb2Zmc2V0ICs9IDMgKiA0OwogICAgICAgICAgZ2V0QXR0cmlidXRlcygKICAgICAgICAgICAgb2Zmc2V0LAogICAgICAgICAgICBub3JtYWxzLAogICAgICAgICAgICB0YW5nZW50cywKICAgICAgICAgICAgYml0YW5nZW50cywKICAgICAgICAgICAgc3QsCiAgICAgICAgICAgIG5lZ2F0aXZlWDIsCiAgICAgICAgICAgIG5lZ2F0aXZlWiwKICAgICAgICAgICAgeQogICAgICAgICAgKTsKICAgICAgICAgIG9mZnNldCArPSAzICogNDsKICAgICAgICAgIGdldEF0dHJpYnV0ZXMoCiAgICAgICAgICAgIG9mZnNldCwKICAgICAgICAgICAgbm9ybWFscywKICAgICAgICAgICAgdGFuZ2VudHMsCiAgICAgICAgICAgIGJpdGFuZ2VudHMsCiAgICAgICAgICAgIHN0LAogICAgICAgICAgICBuZWdhdGl2ZVksCiAgICAgICAgICAgIG5lZ2F0aXZlWiwKICAgICAgICAgICAgbmVnYXRpdmVYMgogICAgICAgICAgKTsKICAgICAgICAgIG9mZnNldCArPSAzICogNDsKICAgICAgICAgIGdldEF0dHJpYnV0ZXMob2Zmc2V0LCBub3JtYWxzLCB0YW5nZW50cywgYml0YW5nZW50cywgc3QsIHgsIHosIHkpOwogICAgICAgICAgb2Zmc2V0ICs9IDMgKiA0OwogICAgICAgICAgZ2V0QXR0cmlidXRlcyhvZmZzZXQsIG5vcm1hbHMsIHRhbmdlbnRzLCBiaXRhbmdlbnRzLCBzdCwgeSwgeiwgbmVnYXRpdmVYMik7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG5vcm1hbHMpKSB7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBub3JtYWxzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0YW5nZW50cykpIHsKICAgICAgICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYml0YW5nZW50cykpIHsKICAgICAgICAgICAgYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN0KSkgewogICAgICAgICAgICBhdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgICAgICAgdmFsdWVzOiBzdAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheSg2ICogbnVtYmVyT2ZQbGFuZXMpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtYmVyT2ZQbGFuZXM7ICsraSkgewogICAgICAgICAgY29uc3QgaW5kZXhPZmZzZXQgPSBpICogNjsKICAgICAgICAgIGNvbnN0IGluZGV4ID0gaSAqIDQ7CiAgICAgICAgICBpbmRpY2VzW2luZGV4T2Zmc2V0XSA9IGluZGV4OwogICAgICAgICAgaW5kaWNlc1tpbmRleE9mZnNldCArIDFdID0gaW5kZXggKyAxOwogICAgICAgICAgaW5kaWNlc1tpbmRleE9mZnNldCArIDJdID0gaW5kZXggKyAyOwogICAgICAgICAgaW5kaWNlc1tpbmRleE9mZnNldCArIDNdID0gaW5kZXg7CiAgICAgICAgICBpbmRpY2VzW2luZGV4T2Zmc2V0ICsgNF0gPSBpbmRleCArIDI7CiAgICAgICAgICBpbmRpY2VzW2luZGV4T2Zmc2V0ICsgNV0gPSBpbmRleCArIDM7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMocG9zaXRpb25zKQogICAgICAgIH0pOwogICAgICB9OwogICAgICBGcnVzdHVtR2VvbWV0cnlfZGVmYXVsdCA9IEZydXN0dW1HZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUZydXN0dW1HZW9tZXRyeS5qcwogIHZhciBjcmVhdGVGcnVzdHVtR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUZydXN0dW1HZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVGcnVzdHVtR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZUZydXN0dW1HZW9tZXRyeShmcnVzdHVtR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGZydXN0dW1HZW9tZXRyeSA9IEZydXN0dW1HZW9tZXRyeV9kZWZhdWx0LnVucGFjayhmcnVzdHVtR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gRnJ1c3R1bUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoZnJ1c3R1bUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZUZydXN0dW1HZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUZydXN0dW1HZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlRnJ1c3R1bUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRnJ1c3R1bUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZUZydXN0dW1HZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlRnJ1c3R1bUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvRnJ1c3R1bU91dGxpbmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIEZydXN0dW1PdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zIiwgb3B0aW9ucyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMuZnJ1c3R1bSIsIG9wdGlvbnMuZnJ1c3R1bSk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMub3JpZ2luIiwgb3B0aW9ucy5vcmlnaW4pOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zLm9yaWVudGF0aW9uIiwgb3B0aW9ucy5vcmllbnRhdGlvbik7CiAgICBjb25zdCBmcnVzdHVtID0gb3B0aW9ucy5mcnVzdHVtOwogICAgY29uc3Qgb3JpZW50YXRpb24gPSBvcHRpb25zLm9yaWVudGF0aW9uOwogICAgY29uc3Qgb3JpZ2luID0gb3B0aW9ucy5vcmlnaW47CiAgICBjb25zdCBkcmF3TmVhclBsYW5lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5fZHJhd05lYXJQbGFuZSwgdHJ1ZSk7CiAgICBsZXQgZnJ1c3R1bVR5cGU7CiAgICBsZXQgZnJ1c3R1bVBhY2tlZExlbmd0aDsKICAgIGlmIChmcnVzdHVtIGluc3RhbmNlb2YgUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQpIHsKICAgICAgZnJ1c3R1bVR5cGUgPSBQRVJTUEVDVElWRTI7CiAgICAgIGZydXN0dW1QYWNrZWRMZW5ndGggPSBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICB9IGVsc2UgaWYgKGZydXN0dW0gaW5zdGFuY2VvZiBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQpIHsKICAgICAgZnJ1c3R1bVR5cGUgPSBPUlRIT0dSQVBISUMyOwogICAgICBmcnVzdHVtUGFja2VkTGVuZ3RoID0gT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIH0KICAgIHRoaXMuX2ZydXN0dW1UeXBlID0gZnJ1c3R1bVR5cGU7CiAgICB0aGlzLl9mcnVzdHVtID0gZnJ1c3R1bS5jbG9uZSgpOwogICAgdGhpcy5fb3JpZ2luID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKG9yaWdpbik7CiAgICB0aGlzLl9vcmllbnRhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5jbG9uZShvcmllbnRhdGlvbik7CiAgICB0aGlzLl9kcmF3TmVhclBsYW5lID0gZHJhd05lYXJQbGFuZTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeSI7CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IDIgKyBmcnVzdHVtUGFja2VkTGVuZ3RoICsgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIFF1YXRlcm5pb25fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgfQogIHZhciBQRVJTUEVDVElWRTIsIE9SVEhPR1JBUEhJQzIsIHNjcmF0Y2hQYWNrUGVyc3BlY3RpdmUyLCBzY3JhdGNoUGFja09ydGhvZ3JhcGhpYzIsIHNjcmF0Y2hQYWNrUXVhdGVybmlvbjIsIHNjcmF0Y2hQYWNrb3JpZ2luMiwgRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X0ZydXN0dW1PdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0ZydXN0dW1PdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRnJ1c3R1bUdlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X09ydGhvZ3JhcGhpY0ZydXN0dW0oKTsKICAgICAgaW5pdF9QZXJzcGVjdGl2ZUZydXN0dW0oKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfUXVhdGVybmlvbigpOwogICAgICBQRVJTUEVDVElWRTIgPSAwOwogICAgICBPUlRIT0dSQVBISUMyID0gMTsKICAgICAgRnJ1c3R1bU91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBmcnVzdHVtVHlwZSA9IHZhbHVlLl9mcnVzdHVtVHlwZTsKICAgICAgICBjb25zdCBmcnVzdHVtID0gdmFsdWUuX2ZydXN0dW07CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGZydXN0dW1UeXBlOwogICAgICAgIGlmIChmcnVzdHVtVHlwZSA9PT0gUEVSU1BFQ1RJVkUyKSB7CiAgICAgICAgICBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdC5wYWNrKGZydXN0dW0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQucGFjayhmcnVzdHVtLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgICBzdGFydGluZ0luZGV4ICs9IE9ydGhvZ3JhcGhpY0ZydXN0dW1fZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZhbHVlLl9vcmlnaW4sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgUXVhdGVybmlvbl9kZWZhdWx0LnBhY2sodmFsdWUuX29yaWVudGF0aW9uLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBRdWF0ZXJuaW9uX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUuX2RyYXdOZWFyUGxhbmUgPyAxIDogMDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hQYWNrUGVyc3BlY3RpdmUyID0gbmV3IFBlcnNwZWN0aXZlRnJ1c3R1bV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQYWNrT3J0aG9ncmFwaGljMiA9IG5ldyBPcnRob2dyYXBoaWNGcnVzdHVtX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBhY2tRdWF0ZXJuaW9uMiA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBhY2tvcmlnaW4yID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBGcnVzdHVtT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBjb25zdCBmcnVzdHVtVHlwZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgbGV0IGZydXN0dW07CiAgICAgICAgaWYgKGZydXN0dW1UeXBlID09PSBQRVJTUEVDVElWRTIpIHsKICAgICAgICAgIGZydXN0dW0gPSBQZXJzcGVjdGl2ZUZydXN0dW1fZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgIGFycmF5LAogICAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgICBzY3JhdGNoUGFja1BlcnNwZWN0aXZlMgogICAgICAgICAgKTsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gUGVyc3BlY3RpdmVGcnVzdHVtX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcnVzdHVtID0gT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgYXJyYXksCiAgICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICAgIHNjcmF0Y2hQYWNrT3J0aG9ncmFwaGljMgogICAgICAgICAgKTsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gT3J0aG9ncmFwaGljRnJ1c3R1bV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb3JpZ2luID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaFBhY2tvcmlnaW4yKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3Qgb3JpZW50YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFBhY2tRdWF0ZXJuaW9uMgogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBRdWF0ZXJuaW9uX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGRyYXdOZWFyUGxhbmUgPSBhcnJheVtzdGFydGluZ0luZGV4XSA9PT0gMTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEZydXN0dW1PdXRsaW5lR2VvbWV0cnkoewogICAgICAgICAgICBmcnVzdHVtLAogICAgICAgICAgICBvcmlnaW4sCiAgICAgICAgICAgIG9yaWVudGF0aW9uLAogICAgICAgICAgICBfZHJhd05lYXJQbGFuZTogZHJhd05lYXJQbGFuZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGZydXN0dW1SZXN1bHQgPSBmcnVzdHVtVHlwZSA9PT0gcmVzdWx0Ll9mcnVzdHVtVHlwZSA/IHJlc3VsdC5fZnJ1c3R1bSA6IHZvaWQgMDsKICAgICAgICByZXN1bHQuX2ZydXN0dW0gPSBmcnVzdHVtLmNsb25lKGZydXN0dW1SZXN1bHQpOwogICAgICAgIHJlc3VsdC5fZnJ1c3R1bVR5cGUgPSBmcnVzdHVtVHlwZTsKICAgICAgICByZXN1bHQuX29yaWdpbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShvcmlnaW4sIHJlc3VsdC5fb3JpZ2luKTsKICAgICAgICByZXN1bHQuX29yaWVudGF0aW9uID0gUXVhdGVybmlvbl9kZWZhdWx0LmNsb25lKG9yaWVudGF0aW9uLCByZXN1bHQuX29yaWVudGF0aW9uKTsKICAgICAgICByZXN1bHQuX2RyYXdOZWFyUGxhbmUgPSBkcmF3TmVhclBsYW5lOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEZydXN0dW1PdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihmcnVzdHVtR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCBmcnVzdHVtVHlwZSA9IGZydXN0dW1HZW9tZXRyeS5fZnJ1c3R1bVR5cGU7CiAgICAgICAgY29uc3QgZnJ1c3R1bSA9IGZydXN0dW1HZW9tZXRyeS5fZnJ1c3R1bTsKICAgICAgICBjb25zdCBvcmlnaW4gPSBmcnVzdHVtR2VvbWV0cnkuX29yaWdpbjsKICAgICAgICBjb25zdCBvcmllbnRhdGlvbiA9IGZydXN0dW1HZW9tZXRyeS5fb3JpZW50YXRpb247CiAgICAgICAgY29uc3QgZHJhd05lYXJQbGFuZSA9IGZydXN0dW1HZW9tZXRyeS5fZHJhd05lYXJQbGFuZTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KDMgKiA0ICogMik7CiAgICAgICAgRnJ1c3R1bUdlb21ldHJ5X2RlZmF1bHQuX2NvbXB1dGVOZWFyRmFyUGxhbmVzKAogICAgICAgICAgb3JpZ2luLAogICAgICAgICAgb3JpZW50YXRpb24sCiAgICAgICAgICBmcnVzdHVtVHlwZSwKICAgICAgICAgIGZydXN0dW0sCiAgICAgICAgICBwb3NpdGlvbnMKICAgICAgICApOwogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoewogICAgICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgICAgfSkKICAgICAgICB9KTsKICAgICAgICBsZXQgb2Zmc2V0OwogICAgICAgIGxldCBpbmRleDsKICAgICAgICBjb25zdCBudW1iZXJPZlBsYW5lcyA9IGRyYXdOZWFyUGxhbmUgPyAyIDogMTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KDggKiAobnVtYmVyT2ZQbGFuZXMgKyAxKSk7CiAgICAgICAgbGV0IGkgPSBkcmF3TmVhclBsYW5lID8gMCA6IDE7CiAgICAgICAgZm9yICg7IGkgPCAyOyArK2kpIHsKICAgICAgICAgIG9mZnNldCA9IGRyYXdOZWFyUGxhbmUgPyBpICogOCA6IDA7CiAgICAgICAgICBpbmRleCA9IGkgKiA0OwogICAgICAgICAgaW5kaWNlc1tvZmZzZXRdID0gaW5kZXg7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDFdID0gaW5kZXggKyAxOwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyAyXSA9IGluZGV4ICsgMTsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgM10gPSBpbmRleCArIDI7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDRdID0gaW5kZXggKyAyOwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyA1XSA9IGluZGV4ICsgMzsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgNl0gPSBpbmRleCArIDM7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDddID0gaW5kZXg7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDA7IGkgPCAyOyArK2kpIHsKICAgICAgICAgIG9mZnNldCA9IChudW1iZXJPZlBsYW5lcyArIGkpICogODsKICAgICAgICAgIGluZGV4ID0gaSAqIDQ7CiAgICAgICAgICBpbmRpY2VzW29mZnNldF0gPSBpbmRleDsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgMV0gPSBpbmRleCArIDQ7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDJdID0gaW5kZXggKyAxOwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyAzXSA9IGluZGV4ICsgNTsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgNF0gPSBpbmRleCArIDI7CiAgICAgICAgICBpbmRpY2VzW29mZnNldCArIDVdID0gaW5kZXggKyA2OwogICAgICAgICAgaW5kaWNlc1tvZmZzZXQgKyA2XSA9IGluZGV4ICsgMzsKICAgICAgICAgIGluZGljZXNbb2Zmc2V0ICsgN10gPSBpbmRleCArIDc7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcyhwb3NpdGlvbnMpCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIEZydXN0dW1PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IEZydXN0dW1PdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeShmcnVzdHVtR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIGZydXN0dW1HZW9tZXRyeSA9IEZydXN0dW1PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soZnJ1c3R1bUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIEZydXN0dW1PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShmcnVzdHVtR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlRnJ1c3R1bU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9GcnVzdHVtT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9HZW9ncmFwaGljVGlsaW5nU2NoZW1lLmpzCiAgZnVuY3Rpb24gR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICB0aGlzLl9yZWN0YW5nbGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJlY3RhbmdsZSwgUmVjdGFuZ2xlX2RlZmF1bHQuTUFYX1ZBTFVFKTsKICAgIHRoaXMuX3Byb2plY3Rpb24gPSBuZXcgR2VvZ3JhcGhpY1Byb2plY3Rpb25fZGVmYXVsdCh0aGlzLl9lbGxpcHNvaWQpOwogICAgdGhpcy5fbnVtYmVyT2ZMZXZlbFplcm9UaWxlc1ggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5udW1iZXJPZkxldmVsWmVyb1RpbGVzWCwKICAgICAgMgogICAgKTsKICAgIHRoaXMuX251bWJlck9mTGV2ZWxaZXJvVGlsZXNZID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMubnVtYmVyT2ZMZXZlbFplcm9UaWxlc1ksCiAgICAgIDEKICAgICk7CiAgfQogIHZhciBHZW9ncmFwaGljVGlsaW5nU2NoZW1lX2RlZmF1bHQ7CiAgdmFyIGluaXRfR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhHZW9ncmFwaGljVGlsaW5nU2NoZW1lLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGVsbGlwc29pZCB0aGF0IGlzIHRpbGVkIGJ5IHRoaXMgdGlsaW5nIHNjaGVtZS4KICAgICAgICAgKiBAbWVtYmVyb2YgR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7RWxsaXBzb2lkfQogICAgICAgICAqLwogICAgICAgIGVsbGlwc29pZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2VsbGlwc29pZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHJlY3RhbmdsZSwgaW4gcmFkaWFucywgY292ZXJlZCBieSB0aGlzIHRpbGluZyBzY2hlbWUuCiAgICAgICAgICogQG1lbWJlcm9mIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge1JlY3RhbmdsZX0KICAgICAgICAgKi8KICAgICAgICByZWN0YW5nbGU6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yZWN0YW5nbGU7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBtYXAgcHJvamVjdGlvbiB1c2VkIGJ5IHRoaXMgdGlsaW5nIHNjaGVtZS4KICAgICAgICAgKiBAbWVtYmVyb2YgR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7TWFwUHJvamVjdGlvbn0KICAgICAgICAgKi8KICAgICAgICBwcm9qZWN0aW9uOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJvamVjdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBHZW9ncmFwaGljVGlsaW5nU2NoZW1lLnByb3RvdHlwZS5nZXROdW1iZXJPZlhUaWxlc0F0TGV2ZWwgPSBmdW5jdGlvbihsZXZlbCkgewogICAgICAgIHJldHVybiB0aGlzLl9udW1iZXJPZkxldmVsWmVyb1RpbGVzWCA8PCBsZXZlbDsKICAgICAgfTsKICAgICAgR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZS5wcm90b3R5cGUuZ2V0TnVtYmVyT2ZZVGlsZXNBdExldmVsID0gZnVuY3Rpb24obGV2ZWwpIHsKICAgICAgICByZXR1cm4gdGhpcy5fbnVtYmVyT2ZMZXZlbFplcm9UaWxlc1kgPDwgbGV2ZWw7CiAgICAgIH07CiAgICAgIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWUucHJvdG90eXBlLnJlY3RhbmdsZVRvTmF0aXZlUmVjdGFuZ2xlID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgY29uc3Qgd2VzdCA9IE1hdGhfZGVmYXVsdC50b0RlZ3JlZXMocmVjdGFuZ2xlLndlc3QpOwogICAgICAgIGNvbnN0IHNvdXRoID0gTWF0aF9kZWZhdWx0LnRvRGVncmVlcyhyZWN0YW5nbGUuc291dGgpOwogICAgICAgIGNvbnN0IGVhc3QgPSBNYXRoX2RlZmF1bHQudG9EZWdyZWVzKHJlY3RhbmdsZS5lYXN0KTsKICAgICAgICBjb25zdCBub3J0aCA9IE1hdGhfZGVmYXVsdC50b0RlZ3JlZXMocmVjdGFuZ2xlLm5vcnRoKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gd2VzdDsKICAgICAgICByZXN1bHQuc291dGggPSBzb3V0aDsKICAgICAgICByZXN1bHQuZWFzdCA9IGVhc3Q7CiAgICAgICAgcmVzdWx0Lm5vcnRoID0gbm9ydGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZS5wcm90b3R5cGUudGlsZVhZVG9OYXRpdmVSZWN0YW5nbGUgPSBmdW5jdGlvbih4LCB5LCBsZXZlbCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlUmFkaWFucyA9IHRoaXMudGlsZVhZVG9SZWN0YW5nbGUoeCwgeSwgbGV2ZWwsIHJlc3VsdCk7CiAgICAgICAgcmVjdGFuZ2xlUmFkaWFucy53ZXN0ID0gTWF0aF9kZWZhdWx0LnRvRGVncmVlcyhyZWN0YW5nbGVSYWRpYW5zLndlc3QpOwogICAgICAgIHJlY3RhbmdsZVJhZGlhbnMuc291dGggPSBNYXRoX2RlZmF1bHQudG9EZWdyZWVzKHJlY3RhbmdsZVJhZGlhbnMuc291dGgpOwogICAgICAgIHJlY3RhbmdsZVJhZGlhbnMuZWFzdCA9IE1hdGhfZGVmYXVsdC50b0RlZ3JlZXMocmVjdGFuZ2xlUmFkaWFucy5lYXN0KTsKICAgICAgICByZWN0YW5nbGVSYWRpYW5zLm5vcnRoID0gTWF0aF9kZWZhdWx0LnRvRGVncmVlcyhyZWN0YW5nbGVSYWRpYW5zLm5vcnRoKTsKICAgICAgICByZXR1cm4gcmVjdGFuZ2xlUmFkaWFuczsKICAgICAgfTsKICAgICAgR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZS5wcm90b3R5cGUudGlsZVhZVG9SZWN0YW5nbGUgPSBmdW5jdGlvbih4LCB5LCBsZXZlbCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlID0gdGhpcy5fcmVjdGFuZ2xlOwogICAgICAgIGNvbnN0IHhUaWxlcyA9IHRoaXMuZ2V0TnVtYmVyT2ZYVGlsZXNBdExldmVsKGxldmVsKTsKICAgICAgICBjb25zdCB5VGlsZXMgPSB0aGlzLmdldE51bWJlck9mWVRpbGVzQXRMZXZlbChsZXZlbCk7CiAgICAgICAgY29uc3QgeFRpbGVXaWR0aCA9IHJlY3RhbmdsZS53aWR0aCAvIHhUaWxlczsKICAgICAgICBjb25zdCB3ZXN0ID0geCAqIHhUaWxlV2lkdGggKyByZWN0YW5nbGUud2VzdDsKICAgICAgICBjb25zdCBlYXN0ID0gKHggKyAxKSAqIHhUaWxlV2lkdGggKyByZWN0YW5nbGUud2VzdDsKICAgICAgICBjb25zdCB5VGlsZUhlaWdodCA9IHJlY3RhbmdsZS5oZWlnaHQgLyB5VGlsZXM7CiAgICAgICAgY29uc3Qgbm9ydGggPSByZWN0YW5nbGUubm9ydGggLSB5ICogeVRpbGVIZWlnaHQ7CiAgICAgICAgY29uc3Qgc291dGggPSByZWN0YW5nbGUubm9ydGggLSAoeSArIDEpICogeVRpbGVIZWlnaHQ7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gd2VzdDsKICAgICAgICByZXN1bHQuc291dGggPSBzb3V0aDsKICAgICAgICByZXN1bHQuZWFzdCA9IGVhc3Q7CiAgICAgICAgcmVzdWx0Lm5vcnRoID0gbm9ydGg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZS5wcm90b3R5cGUucG9zaXRpb25Ub1RpbGVYWSA9IGZ1bmN0aW9uKHBvc2l0aW9uLCBsZXZlbCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlID0gdGhpcy5fcmVjdGFuZ2xlOwogICAgICAgIGlmICghUmVjdGFuZ2xlX2RlZmF1bHQuY29udGFpbnMocmVjdGFuZ2xlLCBwb3NpdGlvbikpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHhUaWxlcyA9IHRoaXMuZ2V0TnVtYmVyT2ZYVGlsZXNBdExldmVsKGxldmVsKTsKICAgICAgICBjb25zdCB5VGlsZXMgPSB0aGlzLmdldE51bWJlck9mWVRpbGVzQXRMZXZlbChsZXZlbCk7CiAgICAgICAgY29uc3QgeFRpbGVXaWR0aCA9IHJlY3RhbmdsZS53aWR0aCAvIHhUaWxlczsKICAgICAgICBjb25zdCB5VGlsZUhlaWdodCA9IHJlY3RhbmdsZS5oZWlnaHQgLyB5VGlsZXM7CiAgICAgICAgbGV0IGxvbmdpdHVkZSA9IHBvc2l0aW9uLmxvbmdpdHVkZTsKICAgICAgICBpZiAocmVjdGFuZ2xlLmVhc3QgPCByZWN0YW5nbGUud2VzdCkgewogICAgICAgICAgbG9uZ2l0dWRlICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgfQogICAgICAgIGxldCB4VGlsZUNvb3JkaW5hdGUgPSAobG9uZ2l0dWRlIC0gcmVjdGFuZ2xlLndlc3QpIC8geFRpbGVXaWR0aCB8IDA7CiAgICAgICAgaWYgKHhUaWxlQ29vcmRpbmF0ZSA+PSB4VGlsZXMpIHsKICAgICAgICAgIHhUaWxlQ29vcmRpbmF0ZSA9IHhUaWxlcyAtIDE7CiAgICAgICAgfQogICAgICAgIGxldCB5VGlsZUNvb3JkaW5hdGUgPSAocmVjdGFuZ2xlLm5vcnRoIC0gcG9zaXRpb24ubGF0aXR1ZGUpIC8geVRpbGVIZWlnaHQgfCAwOwogICAgICAgIGlmICh5VGlsZUNvb3JkaW5hdGUgPj0geVRpbGVzKSB7CiAgICAgICAgICB5VGlsZUNvb3JkaW5hdGUgPSB5VGlsZXMgLSAxOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCh4VGlsZUNvb3JkaW5hdGUsIHlUaWxlQ29vcmRpbmF0ZSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC54ID0geFRpbGVDb29yZGluYXRlOwogICAgICAgIHJlc3VsdC55ID0geVRpbGVDb29yZGluYXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEdlb2dyYXBoaWNUaWxpbmdTY2hlbWVfZGVmYXVsdCA9IEdlb2dyYXBoaWNUaWxpbmdTY2hlbWU7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9BcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLmpzCiAgZnVuY3Rpb24gZ2V0VGlsZVhZTGV2ZWwocmVjdGFuZ2xlKSB7CiAgICBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgcmVjdGFuZ2xlLmVhc3QsCiAgICAgIHJlY3RhbmdsZS5ub3J0aCwKICAgICAgMCwKICAgICAgc2NyYXRjaENvcm5lcnNbMF0KICAgICk7CiAgICBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgcmVjdGFuZ2xlLndlc3QsCiAgICAgIHJlY3RhbmdsZS5ub3J0aCwKICAgICAgMCwKICAgICAgc2NyYXRjaENvcm5lcnNbMV0KICAgICk7CiAgICBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgcmVjdGFuZ2xlLmVhc3QsCiAgICAgIHJlY3RhbmdsZS5zb3V0aCwKICAgICAgMCwKICAgICAgc2NyYXRjaENvcm5lcnNbMl0KICAgICk7CiAgICBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgcmVjdGFuZ2xlLndlc3QsCiAgICAgIHJlY3RhbmdsZS5zb3V0aCwKICAgICAgMCwKICAgICAgc2NyYXRjaENvcm5lcnNbM10KICAgICk7CiAgICBsZXQgbGFzdExldmVsWCA9IDAsIGxhc3RMZXZlbFkgPSAwOwogICAgbGV0IGN1cnJlbnRYID0gMCwgY3VycmVudFkgPSAwOwogICAgY29uc3QgbWF4TGV2ZWwgPSBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl90ZXJyYWluSGVpZ2h0c01heExldmVsOwogICAgbGV0IGk7CiAgICBmb3IgKGkgPSAwOyBpIDw9IG1heExldmVsOyArK2kpIHsKICAgICAgbGV0IGZhaWxlZCA9IGZhbHNlOwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDQ7ICsraikgewogICAgICAgIGNvbnN0IGNvcm5lciA9IHNjcmF0Y2hDb3JuZXJzW2pdOwogICAgICAgIHRpbGluZ1NjaGVtZS5wb3NpdGlvblRvVGlsZVhZKGNvcm5lciwgaSwgc2NyYXRjaFRpbGVYWSk7CiAgICAgICAgaWYgKGogPT09IDApIHsKICAgICAgICAgIGN1cnJlbnRYID0gc2NyYXRjaFRpbGVYWS54OwogICAgICAgICAgY3VycmVudFkgPSBzY3JhdGNoVGlsZVhZLnk7CiAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50WCAhPT0gc2NyYXRjaFRpbGVYWS54IHx8IGN1cnJlbnRZICE9PSBzY3JhdGNoVGlsZVhZLnkpIHsKICAgICAgICAgIGZhaWxlZCA9IHRydWU7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGZhaWxlZCkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGxhc3RMZXZlbFggPSBjdXJyZW50WDsKICAgICAgbGFzdExldmVsWSA9IGN1cnJlbnRZOwogICAgfQogICAgaWYgKGkgPT09IDApIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHg6IGxhc3RMZXZlbFgsCiAgICAgIHk6IGxhc3RMZXZlbFksCiAgICAgIGxldmVsOiBpID4gbWF4TGV2ZWwgPyBtYXhMZXZlbCA6IGkgLSAxCiAgICB9OwogIH0KICB2YXIgc2NyYXRjaERpYWdvbmFsQ2FydGVzaWFuTkUsIHNjcmF0Y2hEaWFnb25hbENhcnRlc2lhblNXLCBzY3JhdGNoRGlhZ29uYWxDYXJ0b2dyYXBoaWMsIHNjcmF0Y2hDZW50ZXJDYXJ0ZXNpYW4sIHNjcmF0Y2hTdXJmYWNlQ2FydGVzaWFuLCBzY3JhdGNoQm91bmRpbmdTcGhlcmUyLCB0aWxpbmdTY2hlbWUsIHNjcmF0Y2hDb3JuZXJzLCBzY3JhdGNoVGlsZVhZLCBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLCBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzX2RlZmF1bHQ7CiAgdmFyIGluaXRfQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9idWlsZE1vZHVsZVVybCgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9ncmFwaGljVGlsaW5nU2NoZW1lKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfUmVzb3VyY2UoKTsKICAgICAgc2NyYXRjaERpYWdvbmFsQ2FydGVzaWFuTkUgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hEaWFnb25hbENhcnRlc2lhblNXID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRGlhZ29uYWxDYXJ0b2dyYXBoaWMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENlbnRlckNhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFN1cmZhY2VDYXJ0ZXNpYW4gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCb3VuZGluZ1NwaGVyZTIgPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICB0aWxpbmdTY2hlbWUgPSBuZXcgR2VvZ3JhcGhpY1RpbGluZ1NjaGVtZV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDb3JuZXJzID0gWwogICAgICAgIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpLAogICAgICAgIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpLAogICAgICAgIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpLAogICAgICAgIG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpCiAgICAgIF07CiAgICAgIHNjcmF0Y2hUaWxlWFkgPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCk7CiAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMgPSB7fTsKICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5pbml0aWFsaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbGV0IGluaXRQcm9taXNlID0gQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5faW5pdFByb21pc2U7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbml0UHJvbWlzZSkpIHsKICAgICAgICAgIHJldHVybiBpbml0UHJvbWlzZTsKICAgICAgICB9CiAgICAgICAgaW5pdFByb21pc2UgPSBSZXNvdXJjZV9kZWZhdWx0LmZldGNoSnNvbigKICAgICAgICAgIGJ1aWxkTW9kdWxlVXJsX2RlZmF1bHQoIkFzc2V0cy9hcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLmpzb24iKQogICAgICAgICkudGhlbihmdW5jdGlvbihqc29uKSB7CiAgICAgICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl90ZXJyYWluSGVpZ2h0cyA9IGpzb247CiAgICAgICAgfSk7CiAgICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5faW5pdFByb21pc2UgPSBpbml0UHJvbWlzZTsKICAgICAgICByZXR1cm4gaW5pdFByb21pc2U7CiAgICAgIH07CiAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuZ2V0TWluaW11bU1heGltdW1IZWlnaHRzID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBlbGxpcHNvaWQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fdGVycmFpbkhlaWdodHMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIllvdSBtdXN0IGNhbGwgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5pbml0aWFsaXplIGFuZCB3YWl0IGZvciB0aGUgcHJvbWlzZSB0byByZXNvbHZlIGJlZm9yZSB1c2luZyB0aGlzIGZ1bmN0aW9uIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgY29uc3QgeHlMZXZlbCA9IGdldFRpbGVYWUxldmVsKHJlY3RhbmdsZSk7CiAgICAgICAgbGV0IG1pblRlcnJhaW5IZWlnaHQgPSBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl9kZWZhdWx0TWluVGVycmFpbkhlaWdodDsKICAgICAgICBsZXQgbWF4VGVycmFpbkhlaWdodCA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2RlZmF1bHRNYXhUZXJyYWluSGVpZ2h0OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoeHlMZXZlbCkpIHsKICAgICAgICAgIGNvbnN0IGtleSA9IGAke3h5TGV2ZWwubGV2ZWx9LSR7eHlMZXZlbC54fS0ke3h5TGV2ZWwueX1gOwogICAgICAgICAgY29uc3QgaGVpZ2h0cyA9IEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX3RlcnJhaW5IZWlnaHRzW2tleV07CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGhlaWdodHMpKSB7CiAgICAgICAgICAgIG1pblRlcnJhaW5IZWlnaHQgPSBoZWlnaHRzWzBdOwogICAgICAgICAgICBtYXhUZXJyYWluSGVpZ2h0ID0gaGVpZ2h0c1sxXTsKICAgICAgICAgIH0KICAgICAgICAgIGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICAgICAgUmVjdGFuZ2xlX2RlZmF1bHQubm9ydGhlYXN0KHJlY3RhbmdsZSwgc2NyYXRjaERpYWdvbmFsQ2FydG9ncmFwaGljKSwKICAgICAgICAgICAgc2NyYXRjaERpYWdvbmFsQ2FydGVzaWFuTkUKICAgICAgICAgICk7CiAgICAgICAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgIFJlY3RhbmdsZV9kZWZhdWx0LnNvdXRod2VzdChyZWN0YW5nbGUsIHNjcmF0Y2hEaWFnb25hbENhcnRvZ3JhcGhpYyksCiAgICAgICAgICAgIHNjcmF0Y2hEaWFnb25hbENhcnRlc2lhblNXCiAgICAgICAgICApOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1pZHBvaW50KAogICAgICAgICAgICBzY3JhdGNoRGlhZ29uYWxDYXJ0ZXNpYW5TVywKICAgICAgICAgICAgc2NyYXRjaERpYWdvbmFsQ2FydGVzaWFuTkUsCiAgICAgICAgICAgIHNjcmF0Y2hDZW50ZXJDYXJ0ZXNpYW4KICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBzdXJmYWNlUG9zaXRpb24gPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZSgKICAgICAgICAgICAgc2NyYXRjaENlbnRlckNhcnRlc2lhbiwKICAgICAgICAgICAgc2NyYXRjaFN1cmZhY2VDYXJ0ZXNpYW4KICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN1cmZhY2VQb3NpdGlvbikpIHsKICAgICAgICAgICAgY29uc3QgZGlzdGFuY2UgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGlzdGFuY2UoCiAgICAgICAgICAgICAgc2NyYXRjaENlbnRlckNhcnRlc2lhbiwKICAgICAgICAgICAgICBzdXJmYWNlUG9zaXRpb24KICAgICAgICAgICAgKTsKICAgICAgICAgICAgbWluVGVycmFpbkhlaWdodCA9IE1hdGgubWluKG1pblRlcnJhaW5IZWlnaHQsIC1kaXN0YW5jZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtaW5UZXJyYWluSGVpZ2h0ID0gQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fZGVmYXVsdE1pblRlcnJhaW5IZWlnaHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIG1pblRlcnJhaW5IZWlnaHQgPSBNYXRoLm1heCgKICAgICAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2RlZmF1bHRNaW5UZXJyYWluSGVpZ2h0LAogICAgICAgICAgbWluVGVycmFpbkhlaWdodAogICAgICAgICk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIG1pbmltdW1UZXJyYWluSGVpZ2h0OiBtaW5UZXJyYWluSGVpZ2h0LAogICAgICAgICAgbWF4aW11bVRlcnJhaW5IZWlnaHQ6IG1heFRlcnJhaW5IZWlnaHQKICAgICAgICB9OwogICAgICB9OwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLmdldEJvdW5kaW5nU3BoZXJlID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBlbGxpcHNvaWQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInJlY3RhbmdsZSIsIHJlY3RhbmdsZSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fdGVycmFpbkhlaWdodHMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAgICAgIllvdSBtdXN0IGNhbGwgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5pbml0aWFsaXplIGFuZCB3YWl0IGZvciB0aGUgcHJvbWlzZSB0byByZXNvbHZlIGJlZm9yZSB1c2luZyB0aGlzIGZ1bmN0aW9uIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgY29uc3QgeHlMZXZlbCA9IGdldFRpbGVYWUxldmVsKHJlY3RhbmdsZSk7CiAgICAgICAgbGV0IG1heFRlcnJhaW5IZWlnaHQgPSBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl9kZWZhdWx0TWF4VGVycmFpbkhlaWdodDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHh5TGV2ZWwpKSB7CiAgICAgICAgICBjb25zdCBrZXkgPSBgJHt4eUxldmVsLmxldmVsfS0ke3h5TGV2ZWwueH0tJHt4eUxldmVsLnl9YDsKICAgICAgICAgIGNvbnN0IGhlaWdodHMgPSBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl90ZXJyYWluSGVpZ2h0c1trZXldOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChoZWlnaHRzKSkgewogICAgICAgICAgICBtYXhUZXJyYWluSGVpZ2h0ID0gaGVpZ2h0c1sxXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgcmVzdWx0ID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUmVjdGFuZ2xlM0QocmVjdGFuZ2xlLCBlbGxpcHNvaWQsIDApOwogICAgICAgIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVJlY3RhbmdsZTNEKAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgbWF4VGVycmFpbkhlaWdodCwKICAgICAgICAgIHNjcmF0Y2hCb3VuZGluZ1NwaGVyZTIKICAgICAgICApOwogICAgICAgIHJldHVybiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnVuaW9uKHJlc3VsdCwgc2NyYXRjaEJvdW5kaW5nU3BoZXJlMiwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cy5fdGVycmFpbkhlaWdodHNNYXhMZXZlbCA9IDY7CiAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX2RlZmF1bHRNYXhUZXJyYWluSGVpZ2h0ID0gOWUzOwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl9kZWZhdWx0TWluVGVycmFpbkhlaWdodCA9IC0xZTU7CiAgICAgIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMuX3RlcnJhaW5IZWlnaHRzID0gdm9pZCAwOwogICAgICBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl9pbml0UHJvbWlzZSA9IHZvaWQgMDsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cywgewogICAgICAgIC8qKgogICAgICAgICAqIERldGVybWluZXMgaWYgdGhlIHRlcnJhaW4gaGVpZ2h0cyBhcmUgaW5pdGlhbGl6ZWQgYW5kIHJlYWR5IHRvIHVzZS4gVG8gaW5pdGlhbGl6ZSB0aGUgdGVycmFpbiBoZWlnaHRzLAogICAgICAgICAqIGNhbGwge0BsaW5rIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMjaW5pdGlhbGl6ZX0gYW5kIHdhaXQgZm9yIHRoZSByZXR1cm5lZCBwcm9taXNlIHRvIHJlc29sdmUuCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICogQG1lbWJlcm9mIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHMKICAgICAgICAgKi8KICAgICAgICBpbml0aWFsaXplZDogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmluZWRfZGVmYXVsdChBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzLl90ZXJyYWluSGVpZ2h0cyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0c19kZWZhdWx0ID0gQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0czsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dyb3VuZFBvbHlsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBHcm91bmRQb2x5bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3QgcG9zaXRpb25zID0gb3B0aW9ucy5wb3NpdGlvbnM7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpIHx8IHBvc2l0aW9ucy5sZW5ndGggPCAyKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJBdCBsZWFzdCB0d28gcG9zaXRpb25zIGFyZSByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5hcmNUeXBlKSAmJiBvcHRpb25zLmFyY1R5cGUgIT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQyAmJiBvcHRpb25zLmFyY1R5cGUgIT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAiVmFsaWQgb3B0aW9ucyBmb3IgYXJjVHlwZSBhcmUgQXJjVHlwZS5HRU9ERVNJQyBhbmQgQXJjVHlwZS5SSFVNQi4iCiAgICAgICk7CiAgICB9CiAgICB0aGlzLndpZHRoID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy53aWR0aCwgMSk7CiAgICB0aGlzLl9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICB0aGlzLmdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5ncmFudWxhcml0eSwgOTk5OSk7CiAgICB0aGlzLmxvb3AgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmxvb3AsIGZhbHNlKTsKICAgIHRoaXMuYXJjVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuYXJjVHlwZSwgQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LldHUzg0OwogICAgdGhpcy5fcHJvamVjdGlvbkluZGV4ID0gMDsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeSI7CiAgICB0aGlzLl9zY2VuZTNET25seSA9IGZhbHNlOwogIH0KICBmdW5jdGlvbiBjb21wdXRlUmlnaHROb3JtYWwoc3RhcnQsIGVuZCwgbWF4SGVpZ2h0LCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgY29uc3Qgc3RhcnRCb3R0b20gPSBnZXRQb3NpdGlvbihlbGxpcHNvaWQsIHN0YXJ0LCAwLCBjYXJ0M1NjcmF0Y2gxKTsKICAgIGNvbnN0IHN0YXJ0VG9wID0gZ2V0UG9zaXRpb24oZWxsaXBzb2lkLCBzdGFydCwgbWF4SGVpZ2h0LCBjYXJ0M1NjcmF0Y2gyKTsKICAgIGNvbnN0IGVuZEJvdHRvbSA9IGdldFBvc2l0aW9uKGVsbGlwc29pZCwgZW5kLCAwLCBjYXJ0M1NjcmF0Y2gzKTsKICAgIGNvbnN0IHVwID0gZGlyZWN0aW9uKHN0YXJ0VG9wLCBzdGFydEJvdHRvbSwgY2FydDNTY3JhdGNoMik7CiAgICBjb25zdCBmb3J3YXJkID0gZGlyZWN0aW9uKGVuZEJvdHRvbSwgc3RhcnRCb3R0b20sIGNhcnQzU2NyYXRjaDMpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGZvcndhcmQsIHVwLCByZXN1bHQpOwogICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogIH0KICBmdW5jdGlvbiBpbnRlcnBvbGF0ZVNlZ21lbnQoc3RhcnQsIGVuZCwgbWluSGVpZ2h0LCBtYXhIZWlnaHQsIGdyYW51bGFyaXR5LCBhcmNUeXBlLCBlbGxpcHNvaWQsIG5vcm1hbHNBcnJheSwgYm90dG9tUG9zaXRpb25zQXJyYXksIHRvcFBvc2l0aW9uc0FycmF5LCBjYXJ0b2dyYXBoaWNzQXJyYXkpIHsKICAgIGlmIChncmFudWxhcml0eSA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBsZXQgZWxsaXBzb2lkTGluZTsKICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgZWxsaXBzb2lkTGluZSA9IG5ldyBFbGxpcHNvaWRHZW9kZXNpY19kZWZhdWx0KHN0YXJ0LCBlbmQsIGVsbGlwc29pZCk7CiAgICB9IGVsc2UgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICBlbGxpcHNvaWRMaW5lID0gbmV3IEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0KHN0YXJ0LCBlbmQsIGVsbGlwc29pZCk7CiAgICB9CiAgICBjb25zdCBzdXJmYWNlRGlzdGFuY2UgPSBlbGxpcHNvaWRMaW5lLnN1cmZhY2VEaXN0YW5jZTsKICAgIGlmIChzdXJmYWNlRGlzdGFuY2UgPCBncmFudWxhcml0eSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBpbnRlcnBvbGF0ZWROb3JtYWwgPSBjb21wdXRlUmlnaHROb3JtYWwoCiAgICAgIHN0YXJ0LAogICAgICBlbmQsCiAgICAgIG1heEhlaWdodCwKICAgICAgZWxsaXBzb2lkLAogICAgICBpbnRlcnBvbGF0ZWROb3JtYWxTY3JhdGNoCiAgICApOwogICAgY29uc3Qgc2VnbWVudHMgPSBNYXRoLmNlaWwoc3VyZmFjZURpc3RhbmNlIC8gZ3JhbnVsYXJpdHkpOwogICAgY29uc3QgaW50ZXJwb2ludERpc3RhbmNlID0gc3VyZmFjZURpc3RhbmNlIC8gc2VnbWVudHM7CiAgICBsZXQgZGlzdGFuY2VGcm9tU3RhcnQgPSBpbnRlcnBvaW50RGlzdGFuY2U7CiAgICBjb25zdCBwb2ludHNUb0FkZCA9IHNlZ21lbnRzIC0gMTsKICAgIGxldCBwYWNrSW5kZXggPSBub3JtYWxzQXJyYXkubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb2ludHNUb0FkZDsgaSsrKSB7CiAgICAgIGNvbnN0IGludGVycG9sYXRlZENhcnRvZ3JhcGhpYyA9IGVsbGlwc29pZExpbmUuaW50ZXJwb2xhdGVVc2luZ1N1cmZhY2VEaXN0YW5jZSgKICAgICAgICBkaXN0YW5jZUZyb21TdGFydCwKICAgICAgICBpbnRlcnBvbGF0ZWRDYXJ0b2dyYXBoaWNTY3JhdGNoCiAgICAgICk7CiAgICAgIGNvbnN0IGludGVycG9sYXRlZEJvdHRvbSA9IGdldFBvc2l0aW9uKAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBpbnRlcnBvbGF0ZWRDYXJ0b2dyYXBoaWMsCiAgICAgICAgbWluSGVpZ2h0LAogICAgICAgIGludGVycG9sYXRlZEJvdHRvbVNjcmF0Y2gKICAgICAgKTsKICAgICAgY29uc3QgaW50ZXJwb2xhdGVkVG9wID0gZ2V0UG9zaXRpb24oCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIGludGVycG9sYXRlZENhcnRvZ3JhcGhpYywKICAgICAgICBtYXhIZWlnaHQsCiAgICAgICAgaW50ZXJwb2xhdGVkVG9wU2NyYXRjaAogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhpbnRlcnBvbGF0ZWROb3JtYWwsIG5vcm1hbHNBcnJheSwgcGFja0luZGV4KTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soaW50ZXJwb2xhdGVkQm90dG9tLCBib3R0b21Qb3NpdGlvbnNBcnJheSwgcGFja0luZGV4KTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soaW50ZXJwb2xhdGVkVG9wLCB0b3BQb3NpdGlvbnNBcnJheSwgcGFja0luZGV4KTsKICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2goaW50ZXJwb2xhdGVkQ2FydG9ncmFwaGljLmxhdGl0dWRlKTsKICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2goaW50ZXJwb2xhdGVkQ2FydG9ncmFwaGljLmxvbmdpdHVkZSk7CiAgICAgIHBhY2tJbmRleCArPSAzOwogICAgICBkaXN0YW5jZUZyb21TdGFydCArPSBpbnRlcnBvaW50RGlzdGFuY2U7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdldFBvc2l0aW9uKGVsbGlwc29pZCwgY2FydG9ncmFwaGljMiwgaGVpZ2h0LCByZXN1bHQpIHsKICAgIENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKGNhcnRvZ3JhcGhpYzIsIGhlaWdodGxlc3NDYXJ0b2dyYXBoaWNTY3JhdGNoKTsKICAgIGhlaWdodGxlc3NDYXJ0b2dyYXBoaWNTY3JhdGNoLmhlaWdodCA9IGhlaWdodDsKICAgIHJldHVybiBDYXJ0b2dyYXBoaWNfZGVmYXVsdC50b0NhcnRlc2lhbigKICAgICAgaGVpZ2h0bGVzc0NhcnRvZ3JhcGhpY1NjcmF0Y2gsCiAgICAgIGVsbGlwc29pZCwKICAgICAgcmVzdWx0CiAgICApOwogIH0KICBmdW5jdGlvbiBkaXJlY3Rpb24odGFyZ2V0LCBvcmlnaW4sIHJlc3VsdCkgewogICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHRhcmdldCwgb3JpZ2luLCByZXN1bHQpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyZXN1bHQsIHJlc3VsdCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiB0YW5nZW50RGlyZWN0aW9uKHRhcmdldCwgb3JpZ2luLCB1cCwgcmVzdWx0KSB7CiAgICByZXN1bHQgPSBkaXJlY3Rpb24odGFyZ2V0LCBvcmlnaW4sIHJlc3VsdCk7CiAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MocmVzdWx0LCB1cCwgcmVzdWx0KTsKICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHVwLCByZXN1bHQsIHJlc3VsdCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBjb21wdXRlVmVydGV4TWl0ZXJOb3JtYWwocHJldmlvdXNCb3R0b20sIHZlcnRleEJvdHRvbSwgdmVydGV4VG9wLCBuZXh0Qm90dG9tLCByZXN1bHQpIHsKICAgIGNvbnN0IHVwID0gZGlyZWN0aW9uKHZlcnRleFRvcCwgdmVydGV4Qm90dG9tLCB2ZXJ0ZXhVcFNjcmF0Y2gpOwogICAgY29uc3QgdG9QcmV2aW91cyA9IHRhbmdlbnREaXJlY3Rpb24oCiAgICAgIHByZXZpb3VzQm90dG9tLAogICAgICB2ZXJ0ZXhCb3R0b20sCiAgICAgIHVwLAogICAgICB0b1ByZXZpb3VzU2NyYXRjaAogICAgKTsKICAgIGNvbnN0IHRvTmV4dCA9IHRhbmdlbnREaXJlY3Rpb24obmV4dEJvdHRvbSwgdmVydGV4Qm90dG9tLCB1cCwgdG9OZXh0U2NyYXRjaCk7CiAgICBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodG9QcmV2aW91cywgdG9OZXh0KSwKICAgICAgY29zaW5lMTgwLAogICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjUKICAgICkpIHsKICAgICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHVwLCB0b1ByZXZpb3VzLCByZXN1bHQpOwogICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJlc3VsdCwgcmVzdWx0KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQodG9OZXh0LCB0b1ByZXZpb3VzLCByZXN1bHQpOwogICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShyZXN1bHQsIHJlc3VsdCk7CiAgICBjb25zdCBmb3J3YXJkID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHVwLCByZXN1bHQsIGZvcndhcmRTY3JhdGNoKTsKICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHRvTmV4dCwgZm9yd2FyZCkgPCBjb3NpbmU5MCkgewogICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubmVnYXRlKHJlc3VsdCwgcmVzdWx0KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGJyZWFrTWl0ZXIoZW5kR2VvbWV0cnlOb3JtYWwsIHN0YXJ0Qm90dG9tLCBlbmRCb3R0b20sIGVuZFRvcCkgewogICAgY29uc3QgbGluZURpcmVjdGlvbiA9IGRpcmVjdGlvbihlbmRCb3R0b20sIHN0YXJ0Qm90dG9tLCBsaW5lRGlyZWN0aW9uU2NyYXRjaCk7CiAgICBjb25zdCBkb3QgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGxpbmVEaXJlY3Rpb24sIGVuZEdlb21ldHJ5Tm9ybWFsKTsKICAgIGlmIChkb3QgPiBNSVRFUl9CUkVBS19TTUFMTCB8fCBkb3QgPCBNSVRFUl9CUkVBS19MQVJHRSkgewogICAgICBjb25zdCB2ZXJ0ZXhVcCA9IGRpcmVjdGlvbihlbmRUb3AsIGVuZEJvdHRvbSwgdmVydGV4VXBTY3JhdGNoKTsKICAgICAgY29uc3QgYW5nbGUgPSBkb3QgPCBNSVRFUl9CUkVBS19MQVJHRSA/IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyA6IC1NYXRoX2RlZmF1bHQuUElfT1ZFUl9UV087CiAgICAgIGNvbnN0IHF1YXRlcm5pb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICB2ZXJ0ZXhVcCwKICAgICAgICBhbmdsZSwKICAgICAgICBxdWF0ZXJuaW9uU2NyYXRjaDMKICAgICAgKTsKICAgICAgY29uc3Qgcm90YXRpb25NYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24ocXVhdGVybmlvbiwgbWF0cml4M1NjcmF0Y2gpOwogICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcigKICAgICAgICByb3RhdGlvbk1hdHJpeCwKICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbCwKICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbAogICAgICApOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgZnVuY3Rpb24gcHJvamVjdE5vcm1hbChwcm9qZWN0aW9uLCBjYXJ0b2dyYXBoaWMyLCBub3JtYWwyLCBwcm9qZWN0ZWRQb3NpdGlvbiwgcmVzdWx0KSB7CiAgICBjb25zdCBwb3NpdGlvbiA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LnRvQ2FydGVzaWFuKAogICAgICBjYXJ0b2dyYXBoaWMyLAogICAgICBwcm9qZWN0aW9uLl9lbGxpcHNvaWQsCiAgICAgIG5vcm1hbFN0YXJ0cG9pbnRTY3JhdGNoCiAgICApOwogICAgbGV0IG5vcm1hbEVuZHBvaW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwb3NpdGlvbiwgbm9ybWFsMiwgbm9ybWFsRW5kcG9pbnRTY3JhdGNoKTsKICAgIGxldCBmbGlwTm9ybWFsID0gZmFsc2U7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBwcm9qZWN0aW9uLl9lbGxpcHNvaWQ7CiAgICBsZXQgbm9ybWFsRW5kcG9pbnRDYXJ0b2dyYXBoaWMgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgIG5vcm1hbEVuZHBvaW50LAogICAgICBlbmRQb3NDYXJ0b2dyYXBoaWNTY3JhdGNoCiAgICApOwogICAgaWYgKE1hdGguYWJzKGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlIC0gbm9ybWFsRW5kcG9pbnRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlKSA+IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTykgewogICAgICBmbGlwTm9ybWFsID0gdHJ1ZTsKICAgICAgbm9ybWFsRW5kcG9pbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgcG9zaXRpb24sCiAgICAgICAgbm9ybWFsMiwKICAgICAgICBub3JtYWxFbmRwb2ludFNjcmF0Y2gKICAgICAgKTsKICAgICAgbm9ybWFsRW5kcG9pbnRDYXJ0b2dyYXBoaWMgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgbm9ybWFsRW5kcG9pbnQsCiAgICAgICAgZW5kUG9zQ2FydG9ncmFwaGljU2NyYXRjaAogICAgICApOwogICAgfQogICAgbm9ybWFsRW5kcG9pbnRDYXJ0b2dyYXBoaWMuaGVpZ2h0ID0gMDsKICAgIGNvbnN0IG5vcm1hbEVuZHBvaW50UHJvamVjdGVkID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICBub3JtYWxFbmRwb2ludENhcnRvZ3JhcGhpYywKICAgICAgcmVzdWx0CiAgICApOwogICAgcmVzdWx0ID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICBub3JtYWxFbmRwb2ludFByb2plY3RlZCwKICAgICAgcHJvamVjdGVkUG9zaXRpb24sCiAgICAgIHJlc3VsdAogICAgKTsKICAgIHJlc3VsdC56ID0gMDsKICAgIHJlc3VsdCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmVzdWx0LCByZXN1bHQpOwogICAgaWYgKGZsaXBOb3JtYWwpIHsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShyZXN1bHQsIHJlc3VsdCk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBhZGp1c3RIZWlnaHRzKGJvdHRvbSwgdG9wLCBtaW5IZWlnaHQsIG1heEhlaWdodCwgYWRqdXN0SGVpZ2h0Qm90dG9tLCBhZGp1c3RIZWlnaHRUb3ApIHsKICAgIGNvbnN0IGFkanVzdEhlaWdodE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgdG9wLAogICAgICBib3R0b20sCiAgICAgIGFkanVzdEhlaWdodE5vcm1hbFNjcmF0Y2gKICAgICk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGFkanVzdEhlaWdodE5vcm1hbCwgYWRqdXN0SGVpZ2h0Tm9ybWFsKTsKICAgIGNvbnN0IGRpc3RhbmNlRm9yQm90dG9tID0gbWluSGVpZ2h0IC0gV0FMTF9JTklUSUFMX01JTl9IRUlHSFQ7CiAgICBsZXQgYWRqdXN0SGVpZ2h0T2Zmc2V0ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIGFkanVzdEhlaWdodE5vcm1hbCwKICAgICAgZGlzdGFuY2VGb3JCb3R0b20sCiAgICAgIGFkanVzdEhlaWdodE9mZnNldFNjcmF0Y2gKICAgICk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGJvdHRvbSwgYWRqdXN0SGVpZ2h0T2Zmc2V0LCBhZGp1c3RIZWlnaHRCb3R0b20pOwogICAgY29uc3QgZGlzdGFuY2VGb3JUb3AgPSBtYXhIZWlnaHQgLSBXQUxMX0lOSVRJQUxfTUFYX0hFSUdIVDsKICAgIGFkanVzdEhlaWdodE9mZnNldCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICBhZGp1c3RIZWlnaHROb3JtYWwsCiAgICAgIGRpc3RhbmNlRm9yVG9wLAogICAgICBhZGp1c3RIZWlnaHRPZmZzZXRTY3JhdGNoCiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZCh0b3AsIGFkanVzdEhlaWdodE9mZnNldCwgYWRqdXN0SGVpZ2h0VG9wKTsKICB9CiAgZnVuY3Rpb24gbnVkZ2VYWihzdGFydCwgZW5kKSB7CiAgICBjb25zdCBzdGFydFRvWFpkaXN0YW5jZSA9IFBsYW5lX2RlZmF1bHQuZ2V0UG9pbnREaXN0YW5jZShYWl9QTEFORSwgc3RhcnQpOwogICAgY29uc3QgZW5kVG9YWmRpc3RhbmNlID0gUGxhbmVfZGVmYXVsdC5nZXRQb2ludERpc3RhbmNlKFhaX1BMQU5FLCBlbmQpOwogICAgbGV0IG9mZnNldCA9IG51ZGdlRGlyZWN0aW9uU2NyYXRjaDsKICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihzdGFydFRvWFpkaXN0YW5jZSwgMCwgTWF0aF9kZWZhdWx0LkVQU0lMT04yKSkgewogICAgICBvZmZzZXQgPSBkaXJlY3Rpb24oZW5kLCBzdGFydCwgb2Zmc2V0KTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIob2Zmc2V0LCBNYXRoX2RlZmF1bHQuRVBTSUxPTjIsIG9mZnNldCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoc3RhcnQsIG9mZnNldCwgc3RhcnQpOwogICAgfSBlbHNlIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihlbmRUb1haZGlzdGFuY2UsIDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMikpIHsKICAgICAgb2Zmc2V0ID0gZGlyZWN0aW9uKHN0YXJ0LCBlbmQsIG9mZnNldCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKG9mZnNldCwgTWF0aF9kZWZhdWx0LkVQU0lMT04yLCBvZmZzZXQpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGVuZCwgb2Zmc2V0LCBlbmQpOwogICAgfQogIH0KICBmdW5jdGlvbiBudWRnZUNhcnRvZ3JhcGhpYyhzdGFydCwgZW5kKSB7CiAgICBjb25zdCBhYnNTdGFydExvbiA9IE1hdGguYWJzKHN0YXJ0LmxvbmdpdHVkZSk7CiAgICBjb25zdCBhYnNFbmRMb24gPSBNYXRoLmFicyhlbmQubG9uZ2l0dWRlKTsKICAgIGlmIChNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihhYnNTdGFydExvbiwgTWF0aF9kZWZhdWx0LlBJLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjExKSkgewogICAgICBjb25zdCBlbmRTaWduID0gTWF0aF9kZWZhdWx0LnNpZ24oZW5kLmxvbmdpdHVkZSk7CiAgICAgIHN0YXJ0LmxvbmdpdHVkZSA9IGVuZFNpZ24gKiAoYWJzU3RhcnRMb24gLSBNYXRoX2RlZmF1bHQuRVBTSUxPTjExKTsKICAgICAgcmV0dXJuIDE7CiAgICB9IGVsc2UgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGFic0VuZExvbiwgTWF0aF9kZWZhdWx0LlBJLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjExKSkgewogICAgICBjb25zdCBzdGFydFNpZ24gPSBNYXRoX2RlZmF1bHQuc2lnbihzdGFydC5sb25naXR1ZGUpOwogICAgICBlbmQubG9uZ2l0dWRlID0gc3RhcnRTaWduICogKGFic0VuZExvbiAtIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTEpOwogICAgICByZXR1cm4gMjsKICAgIH0KICAgIHJldHVybiAwOwogIH0KICBmdW5jdGlvbiBnZW5lcmF0ZUdlb21ldHJ5QXR0cmlidXRlcyhsb29wLCBwcm9qZWN0aW9uLCBib3R0b21Qb3NpdGlvbnNBcnJheSwgdG9wUG9zaXRpb25zQXJyYXksIG5vcm1hbHNBcnJheSwgY2FydG9ncmFwaGljc0FycmF5LCBjb21wdXRlMmRBdHRyaWJ1dGVzKSB7CiAgICBsZXQgaTsKICAgIGxldCBpbmRleDsKICAgIGNvbnN0IGVsbGlwc29pZCA9IHByb2plY3Rpb24uX2VsbGlwc29pZDsKICAgIGNvbnN0IHNlZ21lbnRDb3VudCA9IGJvdHRvbVBvc2l0aW9uc0FycmF5Lmxlbmd0aCAvIDMgLSAxOwogICAgY29uc3QgdmVydGV4Q291bnQgPSBzZWdtZW50Q291bnQgKiA4OwogICAgY29uc3QgYXJyYXlTaXplVmVjNCA9IHZlcnRleENvdW50ICogNDsKICAgIGNvbnN0IGluZGV4Q291bnQgPSBzZWdtZW50Q291bnQgKiAzNjsKICAgIGNvbnN0IGluZGljZXMgPSB2ZXJ0ZXhDb3VudCA+IDY1NTM1ID8gbmV3IFVpbnQzMkFycmF5KGluZGV4Q291bnQpIDogbmV3IFVpbnQxNkFycmF5KGluZGV4Q291bnQpOwogICAgY29uc3QgcG9zaXRpb25zQXJyYXkgPSBuZXcgRmxvYXQ2NEFycmF5KHZlcnRleENvdW50ICogMyk7CiAgICBjb25zdCBzdGFydEhpQW5kRm9yd2FyZE9mZnNldFggPSBuZXcgRmxvYXQzMkFycmF5KGFycmF5U2l6ZVZlYzQpOwogICAgY29uc3Qgc3RhcnRMb0FuZEZvcndhcmRPZmZzZXRZID0gbmV3IEZsb2F0MzJBcnJheShhcnJheVNpemVWZWM0KTsKICAgIGNvbnN0IHN0YXJ0Tm9ybWFsQW5kRm9yd2FyZE9mZnNldFogPSBuZXcgRmxvYXQzMkFycmF5KGFycmF5U2l6ZVZlYzQpOwogICAgY29uc3QgZW5kTm9ybWFsQW5kVGV4dHVyZUNvb3JkaW5hdGVOb3JtYWxpemF0aW9uWCA9IG5ldyBGbG9hdDMyQXJyYXkoCiAgICAgIGFycmF5U2l6ZVZlYzQKICAgICk7CiAgICBjb25zdCByaWdodE5vcm1hbEFuZFRleHR1cmVDb29yZGluYXRlTm9ybWFsaXphdGlvblkgPSBuZXcgRmxvYXQzMkFycmF5KAogICAgICBhcnJheVNpemVWZWM0CiAgICApOwogICAgbGV0IHN0YXJ0SGlMbzJEOwogICAgbGV0IG9mZnNldEFuZFJpZ2h0MkQ7CiAgICBsZXQgc3RhcnRFbmROb3JtYWxzMkQ7CiAgICBsZXQgdGV4Y29vcmROb3JtYWxpemF0aW9uMkQ7CiAgICBpZiAoY29tcHV0ZTJkQXR0cmlidXRlcykgewogICAgICBzdGFydEhpTG8yRCA9IG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlTaXplVmVjNCk7CiAgICAgIG9mZnNldEFuZFJpZ2h0MkQgPSBuZXcgRmxvYXQzMkFycmF5KGFycmF5U2l6ZVZlYzQpOwogICAgICBzdGFydEVuZE5vcm1hbHMyRCA9IG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlTaXplVmVjNCk7CiAgICAgIHRleGNvb3JkTm9ybWFsaXphdGlvbjJEID0gbmV3IEZsb2F0MzJBcnJheSh2ZXJ0ZXhDb3VudCAqIDIpOwogICAgfQogICAgY29uc3QgY2FydG9ncmFwaGljc0xlbmd0aCA9IGNhcnRvZ3JhcGhpY3NBcnJheS5sZW5ndGggLyAyOwogICAgbGV0IGxlbmd0aDJEID0gMDsKICAgIGNvbnN0IHN0YXJ0Q2FydG9ncmFwaGljID0gc3RhcnRDYXJ0b2dyYXBoaWNTY3JhdGNoOwogICAgc3RhcnRDYXJ0b2dyYXBoaWMuaGVpZ2h0ID0gMDsKICAgIGNvbnN0IGVuZENhcnRvZ3JhcGhpYyA9IGVuZENhcnRvZ3JhcGhpY1NjcmF0Y2g7CiAgICBlbmRDYXJ0b2dyYXBoaWMuaGVpZ2h0ID0gMDsKICAgIGxldCBzZWdtZW50U3RhcnRDYXJ0ZXNpYW4gPSBzZWdtZW50U3RhcnRUb3BTY3JhdGNoOwogICAgbGV0IHNlZ21lbnRFbmRDYXJ0ZXNpYW4gPSBzZWdtZW50RW5kVG9wU2NyYXRjaDsKICAgIGlmIChjb21wdXRlMmRBdHRyaWJ1dGVzKSB7CiAgICAgIGluZGV4ID0gMDsKICAgICAgZm9yIChpID0gMTsgaSA8IGNhcnRvZ3JhcGhpY3NMZW5ndGg7IGkrKykgewogICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLmxhdGl0dWRlID0gY2FydG9ncmFwaGljc0FycmF5W2luZGV4XTsKICAgICAgICBzdGFydENhcnRvZ3JhcGhpYy5sb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWNzQXJyYXlbaW5kZXggKyAxXTsKICAgICAgICBlbmRDYXJ0b2dyYXBoaWMubGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWNzQXJyYXlbaW5kZXggKyAyXTsKICAgICAgICBlbmRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlID0gY2FydG9ncmFwaGljc0FycmF5W2luZGV4ICsgM107CiAgICAgICAgc2VnbWVudFN0YXJ0Q2FydGVzaWFuID0gcHJvamVjdGlvbi5wcm9qZWN0KAogICAgICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICBzZWdtZW50U3RhcnRDYXJ0ZXNpYW4KICAgICAgICApOwogICAgICAgIHNlZ21lbnRFbmRDYXJ0ZXNpYW4gPSBwcm9qZWN0aW9uLnByb2plY3QoCiAgICAgICAgICBlbmRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICBzZWdtZW50RW5kQ2FydGVzaWFuCiAgICAgICAgKTsKICAgICAgICBsZW5ndGgyRCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGlzdGFuY2UoCiAgICAgICAgICBzZWdtZW50U3RhcnRDYXJ0ZXNpYW4sCiAgICAgICAgICBzZWdtZW50RW5kQ2FydGVzaWFuCiAgICAgICAgKTsKICAgICAgICBpbmRleCArPSAyOwogICAgICB9CiAgICB9CiAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSB0b3BQb3NpdGlvbnNBcnJheS5sZW5ndGggLyAzOwogICAgc2VnbWVudEVuZENhcnRlc2lhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgIHRvcFBvc2l0aW9uc0FycmF5LAogICAgICAwLAogICAgICBzZWdtZW50RW5kQ2FydGVzaWFuCiAgICApOwogICAgbGV0IGxlbmd0aDNEID0gMDsKICAgIGluZGV4ID0gMzsKICAgIGZvciAoaSA9IDE7IGkgPCBwb3NpdGlvbnNMZW5ndGg7IGkrKykgewogICAgICBzZWdtZW50U3RhcnRDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoCiAgICAgICAgc2VnbWVudEVuZENhcnRlc2lhbiwKICAgICAgICBzZWdtZW50U3RhcnRDYXJ0ZXNpYW4KICAgICAgKTsKICAgICAgc2VnbWVudEVuZENhcnRlc2lhbiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgdG9wUG9zaXRpb25zQXJyYXksCiAgICAgICAgaW5kZXgsCiAgICAgICAgc2VnbWVudEVuZENhcnRlc2lhbgogICAgICApOwogICAgICBsZW5ndGgzRCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGlzdGFuY2Uoc2VnbWVudFN0YXJ0Q2FydGVzaWFuLCBzZWdtZW50RW5kQ2FydGVzaWFuKTsKICAgICAgaW5kZXggKz0gMzsKICAgIH0KICAgIGxldCBqOwogICAgaW5kZXggPSAzOwogICAgbGV0IGNhcnRvZ3JhcGhpY3NJbmRleCA9IDA7CiAgICBsZXQgdmVjMnNXcml0ZUluZGV4ID0gMDsKICAgIGxldCB2ZWMzc1dyaXRlSW5kZXggPSAwOwogICAgbGV0IHZlYzRzV3JpdGVJbmRleCA9IDA7CiAgICBsZXQgbWl0ZXJCcm9rZW4gPSBmYWxzZTsKICAgIGxldCBlbmRCb3R0b20gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICBib3R0b21Qb3NpdGlvbnNBcnJheSwKICAgICAgMCwKICAgICAgc2VnbWVudEVuZEJvdHRvbVNjcmF0Y2gKICAgICk7CiAgICBsZXQgZW5kVG9wID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayh0b3BQb3NpdGlvbnNBcnJheSwgMCwgc2VnbWVudEVuZFRvcFNjcmF0Y2gpOwogICAgbGV0IGVuZEdlb21ldHJ5Tm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgbm9ybWFsc0FycmF5LAogICAgICAwLAogICAgICBzZWdtZW50RW5kTm9ybWFsU2NyYXRjaAogICAgKTsKICAgIGlmIChsb29wKSB7CiAgICAgIGNvbnN0IHByZUVuZEJvdHRvbSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgYm90dG9tUG9zaXRpb25zQXJyYXksCiAgICAgICAgYm90dG9tUG9zaXRpb25zQXJyYXkubGVuZ3RoIC0gNiwKICAgICAgICBzZWdtZW50U3RhcnRCb3R0b21TY3JhdGNoCiAgICAgICk7CiAgICAgIGlmIChicmVha01pdGVyKGVuZEdlb21ldHJ5Tm9ybWFsLCBwcmVFbmRCb3R0b20sIGVuZEJvdHRvbSwgZW5kVG9wKSkgewogICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSgKICAgICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsLAogICAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICBsZXQgbGVuZ3RoU29GYXIzRCA9IDA7CiAgICBsZXQgbGVuZ3RoU29GYXIyRCA9IDA7CiAgICBsZXQgc3VtSGVpZ2h0cyA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgc2VnbWVudENvdW50OyBpKyspIHsKICAgICAgY29uc3Qgc3RhcnRCb3R0b20gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZW5kQm90dG9tLCBzZWdtZW50U3RhcnRCb3R0b21TY3JhdGNoKTsKICAgICAgY29uc3Qgc3RhcnRUb3AgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZW5kVG9wLCBzZWdtZW50U3RhcnRUb3BTY3JhdGNoKTsKICAgICAgbGV0IHN0YXJ0R2VvbWV0cnlOb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoCiAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwsCiAgICAgICAgc2VnbWVudFN0YXJ0Tm9ybWFsU2NyYXRjaAogICAgICApOwogICAgICBpZiAobWl0ZXJCcm9rZW4pIHsKICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZSgKICAgICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwsCiAgICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsCiAgICAgICAgKTsKICAgICAgfQogICAgICBlbmRCb3R0b20gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgIGJvdHRvbVBvc2l0aW9uc0FycmF5LAogICAgICAgIGluZGV4LAogICAgICAgIHNlZ21lbnRFbmRCb3R0b21TY3JhdGNoCiAgICAgICk7CiAgICAgIGVuZFRvcCA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2sodG9wUG9zaXRpb25zQXJyYXksIGluZGV4LCBzZWdtZW50RW5kVG9wU2NyYXRjaCk7CiAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICBub3JtYWxzQXJyYXksCiAgICAgICAgaW5kZXgsCiAgICAgICAgc2VnbWVudEVuZE5vcm1hbFNjcmF0Y2gKICAgICAgKTsKICAgICAgbWl0ZXJCcm9rZW4gPSBicmVha01pdGVyKGVuZEdlb21ldHJ5Tm9ybWFsLCBzdGFydEJvdHRvbSwgZW5kQm90dG9tLCBlbmRUb3ApOwogICAgICBzdGFydENhcnRvZ3JhcGhpYy5sYXRpdHVkZSA9IGNhcnRvZ3JhcGhpY3NBcnJheVtjYXJ0b2dyYXBoaWNzSW5kZXhdOwogICAgICBzdGFydENhcnRvZ3JhcGhpYy5sb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWNzQXJyYXlbY2FydG9ncmFwaGljc0luZGV4ICsgMV07CiAgICAgIGVuZENhcnRvZ3JhcGhpYy5sYXRpdHVkZSA9IGNhcnRvZ3JhcGhpY3NBcnJheVtjYXJ0b2dyYXBoaWNzSW5kZXggKyAyXTsKICAgICAgZW5kQ2FydG9ncmFwaGljLmxvbmdpdHVkZSA9IGNhcnRvZ3JhcGhpY3NBcnJheVtjYXJ0b2dyYXBoaWNzSW5kZXggKyAzXTsKICAgICAgbGV0IHN0YXJ0MkQ7CiAgICAgIGxldCBlbmQyRDsKICAgICAgbGV0IHN0YXJ0R2VvbWV0cnlOb3JtYWwyRDsKICAgICAgbGV0IGVuZEdlb21ldHJ5Tm9ybWFsMkQ7CiAgICAgIGlmIChjb21wdXRlMmRBdHRyaWJ1dGVzKSB7CiAgICAgICAgY29uc3QgbnVkZ2VSZXN1bHQgPSBudWRnZUNhcnRvZ3JhcGhpYyhzdGFydENhcnRvZ3JhcGhpYywgZW5kQ2FydG9ncmFwaGljKTsKICAgICAgICBzdGFydDJEID0gcHJvamVjdGlvbi5wcm9qZWN0KHN0YXJ0Q2FydG9ncmFwaGljLCBzZWdtZW50U3RhcnQyRFNjcmF0Y2gpOwogICAgICAgIGVuZDJEID0gcHJvamVjdGlvbi5wcm9qZWN0KGVuZENhcnRvZ3JhcGhpYywgc2VnbWVudEVuZDJEU2NyYXRjaCk7CiAgICAgICAgY29uc3QgZGlyZWN0aW9uMkQgPSBkaXJlY3Rpb24oZW5kMkQsIHN0YXJ0MkQsIGZvcndhcmRPZmZzZXQyRFNjcmF0Y2gpOwogICAgICAgIGRpcmVjdGlvbjJELnkgPSBNYXRoLmFicyhkaXJlY3Rpb24yRC55KTsKICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsMkQgPSBzZWdtZW50U3RhcnROb3JtYWwyRFNjcmF0Y2g7CiAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwyRCA9IHNlZ21lbnRFbmROb3JtYWwyRFNjcmF0Y2g7CiAgICAgICAgaWYgKG51ZGdlUmVzdWx0ID09PSAwIHx8IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoZGlyZWN0aW9uMkQsIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1kpID4gTUlURVJfQlJFQUtfU01BTEwpIHsKICAgICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwyRCA9IHByb2plY3ROb3JtYWwoCiAgICAgICAgICAgIHByb2plY3Rpb24sCiAgICAgICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLAogICAgICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsLAogICAgICAgICAgICBzdGFydDJELAogICAgICAgICAgICBzZWdtZW50U3RhcnROb3JtYWwyRFNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbDJEID0gcHJvamVjdE5vcm1hbCgKICAgICAgICAgICAgcHJvamVjdGlvbiwKICAgICAgICAgICAgZW5kQ2FydG9ncmFwaGljLAogICAgICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbCwKICAgICAgICAgICAgZW5kMkQsCiAgICAgICAgICAgIHNlZ21lbnRFbmROb3JtYWwyRFNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChudWRnZVJlc3VsdCA9PT0gMSkgewogICAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwyRCA9IHByb2plY3ROb3JtYWwoCiAgICAgICAgICAgIHByb2plY3Rpb24sCiAgICAgICAgICAgIGVuZENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwsCiAgICAgICAgICAgIGVuZDJELAogICAgICAgICAgICBzZWdtZW50RW5kTm9ybWFsMkRTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbDJELnggPSAwOwogICAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbDJELnkgPSBNYXRoX2RlZmF1bHQuc2lnbigKICAgICAgICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMubG9uZ2l0dWRlIC0gTWF0aC5hYnMoZW5kQ2FydG9ncmFwaGljLmxvbmdpdHVkZSkKICAgICAgICAgICk7CiAgICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsMkQueiA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0YXJ0R2VvbWV0cnlOb3JtYWwyRCA9IHByb2plY3ROb3JtYWwoCiAgICAgICAgICAgIHByb2plY3Rpb24sCiAgICAgICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLAogICAgICAgICAgICBzdGFydEdlb21ldHJ5Tm9ybWFsLAogICAgICAgICAgICBzdGFydDJELAogICAgICAgICAgICBzZWdtZW50U3RhcnROb3JtYWwyRFNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbDJELnggPSAwOwogICAgICAgICAgZW5kR2VvbWV0cnlOb3JtYWwyRC55ID0gTWF0aF9kZWZhdWx0LnNpZ24oCiAgICAgICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLmxvbmdpdHVkZSAtIGVuZENhcnRvZ3JhcGhpYy5sb25naXR1ZGUKICAgICAgICAgICk7CiAgICAgICAgICBlbmRHZW9tZXRyeU5vcm1hbDJELnogPSAwOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBzZWdtZW50TGVuZ3RoM0QgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGlzdGFuY2Uoc3RhcnRUb3AsIGVuZFRvcCk7CiAgICAgIGNvbnN0IGVuY29kZWRTdGFydCA9IEVuY29kZWRDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUNhcnRlc2lhbigKICAgICAgICBzdGFydEJvdHRvbSwKICAgICAgICBlbmNvZGVTY3JhdGNoCiAgICAgICk7CiAgICAgIGNvbnN0IGZvcndhcmRPZmZzZXQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgZW5kQm90dG9tLAogICAgICAgIHN0YXJ0Qm90dG9tLAogICAgICAgIG9mZnNldFNjcmF0Y2gyCiAgICAgICk7CiAgICAgIGNvbnN0IGZvcndhcmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGZvcndhcmRPZmZzZXQsIHJpZ2h0U2NyYXRjaDIpOwogICAgICBsZXQgc3RhcnRVcCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChzdGFydFRvcCwgc3RhcnRCb3R0b20sIHN0YXJ0VXBTY3JhdGNoKTsKICAgICAgc3RhcnRVcCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoc3RhcnRVcCwgc3RhcnRVcCk7CiAgICAgIGxldCByaWdodE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhmb3J3YXJkLCBzdGFydFVwLCByaWdodFNjcmF0Y2gyKTsKICAgICAgcmlnaHROb3JtYWwgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJpZ2h0Tm9ybWFsLCByaWdodE5vcm1hbCk7CiAgICAgIGxldCBzdGFydFBsYW5lTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKAogICAgICAgIHN0YXJ0VXAsCiAgICAgICAgc3RhcnRHZW9tZXRyeU5vcm1hbCwKICAgICAgICBzdGFydFBsYW5lTm9ybWFsU2NyYXRjaAogICAgICApOwogICAgICBzdGFydFBsYW5lTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShzdGFydFBsYW5lTm9ybWFsLCBzdGFydFBsYW5lTm9ybWFsKTsKICAgICAgbGV0IGVuZFVwID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGVuZFRvcCwgZW5kQm90dG9tLCBlbmRVcFNjcmF0Y2gpOwogICAgICBlbmRVcCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZW5kVXAsIGVuZFVwKTsKICAgICAgbGV0IGVuZFBsYW5lTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKAogICAgICAgIGVuZEdlb21ldHJ5Tm9ybWFsLAogICAgICAgIGVuZFVwLAogICAgICAgIGVuZFBsYW5lTm9ybWFsU2NyYXRjaAogICAgICApOwogICAgICBlbmRQbGFuZU5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZW5kUGxhbmVOb3JtYWwsIGVuZFBsYW5lTm9ybWFsKTsKICAgICAgY29uc3QgdGV4Y29vcmROb3JtYWxpemF0aW9uM0RYID0gc2VnbWVudExlbmd0aDNEIC8gbGVuZ3RoM0Q7CiAgICAgIGNvbnN0IHRleGNvb3JkTm9ybWFsaXphdGlvbjNEWSA9IGxlbmd0aFNvRmFyM0QgLyBsZW5ndGgzRDsKICAgICAgbGV0IHNlZ21lbnRMZW5ndGgyRCA9IDA7CiAgICAgIGxldCBlbmNvZGVkU3RhcnQyRDsKICAgICAgbGV0IGZvcndhcmRPZmZzZXQyRDsKICAgICAgbGV0IHJpZ2h0MkQ7CiAgICAgIGxldCB0ZXhjb29yZE5vcm1hbGl6YXRpb24yRFggPSAwOwogICAgICBsZXQgdGV4Y29vcmROb3JtYWxpemF0aW9uMkRZID0gMDsKICAgICAgaWYgKGNvbXB1dGUyZEF0dHJpYnV0ZXMpIHsKICAgICAgICBzZWdtZW50TGVuZ3RoMkQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZGlzdGFuY2Uoc3RhcnQyRCwgZW5kMkQpOwogICAgICAgIGVuY29kZWRTdGFydDJEID0gRW5jb2RlZENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuKAogICAgICAgICAgc3RhcnQyRCwKICAgICAgICAgIGVuY29kZVNjcmF0Y2gyRAogICAgICAgICk7CiAgICAgICAgZm9yd2FyZE9mZnNldDJEID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgZW5kMkQsCiAgICAgICAgICBzdGFydDJELAogICAgICAgICAgZm9yd2FyZE9mZnNldDJEU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgcmlnaHQyRCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoZm9yd2FyZE9mZnNldDJELCByaWdodDJEU2NyYXRjaCk7CiAgICAgICAgY29uc3Qgc3dhcDIgPSByaWdodDJELng7CiAgICAgICAgcmlnaHQyRC54ID0gcmlnaHQyRC55OwogICAgICAgIHJpZ2h0MkQueSA9IC1zd2FwMjsKICAgICAgICB0ZXhjb29yZE5vcm1hbGl6YXRpb24yRFggPSBzZWdtZW50TGVuZ3RoMkQgLyBsZW5ndGgyRDsKICAgICAgICB0ZXhjb29yZE5vcm1hbGl6YXRpb24yRFkgPSBsZW5ndGhTb0ZhcjJEIC8gbGVuZ3RoMkQ7CiAgICAgIH0KICAgICAgZm9yIChqID0gMDsgaiA8IDg7IGorKykgewogICAgICAgIGNvbnN0IHZlYzRJbmRleCA9IHZlYzRzV3JpdGVJbmRleCArIGogKiA0OwogICAgICAgIGNvbnN0IHZlYzJJbmRleCA9IHZlYzJzV3JpdGVJbmRleCArIGogKiAyOwogICAgICAgIGNvbnN0IHdJbmRleCA9IHZlYzRJbmRleCArIDM7CiAgICAgICAgY29uc3QgcmlnaHRQbGFuZVNpZGUgPSBqIDwgNCA/IDEgOiAtMTsKICAgICAgICBjb25zdCB0b3BCb3R0b21TaWRlID0gaiA9PT0gMiB8fCBqID09PSAzIHx8IGogPT09IDYgfHwgaiA9PT0gNyA/IDEgOiAtMTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhlbmNvZGVkU3RhcnQuaGlnaCwgc3RhcnRIaUFuZEZvcndhcmRPZmZzZXRYLCB2ZWM0SW5kZXgpOwogICAgICAgIHN0YXJ0SGlBbmRGb3J3YXJkT2Zmc2V0WFt3SW5kZXhdID0gZm9yd2FyZE9mZnNldC54OwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGVuY29kZWRTdGFydC5sb3csIHN0YXJ0TG9BbmRGb3J3YXJkT2Zmc2V0WSwgdmVjNEluZGV4KTsKICAgICAgICBzdGFydExvQW5kRm9yd2FyZE9mZnNldFlbd0luZGV4XSA9IGZvcndhcmRPZmZzZXQueTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjaygKICAgICAgICAgIHN0YXJ0UGxhbmVOb3JtYWwsCiAgICAgICAgICBzdGFydE5vcm1hbEFuZEZvcndhcmRPZmZzZXRaLAogICAgICAgICAgdmVjNEluZGV4CiAgICAgICAgKTsKICAgICAgICBzdGFydE5vcm1hbEFuZEZvcndhcmRPZmZzZXRaW3dJbmRleF0gPSBmb3J3YXJkT2Zmc2V0Lno7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soCiAgICAgICAgICBlbmRQbGFuZU5vcm1hbCwKICAgICAgICAgIGVuZE5vcm1hbEFuZFRleHR1cmVDb29yZGluYXRlTm9ybWFsaXphdGlvblgsCiAgICAgICAgICB2ZWM0SW5kZXgKICAgICAgICApOwogICAgICAgIGVuZE5vcm1hbEFuZFRleHR1cmVDb29yZGluYXRlTm9ybWFsaXphdGlvblhbd0luZGV4XSA9IHRleGNvb3JkTm9ybWFsaXphdGlvbjNEWCAqIHJpZ2h0UGxhbmVTaWRlOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKAogICAgICAgICAgcmlnaHROb3JtYWwsCiAgICAgICAgICByaWdodE5vcm1hbEFuZFRleHR1cmVDb29yZGluYXRlTm9ybWFsaXphdGlvblksCiAgICAgICAgICB2ZWM0SW5kZXgKICAgICAgICApOwogICAgICAgIGxldCB0ZXhjb29yZE5vcm1hbGl6YXRpb24gPSB0ZXhjb29yZE5vcm1hbGl6YXRpb24zRFkgKiB0b3BCb3R0b21TaWRlOwogICAgICAgIGlmICh0ZXhjb29yZE5vcm1hbGl6YXRpb24gPT09IDAgJiYgdG9wQm90dG9tU2lkZSA8IDApIHsKICAgICAgICAgIHRleGNvb3JkTm9ybWFsaXphdGlvbiA9IDk7CiAgICAgICAgfQogICAgICAgIHJpZ2h0Tm9ybWFsQW5kVGV4dHVyZUNvb3JkaW5hdGVOb3JtYWxpemF0aW9uWVt3SW5kZXhdID0gdGV4Y29vcmROb3JtYWxpemF0aW9uOwogICAgICAgIGlmIChjb21wdXRlMmRBdHRyaWJ1dGVzKSB7CiAgICAgICAgICBzdGFydEhpTG8yRFt2ZWM0SW5kZXhdID0gZW5jb2RlZFN0YXJ0MkQuaGlnaC54OwogICAgICAgICAgc3RhcnRIaUxvMkRbdmVjNEluZGV4ICsgMV0gPSBlbmNvZGVkU3RhcnQyRC5oaWdoLnk7CiAgICAgICAgICBzdGFydEhpTG8yRFt2ZWM0SW5kZXggKyAyXSA9IGVuY29kZWRTdGFydDJELmxvdy54OwogICAgICAgICAgc3RhcnRIaUxvMkRbdmVjNEluZGV4ICsgM10gPSBlbmNvZGVkU3RhcnQyRC5sb3cueTsKICAgICAgICAgIHN0YXJ0RW5kTm9ybWFsczJEW3ZlYzRJbmRleF0gPSAtc3RhcnRHZW9tZXRyeU5vcm1hbDJELnk7CiAgICAgICAgICBzdGFydEVuZE5vcm1hbHMyRFt2ZWM0SW5kZXggKyAxXSA9IHN0YXJ0R2VvbWV0cnlOb3JtYWwyRC54OwogICAgICAgICAgc3RhcnRFbmROb3JtYWxzMkRbdmVjNEluZGV4ICsgMl0gPSBlbmRHZW9tZXRyeU5vcm1hbDJELnk7CiAgICAgICAgICBzdGFydEVuZE5vcm1hbHMyRFt2ZWM0SW5kZXggKyAzXSA9IC1lbmRHZW9tZXRyeU5vcm1hbDJELng7CiAgICAgICAgICBvZmZzZXRBbmRSaWdodDJEW3ZlYzRJbmRleF0gPSBmb3J3YXJkT2Zmc2V0MkQueDsKICAgICAgICAgIG9mZnNldEFuZFJpZ2h0MkRbdmVjNEluZGV4ICsgMV0gPSBmb3J3YXJkT2Zmc2V0MkQueTsKICAgICAgICAgIG9mZnNldEFuZFJpZ2h0MkRbdmVjNEluZGV4ICsgMl0gPSByaWdodDJELng7CiAgICAgICAgICBvZmZzZXRBbmRSaWdodDJEW3ZlYzRJbmRleCArIDNdID0gcmlnaHQyRC55OwogICAgICAgICAgdGV4Y29vcmROb3JtYWxpemF0aW9uMkRbdmVjMkluZGV4XSA9IHRleGNvb3JkTm9ybWFsaXphdGlvbjJEWCAqIHJpZ2h0UGxhbmVTaWRlOwogICAgICAgICAgdGV4Y29vcmROb3JtYWxpemF0aW9uID0gdGV4Y29vcmROb3JtYWxpemF0aW9uMkRZICogdG9wQm90dG9tU2lkZTsKICAgICAgICAgIGlmICh0ZXhjb29yZE5vcm1hbGl6YXRpb24gPT09IDAgJiYgdG9wQm90dG9tU2lkZSA8IDApIHsKICAgICAgICAgICAgdGV4Y29vcmROb3JtYWxpemF0aW9uID0gOTsKICAgICAgICAgIH0KICAgICAgICAgIHRleGNvb3JkTm9ybWFsaXphdGlvbjJEW3ZlYzJJbmRleCArIDFdID0gdGV4Y29vcmROb3JtYWxpemF0aW9uOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBhZGp1c3RIZWlnaHRTdGFydEJvdHRvbSA9IGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tU2NyYXRjaDsKICAgICAgY29uc3QgYWRqdXN0SGVpZ2h0RW5kQm90dG9tID0gYWRqdXN0SGVpZ2h0RW5kQm90dG9tU2NyYXRjaDsKICAgICAgY29uc3QgYWRqdXN0SGVpZ2h0U3RhcnRUb3AgPSBhZGp1c3RIZWlnaHRTdGFydFRvcFNjcmF0Y2g7CiAgICAgIGNvbnN0IGFkanVzdEhlaWdodEVuZFRvcCA9IGFkanVzdEhlaWdodEVuZFRvcFNjcmF0Y2g7CiAgICAgIGNvbnN0IGdldEhlaWdodHNSZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5mcm9tQ2FydG9ncmFwaGljQXJyYXkoCiAgICAgICAgZ2V0SGVpZ2h0Q2FydG9ncmFwaGljcywKICAgICAgICBnZXRIZWlnaHRSZWN0YW5nbGVTY3JhdGNoCiAgICAgICk7CiAgICAgIGNvbnN0IG1pbk1heEhlaWdodHMgPSBBcHByb3hpbWF0ZVRlcnJhaW5IZWlnaHRzX2RlZmF1bHQuZ2V0TWluaW11bU1heGltdW1IZWlnaHRzKAogICAgICAgIGdldEhlaWdodHNSZWN0YW5nbGUsCiAgICAgICAgZWxsaXBzb2lkCiAgICAgICk7CiAgICAgIGNvbnN0IG1pbkhlaWdodCA9IG1pbk1heEhlaWdodHMubWluaW11bVRlcnJhaW5IZWlnaHQ7CiAgICAgIGNvbnN0IG1heEhlaWdodCA9IG1pbk1heEhlaWdodHMubWF4aW11bVRlcnJhaW5IZWlnaHQ7CiAgICAgIHN1bUhlaWdodHMgKz0gTWF0aC5hYnMobWluSGVpZ2h0KTsKICAgICAgc3VtSGVpZ2h0cyArPSBNYXRoLmFicyhtYXhIZWlnaHQpOwogICAgICBhZGp1c3RIZWlnaHRzKAogICAgICAgIHN0YXJ0Qm90dG9tLAogICAgICAgIHN0YXJ0VG9wLAogICAgICAgIG1pbkhlaWdodCwKICAgICAgICBtYXhIZWlnaHQsCiAgICAgICAgYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b20sCiAgICAgICAgYWRqdXN0SGVpZ2h0U3RhcnRUb3AKICAgICAgKTsKICAgICAgYWRqdXN0SGVpZ2h0cygKICAgICAgICBlbmRCb3R0b20sCiAgICAgICAgZW5kVG9wLAogICAgICAgIG1pbkhlaWdodCwKICAgICAgICBtYXhIZWlnaHQsCiAgICAgICAgYWRqdXN0SGVpZ2h0RW5kQm90dG9tLAogICAgICAgIGFkanVzdEhlaWdodEVuZFRvcAogICAgICApOwogICAgICBsZXQgbm9ybWFsTnVkZ2UgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICByaWdodE5vcm1hbCwKICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjUsCiAgICAgICAgbm9ybWFsTnVkZ2VTY3JhdGNoCiAgICAgICk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b20sCiAgICAgICAgbm9ybWFsTnVkZ2UsCiAgICAgICAgYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b20KICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChhZGp1c3RIZWlnaHRFbmRCb3R0b20sIG5vcm1hbE51ZGdlLCBhZGp1c3RIZWlnaHRFbmRCb3R0b20pOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGFkanVzdEhlaWdodFN0YXJ0VG9wLCBub3JtYWxOdWRnZSwgYWRqdXN0SGVpZ2h0U3RhcnRUb3ApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGFkanVzdEhlaWdodEVuZFRvcCwgbm9ybWFsTnVkZ2UsIGFkanVzdEhlaWdodEVuZFRvcCk7CiAgICAgIG51ZGdlWFooYWRqdXN0SGVpZ2h0U3RhcnRCb3R0b20sIGFkanVzdEhlaWdodEVuZEJvdHRvbSk7CiAgICAgIG51ZGdlWFooYWRqdXN0SGVpZ2h0U3RhcnRUb3AsIGFkanVzdEhlaWdodEVuZFRvcCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tLCBwb3NpdGlvbnNBcnJheSwgdmVjM3NXcml0ZUluZGV4KTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soYWRqdXN0SGVpZ2h0RW5kQm90dG9tLCBwb3NpdGlvbnNBcnJheSwgdmVjM3NXcml0ZUluZGV4ICsgMyk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGFkanVzdEhlaWdodEVuZFRvcCwgcG9zaXRpb25zQXJyYXksIHZlYzNzV3JpdGVJbmRleCArIDYpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhhZGp1c3RIZWlnaHRTdGFydFRvcCwgcG9zaXRpb25zQXJyYXksIHZlYzNzV3JpdGVJbmRleCArIDkpOwogICAgICBub3JtYWxOdWRnZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgIHJpZ2h0Tm9ybWFsLAogICAgICAgIC0yICogTWF0aF9kZWZhdWx0LkVQU0lMT041LAogICAgICAgIG5vcm1hbE51ZGdlU2NyYXRjaAogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgIGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tLAogICAgICAgIG5vcm1hbE51ZGdlLAogICAgICAgIGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tCiAgICAgICk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoYWRqdXN0SGVpZ2h0RW5kQm90dG9tLCBub3JtYWxOdWRnZSwgYWRqdXN0SGVpZ2h0RW5kQm90dG9tKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChhZGp1c3RIZWlnaHRTdGFydFRvcCwgbm9ybWFsTnVkZ2UsIGFkanVzdEhlaWdodFN0YXJ0VG9wKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChhZGp1c3RIZWlnaHRFbmRUb3AsIG5vcm1hbE51ZGdlLCBhZGp1c3RIZWlnaHRFbmRUb3ApOwogICAgICBudWRnZVhaKGFkanVzdEhlaWdodFN0YXJ0Qm90dG9tLCBhZGp1c3RIZWlnaHRFbmRCb3R0b20pOwogICAgICBudWRnZVhaKGFkanVzdEhlaWdodFN0YXJ0VG9wLCBhZGp1c3RIZWlnaHRFbmRUb3ApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjaygKICAgICAgICBhZGp1c3RIZWlnaHRTdGFydEJvdHRvbSwKICAgICAgICBwb3NpdGlvbnNBcnJheSwKICAgICAgICB2ZWMzc1dyaXRlSW5kZXggKyAxMgogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjaygKICAgICAgICBhZGp1c3RIZWlnaHRFbmRCb3R0b20sCiAgICAgICAgcG9zaXRpb25zQXJyYXksCiAgICAgICAgdmVjM3NXcml0ZUluZGV4ICsgMTUKICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soYWRqdXN0SGVpZ2h0RW5kVG9wLCBwb3NpdGlvbnNBcnJheSwgdmVjM3NXcml0ZUluZGV4ICsgMTgpOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhhZGp1c3RIZWlnaHRTdGFydFRvcCwgcG9zaXRpb25zQXJyYXksIHZlYzNzV3JpdGVJbmRleCArIDIxKTsKICAgICAgY2FydG9ncmFwaGljc0luZGV4ICs9IDI7CiAgICAgIGluZGV4ICs9IDM7CiAgICAgIHZlYzJzV3JpdGVJbmRleCArPSAxNjsKICAgICAgdmVjM3NXcml0ZUluZGV4ICs9IDI0OwogICAgICB2ZWM0c1dyaXRlSW5kZXggKz0gMzI7CiAgICAgIGxlbmd0aFNvRmFyM0QgKz0gc2VnbWVudExlbmd0aDNEOwogICAgICBsZW5ndGhTb0ZhcjJEICs9IHNlZ21lbnRMZW5ndGgyRDsKICAgIH0KICAgIGluZGV4ID0gMDsKICAgIGxldCBpbmRleE9mZnNldCA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgc2VnbWVudENvdW50OyBpKyspIHsKICAgICAgZm9yIChqID0gMDsgaiA8IFJFRkVSRU5DRV9JTkRJQ0VTX0xFTkdUSDsgaisrKSB7CiAgICAgICAgaW5kaWNlc1tpbmRleCArIGpdID0gUkVGRVJFTkNFX0lORElDRVNbal0gKyBpbmRleE9mZnNldDsKICAgICAgfQogICAgICBpbmRleE9mZnNldCArPSA4OwogICAgICBpbmRleCArPSBSRUZFUkVOQ0VfSU5ESUNFU19MRU5HVEg7CiAgICB9CiAgICBjb25zdCBib3VuZGluZ1NwaGVyZXMgPSBzY3JhdGNoQm91bmRpbmdTcGhlcmVzOwogICAgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMoCiAgICAgIGJvdHRvbVBvc2l0aW9uc0FycmF5LAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywKICAgICAgMywKICAgICAgYm91bmRpbmdTcGhlcmVzWzBdCiAgICApOwogICAgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMoCiAgICAgIHRvcFBvc2l0aW9uc0FycmF5LAogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTywKICAgICAgMywKICAgICAgYm91bmRpbmdTcGhlcmVzWzFdCiAgICApOwogICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21Cb3VuZGluZ1NwaGVyZXMoYm91bmRpbmdTcGhlcmVzKTsKICAgIGJvdW5kaW5nU3BoZXJlLnJhZGl1cyArPSBzdW1IZWlnaHRzIC8gKHNlZ21lbnRDb3VudCAqIDIpOwogICAgY29uc3QgYXR0cmlidXRlcyA9IHsKICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICBub3JtYWxpemU6IGZhbHNlLAogICAgICAgIHZhbHVlczogcG9zaXRpb25zQXJyYXkKICAgICAgfSksCiAgICAgIHN0YXJ0SGlBbmRGb3J3YXJkT2Zmc2V0WDogZ2V0VmVjNEdlb21ldHJ5QXR0cmlidXRlKAogICAgICAgIHN0YXJ0SGlBbmRGb3J3YXJkT2Zmc2V0WAogICAgICApLAogICAgICBzdGFydExvQW5kRm9yd2FyZE9mZnNldFk6IGdldFZlYzRHZW9tZXRyeUF0dHJpYnV0ZSgKICAgICAgICBzdGFydExvQW5kRm9yd2FyZE9mZnNldFkKICAgICAgKSwKICAgICAgc3RhcnROb3JtYWxBbmRGb3J3YXJkT2Zmc2V0WjogZ2V0VmVjNEdlb21ldHJ5QXR0cmlidXRlKAogICAgICAgIHN0YXJ0Tm9ybWFsQW5kRm9yd2FyZE9mZnNldFoKICAgICAgKSwKICAgICAgZW5kTm9ybWFsQW5kVGV4dHVyZUNvb3JkaW5hdGVOb3JtYWxpemF0aW9uWDogZ2V0VmVjNEdlb21ldHJ5QXR0cmlidXRlKAogICAgICAgIGVuZE5vcm1hbEFuZFRleHR1cmVDb29yZGluYXRlTm9ybWFsaXphdGlvblgKICAgICAgKSwKICAgICAgcmlnaHROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25ZOiBnZXRWZWM0R2VvbWV0cnlBdHRyaWJ1dGUoCiAgICAgICAgcmlnaHROb3JtYWxBbmRUZXh0dXJlQ29vcmRpbmF0ZU5vcm1hbGl6YXRpb25ZCiAgICAgICkKICAgIH07CiAgICBpZiAoY29tcHV0ZTJkQXR0cmlidXRlcykgewogICAgICBhdHRyaWJ1dGVzLnN0YXJ0SGlMbzJEID0gZ2V0VmVjNEdlb21ldHJ5QXR0cmlidXRlKHN0YXJ0SGlMbzJEKTsKICAgICAgYXR0cmlidXRlcy5vZmZzZXRBbmRSaWdodDJEID0gZ2V0VmVjNEdlb21ldHJ5QXR0cmlidXRlKG9mZnNldEFuZFJpZ2h0MkQpOwogICAgICBhdHRyaWJ1dGVzLnN0YXJ0RW5kTm9ybWFsczJEID0gZ2V0VmVjNEdlb21ldHJ5QXR0cmlidXRlKHN0YXJ0RW5kTm9ybWFsczJEKTsKICAgICAgYXR0cmlidXRlcy50ZXhjb29yZE5vcm1hbGl6YXRpb24yRCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgIG5vcm1hbGl6ZTogZmFsc2UsCiAgICAgICAgdmFsdWVzOiB0ZXhjb29yZE5vcm1hbGl6YXRpb24yRAogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgIGF0dHJpYnV0ZXMsCiAgICAgIGluZGljZXMsCiAgICAgIGJvdW5kaW5nU3BoZXJlCiAgICB9KTsKICB9CiAgZnVuY3Rpb24gZ2V0VmVjNEdlb21ldHJ5QXR0cmlidXRlKHR5cGVkQXJyYXkpIHsKICAgIHJldHVybiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiA0LAogICAgICBub3JtYWxpemU6IGZhbHNlLAogICAgICB2YWx1ZXM6IHR5cGVkQXJyYXkKICAgIH0pOwogIH0KICB2YXIgUFJPSkVDVElPTlMsIFBST0pFQ1RJT05fQ09VTlQsIE1JVEVSX0JSRUFLX1NNQUxMLCBNSVRFUl9CUkVBS19MQVJHRSwgV0FMTF9JTklUSUFMX01JTl9IRUlHSFQsIFdBTExfSU5JVElBTF9NQVhfSEVJR0hULCBjYXJ0M1NjcmF0Y2gxLCBjYXJ0M1NjcmF0Y2gyLCBjYXJ0M1NjcmF0Y2gzLCBpbnRlcnBvbGF0ZWRDYXJ0b2dyYXBoaWNTY3JhdGNoLCBpbnRlcnBvbGF0ZWRCb3R0b21TY3JhdGNoLCBpbnRlcnBvbGF0ZWRUb3BTY3JhdGNoLCBpbnRlcnBvbGF0ZWROb3JtYWxTY3JhdGNoLCBoZWlnaHRsZXNzQ2FydG9ncmFwaGljU2NyYXRjaCwgdG9QcmV2aW91c1NjcmF0Y2gsIHRvTmV4dFNjcmF0Y2gsIGZvcndhcmRTY3JhdGNoLCB2ZXJ0ZXhVcFNjcmF0Y2gsIGNvc2luZTkwLCBjb3NpbmUxODAsIFhaX1BMQU5FLCBwcmV2aW91c0JvdHRvbVNjcmF0Y2gsIHZlcnRleEJvdHRvbVNjcmF0Y2gsIHZlcnRleFRvcFNjcmF0Y2gsIG5leHRCb3R0b21TY3JhdGNoLCB2ZXJ0ZXhOb3JtYWxTY3JhdGNoLCBpbnRlcnNlY3Rpb25TY3JhdGNoLCBjYXJ0b2dyYXBoaWNTY3JhdGNoMCwgY2FydG9ncmFwaGljU2NyYXRjaDEsIGNhcnRvZ3JhcGhpY0ludGVyc2VjdGlvblNjcmF0Y2gsIGxpbmVEaXJlY3Rpb25TY3JhdGNoLCBtYXRyaXgzU2NyYXRjaCwgcXVhdGVybmlvblNjcmF0Y2gzLCBlbmRQb3NDYXJ0b2dyYXBoaWNTY3JhdGNoLCBub3JtYWxTdGFydHBvaW50U2NyYXRjaCwgbm9ybWFsRW5kcG9pbnRTY3JhdGNoLCBhZGp1c3RIZWlnaHROb3JtYWxTY3JhdGNoLCBhZGp1c3RIZWlnaHRPZmZzZXRTY3JhdGNoLCBudWRnZURpcmVjdGlvblNjcmF0Y2gsIHN0YXJ0Q2FydG9ncmFwaGljU2NyYXRjaCwgZW5kQ2FydG9ncmFwaGljU2NyYXRjaCwgc2VnbWVudFN0YXJ0VG9wU2NyYXRjaCwgc2VnbWVudEVuZFRvcFNjcmF0Y2gsIHNlZ21lbnRTdGFydEJvdHRvbVNjcmF0Y2gsIHNlZ21lbnRFbmRCb3R0b21TY3JhdGNoLCBzZWdtZW50U3RhcnROb3JtYWxTY3JhdGNoLCBzZWdtZW50RW5kTm9ybWFsU2NyYXRjaCwgZ2V0SGVpZ2h0Q2FydG9ncmFwaGljcywgZ2V0SGVpZ2h0UmVjdGFuZ2xlU2NyYXRjaCwgYWRqdXN0SGVpZ2h0U3RhcnRUb3BTY3JhdGNoLCBhZGp1c3RIZWlnaHRFbmRUb3BTY3JhdGNoLCBhZGp1c3RIZWlnaHRTdGFydEJvdHRvbVNjcmF0Y2gsIGFkanVzdEhlaWdodEVuZEJvdHRvbVNjcmF0Y2gsIHNlZ21lbnRTdGFydDJEU2NyYXRjaCwgc2VnbWVudEVuZDJEU2NyYXRjaCwgc2VnbWVudFN0YXJ0Tm9ybWFsMkRTY3JhdGNoLCBzZWdtZW50RW5kTm9ybWFsMkRTY3JhdGNoLCBvZmZzZXRTY3JhdGNoMiwgc3RhcnRVcFNjcmF0Y2gsIGVuZFVwU2NyYXRjaCwgcmlnaHRTY3JhdGNoMiwgc3RhcnRQbGFuZU5vcm1hbFNjcmF0Y2gsIGVuZFBsYW5lTm9ybWFsU2NyYXRjaCwgZW5jb2RlU2NyYXRjaCwgZW5jb2RlU2NyYXRjaDJELCBmb3J3YXJkT2Zmc2V0MkRTY3JhdGNoLCByaWdodDJEU2NyYXRjaCwgbm9ybWFsTnVkZ2VTY3JhdGNoLCBzY3JhdGNoQm91bmRpbmdTcGhlcmVzLCBSRUZFUkVOQ0VfSU5ESUNFUywgUkVGRVJFTkNFX0lORElDRVNfTEVOR1RILCBHcm91bmRQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfR3JvdW5kUG9seWxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvR3JvdW5kUG9seWxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cygpOwogICAgICBpbml0X0FyY1R5cGUoKTsKICAgICAgaW5pdF9hcnJheVJlbW92ZUR1cGxpY2F0ZXMoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkR2VvZGVzaWMoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRSaHVtYkxpbmUoKTsKICAgICAgaW5pdF9FbmNvZGVkQ2FydGVzaWFuMygpOwogICAgICBpbml0X0dlb2dyYXBoaWNQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0ludGVyc2VjdGlvblRlc3RzKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDMoKTsKICAgICAgaW5pdF9QbGFuZSgpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9XZWJNZXJjYXRvclByb2plY3Rpb24oKTsKICAgICAgUFJPSkVDVElPTlMgPSBbR2VvZ3JhcGhpY1Byb2plY3Rpb25fZGVmYXVsdCwgV2ViTWVyY2F0b3JQcm9qZWN0aW9uX2RlZmF1bHRdOwogICAgICBQUk9KRUNUSU9OX0NPVU5UID0gUFJPSkVDVElPTlMubGVuZ3RoOwogICAgICBNSVRFUl9CUkVBS19TTUFMTCA9IE1hdGguY29zKE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMzApKTsKICAgICAgTUlURVJfQlJFQUtfTEFSR0UgPSBNYXRoLmNvcyhNYXRoX2RlZmF1bHQudG9SYWRpYW5zKDE1MCkpOwogICAgICBXQUxMX0lOSVRJQUxfTUlOX0hFSUdIVCA9IDA7CiAgICAgIFdBTExfSU5JVElBTF9NQVhfSEVJR0hUID0gMWUzOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhHcm91bmRQb2x5bGluZUdlb21ldHJ5LnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgdXNlZCB0byBwYWNrIHRoZSBvYmplY3QgaW50byBhbiBhcnJheS4KICAgICAgICAgKiBAbWVtYmVyb2YgR3JvdW5kUG9seWxpbmVHZW9tZXRyeS5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgcGFja2VkTGVuZ3RoOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gMSArIHRoaXMuX3Bvc2l0aW9ucy5sZW5ndGggKiAzICsgMSArIDEgKyAxICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMSArIDE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgR3JvdW5kUG9seWxpbmVHZW9tZXRyeS5zZXRQcm9qZWN0aW9uQW5kRWxsaXBzb2lkID0gZnVuY3Rpb24oZ3JvdW5kUG9seWxpbmVHZW9tZXRyeSwgbWFwUHJvamVjdGlvbikgewogICAgICAgIGxldCBwcm9qZWN0aW9uSW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgUFJPSkVDVElPTl9DT1VOVDsgaSsrKSB7CiAgICAgICAgICBpZiAobWFwUHJvamVjdGlvbiBpbnN0YW5jZW9mIFBST0pFQ1RJT05TW2ldKSB7CiAgICAgICAgICAgIHByb2plY3Rpb25JbmRleCA9IGk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBncm91bmRQb2x5bGluZUdlb21ldHJ5Ll9wcm9qZWN0aW9uSW5kZXggPSBwcm9qZWN0aW9uSW5kZXg7CiAgICAgICAgZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5fZWxsaXBzb2lkID0gbWFwUHJvamVjdGlvbi5lbGxpcHNvaWQ7CiAgICAgIH07CiAgICAgIGNhcnQzU2NyYXRjaDEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnQzU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnQzU2NyYXRjaDMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGludGVycG9sYXRlZENhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgaW50ZXJwb2xhdGVkQm90dG9tU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgaW50ZXJwb2xhdGVkVG9wU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgaW50ZXJwb2xhdGVkTm9ybWFsU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgaGVpZ2h0bGVzc0NhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgR3JvdW5kUG9seWxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIGxldCBpbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHZhbHVlLl9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBhcnJheVtpbmRleCsrXSA9IHBvc2l0aW9uc0xlbmd0aDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aDsgKytpKSB7CiAgICAgICAgICBjb25zdCBjYXJ0ZXNpYW4xMSA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGNhcnRlc2lhbjExLCBhcnJheSwgaW5kZXgpOwogICAgICAgICAgaW5kZXggKz0gMzsKICAgICAgICB9CiAgICAgICAgYXJyYXlbaW5kZXgrK10gPSB2YWx1ZS5ncmFudWxhcml0eTsKICAgICAgICBhcnJheVtpbmRleCsrXSA9IHZhbHVlLmxvb3AgPyAxIDogMDsKICAgICAgICBhcnJheVtpbmRleCsrXSA9IHZhbHVlLmFyY1R5cGU7CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgaW5kZXgpOwogICAgICAgIGluZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtpbmRleCsrXSA9IHZhbHVlLl9wcm9qZWN0aW9uSW5kZXg7CiAgICAgICAgYXJyYXlbaW5kZXgrK10gPSB2YWx1ZS5fc2NlbmUzRE9ubHkgPyAxIDogMDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgbGV0IGluZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gYXJyYXlbaW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KHBvc2l0aW9uc0xlbmd0aCk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7IGkrKykgewogICAgICAgICAgcG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgaW5kZXgpOwogICAgICAgICAgaW5kZXggKz0gMzsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBhcnJheVtpbmRleCsrXTsKICAgICAgICBjb25zdCBsb29wID0gYXJyYXlbaW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3QgYXJjVHlwZSA9IGFycmF5W2luZGV4KytdOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgaW5kZXgpOwogICAgICAgIGluZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBwcm9qZWN0aW9uSW5kZXggPSBhcnJheVtpbmRleCsrXTsKICAgICAgICBjb25zdCBzY2VuZTNET25seSA9IGFycmF5W2luZGV4KytdID09PSAxOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBHcm91bmRQb2x5bGluZUdlb21ldHJ5KHsKICAgICAgICAgICAgcG9zaXRpb25zCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmVzdWx0Lmxvb3AgPSBsb29wOwogICAgICAgIHJlc3VsdC5hcmNUeXBlID0gYXJjVHlwZTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IGVsbGlwc29pZDsKICAgICAgICByZXN1bHQuX3Byb2plY3Rpb25JbmRleCA9IHByb2plY3Rpb25JbmRleDsKICAgICAgICByZXN1bHQuX3NjZW5lM0RPbmx5ID0gc2NlbmUzRE9ubHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgdG9QcmV2aW91c1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHRvTmV4dFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZvcndhcmRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB2ZXJ0ZXhVcFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNvc2luZTkwID0gMDsKICAgICAgY29zaW5lMTgwID0gLTE7CiAgICAgIFhaX1BMQU5FID0gUGxhbmVfZGVmYXVsdC5mcm9tUG9pbnROb3JtYWwoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1kpOwogICAgICBwcmV2aW91c0JvdHRvbVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHZlcnRleEJvdHRvbVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHZlcnRleFRvcFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG5leHRCb3R0b21TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB2ZXJ0ZXhOb3JtYWxTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBpbnRlcnNlY3Rpb25TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoMCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoMSA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBjYXJ0b2dyYXBoaWNJbnRlcnNlY3Rpb25TY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIEdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihncm91bmRQb2x5bGluZUdlb21ldHJ5KSB7CiAgICAgICAgY29uc3QgY29tcHV0ZTJkQXR0cmlidXRlcyA9ICFncm91bmRQb2x5bGluZUdlb21ldHJ5Ll9zY2VuZTNET25seTsKICAgICAgICBsZXQgbG9vcCA9IGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkubG9vcDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBncm91bmRQb2x5bGluZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBncm91bmRQb2x5bGluZUdlb21ldHJ5LmdyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBncm91bmRQb2x5bGluZUdlb21ldHJ5LmFyY1R5cGU7CiAgICAgICAgY29uc3QgcHJvamVjdGlvbiA9IG5ldyBQUk9KRUNUSU9OU1tncm91bmRQb2x5bGluZUdlb21ldHJ5Ll9wcm9qZWN0aW9uSW5kZXhdKAogICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgKTsKICAgICAgICBjb25zdCBtaW5IZWlnaHQgPSBXQUxMX0lOSVRJQUxfTUlOX0hFSUdIVDsKICAgICAgICBjb25zdCBtYXhIZWlnaHQgPSBXQUxMX0lOSVRJQUxfTUFYX0hFSUdIVDsKICAgICAgICBsZXQgaW5kZXg7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5fcG9zaXRpb25zOwogICAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgaWYgKHBvc2l0aW9uc0xlbmd0aCA9PT0gMikgewogICAgICAgICAgbG9vcCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBsZXQgcDA7CiAgICAgICAgbGV0IHAxOwogICAgICAgIGxldCBjMDsKICAgICAgICBsZXQgYzE7CiAgICAgICAgY29uc3Qgcmh1bWJMaW5lID0gbmV3IEVsbGlwc29pZFJodW1iTGluZV9kZWZhdWx0KHZvaWQgMCwgdm9pZCAwLCBlbGxpcHNvaWQpOwogICAgICAgIGxldCBpbnRlcnNlY3Rpb247CiAgICAgICAgbGV0IGludGVyc2VjdGlvbkNhcnRvZ3JhcGhpYzsKICAgICAgICBsZXQgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlOwogICAgICAgIGNvbnN0IHNwbGl0UG9zaXRpb25zID0gW3Bvc2l0aW9uc1swXV07CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgcDAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICBwMSA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgICAgICBpbnRlcnNlY3Rpb24gPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LmxpbmVTZWdtZW50UGxhbmUoCiAgICAgICAgICAgIHAwLAogICAgICAgICAgICBwMSwKICAgICAgICAgICAgWFpfUExBTkUsCiAgICAgICAgICAgIGludGVyc2VjdGlvblNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGludGVyc2VjdGlvbikgJiYgIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGludGVyc2VjdGlvbiwgcDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9ONykgJiYgIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGludGVyc2VjdGlvbiwgcDEsIE1hdGhfZGVmYXVsdC5FUFNJTE9ONykpIHsKICAgICAgICAgICAgaWYgKGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgICAgICAgc3BsaXRQb3NpdGlvbnMucHVzaChDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoaW50ZXJzZWN0aW9uKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5hcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICAgICAgICBpbnRlcnNlY3Rpb25Mb25naXR1ZGUgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoCiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24sCiAgICAgICAgICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoMAogICAgICAgICAgICAgICkubG9uZ2l0dWRlOwogICAgICAgICAgICAgIGMwID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAwLCBjYXJ0b2dyYXBoaWNTY3JhdGNoMCk7CiAgICAgICAgICAgICAgYzEgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDEsIGNhcnRvZ3JhcGhpY1NjcmF0Y2gxKTsKICAgICAgICAgICAgICByaHVtYkxpbmUuc2V0RW5kUG9pbnRzKGMwLCBjMSk7CiAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uQ2FydG9ncmFwaGljID0gcmh1bWJMaW5lLmZpbmRJbnRlcnNlY3Rpb25XaXRoTG9uZ2l0dWRlKAogICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uTG9uZ2l0dWRlLAogICAgICAgICAgICAgICAgY2FydG9ncmFwaGljSW50ZXJzZWN0aW9uU2NyYXRjaAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uQ2FydG9ncmFwaGljLAogICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uU2NyYXRjaAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChpbnRlcnNlY3Rpb24pICYmICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihpbnRlcnNlY3Rpb24sIHAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjcpICYmICFDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihpbnRlcnNlY3Rpb24sIHAxLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjcpKSB7CiAgICAgICAgICAgICAgICBzcGxpdFBvc2l0aW9ucy5wdXNoKENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShpbnRlcnNlY3Rpb24pKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHNwbGl0UG9zaXRpb25zLnB1c2gocDEpOwogICAgICAgIH0KICAgICAgICBpZiAobG9vcCkgewogICAgICAgICAgcDAgPSBwb3NpdGlvbnNbcG9zaXRpb25zTGVuZ3RoIC0gMV07CiAgICAgICAgICBwMSA9IHBvc2l0aW9uc1swXTsKICAgICAgICAgIGludGVyc2VjdGlvbiA9IEludGVyc2VjdGlvblRlc3RzX2RlZmF1bHQubGluZVNlZ21lbnRQbGFuZSgKICAgICAgICAgICAgcDAsCiAgICAgICAgICAgIHAxLAogICAgICAgICAgICBYWl9QTEFORSwKICAgICAgICAgICAgaW50ZXJzZWN0aW9uU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW50ZXJzZWN0aW9uKSAmJiAhQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oaW50ZXJzZWN0aW9uLCBwMCwgTWF0aF9kZWZhdWx0LkVQU0lMT043KSAmJiAhQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24oaW50ZXJzZWN0aW9uLCBwMSwgTWF0aF9kZWZhdWx0LkVQU0lMT043KSkgewogICAgICAgICAgICBpZiAoZ3JvdW5kUG9seWxpbmVHZW9tZXRyeS5hcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgICAgICBzcGxpdFBvc2l0aW9ucy5wdXNoKENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShpbnRlcnNlY3Rpb24pKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChncm91bmRQb2x5bGluZUdlb21ldHJ5LmFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICAgICAgICAgIGludGVyc2VjdGlvbkxvbmdpdHVkZSA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbiwKICAgICAgICAgICAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gwCiAgICAgICAgICAgICAgKS5sb25naXR1ZGU7CiAgICAgICAgICAgICAgYzAgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDAsIGNhcnRvZ3JhcGhpY1NjcmF0Y2gwKTsKICAgICAgICAgICAgICBjMSA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhwMSwgY2FydG9ncmFwaGljU2NyYXRjaDEpOwogICAgICAgICAgICAgIHJodW1iTGluZS5zZXRFbmRQb2ludHMoYzAsIGMxKTsKICAgICAgICAgICAgICBpbnRlcnNlY3Rpb25DYXJ0b2dyYXBoaWMgPSByaHVtYkxpbmUuZmluZEludGVyc2VjdGlvbldpdGhMb25naXR1ZGUoCiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb25Mb25naXR1ZGUsCiAgICAgICAgICAgICAgICBjYXJ0b2dyYXBoaWNJbnRlcnNlY3Rpb25TY3JhdGNoCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb25DYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb25TY3JhdGNoCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGludGVyc2VjdGlvbikgJiYgIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGludGVyc2VjdGlvbiwgcDAsIE1hdGhfZGVmYXVsdC5FUFNJTE9ONykgJiYgIUNhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGludGVyc2VjdGlvbiwgcDEsIE1hdGhfZGVmYXVsdC5FUFNJTE9ONykpIHsKICAgICAgICAgICAgICAgIHNwbGl0UG9zaXRpb25zLnB1c2goQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGludGVyc2VjdGlvbikpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZXQgY2FydG9ncmFwaGljc0xlbmd0aCA9IHNwbGl0UG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgY2FydG9ncmFwaGljcyA9IG5ldyBBcnJheShjYXJ0b2dyYXBoaWNzTGVuZ3RoKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY2FydG9ncmFwaGljc0xlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBjYXJ0b2dyYXBoaWMyID0gQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbUNhcnRlc2lhbigKICAgICAgICAgICAgc3BsaXRQb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICAgKTsKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIuaGVpZ2h0ID0gMDsKICAgICAgICAgIGNhcnRvZ3JhcGhpY3NbaV0gPSBjYXJ0b2dyYXBoaWMyOwogICAgICAgIH0KICAgICAgICBjYXJ0b2dyYXBoaWNzID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgICAgICBjYXJ0b2dyYXBoaWNzLAogICAgICAgICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuZXF1YWxzRXBzaWxvbgogICAgICAgICk7CiAgICAgICAgY2FydG9ncmFwaGljc0xlbmd0aCA9IGNhcnRvZ3JhcGhpY3MubGVuZ3RoOwogICAgICAgIGlmIChjYXJ0b2dyYXBoaWNzTGVuZ3RoIDwgMikgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2FydG9ncmFwaGljc0FycmF5ID0gW107CiAgICAgICAgY29uc3Qgbm9ybWFsc0FycmF5ID0gW107CiAgICAgICAgY29uc3QgYm90dG9tUG9zaXRpb25zQXJyYXkgPSBbXTsKICAgICAgICBjb25zdCB0b3BQb3NpdGlvbnNBcnJheSA9IFtdOwogICAgICAgIGxldCBwcmV2aW91c0JvdHRvbSA9IHByZXZpb3VzQm90dG9tU2NyYXRjaDsKICAgICAgICBsZXQgdmVydGV4Qm90dG9tID0gdmVydGV4Qm90dG9tU2NyYXRjaDsKICAgICAgICBsZXQgdmVydGV4VG9wID0gdmVydGV4VG9wU2NyYXRjaDsKICAgICAgICBsZXQgbmV4dEJvdHRvbSA9IG5leHRCb3R0b21TY3JhdGNoOwogICAgICAgIGxldCB2ZXJ0ZXhOb3JtYWwgPSB2ZXJ0ZXhOb3JtYWxTY3JhdGNoOwogICAgICAgIGNvbnN0IHN0YXJ0Q2FydG9ncmFwaGljID0gY2FydG9ncmFwaGljc1swXTsKICAgICAgICBjb25zdCBuZXh0Q2FydG9ncmFwaGljID0gY2FydG9ncmFwaGljc1sxXTsKICAgICAgICBjb25zdCBwcmVzdGFydENhcnRvZ3JhcGhpYyA9IGNhcnRvZ3JhcGhpY3NbY2FydG9ncmFwaGljc0xlbmd0aCAtIDFdOwogICAgICAgIHByZXZpb3VzQm90dG9tID0gZ2V0UG9zaXRpb24oCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBwcmVzdGFydENhcnRvZ3JhcGhpYywKICAgICAgICAgIG1pbkhlaWdodCwKICAgICAgICAgIHByZXZpb3VzQm90dG9tCiAgICAgICAgKTsKICAgICAgICBuZXh0Qm90dG9tID0gZ2V0UG9zaXRpb24oZWxsaXBzb2lkLCBuZXh0Q2FydG9ncmFwaGljLCBtaW5IZWlnaHQsIG5leHRCb3R0b20pOwogICAgICAgIHZlcnRleEJvdHRvbSA9IGdldFBvc2l0aW9uKAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgICB2ZXJ0ZXhCb3R0b20KICAgICAgICApOwogICAgICAgIHZlcnRleFRvcCA9IGdldFBvc2l0aW9uKGVsbGlwc29pZCwgc3RhcnRDYXJ0b2dyYXBoaWMsIG1heEhlaWdodCwgdmVydGV4VG9wKTsKICAgICAgICBpZiAobG9vcCkgewogICAgICAgICAgdmVydGV4Tm9ybWFsID0gY29tcHV0ZVZlcnRleE1pdGVyTm9ybWFsKAogICAgICAgICAgICBwcmV2aW91c0JvdHRvbSwKICAgICAgICAgICAgdmVydGV4Qm90dG9tLAogICAgICAgICAgICB2ZXJ0ZXhUb3AsCiAgICAgICAgICAgIG5leHRCb3R0b20sCiAgICAgICAgICAgIHZlcnRleE5vcm1hbAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmVydGV4Tm9ybWFsID0gY29tcHV0ZVJpZ2h0Tm9ybWFsKAogICAgICAgICAgICBzdGFydENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgbmV4dENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgbWF4SGVpZ2h0LAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHZlcnRleE5vcm1hbAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmVydGV4Tm9ybWFsLCBub3JtYWxzQXJyYXksIDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZlcnRleEJvdHRvbSwgYm90dG9tUG9zaXRpb25zQXJyYXksIDApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZlcnRleFRvcCwgdG9wUG9zaXRpb25zQXJyYXksIDApOwogICAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheS5wdXNoKHN0YXJ0Q2FydG9ncmFwaGljLmxhdGl0dWRlKTsKICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkucHVzaChzdGFydENhcnRvZ3JhcGhpYy5sb25naXR1ZGUpOwogICAgICAgIGludGVycG9sYXRlU2VnbWVudCgKICAgICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljLAogICAgICAgICAgbmV4dENhcnRvZ3JhcGhpYywKICAgICAgICAgIG1pbkhlaWdodCwKICAgICAgICAgIG1heEhlaWdodCwKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgYXJjVHlwZSwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIG5vcm1hbHNBcnJheSwKICAgICAgICAgIGJvdHRvbVBvc2l0aW9uc0FycmF5LAogICAgICAgICAgdG9wUG9zaXRpb25zQXJyYXksCiAgICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkKICAgICAgICApOwogICAgICAgIGZvciAoaSA9IDE7IGkgPCBjYXJ0b2dyYXBoaWNzTGVuZ3RoIC0gMTsgKytpKSB7CiAgICAgICAgICBwcmV2aW91c0JvdHRvbSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhCb3R0b20sIHByZXZpb3VzQm90dG9tKTsKICAgICAgICAgIHZlcnRleEJvdHRvbSA9IENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShuZXh0Qm90dG9tLCB2ZXJ0ZXhCb3R0b20pOwogICAgICAgICAgY29uc3QgdmVydGV4Q2FydG9ncmFwaGljID0gY2FydG9ncmFwaGljc1tpXTsKICAgICAgICAgIGdldFBvc2l0aW9uKGVsbGlwc29pZCwgdmVydGV4Q2FydG9ncmFwaGljLCBtYXhIZWlnaHQsIHZlcnRleFRvcCk7CiAgICAgICAgICBnZXRQb3NpdGlvbihlbGxpcHNvaWQsIGNhcnRvZ3JhcGhpY3NbaSArIDFdLCBtaW5IZWlnaHQsIG5leHRCb3R0b20pOwogICAgICAgICAgY29tcHV0ZVZlcnRleE1pdGVyTm9ybWFsKAogICAgICAgICAgICBwcmV2aW91c0JvdHRvbSwKICAgICAgICAgICAgdmVydGV4Qm90dG9tLAogICAgICAgICAgICB2ZXJ0ZXhUb3AsCiAgICAgICAgICAgIG5leHRCb3R0b20sCiAgICAgICAgICAgIHZlcnRleE5vcm1hbAogICAgICAgICAgKTsKICAgICAgICAgIGluZGV4ID0gbm9ybWFsc0FycmF5Lmxlbmd0aDsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZlcnRleE5vcm1hbCwgbm9ybWFsc0FycmF5LCBpbmRleCk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2ZXJ0ZXhCb3R0b20sIGJvdHRvbVBvc2l0aW9uc0FycmF5LCBpbmRleCk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayh2ZXJ0ZXhUb3AsIHRvcFBvc2l0aW9uc0FycmF5LCBpbmRleCk7CiAgICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkucHVzaCh2ZXJ0ZXhDYXJ0b2dyYXBoaWMubGF0aXR1ZGUpOwogICAgICAgICAgY2FydG9ncmFwaGljc0FycmF5LnB1c2godmVydGV4Q2FydG9ncmFwaGljLmxvbmdpdHVkZSk7CiAgICAgICAgICBpbnRlcnBvbGF0ZVNlZ21lbnQoCiAgICAgICAgICAgIGNhcnRvZ3JhcGhpY3NbaV0sCiAgICAgICAgICAgIGNhcnRvZ3JhcGhpY3NbaSArIDFdLAogICAgICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgICAgIG1heEhlaWdodCwKICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgIGFyY1R5cGUsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgbm9ybWFsc0FycmF5LAogICAgICAgICAgICBib3R0b21Qb3NpdGlvbnNBcnJheSwKICAgICAgICAgICAgdG9wUG9zaXRpb25zQXJyYXksCiAgICAgICAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZW5kQ2FydG9ncmFwaGljID0gY2FydG9ncmFwaGljc1tjYXJ0b2dyYXBoaWNzTGVuZ3RoIC0gMV07CiAgICAgICAgY29uc3QgcHJlRW5kQ2FydG9ncmFwaGljID0gY2FydG9ncmFwaGljc1tjYXJ0b2dyYXBoaWNzTGVuZ3RoIC0gMl07CiAgICAgICAgdmVydGV4Qm90dG9tID0gZ2V0UG9zaXRpb24oCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBlbmRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICBtaW5IZWlnaHQsCiAgICAgICAgICB2ZXJ0ZXhCb3R0b20KICAgICAgICApOwogICAgICAgIHZlcnRleFRvcCA9IGdldFBvc2l0aW9uKGVsbGlwc29pZCwgZW5kQ2FydG9ncmFwaGljLCBtYXhIZWlnaHQsIHZlcnRleFRvcCk7CiAgICAgICAgaWYgKGxvb3ApIHsKICAgICAgICAgIGNvbnN0IHBvc3RFbmRDYXJ0b2dyYXBoaWMgPSBjYXJ0b2dyYXBoaWNzWzBdOwogICAgICAgICAgcHJldmlvdXNCb3R0b20gPSBnZXRQb3NpdGlvbigKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBwcmVFbmRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIG1pbkhlaWdodCwKICAgICAgICAgICAgcHJldmlvdXNCb3R0b20KICAgICAgICAgICk7CiAgICAgICAgICBuZXh0Qm90dG9tID0gZ2V0UG9zaXRpb24oCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgcG9zdEVuZENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgbWluSGVpZ2h0LAogICAgICAgICAgICBuZXh0Qm90dG9tCiAgICAgICAgICApOwogICAgICAgICAgdmVydGV4Tm9ybWFsID0gY29tcHV0ZVZlcnRleE1pdGVyTm9ybWFsKAogICAgICAgICAgICBwcmV2aW91c0JvdHRvbSwKICAgICAgICAgICAgdmVydGV4Qm90dG9tLAogICAgICAgICAgICB2ZXJ0ZXhUb3AsCiAgICAgICAgICAgIG5leHRCb3R0b20sCiAgICAgICAgICAgIHZlcnRleE5vcm1hbAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmVydGV4Tm9ybWFsID0gY29tcHV0ZVJpZ2h0Tm9ybWFsKAogICAgICAgICAgICBwcmVFbmRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIGVuZENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgbWF4SGVpZ2h0LAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHZlcnRleE5vcm1hbAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaW5kZXggPSBub3JtYWxzQXJyYXkubGVuZ3RoOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZlcnRleE5vcm1hbCwgbm9ybWFsc0FycmF5LCBpbmRleCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sodmVydGV4Qm90dG9tLCBib3R0b21Qb3NpdGlvbnNBcnJheSwgaW5kZXgpOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHZlcnRleFRvcCwgdG9wUG9zaXRpb25zQXJyYXksIGluZGV4KTsKICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkucHVzaChlbmRDYXJ0b2dyYXBoaWMubGF0aXR1ZGUpOwogICAgICAgIGNhcnRvZ3JhcGhpY3NBcnJheS5wdXNoKGVuZENhcnRvZ3JhcGhpYy5sb25naXR1ZGUpOwogICAgICAgIGlmIChsb29wKSB7CiAgICAgICAgICBpbnRlcnBvbGF0ZVNlZ21lbnQoCiAgICAgICAgICAgIGVuZENhcnRvZ3JhcGhpYywKICAgICAgICAgICAgc3RhcnRDYXJ0b2dyYXBoaWMsCiAgICAgICAgICAgIG1pbkhlaWdodCwKICAgICAgICAgICAgbWF4SGVpZ2h0LAogICAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgICAgYXJjVHlwZSwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBub3JtYWxzQXJyYXksCiAgICAgICAgICAgIGJvdHRvbVBvc2l0aW9uc0FycmF5LAogICAgICAgICAgICB0b3BQb3NpdGlvbnNBcnJheSwKICAgICAgICAgICAgY2FydG9ncmFwaGljc0FycmF5CiAgICAgICAgICApOwogICAgICAgICAgaW5kZXggPSBub3JtYWxzQXJyYXkubGVuZ3RoOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IDM7ICsraSkgewogICAgICAgICAgICBub3JtYWxzQXJyYXlbaW5kZXggKyBpXSA9IG5vcm1hbHNBcnJheVtpXTsKICAgICAgICAgICAgYm90dG9tUG9zaXRpb25zQXJyYXlbaW5kZXggKyBpXSA9IGJvdHRvbVBvc2l0aW9uc0FycmF5W2ldOwogICAgICAgICAgICB0b3BQb3NpdGlvbnNBcnJheVtpbmRleCArIGldID0gdG9wUG9zaXRpb25zQXJyYXlbaV07CiAgICAgICAgICB9CiAgICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkucHVzaChzdGFydENhcnRvZ3JhcGhpYy5sYXRpdHVkZSk7CiAgICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXkucHVzaChzdGFydENhcnRvZ3JhcGhpYy5sb25naXR1ZGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ2VuZXJhdGVHZW9tZXRyeUF0dHJpYnV0ZXMoCiAgICAgICAgICBsb29wLAogICAgICAgICAgcHJvamVjdGlvbiwKICAgICAgICAgIGJvdHRvbVBvc2l0aW9uc0FycmF5LAogICAgICAgICAgdG9wUG9zaXRpb25zQXJyYXksCiAgICAgICAgICBub3JtYWxzQXJyYXksCiAgICAgICAgICBjYXJ0b2dyYXBoaWNzQXJyYXksCiAgICAgICAgICBjb21wdXRlMmRBdHRyaWJ1dGVzCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgbGluZURpcmVjdGlvblNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG1hdHJpeDNTY3JhdGNoID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBxdWF0ZXJuaW9uU2NyYXRjaDMgPSBuZXcgUXVhdGVybmlvbl9kZWZhdWx0KCk7CiAgICAgIGVuZFBvc0NhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgbm9ybWFsU3RhcnRwb2ludFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG5vcm1hbEVuZHBvaW50U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYWRqdXN0SGVpZ2h0Tm9ybWFsU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYWRqdXN0SGVpZ2h0T2Zmc2V0U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbnVkZ2VEaXJlY3Rpb25TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzdGFydENhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgZW5kQ2FydG9ncmFwaGljU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzZWdtZW50U3RhcnRUb3BTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzZWdtZW50RW5kVG9wU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2VnbWVudFN0YXJ0Qm90dG9tU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2VnbWVudEVuZEJvdHRvbVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlZ21lbnRTdGFydE5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlZ21lbnRFbmROb3JtYWxTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBnZXRIZWlnaHRDYXJ0b2dyYXBoaWNzID0gWwogICAgICAgIHN0YXJ0Q2FydG9ncmFwaGljU2NyYXRjaCwKICAgICAgICBlbmRDYXJ0b2dyYXBoaWNTY3JhdGNoCiAgICAgIF07CiAgICAgIGdldEhlaWdodFJlY3RhbmdsZVNjcmF0Y2ggPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgYWRqdXN0SGVpZ2h0U3RhcnRUb3BTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBhZGp1c3RIZWlnaHRFbmRUb3BTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBhZGp1c3RIZWlnaHRTdGFydEJvdHRvbVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGFkanVzdEhlaWdodEVuZEJvdHRvbVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNlZ21lbnRTdGFydDJEU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2VnbWVudEVuZDJEU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2VnbWVudFN0YXJ0Tm9ybWFsMkRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzZWdtZW50RW5kTm9ybWFsMkRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBvZmZzZXRTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3RhcnRVcFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGVuZFVwU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcmlnaHRTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc3RhcnRQbGFuZU5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGVuZFBsYW5lTm9ybWFsU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgZW5jb2RlU2NyYXRjaCA9IG5ldyBFbmNvZGVkQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGVuY29kZVNjcmF0Y2gyRCA9IG5ldyBFbmNvZGVkQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGZvcndhcmRPZmZzZXQyRFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHJpZ2h0MkRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBub3JtYWxOdWRnZVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hCb3VuZGluZ1NwaGVyZXMgPSBbbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKSwgbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKV07CiAgICAgIFJFRkVSRU5DRV9JTkRJQ0VTID0gWwogICAgICAgIDAsCiAgICAgICAgMiwKICAgICAgICAxLAogICAgICAgIDAsCiAgICAgICAgMywKICAgICAgICAyLAogICAgICAgIC8vIHJpZ2h0CiAgICAgICAgMCwKICAgICAgICA3LAogICAgICAgIDMsCiAgICAgICAgMCwKICAgICAgICA0LAogICAgICAgIDcsCiAgICAgICAgLy8gc3RhcnQKICAgICAgICAwLAogICAgICAgIDUsCiAgICAgICAgNCwKICAgICAgICAwLAogICAgICAgIDEsCiAgICAgICAgNSwKICAgICAgICAvLyBib3R0b20KICAgICAgICA1LAogICAgICAgIDcsCiAgICAgICAgNCwKICAgICAgICA1LAogICAgICAgIDYsCiAgICAgICAgNywKICAgICAgICAvLyBsZWZ0CiAgICAgICAgNSwKICAgICAgICAyLAogICAgICAgIDYsCiAgICAgICAgNSwKICAgICAgICAxLAogICAgICAgIDIsCiAgICAgICAgLy8gZW5kCiAgICAgICAgMywKICAgICAgICA2LAogICAgICAgIDIsCiAgICAgICAgMywKICAgICAgICA3LAogICAgICAgIDYKICAgICAgICAvLyB0b3AKICAgICAgXTsKICAgICAgUkVGRVJFTkNFX0lORElDRVNfTEVOR1RIID0gUkVGRVJFTkNFX0lORElDRVMubGVuZ3RoOwogICAgICBHcm91bmRQb2x5bGluZUdlb21ldHJ5Ll9wcm9qZWN0Tm9ybWFsID0gcHJvamVjdE5vcm1hbDsKICAgICAgR3JvdW5kUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gR3JvdW5kUG9seWxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5KGdyb3VuZFBvbHlsaW5lR2VvbWV0cnksIG9mZnNldCkgewogICAgcmV0dXJuIEFwcHJveGltYXRlVGVycmFpbkhlaWdodHNfZGVmYXVsdC5pbml0aWFsaXplKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgICAgZ3JvdW5kUG9seWxpbmVHZW9tZXRyeSA9IEdyb3VuZFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBncm91bmRQb2x5bGluZUdlb21ldHJ5LAogICAgICAgICAgb2Zmc2V0CiAgICAgICAgKTsKICAgICAgfQogICAgICByZXR1cm4gR3JvdW5kUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KGdyb3VuZFBvbHlsaW5lR2VvbWV0cnkpOwogICAgfSk7CiAgfQogIHZhciBjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQXBwcm94aW1hdGVUZXJyYWluSGVpZ2h0cygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9Hcm91bmRQb2x5bGluZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QbGFuZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gUGxhbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKTsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IHZlcnRleEZvcm1hdDsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlUGxhbmVHZW9tZXRyeSI7CiAgfQogIHZhciBzY3JhdGNoVmVydGV4Rm9ybWF0OCwgc2NyYXRjaE9wdGlvbnMxNSwgbWluLCBtYXgsIFBsYW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9QbGFuZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QbGFuZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIFBsYW5lR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICBQbGFuZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2sodmFsdWUuX3ZlcnRleEZvcm1hdCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDggPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMxNSA9IHsKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ4CiAgICAgIH07CiAgICAgIFBsYW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQ4CiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFBsYW5lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMxNSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgbWluID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgtMC41LCAtMC41LCAwKTsKICAgICAgbWF4ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgwLjUsIDAuNSwgMCk7CiAgICAgIFBsYW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihwbGFuZUdlb21ldHJ5KSB7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gcGxhbmVHZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKTsKICAgICAgICBsZXQgaW5kaWNlczsKICAgICAgICBsZXQgcG9zaXRpb25zOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQucG9zaXRpb24pIHsKICAgICAgICAgIHBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoNCAqIDMpOwogICAgICAgICAgcG9zaXRpb25zWzBdID0gbWluLng7CiAgICAgICAgICBwb3NpdGlvbnNbMV0gPSBtaW4ueTsKICAgICAgICAgIHBvc2l0aW9uc1syXSA9IDA7CiAgICAgICAgICBwb3NpdGlvbnNbM10gPSBtYXgueDsKICAgICAgICAgIHBvc2l0aW9uc1s0XSA9IG1pbi55OwogICAgICAgICAgcG9zaXRpb25zWzVdID0gMDsKICAgICAgICAgIHBvc2l0aW9uc1s2XSA9IG1heC54OwogICAgICAgICAgcG9zaXRpb25zWzddID0gbWF4Lnk7CiAgICAgICAgICBwb3NpdGlvbnNbOF0gPSAwOwogICAgICAgICAgcG9zaXRpb25zWzldID0gbWluLng7CiAgICAgICAgICBwb3NpdGlvbnNbMTBdID0gbWF4Lnk7CiAgICAgICAgICBwb3NpdGlvbnNbMTFdID0gMDsKICAgICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiBwb3NpdGlvbnMKICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwpIHsKICAgICAgICAgICAgY29uc3Qgbm9ybWFscyA9IG5ldyBGbG9hdDMyQXJyYXkoNCAqIDMpOwogICAgICAgICAgICBub3JtYWxzWzBdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1sxXSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbMl0gPSAxOwogICAgICAgICAgICBub3JtYWxzWzNdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s0XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbNV0gPSAxOwogICAgICAgICAgICBub3JtYWxzWzZdID0gMDsKICAgICAgICAgICAgbm9ybWFsc1s3XSA9IDA7CiAgICAgICAgICAgIG5vcm1hbHNbOF0gPSAxOwogICAgICAgICAgICBub3JtYWxzWzldID0gMDsKICAgICAgICAgICAgbm9ybWFsc1sxMF0gPSAwOwogICAgICAgICAgICBub3JtYWxzWzExXSA9IDE7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiBub3JtYWxzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgICBjb25zdCB0ZXhDb29yZHMgPSBuZXcgRmxvYXQzMkFycmF5KDQgKiAyKTsKICAgICAgICAgICAgdGV4Q29vcmRzWzBdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzFdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzJdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzNdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzRdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzVdID0gMTsKICAgICAgICAgICAgdGV4Q29vcmRzWzZdID0gMDsKICAgICAgICAgICAgdGV4Q29vcmRzWzddID0gMTsKICAgICAgICAgICAgYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICAgIHZhbHVlczogdGV4Q29vcmRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgIGNvbnN0IHRhbmdlbnRzID0gbmV3IEZsb2F0MzJBcnJheSg0ICogMyk7CiAgICAgICAgICAgIHRhbmdlbnRzWzBdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbMV0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1syXSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzNdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbNF0gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s1XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzZdID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbN10gPSAwOwogICAgICAgICAgICB0YW5nZW50c1s4XSA9IDA7CiAgICAgICAgICAgIHRhbmdlbnRzWzldID0gMTsKICAgICAgICAgICAgdGFuZ2VudHNbMTBdID0gMDsKICAgICAgICAgICAgdGFuZ2VudHNbMTFdID0gMDsKICAgICAgICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIGNvbnN0IGJpdGFuZ2VudHMgPSBuZXcgRmxvYXQzMkFycmF5KDQgKiAzKTsKICAgICAgICAgICAgYml0YW5nZW50c1swXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMV0gPSAxOwogICAgICAgICAgICBiaXRhbmdlbnRzWzJdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1szXSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbNF0gPSAxOwogICAgICAgICAgICBiaXRhbmdlbnRzWzVdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s2XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbN10gPSAxOwogICAgICAgICAgICBiaXRhbmdlbnRzWzhdID0gMDsKICAgICAgICAgICAgYml0YW5nZW50c1s5XSA9IDA7CiAgICAgICAgICAgIGJpdGFuZ2VudHNbMTBdID0gMTsKICAgICAgICAgICAgYml0YW5nZW50c1sxMV0gPSAwOwogICAgICAgICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoMiAqIDMpOwogICAgICAgICAgaW5kaWNlc1swXSA9IDA7CiAgICAgICAgICBpbmRpY2VzWzFdID0gMTsKICAgICAgICAgIGluZGljZXNbMl0gPSAyOwogICAgICAgICAgaW5kaWNlc1szXSA9IDA7CiAgICAgICAgICBpbmRpY2VzWzRdID0gMjsKICAgICAgICAgIGluZGljZXNbNV0gPSAzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBNYXRoLnNxcnQoMikpCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFBsYW5lR2VvbWV0cnlfZGVmYXVsdCA9IFBsYW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQbGFuZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVBsYW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVBsYW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUGxhbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlUGxhbmVHZW9tZXRyeShwbGFuZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBwbGFuZUdlb21ldHJ5ID0gUGxhbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhwbGFuZUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIFBsYW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShwbGFuZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZVBsYW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVQbGFuZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQbGFuZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfUGxhbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVQbGFuZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVQbGFuZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUGxhbmVPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBQbGFuZU91dGxpbmVHZW9tZXRyeSgpIHsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnkiOwogIH0KICB2YXIgbWluMiwgbWF4MiwgUGxhbmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9QbGFuZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUGxhbmVPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgUGxhbmVPdXRsaW5lR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gMDsKICAgICAgUGxhbmVPdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIFBsYW5lT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgUGxhbmVPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgbWluMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoLTAuNSwgLTAuNSwgMCk7CiAgICAgIG1heDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KDAuNSwgMC41LCAwKTsKICAgICAgUGxhbmVPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheSg0ICogMik7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSg0ICogMyk7CiAgICAgICAgcG9zaXRpb25zWzBdID0gbWluMi54OwogICAgICAgIHBvc2l0aW9uc1sxXSA9IG1pbjIueTsKICAgICAgICBwb3NpdGlvbnNbMl0gPSBtaW4yLno7CiAgICAgICAgcG9zaXRpb25zWzNdID0gbWF4Mi54OwogICAgICAgIHBvc2l0aW9uc1s0XSA9IG1pbjIueTsKICAgICAgICBwb3NpdGlvbnNbNV0gPSBtaW4yLno7CiAgICAgICAgcG9zaXRpb25zWzZdID0gbWF4Mi54OwogICAgICAgIHBvc2l0aW9uc1s3XSA9IG1heDIueTsKICAgICAgICBwb3NpdGlvbnNbOF0gPSBtaW4yLno7CiAgICAgICAgcG9zaXRpb25zWzldID0gbWluMi54OwogICAgICAgIHBvc2l0aW9uc1sxMF0gPSBtYXgyLnk7CiAgICAgICAgcG9zaXRpb25zWzExXSA9IG1pbjIuejsKICAgICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgfSk7CiAgICAgICAgaW5kaWNlc1swXSA9IDA7CiAgICAgICAgaW5kaWNlc1sxXSA9IDE7CiAgICAgICAgaW5kaWNlc1syXSA9IDE7CiAgICAgICAgaW5kaWNlc1szXSA9IDI7CiAgICAgICAgaW5kaWNlc1s0XSA9IDI7CiAgICAgICAgaW5kaWNlc1s1XSA9IDM7CiAgICAgICAgaW5kaWNlc1s2XSA9IDM7CiAgICAgICAgaW5kaWNlc1s3XSA9IDA7CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0KENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBNYXRoLnNxcnQoMikpCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFBsYW5lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBQbGFuZU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnkocGxhbmVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcGxhbmVHZW9tZXRyeSA9IFBsYW5lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHBsYW5lR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gUGxhbmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShwbGFuZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfUGxhbmVPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvU3RlcmVvZ3JhcGhpYy5qcwogIGZ1bmN0aW9uIFN0ZXJlb2dyYXBoaWMocG9zaXRpb24sIHRhbmdlbnRQbGFuZSkgewogICAgdGhpcy5wb3NpdGlvbiA9IHBvc2l0aW9uOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5wb3NpdGlvbikpIHsKICAgICAgdGhpcy5wb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgIH0KICAgIHRoaXMudGFuZ2VudFBsYW5lID0gdGFuZ2VudFBsYW5lOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy50YW5nZW50UGxhbmUpKSB7CiAgICAgIHRoaXMudGFuZ2VudFBsYW5lID0gU3RlcmVvZ3JhcGhpYy5OT1JUSF9QT0xFX1RBTkdFTlRfUExBTkU7CiAgICB9CiAgfQogIHZhciBzY3JhdGNoQ2FydG9ncmFwaGljNSwgc2NyYXRjaENhcnRlc2lhbjEwLCBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5Miwgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZVJheURpcmVjdGlvbiwgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZUNhcnRlc2lhbjMyLCBTdGVyZW9ncmFwaGljX2RlZmF1bHQ7CiAgdmFyIGluaXRfU3RlcmVvZ3JhcGhpYyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvU3RlcmVvZ3JhcGhpYy5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRUYW5nZW50UGxhbmUoKTsKICAgICAgaW5pdF9JbnRlcnNlY3Rpb25UZXN0cygpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9SYXkoKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoU3RlcmVvZ3JhcGhpYy5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSBlbGxpcHNvaWQuCiAgICAgICAgICogQG1lbWJlcm9mIFN0ZXJlb2dyYXBoaWMucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRhbmdlbnRQbGFuZS5lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSB4IGNvb3JkaW5hdGUKICAgICAgICAgKiBAbWVtYmVyb2YgU3RlcmVvZ3JhcGhpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIHg6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uLng7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIHRoZSB5IGNvb3JkaW5hdGUKICAgICAgICAgKiBAbWVtYmVyb2YgU3RlcmVvZ3JhcGhpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIHk6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uLnk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBDb21wdXRlcyB0aGUgY29uZm9ybWFsIGxhdGl0dWRlLCBvciB0aGUgZWxsaXBzb2lkYWwgbGF0aXR1ZGUgcHJvamVjdGVkIG9udG8gYW4gYXJiaXRyYXJ5IHNwaGVyZS4KICAgICAgICAgKiBAbWVtYmVyb2YgU3RlcmVvZ3JhcGhpYy5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGNvbmZvcm1hbExhdGl0dWRlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjb25zdCByID0gQ2FydGVzaWFuMl9kZWZhdWx0Lm1hZ25pdHVkZSh0aGlzLnBvc2l0aW9uKTsKICAgICAgICAgICAgY29uc3QgZCA9IDIgKiB0aGlzLmVsbGlwc29pZC5tYXhpbXVtUmFkaXVzOwogICAgICAgICAgICBjb25zdCBzaWduMiA9IHRoaXMudGFuZ2VudFBsYW5lLnBsYW5lLm5vcm1hbC56OwogICAgICAgICAgICByZXR1cm4gc2lnbjIgKiAoTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPIC0gMiAqIE1hdGguYXRhbjIociwgZCkpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogQ29tcHV0ZXMgdGhlIGxvbmdpdHVkZQogICAgICAgICAqIEBtZW1iZXJvZiBTdGVyZW9ncmFwaGljLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICovCiAgICAgICAgbG9uZ2l0dWRlOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsZXQgbG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPICsgTWF0aC5hdGFuMih0aGlzLnksIHRoaXMueCk7CiAgICAgICAgICAgIGlmIChsb25naXR1ZGUgPiBNYXRoLlBJKSB7CiAgICAgICAgICAgICAgbG9uZ2l0dWRlIC09IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxvbmdpdHVkZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNSA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuMTAgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFN0ZXJlb2dyYXBoaWMucHJvdG90eXBlLmdldExhdGl0dWRlID0gZnVuY3Rpb24oZWxsaXBzb2lkKSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZWxsaXBzb2lkKSkgewogICAgICAgICAgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQ7CiAgICAgICAgfQogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM1LmxhdGl0dWRlID0gdGhpcy5jb25mb3JtYWxMYXRpdHVkZTsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNS5sb25naXR1ZGUgPSB0aGlzLmxvbmdpdHVkZTsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNS5oZWlnaHQgPSAwOwogICAgICAgIGNvbnN0IGNhcnRlc2lhbjExID0gdGhpcy5lbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNSwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xMAogICAgICAgICk7CiAgICAgICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGNhcnRlc2lhbjExLCBzY3JhdGNoQ2FydG9ncmFwaGljNSk7CiAgICAgICAgcmV0dXJuIHNjcmF0Y2hDYXJ0b2dyYXBoaWM1LmxhdGl0dWRlOwogICAgICB9OwogICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5MiA9IG5ldyBSYXlfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lUmF5RGlyZWN0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMzIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFN0ZXJlb2dyYXBoaWMuZnJvbUNhcnRlc2lhbiA9IGZ1bmN0aW9uKGNhcnRlc2lhbjExLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImNhcnRlc2lhbiIsIGNhcnRlc2lhbjExKTsKICAgICAgICBjb25zdCBzaWduMiA9IE1hdGhfZGVmYXVsdC5zaWduTm90WmVybyhjYXJ0ZXNpYW4xMS56KTsKICAgICAgICBsZXQgdGFuZ2VudFBsYW5lID0gU3RlcmVvZ3JhcGhpYy5OT1JUSF9QT0xFX1RBTkdFTlRfUExBTkU7CiAgICAgICAgbGV0IG9yaWdpbiA9IFN0ZXJlb2dyYXBoaWMuU09VVEhfUE9MRTsKICAgICAgICBpZiAoc2lnbjIgPCAwKSB7CiAgICAgICAgICB0YW5nZW50UGxhbmUgPSBTdGVyZW9ncmFwaGljLlNPVVRIX1BPTEVfVEFOR0VOVF9QTEFORTsKICAgICAgICAgIG9yaWdpbiA9IFN0ZXJlb2dyYXBoaWMuTk9SVEhfUE9MRTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmF5ID0gc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZVJheTI7CiAgICAgICAgcmF5Lm9yaWdpbiA9IHRhbmdlbnRQbGFuZS5lbGxpcHNvaWQuc2NhbGVUb0dlb2NlbnRyaWNTdXJmYWNlKAogICAgICAgICAgY2FydGVzaWFuMTEsCiAgICAgICAgICByYXkub3JpZ2luCiAgICAgICAgKTsKICAgICAgICByYXkuZGlyZWN0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgcmF5Lm9yaWdpbiwKICAgICAgICAgIG9yaWdpbiwKICAgICAgICAgIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXlEaXJlY3Rpb24KICAgICAgICApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUocmF5LmRpcmVjdGlvbiwgcmF5LmRpcmVjdGlvbik7CiAgICAgICAgY29uc3QgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0c19kZWZhdWx0LnJheVBsYW5lKAogICAgICAgICAgcmF5LAogICAgICAgICAgdGFuZ2VudFBsYW5lLnBsYW5lLAogICAgICAgICAgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZUNhcnRlc2lhbjMyCiAgICAgICAgKTsKICAgICAgICBjb25zdCB2MyA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChpbnRlcnNlY3Rpb25Qb2ludCwgb3JpZ2luLCBpbnRlcnNlY3Rpb25Qb2ludCk7CiAgICAgICAgY29uc3QgeCA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QodGFuZ2VudFBsYW5lLnhBeGlzLCB2Myk7CiAgICAgICAgY29uc3QgeSA9IHNpZ24yICogQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0YW5nZW50UGxhbmUueUF4aXMsIHYzKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFN0ZXJlb2dyYXBoaWMobmV3IENhcnRlc2lhbjJfZGVmYXVsdCh4LCB5KSwgdGFuZ2VudFBsYW5lKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCh4LCB5KTsKICAgICAgICByZXN1bHQudGFuZ2VudFBsYW5lID0gdGFuZ2VudFBsYW5lOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFN0ZXJlb2dyYXBoaWMuZnJvbUNhcnRlc2lhbkFycmF5ID0gZnVuY3Rpb24oY2FydGVzaWFucywgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJjYXJ0ZXNpYW5zIiwgY2FydGVzaWFucyk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gY2FydGVzaWFucy5sZW5ndGg7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHJlc3VsdFtpXSA9IFN0ZXJlb2dyYXBoaWMuZnJvbUNhcnRlc2lhbihjYXJ0ZXNpYW5zW2ldLCByZXN1bHRbaV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBTdGVyZW9ncmFwaGljLmNsb25lID0gZnVuY3Rpb24oc3RlcmVvZ3JhcGhpYywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc3RlcmVvZ3JhcGhpYykpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgU3RlcmVvZ3JhcGhpYygKICAgICAgICAgICAgc3RlcmVvZ3JhcGhpYy5wb3NpdGlvbiwKICAgICAgICAgICAgc3RlcmVvZ3JhcGhpYy50YW5nZW50UGxhbmUKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wb3NpdGlvbiA9IHN0ZXJlb2dyYXBoaWMucG9zaXRpb247CiAgICAgICAgcmVzdWx0LnRhbmdlbnRQbGFuZSA9IHN0ZXJlb2dyYXBoaWMudGFuZ2VudFBsYW5lOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFN0ZXJlb2dyYXBoaWMuSEFMRl9VTklUX1NQSEVSRSA9IE9iamVjdC5mcmVlemUobmV3IEVsbGlwc29pZF9kZWZhdWx0KDAuNSwgMC41LCAwLjUpKTsKICAgICAgU3RlcmVvZ3JhcGhpYy5OT1JUSF9QT0xFID0gT2JqZWN0LmZyZWV6ZShuZXcgQ2FydGVzaWFuM19kZWZhdWx0KDAsIDAsIDAuNSkpOwogICAgICBTdGVyZW9ncmFwaGljLlNPVVRIX1BPTEUgPSBPYmplY3QuZnJlZXplKG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoMCwgMCwgLTAuNSkpOwogICAgICBTdGVyZW9ncmFwaGljLk5PUlRIX1BPTEVfVEFOR0VOVF9QTEFORSA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0KAogICAgICAgICAgU3RlcmVvZ3JhcGhpYy5OT1JUSF9QT0xFLAogICAgICAgICAgU3RlcmVvZ3JhcGhpYy5IQUxGX1VOSVRfU1BIRVJFCiAgICAgICAgKQogICAgICApOwogICAgICBTdGVyZW9ncmFwaGljLlNPVVRIX1BPTEVfVEFOR0VOVF9QTEFORSA9IE9iamVjdC5mcmVlemUoCiAgICAgICAgbmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0KAogICAgICAgICAgU3RlcmVvZ3JhcGhpYy5TT1VUSF9QT0xFLAogICAgICAgICAgU3RlcmVvZ3JhcGhpYy5IQUxGX1VOSVRfU1BIRVJFCiAgICAgICAgKQogICAgICApOwogICAgICBTdGVyZW9ncmFwaGljX2RlZmF1bHQgPSBTdGVyZW9ncmFwaGljOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvbkdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gYWRqdXN0UG9zSGVpZ2h0c0Zvck5vcm1hbChwb3NpdGlvbiwgcDEsIHAyLCBlbGxpcHNvaWQpIHsKICAgIGNvbnN0IGNhcnRvMTIgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocG9zaXRpb24sIHNjcmF0Y2hDYXJ0bzEpOwogICAgY29uc3QgaGVpZ2h0ID0gY2FydG8xMi5oZWlnaHQ7CiAgICBjb25zdCBwMUNhcnRvID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKHAxLCBzY3JhdGNoQ2FydG8yKTsKICAgIHAxQ2FydG8uaGVpZ2h0ID0gaGVpZ2h0OwogICAgZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKHAxQ2FydG8sIHAxKTsKICAgIGNvbnN0IHAyQ2FydG8gPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMocDIsIHNjcmF0Y2hDYXJ0bzIpOwogICAgcDJDYXJ0by5oZWlnaHQgPSBoZWlnaHQgLSAxMDA7CiAgICBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4ocDJDYXJ0bywgcDIpOwogIH0KICBmdW5jdGlvbiBjb21wdXRlQXR0cmlidXRlcyhvcHRpb25zKSB7CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBvcHRpb25zLnZlcnRleEZvcm1hdDsKICAgIGNvbnN0IGdlb21ldHJ5ID0gb3B0aW9ucy5nZW9tZXRyeTsKICAgIGNvbnN0IHNoYWRvd1ZvbHVtZSA9IG9wdGlvbnMuc2hhZG93Vm9sdW1lOwogICAgY29uc3QgZmxhdFBvc2l0aW9ucyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgY29uc3QgZmxhdFRleGNvb3JkcyA9IGRlZmluZWRfZGVmYXVsdChnZW9tZXRyeS5hdHRyaWJ1dGVzLnN0KSA/IGdlb21ldHJ5LmF0dHJpYnV0ZXMuc3QudmFsdWVzIDogdm9pZCAwOwogICAgbGV0IGxlbmd0aCA9IGZsYXRQb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3Qgd2FsbCA9IG9wdGlvbnMud2FsbDsKICAgIGNvbnN0IHRvcCA9IG9wdGlvbnMudG9wIHx8IHdhbGw7CiAgICBjb25zdCBib3R0b20gPSBvcHRpb25zLmJvdHRvbSB8fCB3YWxsOwogICAgaWYgKHZlcnRleEZvcm1hdC5zdCB8fCB2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgfHwgc2hhZG93Vm9sdW1lKSB7CiAgICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gb3B0aW9ucy5ib3VuZGluZ1JlY3RhbmdsZTsKICAgICAgY29uc3Qgcm90YXRpb25BeGlzID0gb3B0aW9ucy5yb3RhdGlvbkF4aXM7CiAgICAgIGNvbnN0IHByb2plY3RUbzJkID0gb3B0aW9ucy5wcm9qZWN0VG8yZDsKICAgICAgY29uc3QgZWxsaXBzb2lkID0gb3B0aW9ucy5lbGxpcHNvaWQ7CiAgICAgIGNvbnN0IHN0Um90YXRpb24gPSBvcHRpb25zLnN0Um90YXRpb247CiAgICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0ID0gb3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodDsKICAgICAgY29uc3Qgb3JpZ2luID0gYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzT3JpZ2luOwogICAgICBvcmlnaW4ueCA9IGJvdW5kaW5nUmVjdGFuZ2xlLng7CiAgICAgIG9yaWdpbi55ID0gYm91bmRpbmdSZWN0YW5nbGUueTsKICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheSgyICogKGxlbmd0aCAvIDMpKSA6IHZvaWQgMDsKICAgICAgbGV0IG5vcm1hbHM7CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgaWYgKHBlclBvc2l0aW9uSGVpZ2h0ICYmIHRvcCAmJiAhd2FsbCkgewogICAgICAgICAgbm9ybWFscyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbm9ybWFscyA9IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoKSA6IHZvaWQgMDsKICAgICAgY29uc3QgYml0YW5nZW50cyA9IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICAgIGNvbnN0IGV4dHJ1ZGVOb3JtYWxzID0gc2hhZG93Vm9sdW1lID8gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgICBsZXQgdGV4dHVyZUNvb3JkSW5kZXggPSAwOwogICAgICBsZXQgYXR0ckluZGV4ID0gMDsKICAgICAgbGV0IG5vcm1hbDIgPSBzY3JhdGNoTm9ybWFsNjsKICAgICAgbGV0IHRhbmdlbnQgPSBzY3JhdGNoVGFuZ2VudDQ7CiAgICAgIGxldCBiaXRhbmdlbnQgPSBzY3JhdGNoQml0YW5nZW50NDsKICAgICAgbGV0IHJlY29tcHV0ZU5vcm1hbCA9IHRydWU7CiAgICAgIGxldCB0ZXh0dXJlTWF0cml4ID0gYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzTWF0cml4MzsKICAgICAgbGV0IHRhbmdlbnRSb3RhdGlvbk1hdHJpeCA9IHRhbmdlbnRNYXRyaXhTY3JhdGNoMjsKICAgICAgaWYgKHN0Um90YXRpb24gIT09IDApIHsKICAgICAgICBsZXQgcm90YXRpb24gPSBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZSgKICAgICAgICAgIHJvdGF0aW9uQXhpcywKICAgICAgICAgIHN0Um90YXRpb24sCiAgICAgICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICB0ZXh0dXJlTWF0cml4ID0gTWF0cml4M19kZWZhdWx0LmZyb21RdWF0ZXJuaW9uKHJvdGF0aW9uLCB0ZXh0dXJlTWF0cml4KTsKICAgICAgICByb3RhdGlvbiA9IFF1YXRlcm5pb25fZGVmYXVsdC5mcm9tQXhpc0FuZ2xlKAogICAgICAgICAgcm90YXRpb25BeGlzLAogICAgICAgICAgLXN0Um90YXRpb24sCiAgICAgICAgICBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNRdWF0ZXJuaW9uCiAgICAgICAgKTsKICAgICAgICB0YW5nZW50Um90YXRpb25NYXRyaXggPSBNYXRyaXgzX2RlZmF1bHQuZnJvbVF1YXRlcm5pb24oCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIHRhbmdlbnRSb3RhdGlvbk1hdHJpeAogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGV4dHVyZU1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5jbG9uZShNYXRyaXgzX2RlZmF1bHQuSURFTlRJVFksIHRleHR1cmVNYXRyaXgpOwogICAgICAgIHRhbmdlbnRSb3RhdGlvbk1hdHJpeCA9IE1hdHJpeDNfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5JREVOVElUWSwKICAgICAgICAgIHRhbmdlbnRSb3RhdGlvbk1hdHJpeAogICAgICAgICk7CiAgICAgIH0KICAgICAgbGV0IGJvdHRvbU9mZnNldCA9IDA7CiAgICAgIGxldCBib3R0b21PZmZzZXQyID0gMDsKICAgICAgaWYgKHRvcCAmJiBib3R0b20pIHsKICAgICAgICBib3R0b21PZmZzZXQgPSBsZW5ndGggLyAyOwogICAgICAgIGJvdHRvbU9mZnNldDIgPSBsZW5ndGggLyAzOwogICAgICAgIGxlbmd0aCAvPSAyOwogICAgICB9CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICBjb25zdCBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICBmbGF0UG9zaXRpb25zLAogICAgICAgICAgaSwKICAgICAgICAgIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc0NhcnRlc2lhbjMKICAgICAgICApOwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGZsYXRUZXhjb29yZHMpKSB7CiAgICAgICAgICAgIGxldCBwID0gTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IoCiAgICAgICAgICAgICAgdGV4dHVyZU1hdHJpeCwKICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICBzY3JhdGNoUG9zaXRpb24zCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHAgPSBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwLCBwKTsKICAgICAgICAgICAgY29uc3Qgc3QgPSBwcm9qZWN0VG8yZChbcF0sIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc0NhcnRlc2lhbjIpWzBdOwogICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuc3VidHJhY3Qoc3QsIG9yaWdpbiwgc3QpOwogICAgICAgICAgICBjb25zdCBzdHggPSBNYXRoX2RlZmF1bHQuY2xhbXAoc3QueCAvIGJvdW5kaW5nUmVjdGFuZ2xlLndpZHRoLCAwLCAxKTsKICAgICAgICAgICAgY29uc3Qgc3R5ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHN0LnkgLyBib3VuZGluZ1JlY3RhbmdsZS5oZWlnaHQsIDAsIDEpOwogICAgICAgICAgICBpZiAoYm90dG9tKSB7CiAgICAgICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4ICsgYm90dG9tT2Zmc2V0Ml0gPSBzdHg7CiAgICAgICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3RleHR1cmVDb29yZEluZGV4ICsgMSArIGJvdHRvbU9mZnNldDJdID0gc3R5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0b3ApIHsKICAgICAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbdGV4dHVyZUNvb3JkSW5kZXhdID0gc3R4OwogICAgICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1t0ZXh0dXJlQ29vcmRJbmRleCArIDFdID0gc3R5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRleHR1cmVDb29yZEluZGV4ICs9IDI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsIHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQgfHwgc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgICBjb25zdCBhdHRySW5kZXgxID0gYXR0ckluZGV4ICsgMTsKICAgICAgICAgIGNvbnN0IGF0dHJJbmRleDIgPSBhdHRySW5kZXggKyAyOwogICAgICAgICAgaWYgKHdhbGwpIHsKICAgICAgICAgICAgaWYgKGkgKyAzIDwgbGVuZ3RoKSB7CiAgICAgICAgICAgICAgY29uc3QgcDEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KGZsYXRQb3NpdGlvbnMsIGkgKyAzLCBwMVNjcmF0Y2gzKTsKICAgICAgICAgICAgICBpZiAocmVjb21wdXRlTm9ybWFsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgICAgICAgIGZsYXRQb3NpdGlvbnMsCiAgICAgICAgICAgICAgICAgIGkgKyBsZW5ndGgsCiAgICAgICAgICAgICAgICAgIHAyU2NyYXRjaDMKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpZiAocGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgYWRqdXN0UG9zSGVpZ2h0c0Zvck5vcm1hbChwb3NpdGlvbiwgcDEsIHAyLCBlbGxpcHNvaWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAxLCBwb3NpdGlvbiwgcDEpOwogICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAyLCBwb3NpdGlvbiwgcDIpOwogICAgICAgICAgICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhwMiwgcDEsIG5vcm1hbDIpLAogICAgICAgICAgICAgICAgICBub3JtYWwyCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgcmVjb21wdXRlTm9ybWFsID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwMSwgcG9zaXRpb24sIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApKSB7CiAgICAgICAgICAgICAgICByZWNvbXB1dGVOb3JtYWwgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICAgIGJpdGFuZ2VudCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIGJpdGFuZ2VudCk7CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGJpdGFuZ2VudCwgbm9ybWFsMiwgdGFuZ2VudCksCiAgICAgICAgICAgICAgICAgIHRhbmdlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgbm9ybWFsMik7CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgICAgaWYgKHBlclBvc2l0aW9uSGVpZ2h0KSB7CiAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zTm9ybWFsID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICAgICAgbm9ybWFscywKICAgICAgICAgICAgICAgICAgYXR0ckluZGV4LAogICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zTm9ybWFsCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc1RhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NOb3JtYWwsCiAgICAgICAgICAgICAgICAgIHNjcmF0Y2hQZXJQb3NUYW5nZW50CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc1RhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcigKICAgICAgICAgICAgICAgICAgICB0YW5nZW50Um90YXRpb25NYXRyaXgsCiAgICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc1RhbmdlbnQsCiAgICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc1RhbmdlbnQKICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc1RhbmdlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zQml0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zTm9ybWFsLAogICAgICAgICAgICAgICAgICAgICAgc2NyYXRjaFBlclBvc1RhbmdlbnQsCiAgICAgICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zQml0YW5nZW50CiAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICBzY3JhdGNoUGVyUG9zQml0YW5nZW50CiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRhbmdlbnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoQ2FydGVzaWFuM19kZWZhdWx0LlVOSVRfWiwgbm9ybWFsMiwgdGFuZ2VudCk7CiAgICAgICAgICAgICAgdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0YW5nZW50Um90YXRpb25NYXRyaXgsIHRhbmdlbnQsIHRhbmdlbnQpLAogICAgICAgICAgICAgICAgdGFuZ2VudAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCB0YW5nZW50LCBiaXRhbmdlbnQpLAogICAgICAgICAgICAgICAgICBiaXRhbmdlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgICBpZiAob3B0aW9ucy53YWxsKSB7CiAgICAgICAgICAgICAgbm9ybWFsc1thdHRySW5kZXggKyBib3R0b21PZmZzZXRdID0gbm9ybWFsMi54OwogICAgICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4MSArIGJvdHRvbU9mZnNldF0gPSBub3JtYWwyLnk7CiAgICAgICAgICAgICAgbm9ybWFsc1thdHRySW5kZXgyICsgYm90dG9tT2Zmc2V0XSA9IG5vcm1hbDIuejsKICAgICAgICAgICAgfSBlbHNlIGlmIChib3R0b20pIHsKICAgICAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleCArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi54OwogICAgICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4MSArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi55OwogICAgICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4MiArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi56OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0b3AgJiYgIXBlclBvc2l0aW9uSGVpZ2h0IHx8IHdhbGwpIHsKICAgICAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleF0gPSBub3JtYWwyLng7CiAgICAgICAgICAgICAgbm9ybWFsc1thdHRySW5kZXgxXSA9IG5vcm1hbDIueTsKICAgICAgICAgICAgICBub3JtYWxzW2F0dHJJbmRleDJdID0gbm9ybWFsMi56OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgICAgIGlmICh3YWxsKSB7CiAgICAgICAgICAgICAgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24sIG5vcm1hbDIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2F0dHJJbmRleCArIGJvdHRvbU9mZnNldF0gPSAtbm9ybWFsMi54OwogICAgICAgICAgICBleHRydWRlTm9ybWFsc1thdHRySW5kZXgxICsgYm90dG9tT2Zmc2V0XSA9IC1ub3JtYWwyLnk7CiAgICAgICAgICAgIGV4dHJ1ZGVOb3JtYWxzW2F0dHJJbmRleDIgKyBib3R0b21PZmZzZXRdID0gLW5vcm1hbDIuejsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgICBpZiAob3B0aW9ucy53YWxsKSB7CiAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4ICsgYm90dG9tT2Zmc2V0XSA9IHRhbmdlbnQueDsKICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgxICsgYm90dG9tT2Zmc2V0XSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgyICsgYm90dG9tT2Zmc2V0XSA9IHRhbmdlbnQuejsKICAgICAgICAgICAgfSBlbHNlIGlmIChib3R0b20pIHsKICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXggKyBib3R0b21PZmZzZXRdID0gLXRhbmdlbnQueDsKICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgxICsgYm90dG9tT2Zmc2V0XSA9IC10YW5nZW50Lnk7CiAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4MiArIGJvdHRvbU9mZnNldF0gPSAtdGFuZ2VudC56OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0b3ApIHsKICAgICAgICAgICAgICBpZiAocGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleF0gPSBzY3JhdGNoUGVyUG9zVGFuZ2VudC54OwogICAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4MV0gPSBzY3JhdGNoUGVyUG9zVGFuZ2VudC55OwogICAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4Ml0gPSBzY3JhdGNoUGVyUG9zVGFuZ2VudC56OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXhdID0gdGFuZ2VudC54OwogICAgICAgICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4MV0gPSB0YW5nZW50Lnk7CiAgICAgICAgICAgICAgICB0YW5nZW50c1thdHRySW5kZXgyXSA9IHRhbmdlbnQuejsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIGlmIChib3R0b20pIHsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleCArIGJvdHRvbU9mZnNldF0gPSBiaXRhbmdlbnQueDsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleDEgKyBib3R0b21PZmZzZXRdID0gYml0YW5nZW50Lnk7CiAgICAgICAgICAgICAgYml0YW5nZW50c1thdHRySW5kZXgyICsgYm90dG9tT2Zmc2V0XSA9IGJpdGFuZ2VudC56OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0b3ApIHsKICAgICAgICAgICAgICBpZiAocGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4XSA9IHNjcmF0Y2hQZXJQb3NCaXRhbmdlbnQueDsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4MV0gPSBzY3JhdGNoUGVyUG9zQml0YW5nZW50Lnk7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleDJdID0gc2NyYXRjaFBlclBvc0JpdGFuZ2VudC56OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleF0gPSBiaXRhbmdlbnQueDsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4MV0gPSBiaXRhbmdlbnQueTsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4Ml0gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGF0dHJJbmRleCArPSAzOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0LnN0ICYmICFkZWZpbmVkX2RlZmF1bHQoZmxhdFRleGNvb3JkcykpIHsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnN0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgdmFsdWVzOiB0ZXh0dXJlQ29vcmRpbmF0ZXMKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMubm9ybWFsID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBub3JtYWxzCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5iaXRhbmdlbnQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IGJpdGFuZ2VudHMKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5leHRydWRlRGlyZWN0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBleHRydWRlTm9ybWFscwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICBpZiAob3B0aW9ucy5leHRydWRlICYmIGRlZmluZWRfZGVmYXVsdChvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgY29uc3Qgc2l6ZSA9IGZsYXRQb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgICAgbGV0IG9mZnNldEF0dHJpYnV0ZSA9IG5ldyBVaW50OEFycmF5KHNpemUpOwogICAgICBpZiAob3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgICAgaWYgKHRvcCAmJiBib3R0b20gfHwgd2FsbCkgewogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwoMSwgMCwgc2l6ZSAvIDIpOwogICAgICAgIH0gZWxzZSBpZiAodG9wKSB7CiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbCgxKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICB9CiAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgIHZhbHVlczogb2Zmc2V0QXR0cmlidXRlCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNFeHRydWRlZChlbGxpcHNvaWQsIHBvbHlnb24yLCB0ZXh0dXJlQ29vcmRpbmF0ZXMsIGdyYW51bGFyaXR5LCBoaWVyYXJjaHksIHBlclBvc2l0aW9uSGVpZ2h0LCBjbG9zZVRvcCwgY2xvc2VCb3R0b20sIHZlcnRleEZvcm1hdCwgYXJjVHlwZSkgewogICAgY29uc3QgZ2VvcyA9IHsKICAgICAgd2FsbHM6IFtdCiAgICB9OwogICAgbGV0IGk7CiAgICBpZiAoY2xvc2VUb3AgfHwgY2xvc2VCb3R0b20pIHsKICAgICAgY29uc3QgdG9wR2VvID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9ucygKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgcG9seWdvbjIsCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0LAogICAgICAgIHZlcnRleEZvcm1hdCwKICAgICAgICBhcmNUeXBlCiAgICAgICk7CiAgICAgIGNvbnN0IGVkZ2VQb2ludHMgPSB0b3BHZW8uYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXM7CiAgICAgIGNvbnN0IGluZGljZXMgPSB0b3BHZW8uaW5kaWNlczsKICAgICAgbGV0IG51bVBvc2l0aW9uczsKICAgICAgbGV0IG5ld0luZGljZXM7CiAgICAgIGlmIChjbG9zZVRvcCAmJiBjbG9zZUJvdHRvbSkgewogICAgICAgIGNvbnN0IHRvcEJvdHRvbVBvc2l0aW9ucyA9IGVkZ2VQb2ludHMuY29uY2F0KGVkZ2VQb2ludHMpOwogICAgICAgIG51bVBvc2l0aW9ucyA9IHRvcEJvdHRvbVBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgICAgIG5ld0luZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgICAgIG51bVBvc2l0aW9ucywKICAgICAgICAgIGluZGljZXMubGVuZ3RoICogMgogICAgICAgICk7CiAgICAgICAgbmV3SW5kaWNlcy5zZXQoaW5kaWNlcyk7CiAgICAgICAgY29uc3QgaWxlbmd0aCA9IGluZGljZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IG51bVBvc2l0aW9ucyAvIDI7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGlsZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgY29uc3QgaTAgPSBuZXdJbmRpY2VzW2ldICsgbGVuZ3RoOwogICAgICAgICAgY29uc3QgaTEgPSBuZXdJbmRpY2VzW2kgKyAxXSArIGxlbmd0aDsKICAgICAgICAgIGNvbnN0IGkyID0gbmV3SW5kaWNlc1tpICsgMl0gKyBsZW5ndGg7CiAgICAgICAgICBuZXdJbmRpY2VzW2kgKyBpbGVuZ3RoXSA9IGkyOwogICAgICAgICAgbmV3SW5kaWNlc1tpICsgMSArIGlsZW5ndGhdID0gaTE7CiAgICAgICAgICBuZXdJbmRpY2VzW2kgKyAyICsgaWxlbmd0aF0gPSBpMDsKICAgICAgICB9CiAgICAgICAgdG9wR2VvLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gdG9wQm90dG9tUG9zaXRpb25zOwogICAgICAgIGlmIChwZXJQb3NpdGlvbkhlaWdodCAmJiB2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBjb25zdCBub3JtYWxzID0gdG9wR2VvLmF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlczsKICAgICAgICAgIHRvcEdlby5hdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXMgPSBuZXcgRmxvYXQzMkFycmF5KAogICAgICAgICAgICB0b3BCb3R0b21Qb3NpdGlvbnMubGVuZ3RoCiAgICAgICAgICApOwogICAgICAgICAgdG9wR2VvLmF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlcy5zZXQobm9ybWFscyk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QgJiYgZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcykpIHsKICAgICAgICAgIGNvbnN0IHRleGNvb3JkcyA9IHRvcEdlby5hdHRyaWJ1dGVzLnN0LnZhbHVlczsKICAgICAgICAgIHRvcEdlby5hdHRyaWJ1dGVzLnN0LnZhbHVlcyA9IG5ldyBGbG9hdDMyQXJyYXkobnVtUG9zaXRpb25zICogMik7CiAgICAgICAgICB0b3BHZW8uYXR0cmlidXRlcy5zdC52YWx1ZXMgPSB0ZXhjb29yZHMuY29uY2F0KHRleGNvb3Jkcyk7CiAgICAgICAgfQogICAgICAgIHRvcEdlby5pbmRpY2VzID0gbmV3SW5kaWNlczsKICAgICAgfSBlbHNlIGlmIChjbG9zZUJvdHRvbSkgewogICAgICAgIG51bVBvc2l0aW9ucyA9IGVkZ2VQb2ludHMubGVuZ3RoIC8gMzsKICAgICAgICBuZXdJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtUG9zaXRpb25zLCBpbmRpY2VzLmxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGluZGljZXMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIG5ld0luZGljZXNbaV0gPSBpbmRpY2VzW2kgKyAyXTsKICAgICAgICAgIG5ld0luZGljZXNbaSArIDFdID0gaW5kaWNlc1tpICsgMV07CiAgICAgICAgICBuZXdJbmRpY2VzW2kgKyAyXSA9IGluZGljZXNbaV07CiAgICAgICAgfQogICAgICAgIHRvcEdlby5pbmRpY2VzID0gbmV3SW5kaWNlczsKICAgICAgfQogICAgICBnZW9zLnRvcEFuZEJvdHRvbSA9IG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgIGdlb21ldHJ5OiB0b3BHZW8KICAgICAgfSk7CiAgICB9CiAgICBsZXQgb3V0ZXJSaW5nID0gaGllcmFyY2h5Lm91dGVyUmluZzsKICAgIGNvbnN0IHRhbmdlbnRQbGFuZSA9IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0LmZyb21Qb2ludHMob3V0ZXJSaW5nLCBlbGxpcHNvaWQpOwogICAgbGV0IHBvc2l0aW9uczJEID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludHNPbnRvUGxhbmUoCiAgICAgIG91dGVyUmluZywKICAgICAgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zRXh0cnVkZWRQb3NpdGlvbnMKICAgICk7CiAgICBsZXQgd2luZGluZ09yZGVyID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVdpbmRpbmdPcmRlcjJEKHBvc2l0aW9uczJEKTsKICAgIGlmICh3aW5kaW5nT3JkZXIgPT09IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNMT0NLV0lTRSkgewogICAgICBvdXRlclJpbmcgPSBvdXRlclJpbmcuc2xpY2UoKS5yZXZlcnNlKCk7CiAgICB9CiAgICBsZXQgd2FsbEdlbyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlV2FsbEdlb21ldHJ5KAogICAgICBvdXRlclJpbmcsCiAgICAgIHRleHR1cmVDb29yZGluYXRlcywKICAgICAgZWxsaXBzb2lkLAogICAgICBncmFudWxhcml0eSwKICAgICAgcGVyUG9zaXRpb25IZWlnaHQsCiAgICAgIGFyY1R5cGUKICAgICk7CiAgICBnZW9zLndhbGxzLnB1c2goCiAgICAgIG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgIGdlb21ldHJ5OiB3YWxsR2VvCiAgICAgIH0pCiAgICApOwogICAgY29uc3QgaG9sZXMgPSBoaWVyYXJjaHkuaG9sZXM7CiAgICBmb3IgKGkgPSAwOyBpIDwgaG9sZXMubGVuZ3RoOyBpKyspIHsKICAgICAgbGV0IGhvbGUgPSBob2xlc1tpXTsKICAgICAgcG9zaXRpb25zMkQgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50c09udG9QbGFuZSgKICAgICAgICBob2xlLAogICAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc0V4dHJ1ZGVkUG9zaXRpb25zCiAgICAgICk7CiAgICAgIHdpbmRpbmdPcmRlciA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVXaW5kaW5nT3JkZXIyRChwb3NpdGlvbnMyRCk7CiAgICAgIGlmICh3aW5kaW5nT3JkZXIgPT09IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNPVU5URVJfQ0xPQ0tXSVNFKSB7CiAgICAgICAgaG9sZSA9IGhvbGUuc2xpY2UoKS5yZXZlcnNlKCk7CiAgICAgIH0KICAgICAgd2FsbEdlbyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlV2FsbEdlb21ldHJ5KAogICAgICAgIGhvbGUsCiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBncmFudWxhcml0eSwKICAgICAgICBwZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICBhcmNUeXBlCiAgICAgICk7CiAgICAgIGdlb3Mud2FsbHMucHVzaCgKICAgICAgICBuZXcgR2VvbWV0cnlJbnN0YW5jZV9kZWZhdWx0KHsKICAgICAgICAgIGdlb21ldHJ5OiB3YWxsR2VvCiAgICAgICAgfSkKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBnZW9zOwogIH0KICBmdW5jdGlvbiBQb2x5Z29uR2VvbWV0cnkob3B0aW9ucykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zIiwgb3B0aW9ucyk7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoIm9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSIsIG9wdGlvbnMucG9seWdvbkhpZXJhcmNoeSk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQpICYmIG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQgJiYgZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0KSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAiQ2Fubm90IHVzZSBib3RoIG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQgYW5kIG9wdGlvbnMuaGVpZ2h0IgogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLmFyY1R5cGUpICYmIG9wdGlvbnMuYXJjVHlwZSAhPT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDICYmIG9wdGlvbnMuYXJjVHlwZSAhPT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJJbnZhbGlkIGFyY1R5cGUuIFZhbGlkIG9wdGlvbnMgYXJlIEFyY1R5cGUuR0VPREVTSUMgYW5kIEFyY1R5cGUuUkhVTUIuIgogICAgICApOwogICAgfQogICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IG9wdGlvbnMucG9seWdvbkhpZXJhcmNoeTsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMudmVydGV4Rm9ybWF0LCBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5ERUZBVUxUKTsKICAgIGNvbnN0IGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgY29uc3Qgc3RSb3RhdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc3RSb3RhdGlvbiwgMCk7CiAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSBvcHRpb25zLnRleHR1cmVDb29yZGluYXRlczsKICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5wZXJQb3NpdGlvbkhlaWdodCwgZmFsc2UpOwogICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID0gcGVyUG9zaXRpb25IZWlnaHQgJiYgZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQpOwogICAgbGV0IGhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0LCAwKTsKICAgIGxldCBleHRydWRlZEhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICBpZiAoIXBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSkgewogICAgICBjb25zdCBoID0gTWF0aC5tYXgoaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICAgIGV4dHJ1ZGVkSGVpZ2h0ID0gTWF0aC5taW4oaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICAgIGhlaWdodCA9IGg7CiAgICB9CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSh2ZXJ0ZXhGb3JtYXQpOwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkKTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICB0aGlzLl9zdFJvdGF0aW9uID0gc3RSb3RhdGlvbjsKICAgIHRoaXMuX2hlaWdodCA9IGhlaWdodDsKICAgIHRoaXMuX2V4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICB0aGlzLl9jbG9zZVRvcCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY2xvc2VUb3AsIHRydWUpOwogICAgdGhpcy5fY2xvc2VCb3R0b20gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNsb3NlQm90dG9tLCB0cnVlKTsKICAgIHRoaXMuX3BvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uSGllcmFyY2h5OwogICAgdGhpcy5fcGVyUG9zaXRpb25IZWlnaHQgPSBwZXJQb3NpdGlvbkhlaWdodDsKICAgIHRoaXMuX3BlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSA9IHBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZTsKICAgIHRoaXMuX3NoYWRvd1ZvbHVtZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuc2hhZG93Vm9sdW1lLCBmYWxzZSk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVBvbHlnb25HZW9tZXRyeSI7CiAgICB0aGlzLl9vZmZzZXRBdHRyaWJ1dGUgPSBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZTsKICAgIHRoaXMuX2FyY1R5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmFyY1R5cGUsIEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQyk7CiAgICB0aGlzLl9yZWN0YW5nbGUgPSB2b2lkIDA7CiAgICB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzID0gdm9pZCAwOwogICAgdGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVzID0gdGV4dHVyZUNvb3JkaW5hdGVzOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZUhpZXJhcmNoeVBhY2tlZExlbmd0aCgKICAgICAgcG9seWdvbkhpZXJhcmNoeSwKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICApICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgKHRleHR1cmVDb29yZGluYXRlcyA/IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlSGllcmFyY2h5UGFja2VkTGVuZ3RoKAogICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXMsCiAgICAgIENhcnRlc2lhbjJfZGVmYXVsdAogICAgKSA6IDEpICsgMTI7CiAgfQogIGZ1bmN0aW9uIGV4cGFuZFJlY3RhbmdsZShwb2xhciwgbGFzdFBvbGFyLCBlbGxpcHNvaWQsIGFyY1R5cGUsIHBvbHlnb24yLCByZXN1bHQpIHsKICAgIGNvbnN0IGxvbmdpdHVkZSA9IHBvbGFyLmxvbmdpdHVkZTsKICAgIGNvbnN0IGxvbkFkanVzdGVkID0gbG9uZ2l0dWRlID49IDAgPyBsb25naXR1ZGUgOiBsb25naXR1ZGUgKyBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgcG9seWdvbjIud2VzdE92ZXJJZGwgPSBNYXRoLm1pbihwb2x5Z29uMi53ZXN0T3ZlcklkbCwgbG9uQWRqdXN0ZWQpOwogICAgcG9seWdvbjIuZWFzdE92ZXJJZGwgPSBNYXRoLm1heChwb2x5Z29uMi5lYXN0T3ZlcklkbCwgbG9uQWRqdXN0ZWQpOwogICAgcmVzdWx0Lndlc3QgPSBNYXRoLm1pbihyZXN1bHQud2VzdCwgbG9uZ2l0dWRlKTsKICAgIHJlc3VsdC5lYXN0ID0gTWF0aC5tYXgocmVzdWx0LmVhc3QsIGxvbmdpdHVkZSk7CiAgICBjb25zdCBsYXRpdHVkZSA9IHBvbGFyLmdldExhdGl0dWRlKGVsbGlwc29pZCk7CiAgICBsZXQgc2VnbWVudExhdGl0dWRlID0gbGF0aXR1ZGU7CiAgICByZXN1bHQuc291dGggPSBNYXRoLm1pbihyZXN1bHQuc291dGgsIGxhdGl0dWRlKTsKICAgIHJlc3VsdC5ub3J0aCA9IE1hdGgubWF4KHJlc3VsdC5ub3J0aCwgbGF0aXR1ZGUpOwogICAgaWYgKGFyY1R5cGUgIT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICBjb25zdCBzZWdtZW50ID0gQ2FydGVzaWFuMl9kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgIGxhc3RQb2xhci5wb3NpdGlvbiwKICAgICAgICBwb2xhci5wb3NpdGlvbiwKICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMDIKICAgICAgKTsKICAgICAgY29uc3QgdCA9IENhcnRlc2lhbjJfZGVmYXVsdC5kb3QobGFzdFBvbGFyLnBvc2l0aW9uLCBzZWdtZW50KSAvIENhcnRlc2lhbjJfZGVmYXVsdC5kb3Qoc2VnbWVudCwgc2VnbWVudCk7CiAgICAgIGlmICh0ID4gMCAmJiB0IDwgMSkgewogICAgICAgIGNvbnN0IHByb2plY3RlZCA9IENhcnRlc2lhbjJfZGVmYXVsdC5hZGQoCiAgICAgICAgICBsYXN0UG9sYXIucG9zaXRpb24sCiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcihzZWdtZW50LCAtdCwgc2VnbWVudCksCiAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuMTgKICAgICAgICApOwogICAgICAgIGNvbnN0IGNsb3Nlc3RQb2xhciA9IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdC5jbG9uZShsYXN0UG9sYXIsIHNjcmF0Y2hQb2xhckNsb3Nlc3QpOwogICAgICAgIGNsb3Nlc3RQb2xhci5wb3NpdGlvbiA9IHByb2plY3RlZDsKICAgICAgICBjb25zdCBhZGp1c3RlZExhdGl0dWRlID0gY2xvc2VzdFBvbGFyLmdldExhdGl0dWRlKGVsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0LnNvdXRoID0gTWF0aC5taW4ocmVzdWx0LnNvdXRoLCBhZGp1c3RlZExhdGl0dWRlKTsKICAgICAgICByZXN1bHQubm9ydGggPSBNYXRoLm1heChyZXN1bHQubm9ydGgsIGFkanVzdGVkTGF0aXR1ZGUpOwogICAgICAgIGlmIChNYXRoLmFicyhsYXRpdHVkZSkgPiBNYXRoLmFicyhhZGp1c3RlZExhdGl0dWRlKSkgewogICAgICAgICAgc2VnbWVudExhdGl0dWRlID0gYWRqdXN0ZWRMYXRpdHVkZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGRpcmVjdGlvbjIgPSBsYXN0UG9sYXIueCAqIHBvbGFyLnkgLSBwb2xhci54ICogbGFzdFBvbGFyLnk7CiAgICBsZXQgYW5nbGUgPSBNYXRoLnNpZ24oZGlyZWN0aW9uMik7CiAgICBpZiAoYW5nbGUgIT09IDApIHsKICAgICAgYW5nbGUgKj0gQ2FydGVzaWFuMl9kZWZhdWx0LmFuZ2xlQmV0d2VlbihsYXN0UG9sYXIucG9zaXRpb24sIHBvbGFyLnBvc2l0aW9uKTsKICAgIH0KICAgIGlmIChzZWdtZW50TGF0aXR1ZGUgPj0gMCkgewogICAgICBwb2x5Z29uMi5ub3J0aEFuZ2xlICs9IGFuZ2xlOwogICAgfQogICAgaWYgKHNlZ21lbnRMYXRpdHVkZSA8PSAwKSB7CiAgICAgIHBvbHlnb24yLnNvdXRoQW5nbGUgKz0gYW5nbGU7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdldFRhbmdlbnRQbGFuZShyZWN0YW5nbGUsIHBvc2l0aW9ucywgZWxsaXBzb2lkKSB7CiAgICBpZiAocmVjdGFuZ2xlLmhlaWdodCA+PSBNYXRoX2RlZmF1bHQuUEkgfHwgcmVjdGFuZ2xlLndpZHRoID49IE1hdGhfZGVmYXVsdC5QSSkgewogICAgICBjb25zdCBwb2xhciA9IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuKAogICAgICAgIHBvc2l0aW9uc1swXSwKICAgICAgICBzY3JhdGNoUG9sYXJGb3JQbGFuZQogICAgICApOwogICAgICByZXR1cm4gcG9sYXIudGFuZ2VudFBsYW5lOwogICAgfQogICAgcmV0dXJuIEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0LmZyb21Qb2ludHMocG9zaXRpb25zLCBlbGxpcHNvaWQpOwogIH0KICBmdW5jdGlvbiBjcmVhdGVQcm9qZWN0VG8yZChyZWN0YW5nbGUsIG91dGVyUG9zaXRpb25zLCBlbGxpcHNvaWQpIHsKICAgIHJldHVybiAocG9zaXRpb25zLCByZXN1bHRzKSA9PiB7CiAgICAgIGlmIChyZWN0YW5nbGUuaGVpZ2h0ID49IE1hdGhfZGVmYXVsdC5QSSB8fCByZWN0YW5nbGUud2lkdGggPj0gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgaWYgKHJlY3RhbmdsZS5zb3V0aCA8IDAgJiYgcmVjdGFuZ2xlLm5vcnRoID4gMCkgewogICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0cykpIHsKICAgICAgICAgICAgcmVzdWx0cyA9IFtdOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY0N5bGxpbmRyaWNhbAogICAgICAgICAgICApOwogICAgICAgICAgICByZXN1bHRzW2ldID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgKICAgICAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZSAvIE1hdGhfZGVmYXVsdC5QSSwKICAgICAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmxhdGl0dWRlIC8gTWF0aF9kZWZhdWx0LlBJX09WRVJfVFdPCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHRzLmxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFN0ZXJlb2dyYXBoaWNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuQXJyYXkocG9zaXRpb25zLCByZXN1bHRzKTsKICAgICAgfQogICAgICBjb25zdCB0YW5nZW50UGxhbmUgPSBFbGxpcHNvaWRUYW5nZW50UGxhbmVfZGVmYXVsdC5mcm9tUG9pbnRzKAogICAgICAgIG91dGVyUG9zaXRpb25zLAogICAgICAgIGVsbGlwc29pZAogICAgICApOwogICAgICByZXR1cm4gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludHNPbnRvUGxhbmUocG9zaXRpb25zLCByZXN1bHRzKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVByb2plY3RQb3NpdGlvblRvMmQocmVjdGFuZ2xlLCBvdXRlclJpbmcsIGVsbGlwc29pZCkgewogICAgaWYgKHJlY3RhbmdsZS5oZWlnaHQgPj0gTWF0aF9kZWZhdWx0LlBJIHx8IHJlY3RhbmdsZS53aWR0aCA+PSBNYXRoX2RlZmF1bHQuUEkpIHsKICAgICAgcmV0dXJuIChwb3NpdGlvbiwgcmVzdWx0KSA9PiB7CiAgICAgICAgaWYgKHJlY3RhbmdsZS5zb3V0aCA8IDAgJiYgcmVjdGFuZ2xlLm5vcnRoID4gMCkgewogICAgICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWNDeWxsaW5kcmljYWwKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC54ID0gY2FydG9ncmFwaGljMi5sb25naXR1ZGUgLyBNYXRoX2RlZmF1bHQuUEk7CiAgICAgICAgICByZXN1bHQueSA9IGNhcnRvZ3JhcGhpYzIubGF0aXR1ZGUgLyBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV087CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gU3RlcmVvZ3JhcGhpY19kZWZhdWx0LmZyb21DYXJ0ZXNpYW4ocG9zaXRpb24sIHJlc3VsdCk7CiAgICAgIH07CiAgICB9CiAgICBjb25zdCB0YW5nZW50UGxhbmUgPSBFbGxpcHNvaWRUYW5nZW50UGxhbmVfZGVmYXVsdC5mcm9tUG9pbnRzKG91dGVyUmluZywgZWxsaXBzb2lkKTsKICAgIHJldHVybiAocG9zaXRpb24sIHJlc3VsdCkgPT4gewogICAgICByZXR1cm4gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludHNPbnRvUGxhbmUocG9zaXRpb24sIHJlc3VsdCk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBjcmVhdGVTcGxpdFBvbHlnb25zKHJlY3RhbmdsZSwgZWxsaXBzb2lkLCBhcmNUeXBlLCBwZXJQb3NpdGlvbkhlaWdodCkgewogICAgcmV0dXJuIChwb2x5Z29ucywgcmVzdWx0cykgPT4gewogICAgICBpZiAoIXBlclBvc2l0aW9uSGVpZ2h0ICYmIChyZWN0YW5nbGUuaGVpZ2h0ID49IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyB8fCByZWN0YW5nbGUud2lkdGggPj0gMiAqIE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RIUkVFKSkgewogICAgICAgIHJldHVybiBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc3BsaXRQb2x5Z29uc09uRXF1YXRvcigKICAgICAgICAgIHBvbHlnb25zLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgYXJjVHlwZSwKICAgICAgICAgIHJlc3VsdHMKICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiBwb2x5Z29uczsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZShvdXRlclJpbmcsIHJlY3RhbmdsZSwgZWxsaXBzb2lkLCBzdFJvdGF0aW9uKSB7CiAgICBpZiAocmVjdGFuZ2xlLmhlaWdodCA+PSBNYXRoX2RlZmF1bHQuUEkgfHwgcmVjdGFuZ2xlLndpZHRoID49IE1hdGhfZGVmYXVsdC5QSSkgewogICAgICByZXR1cm4gQm91bmRpbmdSZWN0YW5nbGVfZGVmYXVsdC5mcm9tUmVjdGFuZ2xlKAogICAgICAgIHJlY3RhbmdsZSwKICAgICAgICB2b2lkIDAsCiAgICAgICAgc2NyYXRjaEJvdW5kaW5nUmVjdGFuZ2xlCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBvdXRlclBvc2l0aW9ucyA9IG91dGVyUmluZzsKICAgIGNvbnN0IHRhbmdlbnRQbGFuZSA9IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0LmZyb21Qb2ludHMoCiAgICAgIG91dGVyUG9zaXRpb25zLAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICByZXR1cm4gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZSgKICAgICAgdGFuZ2VudFBsYW5lLnBsYW5lLm5vcm1hbCwKICAgICAgdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludE9udG9QbGFuZS5iaW5kKHRhbmdlbnRQbGFuZSksCiAgICAgIG91dGVyUG9zaXRpb25zLAogICAgICBzdFJvdGF0aW9uLAogICAgICBzY3JhdGNoQm91bmRpbmdSZWN0YW5nbGUKICAgICk7CiAgfQogIGZ1bmN0aW9uIHRleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMyKHBvbHlnb25HZW9tZXRyeSkgewogICAgY29uc3Qgc3RSb3RhdGlvbiA9IC1wb2x5Z29uR2VvbWV0cnkuX3N0Um90YXRpb247CiAgICBpZiAoc3RSb3RhdGlvbiA9PT0gMCkgewogICAgICByZXR1cm4gWzAsIDAsIDAsIDEsIDEsIDBdOwogICAgfQogICAgY29uc3QgZWxsaXBzb2lkID0gcG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBwb2x5Z29uR2VvbWV0cnkuX3BvbHlnb25IaWVyYXJjaHkucG9zaXRpb25zOwogICAgY29uc3QgYm91bmRpbmdSZWN0YW5nbGUgPSBwb2x5Z29uR2VvbWV0cnkucmVjdGFuZ2xlOwogICAgcmV0dXJuIEdlb21ldHJ5X2RlZmF1bHQuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMoCiAgICAgIHBvc2l0aW9ucywKICAgICAgc3RSb3RhdGlvbiwKICAgICAgZWxsaXBzb2lkLAogICAgICBib3VuZGluZ1JlY3RhbmdsZQogICAgKTsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0bzEsIHNjcmF0Y2hDYXJ0bzIsIHNjcmF0Y2hCb3VuZGluZ1JlY3RhbmdsZSwgc2NyYXRjaFBvc2l0aW9uMywgc2NyYXRjaE5vcm1hbDYsIHNjcmF0Y2hUYW5nZW50NCwgc2NyYXRjaEJpdGFuZ2VudDQsIHAxU2NyYXRjaDMsIHAyU2NyYXRjaDMsIHNjcmF0Y2hQZXJQb3NOb3JtYWwsIHNjcmF0Y2hQZXJQb3NUYW5nZW50LCBzY3JhdGNoUGVyUG9zQml0YW5nZW50LCBhcHBlbmRUZXh0dXJlQ29vcmRpbmF0ZXNPcmlnaW4sIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc0NhcnRlc2lhbjIsIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc0NhcnRlc2lhbjMsIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc1F1YXRlcm5pb24sIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc01hdHJpeDMsIHRhbmdlbnRNYXRyaXhTY3JhdGNoMiwgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zRXh0cnVkZWRQb3NpdGlvbnMsIHNjcmF0Y2hFbGxpcHNvaWQ2LCBzY3JhdGNoVmVydGV4Rm9ybWF0OSwgZHVtbXlPcHRpb25zLCBzY3JhdGNoQ2FydGVzaWFuMDIsIHNjcmF0Y2hDYXJ0ZXNpYW4xOCwgc2NyYXRjaFBvbGFyQ2xvc2VzdCwgc2NyYXRjaFBvbGFyLCBzY3JhdGNoUG9sYXJQcmV2aW91cywgcG9seWdvbiwgc2NyYXRjaFBvbGFyRm9yUGxhbmUsIHNjcmF0Y2hDYXJ0b2dyYXBoaWNDeWxsaW5kcmljYWwsIFBvbHlnb25HZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1BvbHlnb25HZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvbkdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9BcmNUeXBlKCk7CiAgICAgIGluaXRfQm91bmRpbmdSZWN0YW5nbGUoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZFRhbmdlbnRQbGFuZSgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUluc3RhbmNlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeVBpcGVsaW5lKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfUG9seWdvbkdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X1BvbHlnb25QaXBlbGluZSgpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9TdGVyZW9ncmFwaGljKCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIGluaXRfV2luZGluZ09yZGVyKCk7CiAgICAgIHNjcmF0Y2hDYXJ0bzEgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRvMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQm91bmRpbmdSZWN0YW5nbGUgPSBuZXcgQm91bmRpbmdSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUG9zaXRpb24zID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTm9ybWFsNiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFRhbmdlbnQ0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQml0YW5nZW50NCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcDFTY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcDJTY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlclBvc05vcm1hbCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFBlclBvc1RhbmdlbnQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQZXJQb3NCaXRhbmdlbnQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGFwcGVuZFRleHR1cmVDb29yZGluYXRlc09yaWdpbiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzQ2FydGVzaWFuMiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzQ2FydGVzaWFuMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzUXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uX2RlZmF1bHQoKTsKICAgICAgYXBwZW5kVGV4dHVyZUNvb3JkaW5hdGVzTWF0cml4MyA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgdGFuZ2VudE1hdHJpeFNjcmF0Y2gyID0gbmV3IE1hdHJpeDNfZGVmYXVsdCgpOwogICAgICBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNFeHRydWRlZFBvc2l0aW9ucyA9IFtdOwogICAgICBQb2x5Z29uR2VvbWV0cnkuZnJvbVBvc2l0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoIm9wdGlvbnMucG9zaXRpb25zIiwgb3B0aW9ucy5wb3NpdGlvbnMpOwogICAgICAgIGNvbnN0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5OiB7CiAgICAgICAgICAgIHBvc2l0aW9uczogb3B0aW9ucy5wb3NpdGlvbnMKICAgICAgICAgIH0sCiAgICAgICAgICBoZWlnaHQ6IG9wdGlvbnMuaGVpZ2h0LAogICAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IG9wdGlvbnMudmVydGV4Rm9ybWF0LAogICAgICAgICAgc3RSb3RhdGlvbjogb3B0aW9ucy5zdFJvdGF0aW9uLAogICAgICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZCwKICAgICAgICAgIGdyYW51bGFyaXR5OiBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICAgICAgcGVyUG9zaXRpb25IZWlnaHQ6IG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQsCiAgICAgICAgICBjbG9zZVRvcDogb3B0aW9ucy5jbG9zZVRvcCwKICAgICAgICAgIGNsb3NlQm90dG9tOiBvcHRpb25zLmNsb3NlQm90dG9tLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBvcHRpb25zLm9mZnNldEF0dHJpYnV0ZSwKICAgICAgICAgIGFyY1R5cGU6IG9wdGlvbnMuYXJjVHlwZSwKICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlczogb3B0aW9ucy50ZXh0dXJlQ29vcmRpbmF0ZXMKICAgICAgICB9OwogICAgICAgIHJldHVybiBuZXcgUG9seWdvbkdlb21ldHJ5KG5ld09wdGlvbnMpOwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgIHZhbHVlLl9wb2x5Z29uSGllcmFyY2h5LAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2hlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zdFJvdGF0aW9uOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9wZXJQb3NpdGlvbkhlaWdodCA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fY2xvc2VUb3AgPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2Nsb3NlQm90dG9tID8gMSA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zaGFkb3dWb2x1bWUgPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fYXJjVHlwZTsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHZhbHVlLl90ZXh0dXJlQ29vcmRpbmF0ZXMpKSB7CiAgICAgICAgICBzdGFydGluZ0luZGV4ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgICB2YWx1ZS5fdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgICAgICBhcnJheSwKICAgICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgICAgQ2FydGVzaWFuMl9kZWZhdWx0CiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gLTE7CiAgICAgICAgfQogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5wYWNrZWRMZW5ndGg7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkNiA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDkgPSBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKTsKICAgICAgZHVtbXlPcHRpb25zID0gewogICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHt9CiAgICAgIH07CiAgICAgIFBvbHlnb25HZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC51bnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0CiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gcG9seWdvbkhpZXJhcmNoeS5zdGFydGluZ0luZGV4OwogICAgICAgIGRlbGV0ZSBwb2x5Z29uSGllcmFyY2h5LnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkNik7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDkKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzdFJvdGF0aW9uID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBwZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICBjb25zdCBjbG9zZVRvcCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3QgY2xvc2VCb3R0b20gPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IHNoYWRvd1ZvbHVtZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPT09IDE7CiAgICAgICAgY29uc3Qgb2Zmc2V0QXR0cmlidXRlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBhcmNUeXBlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSBhcnJheVtzdGFydGluZ0luZGV4XSA9PT0gLTEgPyB2b2lkIDAgOiBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQudW5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIENhcnRlc2lhbjJfZGVmYXVsdAogICAgICAgICk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0ZXh0dXJlQ29vcmRpbmF0ZXMpKSB7CiAgICAgICAgICBzdGFydGluZ0luZGV4ID0gdGV4dHVyZUNvb3JkaW5hdGVzLnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgICBkZWxldGUgdGV4dHVyZUNvb3JkaW5hdGVzLnN0YXJ0aW5nSW5kZXg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGFja2VkTGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgUG9seWdvbkdlb21ldHJ5KGR1bW15T3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25IaWVyYXJjaHk7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCwgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQpOwogICAgICAgIHJlc3VsdC5faGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIHJlc3VsdC5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmVzdWx0Ll9zdFJvdGF0aW9uID0gc3RSb3RhdGlvbjsKICAgICAgICByZXN1bHQuX3BlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSA9IHBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZTsKICAgICAgICByZXN1bHQuX3BlclBvc2l0aW9uSGVpZ2h0ID0gcGVyUG9zaXRpb25IZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9jbG9zZVRvcCA9IGNsb3NlVG9wOwogICAgICAgIHJlc3VsdC5fY2xvc2VCb3R0b20gPSBjbG9zZUJvdHRvbTsKICAgICAgICByZXN1bHQuX3NoYWRvd1ZvbHVtZSA9IHNoYWRvd1ZvbHVtZTsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmVzdWx0Ll9hcmNUeXBlID0gYXJjVHlwZTsKICAgICAgICByZXN1bHQuX3RleHR1cmVDb29yZGluYXRlcyA9IHRleHR1cmVDb29yZGluYXRlczsKICAgICAgICByZXN1bHQucGFja2VkTGVuZ3RoID0gcGFja2VkTGVuZ3RoOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4wMiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjE4ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUG9sYXJDbG9zZXN0ID0gbmV3IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUG9sYXIgPSBuZXcgU3RlcmVvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQb2xhclByZXZpb3VzID0gbmV3IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBwb2x5Z29uID0gewogICAgICAgIG5vcnRoQW5nbGU6IDAsCiAgICAgICAgc291dGhBbmdsZTogMCwKICAgICAgICB3ZXN0T3ZlcklkbDogMCwKICAgICAgICBlYXN0T3ZlcklkbDogMAogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnkuY29tcHV0ZVJlY3RhbmdsZUZyb21Qb3NpdGlvbnMgPSBmdW5jdGlvbihwb3NpdGlvbnMsIGVsbGlwc29pZCwgYXJjVHlwZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJwb3NpdGlvbnMiLCBwb3NpdGlvbnMpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBpZiAocG9zaXRpb25zLmxlbmd0aCA8IDMpIHsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC53ZXN0ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIHJlc3VsdC5lYXN0ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgIHJlc3VsdC5zb3V0aCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICByZXN1bHQubm9ydGggPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgcG9seWdvbi5ub3J0aEFuZ2xlID0gMDsKICAgICAgICBwb2x5Z29uLnNvdXRoQW5nbGUgPSAwOwogICAgICAgIHBvbHlnb24ud2VzdE92ZXJJZGwgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgcG9seWdvbi5lYXN0T3ZlcklkbCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgICAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBsYXN0UG9sYXJQb3NpdGlvbiA9IFN0ZXJlb2dyYXBoaWNfZGVmYXVsdC5mcm9tQ2FydGVzaWFuKAogICAgICAgICAgcG9zaXRpb25zWzBdLAogICAgICAgICAgc2NyYXRjaFBvbGFyUHJldmlvdXMKICAgICAgICApOwogICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHBvbGFyUG9zaXRpb24gPSBTdGVyZW9ncmFwaGljX2RlZmF1bHQuZnJvbUNhcnRlc2lhbigKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBzY3JhdGNoUG9sYXIKICAgICAgICAgICk7CiAgICAgICAgICBleHBhbmRSZWN0YW5nbGUoCiAgICAgICAgICAgIHBvbGFyUG9zaXRpb24sCiAgICAgICAgICAgIGxhc3RQb2xhclBvc2l0aW9uLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIGFyY1R5cGUsCiAgICAgICAgICAgIHBvbHlnb24sCiAgICAgICAgICAgIHJlc3VsdAogICAgICAgICAgKTsKICAgICAgICAgIGxhc3RQb2xhclBvc2l0aW9uID0gU3RlcmVvZ3JhcGhpY19kZWZhdWx0LmNsb25lKHBvbGFyUG9zaXRpb24sIGxhc3RQb2xhclBvc2l0aW9uKTsKICAgICAgICB9CiAgICAgICAgZXhwYW5kUmVjdGFuZ2xlKAogICAgICAgICAgU3RlcmVvZ3JhcGhpY19kZWZhdWx0LmZyb21DYXJ0ZXNpYW4ocG9zaXRpb25zWzBdLCBzY3JhdGNoUG9sYXIpLAogICAgICAgICAgbGFzdFBvbGFyUG9zaXRpb24sCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBhcmNUeXBlLAogICAgICAgICAgcG9seWdvbiwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgICAgaWYgKHJlc3VsdC5lYXN0IC0gcmVzdWx0Lndlc3QgPiBwb2x5Z29uLmVhc3RPdmVySWRsIC0gcG9seWdvbi53ZXN0T3ZlcklkbCkgewogICAgICAgICAgcmVzdWx0Lndlc3QgPSBwb2x5Z29uLndlc3RPdmVySWRsOwogICAgICAgICAgcmVzdWx0LmVhc3QgPSBwb2x5Z29uLmVhc3RPdmVySWRsOwogICAgICAgICAgaWYgKHJlc3VsdC5lYXN0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICAgIHJlc3VsdC5lYXN0ID0gcmVzdWx0LmVhc3QgLSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlc3VsdC53ZXN0ID4gTWF0aF9kZWZhdWx0LlBJKSB7CiAgICAgICAgICAgIHJlc3VsdC53ZXN0ID0gcmVzdWx0Lndlc3QgLSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICBNYXRoLmFicyhwb2x5Z29uLm5vcnRoQW5nbGUpLAogICAgICAgICAgTWF0aF9kZWZhdWx0LlRXT19QSSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTAKICAgICAgICApKSB7CiAgICAgICAgICByZXN1bHQubm9ydGggPSBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV087CiAgICAgICAgICByZXN1bHQuZWFzdCA9IE1hdGhfZGVmYXVsdC5QSTsKICAgICAgICAgIHJlc3VsdC53ZXN0ID0gLU1hdGhfZGVmYXVsdC5QSTsKICAgICAgICB9CiAgICAgICAgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgTWF0aC5hYnMocG9seWdvbi5zb3V0aEFuZ2xlKSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5UV09fUEksCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwCiAgICAgICAgKSkgewogICAgICAgICAgcmVzdWx0LnNvdXRoID0gLU1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICAgIHJlc3VsdC5lYXN0ID0gTWF0aF9kZWZhdWx0LlBJOwogICAgICAgICAgcmVzdWx0Lndlc3QgPSAtTWF0aF9kZWZhdWx0LlBJOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoUG9sYXJGb3JQbGFuZSA9IG5ldyBTdGVyZW9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpY0N5bGxpbmRyaWNhbCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBQb2x5Z29uR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihwb2x5Z29uR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBwb2x5Z29uR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IHBvbHlnb25HZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3Qgc3RSb3RhdGlvbiA9IHBvbHlnb25HZW9tZXRyeS5fc3RSb3RhdGlvbjsKICAgICAgICBjb25zdCBwb2x5Z29uSGllcmFyY2h5ID0gcG9seWdvbkdlb21ldHJ5Ll9wb2x5Z29uSGllcmFyY2h5OwogICAgICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0ID0gcG9seWdvbkdlb21ldHJ5Ll9wZXJQb3NpdGlvbkhlaWdodDsKICAgICAgICBjb25zdCBjbG9zZVRvcCA9IHBvbHlnb25HZW9tZXRyeS5fY2xvc2VUb3A7CiAgICAgICAgY29uc3QgY2xvc2VCb3R0b20gPSBwb2x5Z29uR2VvbWV0cnkuX2Nsb3NlQm90dG9tOwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBwb2x5Z29uR2VvbWV0cnkuX2FyY1R5cGU7CiAgICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gcG9seWdvbkdlb21ldHJ5Ll90ZXh0dXJlQ29vcmRpbmF0ZXM7CiAgICAgICAgY29uc3QgaGFzVGV4dHVyZUNvb3JkaW5hdGVzID0gZGVmaW5lZF9kZWZhdWx0KHRleHR1cmVDb29yZGluYXRlcyk7CiAgICAgICAgY29uc3Qgb3V0ZXJQb3NpdGlvbnMgPSBwb2x5Z29uSGllcmFyY2h5LnBvc2l0aW9uczsKICAgICAgICBpZiAob3V0ZXJQb3NpdGlvbnMubGVuZ3RoIDwgMykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCByZWN0YW5nbGUgPSBwb2x5Z29uR2VvbWV0cnkucmVjdGFuZ2xlOwogICAgICAgIGNvbnN0IHJlc3VsdHMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucG9seWdvbnNGcm9tSGllcmFyY2h5KAogICAgICAgICAgcG9seWdvbkhpZXJhcmNoeSwKICAgICAgICAgIGhhc1RleHR1cmVDb29yZGluYXRlcywKICAgICAgICAgIGNyZWF0ZVByb2plY3RUbzJkKHJlY3RhbmdsZSwgb3V0ZXJQb3NpdGlvbnMsIGVsbGlwc29pZCksCiAgICAgICAgICAhcGVyUG9zaXRpb25IZWlnaHQsCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBjcmVhdGVTcGxpdFBvbHlnb25zKHJlY3RhbmdsZSwgZWxsaXBzb2lkLCBhcmNUeXBlLCBwZXJQb3NpdGlvbkhlaWdodCkKICAgICAgICApOwogICAgICAgIGNvbnN0IGhpZXJhcmNoeSA9IHJlc3VsdHMuaGllcmFyY2h5OwogICAgICAgIGNvbnN0IHBvbHlnb25zID0gcmVzdWx0cy5wb2x5Z29uczsKICAgICAgICBjb25zdCBkdW1teUZ1bmN0aW9uID0gZnVuY3Rpb24oaWRlbnRpdHkpIHsKICAgICAgICAgIHJldHVybiBpZGVudGl0eTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IHRleHR1cmVDb29yZGluYXRlUG9seWdvbnMgPSBoYXNUZXh0dXJlQ29vcmRpbmF0ZXMgPyBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucG9seWdvbnNGcm9tSGllcmFyY2h5KAogICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzLAogICAgICAgICAgdHJ1ZSwKICAgICAgICAgIGR1bW15RnVuY3Rpb24sCiAgICAgICAgICBmYWxzZSwKICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICkucG9seWdvbnMgOiB2b2lkIDA7CiAgICAgICAgaWYgKGhpZXJhcmNoeS5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb3V0ZXJSaW5nID0gaGllcmFyY2h5WzBdLm91dGVyUmluZzsKICAgICAgICBjb25zdCBib3VuZGluZ1JlY3RhbmdsZSA9IGNvbXB1dGVCb3VuZGluZ1JlY3RhbmdsZSgKICAgICAgICAgIG91dGVyUmluZywKICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHN0Um90YXRpb24KICAgICAgICApOwogICAgICAgIGNvbnN0IGdlb21ldHJpZXMgPSBbXTsKICAgICAgICBjb25zdCBoZWlnaHQgPSBwb2x5Z29uR2VvbWV0cnkuX2hlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IHBvbHlnb25HZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZSA9IHBvbHlnb25HZW9tZXRyeS5fcGVyUG9zaXRpb25IZWlnaHRFeHRydWRlIHx8ICFNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0LCAwLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjIpOwogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICBwZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICAgIHZlcnRleEZvcm1hdCwKICAgICAgICAgIGdlb21ldHJ5OiB2b2lkIDAsCiAgICAgICAgICByb3RhdGlvbkF4aXM6IGdldFRhbmdlbnRQbGFuZShyZWN0YW5nbGUsIG91dGVyUmluZywgZWxsaXBzb2lkKS5wbGFuZS5ub3JtYWwsCiAgICAgICAgICBwcm9qZWN0VG8yZDogY3JlYXRlUHJvamVjdFBvc2l0aW9uVG8yZChyZWN0YW5nbGUsIG91dGVyUmluZywgZWxsaXBzb2lkKSwKICAgICAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgc3RSb3RhdGlvbiwKICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlczogdm9pZCAwLAogICAgICAgICAgYm90dG9tOiBmYWxzZSwKICAgICAgICAgIHRvcDogdHJ1ZSwKICAgICAgICAgIHdhbGw6IGZhbHNlLAogICAgICAgICAgZXh0cnVkZTogZmFsc2UsCiAgICAgICAgICBhcmNUeXBlCiAgICAgICAgfTsKICAgICAgICBsZXQgaTsKICAgICAgICBpZiAoZXh0cnVkZSkgewogICAgICAgICAgb3B0aW9ucy5leHRydWRlID0gdHJ1ZTsKICAgICAgICAgIG9wdGlvbnMudG9wID0gY2xvc2VUb3A7CiAgICAgICAgICBvcHRpb25zLmJvdHRvbSA9IGNsb3NlQm90dG9tOwogICAgICAgICAgb3B0aW9ucy5zaGFkb3dWb2x1bWUgPSBwb2x5Z29uR2VvbWV0cnkuX3NoYWRvd1ZvbHVtZTsKICAgICAgICAgIG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlID0gcG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcG9seWdvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3Qgc3BsaXRHZW9tZXRyeSA9IGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc0V4dHJ1ZGVkKAogICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICBwb2x5Z29uc1tpXSwKICAgICAgICAgICAgICBoYXNUZXh0dXJlQ29vcmRpbmF0ZXMgPyB0ZXh0dXJlQ29vcmRpbmF0ZVBvbHlnb25zW2ldIDogdm9pZCAwLAogICAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICAgIGhpZXJhcmNoeVtpXSwKICAgICAgICAgICAgICBwZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICAgICAgICBjbG9zZVRvcCwKICAgICAgICAgICAgICBjbG9zZUJvdHRvbSwKICAgICAgICAgICAgICB2ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICAgICAgYXJjVHlwZQogICAgICAgICAgICApOwogICAgICAgICAgICBsZXQgdG9wQW5kQm90dG9tOwogICAgICAgICAgICBpZiAoY2xvc2VUb3AgJiYgY2xvc2VCb3R0b20pIHsKICAgICAgICAgICAgICB0b3BBbmRCb3R0b20gPSBzcGxpdEdlb21ldHJ5LnRvcEFuZEJvdHRvbTsKICAgICAgICAgICAgICBvcHRpb25zLmdlb21ldHJ5ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodEV4dHJ1ZGVkKAogICAgICAgICAgICAgICAgdG9wQW5kQm90dG9tLmdlb21ldHJ5LAogICAgICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICBwZXJQb3NpdGlvbkhlaWdodAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xvc2VUb3ApIHsKICAgICAgICAgICAgICB0b3BBbmRCb3R0b20gPSBzcGxpdEdlb21ldHJ5LnRvcEFuZEJvdHRvbTsKICAgICAgICAgICAgICB0b3BBbmRCb3R0b20uZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgICAgICAgICAgICB0b3BBbmRCb3R0b20uZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICAhcGVyUG9zaXRpb25IZWlnaHQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIG9wdGlvbnMuZ2VvbWV0cnkgPSB0b3BBbmRCb3R0b20uZ2VvbWV0cnk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xvc2VCb3R0b20pIHsKICAgICAgICAgICAgICB0b3BBbmRCb3R0b20gPSBzcGxpdEdlb21ldHJ5LnRvcEFuZEJvdHRvbTsKICAgICAgICAgICAgICB0b3BBbmRCb3R0b20uZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgICAgICAgICAgICB0b3BBbmRCb3R0b20uZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgICAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAgIHRydWUKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIG9wdGlvbnMuZ2VvbWV0cnkgPSB0b3BBbmRCb3R0b20uZ2VvbWV0cnk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNsb3NlVG9wIHx8IGNsb3NlQm90dG9tKSB7CiAgICAgICAgICAgICAgb3B0aW9ucy53YWxsID0gZmFsc2U7CiAgICAgICAgICAgICAgdG9wQW5kQm90dG9tLmdlb21ldHJ5ID0gY29tcHV0ZUF0dHJpYnV0ZXMob3B0aW9ucyk7CiAgICAgICAgICAgICAgZ2VvbWV0cmllcy5wdXNoKHRvcEFuZEJvdHRvbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3Qgd2FsbHMgPSBzcGxpdEdlb21ldHJ5LndhbGxzOwogICAgICAgICAgICBvcHRpb25zLndhbGwgPSB0cnVlOwogICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IHdhbGxzLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgY29uc3Qgd2FsbCA9IHdhbGxzW2tdOwogICAgICAgICAgICAgIG9wdGlvbnMuZ2VvbWV0cnkgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0RXh0cnVkZWQoCiAgICAgICAgICAgICAgICB3YWxsLmdlb21ldHJ5LAogICAgICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgICBwZXJQb3NpdGlvbkhlaWdodAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgd2FsbC5nZW9tZXRyeSA9IGNvbXB1dGVBdHRyaWJ1dGVzKG9wdGlvbnMpOwogICAgICAgICAgICAgIGdlb21ldHJpZXMucHVzaCh3YWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcG9seWdvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cnlJbnN0YW5jZSA9IG5ldyBHZW9tZXRyeUluc3RhbmNlX2RlZmF1bHQoewogICAgICAgICAgICAgIGdlb21ldHJ5OiBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zKAogICAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgICAgcG9seWdvbnNbaV0sCiAgICAgICAgICAgICAgICBoYXNUZXh0dXJlQ29vcmRpbmF0ZXMgPyB0ZXh0dXJlQ29vcmRpbmF0ZVBvbHlnb25zW2ldIDogdm9pZCAwLAogICAgICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgICAgICBwZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICAgICAgICAgIHZlcnRleEZvcm1hdCwKICAgICAgICAgICAgICAgIGFyY1R5cGUKICAgICAgICAgICAgICApCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBnZW9tZXRyeUluc3RhbmNlLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAhcGVyUG9zaXRpb25IZWlnaHQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgb3B0aW9ucy5nZW9tZXRyeSA9IGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnk7CiAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkgPSBjb21wdXRlQXR0cmlidXRlcyhvcHRpb25zKTsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChwb2x5Z29uR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgICBjb25zdCBsZW5ndGggPSBnZW9tZXRyeUluc3RhbmNlLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aDsKICAgICAgICAgICAgICBjb25zdCBvZmZzZXRWYWx1ZSA9IHBvbHlnb25HZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goZ2VvbWV0cnlJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmNvbWJpbmVJbnN0YW5jZXMoZ2VvbWV0cmllcylbMF07CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBuZXcgRmxvYXQ2NEFycmF5KAogICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMKICAgICAgICApOwogICAgICAgIGdlb21ldHJ5LmluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCAvIDMsCiAgICAgICAgICBnZW9tZXRyeS5pbmRpY2VzCiAgICAgICAgKTsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVZlcnRpY2VzKAogICAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMKICAgICAgICApOwogICAgICAgIGlmICghdmVydGV4Rm9ybWF0LnBvc2l0aW9uKSB7CiAgICAgICAgICBkZWxldGUgYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgICBpbmRpY2VzOiBnZW9tZXRyeS5pbmRpY2VzLAogICAgICAgICAgcHJpbWl0aXZlVHlwZTogZ2VvbWV0cnkucHJpbWl0aXZlVHlwZSwKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiBwb2x5Z29uR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBQb2x5Z29uR2VvbWV0cnkuY3JlYXRlU2hhZG93Vm9sdW1lID0gZnVuY3Rpb24ocG9seWdvbkdlb21ldHJ5LCBtaW5IZWlnaHRGdW5jLCBtYXhIZWlnaHRGdW5jKSB7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBwb2x5Z29uR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHBvbHlnb25HZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IG1pbkhlaWdodCA9IG1pbkhlaWdodEZ1bmMoZ3JhbnVsYXJpdHksIGVsbGlwc29pZCk7CiAgICAgICAgY29uc3QgbWF4SGVpZ2h0ID0gbWF4SGVpZ2h0RnVuYyhncmFudWxhcml0eSwgZWxsaXBzb2lkKTsKICAgICAgICByZXR1cm4gbmV3IFBvbHlnb25HZW9tZXRyeSh7CiAgICAgICAgICBwb2x5Z29uSGllcmFyY2h5OiBwb2x5Z29uR2VvbWV0cnkuX3BvbHlnb25IaWVyYXJjaHksCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICBzdFJvdGF0aW9uOiBwb2x5Z29uR2VvbWV0cnkuX3N0Um90YXRpb24sCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0OiBmYWxzZSwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiBtaW5IZWlnaHQsCiAgICAgICAgICBoZWlnaHQ6IG1heEhlaWdodCwKICAgICAgICAgIHZlcnRleEZvcm1hdDogVmVydGV4Rm9ybWF0X2RlZmF1bHQuUE9TSVRJT05fT05MWSwKICAgICAgICAgIHNoYWRvd1ZvbHVtZTogdHJ1ZSwKICAgICAgICAgIGFyY1R5cGU6IHBvbHlnb25HZW9tZXRyeS5fYXJjVHlwZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhQb2x5Z29uR2VvbWV0cnkucHJvdG90eXBlLCB7CiAgICAgICAgLyoqCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICByZWN0YW5nbGU6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXMuX3JlY3RhbmdsZSkpIHsKICAgICAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB0aGlzLl9wb2x5Z29uSGllcmFyY2h5LnBvc2l0aW9uczsKICAgICAgICAgICAgICB0aGlzLl9yZWN0YW5nbGUgPSBQb2x5Z29uR2VvbWV0cnkuY29tcHV0ZVJlY3RhbmdsZUZyb21Qb3NpdGlvbnMoCiAgICAgICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgICAgICB0aGlzLl9lbGxpcHNvaWQsCiAgICAgICAgICAgICAgICB0aGlzLl9hcmNUeXBlCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5fcmVjdGFuZ2xlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogRm9yIHJlbWFwcGluZyB0ZXh0dXJlIGNvb3JkaW5hdGVzIHdoZW4gcmVuZGVyaW5nIFBvbHlnb25HZW9tZXRyaWVzIGFzIEdyb3VuZFByaW1pdGl2ZXMuCiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzKSkgewogICAgICAgICAgICAgIHRoaXMuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMgPSB0ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzMigKICAgICAgICAgICAgICAgIHRoaXMKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl90ZXh0dXJlQ29vcmRpbmF0ZVJvdGF0aW9uUG9pbnRzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIFBvbHlnb25HZW9tZXRyeV9kZWZhdWx0ID0gUG9seWdvbkdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUG9seWdvbkdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVBvbHlnb25HZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUG9seWdvbkdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVBvbHlnb25HZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlUG9seWdvbkdlb21ldHJ5KHBvbHlnb25HZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcG9seWdvbkdlb21ldHJ5ID0gUG9seWdvbkdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHBvbHlnb25HZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHBvbHlnb25HZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUocG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmV0dXJuIFBvbHlnb25HZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHBvbHlnb25HZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVQb2x5Z29uR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVQb2x5Z29uR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBvbHlnb25HZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1BvbHlnb25HZW9tZXRyeSgpOwogICAgICBjcmVhdGVQb2x5Z29uR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVBvbHlnb25HZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlnb25PdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnMyKGVsbGlwc29pZCwgcG9zaXRpb25zLCBtaW5EaXN0YW5jZSwgcGVyUG9zaXRpb25IZWlnaHQsIGFyY1R5cGUpIHsKICAgIGNvbnN0IHRhbmdlbnRQbGFuZSA9IEVsbGlwc29pZFRhbmdlbnRQbGFuZV9kZWZhdWx0LmZyb21Qb2ludHMocG9zaXRpb25zLCBlbGxpcHNvaWQpOwogICAgY29uc3QgcG9zaXRpb25zMkQgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50c09udG9QbGFuZSgKICAgICAgcG9zaXRpb25zLAogICAgICBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNQb3NpdGlvbnMKICAgICk7CiAgICBjb25zdCBvcmlnaW5hbFdpbmRpbmdPcmRlciA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVXaW5kaW5nT3JkZXIyRCgKICAgICAgcG9zaXRpb25zMkQKICAgICk7CiAgICBpZiAob3JpZ2luYWxXaW5kaW5nT3JkZXIgPT09IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNMT0NLV0lTRSkgewogICAgICBwb3NpdGlvbnMyRC5yZXZlcnNlKCk7CiAgICAgIHBvc2l0aW9ucyA9IHBvc2l0aW9ucy5zbGljZSgpLnJldmVyc2UoKTsKICAgIH0KICAgIGxldCBzdWJkaXZpZGVkUG9zaXRpb25zOwogICAgbGV0IGk7CiAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGxldCBpbmRleCA9IDA7CiAgICBpZiAoIXBlclBvc2l0aW9uSGVpZ2h0KSB7CiAgICAgIGxldCBudW1WZXJ0aWNlcyA9IDA7CiAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG51bVZlcnRpY2VzICs9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zdWJkaXZpZGVMaW5lQ291bnQoCiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdLAogICAgICAgICAgICBtaW5EaXN0YW5jZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBudW1WZXJ0aWNlcyArPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc3ViZGl2aWRlUmh1bWJMaW5lQ291bnQoCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF0sCiAgICAgICAgICAgIG1pbkRpc3RhbmNlCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShudW1WZXJ0aWNlcyAqIDMpOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBsZXQgdGVtcFBvc2l0aW9uczsKICAgICAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKSB7CiAgICAgICAgICB0ZW1wUG9zaXRpb25zID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnN1YmRpdmlkZUxpbmUoCiAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdLAogICAgICAgICAgICBtaW5EaXN0YW5jZSwKICAgICAgICAgICAgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zU3ViZGl2aWRlZAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICAgICAgdGVtcFBvc2l0aW9ucyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zdWJkaXZpZGVSaHVtYkxpbmUoCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF0sCiAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNTdWJkaXZpZGVkCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCB0ZW1wUG9zaXRpb25zTGVuZ3RoID0gdGVtcFBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB0ZW1wUG9zaXRpb25zTGVuZ3RoOyArK2opIHsKICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSB0ZW1wUG9zaXRpb25zW2pdOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkobGVuZ3RoICogMiAqIDMpOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBwMCA9IHBvc2l0aW9uc1tpXTsKICAgICAgICBjb25zdCBwMSA9IHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXTsKICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW2luZGV4KytdID0gcDAueDsKICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW2luZGV4KytdID0gcDAueTsKICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW2luZGV4KytdID0gcDAuejsKICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW2luZGV4KytdID0gcDEueDsKICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW2luZGV4KytdID0gcDEueTsKICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW2luZGV4KytdID0gcDEuejsKICAgICAgfQogICAgfQogICAgbGVuZ3RoID0gc3ViZGl2aWRlZFBvc2l0aW9ucy5sZW5ndGggLyAzOwogICAgY29uc3QgaW5kaWNlc1NpemUgPSBsZW5ndGggKiAyOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KGxlbmd0aCwgaW5kaWNlc1NpemUpOwogICAgaW5kZXggPSAwOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyAxOwogICAgfQogICAgaW5kaWNlc1tpbmRleCsrXSA9IGxlbmd0aCAtIDE7CiAgICBpbmRpY2VzW2luZGV4KytdID0gMDsKICAgIHJldHVybiBuZXcgR2VvbWV0cnlJbnN0YW5jZV9kZWZhdWx0KHsKICAgICAgZ2VvbWV0cnk6IG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICBhdHRyaWJ1dGVzOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoewogICAgICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHN1YmRpdmlkZWRQb3NpdGlvbnMKICAgICAgICAgIH0pCiAgICAgICAgfSksCiAgICAgICAgaW5kaWNlcywKICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMKICAgICAgfSkKICAgIH0pOwogIH0KICBmdW5jdGlvbiBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNFeHRydWRlZDIoZWxsaXBzb2lkLCBwb3NpdGlvbnMsIG1pbkRpc3RhbmNlLCBwZXJQb3NpdGlvbkhlaWdodCwgYXJjVHlwZSkgewogICAgY29uc3QgdGFuZ2VudFBsYW5lID0gRWxsaXBzb2lkVGFuZ2VudFBsYW5lX2RlZmF1bHQuZnJvbVBvaW50cyhwb3NpdGlvbnMsIGVsbGlwc29pZCk7CiAgICBjb25zdCBwb3NpdGlvbnMyRCA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRzT250b1BsYW5lKAogICAgICBwb3NpdGlvbnMsCiAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1Bvc2l0aW9ucwogICAgKTsKICAgIGNvbnN0IG9yaWdpbmFsV2luZGluZ09yZGVyID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVdpbmRpbmdPcmRlcjJEKAogICAgICBwb3NpdGlvbnMyRAogICAgKTsKICAgIGlmIChvcmlnaW5hbFdpbmRpbmdPcmRlciA9PT0gV2luZGluZ09yZGVyX2RlZmF1bHQuQ0xPQ0tXSVNFKSB7CiAgICAgIHBvc2l0aW9uczJELnJldmVyc2UoKTsKICAgICAgcG9zaXRpb25zID0gcG9zaXRpb25zLnNsaWNlKCkucmV2ZXJzZSgpOwogICAgfQogICAgbGV0IHN1YmRpdmlkZWRQb3NpdGlvbnM7CiAgICBsZXQgaTsKICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3QgY29ybmVycyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGlmICghcGVyUG9zaXRpb25IZWlnaHQpIHsKICAgICAgbGV0IG51bVZlcnRpY2VzID0gMDsKICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgbnVtVmVydGljZXMgKz0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnN1YmRpdmlkZUxpbmVDb3VudCgKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF0sCiAgICAgICAgICAgIG1pbkRpc3RhbmNlCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuUkhVTUIpIHsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG51bVZlcnRpY2VzICs9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5zdWJkaXZpZGVSaHVtYkxpbmVDb3VudCgKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KG51bVZlcnRpY2VzICogMyAqIDIpOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICBjb3JuZXJzW2ldID0gaW5kZXggLyAzOwogICAgICAgIGxldCB0ZW1wUG9zaXRpb25zOwogICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgIHRlbXBQb3NpdGlvbnMgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc3ViZGl2aWRlTGluZSgKICAgICAgICAgICAgcG9zaXRpb25zW2ldLAogICAgICAgICAgICBwb3NpdGlvbnNbKGkgKyAxKSAlIGxlbmd0aF0sCiAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNTdWJkaXZpZGVkCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICB0ZW1wUG9zaXRpb25zID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnN1YmRpdmlkZVJodW1iTGluZSgKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgIHBvc2l0aW9uc1soaSArIDEpICUgbGVuZ3RoXSwKICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1N1YmRpdmlkZWQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHRlbXBQb3NpdGlvbnNMZW5ndGggPSB0ZW1wUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRlbXBQb3NpdGlvbnNMZW5ndGg7ICsraikgewogICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9uc1tpbmRleCsrXSA9IHRlbXBQb3NpdGlvbnNbal07CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGggKiAyICogMyAqIDIpOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICBjb3JuZXJzW2ldID0gaW5kZXggLyAzOwogICAgICAgIGNvbnN0IHAwID0gcG9zaXRpb25zW2ldOwogICAgICAgIGNvbnN0IHAxID0gcG9zaXRpb25zWyhpICsgMSkgJSBsZW5ndGhdOwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMC54OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMC55OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMC56OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMS54OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMS55OwogICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnNbaW5kZXgrK10gPSBwMS56OwogICAgICB9CiAgICB9CiAgICBsZW5ndGggPSBzdWJkaXZpZGVkUG9zaXRpb25zLmxlbmd0aCAvICgzICogMik7CiAgICBjb25zdCBjb3JuZXJzTGVuZ3RoID0gY29ybmVycy5sZW5ndGg7CiAgICBjb25zdCBpbmRpY2VzU2l6ZSA9IChsZW5ndGggKiAyICsgY29ybmVyc0xlbmd0aCkgKiAyOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBsZW5ndGggKyBjb3JuZXJzTGVuZ3RoLAogICAgICBpbmRpY2VzU2l6ZQogICAgKTsKICAgIGluZGV4ID0gMDsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IChpICsgMSkgJSBsZW5ndGg7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgbGVuZ3RoOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gKGkgKyAxKSAlIGxlbmd0aCArIGxlbmd0aDsKICAgIH0KICAgIGZvciAoaSA9IDA7IGkgPCBjb3JuZXJzTGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgY29ybmVyID0gY29ybmVyc1tpXTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGNvcm5lcjsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGNvcm5lciArIGxlbmd0aDsKICAgIH0KICAgIHJldHVybiBuZXcgR2VvbWV0cnlJbnN0YW5jZV9kZWZhdWx0KHsKICAgICAgZ2VvbWV0cnk6IG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgICBhdHRyaWJ1dGVzOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoewogICAgICAgICAgcG9zaXRpb246IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHN1YmRpdmlkZWRQb3NpdGlvbnMKICAgICAgICAgIH0pCiAgICAgICAgfSksCiAgICAgICAgaW5kaWNlcywKICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMKICAgICAgfSkKICAgIH0pOwogIH0KICBmdW5jdGlvbiBQb2x5Z29uT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgib3B0aW9ucyIsIG9wdGlvbnMpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJvcHRpb25zLnBvbHlnb25IaWVyYXJjaHkiLCBvcHRpb25zLnBvbHlnb25IaWVyYXJjaHkpOwogICAgaWYgKG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQgJiYgZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0KSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAiQ2Fubm90IHVzZSBib3RoIG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQgYW5kIG9wdGlvbnMuaGVpZ2h0IgogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvcHRpb25zLmFyY1R5cGUpICYmIG9wdGlvbnMuYXJjVHlwZSAhPT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDICYmIG9wdGlvbnMuYXJjVHlwZSAhPT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJJbnZhbGlkIGFyY1R5cGUuIFZhbGlkIG9wdGlvbnMgYXJlIEFyY1R5cGUuR0VPREVTSUMgYW5kIEFyY1R5cGUuUkhVTUIuIgogICAgICApOwogICAgfQogICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IG9wdGlvbnMucG9seWdvbkhpZXJhcmNoeTsKICAgIGNvbnN0IGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgY29uc3QgcGVyUG9zaXRpb25IZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnBlclBvc2l0aW9uSGVpZ2h0LCBmYWxzZSk7CiAgICBjb25zdCBwZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgPSBwZXJQb3NpdGlvbkhlaWdodCAmJiBkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5leHRydWRlZEhlaWdodCk7CiAgICBjb25zdCBhcmNUeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5hcmNUeXBlLCBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpOwogICAgbGV0IGhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0LCAwKTsKICAgIGxldCBleHRydWRlZEhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXh0cnVkZWRIZWlnaHQsIGhlaWdodCk7CiAgICBpZiAoIXBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSkgewogICAgICBjb25zdCBoID0gTWF0aC5tYXgoaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICAgIGV4dHJ1ZGVkSGVpZ2h0ID0gTWF0aC5taW4oaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICAgIGhlaWdodCA9IGg7CiAgICB9CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgIHRoaXMuX2hlaWdodCA9IGhlaWdodDsKICAgIHRoaXMuX2V4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICB0aGlzLl9hcmNUeXBlID0gYXJjVHlwZTsKICAgIHRoaXMuX3BvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uSGllcmFyY2h5OwogICAgdGhpcy5fcGVyUG9zaXRpb25IZWlnaHQgPSBwZXJQb3NpdGlvbkhlaWdodDsKICAgIHRoaXMuX3BlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSA9IHBlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZTsKICAgIHRoaXMuX29mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5IjsKICAgIHRoaXMucGFja2VkTGVuZ3RoID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVIaWVyYXJjaHlQYWNrZWRMZW5ndGgoCiAgICAgIHBvbHlnb25IaWVyYXJjaHksCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdAogICAgKSArIEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDg7CiAgfQogIHZhciBjcmVhdGVHZW9tZXRyeUZyb21Qb3NpdGlvbnNQb3NpdGlvbnMsIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1N1YmRpdmlkZWQsIHNjcmF0Y2hFbGxpcHNvaWQ3LCBkdW1teU9wdGlvbnMyLCBQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUG9seWdvbk91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWdvbk91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQXJjVHlwZSgpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRUYW5nZW50UGxhbmUoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlJbnN0YW5jZSgpOwogICAgICBpbml0X0dlb21ldHJ5T2Zmc2V0QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlQaXBlbGluZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWdvbkdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X1BvbHlnb25QaXBlbGluZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9XaW5kaW5nT3JkZXIoKTsKICAgICAgY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zUG9zaXRpb25zID0gW107CiAgICAgIGNyZWF0ZUdlb21ldHJ5RnJvbVBvc2l0aW9uc1N1YmRpdmlkZWQgPSBbXTsKICAgICAgUG9seWdvbk91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoImFycmF5IiwgYXJyYXkpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gUG9seWdvbkdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnBhY2tQb2x5Z29uSGllcmFyY2h5KAogICAgICAgICAgdmFsdWUuX3BvbHlnb25IaWVyYXJjaHksCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQKICAgICAgICApOwogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5faGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3BlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fcGVyUG9zaXRpb25IZWlnaHQgPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2FyY1R5cGU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLnBhY2tlZExlbmd0aDsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQ3ID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoRWxsaXBzb2lkX2RlZmF1bHQuVU5JVF9TUEhFUkUpOwogICAgICBkdW1teU9wdGlvbnMyID0gewogICAgICAgIHBvbHlnb25IaWVyYXJjaHk6IHt9CiAgICAgIH07CiAgICAgIFBvbHlnb25PdXRsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IHBvbHlnb25IaWVyYXJjaHkgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQudW5wYWNrUG9seWdvbkhpZXJhcmNoeSgKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdAogICAgICAgICk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IHBvbHlnb25IaWVyYXJjaHkuc3RhcnRpbmdJbmRleDsKICAgICAgICBkZWxldGUgcG9seWdvbkhpZXJhcmNoeS5zdGFydGluZ0luZGV4OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDcpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBwZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IHBlclBvc2l0aW9uSGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9PT0gMTsKICAgICAgICBjb25zdCBhcmNUeXBlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBvZmZzZXRBdHRyaWJ1dGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBhY2tlZExlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBQb2x5Z29uT3V0bGluZUdlb21ldHJ5KGR1bW15T3B0aW9uczIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQuX3BvbHlnb25IaWVyYXJjaHkgPSBwb2x5Z29uSGllcmFyY2h5OwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLCByZXN1bHQuX2VsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0Ll9oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXN1bHQuX3BlclBvc2l0aW9uSGVpZ2h0ID0gcGVyUG9zaXRpb25IZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9wZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGUgPSBwZXJQb3NpdGlvbkhlaWdodEV4dHJ1ZGU7CiAgICAgICAgcmVzdWx0Ll9hcmNUeXBlID0gYXJjVHlwZTsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmVzdWx0LnBhY2tlZExlbmd0aCA9IHBhY2tlZExlbmd0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmZyb21Qb3NpdGlvbnMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJvcHRpb25zLnBvc2l0aW9ucyIsIG9wdGlvbnMucG9zaXRpb25zKTsKICAgICAgICBjb25zdCBuZXdPcHRpb25zID0gewogICAgICAgICAgcG9seWdvbkhpZXJhcmNoeTogewogICAgICAgICAgICBwb3NpdGlvbnM6IG9wdGlvbnMucG9zaXRpb25zCiAgICAgICAgICB9LAogICAgICAgICAgaGVpZ2h0OiBvcHRpb25zLmhlaWdodCwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0OiBvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZCwKICAgICAgICAgIGdyYW51bGFyaXR5OiBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICAgICAgcGVyUG9zaXRpb25IZWlnaHQ6IG9wdGlvbnMucGVyUG9zaXRpb25IZWlnaHQsCiAgICAgICAgICBhcmNUeXBlOiBvcHRpb25zLmFyY1R5cGUsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gbmV3IFBvbHlnb25PdXRsaW5lR2VvbWV0cnkobmV3T3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFBvbHlnb25PdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihwb2x5Z29uR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IHBvbHlnb25HZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgcG9seWdvbkhpZXJhcmNoeSA9IHBvbHlnb25HZW9tZXRyeS5fcG9seWdvbkhpZXJhcmNoeTsKICAgICAgICBjb25zdCBwZXJQb3NpdGlvbkhlaWdodCA9IHBvbHlnb25HZW9tZXRyeS5fcGVyUG9zaXRpb25IZWlnaHQ7CiAgICAgICAgY29uc3QgYXJjVHlwZSA9IHBvbHlnb25HZW9tZXRyeS5fYXJjVHlwZTsKICAgICAgICBjb25zdCBwb2x5Z29ucyA9IFBvbHlnb25HZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5wb2x5Z29uT3V0bGluZXNGcm9tSGllcmFyY2h5KAogICAgICAgICAgcG9seWdvbkhpZXJhcmNoeSwKICAgICAgICAgICFwZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICAgIGVsbGlwc29pZAogICAgICAgICk7CiAgICAgICAgaWYgKHBvbHlnb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgbGV0IGdlb21ldHJ5SW5zdGFuY2U7CiAgICAgICAgY29uc3QgZ2VvbWV0cmllcyA9IFtdOwogICAgICAgIGNvbnN0IG1pbkRpc3RhbmNlID0gTWF0aF9kZWZhdWx0LmNob3JkTGVuZ3RoKAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBlbGxpcHNvaWQubWF4aW11bVJhZGl1cwogICAgICAgICk7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gcG9seWdvbkdlb21ldHJ5Ll9oZWlnaHQ7CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBwb2x5Z29uR2VvbWV0cnkuX2V4dHJ1ZGVkSGVpZ2h0OwogICAgICAgIGNvbnN0IGV4dHJ1ZGUgPSBwb2x5Z29uR2VvbWV0cnkuX3BlclBvc2l0aW9uSGVpZ2h0RXh0cnVkZSB8fCAhTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oaGVpZ2h0LCBleHRydWRlZEhlaWdodCwgMCwgTWF0aF9kZWZhdWx0LkVQU0lMT04yKTsKICAgICAgICBsZXQgb2Zmc2V0VmFsdWU7CiAgICAgICAgbGV0IGk7CiAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb2x5Z29ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBnZW9tZXRyeUluc3RhbmNlID0gY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zRXh0cnVkZWQyKAogICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICBwb2x5Z29uc1tpXSwKICAgICAgICAgICAgICBtaW5EaXN0YW5jZSwKICAgICAgICAgICAgICBwZXJQb3NpdGlvbkhlaWdodCwKICAgICAgICAgICAgICBhcmNUeXBlCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkgPSBQb2x5Z29uR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0RXh0cnVkZWQoCiAgICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeSwKICAgICAgICAgICAgICBoZWlnaHQsCiAgICAgICAgICAgICAgZXh0cnVkZWRIZWlnaHQsCiAgICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICAgIHBlclBvc2l0aW9uSGVpZ2h0CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocG9seWdvbkdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICAgICAgY29uc3Qgc2l6ZSA9IGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMzsKICAgICAgICAgICAgICBsZXQgb2Zmc2V0QXR0cmlidXRlID0gbmV3IFVpbnQ4QXJyYXkoc2l6ZSk7CiAgICAgICAgICAgICAgaWYgKHBvbHlnb25HZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICAgICAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwoMSwgMCwgc2l6ZSAvIDIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvZmZzZXRWYWx1ZSA9IHBvbHlnb25HZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZ2VvbWV0cnlJbnN0YW5jZS5nZW9tZXRyeS5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgICAgIHZhbHVlczogb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goZ2VvbWV0cnlJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb2x5Z29ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBnZW9tZXRyeUluc3RhbmNlID0gY3JlYXRlR2VvbWV0cnlGcm9tUG9zaXRpb25zMigKICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgcG9seWdvbnNbaV0sCiAgICAgICAgICAgICAgbWluRGlzdGFuY2UsCiAgICAgICAgICAgICAgcGVyUG9zaXRpb25IZWlnaHQsCiAgICAgICAgICAgICAgYXJjVHlwZQogICAgICAgICAgICApOwogICAgICAgICAgICBnZW9tZXRyeUluc3RhbmNlLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICAhcGVyUG9zaXRpb25IZWlnaHQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChwb2x5Z29uR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgICBjb25zdCBsZW5ndGggPSBnZW9tZXRyeUluc3RhbmNlLmdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aDsKICAgICAgICAgICAgICBvZmZzZXRWYWx1ZSA9IHBvbHlnb25HZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgICAgIGdlb21ldHJ5SW5zdGFuY2UuZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goZ2VvbWV0cnlJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGdlb21ldHJ5ID0gR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmNvbWJpbmVJbnN0YW5jZXMoZ2VvbWV0cmllcylbMF07CiAgICAgICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcygKICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlczogZ2VvbWV0cnkuYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXM6IGdlb21ldHJ5LmluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBnZW9tZXRyeS5wcmltaXRpdmVUeXBlLAogICAgICAgICAgYm91bmRpbmdTcGhlcmUsCiAgICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHBvbHlnb25HZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IFBvbHlnb25PdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeShwb2x5Z29uR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHBvbHlnb25HZW9tZXRyeSA9IFBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2socG9seWdvbkdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcG9seWdvbkdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShwb2x5Z29uR2VvbWV0cnkuX2VsbGlwc29pZCk7CiAgICByZXR1cm4gUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHBvbHlnb25HZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1BvbHlnb25PdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0NvbG9yLmpzCiAgZnVuY3Rpb24gaHVlMnJnYihtMSwgbTIsIGgpIHsKICAgIGlmIChoIDwgMCkgewogICAgICBoICs9IDE7CiAgICB9CiAgICBpZiAoaCA+IDEpIHsKICAgICAgaCAtPSAxOwogICAgfQogICAgaWYgKGggKiA2IDwgMSkgewogICAgICByZXR1cm4gbTEgKyAobTIgLSBtMSkgKiA2ICogaDsKICAgIH0KICAgIGlmIChoICogMiA8IDEpIHsKICAgICAgcmV0dXJuIG0yOwogICAgfQogICAgaWYgKGggKiAzIDwgMikgewogICAgICByZXR1cm4gbTEgKyAobTIgLSBtMSkgKiAoMiAvIDMgLSBoKSAqIDY7CiAgICB9CiAgICByZXR1cm4gbTE7CiAgfQogIGZ1bmN0aW9uIENvbG9yKHJlZCwgZ3JlZW4sIGJsdWUsIGFscGhhKSB7CiAgICB0aGlzLnJlZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHJlZCwgMSk7CiAgICB0aGlzLmdyZWVuID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZ3JlZW4sIDEpOwogICAgdGhpcy5ibHVlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoYmx1ZSwgMSk7CiAgICB0aGlzLmFscGhhID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoYWxwaGEsIDEpOwogIH0KICB2YXIgc2NyYXRjaEFycmF5QnVmZmVyLCBzY3JhdGNoVWludDMyQXJyYXksIHNjcmF0Y2hVaW50OEFycmF5LCByZ2JhTWF0Y2hlciwgcnJnZ2JiYWFNYXRjaGVyLCByZ2JQYXJlbnRoZXNlc01hdGNoZXIsIGhzbFBhcmVudGhlc2VzTWF0Y2hlciwgQ29sb3JfZGVmYXVsdDsKICB2YXIgaW5pdF9Db2xvciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvQ29sb3IuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0ZlYXR1cmVEZXRlY3Rpb24oKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIENvbG9yLmZyb21DYXJ0ZXNpYW40ID0gZnVuY3Rpb24oY2FydGVzaWFuMTEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY2FydGVzaWFuIiwgY2FydGVzaWFuMTEpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ29sb3IoY2FydGVzaWFuMTEueCwgY2FydGVzaWFuMTEueSwgY2FydGVzaWFuMTEueiwgY2FydGVzaWFuMTEudyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5yZWQgPSBjYXJ0ZXNpYW4xMS54OwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGNhcnRlc2lhbjExLnk7CiAgICAgICAgcmVzdWx0LmJsdWUgPSBjYXJ0ZXNpYW4xMS56OwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGNhcnRlc2lhbjExLnc7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IuZnJvbUJ5dGVzID0gZnVuY3Rpb24ocmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEsIHJlc3VsdCkgewogICAgICAgIHJlZCA9IENvbG9yLmJ5dGVUb0Zsb2F0KGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHJlZCwgMjU1KSk7CiAgICAgICAgZ3JlZW4gPSBDb2xvci5ieXRlVG9GbG9hdChkZWZhdWx0VmFsdWVfZGVmYXVsdChncmVlbiwgMjU1KSk7CiAgICAgICAgYmx1ZSA9IENvbG9yLmJ5dGVUb0Zsb2F0KGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGJsdWUsIDI1NSkpOwogICAgICAgIGFscGhhID0gQ29sb3IuYnl0ZVRvRmxvYXQoZGVmYXVsdFZhbHVlX2RlZmF1bHQoYWxwaGEsIDI1NSkpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ29sb3IocmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucmVkID0gcmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBhbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5mcm9tQWxwaGEgPSBmdW5jdGlvbihjb2xvciwgYWxwaGEsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY29sb3IiLCBjb2xvcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJhbHBoYSIsIGFscGhhKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENvbG9yKGNvbG9yLnJlZCwgY29sb3IuZ3JlZW4sIGNvbG9yLmJsdWUsIGFscGhhKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnJlZCA9IGNvbG9yLnJlZDsKICAgICAgICByZXN1bHQuZ3JlZW4gPSBjb2xvci5ncmVlbjsKICAgICAgICByZXN1bHQuYmx1ZSA9IGNvbG9yLmJsdWU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgaWYgKEZlYXR1cmVEZXRlY3Rpb25fZGVmYXVsdC5zdXBwb3J0c1R5cGVkQXJyYXlzKCkpIHsKICAgICAgICBzY3JhdGNoQXJyYXlCdWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoNCk7CiAgICAgICAgc2NyYXRjaFVpbnQzMkFycmF5ID0gbmV3IFVpbnQzMkFycmF5KHNjcmF0Y2hBcnJheUJ1ZmZlcik7CiAgICAgICAgc2NyYXRjaFVpbnQ4QXJyYXkgPSBuZXcgVWludDhBcnJheShzY3JhdGNoQXJyYXlCdWZmZXIpOwogICAgICB9CiAgICAgIENvbG9yLmZyb21SZ2JhID0gZnVuY3Rpb24ocmdiYSwgcmVzdWx0KSB7CiAgICAgICAgc2NyYXRjaFVpbnQzMkFycmF5WzBdID0gcmdiYTsKICAgICAgICByZXR1cm4gQ29sb3IuZnJvbUJ5dGVzKAogICAgICAgICAgc2NyYXRjaFVpbnQ4QXJyYXlbMF0sCiAgICAgICAgICBzY3JhdGNoVWludDhBcnJheVsxXSwKICAgICAgICAgIHNjcmF0Y2hVaW50OEFycmF5WzJdLAogICAgICAgICAgc2NyYXRjaFVpbnQ4QXJyYXlbM10sCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBDb2xvci5mcm9tSHNsID0gZnVuY3Rpb24oaHVlLCBzYXR1cmF0aW9uLCBsaWdodG5lc3MsIGFscGhhLCByZXN1bHQpIHsKICAgICAgICBodWUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChodWUsIDApICUgMTsKICAgICAgICBzYXR1cmF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc2F0dXJhdGlvbiwgMCk7CiAgICAgICAgbGlnaHRuZXNzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobGlnaHRuZXNzLCAwKTsKICAgICAgICBhbHBoYSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KGFscGhhLCAxKTsKICAgICAgICBsZXQgcmVkID0gbGlnaHRuZXNzOwogICAgICAgIGxldCBncmVlbiA9IGxpZ2h0bmVzczsKICAgICAgICBsZXQgYmx1ZSA9IGxpZ2h0bmVzczsKICAgICAgICBpZiAoc2F0dXJhdGlvbiAhPT0gMCkgewogICAgICAgICAgbGV0IG0yOwogICAgICAgICAgaWYgKGxpZ2h0bmVzcyA8IDAuNSkgewogICAgICAgICAgICBtMiA9IGxpZ2h0bmVzcyAqICgxICsgc2F0dXJhdGlvbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtMiA9IGxpZ2h0bmVzcyArIHNhdHVyYXRpb24gLSBsaWdodG5lc3MgKiBzYXR1cmF0aW9uOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgbTEgPSAyICogbGlnaHRuZXNzIC0gbTI7CiAgICAgICAgICByZWQgPSBodWUycmdiKG0xLCBtMiwgaHVlICsgMSAvIDMpOwogICAgICAgICAgZ3JlZW4gPSBodWUycmdiKG0xLCBtMiwgaHVlKTsKICAgICAgICAgIGJsdWUgPSBodWUycmdiKG0xLCBtMiwgaHVlIC0gMSAvIDMpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENvbG9yKHJlZCwgZ3JlZW4sIGJsdWUsIGFscGhhKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnJlZCA9IHJlZDsKICAgICAgICByZXN1bHQuZ3JlZW4gPSBncmVlbjsKICAgICAgICByZXN1bHQuYmx1ZSA9IGJsdWU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IuZnJvbVJhbmRvbSA9IGZ1bmN0aW9uKG9wdGlvbnMsIHJlc3VsdCkgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGxldCByZWQgPSBvcHRpb25zLnJlZDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZWQpKSB7CiAgICAgICAgICBjb25zdCBtaW5pbXVtUmVkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5taW5pbXVtUmVkLCAwKTsKICAgICAgICAgIGNvbnN0IG1heGltdW1SZWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1heGltdW1SZWQsIDEpOwogICAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoIm1pbmltdW1SZWQiLCBtaW5pbXVtUmVkLCBtYXhpbXVtUmVkKTsKICAgICAgICAgIHJlZCA9IG1pbmltdW1SZWQgKyBNYXRoX2RlZmF1bHQubmV4dFJhbmRvbU51bWJlcigpICogKG1heGltdW1SZWQgLSBtaW5pbXVtUmVkKTsKICAgICAgICB9CiAgICAgICAgbGV0IGdyZWVuID0gb3B0aW9ucy5ncmVlbjsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChncmVlbikpIHsKICAgICAgICAgIGNvbnN0IG1pbmltdW1HcmVlbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWluaW11bUdyZWVuLCAwKTsKICAgICAgICAgIGNvbnN0IG1heGltdW1HcmVlbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWF4aW11bUdyZWVuLCAxKTsKICAgICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5sZXNzVGhhbk9yRXF1YWxzKAogICAgICAgICAgICAibWluaW11bUdyZWVuIiwKICAgICAgICAgICAgbWluaW11bUdyZWVuLAogICAgICAgICAgICBtYXhpbXVtR3JlZW4KICAgICAgICAgICk7CiAgICAgICAgICBncmVlbiA9IG1pbmltdW1HcmVlbiArIE1hdGhfZGVmYXVsdC5uZXh0UmFuZG9tTnVtYmVyKCkgKiAobWF4aW11bUdyZWVuIC0gbWluaW11bUdyZWVuKTsKICAgICAgICB9CiAgICAgICAgbGV0IGJsdWUgPSBvcHRpb25zLmJsdWU7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYmx1ZSkpIHsKICAgICAgICAgIGNvbnN0IG1pbmltdW1CbHVlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5taW5pbXVtQmx1ZSwgMCk7CiAgICAgICAgICBjb25zdCBtYXhpbXVtQmx1ZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMubWF4aW11bUJsdWUsIDEpOwogICAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyLmxlc3NUaGFuT3JFcXVhbHMoCiAgICAgICAgICAgICJtaW5pbXVtQmx1ZSIsCiAgICAgICAgICAgIG1pbmltdW1CbHVlLAogICAgICAgICAgICBtYXhpbXVtQmx1ZQogICAgICAgICAgKTsKICAgICAgICAgIGJsdWUgPSBtaW5pbXVtQmx1ZSArIE1hdGhfZGVmYXVsdC5uZXh0UmFuZG9tTnVtYmVyKCkgKiAobWF4aW11bUJsdWUgLSBtaW5pbXVtQmx1ZSk7CiAgICAgICAgfQogICAgICAgIGxldCBhbHBoYSA9IG9wdGlvbnMuYWxwaGE7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYWxwaGEpKSB7CiAgICAgICAgICBjb25zdCBtaW5pbXVtQWxwaGEgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1pbmltdW1BbHBoYSwgMCk7CiAgICAgICAgICBjb25zdCBtYXhpbXVtQWxwaGEgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLm1heGltdW1BbHBoYSwgMSk7CiAgICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIubGVzc1RoYW5PckVxdWFscygKICAgICAgICAgICAgIm1pbnVtdW1BbHBoYSIsCiAgICAgICAgICAgIG1pbmltdW1BbHBoYSwKICAgICAgICAgICAgbWF4aW11bUFscGhhCiAgICAgICAgICApOwogICAgICAgICAgYWxwaGEgPSBtaW5pbXVtQWxwaGEgKyBNYXRoX2RlZmF1bHQubmV4dFJhbmRvbU51bWJlcigpICogKG1heGltdW1BbHBoYSAtIG1pbmltdW1BbHBoYSk7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJldHVybiBuZXcgQ29sb3IocmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucmVkID0gcmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBhbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICByZ2JhTWF0Y2hlciA9IC9eIyhbMC05YS1mXSkoWzAtOWEtZl0pKFswLTlhLWZdKShbMC05YS1mXSk/JC9pOwogICAgICBycmdnYmJhYU1hdGNoZXIgPSAvXiMoWzAtOWEtZl17Mn0pKFswLTlhLWZdezJ9KShbMC05YS1mXXsyfSkoWzAtOWEtZl17Mn0pPyQvaTsKICAgICAgcmdiUGFyZW50aGVzZXNNYXRjaGVyID0gL15yZ2JhP1xzKlwoXHMqKFswLTkuXSslPylccypbLFxzXStccyooWzAtOS5dKyU/KVxzKlssXHNdK1xzKihbMC05Ll0rJT8pKD86XHMqWyxccy9dK1xzKihbMC05Ll0rKSk/XHMqXCkkL2k7CiAgICAgIGhzbFBhcmVudGhlc2VzTWF0Y2hlciA9IC9eaHNsYT9ccypcKFxzKihbMC05Ll0rKVxzKlssXHNdK1xzKihbMC05Ll0rJSlccypbLFxzXStccyooWzAtOS5dKyUpKD86XHMqWyxccy9dK1xzKihbMC05Ll0rKSk/XHMqXCkkL2k7CiAgICAgIENvbG9yLmZyb21Dc3NDb2xvclN0cmluZyA9IGZ1bmN0aW9uKGNvbG9yLCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5zdHJpbmcoImNvbG9yIiwgY29sb3IpOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDb2xvcigpOwogICAgICAgIH0KICAgICAgICBjb2xvciA9IGNvbG9yLnRyaW0oKTsKICAgICAgICBjb25zdCBuYW1lZENvbG9yID0gQ29sb3JbY29sb3IudG9VcHBlckNhc2UoKV07CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChuYW1lZENvbG9yKSkgewogICAgICAgICAgQ29sb3IuY2xvbmUobmFtZWRDb2xvciwgcmVzdWx0KTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGxldCBtYXRjaGVzID0gcmdiYU1hdGNoZXIuZXhlYyhjb2xvcik7CiAgICAgICAgaWYgKG1hdGNoZXMgIT09IG51bGwpIHsKICAgICAgICAgIHJlc3VsdC5yZWQgPSBwYXJzZUludChtYXRjaGVzWzFdLCAxNikgLyAxNTsKICAgICAgICAgIHJlc3VsdC5ncmVlbiA9IHBhcnNlSW50KG1hdGNoZXNbMl0sIDE2KSAvIDE1OwogICAgICAgICAgcmVzdWx0LmJsdWUgPSBwYXJzZUludChtYXRjaGVzWzNdLCAxNikgLyAxNTsKICAgICAgICAgIHJlc3VsdC5hbHBoYSA9IHBhcnNlSW50KGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG1hdGNoZXNbNF0sICJmIiksIDE2KSAvIDE1OwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgbWF0Y2hlcyA9IHJyZ2diYmFhTWF0Y2hlci5leGVjKGNvbG9yKTsKICAgICAgICBpZiAobWF0Y2hlcyAhPT0gbnVsbCkgewogICAgICAgICAgcmVzdWx0LnJlZCA9IHBhcnNlSW50KG1hdGNoZXNbMV0sIDE2KSAvIDI1NTsKICAgICAgICAgIHJlc3VsdC5ncmVlbiA9IHBhcnNlSW50KG1hdGNoZXNbMl0sIDE2KSAvIDI1NTsKICAgICAgICAgIHJlc3VsdC5ibHVlID0gcGFyc2VJbnQobWF0Y2hlc1szXSwgMTYpIC8gMjU1OwogICAgICAgICAgcmVzdWx0LmFscGhhID0gcGFyc2VJbnQoZGVmYXVsdFZhbHVlX2RlZmF1bHQobWF0Y2hlc1s0XSwgImZmIiksIDE2KSAvIDI1NTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIG1hdGNoZXMgPSByZ2JQYXJlbnRoZXNlc01hdGNoZXIuZXhlYyhjb2xvcik7CiAgICAgICAgaWYgKG1hdGNoZXMgIT09IG51bGwpIHsKICAgICAgICAgIHJlc3VsdC5yZWQgPSBwYXJzZUZsb2F0KG1hdGNoZXNbMV0pIC8gKCIlIiA9PT0gbWF0Y2hlc1sxXS5zdWJzdHIoLTEpID8gMTAwIDogMjU1KTsKICAgICAgICAgIHJlc3VsdC5ncmVlbiA9IHBhcnNlRmxvYXQobWF0Y2hlc1syXSkgLyAoIiUiID09PSBtYXRjaGVzWzJdLnN1YnN0cigtMSkgPyAxMDAgOiAyNTUpOwogICAgICAgICAgcmVzdWx0LmJsdWUgPSBwYXJzZUZsb2F0KG1hdGNoZXNbM10pIC8gKCIlIiA9PT0gbWF0Y2hlc1szXS5zdWJzdHIoLTEpID8gMTAwIDogMjU1KTsKICAgICAgICAgIHJlc3VsdC5hbHBoYSA9IHBhcnNlRmxvYXQoZGVmYXVsdFZhbHVlX2RlZmF1bHQobWF0Y2hlc1s0XSwgIjEuMCIpKTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIG1hdGNoZXMgPSBoc2xQYXJlbnRoZXNlc01hdGNoZXIuZXhlYyhjb2xvcik7CiAgICAgICAgaWYgKG1hdGNoZXMgIT09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBDb2xvci5mcm9tSHNsKAogICAgICAgICAgICBwYXJzZUZsb2F0KG1hdGNoZXNbMV0pIC8gMzYwLAogICAgICAgICAgICBwYXJzZUZsb2F0KG1hdGNoZXNbMl0pIC8gMTAwLAogICAgICAgICAgICBwYXJzZUZsb2F0KG1hdGNoZXNbM10pIC8gMTAwLAogICAgICAgICAgICBwYXJzZUZsb2F0KGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG1hdGNoZXNbNF0sICIxLjAiKSksCiAgICAgICAgICAgIHJlc3VsdAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gdm9pZCAwOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLnBhY2tlZExlbmd0aCA9IDQ7CiAgICAgIENvbG9yLnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInZhbHVlIiwgdmFsdWUpOwogICAgICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgiYXJyYXkiLCBhcnJheSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5yZWQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLmdyZWVuOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5ibHVlOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gdmFsdWUuYWxwaGE7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBDb2xvci51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENvbG9yKCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5yZWQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgcmVzdWx0LmJsdWUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLmJ5dGVUb0Zsb2F0ID0gZnVuY3Rpb24obnVtYmVyKSB7CiAgICAgICAgcmV0dXJuIG51bWJlciAvIDI1NTsKICAgICAgfTsKICAgICAgQ29sb3IuZmxvYXRUb0J5dGUgPSBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICByZXR1cm4gbnVtYmVyID09PSAxID8gMjU1IDogbnVtYmVyICogMjU2IHwgMDsKICAgICAgfTsKICAgICAgQ29sb3IuY2xvbmUgPSBmdW5jdGlvbihjb2xvciwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29sb3IpKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IENvbG9yKGNvbG9yLnJlZCwgY29sb3IuZ3JlZW4sIGNvbG9yLmJsdWUsIGNvbG9yLmFscGhhKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnJlZCA9IGNvbG9yLnJlZDsKICAgICAgICByZXN1bHQuZ3JlZW4gPSBjb2xvci5ncmVlbjsKICAgICAgICByZXN1bHQuYmx1ZSA9IGNvbG9yLmJsdWU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gY29sb3IuYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IuZXF1YWxzID0gZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgLy8KICAgICAgICBkZWZpbmVkX2RlZmF1bHQobGVmdCkgJiYgLy8KICAgICAgICBkZWZpbmVkX2RlZmF1bHQocmlnaHQpICYmIC8vCiAgICAgICAgbGVmdC5yZWQgPT09IHJpZ2h0LnJlZCAmJiAvLwogICAgICAgIGxlZnQuZ3JlZW4gPT09IHJpZ2h0LmdyZWVuICYmIC8vCiAgICAgICAgbGVmdC5ibHVlID09PSByaWdodC5ibHVlICYmIC8vCiAgICAgICAgbGVmdC5hbHBoYSA9PT0gcmlnaHQuYWxwaGE7CiAgICAgIH07CiAgICAgIENvbG9yLmVxdWFsc0FycmF5ID0gZnVuY3Rpb24oY29sb3IsIGFycmF5LCBvZmZzZXQpIHsKICAgICAgICByZXR1cm4gY29sb3IucmVkID09PSBhcnJheVtvZmZzZXRdICYmIGNvbG9yLmdyZWVuID09PSBhcnJheVtvZmZzZXQgKyAxXSAmJiBjb2xvci5ibHVlID09PSBhcnJheVtvZmZzZXQgKyAyXSAmJiBjb2xvci5hbHBoYSA9PT0gYXJyYXlbb2Zmc2V0ICsgM107CiAgICAgIH07CiAgICAgIENvbG9yLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHJldHVybiBDb2xvci5jbG9uZSh0aGlzLCByZXN1bHQpOwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgICByZXR1cm4gQ29sb3IuZXF1YWxzKHRoaXMsIG90aGVyKTsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLmVxdWFsc0Vwc2lsb24gPSBmdW5jdGlvbihvdGhlciwgZXBzaWxvbikgewogICAgICAgIHJldHVybiB0aGlzID09PSBvdGhlciB8fCAvLwogICAgICAgIGRlZmluZWRfZGVmYXVsdChvdGhlcikgJiYgLy8KICAgICAgICBNYXRoLmFicyh0aGlzLnJlZCAtIG90aGVyLnJlZCkgPD0gZXBzaWxvbiAmJiAvLwogICAgICAgIE1hdGguYWJzKHRoaXMuZ3JlZW4gLSBvdGhlci5ncmVlbikgPD0gZXBzaWxvbiAmJiAvLwogICAgICAgIE1hdGguYWJzKHRoaXMuYmx1ZSAtIG90aGVyLmJsdWUpIDw9IGVwc2lsb24gJiYgLy8KICAgICAgICBNYXRoLmFicyh0aGlzLmFscGhhIC0gb3RoZXIuYWxwaGEpIDw9IGVwc2lsb247CiAgICAgIH07CiAgICAgIENvbG9yLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBgKCR7dGhpcy5yZWR9LCAke3RoaXMuZ3JlZW59LCAke3RoaXMuYmx1ZX0sICR7dGhpcy5hbHBoYX0pYDsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLnRvQ3NzQ29sb3JTdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICBjb25zdCByZWQgPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLnJlZCk7CiAgICAgICAgY29uc3QgZ3JlZW4gPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLmdyZWVuKTsKICAgICAgICBjb25zdCBibHVlID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5ibHVlKTsKICAgICAgICBpZiAodGhpcy5hbHBoYSA9PT0gMSkgewogICAgICAgICAgcmV0dXJuIGByZ2IoJHtyZWR9LCR7Z3JlZW59LCR7Ymx1ZX0pYDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGByZ2JhKCR7cmVkfSwke2dyZWVufSwke2JsdWV9LCR7dGhpcy5hbHBoYX0pYDsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLnRvQ3NzSGV4U3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbGV0IHIgPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLnJlZCkudG9TdHJpbmcoMTYpOwogICAgICAgIGlmIChyLmxlbmd0aCA8IDIpIHsKICAgICAgICAgIHIgPSBgMCR7cn1gOwogICAgICAgIH0KICAgICAgICBsZXQgZyA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuZ3JlZW4pLnRvU3RyaW5nKDE2KTsKICAgICAgICBpZiAoZy5sZW5ndGggPCAyKSB7CiAgICAgICAgICBnID0gYDAke2d9YDsKICAgICAgICB9CiAgICAgICAgbGV0IGIgPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLmJsdWUpLnRvU3RyaW5nKDE2KTsKICAgICAgICBpZiAoYi5sZW5ndGggPCAyKSB7CiAgICAgICAgICBiID0gYDAke2J9YDsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuYWxwaGEgPCAxKSB7CiAgICAgICAgICBsZXQgaGV4QWxwaGEgPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLmFscGhhKS50b1N0cmluZygxNik7CiAgICAgICAgICBpZiAoaGV4QWxwaGEubGVuZ3RoIDwgMikgewogICAgICAgICAgICBoZXhBbHBoYSA9IGAwJHtoZXhBbHBoYX1gOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGAjJHtyfSR7Z30ke2J9JHtoZXhBbHBoYX1gOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYCMke3J9JHtnfSR7Yn1gOwogICAgICB9OwogICAgICBDb2xvci5wcm90b3R5cGUudG9CeXRlcyA9IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIGNvbnN0IHJlZCA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMucmVkKTsKICAgICAgICBjb25zdCBncmVlbiA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuZ3JlZW4pOwogICAgICAgIGNvbnN0IGJsdWUgPSBDb2xvci5mbG9hdFRvQnl0ZSh0aGlzLmJsdWUpOwogICAgICAgIGNvbnN0IGFscGhhID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5hbHBoYSk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIFtyZWQsIGdyZWVuLCBibHVlLCBhbHBoYV07CiAgICAgICAgfQogICAgICAgIHJlc3VsdFswXSA9IHJlZDsKICAgICAgICByZXN1bHRbMV0gPSBncmVlbjsKICAgICAgICByZXN1bHRbMl0gPSBibHVlOwogICAgICAgIHJlc3VsdFszXSA9IGFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLnByb3RvdHlwZS50b1JnYmEgPSBmdW5jdGlvbigpIHsKICAgICAgICBzY3JhdGNoVWludDhBcnJheVswXSA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMucmVkKTsKICAgICAgICBzY3JhdGNoVWludDhBcnJheVsxXSA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuZ3JlZW4pOwogICAgICAgIHNjcmF0Y2hVaW50OEFycmF5WzJdID0gQ29sb3IuZmxvYXRUb0J5dGUodGhpcy5ibHVlKTsKICAgICAgICBzY3JhdGNoVWludDhBcnJheVszXSA9IENvbG9yLmZsb2F0VG9CeXRlKHRoaXMuYWxwaGEpOwogICAgICAgIHJldHVybiBzY3JhdGNoVWludDMyQXJyYXlbMF07CiAgICAgIH07CiAgICAgIENvbG9yLnByb3RvdHlwZS5icmlnaHRlbiA9IGZ1bmN0aW9uKG1hZ25pdHVkZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJtYWduaXR1ZGUiLCBtYWduaXR1ZGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJtYWduaXR1ZGUiLCBtYWduaXR1ZGUsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBtYWduaXR1ZGUgPSAxIC0gbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC5yZWQgPSAxIC0gKDEgLSB0aGlzLnJlZCkgKiBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gMSAtICgxIC0gdGhpcy5ncmVlbikgKiBtYWduaXR1ZGU7CiAgICAgICAgcmVzdWx0LmJsdWUgPSAxIC0gKDEgLSB0aGlzLmJsdWUpICogbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IHRoaXMuYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLmRhcmtlbiA9IGZ1bmN0aW9uKG1hZ25pdHVkZSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJtYWduaXR1ZGUiLCBtYWduaXR1ZGUpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlci5ncmVhdGVyVGhhbk9yRXF1YWxzKCJtYWduaXR1ZGUiLCBtYWduaXR1ZGUsIDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICBtYWduaXR1ZGUgPSAxIC0gbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC5yZWQgPSB0aGlzLnJlZCAqIG1hZ25pdHVkZTsKICAgICAgICByZXN1bHQuZ3JlZW4gPSB0aGlzLmdyZWVuICogbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC5ibHVlID0gdGhpcy5ibHVlICogbWFnbml0dWRlOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IHRoaXMuYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IucHJvdG90eXBlLndpdGhBbHBoYSA9IGZ1bmN0aW9uKGFscGhhLCByZXN1bHQpIHsKICAgICAgICByZXR1cm4gQ29sb3IuZnJvbUFscGhhKHRoaXMsIGFscGhhLCByZXN1bHQpOwogICAgICB9OwogICAgICBDb2xvci5hZGQgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnJlZCA9IGxlZnQucmVkICsgcmlnaHQucmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGxlZnQuZ3JlZW4gKyByaWdodC5ncmVlbjsKICAgICAgICByZXN1bHQuYmx1ZSA9IGxlZnQuYmx1ZSArIHJpZ2h0LmJsdWU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gbGVmdC5hbHBoYSArIHJpZ2h0LmFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLnN1YnRyYWN0ID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC5yZWQgPSBsZWZ0LnJlZCAtIHJpZ2h0LnJlZDsKICAgICAgICByZXN1bHQuZ3JlZW4gPSBsZWZ0LmdyZWVuIC0gcmlnaHQuZ3JlZW47CiAgICAgICAgcmVzdWx0LmJsdWUgPSBsZWZ0LmJsdWUgLSByaWdodC5ibHVlOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGxlZnQuYWxwaGEgLSByaWdodC5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5tdWx0aXBseSA9IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImxlZnQiLCBsZWZ0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJpZ2h0IiwgcmlnaHQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQucmVkID0gbGVmdC5yZWQgKiByaWdodC5yZWQ7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gbGVmdC5ncmVlbiAqIHJpZ2h0LmdyZWVuOwogICAgICAgIHJlc3VsdC5ibHVlID0gbGVmdC5ibHVlICogcmlnaHQuYmx1ZTsKICAgICAgICByZXN1bHQuYWxwaGEgPSBsZWZ0LmFscGhhICogcmlnaHQuYWxwaGE7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IuZGl2aWRlID0gZnVuY3Rpb24obGVmdCwgcmlnaHQsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgibGVmdCIsIGxlZnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmlnaHQiLCByaWdodCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZXN1bHQiLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC5yZWQgPSBsZWZ0LnJlZCAvIHJpZ2h0LnJlZDsKICAgICAgICByZXN1bHQuZ3JlZW4gPSBsZWZ0LmdyZWVuIC8gcmlnaHQuZ3JlZW47CiAgICAgICAgcmVzdWx0LmJsdWUgPSBsZWZ0LmJsdWUgLyByaWdodC5ibHVlOwogICAgICAgIHJlc3VsdC5hbHBoYSA9IGxlZnQuYWxwaGEgLyByaWdodC5hbHBoYTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5tb2QgPSBmdW5jdGlvbihsZWZ0LCByaWdodCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJsZWZ0IiwgbGVmdCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyaWdodCIsIHJpZ2h0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnJlZCA9IGxlZnQucmVkICUgcmlnaHQucmVkOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGxlZnQuZ3JlZW4gJSByaWdodC5ncmVlbjsKICAgICAgICByZXN1bHQuYmx1ZSA9IGxlZnQuYmx1ZSAlIHJpZ2h0LmJsdWU7CiAgICAgICAgcmVzdWx0LmFscGhhID0gbGVmdC5hbHBoYSAlIHJpZ2h0LmFscGhhOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIENvbG9yLmxlcnAgPSBmdW5jdGlvbihzdGFydCwgZW5kLCB0LCByZXN1bHQpIHsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInN0YXJ0Iiwgc3RhcnQpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiZW5kIiwgZW5kKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInQiLCB0KTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoInJlc3VsdCIsIHJlc3VsdCk7CiAgICAgICAgcmVzdWx0LnJlZCA9IE1hdGhfZGVmYXVsdC5sZXJwKHN0YXJ0LnJlZCwgZW5kLnJlZCwgdCk7CiAgICAgICAgcmVzdWx0LmdyZWVuID0gTWF0aF9kZWZhdWx0LmxlcnAoc3RhcnQuZ3JlZW4sIGVuZC5ncmVlbiwgdCk7CiAgICAgICAgcmVzdWx0LmJsdWUgPSBNYXRoX2RlZmF1bHQubGVycChzdGFydC5ibHVlLCBlbmQuYmx1ZSwgdCk7CiAgICAgICAgcmVzdWx0LmFscGhhID0gTWF0aF9kZWZhdWx0LmxlcnAoc3RhcnQuYWxwaGEsIGVuZC5hbHBoYSwgdCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgQ29sb3IubXVsdGlwbHlCeVNjYWxhciA9IGZ1bmN0aW9uKGNvbG9yLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY29sb3IiLCBjb2xvcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQucmVkID0gY29sb3IucmVkICogc2NhbGFyOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGNvbG9yLmdyZWVuICogc2NhbGFyOwogICAgICAgIHJlc3VsdC5ibHVlID0gY29sb3IuYmx1ZSAqIHNjYWxhcjsKICAgICAgICByZXN1bHQuYWxwaGEgPSBjb2xvci5hbHBoYSAqIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5kaXZpZGVCeVNjYWxhciA9IGZ1bmN0aW9uKGNvbG9yLCBzY2FsYXIsIHJlc3VsdCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgiY29sb3IiLCBjb2xvcik7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzY2FsYXIiLCBzY2FsYXIpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVzdWx0IiwgcmVzdWx0KTsKICAgICAgICByZXN1bHQucmVkID0gY29sb3IucmVkIC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC5ncmVlbiA9IGNvbG9yLmdyZWVuIC8gc2NhbGFyOwogICAgICAgIHJlc3VsdC5ibHVlID0gY29sb3IuYmx1ZSAvIHNjYWxhcjsKICAgICAgICByZXN1bHQuYWxwaGEgPSBjb2xvci5hbHBoYSAvIHNjYWxhcjsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBDb2xvci5BTElDRUJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0YwRjhGRiIpKTsKICAgICAgQ29sb3IuQU5USVFVRVdISVRFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGQUVCRDciKSk7CiAgICAgIENvbG9yLkFRVUEgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwRkZGRiIpKTsKICAgICAgQ29sb3IuQVFVQU1BUklORSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjN0ZGRkQ0IikpOwogICAgICBDb2xvci5BWlVSRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRjBGRkZGIikpOwogICAgICBDb2xvci5CRUlHRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRjVGNURDIikpOwogICAgICBDb2xvci5CSVNRVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGRTRDNCIpKTsKICAgICAgQ29sb3IuQkxBQ0sgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwMDAwMCIpKTsKICAgICAgQ29sb3IuQkxBTkNIRURBTE1PTkQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGRUJDRCIpKTsKICAgICAgQ29sb3IuQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDAwMEZGIikpOwogICAgICBDb2xvci5CTFVFVklPTEVUID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM4QTJCRTIiKSk7CiAgICAgIENvbG9yLkJST1dOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNBNTJBMkEiKSk7CiAgICAgIENvbG9yLkJVUkxZV09PRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjREVCODg3IikpOwogICAgICBDb2xvci5DQURFVEJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzVGOUVBMCIpKTsKICAgICAgQ29sb3IuQ0hBUlRSRVVTRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjN0ZGRjAwIikpOwogICAgICBDb2xvci5DSE9DT0xBVEUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0QyNjkxRSIpKTsKICAgICAgQ29sb3IuQ09SQUwgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGN0Y1MCIpKTsKICAgICAgQ29sb3IuQ09STkZMT1dFUkJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzY0OTVFRCIpKTsKICAgICAgQ29sb3IuQ09STlNJTEsgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGRjhEQyIpKTsKICAgICAgQ29sb3IuQ1JJTVNPTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjREMxNDNDIikpOwogICAgICBDb2xvci5DWUFOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMwMEZGRkYiKSk7CiAgICAgIENvbG9yLkRBUktCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMwMDAwOEIiKSk7CiAgICAgIENvbG9yLkRBUktDWUFOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMwMDhCOEIiKSk7CiAgICAgIENvbG9yLkRBUktHT0xERU5ST0QgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0I4ODYwQiIpKTsKICAgICAgQ29sb3IuREFSS0dSQVkgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0E5QTlBOSIpKTsKICAgICAgQ29sb3IuREFSS0dSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMwMDY0MDAiKSk7CiAgICAgIENvbG9yLkRBUktHUkVZID0gQ29sb3IuREFSS0dSQVk7CiAgICAgIENvbG9yLkRBUktLSEFLSSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQkRCNzZCIikpOwogICAgICBDb2xvci5EQVJLTUFHRU5UQSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjOEIwMDhCIikpOwogICAgICBDb2xvci5EQVJLT0xJVkVHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjNTU2QjJGIikpOwogICAgICBDb2xvci5EQVJLT1JBTkdFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRjhDMDAiKSk7CiAgICAgIENvbG9yLkRBUktPUkNISUQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzk5MzJDQyIpKTsKICAgICAgQ29sb3IuREFSS1JFRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjOEIwMDAwIikpOwogICAgICBDb2xvci5EQVJLU0FMTU9OID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNFOTk2N0EiKSk7CiAgICAgIENvbG9yLkRBUktTRUFHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjOEZCQzhGIikpOwogICAgICBDb2xvci5EQVJLU0xBVEVCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM0ODNEOEIiKSk7CiAgICAgIENvbG9yLkRBUktTTEFURUdSQVkgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzJGNEY0RiIpKTsKICAgICAgQ29sb3IuREFSS1NMQVRFR1JFWSA9IENvbG9yLkRBUktTTEFURUdSQVk7CiAgICAgIENvbG9yLkRBUktUVVJRVU9JU0UgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwQ0VEMSIpKTsKICAgICAgQ29sb3IuREFSS1ZJT0xFVCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjOTQwMEQzIikpOwogICAgICBDb2xvci5ERUVQUElOSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkYxNDkzIikpOwogICAgICBDb2xvci5ERUVQU0tZQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMDBCRkZGIikpOwogICAgICBDb2xvci5ESU1HUkFZID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM2OTY5NjkiKSk7CiAgICAgIENvbG9yLkRJTUdSRVkgPSBDb2xvci5ESU1HUkFZOwogICAgICBDb2xvci5ET0RHRVJCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMxRTkwRkYiKSk7CiAgICAgIENvbG9yLkZJUkVCUklDSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQjIyMjIyIikpOwogICAgICBDb2xvci5GTE9SQUxXSElURSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGQUYwIikpOwogICAgICBDb2xvci5GT1JFU1RHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMjI4QjIyIikpOwogICAgICBDb2xvci5GVUNIU0lBID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRjAwRkYiKSk7CiAgICAgIENvbG9yLkdBSU5TQk9STyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRENEQ0RDIikpOwogICAgICBDb2xvci5HSE9TVFdISVRFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGOEY4RkYiKSk7CiAgICAgIENvbG9yLkdPTEQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGRDcwMCIpKTsKICAgICAgQ29sb3IuR09MREVOUk9EID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEQUE1MjAiKSk7CiAgICAgIENvbG9yLkdSQVkgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzgwODA4MCIpKTsKICAgICAgQ29sb3IuR1JFRU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwODAwMCIpKTsKICAgICAgQ29sb3IuR1JFRU5ZRUxMT1cgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0FERkYyRiIpKTsKICAgICAgQ29sb3IuR1JFWSA9IENvbG9yLkdSQVk7CiAgICAgIENvbG9yLkhPTkVZREVXID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGMEZGRjAiKSk7CiAgICAgIENvbG9yLkhPVFBJTksgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGNjlCNCIpKTsKICAgICAgQ29sb3IuSU5ESUFOUkVEID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNDRDVDNUMiKSk7CiAgICAgIENvbG9yLklORElHTyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjNEIwMDgyIikpOwogICAgICBDb2xvci5JVk9SWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGRkYwIikpOwogICAgICBDb2xvci5LSEFLSSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRjBFNjhDIikpOwogICAgICBDb2xvci5MQVZFTkRFUiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRTZFNkZBIikpOwogICAgICBDb2xvci5MQVZFTkRBUl9CTFVTSCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGMEY1IikpOwogICAgICBDb2xvci5MQVdOR1JFRU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzdDRkMwMCIpKTsKICAgICAgQ29sb3IuTEVNT05DSElGRk9OID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkZBQ0QiKSk7CiAgICAgIENvbG9yLkxJR0hUQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQUREOEU2IikpOwogICAgICBDb2xvci5MSUdIVENPUkFMID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGMDgwODAiKSk7CiAgICAgIENvbG9yLkxJR0hUQ1lBTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRTBGRkZGIikpOwogICAgICBDb2xvci5MSUdIVEdPTERFTlJPRFlFTExPVyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkFGQUQyIikpOwogICAgICBDb2xvci5MSUdIVEdSQVkgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0QzRDNEMyIpKTsKICAgICAgQ29sb3IuTElHSFRHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjOTBFRTkwIikpOwogICAgICBDb2xvci5MSUdIVEdSRVkgPSBDb2xvci5MSUdIVEdSQVk7CiAgICAgIENvbG9yLkxJR0hUUElOSyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZCNkMxIikpOwogICAgICBDb2xvci5MSUdIVFNFQUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMyMEIyQUEiKSk7CiAgICAgIENvbG9yLkxJR0hUU0tZQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjODdDRUZBIikpOwogICAgICBDb2xvci5MSUdIVFNMQVRFR1JBWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjNzc4ODk5IikpOwogICAgICBDb2xvci5MSUdIVFNMQVRFR1JFWSA9IENvbG9yLkxJR0hUU0xBVEVHUkFZOwogICAgICBDb2xvci5MSUdIVFNURUVMQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQjBDNERFIikpOwogICAgICBDb2xvci5MSUdIVFlFTExPVyA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGRkUwIikpOwogICAgICBDb2xvci5MSU1FID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMwMEZGMDAiKSk7CiAgICAgIENvbG9yLkxJTUVHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMzJDRDMyIikpOwogICAgICBDb2xvci5MSU5FTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkFGMEU2IikpOwogICAgICBDb2xvci5NQUdFTlRBID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRjAwRkYiKSk7CiAgICAgIENvbG9yLk1BUk9PTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjODAwMDAwIikpOwogICAgICBDb2xvci5NRURJVU1BUVVBTUFSSU5FID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM2NkNEQUEiKSk7CiAgICAgIENvbG9yLk1FRElVTUJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwMDBDRCIpKTsKICAgICAgQ29sb3IuTUVESVVNT1JDSElEID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNCQTU1RDMiKSk7CiAgICAgIENvbG9yLk1FRElVTVBVUlBMRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjOTM3MERCIikpOwogICAgICBDb2xvci5NRURJVU1TRUFHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjM0NCMzcxIikpOwogICAgICBDb2xvci5NRURJVU1TTEFURUJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzdCNjhFRSIpKTsKICAgICAgQ29sb3IuTUVESVVNU1BSSU5HR1JFRU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwRkE5QSIpKTsKICAgICAgQ29sb3IuTUVESVVNVFVSUVVPSVNFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM0OEQxQ0MiKSk7CiAgICAgIENvbG9yLk1FRElVTVZJT0xFVFJFRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjQzcxNTg1IikpOwogICAgICBDb2xvci5NSUROSUdIVEJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzE5MTk3MCIpKTsKICAgICAgQ29sb3IuTUlOVENSRUFNID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGNUZGRkEiKSk7CiAgICAgIENvbG9yLk1JU1RZUk9TRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZFNEUxIikpOwogICAgICBDb2xvci5NT0NDQVNJTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZFNEI1IikpOwogICAgICBDb2xvci5OQVZBSk9XSElURSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZERUFEIikpOwogICAgICBDb2xvci5OQVZZID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMwMDAwODAiKSk7CiAgICAgIENvbG9yLk9MRExBQ0UgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZERjVFNiIpKTsKICAgICAgQ29sb3IuT0xJVkUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzgwODAwMCIpKTsKICAgICAgQ29sb3IuT0xJVkVEUkFCID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM2QjhFMjMiKSk7CiAgICAgIENvbG9yLk9SQU5HRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZBNTAwIikpOwogICAgICBDb2xvci5PUkFOR0VSRUQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGNDUwMCIpKTsKICAgICAgQ29sb3IuT1JDSElEID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNEQTcwRDYiKSk7CiAgICAgIENvbG9yLlBBTEVHT0xERU5ST0QgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0VFRThBQSIpKTsKICAgICAgQ29sb3IuUEFMRUdSRUVOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM5OEZCOTgiKSk7CiAgICAgIENvbG9yLlBBTEVUVVJRVU9JU0UgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0FGRUVFRSIpKTsKICAgICAgQ29sb3IuUEFMRVZJT0xFVFJFRCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjREI3MDkzIikpOwogICAgICBDb2xvci5QQVBBWUFXSElQID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRkVGRDUiKSk7CiAgICAgIENvbG9yLlBFQUNIUFVGRiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZEQUI5IikpOwogICAgICBDb2xvci5QRVJVID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNDRDg1M0YiKSk7CiAgICAgIENvbG9yLlBJTksgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGQzBDQiIpKTsKICAgICAgQ29sb3IuUExVTSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRERBMEREIikpOwogICAgICBDb2xvci5QT1dERVJCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNCMEUwRTYiKSk7CiAgICAgIENvbG9yLlBVUlBMRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjODAwMDgwIikpOwogICAgICBDb2xvci5SRUQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGMDAwMCIpKTsKICAgICAgQ29sb3IuUk9TWUJST1dOID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNCQzhGOEYiKSk7CiAgICAgIENvbG9yLlJPWUFMQkxVRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjNDE2OUUxIikpOwogICAgICBDb2xvci5TQURETEVCUk9XTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjOEI0NTEzIikpOwogICAgICBDb2xvci5TQUxNT04gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZBODA3MiIpKTsKICAgICAgQ29sb3IuU0FORFlCUk9XTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRjRBNDYwIikpOwogICAgICBDb2xvci5TRUFHUkVFTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjMkU4QjU3IikpOwogICAgICBDb2xvci5TRUFTSEVMTCA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRkZGNUVFIikpOwogICAgICBDb2xvci5TSUVOTkEgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0EwNTIyRCIpKTsKICAgICAgQ29sb3IuU0lMVkVSID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNDMEMwQzAiKSk7CiAgICAgIENvbG9yLlNLWUJMVUUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzg3Q0VFQiIpKTsKICAgICAgQ29sb3IuU0xBVEVCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM2QTVBQ0QiKSk7CiAgICAgIENvbG9yLlNMQVRFR1JBWSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjNzA4MDkwIikpOwogICAgICBDb2xvci5TTEFURUdSRVkgPSBDb2xvci5TTEFURUdSQVk7CiAgICAgIENvbG9yLlNOT1cgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGRkFGQSIpKTsKICAgICAgQ29sb3IuU1BSSU5HR1JFRU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzAwRkY3RiIpKTsKICAgICAgQ29sb3IuU1RFRUxCTFVFID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiM0NjgyQjQiKSk7CiAgICAgIENvbG9yLlRBTiA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRDJCNDhDIikpOwogICAgICBDb2xvci5URUFMID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiMwMDgwODAiKSk7CiAgICAgIENvbG9yLlRISVNUTEUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0Q4QkZEOCIpKTsKICAgICAgQ29sb3IuVE9NQVRPID0gT2JqZWN0LmZyZWV6ZShDb2xvci5mcm9tQ3NzQ29sb3JTdHJpbmcoIiNGRjYzNDciKSk7CiAgICAgIENvbG9yLlRVUlFVT0lTRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjNDBFMEQwIikpOwogICAgICBDb2xvci5WSU9MRVQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0VFODJFRSIpKTsKICAgICAgQ29sb3IuV0hFQVQgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0Y1REVCMyIpKTsKICAgICAgQ29sb3IuV0hJVEUgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGRkZGRiIpKTsKICAgICAgQ29sb3IuV0hJVEVTTU9LRSA9IE9iamVjdC5mcmVlemUoQ29sb3IuZnJvbUNzc0NvbG9yU3RyaW5nKCIjRjVGNUY1IikpOwogICAgICBDb2xvci5ZRUxMT1cgPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiI0ZGRkYwMCIpKTsKICAgICAgQ29sb3IuWUVMTE9XR1JFRU4gPSBPYmplY3QuZnJlZXplKENvbG9yLmZyb21Dc3NDb2xvclN0cmluZygiIzlBQ0QzMiIpKTsKICAgICAgQ29sb3IuVFJBTlNQQVJFTlQgPSBPYmplY3QuZnJlZXplKG5ldyBDb2xvcigwLCAwLCAwLCAwKSk7CiAgICAgIENvbG9yX2RlZmF1bHQgPSBDb2xvcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BvbHlsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBpbnRlcnBvbGF0ZUNvbG9ycyhwMCwgcDEsIGNvbG9yMCwgY29sb3IxLCBudW1Qb2ludHMpIHsKICAgIGNvbnN0IGNvbG9ycyA9IHNjcmF0Y2hJbnRlcnBvbGF0ZUNvbG9yc0FycmF5OwogICAgY29sb3JzLmxlbmd0aCA9IG51bVBvaW50czsKICAgIGxldCBpOwogICAgY29uc3QgcjAgPSBjb2xvcjAucmVkOwogICAgY29uc3QgZzAgPSBjb2xvcjAuZ3JlZW47CiAgICBjb25zdCBiMCA9IGNvbG9yMC5ibHVlOwogICAgY29uc3QgYTAgPSBjb2xvcjAuYWxwaGE7CiAgICBjb25zdCByMSA9IGNvbG9yMS5yZWQ7CiAgICBjb25zdCBnMSA9IGNvbG9yMS5ncmVlbjsKICAgIGNvbnN0IGIxID0gY29sb3IxLmJsdWU7CiAgICBjb25zdCBhMSA9IGNvbG9yMS5hbHBoYTsKICAgIGlmIChDb2xvcl9kZWZhdWx0LmVxdWFscyhjb2xvcjAsIGNvbG9yMSkpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgICAgY29sb3JzW2ldID0gQ29sb3JfZGVmYXVsdC5jbG9uZShjb2xvcjApOwogICAgICB9CiAgICAgIHJldHVybiBjb2xvcnM7CiAgICB9CiAgICBjb25zdCByZWRQZXJWZXJ0ZXggPSAocjEgLSByMCkgLyBudW1Qb2ludHM7CiAgICBjb25zdCBncmVlblBlclZlcnRleCA9IChnMSAtIGcwKSAvIG51bVBvaW50czsKICAgIGNvbnN0IGJsdWVQZXJWZXJ0ZXggPSAoYjEgLSBiMCkgLyBudW1Qb2ludHM7CiAgICBjb25zdCBhbHBoYVBlclZlcnRleCA9IChhMSAtIGEwKSAvIG51bVBvaW50czsKICAgIGZvciAoaSA9IDA7IGkgPCBudW1Qb2ludHM7IGkrKykgewogICAgICBjb2xvcnNbaV0gPSBuZXcgQ29sb3JfZGVmYXVsdCgKICAgICAgICByMCArIGkgKiByZWRQZXJWZXJ0ZXgsCiAgICAgICAgZzAgKyBpICogZ3JlZW5QZXJWZXJ0ZXgsCiAgICAgICAgYjAgKyBpICogYmx1ZVBlclZlcnRleCwKICAgICAgICBhMCArIGkgKiBhbHBoYVBlclZlcnRleAogICAgICApOwogICAgfQogICAgcmV0dXJuIGNvbG9yczsKICB9CiAgZnVuY3Rpb24gUG9seWxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgY29uc3QgY29sb3JzID0gb3B0aW9ucy5jb2xvcnM7CiAgICBjb25zdCB3aWR0aCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMud2lkdGgsIDEpOwogICAgY29uc3QgY29sb3JzUGVyVmVydGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5jb2xvcnNQZXJWZXJ0ZXgsIGZhbHNlKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA8IDIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIkF0IGxlYXN0IHR3byBwb3NpdGlvbnMgYXJlIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKHR5cGVvZiB3aWR0aCAhPT0gIm51bWJlciIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIndpZHRoIG11c3QgYmUgYSBudW1iZXIiKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSAmJiAoY29sb3JzUGVyVmVydGV4ICYmIGNvbG9ycy5sZW5ndGggPCBwb3NpdGlvbnMubGVuZ3RoIHx8ICFjb2xvcnNQZXJWZXJ0ZXggJiYgY29sb3JzLmxlbmd0aCA8IHBvc2l0aW9ucy5sZW5ndGggLSAxKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiY29sb3JzIGhhcyBhbiBpbnZhbGlkIGxlbmd0aC4iKTsKICAgIH0KICAgIHRoaXMuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgIHRoaXMuX2NvbG9ycyA9IGNvbG9yczsKICAgIHRoaXMuX3dpZHRoID0gd2lkdGg7CiAgICB0aGlzLl9jb2xvcnNQZXJWZXJ0ZXggPSBjb2xvcnNQZXJWZXJ0ZXg7CiAgICB0aGlzLl92ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSgKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy52ZXJ0ZXhGb3JtYXQsIFZlcnRleEZvcm1hdF9kZWZhdWx0LkRFRkFVTFQpCiAgICApOwogICAgdGhpcy5fYXJjVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuYXJjVHlwZSwgQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KQogICAgKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlUG9seWxpbmVHZW9tZXRyeSI7CiAgICBsZXQgbnVtQ29tcG9uZW50cyA9IDEgKyBwb3NpdGlvbnMubGVuZ3RoICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIG51bUNvbXBvbmVudHMgKz0gZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykgPyAxICsgY29sb3JzLmxlbmd0aCAqIENvbG9yX2RlZmF1bHQucGFja2VkTGVuZ3RoIDogMTsKICAgIHRoaXMucGFja2VkTGVuZ3RoID0gbnVtQ29tcG9uZW50cyArIEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDQ7CiAgfQogIHZhciBzY3JhdGNoSW50ZXJwb2xhdGVDb2xvcnNBcnJheSwgc2NyYXRjaEVsbGlwc29pZDgsIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMCwgc2NyYXRjaE9wdGlvbnMxNiwgc2NyYXRjaENhcnRlc2lhbjM4LCBzY3JhdGNoUG9zaXRpb240LCBzY3JhdGNoUHJldlBvc2l0aW9uLCBzY3JhdGNoTmV4dFBvc2l0aW9uLCBQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUG9seWxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQXJjVHlwZSgpOwogICAgICBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcygpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbG9yKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlUeXBlKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9Qb2x5bGluZVBpcGVsaW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1ZlcnRleEZvcm1hdCgpOwogICAgICBzY3JhdGNoSW50ZXJwb2xhdGVDb2xvcnNBcnJheSA9IFtdOwogICAgICBQb2x5bGluZUdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdmFsdWUuX3Bvc2l0aW9uczsKICAgICAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29sb3JzID0gdmFsdWUuX2NvbG9yczsKICAgICAgICBsZW5ndGggPSBkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSA/IGNvbG9ycy5sZW5ndGggOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENvbG9yX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDb2xvcl9kZWZhdWx0LnBhY2soY29sb3JzW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2sodmFsdWUuX3ZlcnRleEZvcm1hdCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fd2lkdGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9jb2xvcnNQZXJWZXJ0ZXggPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2FyY1R5cGU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkOCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDEwID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTYgPSB7CiAgICAgICAgcG9zaXRpb25zOiB2b2lkIDAsCiAgICAgICAgY29sb3JzOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkOCwKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMCwKICAgICAgICB3aWR0aDogdm9pZCAwLAogICAgICAgIGNvbG9yc1BlclZlcnRleDogdm9pZCAwLAogICAgICAgIGFyY1R5cGU6IHZvaWQgMCwKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwCiAgICAgIH07CiAgICAgIFBvbHlsaW5lR2VvbWV0cnkudW5wYWNrID0gZnVuY3Rpb24oYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBsZXQgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgcG9zaXRpb25zW2ldID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgY29sb3JzID0gbGVuZ3RoID4gMCA/IG5ldyBBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDb2xvcl9kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgY29sb3JzW2ldID0gQ29sb3JfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQ4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MTAKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IHdpZHRoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBjb2xvcnNQZXJWZXJ0ZXggPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNi5wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE2LmNvbG9ycyA9IGNvbG9yczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTYud2lkdGggPSB3aWR0aDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTYuY29sb3JzUGVyVmVydGV4ID0gY29sb3JzUGVyVmVydGV4OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNi5hcmNUeXBlID0gYXJjVHlwZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTYuZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICAgIHJldHVybiBuZXcgUG9seWxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczE2KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9jb2xvcnMgPSBjb2xvcnM7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCwgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQpOwogICAgICAgIHJlc3VsdC5fd2lkdGggPSB3aWR0aDsKICAgICAgICByZXN1bHQuX2NvbG9yc1BlclZlcnRleCA9IGNvbG9yc1BlclZlcnRleDsKICAgICAgICByZXN1bHQuX2FyY1R5cGUgPSBhcmNUeXBlOwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBzY3JhdGNoQ2FydGVzaWFuMzggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQb3NpdGlvbjQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQcmV2UG9zaXRpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOZXh0UG9zaXRpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFBvbHlsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihwb2x5bGluZUdlb21ldHJ5KSB7CiAgICAgICAgY29uc3Qgd2lkdGggPSBwb2x5bGluZUdlb21ldHJ5Ll93aWR0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBwb2x5bGluZUdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQ7CiAgICAgICAgbGV0IGNvbG9ycyA9IHBvbHlsaW5lR2VvbWV0cnkuX2NvbG9yczsKICAgICAgICBjb25zdCBjb2xvcnNQZXJWZXJ0ZXggPSBwb2x5bGluZUdlb21ldHJ5Ll9jb2xvcnNQZXJWZXJ0ZXg7CiAgICAgICAgY29uc3QgYXJjVHlwZSA9IHBvbHlsaW5lR2VvbWV0cnkuX2FyY1R5cGU7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBwb2x5bGluZUdlb21ldHJ5Ll9ncmFudWxhcml0eTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBwb2x5bGluZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGo7CiAgICAgICAgbGV0IGs7CiAgICAgICAgY29uc3QgcmVtb3ZlZEluZGljZXMgPSBbXTsKICAgICAgICBsZXQgcG9zaXRpb25zID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgICAgICBwb2x5bGluZUdlb21ldHJ5Ll9wb3NpdGlvbnMsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbiwKICAgICAgICAgIGZhbHNlLAogICAgICAgICAgcmVtb3ZlZEluZGljZXMKICAgICAgICApOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSAmJiByZW1vdmVkSW5kaWNlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICBsZXQgcmVtb3ZlZEFycmF5SW5kZXggPSAwOwogICAgICAgICAgbGV0IG5leHRSZW1vdmVkSW5kZXggPSByZW1vdmVkSW5kaWNlc1swXTsKICAgICAgICAgIGNvbG9ycyA9IGNvbG9ycy5maWx0ZXIoZnVuY3Rpb24oY29sb3IsIGluZGV4MikgewogICAgICAgICAgICBsZXQgcmVtb3ZlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChjb2xvcnNQZXJWZXJ0ZXgpIHsKICAgICAgICAgICAgICByZW1vdmUgPSBpbmRleDIgPT09IG5leHRSZW1vdmVkSW5kZXggfHwgaW5kZXgyID09PSAwICYmIG5leHRSZW1vdmVkSW5kZXggPT09IDE7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVtb3ZlID0gaW5kZXgyICsgMSA9PT0gbmV4dFJlbW92ZWRJbmRleDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVtb3ZlKSB7CiAgICAgICAgICAgICAgcmVtb3ZlZEFycmF5SW5kZXgrKzsKICAgICAgICAgICAgICBuZXh0UmVtb3ZlZEluZGV4ID0gcmVtb3ZlZEluZGljZXNbcmVtb3ZlZEFycmF5SW5kZXhdOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBsZXQgcG9zaXRpb25zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBpZiAocG9zaXRpb25zTGVuZ3RoIDwgMiB8fCB3aWR0aCA8PSAwKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDIHx8IGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5SSFVNQikgewogICAgICAgICAgbGV0IHN1YmRpdmlzaW9uU2l6ZTsKICAgICAgICAgIGxldCBudW1iZXJPZlBvaW50c0Z1bmN0aW9uOwogICAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgICBzdWJkaXZpc2lvblNpemUgPSBNYXRoX2RlZmF1bHQuY2hvcmRMZW5ndGgoCiAgICAgICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICAgICAgZWxsaXBzb2lkLm1heGltdW1SYWRpdXMKICAgICAgICAgICAgKTsKICAgICAgICAgICAgbnVtYmVyT2ZQb2ludHNGdW5jdGlvbiA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5udW1iZXJPZlBvaW50czsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN1YmRpdmlzaW9uU2l6ZSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgICBudW1iZXJPZlBvaW50c0Z1bmN0aW9uID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0Lm51bWJlck9mUG9pbnRzUmh1bWJMaW5lOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgaGVpZ2h0cyA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5leHRyYWN0SGVpZ2h0cyhwb3NpdGlvbnMsIGVsbGlwc29pZCk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykpIHsKICAgICAgICAgICAgbGV0IGNvbG9yTGVuZ3RoID0gMTsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBvc2l0aW9uc0xlbmd0aCAtIDE7ICsraSkgewogICAgICAgICAgICAgIGNvbG9yTGVuZ3RoICs9IG51bWJlck9mUG9pbnRzRnVuY3Rpb24oCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaV0sCiAgICAgICAgICAgICAgICBwb3NpdGlvbnNbaSArIDFdLAogICAgICAgICAgICAgICAgc3ViZGl2aXNpb25TaXplCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBuZXdDb2xvcnMgPSBuZXcgQXJyYXkoY29sb3JMZW5ndGgpOwogICAgICAgICAgICBsZXQgbmV3Q29sb3JJbmRleCA9IDA7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGggLSAxOyArK2kpIHsKICAgICAgICAgICAgICBjb25zdCBwMCA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgICAgICBjb25zdCBwMSA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgICAgICAgICAgY29uc3QgYzAgPSBjb2xvcnNbaV07CiAgICAgICAgICAgICAgY29uc3QgbnVtQ29sb3JzID0gbnVtYmVyT2ZQb2ludHNGdW5jdGlvbihwMCwgcDEsIHN1YmRpdmlzaW9uU2l6ZSk7CiAgICAgICAgICAgICAgaWYgKGNvbG9yc1BlclZlcnRleCAmJiBpIDwgY29sb3JMZW5ndGgpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGMxID0gY29sb3JzW2kgKyAxXTsKICAgICAgICAgICAgICAgIGNvbnN0IGludGVycG9sYXRlZENvbG9ycyA9IGludGVycG9sYXRlQ29sb3JzKAogICAgICAgICAgICAgICAgICBwMCwKICAgICAgICAgICAgICAgICAgcDEsCiAgICAgICAgICAgICAgICAgIGMwLAogICAgICAgICAgICAgICAgICBjMSwKICAgICAgICAgICAgICAgICAgbnVtQ29sb3JzCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgY29uc3QgaW50ZXJwb2xhdGVkQ29sb3JzTGVuZ3RoID0gaW50ZXJwb2xhdGVkQ29sb3JzLmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBpbnRlcnBvbGF0ZWRDb2xvcnNMZW5ndGg7ICsraikgewogICAgICAgICAgICAgICAgICBuZXdDb2xvcnNbbmV3Q29sb3JJbmRleCsrXSA9IGludGVycG9sYXRlZENvbG9yc1tqXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IG51bUNvbG9yczsgKytqKSB7CiAgICAgICAgICAgICAgICAgIG5ld0NvbG9yc1tuZXdDb2xvckluZGV4KytdID0gQ29sb3JfZGVmYXVsdC5jbG9uZShjMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG5ld0NvbG9yc1tuZXdDb2xvckluZGV4XSA9IENvbG9yX2RlZmF1bHQuY2xvbmUoY29sb3JzW2NvbG9ycy5sZW5ndGggLSAxXSk7CiAgICAgICAgICAgIGNvbG9ycyA9IG5ld0NvbG9yczsKICAgICAgICAgICAgc2NyYXRjaEludGVycG9sYXRlQ29sb3JzQXJyYXkubGVuZ3RoID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgICAgcG9zaXRpb25zID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQ2FydGVzaWFuQXJjKHsKICAgICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgICAgbWluRGlzdGFuY2U6IHN1YmRpdmlzaW9uU2l6ZSwKICAgICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHRzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcG9zaXRpb25zID0gUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQ2FydGVzaWFuUmh1bWJBcmMoewogICAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgICBncmFudWxhcml0eTogc3ViZGl2aXNpb25TaXplLAogICAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgICBoZWlnaHQ6IGhlaWdodHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHBvc2l0aW9uc0xlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3Qgc2l6ZSA9IHBvc2l0aW9uc0xlbmd0aCAqIDQgLSA0OwogICAgICAgIGNvbnN0IGZpbmFsUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplICogMyk7CiAgICAgICAgY29uc3QgcHJldlBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSAqIDMpOwogICAgICAgIGNvbnN0IG5leHRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHNpemUgKiAzKTsKICAgICAgICBjb25zdCBleHBhbmRBbmRXaWR0aCA9IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDIpOwogICAgICAgIGNvbnN0IHN0ID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheShzaXplICogMikgOiB2b2lkIDA7CiAgICAgICAgY29uc3QgZmluYWxDb2xvcnMgPSBkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSA/IG5ldyBVaW50OEFycmF5KHNpemUgKiA0KSA6IHZvaWQgMDsKICAgICAgICBsZXQgcG9zaXRpb25JbmRleCA9IDA7CiAgICAgICAgbGV0IGV4cGFuZEFuZFdpZHRoSW5kZXggPSAwOwogICAgICAgIGxldCBzdEluZGV4ID0gMDsKICAgICAgICBsZXQgY29sb3JJbmRleCA9IDA7CiAgICAgICAgbGV0IHBvc2l0aW9uOwogICAgICAgIGZvciAoaiA9IDA7IGogPCBwb3NpdGlvbnNMZW5ndGg7ICsraikgewogICAgICAgICAgaWYgKGogPT09IDApIHsKICAgICAgICAgICAgcG9zaXRpb24gPSBzY3JhdGNoQ2FydGVzaWFuMzg7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwb3NpdGlvbnNbMF0sIHBvc2l0aW9uc1sxXSwgcG9zaXRpb24pOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uc1swXSwgcG9zaXRpb24sIHBvc2l0aW9uKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBvc2l0aW9uID0gcG9zaXRpb25zW2ogLSAxXTsKICAgICAgICAgIH0KICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbiwgc2NyYXRjaFByZXZQb3NpdGlvbik7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUocG9zaXRpb25zW2pdLCBzY3JhdGNoUG9zaXRpb240KTsKICAgICAgICAgIGlmIChqID09PSBwb3NpdGlvbnNMZW5ndGggLSAxKSB7CiAgICAgICAgICAgIHBvc2l0aW9uID0gc2NyYXRjaENhcnRlc2lhbjM4OwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uc0xlbmd0aCAtIDFdLAogICAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbnNMZW5ndGggLSAyXSwKICAgICAgICAgICAgICBwb3NpdGlvbgogICAgICAgICAgICApOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHBvc2l0aW9uc1twb3NpdGlvbnNMZW5ndGggLSAxXSwgcG9zaXRpb24sIHBvc2l0aW9uKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBvc2l0aW9uID0gcG9zaXRpb25zW2ogKyAxXTsKICAgICAgICAgIH0KICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShwb3NpdGlvbiwgc2NyYXRjaE5leHRQb3NpdGlvbik7CiAgICAgICAgICBsZXQgY29sb3IwLCBjb2xvcjE7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGZpbmFsQ29sb3JzKSkgewogICAgICAgICAgICBpZiAoaiAhPT0gMCAmJiAhY29sb3JzUGVyVmVydGV4KSB7CiAgICAgICAgICAgICAgY29sb3IwID0gY29sb3JzW2ogLSAxXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb2xvcjAgPSBjb2xvcnNbal07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGogIT09IHBvc2l0aW9uc0xlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICBjb2xvcjEgPSBjb2xvcnNbal07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHN0YXJ0SyA9IGogPT09IDAgPyAyIDogMDsKICAgICAgICAgIGNvbnN0IGVuZEsgPSBqID09PSBwb3NpdGlvbnNMZW5ndGggLSAxID8gMiA6IDQ7CiAgICAgICAgICBmb3IgKGsgPSBzdGFydEs7IGsgPCBlbmRLOyArK2spIHsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soc2NyYXRjaFBvc2l0aW9uNCwgZmluYWxQb3NpdGlvbnMsIHBvc2l0aW9uSW5kZXgpOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhzY3JhdGNoUHJldlBvc2l0aW9uLCBwcmV2UG9zaXRpb25zLCBwb3NpdGlvbkluZGV4KTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soc2NyYXRjaE5leHRQb3NpdGlvbiwgbmV4dFBvc2l0aW9ucywgcG9zaXRpb25JbmRleCk7CiAgICAgICAgICAgIHBvc2l0aW9uSW5kZXggKz0gMzsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aW9uMiA9IGsgLSAyIDwgMCA/IC0xIDogMTsKICAgICAgICAgICAgZXhwYW5kQW5kV2lkdGhbZXhwYW5kQW5kV2lkdGhJbmRleCsrXSA9IDIgKiAoayAlIDIpIC0gMTsKICAgICAgICAgICAgZXhwYW5kQW5kV2lkdGhbZXhwYW5kQW5kV2lkdGhJbmRleCsrXSA9IGRpcmVjdGlvbjIgKiB3aWR0aDsKICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSBqIC8gKHBvc2l0aW9uc0xlbmd0aCAtIDEpOwogICAgICAgICAgICAgIHN0W3N0SW5kZXgrK10gPSBNYXRoLm1heChleHBhbmRBbmRXaWR0aFtleHBhbmRBbmRXaWR0aEluZGV4IC0gMl0sIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZmluYWxDb2xvcnMpKSB7CiAgICAgICAgICAgICAgY29uc3QgY29sb3IgPSBrIDwgMiA/IGNvbG9yMCA6IGNvbG9yMTsKICAgICAgICAgICAgICBmaW5hbENvbG9yc1tjb2xvckluZGV4KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShjb2xvci5yZWQpOwogICAgICAgICAgICAgIGZpbmFsQ29sb3JzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmdyZWVuKTsKICAgICAgICAgICAgICBmaW5hbENvbG9yc1tjb2xvckluZGV4KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShjb2xvci5ibHVlKTsKICAgICAgICAgICAgICBmaW5hbENvbG9yc1tjb2xvckluZGV4KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShjb2xvci5hbHBoYSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgICAgIGF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgdmFsdWVzOiBmaW5hbFBvc2l0aW9ucwogICAgICAgIH0pOwogICAgICAgIGF0dHJpYnV0ZXMucHJldlBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogcHJldlBvc2l0aW9ucwogICAgICAgIH0pOwogICAgICAgIGF0dHJpYnV0ZXMubmV4dFBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgIHZhbHVlczogbmV4dFBvc2l0aW9ucwogICAgICAgIH0pOwogICAgICAgIGF0dHJpYnV0ZXMuZXhwYW5kQW5kV2lkdGggPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgICB2YWx1ZXM6IGV4cGFuZEFuZFdpZHRoCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDIsCiAgICAgICAgICAgIHZhbHVlczogc3QKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGZpbmFsQ29sb3JzKSkgewogICAgICAgICAgYXR0cmlidXRlcy5jb2xvciA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogNCwKICAgICAgICAgICAgdmFsdWVzOiBmaW5hbENvbG9ycywKICAgICAgICAgICAgbm9ybWFsaXplOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KHNpemUsIHBvc2l0aW9uc0xlbmd0aCAqIDYgLSA2KTsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGxldCBpbmRpY2VzSW5kZXggPSAwOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9uc0xlbmd0aCAtIDE7CiAgICAgICAgZm9yIChqID0gMDsgaiA8IGxlbmd0aDsgKytqKSB7CiAgICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4OwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpbmRleCArIDI7CiAgICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMTsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXggKyAxOwogICAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpbmRleCArIDI7CiAgICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMzsKICAgICAgICAgIGluZGV4ICs9IDQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZTogQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUG9pbnRzKHBvc2l0aW9ucyksCiAgICAgICAgICBnZW9tZXRyeVR5cGU6IEdlb21ldHJ5VHlwZV9kZWZhdWx0LlBPTFlMSU5FUwogICAgICAgIH0pOwogICAgICB9OwogICAgICBQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBQb2x5bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUG9seWxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVQb2x5bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVQb2x5bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVBvbHlsaW5lR2VvbWV0cnkocG9seWxpbmVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcG9seWxpbmVHZW9tZXRyeSA9IFBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2socG9seWxpbmVHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHBvbHlsaW5lR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBvbHlsaW5lR2VvbWV0cnkuX2VsbGlwc29pZCk7CiAgICByZXR1cm4gUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHBvbHlsaW5lR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVBvbHlsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBvbHlsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9Qb2x5bGluZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVBvbHlsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZVZvbHVtZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gY29tcHV0ZUF0dHJpYnV0ZXMyKGNvbWJpbmVkUG9zaXRpb25zLCBzaGFwZSwgYm91bmRpbmdSZWN0YW5nbGUsIHZlcnRleEZvcm1hdCkgewogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICBhdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogY29tYmluZWRQb3NpdGlvbnMKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBzaGFwZUxlbmd0aCA9IHNoYXBlLmxlbmd0aDsKICAgIGNvbnN0IHZlcnRleENvdW50ID0gY29tYmluZWRQb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IGxlbmd0aCA9ICh2ZXJ0ZXhDb3VudCAtIHNoYXBlTGVuZ3RoICogMikgLyAoc2hhcGVMZW5ndGggKiAyKTsKICAgIGNvbnN0IGZpcnN0RW5kSW5kaWNlcyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnRyaWFuZ3VsYXRlKHNoYXBlKTsKICAgIGNvbnN0IGluZGljZXNDb3VudCA9IChsZW5ndGggLSAxKSAqIHNoYXBlTGVuZ3RoICogNiArIGZpcnN0RW5kSW5kaWNlcy5sZW5ndGggKiAyOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KHZlcnRleENvdW50LCBpbmRpY2VzQ291bnQpOwogICAgbGV0IGksIGo7CiAgICBsZXQgbGwsIHVsLCB1ciwgbHI7CiAgICBjb25zdCBvZmZzZXQgPSBzaGFwZUxlbmd0aCAqIDI7CiAgICBsZXQgaW5kZXggPSAwOwogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICBmb3IgKGogPSAwOyBqIDwgc2hhcGVMZW5ndGggLSAxOyBqKyspIHsKICAgICAgICBsbCA9IGogKiAyICsgaSAqIHNoYXBlTGVuZ3RoICogMjsKICAgICAgICBsciA9IGxsICsgb2Zmc2V0OwogICAgICAgIHVsID0gbGwgKyAxOwogICAgICAgIHVyID0gdWwgKyBvZmZzZXQ7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHVsOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBsbDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gdXI7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHVyOwogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBsbDsKICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gbHI7CiAgICAgIH0KICAgICAgbGwgPSBzaGFwZUxlbmd0aCAqIDIgLSAyICsgaSAqIHNoYXBlTGVuZ3RoICogMjsKICAgICAgdWwgPSBsbCArIDE7CiAgICAgIHVyID0gdWwgKyBvZmZzZXQ7CiAgICAgIGxyID0gbGwgKyBvZmZzZXQ7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB1bDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGxsOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gdXI7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB1cjsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGxsOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gbHI7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0IHx8IHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgY29uc3Qgc3QgPSBuZXcgRmxvYXQzMkFycmF5KHZlcnRleENvdW50ICogMik7CiAgICAgIGNvbnN0IGxlbmd0aFN0ID0gMSAvIChsZW5ndGggLSAxKTsKICAgICAgY29uc3QgaGVpZ2h0U3QgPSAxIC8gYm91bmRpbmdSZWN0YW5nbGUuaGVpZ2h0OwogICAgICBjb25zdCBoZWlnaHRPZmZzZXQgPSBib3VuZGluZ1JlY3RhbmdsZS5oZWlnaHQgLyAyOwogICAgICBsZXQgcywgdDsKICAgICAgbGV0IHN0aW5kZXggPSAwOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBzID0gaSAqIGxlbmd0aFN0OwogICAgICAgIHQgPSBoZWlnaHRTdCAqIChzaGFwZVswXS55ICsgaGVpZ2h0T2Zmc2V0KTsKICAgICAgICBzdFtzdGluZGV4KytdID0gczsKICAgICAgICBzdFtzdGluZGV4KytdID0gdDsKICAgICAgICBmb3IgKGogPSAxOyBqIDwgc2hhcGVMZW5ndGg7IGorKykgewogICAgICAgICAgdCA9IGhlaWdodFN0ICogKHNoYXBlW2pdLnkgKyBoZWlnaHRPZmZzZXQpOwogICAgICAgICAgc3Rbc3RpbmRleCsrXSA9IHM7CiAgICAgICAgICBzdFtzdGluZGV4KytdID0gdDsKICAgICAgICAgIHN0W3N0aW5kZXgrK10gPSBzOwogICAgICAgICAgc3Rbc3RpbmRleCsrXSA9IHQ7CiAgICAgICAgfQogICAgICAgIHQgPSBoZWlnaHRTdCAqIChzaGFwZVswXS55ICsgaGVpZ2h0T2Zmc2V0KTsKICAgICAgICBzdFtzdGluZGV4KytdID0gczsKICAgICAgICBzdFtzdGluZGV4KytdID0gdDsKICAgICAgfQogICAgICBmb3IgKGogPSAwOyBqIDwgc2hhcGVMZW5ndGg7IGorKykgewogICAgICAgIHMgPSAwOwogICAgICAgIHQgPSBoZWlnaHRTdCAqIChzaGFwZVtqXS55ICsgaGVpZ2h0T2Zmc2V0KTsKICAgICAgICBzdFtzdGluZGV4KytdID0gczsKICAgICAgICBzdFtzdGluZGV4KytdID0gdDsKICAgICAgfQogICAgICBmb3IgKGogPSAwOyBqIDwgc2hhcGVMZW5ndGg7IGorKykgewogICAgICAgIHMgPSAobGVuZ3RoIC0gMSkgKiBsZW5ndGhTdDsKICAgICAgICB0ID0gaGVpZ2h0U3QgKiAoc2hhcGVbal0ueSArIGhlaWdodE9mZnNldCk7CiAgICAgICAgc3Rbc3RpbmRleCsrXSA9IHM7CiAgICAgICAgc3Rbc3RpbmRleCsrXSA9IHQ7CiAgICAgIH0KICAgICAgYXR0cmlidXRlcy5zdCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgIHZhbHVlczogbmV3IEZsb2F0MzJBcnJheShzdCkKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBlbmRPZmZzZXQgPSB2ZXJ0ZXhDb3VudCAtIHNoYXBlTGVuZ3RoICogMjsKICAgIGZvciAoaSA9IDA7IGkgPCBmaXJzdEVuZEluZGljZXMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgY29uc3QgdjAyID0gZmlyc3RFbmRJbmRpY2VzW2ldICsgZW5kT2Zmc2V0OwogICAgICBjb25zdCB2MTIgPSBmaXJzdEVuZEluZGljZXNbaSArIDFdICsgZW5kT2Zmc2V0OwogICAgICBjb25zdCB2MjIgPSBmaXJzdEVuZEluZGljZXNbaSArIDJdICsgZW5kT2Zmc2V0OwogICAgICBpbmRpY2VzW2luZGV4KytdID0gdjAyOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gdjEyOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gdjIyOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gdjIyICsgc2hhcGVMZW5ndGg7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB2MTIgKyBzaGFwZUxlbmd0aDsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHYwMiArIHNoYXBlTGVuZ3RoOwogICAgfQogICAgbGV0IGdlb21ldHJ5ID0gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzLAogICAgICBib3VuZGluZ1NwaGVyZTogQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMoY29tYmluZWRQb3NpdGlvbnMpLAogICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTCiAgICB9KTsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgIGdlb21ldHJ5ID0gR2VvbWV0cnlQaXBlbGluZV9kZWZhdWx0LmNvbXB1dGVOb3JtYWwoZ2VvbWV0cnkpOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50IHx8IHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgdHJ5IHsKICAgICAgICBnZW9tZXRyeSA9IEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlVGFuZ2VudEFuZEJpdGFuZ2VudChnZW9tZXRyeSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBvbmVUaW1lV2FybmluZ19kZWZhdWx0KAogICAgICAgICAgInBvbHlsaW5lLXZvbHVtZS10YW5nZW50LWJpdGFuZ2VudCIsCiAgICAgICAgICAiVW5hYmxlIHRvIGNvbXB1dGUgdGFuZ2VudHMgYW5kIGJpdGFuZ2VudHMgZm9yIHBvbHlsaW5lIHZvbHVtZSBnZW9tZXRyeSIKICAgICAgICApOwogICAgICB9CiAgICAgIGlmICghdmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnRhbmdlbnQgPSB2b2lkIDA7CiAgICAgIH0KICAgICAgaWYgKCF2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5iaXRhbmdlbnQgPSB2b2lkIDA7CiAgICAgIH0KICAgICAgaWYgKCF2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnN0ID0gdm9pZCAwOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZ2VvbWV0cnk7CiAgfQogIGZ1bmN0aW9uIFBvbHlsaW5lVm9sdW1lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBvcHRpb25zLnBvbHlsaW5lUG9zaXRpb25zOwogICAgY29uc3Qgc2hhcGUgPSBvcHRpb25zLnNoYXBlUG9zaXRpb25zOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5wb2x5bGluZVBvc2l0aW9ucyBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHNoYXBlKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5zaGFwZVBvc2l0aW9ucyBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIHRoaXMuX3Bvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgIHRoaXMuX3NoYXBlID0gc2hhcGU7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KQogICAgKTsKICAgIHRoaXMuX2Nvcm5lclR5cGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmNvcm5lclR5cGUsIENvcm5lclR5cGVfZGVmYXVsdC5ST1VOREVEKTsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCkKICAgICk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5IjsKICAgIGxldCBudW1Db21wb25lbnRzID0gMSArIHBvc2l0aW9ucy5sZW5ndGggKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgbnVtQ29tcG9uZW50cyArPSAxICsgc2hhcGUubGVuZ3RoICogQ2FydGVzaWFuMl9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIHRoaXMucGFja2VkTGVuZ3RoID0gbnVtQ29tcG9uZW50cyArIEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDI7CiAgfQogIHZhciBzY3JhdGNoRWxsaXBzb2lkOSwgc2NyYXRjaFZlcnRleEZvcm1hdDExLCBzY3JhdGNoT3B0aW9uczE3LCBiclNjcmF0Y2gsIFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Qb2x5bGluZVZvbHVtZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9Qb2x5bGluZVZvbHVtZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9hcnJheVJlbW92ZUR1cGxpY2F0ZXMoKTsKICAgICAgaW5pdF9Cb3VuZGluZ1JlY3RhbmdsZSgpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X0Nvcm5lclR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlQaXBlbGluZSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfb25lVGltZVdhcm5pbmcoKTsKICAgICAgaW5pdF9Qb2x5Z29uUGlwZWxpbmUoKTsKICAgICAgaW5pdF9Qb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgaW5pdF9XaW5kaW5nT3JkZXIoKTsKICAgICAgUG9seWxpbmVWb2x1bWVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHZhbHVlLl9wb3NpdGlvbnM7CiAgICAgICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socG9zaXRpb25zW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNoYXBlID0gdmFsdWUuX3NoYXBlOwogICAgICAgIGxlbmd0aCA9IHNoYXBlLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFjayhzaGFwZVtpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrKHZhbHVlLl92ZXJ0ZXhGb3JtYXQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2Nvcm5lclR5cGU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkOSA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDExID0gbmV3IFZlcnRleEZvcm1hdF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTcgPSB7CiAgICAgICAgcG9seWxpbmVQb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgICBzaGFwZVBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIGVsbGlwc29pZDogc2NyYXRjaEVsbGlwc29pZDksCiAgICAgICAgdmVydGV4Rm9ybWF0OiBzY3JhdGNoVmVydGV4Rm9ybWF0MTEsCiAgICAgICAgY29ybmVyVHlwZTogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAKICAgICAgfTsKICAgICAgUG9seWxpbmVWb2x1bWVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzaGFwZSA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBzaGFwZVtpXSA9IENhcnRlc2lhbjJfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQ5KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MTEKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGNvcm5lclR5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxNy5wb2x5bGluZVBvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTcuc2hhcGVQb3NpdGlvbnMgPSBzaGFwZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTcuY29ybmVyVHlwZSA9IGNvcm5lclR5cGU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE3LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICByZXR1cm4gbmV3IFBvbHlsaW5lVm9sdW1lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMxNyk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgIHJlc3VsdC5fc2hhcGUgPSBzaGFwZTsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9jb3JuZXJUeXBlID0gY29ybmVyVHlwZTsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgYnJTY3JhdGNoID0gbmV3IEJvdW5kaW5nUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgUG9seWxpbmVWb2x1bWVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHBvbHlsaW5lVm9sdW1lR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBwb2x5bGluZVZvbHVtZUdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgY2xlYW5Qb3NpdGlvbnMgPSBhcnJheVJlbW92ZUR1cGxpY2F0ZXNfZGVmYXVsdCgKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHNFcHNpbG9uCiAgICAgICAgKTsKICAgICAgICBsZXQgc2hhcGUyRCA9IHBvbHlsaW5lVm9sdW1lR2VvbWV0cnkuX3NoYXBlOwogICAgICAgIHNoYXBlMkQgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LnJlbW92ZUR1cGxpY2F0ZXNGcm9tU2hhcGUoc2hhcGUyRCk7CiAgICAgICAgaWYgKGNsZWFuUG9zaXRpb25zLmxlbmd0aCA8IDIgfHwgc2hhcGUyRC5sZW5ndGggPCAzKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuY29tcHV0ZVdpbmRpbmdPcmRlcjJEKHNoYXBlMkQpID09PSBXaW5kaW5nT3JkZXJfZGVmYXVsdC5DTE9DS1dJU0UpIHsKICAgICAgICAgIHNoYXBlMkQucmV2ZXJzZSgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3VuZGluZ1JlY3RhbmdsZSA9IEJvdW5kaW5nUmVjdGFuZ2xlX2RlZmF1bHQuZnJvbVBvaW50cyhzaGFwZTJELCBiclNjcmF0Y2gpOwogICAgICAgIGNvbnN0IGNvbXB1dGVkUG9zaXRpb25zID0gUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKAogICAgICAgICAgY2xlYW5Qb3NpdGlvbnMsCiAgICAgICAgICBzaGFwZTJELAogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgICAgICBwb2x5bGluZVZvbHVtZUdlb21ldHJ5LAogICAgICAgICAgdHJ1ZQogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVBdHRyaWJ1dGVzMigKICAgICAgICAgIGNvbXB1dGVkUG9zaXRpb25zLAogICAgICAgICAgc2hhcGUyRCwKICAgICAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlLAogICAgICAgICAgcG9seWxpbmVWb2x1bWVHZW9tZXRyeS5fdmVydGV4Rm9ybWF0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgUG9seWxpbmVWb2x1bWVHZW9tZXRyeV9kZWZhdWx0ID0gUG9seWxpbmVWb2x1bWVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUG9seWxpbmVWb2x1bWVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUG9seWxpbmVWb2x1bWVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5KHBvbHlsaW5lVm9sdW1lR2VvbWV0cnksIG9mZnNldCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvZmZzZXQpKSB7CiAgICAgIHBvbHlsaW5lVm9sdW1lR2VvbWV0cnkgPSBQb2x5bGluZVZvbHVtZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKAogICAgICAgIHBvbHlsaW5lVm9sdW1lR2VvbWV0cnksCiAgICAgICAgb2Zmc2V0CiAgICAgICk7CiAgICB9CiAgICBwb2x5bGluZVZvbHVtZUdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgcG9seWxpbmVWb2x1bWVHZW9tZXRyeS5fZWxsaXBzb2lkCiAgICApOwogICAgcmV0dXJuIFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShwb2x5bGluZVZvbHVtZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUG9seWxpbmVWb2x1bWVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBjb21wdXRlQXR0cmlidXRlczMocG9zaXRpb25zLCBzaGFwZSkgewogICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCgpOwogICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgfSk7CiAgICBjb25zdCBzaGFwZUxlbmd0aCA9IHNoYXBlLmxlbmd0aDsKICAgIGNvbnN0IHZlcnRleENvdW50ID0gYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IHBvc2l0aW9uTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCBzaGFwZUNvdW50ID0gcG9zaXRpb25MZW5ndGggLyBzaGFwZUxlbmd0aDsKICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgdmVydGV4Q291bnQsCiAgICAgIDIgKiBzaGFwZUxlbmd0aCAqIChzaGFwZUNvdW50ICsgMSkKICAgICk7CiAgICBsZXQgaSwgajsKICAgIGxldCBpbmRleCA9IDA7CiAgICBpID0gMDsKICAgIGxldCBvZmZzZXQgPSBpICogc2hhcGVMZW5ndGg7CiAgICBmb3IgKGogPSAwOyBqIDwgc2hhcGVMZW5ndGggLSAxOyBqKyspIHsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyBvZmZzZXQ7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqICsgb2Zmc2V0ICsgMTsKICAgIH0KICAgIGluZGljZXNbaW5kZXgrK10gPSBzaGFwZUxlbmd0aCAtIDEgKyBvZmZzZXQ7CiAgICBpbmRpY2VzW2luZGV4KytdID0gb2Zmc2V0OwogICAgaSA9IHNoYXBlQ291bnQgLSAxOwogICAgb2Zmc2V0ID0gaSAqIHNoYXBlTGVuZ3RoOwogICAgZm9yIChqID0gMDsgaiA8IHNoYXBlTGVuZ3RoIC0gMTsgaisrKSB7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqICsgb2Zmc2V0OwogICAgICBpbmRpY2VzW2luZGV4KytdID0gaiArIG9mZnNldCArIDE7CiAgICB9CiAgICBpbmRpY2VzW2luZGV4KytdID0gc2hhcGVMZW5ndGggLSAxICsgb2Zmc2V0OwogICAgaW5kaWNlc1tpbmRleCsrXSA9IG9mZnNldDsKICAgIGZvciAoaSA9IDA7IGkgPCBzaGFwZUNvdW50IC0gMTsgaSsrKSB7CiAgICAgIGNvbnN0IGZpcnN0T2Zmc2V0ID0gc2hhcGVMZW5ndGggKiBpOwogICAgICBjb25zdCBzZWNvbmRPZmZzZXQgPSBmaXJzdE9mZnNldCArIHNoYXBlTGVuZ3RoOwogICAgICBmb3IgKGogPSAwOyBqIDwgc2hhcGVMZW5ndGg7IGorKykgewogICAgICAgIGluZGljZXNbaW5kZXgrK10gPSBqICsgZmlyc3RPZmZzZXQ7CiAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGogKyBzZWNvbmRPZmZzZXQ7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICBhdHRyaWJ1dGVzLAogICAgICBpbmRpY2VzOiBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSh2ZXJ0ZXhDb3VudCwgaW5kaWNlcyksCiAgICAgIGJvdW5kaW5nU3BoZXJlOiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcyhwb3NpdGlvbnMpLAogICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuTElORVMKICAgIH0pOwogICAgcmV0dXJuIGdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9seWxpbmVQb3NpdGlvbnM7CiAgICBjb25zdCBzaGFwZSA9IG9wdGlvbnMuc2hhcGVQb3NpdGlvbnM7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3NpdGlvbnMpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvbHlsaW5lUG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoc2hhcGUpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnNoYXBlUG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgdGhpcy5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgdGhpcy5fc2hhcGUgPSBzaGFwZTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpCiAgICApOwogICAgdGhpcy5fY29ybmVyVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuY29ybmVyVHlwZSwgQ29ybmVyVHlwZV9kZWZhdWx0LlJPVU5ERUQpOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkiOwogICAgbGV0IG51bUNvbXBvbmVudHMgPSAxICsgcG9zaXRpb25zLmxlbmd0aCAqIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBudW1Db21wb25lbnRzICs9IDEgKyBzaGFwZS5sZW5ndGggKiBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBudW1Db21wb25lbnRzICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMjsKICB9CiAgdmFyIHNjcmF0Y2hFbGxpcHNvaWQxMCwgc2NyYXRjaE9wdGlvbnMxOCwgYnJTY3JhdGNoMiwgUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9Qb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2FycmF5UmVtb3ZlRHVwbGljYXRlcygpOwogICAgICBpbml0X0JvdW5kaW5nUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfQ29ybmVyVHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1BvbHlnb25QaXBlbGluZSgpOwogICAgICBpbml0X1BvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1dpbmRpbmdPcmRlcigpOwogICAgICBQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHZhbHVlLl9wb3NpdGlvbnM7CiAgICAgICAgbGV0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socG9zaXRpb25zW2ldLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNoYXBlID0gdmFsdWUuX3NoYXBlOwogICAgICAgIGxlbmd0aCA9IHNoYXBlLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFjayhzaGFwZVtpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2Nvcm5lclR5cGU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkMTAgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTggPSB7CiAgICAgICAgcG9seWxpbmVQb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgICBzaGFwZVBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIGVsbGlwc29pZDogc2NyYXRjaEVsbGlwc29pZDEwLAogICAgICAgIGhlaWdodDogdm9pZCAwLAogICAgICAgIGNvcm5lclR5cGU6IHZvaWQgMCwKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwCiAgICAgIH07CiAgICAgIFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHNoYXBlID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHNoYXBlW2ldID0gQ2FydGVzaWFuMl9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDEwKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBjb3JuZXJUeXBlID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTgucG9seWxpbmVQb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE4LnNoYXBlUG9zaXRpb25zID0gc2hhcGU7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE4LmNvcm5lclR5cGUgPSBjb3JuZXJUeXBlOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMxOC5ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgcmV0dXJuIG5ldyBQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczE4KTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9zaGFwZSA9IHNoYXBlOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkLCByZXN1bHQuX2VsbGlwc29pZCk7CiAgICAgICAgcmVzdWx0Ll9jb3JuZXJUeXBlID0gY29ybmVyVHlwZTsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgYnJTY3JhdGNoMiA9IG5ldyBCb3VuZGluZ1JlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgIFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24ocG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5fcG9zaXRpb25zOwogICAgICAgIGNvbnN0IGNsZWFuUG9zaXRpb25zID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQoCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbgogICAgICAgICk7CiAgICAgICAgbGV0IHNoYXBlMkQgPSBwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5fc2hhcGU7CiAgICAgICAgc2hhcGUyRCA9IFBvbHlsaW5lVm9sdW1lR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQucmVtb3ZlRHVwbGljYXRlc0Zyb21TaGFwZShzaGFwZTJEKTsKICAgICAgICBpZiAoY2xlYW5Qb3NpdGlvbnMubGVuZ3RoIDwgMiB8fCBzaGFwZTJELmxlbmd0aCA8IDMpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmIChQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5jb21wdXRlV2luZGluZ09yZGVyMkQoc2hhcGUyRCkgPT09IFdpbmRpbmdPcmRlcl9kZWZhdWx0LkNMT0NLV0lTRSkgewogICAgICAgICAgc2hhcGUyRC5yZXZlcnNlKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJvdW5kaW5nUmVjdGFuZ2xlID0gQm91bmRpbmdSZWN0YW5nbGVfZGVmYXVsdC5mcm9tUG9pbnRzKHNoYXBlMkQsIGJyU2NyYXRjaDIpOwogICAgICAgIGNvbnN0IGNvbXB1dGVkUG9zaXRpb25zID0gUG9seWxpbmVWb2x1bWVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKAogICAgICAgICAgY2xlYW5Qb3NpdGlvbnMsCiAgICAgICAgICBzaGFwZTJELAogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgICAgICBwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gY29tcHV0ZUF0dHJpYnV0ZXMzKGNvbXB1dGVkUG9zaXRpb25zLCBzaGFwZTJEKTsKICAgICAgfTsKICAgICAgUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IFBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeShwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkgPSBQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICBwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSwKICAgICAgICBvZmZzZXQKICAgICAgKTsKICAgIH0KICAgIHBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgcG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkuX2VsbGlwc29pZAogICAgKTsKICAgIHJldHVybiBQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KAogICAgICBwb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeQogICAgKTsKICB9CiAgdmFyIGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5LmpzCiAgZnVuY3Rpb24gZ2V0Um90YXRpb25PcHRpb25zKG53Q29ybmVyLCByb3RhdGlvbiwgZ3JhbnVsYXJpdHlYLCBncmFudWxhcml0eVksIGNlbnRlciwgd2lkdGgsIGhlaWdodCkgewogICAgY29uc3QgY29zUm90YXRpb24gPSBNYXRoLmNvcyhyb3RhdGlvbik7CiAgICBjb25zdCBncmFuWUNvcyA9IGdyYW51bGFyaXR5WSAqIGNvc1JvdGF0aW9uOwogICAgY29uc3QgZ3JhblhDb3MgPSBncmFudWxhcml0eVggKiBjb3NSb3RhdGlvbjsKICAgIGNvbnN0IHNpblJvdGF0aW9uID0gTWF0aC5zaW4ocm90YXRpb24pOwogICAgY29uc3QgZ3JhbllTaW4gPSBncmFudWxhcml0eVkgKiBzaW5Sb3RhdGlvbjsKICAgIGNvbnN0IGdyYW5YU2luID0gZ3JhbnVsYXJpdHlYICogc2luUm90YXRpb247CiAgICBud0NhcnRlc2lhbiA9IHByb2oucHJvamVjdChud0Nvcm5lciwgbndDYXJ0ZXNpYW4pOwogICAgbndDYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobndDYXJ0ZXNpYW4sIGNlbnRlckNhcnRlc2lhbiwgbndDYXJ0ZXNpYW4pOwogICAgY29uc3Qgcm90YXRpb25NYXRyaXggPSBNYXRyaXgyX2RlZmF1bHQuZnJvbVJvdGF0aW9uKHJvdGF0aW9uLCByb3RhdGlvbk1hdHJpeFNjcmF0Y2gpOwogICAgbndDYXJ0ZXNpYW4gPSBNYXRyaXgyX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcigKICAgICAgcm90YXRpb25NYXRyaXgsCiAgICAgIG53Q2FydGVzaWFuLAogICAgICBud0NhcnRlc2lhbgogICAgKTsKICAgIG53Q2FydGVzaWFuID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChud0NhcnRlc2lhbiwgY2VudGVyQ2FydGVzaWFuLCBud0NhcnRlc2lhbik7CiAgICBud0Nvcm5lciA9IHByb2oudW5wcm9qZWN0KG53Q2FydGVzaWFuLCBud0Nvcm5lcik7CiAgICB3aWR0aCAtPSAxOwogICAgaGVpZ2h0IC09IDE7CiAgICBjb25zdCBsYXRpdHVkZSA9IG53Q29ybmVyLmxhdGl0dWRlOwogICAgY29uc3QgbGF0aXR1ZGUwID0gbGF0aXR1ZGUgKyB3aWR0aCAqIGdyYW5YU2luOwogICAgY29uc3QgbGF0aXR1ZGUxID0gbGF0aXR1ZGUgLSBncmFuWUNvcyAqIGhlaWdodDsKICAgIGNvbnN0IGxhdGl0dWRlMiA9IGxhdGl0dWRlIC0gZ3JhbllDb3MgKiBoZWlnaHQgKyB3aWR0aCAqIGdyYW5YU2luOwogICAgY29uc3Qgbm9ydGggPSBNYXRoLm1heChsYXRpdHVkZSwgbGF0aXR1ZGUwLCBsYXRpdHVkZTEsIGxhdGl0dWRlMik7CiAgICBjb25zdCBzb3V0aCA9IE1hdGgubWluKGxhdGl0dWRlLCBsYXRpdHVkZTAsIGxhdGl0dWRlMSwgbGF0aXR1ZGUyKTsKICAgIGNvbnN0IGxvbmdpdHVkZSA9IG53Q29ybmVyLmxvbmdpdHVkZTsKICAgIGNvbnN0IGxvbmdpdHVkZTAgPSBsb25naXR1ZGUgKyB3aWR0aCAqIGdyYW5YQ29zOwogICAgY29uc3QgbG9uZ2l0dWRlMSA9IGxvbmdpdHVkZSArIGhlaWdodCAqIGdyYW5ZU2luOwogICAgY29uc3QgbG9uZ2l0dWRlMiA9IGxvbmdpdHVkZSArIGhlaWdodCAqIGdyYW5ZU2luICsgd2lkdGggKiBncmFuWENvczsKICAgIGNvbnN0IGVhc3QgPSBNYXRoLm1heChsb25naXR1ZGUsIGxvbmdpdHVkZTAsIGxvbmdpdHVkZTEsIGxvbmdpdHVkZTIpOwogICAgY29uc3Qgd2VzdCA9IE1hdGgubWluKGxvbmdpdHVkZSwgbG9uZ2l0dWRlMCwgbG9uZ2l0dWRlMSwgbG9uZ2l0dWRlMik7CiAgICByZXR1cm4gewogICAgICBub3J0aCwKICAgICAgc291dGgsCiAgICAgIGVhc3QsCiAgICAgIHdlc3QsCiAgICAgIGdyYW5ZQ29zLAogICAgICBncmFuWVNpbiwKICAgICAgZ3JhblhDb3MsCiAgICAgIGdyYW5YU2luLAogICAgICBud0Nvcm5lcgogICAgfTsKICB9CiAgdmFyIGNvczMsIHNpbjMsIHNxcnQsIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeSwgcm90YXRpb25NYXRyaXhTY3JhdGNoLCBud0NhcnRlc2lhbiwgY2VudGVyU2NyYXRjaDMsIGNlbnRlckNhcnRlc2lhbiwgcHJvaiwgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9SZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9HZW9ncmFwaGljUHJvamVjdGlvbigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXgyKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGNvczMgPSBNYXRoLmNvczsKICAgICAgc2luMyA9IE1hdGguc2luOwogICAgICBzcXJ0ID0gTWF0aC5zcXJ0OwogICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkgPSB7fTsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVQb3NpdGlvbiA9IGZ1bmN0aW9uKGNvbXB1dGVkT3B0aW9ucywgZWxsaXBzb2lkLCBjb21wdXRlU1QsIHJvdywgY29sLCBwb3NpdGlvbiwgc3QpIHsKICAgICAgICBjb25zdCByYWRpaVNxdWFyZWQgPSBlbGxpcHNvaWQucmFkaWlTcXVhcmVkOwogICAgICAgIGNvbnN0IG53Q29ybmVyID0gY29tcHV0ZWRPcHRpb25zLm53Q29ybmVyOwogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IGNvbXB1dGVkT3B0aW9ucy5ib3VuZGluZ1JlY3RhbmdsZTsKICAgICAgICBsZXQgc3RMYXRpdHVkZSA9IG53Q29ybmVyLmxhdGl0dWRlIC0gY29tcHV0ZWRPcHRpb25zLmdyYW5ZQ29zICogcm93ICsgY29sICogY29tcHV0ZWRPcHRpb25zLmdyYW5YU2luOwogICAgICAgIGNvbnN0IGNvc0xhdGl0dWRlID0gY29zMyhzdExhdGl0dWRlKTsKICAgICAgICBjb25zdCBuWiA9IHNpbjMoc3RMYXRpdHVkZSk7CiAgICAgICAgY29uc3Qga1ogPSByYWRpaVNxdWFyZWQueiAqIG5aOwogICAgICAgIGxldCBzdExvbmdpdHVkZSA9IG53Q29ybmVyLmxvbmdpdHVkZSArIHJvdyAqIGNvbXB1dGVkT3B0aW9ucy5ncmFuWVNpbiArIGNvbCAqIGNvbXB1dGVkT3B0aW9ucy5ncmFuWENvczsKICAgICAgICBjb25zdCBuWCA9IGNvc0xhdGl0dWRlICogY29zMyhzdExvbmdpdHVkZSk7CiAgICAgICAgY29uc3QgblkgPSBjb3NMYXRpdHVkZSAqIHNpbjMoc3RMb25naXR1ZGUpOwogICAgICAgIGNvbnN0IGtYID0gcmFkaWlTcXVhcmVkLnggKiBuWDsKICAgICAgICBjb25zdCBrWSA9IHJhZGlpU3F1YXJlZC55ICogblk7CiAgICAgICAgY29uc3QgZ2FtbWEgPSBzcXJ0KGtYICogblggKyBrWSAqIG5ZICsga1ogKiBuWik7CiAgICAgICAgcG9zaXRpb24ueCA9IGtYIC8gZ2FtbWE7CiAgICAgICAgcG9zaXRpb24ueSA9IGtZIC8gZ2FtbWE7CiAgICAgICAgcG9zaXRpb24ueiA9IGtaIC8gZ2FtbWE7CiAgICAgICAgaWYgKGNvbXB1dGVTVCkgewogICAgICAgICAgY29uc3Qgc3ROd0Nvcm5lciA9IGNvbXB1dGVkT3B0aW9ucy5zdE53Q29ybmVyOwogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChzdE53Q29ybmVyKSkgewogICAgICAgICAgICBzdExhdGl0dWRlID0gc3ROd0Nvcm5lci5sYXRpdHVkZSAtIGNvbXB1dGVkT3B0aW9ucy5zdEdyYW5ZQ29zICogcm93ICsgY29sICogY29tcHV0ZWRPcHRpb25zLnN0R3JhblhTaW47CiAgICAgICAgICAgIHN0TG9uZ2l0dWRlID0gc3ROd0Nvcm5lci5sb25naXR1ZGUgKyByb3cgKiBjb21wdXRlZE9wdGlvbnMuc3RHcmFuWVNpbiArIGNvbCAqIGNvbXB1dGVkT3B0aW9ucy5zdEdyYW5YQ29zOwogICAgICAgICAgICBzdC54ID0gKHN0TG9uZ2l0dWRlIC0gY29tcHV0ZWRPcHRpb25zLnN0V2VzdCkgKiBjb21wdXRlZE9wdGlvbnMubG9uU2NhbGFyOwogICAgICAgICAgICBzdC55ID0gKHN0TGF0aXR1ZGUgLSBjb21wdXRlZE9wdGlvbnMuc3RTb3V0aCkgKiBjb21wdXRlZE9wdGlvbnMubGF0U2NhbGFyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3QueCA9IChzdExvbmdpdHVkZSAtIHJlY3RhbmdsZS53ZXN0KSAqIGNvbXB1dGVkT3B0aW9ucy5sb25TY2FsYXI7CiAgICAgICAgICAgIHN0LnkgPSAoc3RMYXRpdHVkZSAtIHJlY3RhbmdsZS5zb3V0aCkgKiBjb21wdXRlZE9wdGlvbnMubGF0U2NhbGFyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgcm90YXRpb25NYXRyaXhTY3JhdGNoID0gbmV3IE1hdHJpeDJfZGVmYXVsdCgpOwogICAgICBud0NhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgY2VudGVyU2NyYXRjaDMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgY2VudGVyQ2FydGVzaWFuID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwcm9qID0gbmV3IEdlb2dyYXBoaWNQcm9qZWN0aW9uX2RlZmF1bHQoKTsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5LmNvbXB1dGVPcHRpb25zID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBncmFudWxhcml0eSwgcm90YXRpb24sIHN0Um90YXRpb24sIGJvdW5kaW5nUmVjdGFuZ2xlU2NyYXRjaCwgbndDb3JuZXJSZXN1bHQsIHN0TndDb3JuZXJSZXN1bHQpIHsKICAgICAgICBsZXQgZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgICAgIGxldCB3ZXN0ID0gcmVjdGFuZ2xlLndlc3Q7CiAgICAgICAgbGV0IG5vcnRoID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgICAgIGxldCBzb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICBsZXQgbm9ydGhDYXAgPSBmYWxzZTsKICAgICAgICBsZXQgc291dGhDYXAgPSBmYWxzZTsKICAgICAgICBpZiAobm9ydGggPT09IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTykgewogICAgICAgICAgbm9ydGhDYXAgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAoc291dGggPT09IC1NYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08pIHsKICAgICAgICAgIHNvdXRoQ2FwID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgbGV0IGR4OwogICAgICAgIGNvbnN0IGR5ID0gbm9ydGggLSBzb3V0aDsKICAgICAgICBpZiAod2VzdCA+IGVhc3QpIHsKICAgICAgICAgIGR4ID0gTWF0aF9kZWZhdWx0LlRXT19QSSAtIHdlc3QgKyBlYXN0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkeCA9IGVhc3QgLSB3ZXN0OwogICAgICAgIH0KICAgICAgICBjb25zdCB3aWR0aCA9IE1hdGguY2VpbChkeCAvIGdyYW51bGFyaXR5KSArIDE7CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gTWF0aC5jZWlsKGR5IC8gZ3JhbnVsYXJpdHkpICsgMTsKICAgICAgICBjb25zdCBncmFudWxhcml0eVggPSBkeCAvICh3aWR0aCAtIDEpOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5WSA9IGR5IC8gKGhlaWdodCAtIDEpOwogICAgICAgIGNvbnN0IG53Q29ybmVyID0gUmVjdGFuZ2xlX2RlZmF1bHQubm9ydGh3ZXN0KHJlY3RhbmdsZSwgbndDb3JuZXJSZXN1bHQpOwogICAgICAgIGNvbnN0IGNlbnRlciA9IFJlY3RhbmdsZV9kZWZhdWx0LmNlbnRlcihyZWN0YW5nbGUsIGNlbnRlclNjcmF0Y2gzKTsKICAgICAgICBpZiAocm90YXRpb24gIT09IDAgfHwgc3RSb3RhdGlvbiAhPT0gMCkgewogICAgICAgICAgaWYgKGNlbnRlci5sb25naXR1ZGUgPCBud0Nvcm5lci5sb25naXR1ZGUpIHsKICAgICAgICAgICAgY2VudGVyLmxvbmdpdHVkZSArPSBNYXRoX2RlZmF1bHQuVFdPX1BJOwogICAgICAgICAgfQogICAgICAgICAgY2VudGVyQ2FydGVzaWFuID0gcHJvai5wcm9qZWN0KGNlbnRlciwgY2VudGVyQ2FydGVzaWFuKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ3JhbllDb3MgPSBncmFudWxhcml0eVk7CiAgICAgICAgY29uc3QgZ3JhblhDb3MgPSBncmFudWxhcml0eVg7CiAgICAgICAgY29uc3QgZ3JhbllTaW4gPSAwOwogICAgICAgIGNvbnN0IGdyYW5YU2luID0gMDsKICAgICAgICBjb25zdCBib3VuZGluZ1JlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNsb25lKAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGVTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBjb21wdXRlZE9wdGlvbnMgPSB7CiAgICAgICAgICBncmFuWUNvcywKICAgICAgICAgIGdyYW5ZU2luLAogICAgICAgICAgZ3JhblhDb3MsCiAgICAgICAgICBncmFuWFNpbiwKICAgICAgICAgIG53Q29ybmVyLAogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUsCiAgICAgICAgICB3aWR0aCwKICAgICAgICAgIGhlaWdodCwKICAgICAgICAgIG5vcnRoQ2FwLAogICAgICAgICAgc291dGhDYXAKICAgICAgICB9OwogICAgICAgIGlmIChyb3RhdGlvbiAhPT0gMCkgewogICAgICAgICAgY29uc3Qgcm90YXRpb25PcHRpb25zID0gZ2V0Um90YXRpb25PcHRpb25zKAogICAgICAgICAgICBud0Nvcm5lciwKICAgICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICAgIGdyYW51bGFyaXR5WCwKICAgICAgICAgICAgZ3JhbnVsYXJpdHlZLAogICAgICAgICAgICBjZW50ZXIsCiAgICAgICAgICAgIHdpZHRoLAogICAgICAgICAgICBoZWlnaHQKICAgICAgICAgICk7CiAgICAgICAgICBub3J0aCA9IHJvdGF0aW9uT3B0aW9ucy5ub3J0aDsKICAgICAgICAgIHNvdXRoID0gcm90YXRpb25PcHRpb25zLnNvdXRoOwogICAgICAgICAgZWFzdCA9IHJvdGF0aW9uT3B0aW9ucy5lYXN0OwogICAgICAgICAgd2VzdCA9IHJvdGF0aW9uT3B0aW9ucy53ZXN0OwogICAgICAgICAgaWYgKG5vcnRoIDwgLU1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyB8fCBub3J0aCA+IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTyB8fCBzb3V0aCA8IC1NYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08gfHwgc291dGggPiBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICAgIlJvdGF0ZWQgcmVjdGFuZ2xlIGlzIGludmFsaWQuICBJdCBjcm9zc2VzIG92ZXIgZWl0aGVyIHRoZSBub3J0aCBvciBzb3V0aCBwb2xlLiIKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucy5ncmFuWUNvcyA9IHJvdGF0aW9uT3B0aW9ucy5ncmFuWUNvczsKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucy5ncmFuWVNpbiA9IHJvdGF0aW9uT3B0aW9ucy5ncmFuWVNpbjsKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucy5ncmFuWENvcyA9IHJvdGF0aW9uT3B0aW9ucy5ncmFuWENvczsKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucy5ncmFuWFNpbiA9IHJvdGF0aW9uT3B0aW9ucy5ncmFuWFNpbjsKICAgICAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlLm5vcnRoID0gbm9ydGg7CiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZS5zb3V0aCA9IHNvdXRoOwogICAgICAgICAgYm91bmRpbmdSZWN0YW5nbGUuZWFzdCA9IGVhc3Q7CiAgICAgICAgICBib3VuZGluZ1JlY3RhbmdsZS53ZXN0ID0gd2VzdDsKICAgICAgICB9CiAgICAgICAgaWYgKHN0Um90YXRpb24gIT09IDApIHsKICAgICAgICAgIHJvdGF0aW9uID0gcm90YXRpb24gLSBzdFJvdGF0aW9uOwogICAgICAgICAgY29uc3Qgc3ROd0Nvcm5lciA9IFJlY3RhbmdsZV9kZWZhdWx0Lm5vcnRod2VzdChib3VuZGluZ1JlY3RhbmdsZSwgc3ROd0Nvcm5lclJlc3VsdCk7CiAgICAgICAgICBjb25zdCBzdFJvdGF0aW9uT3B0aW9ucyA9IGdldFJvdGF0aW9uT3B0aW9ucygKICAgICAgICAgICAgc3ROd0Nvcm5lciwKICAgICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICAgIGdyYW51bGFyaXR5WCwKICAgICAgICAgICAgZ3JhbnVsYXJpdHlZLAogICAgICAgICAgICBjZW50ZXIsCiAgICAgICAgICAgIHdpZHRoLAogICAgICAgICAgICBoZWlnaHQKICAgICAgICAgICk7CiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMuc3RHcmFuWUNvcyA9IHN0Um90YXRpb25PcHRpb25zLmdyYW5ZQ29zOwogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLnN0R3JhblhDb3MgPSBzdFJvdGF0aW9uT3B0aW9ucy5ncmFuWENvczsKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucy5zdEdyYW5ZU2luID0gc3RSb3RhdGlvbk9wdGlvbnMuZ3JhbllTaW47CiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMuc3RHcmFuWFNpbiA9IHN0Um90YXRpb25PcHRpb25zLmdyYW5YU2luOwogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLnN0TndDb3JuZXIgPSBzdE53Q29ybmVyOwogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLnN0V2VzdCA9IHN0Um90YXRpb25PcHRpb25zLndlc3Q7CiAgICAgICAgICBjb21wdXRlZE9wdGlvbnMuc3RTb3V0aCA9IHN0Um90YXRpb25PcHRpb25zLnNvdXRoOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29tcHV0ZWRPcHRpb25zOwogICAgICB9OwogICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdCA9IFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlY3RhbmdsZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gY3JlYXRlQXR0cmlidXRlcyh2ZXJ0ZXhGb3JtYXQsIGF0dHJpYnV0ZXMpIHsKICAgIGNvbnN0IGdlbyA9IG5ldyBHZW9tZXRyeV9kZWZhdWx0KHsKICAgICAgYXR0cmlidXRlczogbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCksCiAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5UUklBTkdMRVMKICAgIH0pOwogICAgZ2VvLmF0dHJpYnV0ZXMucG9zaXRpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgdmFsdWVzOiBhdHRyaWJ1dGVzLnBvc2l0aW9ucwogICAgfSk7CiAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICBnZW8uYXR0cmlidXRlcy5ub3JtYWwgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGF0dHJpYnV0ZXMubm9ybWFscwogICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICBnZW8uYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBhdHRyaWJ1dGVzLnRhbmdlbnRzCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgZ2VvLmF0dHJpYnV0ZXMuYml0YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgdmFsdWVzOiBhdHRyaWJ1dGVzLmJpdGFuZ2VudHMKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gZ2VvOwogIH0KICBmdW5jdGlvbiBjYWxjdWxhdGVBdHRyaWJ1dGVzKHBvc2l0aW9ucywgdmVydGV4Rm9ybWF0LCBlbGxpcHNvaWQsIHRhbmdlbnRSb3RhdGlvbk1hdHJpeCkgewogICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgY29uc3QgdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoKSA6IHZvaWQgMDsKICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgbGV0IGF0dHJJbmRleCA9IDA7CiAgICBjb25zdCBiaXRhbmdlbnQgPSBiaXRhbmdlbnRTY3JhdGNoMjsKICAgIGNvbnN0IHRhbmdlbnQgPSB0YW5nZW50U2NyYXRjaDI7CiAgICBsZXQgbm9ybWFsMiA9IG5vcm1hbFNjcmF0Y2g0OwogICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICAgICAgY29uc3QgcCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpLCBwb3NpdGlvblNjcmF0Y2gyKTsKICAgICAgICBjb25zdCBhdHRySW5kZXgxID0gYXR0ckluZGV4ICsgMTsKICAgICAgICBjb25zdCBhdHRySW5kZXgyID0gYXR0ckluZGV4ICsgMjsKICAgICAgICBub3JtYWwyID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwLCBub3JtYWwyKTsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKENhcnRlc2lhbjNfZGVmYXVsdC5VTklUX1osIG5vcm1hbDIsIHRhbmdlbnQpOwogICAgICAgICAgTWF0cml4M19kZWZhdWx0Lm11bHRpcGx5QnlWZWN0b3IodGFuZ2VudFJvdGF0aW9uTWF0cml4LCB0YW5nZW50LCB0YW5nZW50KTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUodGFuZ2VudCwgdGFuZ2VudCk7CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCB0YW5nZW50LCBiaXRhbmdlbnQpLAogICAgICAgICAgICAgIGJpdGFuZ2VudAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgbm9ybWFsc1thdHRySW5kZXhdID0gbm9ybWFsMi54OwogICAgICAgICAgbm9ybWFsc1thdHRySW5kZXgxXSA9IG5vcm1hbDIueTsKICAgICAgICAgIG5vcm1hbHNbYXR0ckluZGV4Ml0gPSBub3JtYWwyLno7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4XSA9IHRhbmdlbnQueDsKICAgICAgICAgIHRhbmdlbnRzW2F0dHJJbmRleDFdID0gdGFuZ2VudC55OwogICAgICAgICAgdGFuZ2VudHNbYXR0ckluZGV4Ml0gPSB0YW5nZW50Lno7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBiaXRhbmdlbnRzW2F0dHJJbmRleF0gPSBiaXRhbmdlbnQueDsKICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4MV0gPSBiaXRhbmdlbnQueTsKICAgICAgICAgIGJpdGFuZ2VudHNbYXR0ckluZGV4Ml0gPSBiaXRhbmdlbnQuejsKICAgICAgICB9CiAgICAgICAgYXR0ckluZGV4ICs9IDM7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjcmVhdGVBdHRyaWJ1dGVzKHZlcnRleEZvcm1hdCwgewogICAgICBwb3NpdGlvbnMsCiAgICAgIG5vcm1hbHMsCiAgICAgIHRhbmdlbnRzLAogICAgICBiaXRhbmdlbnRzCiAgICB9KTsKICB9CiAgZnVuY3Rpb24gY2FsY3VsYXRlQXR0cmlidXRlc1dhbGwocG9zaXRpb25zLCB2ZXJ0ZXhGb3JtYXQsIGVsbGlwc29pZCkgewogICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgY29uc3QgdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkobGVuZ3RoKSA6IHZvaWQgMDsKICAgIGNvbnN0IGJpdGFuZ2VudHMgPSB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgbGV0IG5vcm1hbEluZGV4ID0gMDsKICAgIGxldCB0YW5nZW50SW5kZXggPSAwOwogICAgbGV0IGJpdGFuZ2VudEluZGV4ID0gMDsKICAgIGxldCByZWNvbXB1dGVOb3JtYWwgPSB0cnVlOwogICAgbGV0IGJpdGFuZ2VudCA9IGJpdGFuZ2VudFNjcmF0Y2gyOwogICAgbGV0IHRhbmdlbnQgPSB0YW5nZW50U2NyYXRjaDI7CiAgICBsZXQgbm9ybWFsMiA9IG5vcm1hbFNjcmF0Y2g0OwogICAgaWYgKHZlcnRleEZvcm1hdC5ub3JtYWwgfHwgdmVydGV4Rm9ybWF0LnRhbmdlbnQgfHwgdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSA2KSB7CiAgICAgICAgY29uc3QgcCA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBpLCBwb3NpdGlvblNjcmF0Y2gyKTsKICAgICAgICBjb25zdCBwMSA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCAoaSArIDYpICUgbGVuZ3RoLCB2MVNjcmF0Y2gpOwogICAgICAgIGlmIChyZWNvbXB1dGVOb3JtYWwpIHsKICAgICAgICAgIGNvbnN0IHAyID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIChpICsgMykgJSBsZW5ndGgsIHYyU2NyYXRjaCk7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDEsIHAsIHAxKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwMiwgcCwgcDIpOwogICAgICAgICAgbm9ybWFsMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHAyLCBwMSwgbm9ybWFsMiksIG5vcm1hbDIpOwogICAgICAgICAgcmVjb21wdXRlTm9ybWFsID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwMSwgcCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkpIHsKICAgICAgICAgIHJlY29tcHV0ZU5vcm1hbCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBiaXRhbmdlbnQgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHAsIGJpdGFuZ2VudCk7CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgICAgdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGJpdGFuZ2VudCwgbm9ybWFsMiwgdGFuZ2VudCksCiAgICAgICAgICAgICAgdGFuZ2VudAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCkgewogICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLnk7CiAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi56OwogICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLnk7CiAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi56OwogICAgICAgIH0KICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnRhbmdlbnQpIHsKICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueDsKICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQuejsKICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueDsKICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQuejsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueDsKICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueTsKICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueDsKICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQueTsKICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjcmVhdGVBdHRyaWJ1dGVzKHZlcnRleEZvcm1hdCwgewogICAgICBwb3NpdGlvbnMsCiAgICAgIG5vcm1hbHMsCiAgICAgIHRhbmdlbnRzLAogICAgICBiaXRhbmdlbnRzCiAgICB9KTsKICB9CiAgZnVuY3Rpb24gY29uc3RydWN0UmVjdGFuZ2xlKHJlY3RhbmdsZUdlb21ldHJ5LCBjb21wdXRlZE9wdGlvbnMpIHsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQ7CiAgICBjb25zdCBlbGxpcHNvaWQgPSByZWN0YW5nbGVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgY29uc3QgaGVpZ2h0ID0gY29tcHV0ZWRPcHRpb25zLmhlaWdodDsKICAgIGNvbnN0IHdpZHRoID0gY29tcHV0ZWRPcHRpb25zLndpZHRoOwogICAgY29uc3Qgbm9ydGhDYXAgPSBjb21wdXRlZE9wdGlvbnMubm9ydGhDYXA7CiAgICBjb25zdCBzb3V0aENhcCA9IGNvbXB1dGVkT3B0aW9ucy5zb3V0aENhcDsKICAgIGxldCByb3dTdGFydCA9IDA7CiAgICBsZXQgcm93RW5kID0gaGVpZ2h0OwogICAgbGV0IHJvd0hlaWdodCA9IGhlaWdodDsKICAgIGxldCBzaXplID0gMDsKICAgIGlmIChub3J0aENhcCkgewogICAgICByb3dTdGFydCA9IDE7CiAgICAgIHJvd0hlaWdodCAtPSAxOwogICAgICBzaXplICs9IDE7CiAgICB9CiAgICBpZiAoc291dGhDYXApIHsKICAgICAgcm93RW5kIC09IDE7CiAgICAgIHJvd0hlaWdodCAtPSAxOwogICAgICBzaXplICs9IDE7CiAgICB9CiAgICBzaXplICs9IHdpZHRoICogcm93SGVpZ2h0OwogICAgY29uc3QgcG9zaXRpb25zID0gdmVydGV4Rm9ybWF0LnBvc2l0aW9uID8gbmV3IEZsb2F0NjRBcnJheShzaXplICogMykgOiB2b2lkIDA7CiAgICBjb25zdCB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSB2ZXJ0ZXhGb3JtYXQuc3QgPyBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAyKSA6IHZvaWQgMDsKICAgIGxldCBwb3NJbmRleCA9IDA7CiAgICBsZXQgc3RJbmRleCA9IDA7CiAgICBjb25zdCBwb3NpdGlvbiA9IHBvc2l0aW9uU2NyYXRjaDI7CiAgICBjb25zdCBzdCA9IHN0U2NyYXRjaDI7CiAgICBsZXQgbWluWCA9IE51bWJlci5NQVhfVkFMVUU7CiAgICBsZXQgbWluWSA9IE51bWJlci5NQVhfVkFMVUU7CiAgICBsZXQgbWF4WCA9IC1OdW1iZXIuTUFYX1ZBTFVFOwogICAgbGV0IG1heFkgPSAtTnVtYmVyLk1BWF9WQUxVRTsKICAgIGZvciAobGV0IHJvdyA9IHJvd1N0YXJ0OyByb3cgPCByb3dFbmQ7ICsrcm93KSB7CiAgICAgIGZvciAobGV0IGNvbCA9IDA7IGNvbCA8IHdpZHRoOyArK2NvbCkgewogICAgICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgICAgIGNvbXB1dGVkT3B0aW9ucywKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHZlcnRleEZvcm1hdC5zdCwKICAgICAgICAgIHJvdywKICAgICAgICAgIGNvbCwKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc3QKICAgICAgICApOwogICAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi56OwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gc3QueDsKICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gc3QueTsKICAgICAgICAgIG1pblggPSBNYXRoLm1pbihtaW5YLCBzdC54KTsKICAgICAgICAgIG1pblkgPSBNYXRoLm1pbihtaW5ZLCBzdC55KTsKICAgICAgICAgIG1heFggPSBNYXRoLm1heChtYXhYLCBzdC54KTsKICAgICAgICAgIG1heFkgPSBNYXRoLm1heChtYXhZLCBzdC55KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChub3J0aENhcCkgewogICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICB2ZXJ0ZXhGb3JtYXQuc3QsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIHBvc2l0aW9uLAogICAgICAgIHN0CiAgICAgICk7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IHN0Lng7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzdC55OwogICAgICAgIG1pblggPSBzdC54OwogICAgICAgIG1pblkgPSBzdC55OwogICAgICAgIG1heFggPSBzdC54OwogICAgICAgIG1heFkgPSBzdC55OwogICAgICB9CiAgICB9CiAgICBpZiAoc291dGhDYXApIHsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICAgIGNvbXB1dGVkT3B0aW9ucywKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgdmVydGV4Rm9ybWF0LnN0LAogICAgICAgIGhlaWdodCAtIDEsCiAgICAgICAgMCwKICAgICAgICBwb3NpdGlvbiwKICAgICAgICBzdAogICAgICApOwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi54OwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICBwb3NpdGlvbnNbcG9zSW5kZXhdID0gcG9zaXRpb24uejsKICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gc3QueDsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleF0gPSBzdC55OwogICAgICAgIG1pblggPSBNYXRoLm1pbihtaW5YLCBzdC54KTsKICAgICAgICBtaW5ZID0gTWF0aC5taW4obWluWSwgc3QueSk7CiAgICAgICAgbWF4WCA9IE1hdGgubWF4KG1heFgsIHN0LngpOwogICAgICAgIG1heFkgPSBNYXRoLm1heChtYXhZLCBzdC55KTsKICAgICAgfQogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC5zdCAmJiAobWluWCA8IDAgfHwgbWluWSA8IDAgfHwgbWF4WCA+IDEgfHwgbWF4WSA+IDEpKSB7CiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgdGV4dHVyZUNvb3JkaW5hdGVzLmxlbmd0aDsgayArPSAyKSB7CiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW2tdID0gKHRleHR1cmVDb29yZGluYXRlc1trXSAtIG1pblgpIC8gKG1heFggLSBtaW5YKTsKICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbayArIDFdID0gKHRleHR1cmVDb29yZGluYXRlc1trICsgMV0gLSBtaW5ZKSAvIChtYXhZIC0gbWluWSk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGdlbyA9IGNhbGN1bGF0ZUF0dHJpYnV0ZXMoCiAgICAgIHBvc2l0aW9ucywKICAgICAgdmVydGV4Rm9ybWF0LAogICAgICBlbGxpcHNvaWQsCiAgICAgIGNvbXB1dGVkT3B0aW9ucy50YW5nZW50Um90YXRpb25NYXRyaXgKICAgICk7CiAgICBsZXQgaW5kaWNlc1NpemUgPSA2ICogKHdpZHRoIC0gMSkgKiAocm93SGVpZ2h0IC0gMSk7CiAgICBpZiAobm9ydGhDYXApIHsKICAgICAgaW5kaWNlc1NpemUgKz0gMyAqICh3aWR0aCAtIDEpOwogICAgfQogICAgaWYgKHNvdXRoQ2FwKSB7CiAgICAgIGluZGljZXNTaXplICs9IDMgKiAod2lkdGggLSAxKTsKICAgIH0KICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheShzaXplLCBpbmRpY2VzU2l6ZSk7CiAgICBsZXQgaW5kZXggPSAwOwogICAgbGV0IGluZGljZXNJbmRleCA9IDA7CiAgICBsZXQgaTsKICAgIGZvciAoaSA9IDA7IGkgPCByb3dIZWlnaHQgLSAxOyArK2kpIHsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB3aWR0aCAtIDE7ICsraikgewogICAgICAgIGNvbnN0IHVwcGVyTGVmdCA9IGluZGV4OwogICAgICAgIGNvbnN0IGxvd2VyTGVmdCA9IHVwcGVyTGVmdCArIHdpZHRoOwogICAgICAgIGNvbnN0IGxvd2VyUmlnaHQgPSBsb3dlckxlZnQgKyAxOwogICAgICAgIGNvbnN0IHVwcGVyUmlnaHQgPSB1cHBlckxlZnQgKyAxOwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gdXBwZXJMZWZ0OwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gbG93ZXJMZWZ0OwogICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gdXBwZXJSaWdodDsKICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHVwcGVyUmlnaHQ7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBsb3dlckxlZnQ7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBsb3dlclJpZ2h0OwogICAgICAgICsraW5kZXg7CiAgICAgIH0KICAgICAgKytpbmRleDsKICAgIH0KICAgIGlmIChub3J0aENhcCB8fCBzb3V0aENhcCkgewogICAgICBsZXQgbm9ydGhJbmRleCA9IHNpemUgLSAxOwogICAgICBjb25zdCBzb3V0aEluZGV4ID0gc2l6ZSAtIDE7CiAgICAgIGlmIChub3J0aENhcCAmJiBzb3V0aENhcCkgewogICAgICAgIG5vcnRoSW5kZXggPSBzaXplIC0gMjsKICAgICAgfQogICAgICBsZXQgcDE7CiAgICAgIGxldCBwMjsKICAgICAgaW5kZXggPSAwOwogICAgICBpZiAobm9ydGhDYXApIHsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgd2lkdGggLSAxOyBpKyspIHsKICAgICAgICAgIHAxID0gaW5kZXg7CiAgICAgICAgICBwMiA9IHAxICsgMTsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gbm9ydGhJbmRleDsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcDE7CiAgICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHAyOwogICAgICAgICAgKytpbmRleDsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHNvdXRoQ2FwKSB7CiAgICAgICAgaW5kZXggPSAocm93SGVpZ2h0IC0gMSkgKiB3aWR0aDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgd2lkdGggLSAxOyBpKyspIHsKICAgICAgICAgIHAxID0gaW5kZXg7CiAgICAgICAgICBwMiA9IHAxICsgMTsKICAgICAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gcDE7CiAgICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHNvdXRoSW5kZXg7CiAgICAgICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHAyOwogICAgICAgICAgKytpbmRleDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGdlby5pbmRpY2VzID0gaW5kaWNlczsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgZ2VvLmF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICB2YWx1ZXM6IHRleHR1cmVDb29yZGluYXRlcwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBnZW87CiAgfQogIGZ1bmN0aW9uIGFkZFdhbGxQb3NpdGlvbnMyKHdhbGxQb3NpdGlvbnMsIHBvc0luZGV4LCBpLCB0b3BQb3NpdGlvbnMsIGJvdHRvbVBvc2l0aW9ucykgewogICAgd2FsbFBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHRvcFBvc2l0aW9uc1tpXTsKICAgIHdhbGxQb3NpdGlvbnNbcG9zSW5kZXgrK10gPSB0b3BQb3NpdGlvbnNbaSArIDFdOwogICAgd2FsbFBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHRvcFBvc2l0aW9uc1tpICsgMl07CiAgICB3YWxsUG9zaXRpb25zW3Bvc0luZGV4KytdID0gYm90dG9tUG9zaXRpb25zW2ldOwogICAgd2FsbFBvc2l0aW9uc1twb3NJbmRleCsrXSA9IGJvdHRvbVBvc2l0aW9uc1tpICsgMV07CiAgICB3YWxsUG9zaXRpb25zW3Bvc0luZGV4XSA9IGJvdHRvbVBvc2l0aW9uc1tpICsgMl07CiAgICByZXR1cm4gd2FsbFBvc2l0aW9uczsKICB9CiAgZnVuY3Rpb24gYWRkV2FsbFRleHR1cmVDb29yZGluYXRlcyh3YWxsVGV4dHVyZXMsIHN0SW5kZXgsIGksIHN0KSB7CiAgICB3YWxsVGV4dHVyZXNbc3RJbmRleCsrXSA9IHN0W2ldOwogICAgd2FsbFRleHR1cmVzW3N0SW5kZXgrK10gPSBzdFtpICsgMV07CiAgICB3YWxsVGV4dHVyZXNbc3RJbmRleCsrXSA9IHN0W2ldOwogICAgd2FsbFRleHR1cmVzW3N0SW5kZXhdID0gc3RbaSArIDFdOwogICAgcmV0dXJuIHdhbGxUZXh0dXJlczsKICB9CiAgZnVuY3Rpb24gY29uc3RydWN0RXh0cnVkZWRSZWN0YW5nbGUocmVjdGFuZ2xlR2VvbWV0cnksIGNvbXB1dGVkT3B0aW9ucykgewogICAgY29uc3Qgc2hhZG93Vm9sdW1lID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3NoYWRvd1ZvbHVtZTsKICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZVZhbHVlID0gcmVjdGFuZ2xlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZTsKICAgIGNvbnN0IHZlcnRleEZvcm1hdCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQ7CiAgICBjb25zdCBtaW5IZWlnaHQgPSByZWN0YW5nbGVHZW9tZXRyeS5fZXh0cnVkZWRIZWlnaHQ7CiAgICBjb25zdCBtYXhIZWlnaHQgPSByZWN0YW5nbGVHZW9tZXRyeS5fc3VyZmFjZUhlaWdodDsKICAgIGNvbnN0IGVsbGlwc29pZCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICBjb25zdCBoZWlnaHQgPSBjb21wdXRlZE9wdGlvbnMuaGVpZ2h0OwogICAgY29uc3Qgd2lkdGggPSBjb21wdXRlZE9wdGlvbnMud2lkdGg7CiAgICBsZXQgaTsKICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgY29uc3QgbmV3VmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUoCiAgICAgICAgdmVydGV4Rm9ybWF0LAogICAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMgogICAgICApOwogICAgICBuZXdWZXJ0ZXhGb3JtYXQubm9ybWFsID0gdHJ1ZTsKICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3ZlcnRleEZvcm1hdCA9IG5ld1ZlcnRleEZvcm1hdDsKICAgIH0KICAgIGNvbnN0IHRvcEJvdHRvbUdlbyA9IGNvbnN0cnVjdFJlY3RhbmdsZShyZWN0YW5nbGVHZW9tZXRyeSwgY29tcHV0ZWRPcHRpb25zKTsKICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3ZlcnRleEZvcm1hdCA9IHZlcnRleEZvcm1hdDsKICAgIH0KICAgIGxldCB0b3BQb3NpdGlvbnMgPSBQb2x5Z29uUGlwZWxpbmVfZGVmYXVsdC5zY2FsZVRvR2VvZGV0aWNIZWlnaHQoCiAgICAgIHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgbWF4SGVpZ2h0LAogICAgICBlbGxpcHNvaWQsCiAgICAgIGZhbHNlCiAgICApOwogICAgdG9wUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSh0b3BQb3NpdGlvbnMpOwogICAgbGV0IGxlbmd0aCA9IHRvcFBvc2l0aW9ucy5sZW5ndGg7CiAgICBjb25zdCBuZXdMZW5ndGggPSBsZW5ndGggKiAyOwogICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShuZXdMZW5ndGgpOwogICAgcG9zaXRpb25zLnNldCh0b3BQb3NpdGlvbnMpOwogICAgY29uc3QgYm90dG9tUG9zaXRpb25zID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgIG1pbkhlaWdodCwKICAgICAgZWxsaXBzb2lkCiAgICApOwogICAgcG9zaXRpb25zLnNldChib3R0b21Qb3NpdGlvbnMsIGxlbmd0aCk7CiAgICB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMgPSBwb3NpdGlvbnM7CiAgICBjb25zdCBub3JtYWxzID0gdmVydGV4Rm9ybWF0Lm5vcm1hbCA/IG5ldyBGbG9hdDMyQXJyYXkobmV3TGVuZ3RoKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LnRhbmdlbnQgPyBuZXcgRmxvYXQzMkFycmF5KG5ld0xlbmd0aCkgOiB2b2lkIDA7CiAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkobmV3TGVuZ3RoKSA6IHZvaWQgMDsKICAgIGNvbnN0IHRleHR1cmVzID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheShuZXdMZW5ndGggLyAzICogMikgOiB2b2lkIDA7CiAgICBsZXQgdG9wU3Q7CiAgICBsZXQgdG9wTm9ybWFsczsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgIHRvcE5vcm1hbHMgPSB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5ub3JtYWwudmFsdWVzOwogICAgICBub3JtYWxzLnNldCh0b3BOb3JtYWxzKTsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgdG9wTm9ybWFsc1tpXSA9IC10b3BOb3JtYWxzW2ldOwogICAgICB9CiAgICAgIG5vcm1hbHMuc2V0KHRvcE5vcm1hbHMsIGxlbmd0aCk7CiAgICAgIHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLm5vcm1hbC52YWx1ZXMgPSBub3JtYWxzOwogICAgfQogICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICB0b3BOb3JtYWxzID0gdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMubm9ybWFsLnZhbHVlczsKICAgICAgaWYgKCF2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMubm9ybWFsID0gdm9pZCAwOwogICAgICB9CiAgICAgIGNvbnN0IGV4dHJ1ZGVOb3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheShuZXdMZW5ndGgpOwogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICB0b3BOb3JtYWxzW2ldID0gLXRvcE5vcm1hbHNbaV07CiAgICAgIH0KICAgICAgZXh0cnVkZU5vcm1hbHMuc2V0KHRvcE5vcm1hbHMsIGxlbmd0aCk7CiAgICAgIHRvcEJvdHRvbUdlby5hdHRyaWJ1dGVzLmV4dHJ1ZGVEaXJlY3Rpb24gPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICB2YWx1ZXM6IGV4dHJ1ZGVOb3JtYWxzCiAgICAgIH0pOwogICAgfQogICAgbGV0IG9mZnNldFZhbHVlOwogICAgY29uc3QgaGFzT2Zmc2V0cyA9IGRlZmluZWRfZGVmYXVsdChvZmZzZXRBdHRyaWJ1dGVWYWx1ZSk7CiAgICBpZiAoaGFzT2Zmc2V0cykgewogICAgICBjb25zdCBzaXplID0gbGVuZ3RoIC8gMyAqIDI7CiAgICAgIGxldCBvZmZzZXRBdHRyaWJ1dGUgPSBuZXcgVWludDhBcnJheShzaXplKTsKICAgICAgaWYgKG9mZnNldEF0dHJpYnV0ZVZhbHVlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0LlRPUCkgewogICAgICAgIG9mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZS5maWxsKDEsIDAsIHNpemUgLyAyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvZmZzZXRWYWx1ZSA9IG9mZnNldEF0dHJpYnV0ZVZhbHVlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUuZmlsbChvZmZzZXRWYWx1ZSk7CiAgICAgIH0KICAgICAgdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgIHZhbHVlczogb2Zmc2V0QXR0cmlidXRlCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgIGNvbnN0IHRvcFRhbmdlbnRzID0gdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMudGFuZ2VudC52YWx1ZXM7CiAgICAgIHRhbmdlbnRzLnNldCh0b3BUYW5nZW50cyk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHRvcFRhbmdlbnRzW2ldID0gLXRvcFRhbmdlbnRzW2ldOwogICAgICB9CiAgICAgIHRhbmdlbnRzLnNldCh0b3BUYW5nZW50cywgbGVuZ3RoKTsKICAgICAgdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMudGFuZ2VudC52YWx1ZXMgPSB0YW5nZW50czsKICAgIH0KICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgIGNvbnN0IHRvcEJpdGFuZ2VudHMgPSB0b3BCb3R0b21HZW8uYXR0cmlidXRlcy5iaXRhbmdlbnQudmFsdWVzOwogICAgICBiaXRhbmdlbnRzLnNldCh0b3BCaXRhbmdlbnRzKTsKICAgICAgYml0YW5nZW50cy5zZXQodG9wQml0YW5nZW50cywgbGVuZ3RoKTsKICAgICAgdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMuYml0YW5nZW50LnZhbHVlcyA9IGJpdGFuZ2VudHM7CiAgICB9CiAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgIHRvcFN0ID0gdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMuc3QudmFsdWVzOwogICAgICB0ZXh0dXJlcy5zZXQodG9wU3QpOwogICAgICB0ZXh0dXJlcy5zZXQodG9wU3QsIGxlbmd0aCAvIDMgKiAyKTsKICAgICAgdG9wQm90dG9tR2VvLmF0dHJpYnV0ZXMuc3QudmFsdWVzID0gdGV4dHVyZXM7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gdG9wQm90dG9tR2VvLmluZGljZXM7CiAgICBjb25zdCBpbmRpY2VzTGVuZ3RoID0gaW5kaWNlcy5sZW5ndGg7CiAgICBjb25zdCBwb3NMZW5ndGggPSBsZW5ndGggLyAzOwogICAgY29uc3QgbmV3SW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBuZXdMZW5ndGggLyAzLAogICAgICBpbmRpY2VzTGVuZ3RoICogMgogICAgKTsKICAgIG5ld0luZGljZXMuc2V0KGluZGljZXMpOwogICAgZm9yIChpID0gMDsgaSA8IGluZGljZXNMZW5ndGg7IGkgKz0gMykgewogICAgICBuZXdJbmRpY2VzW2kgKyBpbmRpY2VzTGVuZ3RoXSA9IGluZGljZXNbaSArIDJdICsgcG9zTGVuZ3RoOwogICAgICBuZXdJbmRpY2VzW2kgKyAxICsgaW5kaWNlc0xlbmd0aF0gPSBpbmRpY2VzW2kgKyAxXSArIHBvc0xlbmd0aDsKICAgICAgbmV3SW5kaWNlc1tpICsgMiArIGluZGljZXNMZW5ndGhdID0gaW5kaWNlc1tpXSArIHBvc0xlbmd0aDsKICAgIH0KICAgIHRvcEJvdHRvbUdlby5pbmRpY2VzID0gbmV3SW5kaWNlczsKICAgIGNvbnN0IG5vcnRoQ2FwID0gY29tcHV0ZWRPcHRpb25zLm5vcnRoQ2FwOwogICAgY29uc3Qgc291dGhDYXAgPSBjb21wdXRlZE9wdGlvbnMuc291dGhDYXA7CiAgICBsZXQgcm93SGVpZ2h0ID0gaGVpZ2h0OwogICAgbGV0IHdpZHRoTXVsdGlwbGllciA9IDI7CiAgICBsZXQgcGVyaW1ldGVyUG9zaXRpb25zID0gMDsKICAgIGxldCBjb3JuZXJzID0gNDsKICAgIGxldCBkdXBsaWF0ZUNvcm5lcnMgPSA0OwogICAgaWYgKG5vcnRoQ2FwKSB7CiAgICAgIHdpZHRoTXVsdGlwbGllciAtPSAxOwogICAgICByb3dIZWlnaHQgLT0gMTsKICAgICAgcGVyaW1ldGVyUG9zaXRpb25zICs9IDE7CiAgICAgIGNvcm5lcnMgLT0gMjsKICAgICAgZHVwbGlhdGVDb3JuZXJzIC09IDE7CiAgICB9CiAgICBpZiAoc291dGhDYXApIHsKICAgICAgd2lkdGhNdWx0aXBsaWVyIC09IDE7CiAgICAgIHJvd0hlaWdodCAtPSAxOwogICAgICBwZXJpbWV0ZXJQb3NpdGlvbnMgKz0gMTsKICAgICAgY29ybmVycyAtPSAyOwogICAgICBkdXBsaWF0ZUNvcm5lcnMgLT0gMTsKICAgIH0KICAgIHBlcmltZXRlclBvc2l0aW9ucyArPSB3aWR0aE11bHRpcGxpZXIgKiB3aWR0aCArIDIgKiByb3dIZWlnaHQgLSBjb3JuZXJzOwogICAgY29uc3Qgd2FsbENvdW50ID0gKHBlcmltZXRlclBvc2l0aW9ucyArIGR1cGxpYXRlQ29ybmVycykgKiAyOwogICAgbGV0IHdhbGxQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHdhbGxDb3VudCAqIDMpOwogICAgY29uc3Qgd2FsbEV4dHJ1ZGVOb3JtYWxzID0gc2hhZG93Vm9sdW1lID8gbmV3IEZsb2F0MzJBcnJheSh3YWxsQ291bnQgKiAzKSA6IHZvaWQgMDsKICAgIGxldCB3YWxsT2Zmc2V0QXR0cmlidXRlID0gaGFzT2Zmc2V0cyA/IG5ldyBVaW50OEFycmF5KHdhbGxDb3VudCkgOiB2b2lkIDA7CiAgICBsZXQgd2FsbFRleHR1cmVzID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheSh3YWxsQ291bnQgKiAyKSA6IHZvaWQgMDsKICAgIGNvbnN0IGNvbXB1dGVUb3BPZmZzZXRzID0gb2Zmc2V0QXR0cmlidXRlVmFsdWUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QOwogICAgaWYgKGhhc09mZnNldHMgJiYgIWNvbXB1dGVUb3BPZmZzZXRzKSB7CiAgICAgIG9mZnNldFZhbHVlID0gb2Zmc2V0QXR0cmlidXRlVmFsdWUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuQUxMID8gMSA6IDA7CiAgICAgIHdhbGxPZmZzZXRBdHRyaWJ1dGUgPSB3YWxsT2Zmc2V0QXR0cmlidXRlLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgfQogICAgbGV0IHBvc0luZGV4ID0gMDsKICAgIGxldCBzdEluZGV4ID0gMDsKICAgIGxldCBleHRydWRlTm9ybWFsSW5kZXggPSAwOwogICAgbGV0IHdhbGxPZmZzZXRJbmRleCA9IDA7CiAgICBjb25zdCBhcmVhID0gd2lkdGggKiByb3dIZWlnaHQ7CiAgICBsZXQgdGhyZWVJOwogICAgZm9yIChpID0gMDsgaSA8IGFyZWE7IGkgKz0gd2lkdGgpIHsKICAgICAgdGhyZWVJID0gaSAqIDM7CiAgICAgIHdhbGxQb3NpdGlvbnMgPSBhZGRXYWxsUG9zaXRpb25zMigKICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgIHBvc0luZGV4LAogICAgICAgIHRocmVlSSwKICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgYm90dG9tUG9zaXRpb25zCiAgICAgICk7CiAgICAgIHBvc0luZGV4ICs9IDY7CiAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICB3YWxsVGV4dHVyZXMgPSBhZGRXYWxsVGV4dHVyZUNvb3JkaW5hdGVzKAogICAgICAgICAgd2FsbFRleHR1cmVzLAogICAgICAgICAgc3RJbmRleCwKICAgICAgICAgIGkgKiAyLAogICAgICAgICAgdG9wU3QKICAgICAgICApOwogICAgICAgIHN0SW5kZXggKz0gNDsKICAgICAgfQogICAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgZXh0cnVkZU5vcm1hbEluZGV4ICs9IDM7CiAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJXTsKICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUkgKyAxXTsKICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUkgKyAyXTsKICAgICAgfQogICAgICBpZiAoY29tcHV0ZVRvcE9mZnNldHMpIHsKICAgICAgICB3YWxsT2Zmc2V0QXR0cmlidXRlW3dhbGxPZmZzZXRJbmRleCsrXSA9IDE7CiAgICAgICAgd2FsbE9mZnNldEluZGV4ICs9IDE7CiAgICAgIH0KICAgIH0KICAgIGlmICghc291dGhDYXApIHsKICAgICAgZm9yIChpID0gYXJlYSAtIHdpZHRoOyBpIDwgYXJlYTsgaSsrKSB7CiAgICAgICAgdGhyZWVJID0gaSAqIDM7CiAgICAgICAgd2FsbFBvc2l0aW9ucyA9IGFkZFdhbGxQb3NpdGlvbnMyKAogICAgICAgICAgd2FsbFBvc2l0aW9ucywKICAgICAgICAgIHBvc0luZGV4LAogICAgICAgICAgdGhyZWVJLAogICAgICAgICAgdG9wUG9zaXRpb25zLAogICAgICAgICAgYm90dG9tUG9zaXRpb25zCiAgICAgICAgKTsKICAgICAgICBwb3NJbmRleCArPSA2OwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIHdhbGxUZXh0dXJlcyA9IGFkZFdhbGxUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIHdhbGxUZXh0dXJlcywKICAgICAgICAgICAgc3RJbmRleCwKICAgICAgICAgICAgaSAqIDIsCiAgICAgICAgICAgIHRvcFN0CiAgICAgICAgICApOwogICAgICAgICAgc3RJbmRleCArPSA0OwogICAgICAgIH0KICAgICAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgICBleHRydWRlTm9ybWFsSW5kZXggKz0gMzsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSV07CiAgICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUkgKyAxXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDJdOwogICAgICAgIH0KICAgICAgICBpZiAoY29tcHV0ZVRvcE9mZnNldHMpIHsKICAgICAgICAgIHdhbGxPZmZzZXRBdHRyaWJ1dGVbd2FsbE9mZnNldEluZGV4KytdID0gMTsKICAgICAgICAgIHdhbGxPZmZzZXRJbmRleCArPSAxOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uc3Qgc291dGhJbmRleCA9IG5vcnRoQ2FwID8gYXJlYSArIDEgOiBhcmVhOwogICAgICB0aHJlZUkgPSBzb3V0aEluZGV4ICogMzsKICAgICAgZm9yIChpID0gMDsgaSA8IDI7IGkrKykgewogICAgICAgIHdhbGxQb3NpdGlvbnMgPSBhZGRXYWxsUG9zaXRpb25zMigKICAgICAgICAgIHdhbGxQb3NpdGlvbnMsCiAgICAgICAgICBwb3NJbmRleCwKICAgICAgICAgIHRocmVlSSwKICAgICAgICAgIHRvcFBvc2l0aW9ucywKICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucwogICAgICAgICk7CiAgICAgICAgcG9zSW5kZXggKz0gNjsKICAgICAgICBpZiAodmVydGV4Rm9ybWF0LnN0KSB7CiAgICAgICAgICB3YWxsVGV4dHVyZXMgPSBhZGRXYWxsVGV4dHVyZUNvb3JkaW5hdGVzKAogICAgICAgICAgICB3YWxsVGV4dHVyZXMsCiAgICAgICAgICAgIHN0SW5kZXgsCiAgICAgICAgICAgIHNvdXRoSW5kZXggKiAyLAogICAgICAgICAgICB0b3BTdAogICAgICAgICAgKTsKICAgICAgICAgIHN0SW5kZXggKz0gNDsKICAgICAgICB9CiAgICAgICAgaWYgKHNoYWRvd1ZvbHVtZSkgewogICAgICAgICAgZXh0cnVkZU5vcm1hbEluZGV4ICs9IDM7CiAgICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUldOwogICAgICAgICAgd2FsbEV4dHJ1ZGVOb3JtYWxzW2V4dHJ1ZGVOb3JtYWxJbmRleCsrXSA9IHRvcE5vcm1hbHNbdGhyZWVJICsgMV07CiAgICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUkgKyAyXTsKICAgICAgICB9CiAgICAgICAgaWYgKGNvbXB1dGVUb3BPZmZzZXRzKSB7CiAgICAgICAgICB3YWxsT2Zmc2V0QXR0cmlidXRlW3dhbGxPZmZzZXRJbmRleCsrXSA9IDE7CiAgICAgICAgICB3YWxsT2Zmc2V0SW5kZXggKz0gMTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZvciAoaSA9IGFyZWEgLSAxOyBpID4gMDsgaSAtPSB3aWR0aCkgewogICAgICB0aHJlZUkgPSBpICogMzsKICAgICAgd2FsbFBvc2l0aW9ucyA9IGFkZFdhbGxQb3NpdGlvbnMyKAogICAgICAgIHdhbGxQb3NpdGlvbnMsCiAgICAgICAgcG9zSW5kZXgsCiAgICAgICAgdGhyZWVJLAogICAgICAgIHRvcFBvc2l0aW9ucywKICAgICAgICBib3R0b21Qb3NpdGlvbnMKICAgICAgKTsKICAgICAgcG9zSW5kZXggKz0gNjsKICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgIHdhbGxUZXh0dXJlcyA9IGFkZFdhbGxUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICB3YWxsVGV4dHVyZXMsCiAgICAgICAgICBzdEluZGV4LAogICAgICAgICAgaSAqIDIsCiAgICAgICAgICB0b3BTdAogICAgICAgICk7CiAgICAgICAgc3RJbmRleCArPSA0OwogICAgICB9CiAgICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgICBleHRydWRlTm9ybWFsSW5kZXggKz0gMzsKICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUldOwogICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDFdOwogICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDJdOwogICAgICB9CiAgICAgIGlmIChjb21wdXRlVG9wT2Zmc2V0cykgewogICAgICAgIHdhbGxPZmZzZXRBdHRyaWJ1dGVbd2FsbE9mZnNldEluZGV4KytdID0gMTsKICAgICAgICB3YWxsT2Zmc2V0SW5kZXggKz0gMTsKICAgICAgfQogICAgfQogICAgaWYgKCFub3J0aENhcCkgewogICAgICBmb3IgKGkgPSB3aWR0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgdGhyZWVJID0gaSAqIDM7CiAgICAgICAgd2FsbFBvc2l0aW9ucyA9IGFkZFdhbGxQb3NpdGlvbnMyKAogICAgICAgICAgd2FsbFBvc2l0aW9ucywKICAgICAgICAgIHBvc0luZGV4LAogICAgICAgICAgdGhyZWVJLAogICAgICAgICAgdG9wUG9zaXRpb25zLAogICAgICAgICAgYm90dG9tUG9zaXRpb25zCiAgICAgICAgKTsKICAgICAgICBwb3NJbmRleCArPSA2OwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIHdhbGxUZXh0dXJlcyA9IGFkZFdhbGxUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIHdhbGxUZXh0dXJlcywKICAgICAgICAgICAgc3RJbmRleCwKICAgICAgICAgICAgaSAqIDIsCiAgICAgICAgICAgIHRvcFN0CiAgICAgICAgICApOwogICAgICAgICAgc3RJbmRleCArPSA0OwogICAgICAgIH0KICAgICAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgICBleHRydWRlTm9ybWFsSW5kZXggKz0gMzsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSV07CiAgICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUkgKyAxXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDJdOwogICAgICAgIH0KICAgICAgICBpZiAoY29tcHV0ZVRvcE9mZnNldHMpIHsKICAgICAgICAgIHdhbGxPZmZzZXRBdHRyaWJ1dGVbd2FsbE9mZnNldEluZGV4KytdID0gMTsKICAgICAgICAgIHdhbGxPZmZzZXRJbmRleCArPSAxOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uc3Qgbm9ydGhJbmRleCA9IGFyZWE7CiAgICAgIHRocmVlSSA9IG5vcnRoSW5kZXggKiAzOwogICAgICBmb3IgKGkgPSAwOyBpIDwgMjsgaSsrKSB7CiAgICAgICAgd2FsbFBvc2l0aW9ucyA9IGFkZFdhbGxQb3NpdGlvbnMyKAogICAgICAgICAgd2FsbFBvc2l0aW9ucywKICAgICAgICAgIHBvc0luZGV4LAogICAgICAgICAgdGhyZWVJLAogICAgICAgICAgdG9wUG9zaXRpb25zLAogICAgICAgICAgYm90dG9tUG9zaXRpb25zCiAgICAgICAgKTsKICAgICAgICBwb3NJbmRleCArPSA2OwogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIHdhbGxUZXh0dXJlcyA9IGFkZFdhbGxUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIHdhbGxUZXh0dXJlcywKICAgICAgICAgICAgc3RJbmRleCwKICAgICAgICAgICAgbm9ydGhJbmRleCAqIDIsCiAgICAgICAgICAgIHRvcFN0CiAgICAgICAgICApOwogICAgICAgICAgc3RJbmRleCArPSA0OwogICAgICAgIH0KICAgICAgICBpZiAoc2hhZG93Vm9sdW1lKSB7CiAgICAgICAgICBleHRydWRlTm9ybWFsSW5kZXggKz0gMzsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSV07CiAgICAgICAgICB3YWxsRXh0cnVkZU5vcm1hbHNbZXh0cnVkZU5vcm1hbEluZGV4KytdID0gdG9wTm9ybWFsc1t0aHJlZUkgKyAxXTsKICAgICAgICAgIHdhbGxFeHRydWRlTm9ybWFsc1tleHRydWRlTm9ybWFsSW5kZXgrK10gPSB0b3BOb3JtYWxzW3RocmVlSSArIDJdOwogICAgICAgIH0KICAgICAgICBpZiAoY29tcHV0ZVRvcE9mZnNldHMpIHsKICAgICAgICAgIHdhbGxPZmZzZXRBdHRyaWJ1dGVbd2FsbE9mZnNldEluZGV4KytdID0gMTsKICAgICAgICAgIHdhbGxPZmZzZXRJbmRleCArPSAxOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgbGV0IGdlbyA9IGNhbGN1bGF0ZUF0dHJpYnV0ZXNXYWxsKHdhbGxQb3NpdGlvbnMsIHZlcnRleEZvcm1hdCwgZWxsaXBzb2lkKTsKICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgZ2VvLmF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMiwKICAgICAgICB2YWx1ZXM6IHdhbGxUZXh0dXJlcwogICAgICB9KTsKICAgIH0KICAgIGlmIChzaGFkb3dWb2x1bWUpIHsKICAgICAgZ2VvLmF0dHJpYnV0ZXMuZXh0cnVkZURpcmVjdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgIHZhbHVlczogd2FsbEV4dHJ1ZGVOb3JtYWxzCiAgICAgIH0pOwogICAgfQogICAgaWYgKGhhc09mZnNldHMpIHsKICAgICAgZ2VvLmF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgIHZhbHVlczogd2FsbE9mZnNldEF0dHJpYnV0ZQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IHdhbGxJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIHdhbGxDb3VudCwKICAgICAgcGVyaW1ldGVyUG9zaXRpb25zICogNgogICAgKTsKICAgIGxldCB1cHBlckxlZnQ7CiAgICBsZXQgbG93ZXJMZWZ0OwogICAgbGV0IGxvd2VyUmlnaHQ7CiAgICBsZXQgdXBwZXJSaWdodDsKICAgIGxlbmd0aCA9IHdhbGxQb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSArPSAyKSB7CiAgICAgIHVwcGVyTGVmdCA9IGk7CiAgICAgIHVwcGVyUmlnaHQgPSAodXBwZXJMZWZ0ICsgMikgJSBsZW5ndGg7CiAgICAgIGNvbnN0IHAxID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSh3YWxsUG9zaXRpb25zLCB1cHBlckxlZnQgKiAzLCB2MVNjcmF0Y2gpOwogICAgICBjb25zdCBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkod2FsbFBvc2l0aW9ucywgdXBwZXJSaWdodCAqIDMsIHYyU2NyYXRjaCk7CiAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwMSwgcDIsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgbG93ZXJMZWZ0ID0gKHVwcGVyTGVmdCArIDEpICUgbGVuZ3RoOwogICAgICBsb3dlclJpZ2h0ID0gKGxvd2VyTGVmdCArIDIpICUgbGVuZ3RoOwogICAgICB3YWxsSW5kaWNlc1tpbmRleCsrXSA9IHVwcGVyTGVmdDsKICAgICAgd2FsbEluZGljZXNbaW5kZXgrK10gPSBsb3dlckxlZnQ7CiAgICAgIHdhbGxJbmRpY2VzW2luZGV4KytdID0gdXBwZXJSaWdodDsKICAgICAgd2FsbEluZGljZXNbaW5kZXgrK10gPSB1cHBlclJpZ2h0OwogICAgICB3YWxsSW5kaWNlc1tpbmRleCsrXSA9IGxvd2VyTGVmdDsKICAgICAgd2FsbEluZGljZXNbaW5kZXgrK10gPSBsb3dlclJpZ2h0OwogICAgfQogICAgZ2VvLmluZGljZXMgPSB3YWxsSW5kaWNlczsKICAgIGdlbyA9IEdlb21ldHJ5UGlwZWxpbmVfZGVmYXVsdC5jb21iaW5lSW5zdGFuY2VzKFsKICAgICAgbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgZ2VvbWV0cnk6IHRvcEJvdHRvbUdlbwogICAgICB9KSwKICAgICAgbmV3IEdlb21ldHJ5SW5zdGFuY2VfZGVmYXVsdCh7CiAgICAgICAgZ2VvbWV0cnk6IGdlbwogICAgICB9KQogICAgXSk7CiAgICByZXR1cm4gZ2VvWzBdOwogIH0KICBmdW5jdGlvbiBjb21wdXRlUmVjdGFuZ2xlMyhyZWN0YW5nbGUsIGdyYW51bGFyaXR5LCByb3RhdGlvbiwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgIGlmIChyb3RhdGlvbiA9PT0gMCkgewogICAgICByZXR1cm4gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocmVjdGFuZ2xlLCByZXN1bHQpOwogICAgfQogICAgY29uc3QgY29tcHV0ZWRPcHRpb25zID0gUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZU9wdGlvbnMoCiAgICAgIHJlY3RhbmdsZSwKICAgICAgZ3JhbnVsYXJpdHksCiAgICAgIHJvdGF0aW9uLAogICAgICAwLAogICAgICByZWN0YW5nbGVTY3JhdGNoLAogICAgICBud1NjcmF0Y2gKICAgICk7CiAgICBjb25zdCBoZWlnaHQgPSBjb21wdXRlZE9wdGlvbnMuaGVpZ2h0OwogICAgY29uc3Qgd2lkdGggPSBjb21wdXRlZE9wdGlvbnMud2lkdGg7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBzY3JhdGNoUmVjdGFuZ2xlUG9pbnRzOwogICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgZmFsc2UsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIHBvc2l0aW9uc1swXQogICAgKTsKICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICBlbGxpcHNvaWQsCiAgICAgIGZhbHNlLAogICAgICAwLAogICAgICB3aWR0aCAtIDEsCiAgICAgIHBvc2l0aW9uc1sxXQogICAgKTsKICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICBlbGxpcHNvaWQsCiAgICAgIGZhbHNlLAogICAgICBoZWlnaHQgLSAxLAogICAgICAwLAogICAgICBwb3NpdGlvbnNbMl0KICAgICk7CiAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgIGNvbXB1dGVkT3B0aW9ucywKICAgICAgZWxsaXBzb2lkLAogICAgICBmYWxzZSwKICAgICAgaGVpZ2h0IC0gMSwKICAgICAgd2lkdGggLSAxLAogICAgICBwb3NpdGlvbnNbM10KICAgICk7CiAgICByZXR1cm4gUmVjdGFuZ2xlX2RlZmF1bHQuZnJvbUNhcnRlc2lhbkFycmF5KHBvc2l0aW9ucywgZWxsaXBzb2lkLCByZXN1bHQpOwogIH0KICBmdW5jdGlvbiBSZWN0YW5nbGVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHJlY3RhbmdsZSA9IG9wdGlvbnMucmVjdGFuZ2xlOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgUmVjdGFuZ2xlX2RlZmF1bHQudmFsaWRhdGUocmVjdGFuZ2xlKTsKICAgIGlmIChyZWN0YW5nbGUubm9ydGggPCByZWN0YW5nbGUuc291dGgpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIm9wdGlvbnMucmVjdGFuZ2xlLm5vcnRoIG11c3QgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIG9wdGlvbnMucmVjdGFuZ2xlLnNvdXRoIgogICAgICApOwogICAgfQogICAgY29uc3QgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocmVjdGFuZ2xlKTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZSgKICAgICAgZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KQogICAgKTsKICAgIHRoaXMuX3N1cmZhY2VIZWlnaHQgPSBNYXRoLm1heChoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgIHRoaXMuX3JvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yb3RhdGlvbiwgMCk7CiAgICB0aGlzLl9zdFJvdGF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zdFJvdGF0aW9uLCAwKTsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKAogICAgICBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCkKICAgICk7CiAgICB0aGlzLl9leHRydWRlZEhlaWdodCA9IE1hdGgubWluKGhlaWdodCwgZXh0cnVkZWRIZWlnaHQpOwogICAgdGhpcy5fc2hhZG93Vm9sdW1lID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5zaGFkb3dWb2x1bWUsIGZhbHNlKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkiOwogICAgdGhpcy5fb2Zmc2V0QXR0cmlidXRlID0gb3B0aW9ucy5vZmZzZXRBdHRyaWJ1dGU7CiAgICB0aGlzLl9yb3RhdGVkUmVjdGFuZ2xlID0gdm9pZCAwOwogICAgdGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cyA9IHZvaWQgMDsKICB9CiAgZnVuY3Rpb24gdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50czMocmVjdGFuZ2xlR2VvbWV0cnkpIHsKICAgIGlmIChyZWN0YW5nbGVHZW9tZXRyeS5fc3RSb3RhdGlvbiA9PT0gMCkgewogICAgICByZXR1cm4gWzAsIDAsIDAsIDEsIDEsIDBdOwogICAgfQogICAgY29uc3QgcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUoCiAgICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUsCiAgICAgIHVucm90YXRlZFRleHR1cmVSZWN0YW5nbGVTY3JhdGNoCiAgICApOwogICAgY29uc3QgZ3JhbnVsYXJpdHkgPSByZWN0YW5nbGVHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICBjb25zdCBlbGxpcHNvaWQgPSByZWN0YW5nbGVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgY29uc3Qgcm90YXRpb24gPSByZWN0YW5nbGVHZW9tZXRyeS5fcm90YXRpb24gLSByZWN0YW5nbGVHZW9tZXRyeS5fc3RSb3RhdGlvbjsKICAgIGNvbnN0IHVucm90YXRlZFRleHR1cmVSZWN0YW5nbGUgPSBjb21wdXRlUmVjdGFuZ2xlMygKICAgICAgcmVjdGFuZ2xlLAogICAgICBncmFudWxhcml0eSwKICAgICAgcm90YXRpb24sCiAgICAgIGVsbGlwc29pZCwKICAgICAgdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZVNjcmF0Y2gKICAgICk7CiAgICBjb25zdCBwb2ludHMyRCA9IHBvaW50czJEU2NyYXRjaDI7CiAgICBwb2ludHMyRFswXS54ID0gdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZS53ZXN0OwogICAgcG9pbnRzMkRbMF0ueSA9IHVucm90YXRlZFRleHR1cmVSZWN0YW5nbGUuc291dGg7CiAgICBwb2ludHMyRFsxXS54ID0gdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZS53ZXN0OwogICAgcG9pbnRzMkRbMV0ueSA9IHVucm90YXRlZFRleHR1cmVSZWN0YW5nbGUubm9ydGg7CiAgICBwb2ludHMyRFsyXS54ID0gdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZS5lYXN0OwogICAgcG9pbnRzMkRbMl0ueSA9IHVucm90YXRlZFRleHR1cmVSZWN0YW5nbGUuc291dGg7CiAgICBjb25zdCBib3VuZGluZ1JlY3RhbmdsZSA9IHJlY3RhbmdsZUdlb21ldHJ5LnJlY3RhbmdsZTsKICAgIGNvbnN0IHRvRGVzaXJlZEluQ29tcHV0ZWQgPSBNYXRyaXgyX2RlZmF1bHQuZnJvbVJvdGF0aW9uKAogICAgICByZWN0YW5nbGVHZW9tZXRyeS5fc3RSb3RhdGlvbiwKICAgICAgcm90YXRpb24yRFNjcmF0Y2gyCiAgICApOwogICAgY29uc3QgYm91bmRpbmdSZWN0YW5nbGVDZW50ZXIgPSBSZWN0YW5nbGVfZGVmYXVsdC5jZW50ZXIoCiAgICAgIGJvdW5kaW5nUmVjdGFuZ2xlLAogICAgICByZWN0YW5nbGVDZW50ZXJTY3JhdGNoMgogICAgKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzsgKytpKSB7CiAgICAgIGNvbnN0IHBvaW50MkQgPSBwb2ludHMyRFtpXTsKICAgICAgcG9pbnQyRC54IC09IGJvdW5kaW5nUmVjdGFuZ2xlQ2VudGVyLmxvbmdpdHVkZTsKICAgICAgcG9pbnQyRC55IC09IGJvdW5kaW5nUmVjdGFuZ2xlQ2VudGVyLmxhdGl0dWRlOwogICAgICBNYXRyaXgyX2RlZmF1bHQubXVsdGlwbHlCeVZlY3Rvcih0b0Rlc2lyZWRJbkNvbXB1dGVkLCBwb2ludDJELCBwb2ludDJEKTsKICAgICAgcG9pbnQyRC54ICs9IGJvdW5kaW5nUmVjdGFuZ2xlQ2VudGVyLmxvbmdpdHVkZTsKICAgICAgcG9pbnQyRC55ICs9IGJvdW5kaW5nUmVjdGFuZ2xlQ2VudGVyLmxhdGl0dWRlOwogICAgICBwb2ludDJELnggPSAocG9pbnQyRC54IC0gYm91bmRpbmdSZWN0YW5nbGUud2VzdCkgLyBib3VuZGluZ1JlY3RhbmdsZS53aWR0aDsKICAgICAgcG9pbnQyRC55ID0gKHBvaW50MkQueSAtIGJvdW5kaW5nUmVjdGFuZ2xlLnNvdXRoKSAvIGJvdW5kaW5nUmVjdGFuZ2xlLmhlaWdodDsKICAgIH0KICAgIGNvbnN0IG1pblhZQ29ybmVyID0gcG9pbnRzMkRbMF07CiAgICBjb25zdCBtYXhZQ29ybmVyID0gcG9pbnRzMkRbMV07CiAgICBjb25zdCBtYXhYQ29ybmVyID0gcG9pbnRzMkRbMl07CiAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkoNik7CiAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFjayhtaW5YWUNvcm5lciwgcmVzdWx0KTsKICAgIENhcnRlc2lhbjJfZGVmYXVsdC5wYWNrKG1heFlDb3JuZXIsIHJlc3VsdCwgMik7CiAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQucGFjayhtYXhYQ29ybmVyLCByZXN1bHQsIDQpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdmFyIHBvc2l0aW9uU2NyYXRjaDIsIG5vcm1hbFNjcmF0Y2g0LCB0YW5nZW50U2NyYXRjaDIsIGJpdGFuZ2VudFNjcmF0Y2gyLCByZWN0YW5nbGVTY3JhdGNoLCBzdFNjcmF0Y2gyLCBib3R0b21Cb3VuZGluZ1NwaGVyZTMsIHRvcEJvdW5kaW5nU3BoZXJlMywgdjFTY3JhdGNoLCB2MlNjcmF0Y2gsIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMiwgc2NyYXRjaFJlY3RhbmdsZVBvaW50cywgbndTY3JhdGNoLCBzdE53U2NyYXRjaCwgc2NyYXRjaFJlY3RhbmdsZSwgc2NyYXRjaEVsbGlwc29pZDExLCBzY3JhdGNoT3B0aW9uczE5LCB0YW5nZW50Um90YXRpb25NYXRyaXhTY3JhdGNoLCBxdWF0ZXJuaW9uU2NyYXRjaDQsIGNlbnRlclNjcmF0Y2g0LCB1bnJvdGF0ZWRUZXh0dXJlUmVjdGFuZ2xlU2NyYXRjaCwgcG9pbnRzMkRTY3JhdGNoMiwgcm90YXRpb24yRFNjcmF0Y2gyLCByZWN0YW5nbGVDZW50ZXJTY3JhdGNoMiwgUmVjdGFuZ2xlR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9SZWN0YW5nbGVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVjdGFuZ2xlR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0dlb21ldHJ5SW5zdGFuY2UoKTsKICAgICAgaW5pdF9HZW9tZXRyeU9mZnNldEF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5UGlwZWxpbmUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDIoKTsKICAgICAgaW5pdF9NYXRyaXgzKCk7CiAgICAgIGluaXRfUG9seWdvblBpcGVsaW5lKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1F1YXRlcm5pb24oKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9SZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgcG9zaXRpb25TY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbm9ybWFsU2NyYXRjaDQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHRhbmdlbnRTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYml0YW5nZW50U2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHJlY3RhbmdsZVNjcmF0Y2ggPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc3RTY3JhdGNoMiA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgYm90dG9tQm91bmRpbmdTcGhlcmUzID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKTsKICAgICAgdG9wQm91bmRpbmdTcGhlcmUzID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKTsKICAgICAgdjFTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICB2MlNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMiA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUmVjdGFuZ2xlUG9pbnRzID0gWwogICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKSwKICAgICAgICBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKQogICAgICBdOwogICAgICBud1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc3ROd1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnkucGFja2VkTGVuZ3RoID0gUmVjdGFuZ2xlX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgNzsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgidmFsdWUiLCB2YWx1ZSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgUmVjdGFuZ2xlX2RlZmF1bHQucGFjayh2YWx1ZS5fcmVjdGFuZ2xlLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N1cmZhY2VIZWlnaHQ7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9yb3RhdGlvbjsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3N0Um90YXRpb247CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9leHRydWRlZEhlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX3NoYWRvd1ZvbHVtZSA/IDEgOiAwOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXhdID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQodmFsdWUuX29mZnNldEF0dHJpYnV0ZSwgLTEpOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZSA9IG5ldyBSZWN0YW5nbGVfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRWxsaXBzb2lkMTEgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIHNjcmF0Y2hPcHRpb25zMTkgPSB7CiAgICAgICAgcmVjdGFuZ2xlOiBzY3JhdGNoUmVjdGFuZ2xlLAogICAgICAgIGVsbGlwc29pZDogc2NyYXRjaEVsbGlwc29pZDExLAogICAgICAgIHZlcnRleEZvcm1hdDogc2NyYXRjaFZlcnRleEZvcm1hdDEyLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAsCiAgICAgICAgaGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgcm90YXRpb246IHZvaWQgMCwKICAgICAgICBzdFJvdGF0aW9uOiB2b2lkIDAsCiAgICAgICAgZXh0cnVkZWRIZWlnaHQ6IHZvaWQgMCwKICAgICAgICBzaGFkb3dWb2x1bWU6IHZvaWQgMCwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGU6IHZvaWQgMAogICAgICB9OwogICAgICBSZWN0YW5nbGVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC5kZWZpbmVkKCJhcnJheSIsIGFycmF5KTsKICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgY29uc3QgcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoUmVjdGFuZ2xlKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFJlY3RhbmdsZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgsIHNjcmF0Y2hFbGxpcHNvaWQxMSk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgY29uc3QgdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgYXJyYXksCiAgICAgICAgICBzdGFydGluZ0luZGV4LAogICAgICAgICAgc2NyYXRjaFZlcnRleEZvcm1hdDEyCiAgICAgICAgKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IFZlcnRleEZvcm1hdF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgc3VyZmFjZUhlaWdodCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHN0Um90YXRpb24gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGV4dHJ1ZGVkSGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCBzaGFkb3dWb2x1bWUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTkuZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTkuaGVpZ2h0ID0gc3VyZmFjZUhlaWdodDsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTkucm90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTkuc3RSb3RhdGlvbiA9IHN0Um90YXRpb247CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE5LmV4dHJ1ZGVkSGVpZ2h0ID0gZXh0cnVkZWRIZWlnaHQ7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczE5LnNoYWRvd1ZvbHVtZSA9IHNoYWRvd1ZvbHVtZTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMTkub2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlID09PSAtMSA/IHZvaWQgMCA6IG9mZnNldEF0dHJpYnV0ZTsKICAgICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMxOSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocmVjdGFuZ2xlLCByZXN1bHQuX3JlY3RhbmdsZSk7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCwgcmVzdWx0Ll92ZXJ0ZXhGb3JtYXQpOwogICAgICAgIHJlc3VsdC5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICByZXN1bHQuX3N1cmZhY2VIZWlnaHQgPSBzdXJmYWNlSGVpZ2h0OwogICAgICAgIHJlc3VsdC5fcm90YXRpb24gPSByb3RhdGlvbjsKICAgICAgICByZXN1bHQuX3N0Um90YXRpb24gPSBzdFJvdGF0aW9uOwogICAgICAgIHJlc3VsdC5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICByZXN1bHQuX3NoYWRvd1ZvbHVtZSA9IHNoYWRvd1ZvbHVtZTsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnkuY29tcHV0ZVJlY3RhbmdsZSA9IGZ1bmN0aW9uKG9wdGlvbnMsIHJlc3VsdCkgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IG9wdGlvbnMucmVjdGFuZ2xlOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm9iamVjdCgicmVjdGFuZ2xlIiwgcmVjdGFuZ2xlKTsKICAgICAgICBSZWN0YW5nbGVfZGVmYXVsdC52YWxpZGF0ZShyZWN0YW5nbGUpOwogICAgICAgIGlmIChyZWN0YW5nbGUubm9ydGggPCByZWN0YW5nbGUuc291dGgpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAib3B0aW9ucy5yZWN0YW5nbGUubm9ydGggbXVzdCBiZSBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gb3B0aW9ucy5yZWN0YW5nbGUuc291dGgiCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICAgICApOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICAgICAgY29uc3Qgcm90YXRpb24gPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnJvdGF0aW9uLCAwKTsKICAgICAgICByZXR1cm4gY29tcHV0ZVJlY3RhbmdsZTMocmVjdGFuZ2xlLCBncmFudWxhcml0eSwgcm90YXRpb24sIGVsbGlwc29pZCwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgdGFuZ2VudFJvdGF0aW9uTWF0cml4U2NyYXRjaCA9IG5ldyBNYXRyaXgzX2RlZmF1bHQoKTsKICAgICAgcXVhdGVybmlvblNjcmF0Y2g0ID0gbmV3IFF1YXRlcm5pb25fZGVmYXVsdCgpOwogICAgICBjZW50ZXJTY3JhdGNoNCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBSZWN0YW5nbGVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHJlY3RhbmdsZUdlb21ldHJ5KSB7CiAgICAgICAgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZS5ub3J0aCwKICAgICAgICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUuc291dGgsCiAgICAgICAgICBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwCiAgICAgICAgKSB8fCBNYXRoX2RlZmF1bHQuZXF1YWxzRXBzaWxvbigKICAgICAgICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUuZWFzdCwKICAgICAgICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUud2VzdCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTAKICAgICAgICApKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBsZXQgcmVjdGFuZ2xlID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSByZWN0YW5nbGVHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gcmVjdGFuZ2xlR2VvbWV0cnkuX3JvdGF0aW9uOwogICAgICAgIGNvbnN0IHN0Um90YXRpb24gPSByZWN0YW5nbGVHZW9tZXRyeS5fc3RSb3RhdGlvbjsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSByZWN0YW5nbGVHZW9tZXRyeS5fdmVydGV4Rm9ybWF0OwogICAgICAgIGNvbnN0IGNvbXB1dGVkT3B0aW9ucyA9IFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVPcHRpb25zKAogICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkuX2dyYW51bGFyaXR5LAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICBzdFJvdGF0aW9uLAogICAgICAgICAgcmVjdGFuZ2xlU2NyYXRjaCwKICAgICAgICAgIG53U2NyYXRjaCwKICAgICAgICAgIHN0TndTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0YW5nZW50Um90YXRpb25NYXRyaXggPSB0YW5nZW50Um90YXRpb25NYXRyaXhTY3JhdGNoOwogICAgICAgIGlmIChzdFJvdGF0aW9uICE9PSAwIHx8IHJvdGF0aW9uICE9PSAwKSB7CiAgICAgICAgICBjb25zdCBjZW50ZXIgPSBSZWN0YW5nbGVfZGVmYXVsdC5jZW50ZXIocmVjdGFuZ2xlLCBjZW50ZXJTY3JhdGNoNCk7CiAgICAgICAgICBjb25zdCBheGlzID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbENhcnRvZ3JhcGhpYyhjZW50ZXIsIHYxU2NyYXRjaCk7CiAgICAgICAgICBRdWF0ZXJuaW9uX2RlZmF1bHQuZnJvbUF4aXNBbmdsZShheGlzLCAtc3RSb3RhdGlvbiwgcXVhdGVybmlvblNjcmF0Y2g0KTsKICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5mcm9tUXVhdGVybmlvbihxdWF0ZXJuaW9uU2NyYXRjaDQsIHRhbmdlbnRSb3RhdGlvbk1hdHJpeCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIE1hdHJpeDNfZGVmYXVsdC5jbG9uZShNYXRyaXgzX2RlZmF1bHQuSURFTlRJVFksIHRhbmdlbnRSb3RhdGlvbk1hdHJpeCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN1cmZhY2VIZWlnaHQgPSByZWN0YW5nbGVHZW9tZXRyeS5fc3VyZmFjZUhlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlID0gIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgc3VyZmFjZUhlaWdodCwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgMCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMgogICAgICAgICk7CiAgICAgICAgY29tcHV0ZWRPcHRpb25zLmxvblNjYWxhciA9IDEgLyByZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlLndpZHRoOwogICAgICAgIGNvbXB1dGVkT3B0aW9ucy5sYXRTY2FsYXIgPSAxIC8gcmVjdGFuZ2xlR2VvbWV0cnkuX3JlY3RhbmdsZS5oZWlnaHQ7CiAgICAgICAgY29tcHV0ZWRPcHRpb25zLnRhbmdlbnRSb3RhdGlvbk1hdHJpeCA9IHRhbmdlbnRSb3RhdGlvbk1hdHJpeDsKICAgICAgICBsZXQgZ2VvbWV0cnk7CiAgICAgICAgbGV0IGJvdW5kaW5nU3BoZXJlOwogICAgICAgIHJlY3RhbmdsZSA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGU7CiAgICAgICAgaWYgKGV4dHJ1ZGUpIHsKICAgICAgICAgIGdlb21ldHJ5ID0gY29uc3RydWN0RXh0cnVkZWRSZWN0YW5nbGUocmVjdGFuZ2xlR2VvbWV0cnksIGNvbXB1dGVkT3B0aW9ucyk7CiAgICAgICAgICBjb25zdCB0b3BCUyA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVJlY3RhbmdsZTNEKAogICAgICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgc3VyZmFjZUhlaWdodCwKICAgICAgICAgICAgdG9wQm91bmRpbmdTcGhlcmUzCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgYm90dG9tQlMgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21SZWN0YW5nbGUzRCgKICAgICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgICBib3R0b21Cb3VuZGluZ1NwaGVyZTMKICAgICAgICAgICk7CiAgICAgICAgICBib3VuZGluZ1NwaGVyZSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudW5pb24odG9wQlMsIGJvdHRvbUJTKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZ2VvbWV0cnkgPSBjb25zdHJ1Y3RSZWN0YW5nbGUocmVjdGFuZ2xlR2VvbWV0cnksIGNvbXB1dGVkT3B0aW9ucyk7CiAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgICAgICAgIHN1cmZhY2VIZWlnaHQsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUpKSB7CiAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aDsKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0VmFsdWUgPSByZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlID09PSBHZW9tZXRyeU9mZnNldEF0dHJpYnV0ZV9kZWZhdWx0Lk5PTkUgPyAwIDogMTsKICAgICAgICAgICAgY29uc3QgYXBwbHlPZmZzZXQgPSBuZXcgVWludDhBcnJheShsZW5ndGggLyAzKS5maWxsKG9mZnNldFZhbHVlKTsKICAgICAgICAgICAgZ2VvbWV0cnkuYXR0cmlidXRlcy5hcHBseU9mZnNldCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDEsCiAgICAgICAgICAgICAgdmFsdWVzOiBhcHBseU9mZnNldAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGJvdW5kaW5nU3BoZXJlID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUmVjdGFuZ2xlM0QoCiAgICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBzdXJmYWNlSGVpZ2h0CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoIXZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgZGVsZXRlIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb247CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzOiBnZW9tZXRyeS5hdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlczogZ2VvbWV0cnkuaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IGdlb21ldHJ5LnByaW1pdGl2ZVR5cGUsCiAgICAgICAgICBib3VuZGluZ1NwaGVyZSwKICAgICAgICAgIG9mZnNldEF0dHJpYnV0ZTogcmVjdGFuZ2xlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZQogICAgICAgIH0pOwogICAgICB9OwogICAgICBSZWN0YW5nbGVHZW9tZXRyeS5jcmVhdGVTaGFkb3dWb2x1bWUgPSBmdW5jdGlvbihyZWN0YW5nbGVHZW9tZXRyeSwgbWluSGVpZ2h0RnVuYywgbWF4SGVpZ2h0RnVuYykgewogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgbWluSGVpZ2h0ID0gbWluSGVpZ2h0RnVuYyhncmFudWxhcml0eSwgZWxsaXBzb2lkKTsKICAgICAgICBjb25zdCBtYXhIZWlnaHQgPSBtYXhIZWlnaHRGdW5jKGdyYW51bGFyaXR5LCBlbGxpcHNvaWQpOwogICAgICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlR2VvbWV0cnkoewogICAgICAgICAgcmVjdGFuZ2xlOiByZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlLAogICAgICAgICAgcm90YXRpb246IHJlY3RhbmdsZUdlb21ldHJ5Ll9yb3RhdGlvbiwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHN0Um90YXRpb246IHJlY3RhbmdsZUdlb21ldHJ5Ll9zdFJvdGF0aW9uLAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBleHRydWRlZEhlaWdodDogbWF4SGVpZ2h0LAogICAgICAgICAgaGVpZ2h0OiBtaW5IZWlnaHQsCiAgICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IFZlcnRleEZvcm1hdF9kZWZhdWx0LlBPU0lUSU9OX09OTFksCiAgICAgICAgICBzaGFkb3dWb2x1bWU6IHRydWUKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgdW5yb3RhdGVkVGV4dHVyZVJlY3RhbmdsZVNjcmF0Y2ggPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgcG9pbnRzMkRTY3JhdGNoMiA9IFtuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KCksIG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKSwgbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpXTsKICAgICAgcm90YXRpb24yRFNjcmF0Y2gyID0gbmV3IE1hdHJpeDJfZGVmYXVsdCgpOwogICAgICByZWN0YW5nbGVDZW50ZXJTY3JhdGNoMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhSZWN0YW5nbGVHZW9tZXRyeS5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHJlY3RhbmdsZTogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhpcy5fcm90YXRlZFJlY3RhbmdsZSkpIHsKICAgICAgICAgICAgICB0aGlzLl9yb3RhdGVkUmVjdGFuZ2xlID0gY29tcHV0ZVJlY3RhbmdsZTMoCiAgICAgICAgICAgICAgICB0aGlzLl9yZWN0YW5nbGUsCiAgICAgICAgICAgICAgICB0aGlzLl9ncmFudWxhcml0eSwKICAgICAgICAgICAgICAgIHRoaXMuX3JvdGF0aW9uLAogICAgICAgICAgICAgICAgdGhpcy5fZWxsaXBzb2lkCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5fcm90YXRlZFJlY3RhbmdsZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEZvciByZW1hcHBpbmcgdGV4dHVyZSBjb29yZGluYXRlcyB3aGVuIHJlbmRlcmluZyBSZWN0YW5nbGVHZW9tZXRyaWVzIGFzIEdyb3VuZFByaW1pdGl2ZXMuCiAgICAgICAgICogVGhpcyB2ZXJzaW9uIHBlcm1pdHMgc2tldyBpbiB0ZXh0dXJlcyBieSBjb21wdXRpbmcgb2Zmc2V0cyBkaXJlY3RseSBpbiBjYXJ0b2dyYXBoaWMgc3BhY2UgYW5kCiAgICAgICAgICogbW9yZSBhY2N1cmF0ZWx5IGFwcHJveGltYXRlcyByZW5kZXJpbmcgUmVjdGFuZ2xlR2VvbWV0cmllcyB3aXRoIGhlaWdodCBhcyBzdGFuZGFyZCBQcmltaXRpdmVzLgogICAgICAgICAqIEBzZWUgR2VvbWV0cnkjX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHM6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRoaXMuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMpKSB7CiAgICAgICAgICAgICAgdGhpcy5fdGV4dHVyZUNvb3JkaW5hdGVSb3RhdGlvblBvaW50cyA9IHRleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHMzKAogICAgICAgICAgICAgICAgdGhpcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RleHR1cmVDb29yZGluYXRlUm90YXRpb25Qb2ludHM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlfZGVmYXVsdCA9IFJlY3RhbmdsZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkuanMKICB2YXIgY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeShyZWN0YW5nbGVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgcmVjdGFuZ2xlR2VvbWV0cnkgPSBSZWN0YW5nbGVHZW9tZXRyeV9kZWZhdWx0LnVucGFjayhyZWN0YW5nbGVHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShyZWN0YW5nbGVHZW9tZXRyeS5fZWxsaXBzb2lkKTsKICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShyZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlKTsKICAgIHJldHVybiBSZWN0YW5nbGVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHJlY3RhbmdsZUdlb21ldHJ5KTsKICB9CiAgdmFyIGNyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5LmpzCiAgZnVuY3Rpb24gY29uc3RydWN0UmVjdGFuZ2xlMihnZW9tZXRyeSwgY29tcHV0ZWRPcHRpb25zKSB7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBnZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgY29uc3QgaGVpZ2h0ID0gY29tcHV0ZWRPcHRpb25zLmhlaWdodDsKICAgIGNvbnN0IHdpZHRoID0gY29tcHV0ZWRPcHRpb25zLndpZHRoOwogICAgY29uc3Qgbm9ydGhDYXAgPSBjb21wdXRlZE9wdGlvbnMubm9ydGhDYXA7CiAgICBjb25zdCBzb3V0aENhcCA9IGNvbXB1dGVkT3B0aW9ucy5zb3V0aENhcDsKICAgIGxldCByb3dIZWlnaHQgPSBoZWlnaHQ7CiAgICBsZXQgd2lkdGhNdWx0aXBsaWVyID0gMjsKICAgIGxldCBzaXplID0gMDsKICAgIGxldCBjb3JuZXJzID0gNDsKICAgIGlmIChub3J0aENhcCkgewogICAgICB3aWR0aE11bHRpcGxpZXIgLT0gMTsKICAgICAgcm93SGVpZ2h0IC09IDE7CiAgICAgIHNpemUgKz0gMTsKICAgICAgY29ybmVycyAtPSAyOwogICAgfQogICAgaWYgKHNvdXRoQ2FwKSB7CiAgICAgIHdpZHRoTXVsdGlwbGllciAtPSAxOwogICAgICByb3dIZWlnaHQgLT0gMTsKICAgICAgc2l6ZSArPSAxOwogICAgICBjb3JuZXJzIC09IDI7CiAgICB9CiAgICBzaXplICs9IHdpZHRoTXVsdGlwbGllciAqIHdpZHRoICsgMiAqIHJvd0hlaWdodCAtIGNvcm5lcnM7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHNpemUgKiAzKTsKICAgIGxldCBwb3NJbmRleCA9IDA7CiAgICBsZXQgcm93ID0gMDsKICAgIGxldCBjb2w7CiAgICBjb25zdCBwb3NpdGlvbiA9IHBvc2l0aW9uU2NyYXRjaDM7CiAgICBpZiAobm9ydGhDYXApIHsKICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICAgIGNvbXB1dGVkT3B0aW9ucywKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgZmFsc2UsCiAgICAgICAgcm93LAogICAgICAgIDAsCiAgICAgICAgcG9zaXRpb24KICAgICAgKTsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24uejsKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoY29sID0gMDsgY29sIDwgd2lkdGg7IGNvbCsrKSB7CiAgICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgZmFsc2UsCiAgICAgICAgICByb3csCiAgICAgICAgICBjb2wsCiAgICAgICAgICBwb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICAgIH0KICAgIH0KICAgIGNvbCA9IHdpZHRoIC0gMTsKICAgIGZvciAocm93ID0gMTsgcm93IDwgaGVpZ2h0OyByb3crKykgewogICAgICBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb24oCiAgICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICBmYWxzZSwKICAgICAgICByb3csCiAgICAgICAgY29sLAogICAgICAgIHBvc2l0aW9uCiAgICAgICk7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLng7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLnk7CiAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICB9CiAgICByb3cgPSBoZWlnaHQgLSAxOwogICAgaWYgKCFzb3V0aENhcCkgewogICAgICBmb3IgKGNvbCA9IHdpZHRoIC0gMjsgY29sID49IDA7IGNvbC0tKSB7CiAgICAgICAgUmVjdGFuZ2xlR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQuY29tcHV0ZVBvc2l0aW9uKAogICAgICAgICAgY29tcHV0ZWRPcHRpb25zLAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgZmFsc2UsCiAgICAgICAgICByb3csCiAgICAgICAgICBjb2wsCiAgICAgICAgICBwb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgICBwb3NpdGlvbnNbcG9zSW5kZXgrK10gPSBwb3NpdGlvbi55OwogICAgICAgIHBvc2l0aW9uc1twb3NJbmRleCsrXSA9IHBvc2l0aW9uLno7CiAgICAgIH0KICAgIH0KICAgIGNvbCA9IDA7CiAgICBmb3IgKHJvdyA9IGhlaWdodCAtIDI7IHJvdyA+IDA7IHJvdy0tKSB7CiAgICAgIFJlY3RhbmdsZUdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbigKICAgICAgICBjb21wdXRlZE9wdGlvbnMsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIGZhbHNlLAogICAgICAgIHJvdywKICAgICAgICBjb2wsCiAgICAgICAgcG9zaXRpb24KICAgICAgKTsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueDsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24ueTsKICAgICAgcG9zaXRpb25zW3Bvc0luZGV4KytdID0gcG9zaXRpb24uejsKICAgIH0KICAgIGNvbnN0IGluZGljZXNTaXplID0gcG9zaXRpb25zLmxlbmd0aCAvIDMgKiAyOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBwb3NpdGlvbnMubGVuZ3RoIC8gMywKICAgICAgaW5kaWNlc1NpemUKICAgICk7CiAgICBsZXQgaW5kZXggPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnMubGVuZ3RoIC8gMyAtIDE7IGkrKykgewogICAgICBpbmRpY2VzW2luZGV4KytdID0gaTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGkgKyAxOwogICAgfQogICAgaW5kaWNlc1tpbmRleCsrXSA9IHBvc2l0aW9ucy5sZW5ndGggLyAzIC0gMTsKICAgIGluZGljZXNbaW5kZXgrK10gPSAwOwogICAgY29uc3QgZ2VvID0gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICBhdHRyaWJ1dGVzOiBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVzX2RlZmF1bHQoKSwKICAgICAgcHJpbWl0aXZlVHlwZTogUHJpbWl0aXZlVHlwZV9kZWZhdWx0LkxJTkVTCiAgICB9KTsKICAgIGdlby5hdHRyaWJ1dGVzLnBvc2l0aW9uID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICB9KTsKICAgIGdlby5pbmRpY2VzID0gaW5kaWNlczsKICAgIHJldHVybiBnZW87CiAgfQogIGZ1bmN0aW9uIGNvbnN0cnVjdEV4dHJ1ZGVkUmVjdGFuZ2xlMihyZWN0YW5nbGVHZW9tZXRyeSwgY29tcHV0ZWRPcHRpb25zKSB7CiAgICBjb25zdCBtYXhIZWlnaHQgPSByZWN0YW5nbGVHZW9tZXRyeS5fc3VyZmFjZUhlaWdodDsKICAgIGNvbnN0IG1pbkhlaWdodCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgIGNvbnN0IGVsbGlwc29pZCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICBjb25zdCBnZW8gPSBjb25zdHJ1Y3RSZWN0YW5nbGUyKHJlY3RhbmdsZUdlb21ldHJ5LCBjb21wdXRlZE9wdGlvbnMpOwogICAgY29uc3QgaGVpZ2h0ID0gY29tcHV0ZWRPcHRpb25zLmhlaWdodDsKICAgIGNvbnN0IHdpZHRoID0gY29tcHV0ZWRPcHRpb25zLndpZHRoOwogICAgY29uc3QgdG9wUG9zaXRpb25zID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICBnZW8uYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMsCiAgICAgIG1heEhlaWdodCwKICAgICAgZWxsaXBzb2lkLAogICAgICBmYWxzZQogICAgKTsKICAgIGxldCBsZW5ndGggPSB0b3BQb3NpdGlvbnMubGVuZ3RoOwogICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGggKiAyKTsKICAgIHBvc2l0aW9ucy5zZXQodG9wUG9zaXRpb25zKTsKICAgIGNvbnN0IGJvdHRvbVBvc2l0aW9ucyA9IFBvbHlnb25QaXBlbGluZV9kZWZhdWx0LnNjYWxlVG9HZW9kZXRpY0hlaWdodCgKICAgICAgZ2VvLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLAogICAgICBtaW5IZWlnaHQsCiAgICAgIGVsbGlwc29pZAogICAgKTsKICAgIHBvc2l0aW9ucy5zZXQoYm90dG9tUG9zaXRpb25zLCBsZW5ndGgpOwogICAgZ2VvLmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gcG9zaXRpb25zOwogICAgY29uc3Qgbm9ydGhDYXAgPSBjb21wdXRlZE9wdGlvbnMubm9ydGhDYXA7CiAgICBjb25zdCBzb3V0aENhcCA9IGNvbXB1dGVkT3B0aW9ucy5zb3V0aENhcDsKICAgIGxldCBjb3JuZXJzID0gNDsKICAgIGlmIChub3J0aENhcCkgewogICAgICBjb3JuZXJzIC09IDE7CiAgICB9CiAgICBpZiAoc291dGhDYXApIHsKICAgICAgY29ybmVycyAtPSAxOwogICAgfQogICAgY29uc3QgaW5kaWNlc1NpemUgPSAocG9zaXRpb25zLmxlbmd0aCAvIDMgKyBjb3JuZXJzKSAqIDI7CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIHBvc2l0aW9ucy5sZW5ndGggLyAzLAogICAgICBpbmRpY2VzU2l6ZQogICAgKTsKICAgIGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGggLyA2OwogICAgbGV0IGluZGV4ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIDE7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSBpICsgbGVuZ3RoOwogICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIGxlbmd0aCArIDE7CiAgICB9CiAgICBpbmRpY2VzW2luZGV4KytdID0gbGVuZ3RoIC0gMTsKICAgIGluZGljZXNbaW5kZXgrK10gPSAwOwogICAgaW5kaWNlc1tpbmRleCsrXSA9IGxlbmd0aCArIGxlbmd0aCAtIDE7CiAgICBpbmRpY2VzW2luZGV4KytdID0gbGVuZ3RoOwogICAgaW5kaWNlc1tpbmRleCsrXSA9IDA7CiAgICBpbmRpY2VzW2luZGV4KytdID0gbGVuZ3RoOwogICAgbGV0IGJvdHRvbUNvcm5lcjsKICAgIGlmIChub3J0aENhcCkgewogICAgICBib3R0b21Db3JuZXIgPSBoZWlnaHQgLSAxOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgdG9wUmlnaHRDb3JuZXIgPSB3aWR0aCAtIDE7CiAgICAgIGluZGljZXNbaW5kZXgrK10gPSB0b3BSaWdodENvcm5lcjsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IHRvcFJpZ2h0Q29ybmVyICsgbGVuZ3RoOwogICAgICBib3R0b21Db3JuZXIgPSB3aWR0aCArIGhlaWdodCAtIDI7CiAgICB9CiAgICBpbmRpY2VzW2luZGV4KytdID0gYm90dG9tQ29ybmVyOwogICAgaW5kaWNlc1tpbmRleCsrXSA9IGJvdHRvbUNvcm5lciArIGxlbmd0aDsKICAgIGlmICghc291dGhDYXApIHsKICAgICAgY29uc3QgYm90dG9tTGVmdENvcm5lciA9IHdpZHRoICsgYm90dG9tQ29ybmVyIC0gMTsKICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGJvdHRvbUxlZnRDb3JuZXI7CiAgICAgIGluZGljZXNbaW5kZXhdID0gYm90dG9tTGVmdENvcm5lciArIGxlbmd0aDsKICAgIH0KICAgIGdlby5pbmRpY2VzID0gaW5kaWNlczsKICAgIHJldHVybiBnZW87CiAgfQogIGZ1bmN0aW9uIFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHJlY3RhbmdsZSA9IG9wdGlvbnMucmVjdGFuZ2xlOwogICAgY29uc3QgZ3JhbnVsYXJpdHkgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgb3B0aW9ucy5ncmFudWxhcml0eSwKICAgICAgTWF0aF9kZWZhdWx0LlJBRElBTlNfUEVSX0RFR1JFRQogICAgKTsKICAgIGNvbnN0IGVsbGlwc29pZCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZWxsaXBzb2lkLCBFbGxpcHNvaWRfZGVmYXVsdC5XR1M4NCk7CiAgICBjb25zdCByb3RhdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucm90YXRpb24sIDApOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVjdGFuZ2xlIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgUmVjdGFuZ2xlX2RlZmF1bHQudmFsaWRhdGUocmVjdGFuZ2xlKTsKICAgIGlmIChyZWN0YW5nbGUubm9ydGggPCByZWN0YW5nbGUuc291dGgpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIm9wdGlvbnMucmVjdGFuZ2xlLm5vcnRoIG11c3QgYmUgZ3JlYXRlciB0aGFuIG9wdGlvbnMucmVjdGFuZ2xlLnNvdXRoIgogICAgICApOwogICAgfQogICAgY29uc3QgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5oZWlnaHQsIDApOwogICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmV4dHJ1ZGVkSGVpZ2h0LCBoZWlnaHQpOwogICAgdGhpcy5fcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocmVjdGFuZ2xlKTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBlbGxpcHNvaWQ7CiAgICB0aGlzLl9zdXJmYWNlSGVpZ2h0ID0gTWF0aC5tYXgoaGVpZ2h0LCBleHRydWRlZEhlaWdodCk7CiAgICB0aGlzLl9yb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgdGhpcy5fZXh0cnVkZWRIZWlnaHQgPSBNYXRoLm1pbihoZWlnaHQsIGV4dHJ1ZGVkSGVpZ2h0KTsKICAgIHRoaXMuX29mZnNldEF0dHJpYnV0ZSA9IG9wdGlvbnMub2Zmc2V0QXR0cmlidXRlOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkiOwogIH0KICB2YXIgYm90dG9tQm91bmRpbmdTcGhlcmU0LCB0b3BCb3VuZGluZ1NwaGVyZTQsIHBvc2l0aW9uU2NyYXRjaDMsIHJlY3RhbmdsZVNjcmF0Y2gyLCBzY3JhdGNoUmVjdGFuZ2xlMiwgc2NyYXRjaEVsbGlwc29pZDEyLCBzY3JhdGNoT3B0aW9uczIwLCBud1NjcmF0Y2gyLCBSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9SZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1JlY3RhbmdsZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9HZW9tZXRyeSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlKCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGVzKCk7CiAgICAgIGluaXRfR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1BvbHlnb25QaXBlbGluZSgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9SZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgYm90dG9tQm91bmRpbmdTcGhlcmU0ID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKTsKICAgICAgdG9wQm91bmRpbmdTcGhlcmU0ID0gbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKTsKICAgICAgcG9zaXRpb25TY3JhdGNoMyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcmVjdGFuZ2xlU2NyYXRjaDIgPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IFJlY3RhbmdsZV9kZWZhdWx0LnBhY2tlZExlbmd0aCArIEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDU7CiAgICAgIFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodmFsdWUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidmFsdWUgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIFJlY3RhbmdsZV9kZWZhdWx0LnBhY2sodmFsdWUuX3JlY3RhbmdsZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gUmVjdGFuZ2xlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIEVsbGlwc29pZF9kZWZhdWx0LnBhY2sodmFsdWUuX2VsbGlwc29pZCwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9zdXJmYWNlSGVpZ2h0OwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSB2YWx1ZS5fcm90YXRpb247CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9leHRydWRlZEhlaWdodDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHZhbHVlLl9vZmZzZXRBdHRyaWJ1dGUsIC0xKTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hSZWN0YW5nbGUyID0gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxMiA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaE9wdGlvbnMyMCA9IHsKICAgICAgICByZWN0YW5nbGU6IHNjcmF0Y2hSZWN0YW5nbGUyLAogICAgICAgIGVsbGlwc29pZDogc2NyYXRjaEVsbGlwc29pZDEyLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAsCiAgICAgICAgaGVpZ2h0OiB2b2lkIDAsCiAgICAgICAgcm90YXRpb246IHZvaWQgMCwKICAgICAgICBleHRydWRlZEhlaWdodDogdm9pZCAwLAogICAgICAgIG9mZnNldEF0dHJpYnV0ZTogdm9pZCAwCiAgICAgIH07CiAgICAgIFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaFJlY3RhbmdsZTIpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gUmVjdGFuZ2xlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDEyKTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgaGVpZ2h0ID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBjb25zdCByb3RhdGlvbiA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgZXh0cnVkZWRIZWlnaHQgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IG9mZnNldEF0dHJpYnV0ZSA9IGFycmF5W3N0YXJ0aW5nSW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMjAuZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgICAgICAgIHNjcmF0Y2hPcHRpb25zMjAuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyMC5yb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyMC5leHRydWRlZEhlaWdodCA9IGV4dHJ1ZGVkSGVpZ2h0OwogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyMC5vZmZzZXRBdHRyaWJ1dGUgPSBvZmZzZXRBdHRyaWJ1dGUgPT09IC0xID8gdm9pZCAwIDogb2Zmc2V0QXR0cmlidXRlOwogICAgICAgICAgcmV0dXJuIG5ldyBSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMyMCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocmVjdGFuZ2xlLCByZXN1bHQuX3JlY3RhbmdsZSk7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX3N1cmZhY2VIZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgcmVzdWx0Ll9yb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICAgIHJlc3VsdC5fZXh0cnVkZWRIZWlnaHQgPSBleHRydWRlZEhlaWdodDsKICAgICAgICByZXN1bHQuX29mZnNldEF0dHJpYnV0ZSA9IG9mZnNldEF0dHJpYnV0ZSA9PT0gLTEgPyB2b2lkIDAgOiBvZmZzZXRBdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgbndTY3JhdGNoMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbihyZWN0YW5nbGVHZW9tZXRyeSkgewogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGU7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gcmVjdGFuZ2xlR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBjb21wdXRlZE9wdGlvbnMgPSBSZWN0YW5nbGVHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlT3B0aW9ucygKICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9ncmFudWxhcml0eSwKICAgICAgICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9yb3RhdGlvbiwKICAgICAgICAgIDAsCiAgICAgICAgICByZWN0YW5nbGVTY3JhdGNoMiwKICAgICAgICAgIG53U2NyYXRjaDIKICAgICAgICApOwogICAgICAgIGxldCBnZW9tZXRyeTsKICAgICAgICBsZXQgYm91bmRpbmdTcGhlcmU7CiAgICAgICAgaWYgKE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgcmVjdGFuZ2xlLm5vcnRoLAogICAgICAgICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xMAogICAgICAgICkgfHwgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oCiAgICAgICAgICByZWN0YW5nbGUuZWFzdCwKICAgICAgICAgIHJlY3RhbmdsZS53ZXN0LAogICAgICAgICAgTWF0aF9kZWZhdWx0LkVQU0lMT04xMAogICAgICAgICkpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN1cmZhY2VIZWlnaHQgPSByZWN0YW5nbGVHZW9tZXRyeS5fc3VyZmFjZUhlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlZEhlaWdodCA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9leHRydWRlZEhlaWdodDsKICAgICAgICBjb25zdCBleHRydWRlID0gIU1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKAogICAgICAgICAgc3VyZmFjZUhlaWdodCwKICAgICAgICAgIGV4dHJ1ZGVkSGVpZ2h0LAogICAgICAgICAgMCwKICAgICAgICAgIE1hdGhfZGVmYXVsdC5FUFNJTE9OMgogICAgICAgICk7CiAgICAgICAgbGV0IG9mZnNldFZhbHVlOwogICAgICAgIGlmIChleHRydWRlKSB7CiAgICAgICAgICBnZW9tZXRyeSA9IGNvbnN0cnVjdEV4dHJ1ZGVkUmVjdGFuZ2xlMihyZWN0YW5nbGVHZW9tZXRyeSwgY29tcHV0ZWRPcHRpb25zKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgY29uc3Qgc2l6ZSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzLmxlbmd0aCAvIDM7CiAgICAgICAgICAgIGxldCBvZmZzZXRBdHRyaWJ1dGUgPSBuZXcgVWludDhBcnJheShzaXplKTsKICAgICAgICAgICAgaWYgKHJlY3RhbmdsZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuVE9QKSB7CiAgICAgICAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwoMSwgMCwgc2l6ZSAvIDIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG9mZnNldFZhbHVlID0gcmVjdGFuZ2xlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSA9PT0gR2VvbWV0cnlPZmZzZXRBdHRyaWJ1dGVfZGVmYXVsdC5OT05FID8gMCA6IDE7CiAgICAgICAgICAgICAgb2Zmc2V0QXR0cmlidXRlID0gb2Zmc2V0QXR0cmlidXRlLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMuYXBwbHlPZmZzZXQgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfQllURSwKICAgICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAxLAogICAgICAgICAgICAgIHZhbHVlczogb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgdG9wQlMgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21SZWN0YW5nbGUzRCgKICAgICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHN1cmZhY2VIZWlnaHQsCiAgICAgICAgICAgIHRvcEJvdW5kaW5nU3BoZXJlNAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IGJvdHRvbUJTID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUmVjdGFuZ2xlM0QoCiAgICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBleHRydWRlZEhlaWdodCwKICAgICAgICAgICAgYm90dG9tQm91bmRpbmdTcGhlcmU0CiAgICAgICAgICApOwogICAgICAgICAgYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LnVuaW9uKHRvcEJTLCBib3R0b21CUyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGdlb21ldHJ5ID0gY29uc3RydWN0UmVjdGFuZ2xlMihyZWN0YW5nbGVHZW9tZXRyeSwgY29tcHV0ZWRPcHRpb25zKTsKICAgICAgICAgIGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzID0gUG9seWdvblBpcGVsaW5lX2RlZmF1bHQuc2NhbGVUb0dlb2RldGljSGVpZ2h0KAogICAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlcywKICAgICAgICAgICAgc3VyZmFjZUhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVjdGFuZ2xlR2VvbWV0cnkuX29mZnNldEF0dHJpYnV0ZSkpIHsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi52YWx1ZXMubGVuZ3RoOwogICAgICAgICAgICBvZmZzZXRWYWx1ZSA9IHJlY3RhbmdsZUdlb21ldHJ5Ll9vZmZzZXRBdHRyaWJ1dGUgPT09IEdlb21ldHJ5T2Zmc2V0QXR0cmlidXRlX2RlZmF1bHQuTk9ORSA/IDAgOiAxOwogICAgICAgICAgICBjb25zdCBhcHBseU9mZnNldCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCAvIDMpLmZpbGwob2Zmc2V0VmFsdWUpOwogICAgICAgICAgICBnZW9tZXRyeS5hdHRyaWJ1dGVzLmFwcGx5T2Zmc2V0ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEUsCiAgICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMSwKICAgICAgICAgICAgICB2YWx1ZXM6IGFwcGx5T2Zmc2V0CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21SZWN0YW5nbGUzRCgKICAgICAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICAgIHN1cmZhY2VIZWlnaHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzOiBnZW9tZXRyeS5hdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlczogZ2VvbWV0cnkuaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICAgICAgb2Zmc2V0QXR0cmlidXRlOiByZWN0YW5nbGVHZW9tZXRyeS5fb2Zmc2V0QXR0cmlidXRlCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0ID0gUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5KHJlY3RhbmdsZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICByZWN0YW5nbGVHZW9tZXRyeSA9IFJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICByZWN0YW5nbGVHZW9tZXRyeSwKICAgICAgICBvZmZzZXQKICAgICAgKTsKICAgIH0KICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShyZWN0YW5nbGVHZW9tZXRyeS5fZWxsaXBzb2lkKTsKICAgIHJlY3RhbmdsZUdlb21ldHJ5Ll9yZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShyZWN0YW5nbGVHZW9tZXRyeS5fcmVjdGFuZ2xlKTsKICAgIHJldHVybiBSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShyZWN0YW5nbGVHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1JlY3RhbmdsZU91dGxpbmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1NpbXBsZVBvbHlsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBpbnRlcnBvbGF0ZUNvbG9yczIocDAsIHAxLCBjb2xvcjAsIGNvbG9yMSwgbWluRGlzdGFuY2UsIGFycmF5LCBvZmZzZXQpIHsKICAgIGNvbnN0IG51bVBvaW50cyA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5udW1iZXJPZlBvaW50cyhwMCwgcDEsIG1pbkRpc3RhbmNlKTsKICAgIGxldCBpOwogICAgY29uc3QgcjAgPSBjb2xvcjAucmVkOwogICAgY29uc3QgZzAgPSBjb2xvcjAuZ3JlZW47CiAgICBjb25zdCBiMCA9IGNvbG9yMC5ibHVlOwogICAgY29uc3QgYTAgPSBjb2xvcjAuYWxwaGE7CiAgICBjb25zdCByMSA9IGNvbG9yMS5yZWQ7CiAgICBjb25zdCBnMSA9IGNvbG9yMS5ncmVlbjsKICAgIGNvbnN0IGIxID0gY29sb3IxLmJsdWU7CiAgICBjb25zdCBhMSA9IGNvbG9yMS5hbHBoYTsKICAgIGlmIChDb2xvcl9kZWZhdWx0LmVxdWFscyhjb2xvcjAsIGNvbG9yMSkpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgICAgYXJyYXlbb2Zmc2V0KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShyMCk7CiAgICAgICAgYXJyYXlbb2Zmc2V0KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShnMCk7CiAgICAgICAgYXJyYXlbb2Zmc2V0KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShiMCk7CiAgICAgICAgYXJyYXlbb2Zmc2V0KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShhMCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG9mZnNldDsKICAgIH0KICAgIGNvbnN0IHJlZFBlclZlcnRleCA9IChyMSAtIHIwKSAvIG51bVBvaW50czsKICAgIGNvbnN0IGdyZWVuUGVyVmVydGV4ID0gKGcxIC0gZzApIC8gbnVtUG9pbnRzOwogICAgY29uc3QgYmx1ZVBlclZlcnRleCA9IChiMSAtIGIwKSAvIG51bVBvaW50czsKICAgIGNvbnN0IGFscGhhUGVyVmVydGV4ID0gKGExIC0gYTApIC8gbnVtUG9pbnRzOwogICAgbGV0IGluZGV4ID0gb2Zmc2V0OwogICAgZm9yIChpID0gMDsgaSA8IG51bVBvaW50czsgaSsrKSB7CiAgICAgIGFycmF5W2luZGV4KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShyMCArIGkgKiByZWRQZXJWZXJ0ZXgpOwogICAgICBhcnJheVtpbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoZzAgKyBpICogZ3JlZW5QZXJWZXJ0ZXgpOwogICAgICBhcnJheVtpbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoYjAgKyBpICogYmx1ZVBlclZlcnRleCk7CiAgICAgIGFycmF5W2luZGV4KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShhMCArIGkgKiBhbHBoYVBlclZlcnRleCk7CiAgICB9CiAgICByZXR1cm4gaW5kZXg7CiAgfQogIGZ1bmN0aW9uIFNpbXBsZVBvbHlsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgb3B0aW9ucyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMsIGRlZmF1bHRWYWx1ZV9kZWZhdWx0LkVNUFRZX09CSkVDVCk7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgIGNvbnN0IGNvbG9ycyA9IG9wdGlvbnMuY29sb3JzOwogICAgY29uc3QgY29sb3JzUGVyVmVydGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5jb2xvcnNQZXJWZXJ0ZXgsIGZhbHNlKTsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA8IDIpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIkF0IGxlYXN0IHR3byBwb3NpdGlvbnMgYXJlIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpICYmIChjb2xvcnNQZXJWZXJ0ZXggJiYgY29sb3JzLmxlbmd0aCA8IHBvc2l0aW9ucy5sZW5ndGggfHwgIWNvbG9yc1BlclZlcnRleCAmJiBjb2xvcnMubGVuZ3RoIDwgcG9zaXRpb25zLmxlbmd0aCAtIDEpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJjb2xvcnMgaGFzIGFuIGludmFsaWQgbGVuZ3RoLiIpOwogICAgfQogICAgdGhpcy5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgdGhpcy5fY29sb3JzID0gY29sb3JzOwogICAgdGhpcy5fY29sb3JzUGVyVmVydGV4ID0gY29sb3JzUGVyVmVydGV4OwogICAgdGhpcy5fYXJjVHlwZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuYXJjVHlwZSwgQXJjVHlwZV9kZWZhdWx0LkdFT0RFU0lDKTsKICAgIHRoaXMuX2dyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgdGhpcy5fd29ya2VyTmFtZSA9ICJjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5IjsKICAgIGxldCBudW1Db21wb25lbnRzID0gMSArIHBvc2l0aW9ucy5sZW5ndGggKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgbnVtQ29tcG9uZW50cyArPSBkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSA/IDEgKyBjb2xvcnMubGVuZ3RoICogQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGggOiAxOwogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBudW1Db21wb25lbnRzICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMzsKICB9CiAgdmFyIHNjcmF0Y2hBcnJheTEsIHNjcmF0Y2hBcnJheTIsIGdlbmVyYXRlQXJjT3B0aW9uc1NjcmF0Y2gsIFNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9TaW1wbGVQb2x5bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9TaW1wbGVQb2x5bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9BcmNUeXBlKCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29sb3IoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1BvbHlsaW5lUGlwZWxpbmUoKTsKICAgICAgaW5pdF9QcmltaXRpdmVUeXBlKCk7CiAgICAgIFNpbXBsZVBvbHlsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2YWx1ZS5fcG9zaXRpb25zOwogICAgICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb2xvcnMgPSB2YWx1ZS5fY29sb3JzOwogICAgICAgIGxlbmd0aCA9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpID8gY29sb3JzLmxlbmd0aCA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENvbG9yX2RlZmF1bHQucGFjayhjb2xvcnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IHZhbHVlLl9jb2xvcnNQZXJWZXJ0ZXggPyAxIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gdmFsdWUuX2FyY1R5cGU7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBTaW1wbGVQb2x5bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGNvbG9ycyA9IGxlbmd0aCA+IDAgPyBuZXcgQXJyYXkobGVuZ3RoKSA6IHZvaWQgMDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2ksIHN0YXJ0aW5nSW5kZXggKz0gQ29sb3JfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIGNvbG9yc1tpXSA9IENvbG9yX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCBjb2xvcnNQZXJWZXJ0ZXggPSBhcnJheVtzdGFydGluZ0luZGV4KytdID09PSAxOwogICAgICAgIGNvbnN0IGFyY1R5cGUgPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmV0dXJuIG5ldyBTaW1wbGVQb2x5bGluZUdlb21ldHJ5KHsKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBjb2xvcnMsCiAgICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgICAgY29sb3JzUGVyVmVydGV4LAogICAgICAgICAgICBhcmNUeXBlLAogICAgICAgICAgICBncmFudWxhcml0eQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgIHJlc3VsdC5fY29sb3JzID0gY29sb3JzOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkID0gZWxsaXBzb2lkOwogICAgICAgIHJlc3VsdC5fY29sb3JzUGVyVmVydGV4ID0gY29sb3JzUGVyVmVydGV4OwogICAgICAgIHJlc3VsdC5fYXJjVHlwZSA9IGFyY1R5cGU7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hBcnJheTEgPSBuZXcgQXJyYXkoMik7CiAgICAgIHNjcmF0Y2hBcnJheTIgPSBuZXcgQXJyYXkoMik7CiAgICAgIGdlbmVyYXRlQXJjT3B0aW9uc1NjcmF0Y2ggPSB7CiAgICAgICAgcG9zaXRpb25zOiBzY3JhdGNoQXJyYXkxLAogICAgICAgIGhlaWdodDogc2NyYXRjaEFycmF5MiwKICAgICAgICBlbGxpcHNvaWQ6IHZvaWQgMCwKICAgICAgICBtaW5EaXN0YW5jZTogdm9pZCAwLAogICAgICAgIGdyYW51bGFyaXR5OiB2b2lkIDAKICAgICAgfTsKICAgICAgU2ltcGxlUG9seWxpbmVHZW9tZXRyeS5jcmVhdGVHZW9tZXRyeSA9IGZ1bmN0aW9uKHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBzaW1wbGVQb2x5bGluZUdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgY29sb3JzID0gc2ltcGxlUG9seWxpbmVHZW9tZXRyeS5fY29sb3JzOwogICAgICAgIGNvbnN0IGNvbG9yc1BlclZlcnRleCA9IHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuX2NvbG9yc1BlclZlcnRleDsKICAgICAgICBjb25zdCBhcmNUeXBlID0gc2ltcGxlUG9seWxpbmVHZW9tZXRyeS5fYXJjVHlwZTsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuX2VsbGlwc29pZDsKICAgICAgICBjb25zdCBtaW5EaXN0YW5jZSA9IE1hdGhfZGVmYXVsdC5jaG9yZExlbmd0aCgKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgZWxsaXBzb2lkLm1heGltdW1SYWRpdXMKICAgICAgICApOwogICAgICAgIGNvbnN0IHBlclNlZ21lbnRDb2xvcnMgPSBkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSAmJiAhY29sb3JzUGVyVmVydGV4OwogICAgICAgIGxldCBpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgbGV0IHBvc2l0aW9uVmFsdWVzOwogICAgICAgIGxldCBudW1iZXJPZlBvc2l0aW9uczsKICAgICAgICBsZXQgY29sb3JWYWx1ZXM7CiAgICAgICAgbGV0IGNvbG9yOwogICAgICAgIGxldCBvZmZzZXQgPSAwOwogICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMgfHwgYXJjVHlwZSA9PT0gQXJjVHlwZV9kZWZhdWx0LlJIVU1CKSB7CiAgICAgICAgICBsZXQgc3ViZGl2aXNpb25TaXplOwogICAgICAgICAgbGV0IG51bWJlck9mUG9pbnRzRnVuY3Rpb247CiAgICAgICAgICBsZXQgZ2VuZXJhdGVBcmNGdW5jdGlvbjsKICAgICAgICAgIGlmIChhcmNUeXBlID09PSBBcmNUeXBlX2RlZmF1bHQuR0VPREVTSUMpIHsKICAgICAgICAgICAgc3ViZGl2aXNpb25TaXplID0gTWF0aF9kZWZhdWx0LmNob3JkTGVuZ3RoKAogICAgICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgICAgIGVsbGlwc29pZC5tYXhpbXVtUmFkaXVzCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG51bWJlck9mUG9pbnRzRnVuY3Rpb24gPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQubnVtYmVyT2ZQb2ludHM7CiAgICAgICAgICAgIGdlbmVyYXRlQXJjRnVuY3Rpb24gPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVBcmM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdWJkaXZpc2lvblNpemUgPSBncmFudWxhcml0eTsKICAgICAgICAgICAgbnVtYmVyT2ZQb2ludHNGdW5jdGlvbiA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5udW1iZXJPZlBvaW50c1JodW1iTGluZTsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNGdW5jdGlvbiA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZVJodW1iQXJjOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgaGVpZ2h0cyA9IFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5leHRyYWN0SGVpZ2h0cyhwb3NpdGlvbnMsIGVsbGlwc29pZCk7CiAgICAgICAgICBjb25zdCBnZW5lcmF0ZUFyY09wdGlvbnMgPSBnZW5lcmF0ZUFyY09wdGlvbnNTY3JhdGNoOwogICAgICAgICAgaWYgKGFyY1R5cGUgPT09IEFyY1R5cGVfZGVmYXVsdC5HRU9ERVNJQykgewogICAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMubWluRGlzdGFuY2UgPSBtaW5EaXN0YW5jZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgICAgfQogICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLmVsbGlwc29pZCA9IGVsbGlwc29pZDsKICAgICAgICAgIGlmIChwZXJTZWdtZW50Q29sb3JzKSB7CiAgICAgICAgICAgIGxldCBwb3NpdGlvbkNvdW50ID0gMDsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgICAgIHBvc2l0aW9uQ291bnQgKz0gbnVtYmVyT2ZQb2ludHNGdW5jdGlvbigKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tpICsgMV0sCiAgICAgICAgICAgICAgICBzdWJkaXZpc2lvblNpemUKICAgICAgICAgICAgICApICsgMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwb3NpdGlvblZhbHVlcyA9IG5ldyBGbG9hdDY0QXJyYXkocG9zaXRpb25Db3VudCAqIDMpOwogICAgICAgICAgICBjb2xvclZhbHVlcyA9IG5ldyBVaW50OEFycmF5KHBvc2l0aW9uQ291bnQgKiA0KTsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLnBvc2l0aW9ucyA9IHNjcmF0Y2hBcnJheTE7CiAgICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5oZWlnaHQgPSBzY3JhdGNoQXJyYXkyOwogICAgICAgICAgICBsZXQgY2kgPSAwOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoIC0gMTsgKytpKSB7CiAgICAgICAgICAgICAgc2NyYXRjaEFycmF5MVswXSA9IHBvc2l0aW9uc1tpXTsKICAgICAgICAgICAgICBzY3JhdGNoQXJyYXkxWzFdID0gcG9zaXRpb25zW2kgKyAxXTsKICAgICAgICAgICAgICBzY3JhdGNoQXJyYXkyWzBdID0gaGVpZ2h0c1tpXTsKICAgICAgICAgICAgICBzY3JhdGNoQXJyYXkyWzFdID0gaGVpZ2h0c1tpICsgMV07CiAgICAgICAgICAgICAgY29uc3QgcG9zID0gZ2VuZXJhdGVBcmNGdW5jdGlvbihnZW5lcmF0ZUFyY09wdGlvbnMpOwogICAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSkgewogICAgICAgICAgICAgICAgY29uc3Qgc2VnTGVuID0gcG9zLmxlbmd0aCAvIDM7CiAgICAgICAgICAgICAgICBjb2xvciA9IGNvbG9yc1tpXTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgc2VnTGVuOyArK2spIHsKICAgICAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY2krK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLnJlZCk7CiAgICAgICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NpKytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShjb2xvci5ncmVlbik7CiAgICAgICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NpKytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShjb2xvci5ibHVlKTsKICAgICAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY2krK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmFscGhhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcG9zaXRpb25WYWx1ZXMuc2V0KHBvcywgb2Zmc2V0KTsKICAgICAgICAgICAgICBvZmZzZXQgKz0gcG9zLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLnBvc2l0aW9ucyA9IHBvc2l0aW9uczsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLmhlaWdodCA9IGhlaWdodHM7CiAgICAgICAgICAgIHBvc2l0aW9uVmFsdWVzID0gbmV3IEZsb2F0NjRBcnJheSgKICAgICAgICAgICAgICBnZW5lcmF0ZUFyY0Z1bmN0aW9uKGdlbmVyYXRlQXJjT3B0aW9ucykKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpKSB7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXMgPSBuZXcgVWludDhBcnJheShwb3NpdGlvblZhbHVlcy5sZW5ndGggLyAzICogNCk7CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aCAtIDE7ICsraSkgewogICAgICAgICAgICAgICAgY29uc3QgcDAgPSBwb3NpdGlvbnNbaV07CiAgICAgICAgICAgICAgICBjb25zdCBwMSA9IHBvc2l0aW9uc1tpICsgMV07CiAgICAgICAgICAgICAgICBjb25zdCBjMCA9IGNvbG9yc1tpXTsKICAgICAgICAgICAgICAgIGNvbnN0IGMxID0gY29sb3JzW2kgKyAxXTsKICAgICAgICAgICAgICAgIG9mZnNldCA9IGludGVycG9sYXRlQ29sb3JzMigKICAgICAgICAgICAgICAgICAgcDAsCiAgICAgICAgICAgICAgICAgIHAxLAogICAgICAgICAgICAgICAgICBjMCwKICAgICAgICAgICAgICAgICAgYzEsCiAgICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlLAogICAgICAgICAgICAgICAgICBjb2xvclZhbHVlcywKICAgICAgICAgICAgICAgICAgb2Zmc2V0CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCBsYXN0Q29sb3IgPSBjb2xvcnNbbGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbb2Zmc2V0KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShsYXN0Q29sb3IucmVkKTsKICAgICAgICAgICAgICBjb2xvclZhbHVlc1tvZmZzZXQrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGxhc3RDb2xvci5ncmVlbik7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbb2Zmc2V0KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShsYXN0Q29sb3IuYmx1ZSk7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbb2Zmc2V0KytdID0gQ29sb3JfZGVmYXVsdC5mbG9hdFRvQnl0ZShsYXN0Q29sb3IuYWxwaGEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG51bWJlck9mUG9zaXRpb25zID0gcGVyU2VnbWVudENvbG9ycyA/IGxlbmd0aCAqIDIgLSAyIDogbGVuZ3RoOwogICAgICAgICAgcG9zaXRpb25WYWx1ZXMgPSBuZXcgRmxvYXQ2NEFycmF5KG51bWJlck9mUG9zaXRpb25zICogMyk7CiAgICAgICAgICBjb2xvclZhbHVlcyA9IGRlZmluZWRfZGVmYXVsdChjb2xvcnMpID8gbmV3IFVpbnQ4QXJyYXkobnVtYmVyT2ZQb3NpdGlvbnMgKiA0KSA6IHZvaWQgMDsKICAgICAgICAgIGxldCBwb3NpdGlvbkluZGV4ID0gMDsKICAgICAgICAgIGxldCBjb2xvckluZGV4ID0gMDsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBjb25zdCBwID0gcG9zaXRpb25zW2ldOwogICAgICAgICAgICBpZiAocGVyU2VnbWVudENvbG9ycyAmJiBpID4gMCkgewogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHAsIHBvc2l0aW9uVmFsdWVzLCBwb3NpdGlvbkluZGV4KTsKICAgICAgICAgICAgICBwb3NpdGlvbkluZGV4ICs9IDM7CiAgICAgICAgICAgICAgY29sb3IgPSBjb2xvcnNbaSAtIDFdOwogICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLnJlZCk7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuZ3JlZW4pOwogICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmJsdWUpOwogICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmFscGhhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGVyU2VnbWVudENvbG9ycyAmJiBpID09PSBsZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socCwgcG9zaXRpb25WYWx1ZXMsIHBvc2l0aW9uSW5kZXgpOwogICAgICAgICAgICBwb3NpdGlvbkluZGV4ICs9IDM7CiAgICAgICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSkgewogICAgICAgICAgICAgIGNvbG9yID0gY29sb3JzW2ldOwogICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLnJlZCk7CiAgICAgICAgICAgICAgY29sb3JWYWx1ZXNbY29sb3JJbmRleCsrXSA9IENvbG9yX2RlZmF1bHQuZmxvYXRUb0J5dGUoY29sb3IuZ3JlZW4pOwogICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmJsdWUpOwogICAgICAgICAgICAgIGNvbG9yVmFsdWVzW2NvbG9ySW5kZXgrK10gPSBDb2xvcl9kZWZhdWx0LmZsb2F0VG9CeXRlKGNvbG9yLmFscGhhKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkRPVUJMRSwKICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9uVmFsdWVzCiAgICAgICAgfSk7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChjb2xvcnMpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLmNvbG9yID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiA0LAogICAgICAgICAgICB2YWx1ZXM6IGNvbG9yVmFsdWVzLAogICAgICAgICAgICBub3JtYWxpemU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBudW1iZXJPZlBvc2l0aW9ucyA9IHBvc2l0aW9uVmFsdWVzLmxlbmd0aCAvIDM7CiAgICAgICAgY29uc3QgbnVtYmVyT2ZJbmRpY2VzID0gKG51bWJlck9mUG9zaXRpb25zIC0gMSkgKiAyOwogICAgICAgIGNvbnN0IGluZGljZXMgPSBJbmRleERhdGF0eXBlX2RlZmF1bHQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgICAgIG51bWJlck9mUG9zaXRpb25zLAogICAgICAgICAgbnVtYmVyT2ZJbmRpY2VzCiAgICAgICAgKTsKICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1iZXJPZlBvc2l0aW9ucyAtIDE7ICsraSkgewogICAgICAgICAgaW5kaWNlc1tpbmRleCsrXSA9IGk7CiAgICAgICAgICBpbmRpY2VzW2luZGV4KytdID0gaSArIDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21Qb2ludHMocG9zaXRpb25zKQogICAgICAgIH0pOwogICAgICB9OwogICAgICBTaW1wbGVQb2x5bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBTaW1wbGVQb2x5bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnkoc2ltcGxlUG9seWxpbmVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgc2ltcGxlUG9seWxpbmVHZW9tZXRyeSA9IFNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soCiAgICAgICAgc2ltcGxlUG9seWxpbmVHZW9tZXRyeSwKICAgICAgICBvZmZzZXQKICAgICAgKTsKICAgIH0KICAgIHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKAogICAgICBzaW1wbGVQb2x5bGluZUdlb21ldHJ5Ll9lbGxpcHNvaWQKICAgICk7CiAgICByZXR1cm4gU2ltcGxlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHNpbXBsZVBvbHlsaW5lR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9TaW1wbGVQb2x5bGluZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9TcGhlcmVHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIFNwaGVyZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIGNvbnN0IHJhZGl1cyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMucmFkaXVzLCAxKTsKICAgIGNvbnN0IHJhZGlpID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdChyYWRpdXMsIHJhZGl1cywgcmFkaXVzKTsKICAgIGNvbnN0IGVsbGlwc29pZE9wdGlvbnMgPSB7CiAgICAgIHJhZGlpLAogICAgICBzdGFja1BhcnRpdGlvbnM6IG9wdGlvbnMuc3RhY2tQYXJ0aXRpb25zLAogICAgICBzbGljZVBhcnRpdGlvbnM6IG9wdGlvbnMuc2xpY2VQYXJ0aXRpb25zLAogICAgICB2ZXJ0ZXhGb3JtYXQ6IG9wdGlvbnMudmVydGV4Rm9ybWF0CiAgICB9OwogICAgdGhpcy5fZWxsaXBzb2lkR2VvbWV0cnkgPSBuZXcgRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdChlbGxpcHNvaWRPcHRpb25zKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlU3BoZXJlR2VvbWV0cnkiOwogIH0KICB2YXIgc2NyYXRjaEVsbGlwc29pZEdlb21ldHJ5LCBzY3JhdGNoT3B0aW9uczIxLCBTcGhlcmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1NwaGVyZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9TcGhlcmVHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZEdlb21ldHJ5KCk7CiAgICAgIGluaXRfVmVydGV4Rm9ybWF0KCk7CiAgICAgIFNwaGVyZUdlb21ldHJ5LnBhY2tlZExlbmd0aCA9IEVsbGlwc29pZEdlb21ldHJ5X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICBTcGhlcmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICByZXR1cm4gRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWRHZW9tZXRyeSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkR2VvbWV0cnkgPSBuZXcgRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczIxID0gewogICAgICAgIHJhZGl1czogdm9pZCAwLAogICAgICAgIHJhZGlpOiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksCiAgICAgICAgdmVydGV4Rm9ybWF0OiBuZXcgVmVydGV4Rm9ybWF0X2RlZmF1bHQoKSwKICAgICAgICBzdGFja1BhcnRpdGlvbnM6IHZvaWQgMCwKICAgICAgICBzbGljZVBhcnRpdGlvbnM6IHZvaWQgMAogICAgICB9OwogICAgICBTcGhlcmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkR2VvbWV0cnkgPSBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0LnVucGFjaygKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleCwKICAgICAgICAgIHNjcmF0Y2hFbGxpcHNvaWRHZW9tZXRyeQogICAgICAgICk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnMyMS52ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5jbG9uZSgKICAgICAgICAgIGVsbGlwc29pZEdlb21ldHJ5Ll92ZXJ0ZXhGb3JtYXQsCiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIxLnZlcnRleEZvcm1hdAogICAgICAgICk7CiAgICAgICAgc2NyYXRjaE9wdGlvbnMyMS5zdGFja1BhcnRpdGlvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc3RhY2tQYXJ0aXRpb25zOwogICAgICAgIHNjcmF0Y2hPcHRpb25zMjEuc2xpY2VQYXJ0aXRpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuX3NsaWNlUGFydGl0aW9uczsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIxLnJhZGl1cyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9yYWRpaS54OwogICAgICAgICAgcmV0dXJuIG5ldyBTcGhlcmVHZW9tZXRyeShzY3JhdGNoT3B0aW9uczIxKTsKICAgICAgICB9CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGVsbGlwc29pZEdlb21ldHJ5Ll9yYWRpaSwgc2NyYXRjaE9wdGlvbnMyMS5yYWRpaSk7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWRHZW9tZXRyeSA9IG5ldyBFbGxpcHNvaWRHZW9tZXRyeV9kZWZhdWx0KHNjcmF0Y2hPcHRpb25zMjEpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFNwaGVyZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oc3BoZXJlR2VvbWV0cnkpIHsKICAgICAgICByZXR1cm4gRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeShzcGhlcmVHZW9tZXRyeS5fZWxsaXBzb2lkR2VvbWV0cnkpOwogICAgICB9OwogICAgICBTcGhlcmVHZW9tZXRyeV9kZWZhdWx0ID0gU3BoZXJlR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVTcGhlcmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVTcGhlcmVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlU3BoZXJlR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlU3BoZXJlR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVNwaGVyZUdlb21ldHJ5KHNwaGVyZUdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICBzcGhlcmVHZW9tZXRyeSA9IFNwaGVyZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHNwaGVyZUdlb21ldHJ5LCBvZmZzZXQpOwogICAgfQogICAgcmV0dXJuIFNwaGVyZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoc3BoZXJlR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlU3BoZXJlR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVTcGhlcmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlU3BoZXJlR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9TcGhlcmVHZW9tZXRyeSgpOwogICAgICBjcmVhdGVTcGhlcmVHZW9tZXRyeV9kZWZhdWx0ID0gY3JlYXRlU3BoZXJlR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9TcGhlcmVPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBTcGhlcmVPdXRsaW5lR2VvbWV0cnkob3B0aW9ucykgewogICAgY29uc3QgcmFkaXVzID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5yYWRpdXMsIDEpOwogICAgY29uc3QgcmFkaWkgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KHJhZGl1cywgcmFkaXVzLCByYWRpdXMpOwogICAgY29uc3QgZWxsaXBzb2lkT3B0aW9ucyA9IHsKICAgICAgcmFkaWksCiAgICAgIHN0YWNrUGFydGl0aW9uczogb3B0aW9ucy5zdGFja1BhcnRpdGlvbnMsCiAgICAgIHNsaWNlUGFydGl0aW9uczogb3B0aW9ucy5zbGljZVBhcnRpdGlvbnMsCiAgICAgIHN1YmRpdmlzaW9uczogb3B0aW9ucy5zdWJkaXZpc2lvbnMKICAgIH07CiAgICB0aGlzLl9lbGxpcHNvaWRHZW9tZXRyeSA9IG5ldyBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdChlbGxpcHNvaWRPcHRpb25zKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5IjsKICB9CiAgdmFyIHNjcmF0Y2hFbGxpcHNvaWRHZW9tZXRyeTIsIHNjcmF0Y2hPcHRpb25zMjIsIFNwaGVyZU91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1NwaGVyZU91dGxpbmVHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvU3BoZXJlT3V0bGluZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIFNwaGVyZU91dGxpbmVHZW9tZXRyeS5wYWNrZWRMZW5ndGggPSBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgIFNwaGVyZU91dGxpbmVHZW9tZXRyeS5wYWNrID0gZnVuY3Rpb24odmFsdWUsIGFycmF5LCBzdGFydGluZ0luZGV4KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ2YWx1ZSIsIHZhbHVlKTsKICAgICAgICByZXR1cm4gRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQucGFjaygKICAgICAgICAgIHZhbHVlLl9lbGxpcHNvaWRHZW9tZXRyeSwKICAgICAgICAgIGFycmF5LAogICAgICAgICAgc3RhcnRpbmdJbmRleAogICAgICAgICk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWRHZW9tZXRyeTIgPSBuZXcgRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE9wdGlvbnMyMiA9IHsKICAgICAgICByYWRpdXM6IHZvaWQgMCwKICAgICAgICByYWRpaTogbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLAogICAgICAgIHN0YWNrUGFydGl0aW9uczogdm9pZCAwLAogICAgICAgIHNsaWNlUGFydGl0aW9uczogdm9pZCAwLAogICAgICAgIHN1YmRpdmlzaW9uczogdm9pZCAwCiAgICAgIH07CiAgICAgIFNwaGVyZU91dGxpbmVHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkR2VvbWV0cnkgPSBFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoRWxsaXBzb2lkR2VvbWV0cnkyCiAgICAgICAgKTsKICAgICAgICBzY3JhdGNoT3B0aW9uczIyLnN0YWNrUGFydGl0aW9ucyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9zdGFja1BhcnRpdGlvbnM7CiAgICAgICAgc2NyYXRjaE9wdGlvbnMyMi5zbGljZVBhcnRpdGlvbnMgPSBlbGxpcHNvaWRHZW9tZXRyeS5fc2xpY2VQYXJ0aXRpb25zOwogICAgICAgIHNjcmF0Y2hPcHRpb25zMjIuc3ViZGl2aXNpb25zID0gZWxsaXBzb2lkR2VvbWV0cnkuX3N1YmRpdmlzaW9uczsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIyLnJhZGl1cyA9IGVsbGlwc29pZEdlb21ldHJ5Ll9yYWRpaS54OwogICAgICAgICAgcmV0dXJuIG5ldyBTcGhlcmVPdXRsaW5lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMyMik7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWRHZW9tZXRyeS5fcmFkaWksIHNjcmF0Y2hPcHRpb25zMjIucmFkaWkpOwogICAgICAgIHJlc3VsdC5fZWxsaXBzb2lkR2VvbWV0cnkgPSBuZXcgRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQoc2NyYXRjaE9wdGlvbnMyMik7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgU3BoZXJlT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24oc3BoZXJlR2VvbWV0cnkpIHsKICAgICAgICByZXR1cm4gRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoCiAgICAgICAgICBzcGhlcmVHZW9tZXRyeS5fZWxsaXBzb2lkR2VvbWV0cnkKICAgICAgICApOwogICAgICB9OwogICAgICBTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IFNwaGVyZU91dGxpbmVHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeShzcGhlcmVHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgc3BoZXJlR2VvbWV0cnkgPSBTcGhlcmVPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC51bnBhY2soc3BoZXJlR2VvbWV0cnksIG9mZnNldCk7CiAgICB9CiAgICByZXR1cm4gU3BoZXJlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQuY3JlYXRlR2VvbWV0cnkoc3BoZXJlR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9TcGhlcmVPdXRsaW5lR2VvbWV0cnkoKTsKICAgICAgY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lcy5qcwogIHZhciBjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lc19leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXNfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXNfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGRlY29kZVBvc2l0aW9ucyh1QnVmZmVyLCB2QnVmZmVyLCBoZWlnaHRCdWZmZXIsIHJlY3RhbmdsZSwgbWluaW11bUhlaWdodCwgbWF4aW11bUhlaWdodCwgZWxsaXBzb2lkKSB7CiAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSB1QnVmZmVyLmxlbmd0aDsKICAgIGNvbnN0IGRlY29kZWRQb3NpdGlvbnMgPSBuZXcgRmxvYXQ2NEFycmF5KHBvc2l0aW9uc0xlbmd0aCAqIDMpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7ICsraSkgewogICAgICBjb25zdCB1MyA9IHVCdWZmZXJbaV07CiAgICAgIGNvbnN0IHYzID0gdkJ1ZmZlcltpXTsKICAgICAgY29uc3QgaCA9IGhlaWdodEJ1ZmZlcltpXTsKICAgICAgY29uc3QgbG9uID0gTWF0aF9kZWZhdWx0LmxlcnAocmVjdGFuZ2xlLndlc3QsIHJlY3RhbmdsZS5lYXN0LCB1MyAvIE1BWF9TSE9SVCk7CiAgICAgIGNvbnN0IGxhdCA9IE1hdGhfZGVmYXVsdC5sZXJwKAogICAgICAgIHJlY3RhbmdsZS5zb3V0aCwKICAgICAgICByZWN0YW5nbGUubm9ydGgsCiAgICAgICAgdjMgLyBNQVhfU0hPUlQKICAgICAgKTsKICAgICAgY29uc3QgYWx0ID0gTWF0aF9kZWZhdWx0LmxlcnAobWluaW11bUhlaWdodCwgbWF4aW11bUhlaWdodCwgaCAvIE1BWF9TSE9SVCk7CiAgICAgIGNvbnN0IGNhcnRvZ3JhcGhpYzIgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICBsb24sCiAgICAgICAgbGF0LAogICAgICAgIGFsdCwKICAgICAgICBzY3JhdGNoQlZDYXJ0b2dyYXBoaWMKICAgICAgKTsKICAgICAgY29uc3QgZGVjb2RlZFBvc2l0aW9uID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgIGNhcnRvZ3JhcGhpYzIsCiAgICAgICAgc2NyYXRjaEVuY29kZWRQb3NpdGlvbgogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhkZWNvZGVkUG9zaXRpb24sIGRlY29kZWRQb3NpdGlvbnMsIGkgKiAzKTsKICAgIH0KICAgIHJldHVybiBkZWNvZGVkUG9zaXRpb25zOwogIH0KICBmdW5jdGlvbiBnZXRQb3NpdGlvbk9mZnNldHMoY291bnRzKSB7CiAgICBjb25zdCBjb3VudHNMZW5ndGggPSBjb3VudHMubGVuZ3RoOwogICAgY29uc3QgcG9zaXRpb25PZmZzZXRzID0gbmV3IFVpbnQzMkFycmF5KGNvdW50c0xlbmd0aCArIDEpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50c0xlbmd0aDsgKytpKSB7CiAgICAgIHBvc2l0aW9uT2Zmc2V0c1tpXSA9IG9mZnNldDsKICAgICAgb2Zmc2V0ICs9IGNvdW50c1tpXTsKICAgIH0KICAgIHBvc2l0aW9uT2Zmc2V0c1tjb3VudHNMZW5ndGhdID0gb2Zmc2V0OwogICAgcmV0dXJuIHBvc2l0aW9uT2Zmc2V0czsKICB9CiAgZnVuY3Rpb24gcmVtb3ZlRHVwbGljYXRlcyh1QnVmZmVyLCB2QnVmZmVyLCBoZWlnaHRCdWZmZXIsIGNvdW50cykgewogICAgY29uc3QgY291bnRzTGVuZ3RoID0gY291bnRzLmxlbmd0aDsKICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IHVCdWZmZXIubGVuZ3RoOwogICAgY29uc3QgbWFya1JlbW92YWwgPSBuZXcgVWludDhBcnJheShwb3NpdGlvbnNMZW5ndGgpOwogICAgY29uc3QgcHJldmlvdXMgPSBwcmV2aW91c0NvbXByZXNzZWRDYXJ0b2dyYXBoaWNTY3JhdGNoOwogICAgY29uc3QgY3VycmVudCA9IGN1cnJlbnRDb21wcmVzc2VkQ2FydG9ncmFwaGljU2NyYXRjaDsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudHNMZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjb3VudCA9IGNvdW50c1tpXTsKICAgICAgbGV0IHVwZGF0ZWRDb3VudCA9IGNvdW50OwogICAgICBmb3IgKGxldCBqID0gMTsgaiA8IGNvdW50OyBqKyspIHsKICAgICAgICBjb25zdCBpbmRleCA9IG9mZnNldCArIGo7CiAgICAgICAgY29uc3QgcHJldmlvdXNJbmRleCA9IGluZGV4IC0gMTsKICAgICAgICBjdXJyZW50LmxvbmdpdHVkZSA9IHVCdWZmZXJbaW5kZXhdOwogICAgICAgIGN1cnJlbnQubGF0aXR1ZGUgPSB2QnVmZmVyW2luZGV4XTsKICAgICAgICBwcmV2aW91cy5sb25naXR1ZGUgPSB1QnVmZmVyW3ByZXZpb3VzSW5kZXhdOwogICAgICAgIHByZXZpb3VzLmxhdGl0dWRlID0gdkJ1ZmZlcltwcmV2aW91c0luZGV4XTsKICAgICAgICBpZiAoQ2FydG9ncmFwaGljX2RlZmF1bHQuZXF1YWxzKGN1cnJlbnQsIHByZXZpb3VzKSkgewogICAgICAgICAgdXBkYXRlZENvdW50LS07CiAgICAgICAgICBtYXJrUmVtb3ZhbFtwcmV2aW91c0luZGV4XSA9IDE7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvdW50c1tpXSA9IHVwZGF0ZWRDb3VudDsKICAgICAgb2Zmc2V0ICs9IGNvdW50OwogICAgfQogICAgbGV0IG5leHRBdmFpbGFibGVJbmRleCA9IDA7CiAgICBmb3IgKGxldCBrID0gMDsgayA8IHBvc2l0aW9uc0xlbmd0aDsgaysrKSB7CiAgICAgIGlmIChtYXJrUmVtb3ZhbFtrXSAhPT0gMSkgewogICAgICAgIHVCdWZmZXJbbmV4dEF2YWlsYWJsZUluZGV4XSA9IHVCdWZmZXJba107CiAgICAgICAgdkJ1ZmZlcltuZXh0QXZhaWxhYmxlSW5kZXhdID0gdkJ1ZmZlcltrXTsKICAgICAgICBoZWlnaHRCdWZmZXJbbmV4dEF2YWlsYWJsZUluZGV4XSA9IGhlaWdodEJ1ZmZlcltrXTsKICAgICAgICBuZXh0QXZhaWxhYmxlSW5kZXgrKzsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBWZXJ0ZXhBdHRyaWJ1dGVzQW5kSW5kaWNlcyh2b2x1bWVzQ291bnQpIHsKICAgIGNvbnN0IHZlcnRleENvdW50ID0gdm9sdW1lc0NvdW50ICogODsKICAgIGNvbnN0IHZlYzNGbG9hdHMgPSB2ZXJ0ZXhDb3VudCAqIDM7CiAgICBjb25zdCB2ZWM0RmxvYXRzID0gdmVydGV4Q291bnQgKiA0OwogICAgdGhpcy5zdGFydEVsbGlwc29pZE5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KHZlYzNGbG9hdHMpOwogICAgdGhpcy5lbmRFbGxpcHNvaWROb3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheSh2ZWMzRmxvYXRzKTsKICAgIHRoaXMuc3RhcnRQb3NpdGlvbkFuZEhlaWdodHMgPSBuZXcgRmxvYXQzMkFycmF5KHZlYzRGbG9hdHMpOwogICAgdGhpcy5zdGFydEZhY2VOb3JtYWxBbmRWZXJ0ZXhDb3JuZXJJZHMgPSBuZXcgRmxvYXQzMkFycmF5KHZlYzRGbG9hdHMpOwogICAgdGhpcy5lbmRQb3NpdGlvbkFuZEhlaWdodHMgPSBuZXcgRmxvYXQzMkFycmF5KHZlYzRGbG9hdHMpOwogICAgdGhpcy5lbmRGYWNlTm9ybWFsQW5kSGFsZldpZHRocyA9IG5ldyBGbG9hdDMyQXJyYXkodmVjNEZsb2F0cyk7CiAgICB0aGlzLnZlcnRleEJhdGNoSWRzID0gbmV3IFVpbnQxNkFycmF5KHZlcnRleENvdW50KTsKICAgIHRoaXMuaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KHZlcnRleENvdW50LCAzNiAqIHZvbHVtZXNDb3VudCk7CiAgICB0aGlzLnZlYzNPZmZzZXQgPSAwOwogICAgdGhpcy52ZWM0T2Zmc2V0ID0gMDsKICAgIHRoaXMuYmF0Y2hJZE9mZnNldCA9IDA7CiAgICB0aGlzLmluZGV4T2Zmc2V0ID0gMDsKICAgIHRoaXMudm9sdW1lU3RhcnRJbmRleCA9IDA7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVNaXRlcmVkTm9ybWFsKHByZXZpb3VzUG9zaXRpb24sIHBvc2l0aW9uLCBuZXh0UG9zaXRpb24sIGVsbGlwc29pZFN1cmZhY2VOb3JtYWwsIHJlc3VsdCkgewogICAgY29uc3QgdG93YXJkTmV4dCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgbmV4dFBvc2l0aW9uLAogICAgICBwb3NpdGlvbiwKICAgICAgdG93YXJkTmV4dFNjcmF0Y2gKICAgICk7CiAgICBsZXQgdG93YXJkQ3VyciA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgcG9zaXRpb24sCiAgICAgIHByZXZpb3VzUG9zaXRpb24sCiAgICAgIHRvd2FyZEN1cnJTY3JhdGNoCiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSh0b3dhcmROZXh0LCB0b3dhcmROZXh0KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUodG93YXJkQ3VyciwgdG93YXJkQ3Vycik7CiAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmRvdCh0b3dhcmROZXh0LCB0b3dhcmRDdXJyKSA8IE1JVEVSX0JSRUFLKSB7CiAgICAgIHRvd2FyZEN1cnIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubXVsdGlwbHlCeVNjYWxhcigKICAgICAgICB0b3dhcmRDdXJyLAogICAgICAgIC0xLAogICAgICAgIHRvd2FyZEN1cnJTY3JhdGNoCiAgICAgICk7CiAgICB9CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHRvd2FyZE5leHQsIHRvd2FyZEN1cnIsIHJlc3VsdCk7CiAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhyZXN1bHQsIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPKSkgewogICAgICByZXN1bHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocHJldmlvdXNQb3NpdGlvbiwgcG9zaXRpb24pOwogICAgfQogICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKHJlc3VsdCwgZWxsaXBzb2lkU3VyZmFjZU5vcm1hbCwgcmVzdWx0KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhlbGxpcHNvaWRTdXJmYWNlTm9ybWFsLCByZXN1bHQsIHJlc3VsdCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKHJlc3VsdCwgcmVzdWx0KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IGVuY29kZWRQb3NpdGlvbnMgPSBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5wb3NpdGlvbnMpOwogICAgY29uc3Qgd2lkdGhzID0gbmV3IFVpbnQxNkFycmF5KHBhcmFtZXRlcnMud2lkdGhzKTsKICAgIGNvbnN0IGNvdW50cyA9IG5ldyBVaW50MzJBcnJheShwYXJhbWV0ZXJzLmNvdW50cyk7CiAgICBjb25zdCBiYXRjaElkcyA9IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLmJhdGNoSWRzKTsKICAgIGNvbnN0IHJlY3RhbmdsZSA9IHNjcmF0Y2hSZWN0YW5nbGUzOwogICAgY29uc3QgZWxsaXBzb2lkID0gc2NyYXRjaEVsbGlwc29pZDEzOwogICAgY29uc3QgY2VudGVyID0gc2NyYXRjaENlbnRlcjQ7CiAgICBjb25zdCBwYWNrZWRCdWZmZXIgPSBuZXcgRmxvYXQ2NEFycmF5KHBhcmFtZXRlcnMucGFja2VkQnVmZmVyKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgY29uc3QgbWluaW11bUhlaWdodCA9IHBhY2tlZEJ1ZmZlcltvZmZzZXQrK107CiAgICBjb25zdCBtYXhpbXVtSGVpZ2h0ID0gcGFja2VkQnVmZmVyW29mZnNldCsrXTsKICAgIFJlY3RhbmdsZV9kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgcmVjdGFuZ2xlKTsKICAgIG9mZnNldCArPSBSZWN0YW5nbGVfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBFbGxpcHNvaWRfZGVmYXVsdC51bnBhY2socGFja2VkQnVmZmVyLCBvZmZzZXQsIGVsbGlwc29pZCk7CiAgICBvZmZzZXQgKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgY2VudGVyKTsKICAgIGxldCBpOwogICAgbGV0IHBvc2l0aW9uc0xlbmd0aCA9IGVuY29kZWRQb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IHVCdWZmZXIgPSBlbmNvZGVkUG9zaXRpb25zLnN1YmFycmF5KDAsIHBvc2l0aW9uc0xlbmd0aCk7CiAgICBjb25zdCB2QnVmZmVyID0gZW5jb2RlZFBvc2l0aW9ucy5zdWJhcnJheSgKICAgICAgcG9zaXRpb25zTGVuZ3RoLAogICAgICAyICogcG9zaXRpb25zTGVuZ3RoCiAgICApOwogICAgY29uc3QgaGVpZ2h0QnVmZmVyID0gZW5jb2RlZFBvc2l0aW9ucy5zdWJhcnJheSgKICAgICAgMiAqIHBvc2l0aW9uc0xlbmd0aCwKICAgICAgMyAqIHBvc2l0aW9uc0xlbmd0aAogICAgKTsKICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuemlnWmFnRGVsdGFEZWNvZGUodUJ1ZmZlciwgdkJ1ZmZlciwgaGVpZ2h0QnVmZmVyKTsKICAgIHJlbW92ZUR1cGxpY2F0ZXModUJ1ZmZlciwgdkJ1ZmZlciwgaGVpZ2h0QnVmZmVyLCBjb3VudHMpOwogICAgY29uc3QgY291bnRzTGVuZ3RoID0gY291bnRzLmxlbmd0aDsKICAgIGxldCB2b2x1bWVzQ291bnQgPSAwOwogICAgZm9yIChpID0gMDsgaSA8IGNvdW50c0xlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHBvbHlsaW5lUG9zaXRpb25Db3VudCA9IGNvdW50c1tpXTsKICAgICAgdm9sdW1lc0NvdW50ICs9IHBvbHlsaW5lUG9zaXRpb25Db3VudCAtIDE7CiAgICB9CiAgICBjb25zdCBhdHRyaWJzQW5kSW5kaWNlcyA9IG5ldyBWZXJ0ZXhBdHRyaWJ1dGVzQW5kSW5kaWNlcyh2b2x1bWVzQ291bnQpOwogICAgY29uc3QgcG9zaXRpb25zID0gZGVjb2RlUG9zaXRpb25zKAogICAgICB1QnVmZmVyLAogICAgICB2QnVmZmVyLAogICAgICBoZWlnaHRCdWZmZXIsCiAgICAgIHJlY3RhbmdsZSwKICAgICAgbWluaW11bUhlaWdodCwKICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgZWxsaXBzb2lkLAogICAgICBjZW50ZXIKICAgICk7CiAgICBwb3NpdGlvbnNMZW5ndGggPSB1QnVmZmVyLmxlbmd0aDsKICAgIGNvbnN0IHBvc2l0aW9uc1JUQyA9IG5ldyBGbG9hdDMyQXJyYXkocG9zaXRpb25zTGVuZ3RoICogMyk7CiAgICBmb3IgKGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyArK2kpIHsKICAgICAgcG9zaXRpb25zUlRDW2kgKiAzXSA9IHBvc2l0aW9uc1tpICogM10gLSBjZW50ZXIueDsKICAgICAgcG9zaXRpb25zUlRDW2kgKiAzICsgMV0gPSBwb3NpdGlvbnNbaSAqIDMgKyAxXSAtIGNlbnRlci55OwogICAgICBwb3NpdGlvbnNSVENbaSAqIDMgKyAyXSA9IHBvc2l0aW9uc1tpICogMyArIDJdIC0gY2VudGVyLno7CiAgICB9CiAgICBsZXQgY3VycmVudFBvc2l0aW9uSW5kZXggPSAwOwogICAgbGV0IGN1cnJlbnRIZWlnaHRJbmRleCA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgY291bnRzTGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcG9seWxpbmVWb2x1bWVDb3VudCA9IGNvdW50c1tpXSAtIDE7CiAgICAgIGNvbnN0IGhhbGZXaWR0aCA9IHdpZHRoc1tpXSAqIDAuNTsKICAgICAgY29uc3QgYmF0Y2hJZCA9IGJhdGNoSWRzW2ldOwogICAgICBjb25zdCB2b2x1bWVGaXJzdFBvc2l0aW9uSW5kZXggPSBjdXJyZW50UG9zaXRpb25JbmRleDsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBwb2x5bGluZVZvbHVtZUNvdW50OyBqKyspIHsKICAgICAgICBjb25zdCB2b2x1bWVTdGFydCA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBwb3NpdGlvbnNSVEMsCiAgICAgICAgICBjdXJyZW50UG9zaXRpb25JbmRleCwKICAgICAgICAgIHNjcmF0Y2hQMAogICAgICAgICk7CiAgICAgICAgY29uc3Qgdm9sdW1lRW5kID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgIHBvc2l0aW9uc1JUQywKICAgICAgICAgIGN1cnJlbnRQb3NpdGlvbkluZGV4ICsgMywKICAgICAgICAgIHNjcmF0Y2hQMQogICAgICAgICk7CiAgICAgICAgbGV0IHN0YXJ0SGVpZ2h0ID0gaGVpZ2h0QnVmZmVyW2N1cnJlbnRIZWlnaHRJbmRleF07CiAgICAgICAgbGV0IGVuZEhlaWdodCA9IGhlaWdodEJ1ZmZlcltjdXJyZW50SGVpZ2h0SW5kZXggKyAxXTsKICAgICAgICBzdGFydEhlaWdodCA9IE1hdGhfZGVmYXVsdC5sZXJwKAogICAgICAgICAgbWluaW11bUhlaWdodCwKICAgICAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgICAgICBzdGFydEhlaWdodCAvIE1BWF9TSE9SVAogICAgICAgICk7CiAgICAgICAgZW5kSGVpZ2h0ID0gTWF0aF9kZWZhdWx0LmxlcnAoCiAgICAgICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgIGVuZEhlaWdodCAvIE1BWF9TSE9SVAogICAgICAgICk7CiAgICAgICAgY3VycmVudEhlaWdodEluZGV4Kys7CiAgICAgICAgbGV0IHByZVN0YXJ0ID0gc2NyYXRjaFByZXY7CiAgICAgICAgbGV0IHBvc3RFbmQgPSBzY3JhdGNoTmV4dDsKICAgICAgICBpZiAoaiA9PT0gMCkgewogICAgICAgICAgY29uc3QgZmluYWxQb3NpdGlvbkluZGV4ID0gdm9sdW1lRmlyc3RQb3NpdGlvbkluZGV4ICsgcG9seWxpbmVWb2x1bWVDb3VudCAqIDM7CiAgICAgICAgICBjb25zdCBmaW5hbFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgcG9zaXRpb25zUlRDLAogICAgICAgICAgICBmaW5hbFBvc2l0aW9uSW5kZXgsCiAgICAgICAgICAgIHNjcmF0Y2hQcmV2CiAgICAgICAgICApOwogICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMoZmluYWxQb3NpdGlvbiwgdm9sdW1lU3RhcnQpKSB7CiAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socG9zaXRpb25zUlRDLCBmaW5hbFBvc2l0aW9uSW5kZXggLSAzLCBwcmVTdGFydCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBvZmZzZXRQYXN0U3RhcnQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICAgICAgdm9sdW1lU3RhcnQsCiAgICAgICAgICAgICAgdm9sdW1lRW5kLAogICAgICAgICAgICAgIHNjcmF0Y2hQcmV2CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHByZVN0YXJ0ID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChvZmZzZXRQYXN0U3RhcnQsIHZvbHVtZVN0YXJ0LCBzY3JhdGNoUHJldik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socG9zaXRpb25zUlRDLCBjdXJyZW50UG9zaXRpb25JbmRleCAtIDMsIHByZVN0YXJ0KTsKICAgICAgICB9CiAgICAgICAgaWYgKGogPT09IHBvbHlsaW5lVm9sdW1lQ291bnQgLSAxKSB7CiAgICAgICAgICBjb25zdCBmaXJzdFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgcG9zaXRpb25zUlRDLAogICAgICAgICAgICB2b2x1bWVGaXJzdFBvc2l0aW9uSW5kZXgsCiAgICAgICAgICAgIHNjcmF0Y2hOZXh0CiAgICAgICAgICApOwogICAgICAgICAgaWYgKENhcnRlc2lhbjNfZGVmYXVsdC5lcXVhbHMoZmlyc3RQb3NpdGlvbiwgdm9sdW1lRW5kKSkgewogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICAgIHBvc2l0aW9uc1JUQywKICAgICAgICAgICAgICB2b2x1bWVGaXJzdFBvc2l0aW9uSW5kZXggKyAzLAogICAgICAgICAgICAgIHBvc3RFbmQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IG9mZnNldFBhc3RFbmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgICAgICAgICAgdm9sdW1lRW5kLAogICAgICAgICAgICAgIHZvbHVtZVN0YXJ0LAogICAgICAgICAgICAgIHNjcmF0Y2hOZXh0CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHBvc3RFbmQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKG9mZnNldFBhc3RFbmQsIHZvbHVtZUVuZCwgc2NyYXRjaE5leHQpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHBvc2l0aW9uc1JUQywgY3VycmVudFBvc2l0aW9uSW5kZXggKyA2LCBwb3N0RW5kKTsKICAgICAgICB9CiAgICAgICAgYXR0cmlic0FuZEluZGljZXMuYWRkVm9sdW1lKAogICAgICAgICAgcHJlU3RhcnQsCiAgICAgICAgICB2b2x1bWVTdGFydCwKICAgICAgICAgIHZvbHVtZUVuZCwKICAgICAgICAgIHBvc3RFbmQsCiAgICAgICAgICBzdGFydEhlaWdodCwKICAgICAgICAgIGVuZEhlaWdodCwKICAgICAgICAgIGhhbGZXaWR0aCwKICAgICAgICAgIGJhdGNoSWQsCiAgICAgICAgICBjZW50ZXIsCiAgICAgICAgICBlbGxpcHNvaWQKICAgICAgICApOwogICAgICAgIGN1cnJlbnRQb3NpdGlvbkluZGV4ICs9IDM7CiAgICAgIH0KICAgICAgY3VycmVudFBvc2l0aW9uSW5kZXggKz0gMzsKICAgICAgY3VycmVudEhlaWdodEluZGV4Kys7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gYXR0cmlic0FuZEluZGljZXMuaW5kaWNlczsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChhdHRyaWJzQW5kSW5kaWNlcy5zdGFydEVsbGlwc29pZE5vcm1hbHMuYnVmZmVyKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChhdHRyaWJzQW5kSW5kaWNlcy5lbmRFbGxpcHNvaWROb3JtYWxzLmJ1ZmZlcik7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goYXR0cmlic0FuZEluZGljZXMuc3RhcnRQb3NpdGlvbkFuZEhlaWdodHMuYnVmZmVyKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCgKICAgICAgYXR0cmlic0FuZEluZGljZXMuc3RhcnRGYWNlTm9ybWFsQW5kVmVydGV4Q29ybmVySWRzLmJ1ZmZlcgogICAgKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChhdHRyaWJzQW5kSW5kaWNlcy5lbmRQb3NpdGlvbkFuZEhlaWdodHMuYnVmZmVyKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChhdHRyaWJzQW5kSW5kaWNlcy5lbmRGYWNlTm9ybWFsQW5kSGFsZldpZHRocy5idWZmZXIpOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKGF0dHJpYnNBbmRJbmRpY2VzLnZlcnRleEJhdGNoSWRzLmJ1ZmZlcik7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goaW5kaWNlcy5idWZmZXIpOwogICAgbGV0IHJlc3VsdHMgPSB7CiAgICAgIGluZGV4RGF0YXR5cGU6IGluZGljZXMuQllURVNfUEVSX0VMRU1FTlQgPT09IDIgPyBJbmRleERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfU0hPUlQgOiBJbmRleERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfSU5ULAogICAgICBzdGFydEVsbGlwc29pZE5vcm1hbHM6IGF0dHJpYnNBbmRJbmRpY2VzLnN0YXJ0RWxsaXBzb2lkTm9ybWFscy5idWZmZXIsCiAgICAgIGVuZEVsbGlwc29pZE5vcm1hbHM6IGF0dHJpYnNBbmRJbmRpY2VzLmVuZEVsbGlwc29pZE5vcm1hbHMuYnVmZmVyLAogICAgICBzdGFydFBvc2l0aW9uQW5kSGVpZ2h0czogYXR0cmlic0FuZEluZGljZXMuc3RhcnRQb3NpdGlvbkFuZEhlaWdodHMuYnVmZmVyLAogICAgICBzdGFydEZhY2VOb3JtYWxBbmRWZXJ0ZXhDb3JuZXJJZHM6IGF0dHJpYnNBbmRJbmRpY2VzLnN0YXJ0RmFjZU5vcm1hbEFuZFZlcnRleENvcm5lcklkcy5idWZmZXIsCiAgICAgIGVuZFBvc2l0aW9uQW5kSGVpZ2h0czogYXR0cmlic0FuZEluZGljZXMuZW5kUG9zaXRpb25BbmRIZWlnaHRzLmJ1ZmZlciwKICAgICAgZW5kRmFjZU5vcm1hbEFuZEhhbGZXaWR0aHM6IGF0dHJpYnNBbmRJbmRpY2VzLmVuZEZhY2VOb3JtYWxBbmRIYWxmV2lkdGhzLmJ1ZmZlciwKICAgICAgdmVydGV4QmF0Y2hJZHM6IGF0dHJpYnNBbmRJbmRpY2VzLnZlcnRleEJhdGNoSWRzLmJ1ZmZlciwKICAgICAgaW5kaWNlczogaW5kaWNlcy5idWZmZXIKICAgIH07CiAgICBpZiAocGFyYW1ldGVycy5rZWVwRGVjb2RlZFBvc2l0aW9ucykgewogICAgICBjb25zdCBwb3NpdGlvbk9mZnNldHMgPSBnZXRQb3NpdGlvbk9mZnNldHMoY291bnRzKTsKICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKHBvc2l0aW9ucy5idWZmZXIsIHBvc2l0aW9uT2Zmc2V0cy5idWZmZXIpOwogICAgICByZXN1bHRzID0gY29tYmluZV9kZWZhdWx0KHJlc3VsdHMsIHsKICAgICAgICBkZWNvZGVkUG9zaXRpb25zOiBwb3NpdGlvbnMuYnVmZmVyLAogICAgICAgIGRlY29kZWRQb3NpdGlvbk9mZnNldHM6IHBvc2l0aW9uT2Zmc2V0cy5idWZmZXIKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9CiAgdmFyIE1BWF9TSE9SVCwgTUlURVJfQlJFQUssIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYywgc2NyYXRjaEVuY29kZWRQb3NpdGlvbiwgcHJldmlvdXNDb21wcmVzc2VkQ2FydG9ncmFwaGljU2NyYXRjaCwgY3VycmVudENvbXByZXNzZWRDYXJ0b2dyYXBoaWNTY3JhdGNoLCB0b3dhcmRDdXJyU2NyYXRjaCwgdG93YXJkTmV4dFNjcmF0Y2gsIFJFRkVSRU5DRV9JTkRJQ0VTMiwgUkVGRVJFTkNFX0lORElDRVNfTEVOR1RIMiwgcG9zaXRpb25TY3JhdGNoNCwgc2NyYXRjaFN0YXJ0RWxsaXBzb2lkTm9ybWFsLCBzY3JhdGNoU3RhcnRGYWNlTm9ybWFsLCBzY3JhdGNoRW5kRWxsaXBzb2lkTm9ybWFsLCBzY3JhdGNoRW5kRmFjZU5vcm1hbCwgc2NyYXRjaFJlY3RhbmdsZTMsIHNjcmF0Y2hFbGxpcHNvaWQxMywgc2NyYXRjaENlbnRlcjQsIHNjcmF0Y2hQcmV2LCBzY3JhdGNoUDAsIHNjcmF0Y2hQMSwgc2NyYXRjaE5leHQsIGNyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzLmpzIigpIHsKICAgICAgaW5pdF9BdHRyaWJ1dGVDb21wcmVzc2lvbigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9jb21iaW5lKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfSW5kZXhEYXRhdHlwZSgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIE1BWF9TSE9SVCA9IDMyNzY3OwogICAgICBNSVRFUl9CUkVBSyA9IE1hdGguY29zKE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoMTUwKSk7CiAgICAgIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBwcmV2aW91c0NvbXByZXNzZWRDYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIGN1cnJlbnRDb21wcmVzc2VkQ2FydG9ncmFwaGljU2NyYXRjaCA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICB0b3dhcmRDdXJyU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdG93YXJkTmV4dFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFJFRkVSRU5DRV9JTkRJQ0VTMiA9IFsKICAgICAgICAwLAogICAgICAgIDIsCiAgICAgICAgNiwKICAgICAgICAwLAogICAgICAgIDYsCiAgICAgICAgNCwKICAgICAgICAvLyByaWdodAogICAgICAgIDAsCiAgICAgICAgMSwKICAgICAgICAzLAogICAgICAgIDAsCiAgICAgICAgMywKICAgICAgICAyLAogICAgICAgIC8vIHN0YXJ0IGZhY2UKICAgICAgICAwLAogICAgICAgIDQsCiAgICAgICAgNSwKICAgICAgICAwLAogICAgICAgIDUsCiAgICAgICAgMSwKICAgICAgICAvLyBib3R0b20KICAgICAgICA1LAogICAgICAgIDMsCiAgICAgICAgMSwKICAgICAgICA1LAogICAgICAgIDcsCiAgICAgICAgMywKICAgICAgICAvLyBsZWZ0CiAgICAgICAgNywKICAgICAgICA1LAogICAgICAgIDQsCiAgICAgICAgNywKICAgICAgICA0LAogICAgICAgIDYsCiAgICAgICAgLy8gZW5kIGZhY2UKICAgICAgICA3LAogICAgICAgIDYsCiAgICAgICAgMiwKICAgICAgICA3LAogICAgICAgIDIsCiAgICAgICAgMwogICAgICAgIC8vIHRvcAogICAgICBdOwogICAgICBSRUZFUkVOQ0VfSU5ESUNFU19MRU5HVEgyID0gUkVGRVJFTkNFX0lORElDRVMyLmxlbmd0aDsKICAgICAgcG9zaXRpb25TY3JhdGNoNCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFN0YXJ0RWxsaXBzb2lkTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoU3RhcnRGYWNlTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRW5kRWxsaXBzb2lkTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRW5kRmFjZU5vcm1hbCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgVmVydGV4QXR0cmlidXRlc0FuZEluZGljZXMucHJvdG90eXBlLmFkZFZvbHVtZSA9IGZ1bmN0aW9uKHByZVN0YXJ0UlRDLCBzdGFydFJUQywgZW5kUlRDLCBwb3N0RW5kUlRDLCBzdGFydEhlaWdodCwgZW5kSGVpZ2h0LCBoYWxmV2lkdGgsIGJhdGNoSWQsIGNlbnRlciwgZWxsaXBzb2lkKSB7CiAgICAgICAgbGV0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmFkZChzdGFydFJUQywgY2VudGVyLCBwb3NpdGlvblNjcmF0Y2g0KTsKICAgICAgICBjb25zdCBzdGFydEVsbGlwc29pZE5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjcmF0Y2hTdGFydEVsbGlwc29pZE5vcm1hbAogICAgICAgICk7CiAgICAgICAgcG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKGVuZFJUQywgY2VudGVyLCBwb3NpdGlvblNjcmF0Y2g0KTsKICAgICAgICBjb25zdCBlbmRFbGxpcHNvaWROb3JtYWwgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBzY3JhdGNoRW5kRWxsaXBzb2lkTm9ybWFsCiAgICAgICAgKTsKICAgICAgICBjb25zdCBzdGFydEZhY2VOb3JtYWwgPSBjb21wdXRlTWl0ZXJlZE5vcm1hbCgKICAgICAgICAgIHByZVN0YXJ0UlRDLAogICAgICAgICAgc3RhcnRSVEMsCiAgICAgICAgICBlbmRSVEMsCiAgICAgICAgICBzdGFydEVsbGlwc29pZE5vcm1hbCwKICAgICAgICAgIHNjcmF0Y2hTdGFydEZhY2VOb3JtYWwKICAgICAgICApOwogICAgICAgIGNvbnN0IGVuZEZhY2VOb3JtYWwgPSBjb21wdXRlTWl0ZXJlZE5vcm1hbCgKICAgICAgICAgIHBvc3RFbmRSVEMsCiAgICAgICAgICBlbmRSVEMsCiAgICAgICAgICBzdGFydFJUQywKICAgICAgICAgIGVuZEVsbGlwc29pZE5vcm1hbCwKICAgICAgICAgIHNjcmF0Y2hFbmRGYWNlTm9ybWFsCiAgICAgICAgKTsKICAgICAgICBjb25zdCBzdGFydEVsbGlwc29pZE5vcm1hbHMgPSB0aGlzLnN0YXJ0RWxsaXBzb2lkTm9ybWFsczsKICAgICAgICBjb25zdCBlbmRFbGxpcHNvaWROb3JtYWxzID0gdGhpcy5lbmRFbGxpcHNvaWROb3JtYWxzOwogICAgICAgIGNvbnN0IHN0YXJ0UG9zaXRpb25BbmRIZWlnaHRzID0gdGhpcy5zdGFydFBvc2l0aW9uQW5kSGVpZ2h0czsKICAgICAgICBjb25zdCBzdGFydEZhY2VOb3JtYWxBbmRWZXJ0ZXhDb3JuZXJJZHMgPSB0aGlzLnN0YXJ0RmFjZU5vcm1hbEFuZFZlcnRleENvcm5lcklkczsKICAgICAgICBjb25zdCBlbmRQb3NpdGlvbkFuZEhlaWdodHMgPSB0aGlzLmVuZFBvc2l0aW9uQW5kSGVpZ2h0czsKICAgICAgICBjb25zdCBlbmRGYWNlTm9ybWFsQW5kSGFsZldpZHRocyA9IHRoaXMuZW5kRmFjZU5vcm1hbEFuZEhhbGZXaWR0aHM7CiAgICAgICAgY29uc3QgdmVydGV4QmF0Y2hJZHMgPSB0aGlzLnZlcnRleEJhdGNoSWRzOwogICAgICAgIGxldCBiYXRjaElkT2Zmc2V0ID0gdGhpcy5iYXRjaElkT2Zmc2V0OwogICAgICAgIGxldCB2ZWMzT2Zmc2V0ID0gdGhpcy52ZWMzT2Zmc2V0OwogICAgICAgIGxldCB2ZWM0T2Zmc2V0ID0gdGhpcy52ZWM0T2Zmc2V0OwogICAgICAgIGxldCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCA4OyBpKyspIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHN0YXJ0RWxsaXBzb2lkTm9ybWFsLCBzdGFydEVsbGlwc29pZE5vcm1hbHMsIHZlYzNPZmZzZXQpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soZW5kRWxsaXBzb2lkTm9ybWFsLCBlbmRFbGxpcHNvaWROb3JtYWxzLCB2ZWMzT2Zmc2V0KTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHN0YXJ0UlRDLCBzdGFydFBvc2l0aW9uQW5kSGVpZ2h0cywgdmVjNE9mZnNldCk7CiAgICAgICAgICBzdGFydFBvc2l0aW9uQW5kSGVpZ2h0c1t2ZWM0T2Zmc2V0ICsgM10gPSBzdGFydEhlaWdodDsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGVuZFJUQywgZW5kUG9zaXRpb25BbmRIZWlnaHRzLCB2ZWM0T2Zmc2V0KTsKICAgICAgICAgIGVuZFBvc2l0aW9uQW5kSGVpZ2h0c1t2ZWM0T2Zmc2V0ICsgM10gPSBlbmRIZWlnaHQ7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjaygKICAgICAgICAgICAgc3RhcnRGYWNlTm9ybWFsLAogICAgICAgICAgICBzdGFydEZhY2VOb3JtYWxBbmRWZXJ0ZXhDb3JuZXJJZHMsCiAgICAgICAgICAgIHZlYzRPZmZzZXQKICAgICAgICAgICk7CiAgICAgICAgICBzdGFydEZhY2VOb3JtYWxBbmRWZXJ0ZXhDb3JuZXJJZHNbdmVjNE9mZnNldCArIDNdID0gaTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGVuZEZhY2VOb3JtYWwsIGVuZEZhY2VOb3JtYWxBbmRIYWxmV2lkdGhzLCB2ZWM0T2Zmc2V0KTsKICAgICAgICAgIGVuZEZhY2VOb3JtYWxBbmRIYWxmV2lkdGhzW3ZlYzRPZmZzZXQgKyAzXSA9IGhhbGZXaWR0aDsKICAgICAgICAgIHZlcnRleEJhdGNoSWRzW2JhdGNoSWRPZmZzZXQrK10gPSBiYXRjaElkOwogICAgICAgICAgdmVjM09mZnNldCArPSAzOwogICAgICAgICAgdmVjNE9mZnNldCArPSA0OwogICAgICAgIH0KICAgICAgICB0aGlzLmJhdGNoSWRPZmZzZXQgPSBiYXRjaElkT2Zmc2V0OwogICAgICAgIHRoaXMudmVjM09mZnNldCA9IHZlYzNPZmZzZXQ7CiAgICAgICAgdGhpcy52ZWM0T2Zmc2V0ID0gdmVjNE9mZnNldDsKICAgICAgICBjb25zdCBpbmRpY2VzID0gdGhpcy5pbmRpY2VzOwogICAgICAgIGNvbnN0IHZvbHVtZVN0YXJ0SW5kZXggPSB0aGlzLnZvbHVtZVN0YXJ0SW5kZXg7CiAgICAgICAgY29uc3QgaW5kZXhPZmZzZXQgPSB0aGlzLmluZGV4T2Zmc2V0OwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBSRUZFUkVOQ0VfSU5ESUNFU19MRU5HVEgyOyBpKyspIHsKICAgICAgICAgIGluZGljZXNbaW5kZXhPZmZzZXQgKyBpXSA9IFJFRkVSRU5DRV9JTkRJQ0VTMltpXSArIHZvbHVtZVN0YXJ0SW5kZXg7CiAgICAgICAgfQogICAgICAgIHRoaXMudm9sdW1lU3RhcnRJbmRleCArPSA4OwogICAgICAgIHRoaXMuaW5kZXhPZmZzZXQgKz0gUkVGRVJFTkNFX0lORElDRVNfTEVOR1RIMjsKICAgICAgfTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZTMgPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVsbGlwc29pZDEzID0gbmV3IEVsbGlwc29pZF9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDZW50ZXI0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUHJldiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFAwID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoUDEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOZXh0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lc19kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KGNyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9TY2VuZS9WZWN0b3IzRFRpbGVCYXRjaC5qcwogIGZ1bmN0aW9uIFZlY3RvcjNEVGlsZUJhdGNoKG9wdGlvbnMpIHsKICAgIHRoaXMub2Zmc2V0ID0gb3B0aW9ucy5vZmZzZXQ7CiAgICB0aGlzLmNvdW50ID0gb3B0aW9ucy5jb3VudDsKICAgIHRoaXMuY29sb3IgPSBvcHRpb25zLmNvbG9yOwogICAgdGhpcy5iYXRjaElkcyA9IG9wdGlvbnMuYmF0Y2hJZHM7CiAgfQogIHZhciBWZWN0b3IzRFRpbGVCYXRjaF9kZWZhdWx0OwogIHZhciBpbml0X1ZlY3RvcjNEVGlsZUJhdGNoID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvU2NlbmUvVmVjdG9yM0RUaWxlQmF0Y2guanMiKCkgewogICAgICBWZWN0b3IzRFRpbGVCYXRjaF9kZWZhdWx0ID0gVmVjdG9yM0RUaWxlQmF0Y2g7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllcy5qcwogIHZhciBjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllc19leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXNfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXNfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGJveE1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUoYm94ZXMsIGluZGV4KSB7CiAgICBsZXQgYm94SW5kZXggPSBpbmRleCAqIHBhY2tlZEJveExlbmd0aDsKICAgIGNvbnN0IGRpbWVuc2lvbnMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGJveGVzLCBib3hJbmRleCwgc2NyYXRjaENhcnRlc2lhbjExKTsKICAgIGJveEluZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBjb25zdCBib3hNb2RlbE1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC51bnBhY2soCiAgICAgIGJveGVzLAogICAgICBib3hJbmRleCwKICAgICAgc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYubW9kZWxNYXRyaXgKICAgICk7CiAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVNjYWxlKGJveE1vZGVsTWF0cml4LCBkaW1lbnNpb25zLCBib3hNb2RlbE1hdHJpeCk7CiAgICBjb25zdCBib3VuZGluZ1ZvbHVtZSA9IHNjcmF0Y2hNb2RlbE1hdHJpeEFuZEJWLmJvdW5kaW5nVm9sdW1lOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLCBib3VuZGluZ1ZvbHVtZS5jZW50ZXIpOwogICAgYm91bmRpbmdWb2x1bWUucmFkaXVzID0gTWF0aC5zcXJ0KDMpOwogICAgcmV0dXJuIHNjcmF0Y2hNb2RlbE1hdHJpeEFuZEJWOwogIH0KICBmdW5jdGlvbiBjeWxpbmRlck1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUoY3lsaW5kZXJzLCBpbmRleCkgewogICAgbGV0IGN5bGluZGVySW5kZXggPSBpbmRleCAqIHBhY2tlZEN5bGluZGVyTGVuZ3RoOwogICAgY29uc3QgY3lsaW5kZXJSYWRpdXMgPSBjeWxpbmRlcnNbY3lsaW5kZXJJbmRleCsrXTsKICAgIGNvbnN0IGxlbmd0aCA9IGN5bGluZGVyc1tjeWxpbmRlckluZGV4KytdOwogICAgY29uc3Qgc2NhbGUgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUVsZW1lbnRzKAogICAgICBjeWxpbmRlclJhZGl1cywKICAgICAgY3lsaW5kZXJSYWRpdXMsCiAgICAgIGxlbmd0aCwKICAgICAgc2NyYXRjaENhcnRlc2lhbjExCiAgICApOwogICAgY29uc3QgY3lsaW5kZXJNb2RlbE1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC51bnBhY2soCiAgICAgIGN5bGluZGVycywKICAgICAgY3lsaW5kZXJJbmRleCwKICAgICAgc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYubW9kZWxNYXRyaXgKICAgICk7CiAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVNjYWxlKGN5bGluZGVyTW9kZWxNYXRyaXgsIHNjYWxlLCBjeWxpbmRlck1vZGVsTWF0cml4KTsKICAgIGNvbnN0IGJvdW5kaW5nVm9sdW1lID0gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYuYm91bmRpbmdWb2x1bWU7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIGJvdW5kaW5nVm9sdW1lLmNlbnRlcik7CiAgICBib3VuZGluZ1ZvbHVtZS5yYWRpdXMgPSBNYXRoLnNxcnQoMik7CiAgICByZXR1cm4gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlY7CiAgfQogIGZ1bmN0aW9uIGVsbGlwc29pZE1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUoZWxsaXBzb2lkcywgaW5kZXgpIHsKICAgIGxldCBlbGxpcHNvaWRJbmRleCA9IGluZGV4ICogcGFja2VkRWxsaXBzb2lkTGVuZ3RoOwogICAgY29uc3QgcmFkaWkgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGVsbGlwc29pZHMsIGVsbGlwc29pZEluZGV4LCBzY3JhdGNoQ2FydGVzaWFuMTEpOwogICAgZWxsaXBzb2lkSW5kZXggKz0gQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIGNvbnN0IGVsbGlwc29pZE1vZGVsTWF0cml4ID0gTWF0cml4NF9kZWZhdWx0LnVucGFjaygKICAgICAgZWxsaXBzb2lkcywKICAgICAgZWxsaXBzb2lkSW5kZXgsCiAgICAgIHNjcmF0Y2hNb2RlbE1hdHJpeEFuZEJWLm1vZGVsTWF0cml4CiAgICApOwogICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlTY2FsZShlbGxpcHNvaWRNb2RlbE1hdHJpeCwgcmFkaWksIGVsbGlwc29pZE1vZGVsTWF0cml4KTsKICAgIGNvbnN0IGJvdW5kaW5nVm9sdW1lID0gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYuYm91bmRpbmdWb2x1bWU7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIGJvdW5kaW5nVm9sdW1lLmNlbnRlcik7CiAgICBib3VuZGluZ1ZvbHVtZS5yYWRpdXMgPSAxOwogICAgcmV0dXJuIHNjcmF0Y2hNb2RlbE1hdHJpeEFuZEJWOwogIH0KICBmdW5jdGlvbiBzcGhlcmVNb2RlbE1hdHJpeEFuZEJvdW5kaW5nVm9sdW1lKHNwaGVyZXMsIGluZGV4KSB7CiAgICBsZXQgc3BoZXJlSW5kZXggPSBpbmRleCAqIHBhY2tlZFNwaGVyZUxlbmd0aDsKICAgIGNvbnN0IHNwaGVyZVJhZGl1cyA9IHNwaGVyZXNbc3BoZXJlSW5kZXgrK107CiAgICBjb25zdCBzcGhlcmVUcmFuc2xhdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgIHNwaGVyZXMsCiAgICAgIHNwaGVyZUluZGV4LAogICAgICBzY3JhdGNoQ2FydGVzaWFuMTEKICAgICk7CiAgICBjb25zdCBzcGhlcmVNb2RlbE1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5mcm9tVHJhbnNsYXRpb24oCiAgICAgIHNwaGVyZVRyYW5zbGF0aW9uLAogICAgICBzY3JhdGNoTW9kZWxNYXRyaXhBbmRCVi5tb2RlbE1hdHJpeAogICAgKTsKICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5VW5pZm9ybVNjYWxlKAogICAgICBzcGhlcmVNb2RlbE1hdHJpeCwKICAgICAgc3BoZXJlUmFkaXVzLAogICAgICBzcGhlcmVNb2RlbE1hdHJpeAogICAgKTsKICAgIGNvbnN0IGJvdW5kaW5nVm9sdW1lID0gc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYuYm91bmRpbmdWb2x1bWU7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIGJvdW5kaW5nVm9sdW1lLmNlbnRlcik7CiAgICBib3VuZGluZ1ZvbHVtZS5yYWRpdXMgPSAxOwogICAgcmV0dXJuIHNjcmF0Y2hNb2RlbE1hdHJpeEFuZEJWOwogIH0KICBmdW5jdGlvbiBjcmVhdGVQcmltaXRpdmUob3B0aW9ucywgcHJpbWl0aXZlLCBwcmltaXRpdmVCYXRjaElkcywgZ2VvbWV0cnksIGdldE1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHByaW1pdGl2ZSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgbnVtYmVyT2ZQcmltaXRpdmVzID0gcHJpbWl0aXZlQmF0Y2hJZHMubGVuZ3RoOwogICAgY29uc3QgZ2VvbWV0cnlQb3NpdGlvbnMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IGdlb21ldHJ5SW5kaWNlcyA9IGdlb21ldHJ5LmluZGljZXM7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgIGNvbnN0IHZlcnRleEJhdGNoSWRzID0gb3B0aW9ucy52ZXJ0ZXhCYXRjaElkczsKICAgIGNvbnN0IGluZGljZXMgPSBvcHRpb25zLmluZGljZXM7CiAgICBjb25zdCBiYXRjaElkcyA9IG9wdGlvbnMuYmF0Y2hJZHM7CiAgICBjb25zdCBiYXRjaFRhYmxlQ29sb3JzID0gb3B0aW9ucy5iYXRjaFRhYmxlQ29sb3JzOwogICAgY29uc3QgYmF0Y2hlZEluZGljZXMgPSBvcHRpb25zLmJhdGNoZWRJbmRpY2VzOwogICAgY29uc3QgaW5kZXhPZmZzZXRzID0gb3B0aW9ucy5pbmRleE9mZnNldHM7CiAgICBjb25zdCBpbmRleENvdW50cyA9IG9wdGlvbnMuaW5kZXhDb3VudHM7CiAgICBjb25zdCBib3VuZGluZ1ZvbHVtZXMgPSBvcHRpb25zLmJvdW5kaW5nVm9sdW1lczsKICAgIGNvbnN0IG1vZGVsTWF0cml4ID0gb3B0aW9ucy5tb2RlbE1hdHJpeDsKICAgIGNvbnN0IGNlbnRlciA9IG9wdGlvbnMuY2VudGVyOwogICAgbGV0IHBvc2l0aW9uT2Zmc2V0ID0gb3B0aW9ucy5wb3NpdGlvbk9mZnNldDsKICAgIGxldCBiYXRjaElkSW5kZXggPSBvcHRpb25zLmJhdGNoSWRJbmRleDsKICAgIGxldCBpbmRleE9mZnNldCA9IG9wdGlvbnMuaW5kZXhPZmZzZXQ7CiAgICBjb25zdCBiYXRjaGVkSW5kaWNlc09mZnNldCA9IG9wdGlvbnMuYmF0Y2hlZEluZGljZXNPZmZzZXQ7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bWJlck9mUHJpbWl0aXZlczsgKytpKSB7CiAgICAgIGNvbnN0IHByaW1pdGl2ZU1vZGVsTWF0cml4QW5kQlYgPSBnZXRNb2RlbE1hdHJpeEFuZEJvdW5kaW5nVm9sdW1lKAogICAgICAgIHByaW1pdGl2ZSwKICAgICAgICBpCiAgICAgICk7CiAgICAgIGNvbnN0IHByaW1pdGl2ZU1vZGVsTWF0cml4ID0gcHJpbWl0aXZlTW9kZWxNYXRyaXhBbmRCVi5tb2RlbE1hdHJpeDsKICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5KG1vZGVsTWF0cml4LCBwcmltaXRpdmVNb2RlbE1hdHJpeCwgcHJpbWl0aXZlTW9kZWxNYXRyaXgpOwogICAgICBjb25zdCBiYXRjaElkID0gcHJpbWl0aXZlQmF0Y2hJZHNbaV07CiAgICAgIGNvbnN0IHBvc2l0aW9uc0xlbmd0aCA9IGdlb21ldHJ5UG9zaXRpb25zLmxlbmd0aDsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBwb3NpdGlvbnNMZW5ndGg7IGogKz0gMykgewogICAgICAgIGNvbnN0IHBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhnZW9tZXRyeVBvc2l0aW9ucywgaiwgc2NyYXRjaFBvc2l0aW9uNSk7CiAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludChwcmltaXRpdmVNb2RlbE1hdHJpeCwgcG9zaXRpb24sIHBvc2l0aW9uKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocG9zaXRpb24sIGNlbnRlciwgcG9zaXRpb24pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uLCBwb3NpdGlvbnMsIHBvc2l0aW9uT2Zmc2V0ICogMyArIGopOwogICAgICAgIHZlcnRleEJhdGNoSWRzW2JhdGNoSWRJbmRleCsrXSA9IGJhdGNoSWQ7CiAgICAgIH0KICAgICAgY29uc3QgaW5kaWNlc0xlbmd0aCA9IGdlb21ldHJ5SW5kaWNlcy5sZW5ndGg7CiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgaW5kaWNlc0xlbmd0aDsgKytrKSB7CiAgICAgICAgaW5kaWNlc1tpbmRleE9mZnNldCArIGtdID0gZ2VvbWV0cnlJbmRpY2VzW2tdICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgIH0KICAgICAgY29uc3Qgb2Zmc2V0ID0gaSArIGJhdGNoZWRJbmRpY2VzT2Zmc2V0OwogICAgICBiYXRjaGVkSW5kaWNlc1tvZmZzZXRdID0gbmV3IFZlY3RvcjNEVGlsZUJhdGNoX2RlZmF1bHQoewogICAgICAgIG9mZnNldDogaW5kZXhPZmZzZXQsCiAgICAgICAgY291bnQ6IGluZGljZXNMZW5ndGgsCiAgICAgICAgY29sb3I6IENvbG9yX2RlZmF1bHQuZnJvbVJnYmEoYmF0Y2hUYWJsZUNvbG9yc1tiYXRjaElkXSksCiAgICAgICAgYmF0Y2hJZHM6IFtiYXRjaElkXQogICAgICB9KTsKICAgICAgYmF0Y2hJZHNbb2Zmc2V0XSA9IGJhdGNoSWQ7CiAgICAgIGluZGV4T2Zmc2V0c1tvZmZzZXRdID0gaW5kZXhPZmZzZXQ7CiAgICAgIGluZGV4Q291bnRzW29mZnNldF0gPSBpbmRpY2VzTGVuZ3RoOwogICAgICBib3VuZGluZ1ZvbHVtZXNbb2Zmc2V0XSA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQudHJhbnNmb3JtKAogICAgICAgIHByaW1pdGl2ZU1vZGVsTWF0cml4QW5kQlYuYm91bmRpbmdWb2x1bWUsCiAgICAgICAgcHJpbWl0aXZlTW9kZWxNYXRyaXgKICAgICAgKTsKICAgICAgcG9zaXRpb25PZmZzZXQgKz0gcG9zaXRpb25zTGVuZ3RoIC8gMzsKICAgICAgaW5kZXhPZmZzZXQgKz0gaW5kaWNlc0xlbmd0aDsKICAgIH0KICAgIG9wdGlvbnMucG9zaXRpb25PZmZzZXQgPSBwb3NpdGlvbk9mZnNldDsKICAgIG9wdGlvbnMuYmF0Y2hJZEluZGV4ID0gYmF0Y2hJZEluZGV4OwogICAgb3B0aW9ucy5pbmRleE9mZnNldCA9IGluZGV4T2Zmc2V0OwogICAgb3B0aW9ucy5iYXRjaGVkSW5kaWNlc09mZnNldCArPSBudW1iZXJPZlByaW1pdGl2ZXM7CiAgfQogIGZ1bmN0aW9uIHVucGFja0J1ZmZlcihidWZmZXIpIHsKICAgIGNvbnN0IHBhY2tlZEJ1ZmZlciA9IG5ldyBGbG9hdDY0QXJyYXkoYnVmZmVyKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgc2NyYXRjaENlbnRlcjUpOwogICAgb2Zmc2V0ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBNYXRyaXg0X2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoTWF0cml4NCk7CiAgfQogIGZ1bmN0aW9uIHBhY2tlZEJhdGNoZWRJbmRpY2VzTGVuZ3RoKGJhdGNoZWRJbmRpY2VzKSB7CiAgICBjb25zdCBsZW5ndGggPSBiYXRjaGVkSW5kaWNlcy5sZW5ndGg7CiAgICBsZXQgY291bnQgPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb3VudCArPSBDb2xvcl9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDMgKyBiYXRjaGVkSW5kaWNlc1tpXS5iYXRjaElkcy5sZW5ndGg7CiAgICB9CiAgICByZXR1cm4gY291bnQ7CiAgfQogIGZ1bmN0aW9uIHBhY2tCdWZmZXIoaW5kaWNlc0J5dGVzUGVyRWxlbWVudCwgYmF0Y2hlZEluZGljZXMsIGJvdW5kaW5nVm9sdW1lcykgewogICAgY29uc3QgbnVtQlZzID0gYm91bmRpbmdWb2x1bWVzLmxlbmd0aDsKICAgIGNvbnN0IGxlbmd0aCA9IDEgKyAxICsgbnVtQlZzICogQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAxICsgcGFja2VkQmF0Y2hlZEluZGljZXNMZW5ndGgoYmF0Y2hlZEluZGljZXMpOwogICAgY29uc3QgcGFja2VkQnVmZmVyID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGgpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gaW5kaWNlc0J5dGVzUGVyRWxlbWVudDsKICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBudW1CVnM7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bUJWczsgKytpKSB7CiAgICAgIEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFjayhib3VuZGluZ1ZvbHVtZXNbaV0sIHBhY2tlZEJ1ZmZlciwgb2Zmc2V0KTsKICAgICAgb2Zmc2V0ICs9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgfQogICAgY29uc3QgaW5kaWNlc0xlbmd0aCA9IGJhdGNoZWRJbmRpY2VzLmxlbmd0aDsKICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBpbmRpY2VzTGVuZ3RoOwogICAgZm9yIChsZXQgaiA9IDA7IGogPCBpbmRpY2VzTGVuZ3RoOyArK2opIHsKICAgICAgY29uc3QgYmF0Y2hlZEluZGV4ID0gYmF0Y2hlZEluZGljZXNbal07CiAgICAgIENvbG9yX2RlZmF1bHQucGFjayhiYXRjaGVkSW5kZXguY29sb3IsIHBhY2tlZEJ1ZmZlciwgb2Zmc2V0KTsKICAgICAgb2Zmc2V0ICs9IENvbG9yX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gYmF0Y2hlZEluZGV4Lm9mZnNldDsKICAgICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IGJhdGNoZWRJbmRleC5jb3VudDsKICAgICAgY29uc3QgYmF0Y2hJZHMgPSBiYXRjaGVkSW5kZXguYmF0Y2hJZHM7CiAgICAgIGNvbnN0IGJhdGNoSWRzTGVuZ3RoID0gYmF0Y2hJZHMubGVuZ3RoOwogICAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gYmF0Y2hJZHNMZW5ndGg7CiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgYmF0Y2hJZHNMZW5ndGg7ICsraykgewogICAgICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBiYXRjaElkc1trXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHBhY2tlZEJ1ZmZlcjsKICB9CiAgZnVuY3Rpb24gY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgYm94ZXMgPSBkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5ib3hlcykgPyBuZXcgRmxvYXQzMkFycmF5KHBhcmFtZXRlcnMuYm94ZXMpIDogdm9pZCAwOwogICAgY29uc3QgYm94QmF0Y2hJZHMgPSBkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5ib3hCYXRjaElkcykgPyBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5ib3hCYXRjaElkcykgOiB2b2lkIDA7CiAgICBjb25zdCBjeWxpbmRlcnMgPSBkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5jeWxpbmRlcnMpID8gbmV3IEZsb2F0MzJBcnJheShwYXJhbWV0ZXJzLmN5bGluZGVycykgOiB2b2lkIDA7CiAgICBjb25zdCBjeWxpbmRlckJhdGNoSWRzID0gZGVmaW5lZF9kZWZhdWx0KHBhcmFtZXRlcnMuY3lsaW5kZXJCYXRjaElkcykgPyBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5jeWxpbmRlckJhdGNoSWRzKSA6IHZvaWQgMDsKICAgIGNvbnN0IGVsbGlwc29pZHMgPSBkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5lbGxpcHNvaWRzKSA/IG5ldyBGbG9hdDMyQXJyYXkocGFyYW1ldGVycy5lbGxpcHNvaWRzKSA6IHZvaWQgMDsKICAgIGNvbnN0IGVsbGlwc29pZEJhdGNoSWRzID0gZGVmaW5lZF9kZWZhdWx0KHBhcmFtZXRlcnMuZWxsaXBzb2lkQmF0Y2hJZHMpID8gbmV3IFVpbnQxNkFycmF5KHBhcmFtZXRlcnMuZWxsaXBzb2lkQmF0Y2hJZHMpIDogdm9pZCAwOwogICAgY29uc3Qgc3BoZXJlcyA9IGRlZmluZWRfZGVmYXVsdChwYXJhbWV0ZXJzLnNwaGVyZXMpID8gbmV3IEZsb2F0MzJBcnJheShwYXJhbWV0ZXJzLnNwaGVyZXMpIDogdm9pZCAwOwogICAgY29uc3Qgc3BoZXJlQmF0Y2hJZHMgPSBkZWZpbmVkX2RlZmF1bHQocGFyYW1ldGVycy5zcGhlcmVCYXRjaElkcykgPyBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5zcGhlcmVCYXRjaElkcykgOiB2b2lkIDA7CiAgICBjb25zdCBudW1iZXJPZkJveGVzID0gZGVmaW5lZF9kZWZhdWx0KGJveGVzKSA/IGJveEJhdGNoSWRzLmxlbmd0aCA6IDA7CiAgICBjb25zdCBudW1iZXJPZkN5bGluZGVycyA9IGRlZmluZWRfZGVmYXVsdChjeWxpbmRlcnMpID8gY3lsaW5kZXJCYXRjaElkcy5sZW5ndGggOiAwOwogICAgY29uc3QgbnVtYmVyT2ZFbGxpcHNvaWRzID0gZGVmaW5lZF9kZWZhdWx0KGVsbGlwc29pZHMpID8gZWxsaXBzb2lkQmF0Y2hJZHMubGVuZ3RoIDogMDsKICAgIGNvbnN0IG51bWJlck9mU3BoZXJlcyA9IGRlZmluZWRfZGVmYXVsdChzcGhlcmVzKSA/IHNwaGVyZUJhdGNoSWRzLmxlbmd0aCA6IDA7CiAgICBjb25zdCBib3hHZW9tZXRyeSA9IEJveEdlb21ldHJ5X2RlZmF1bHQuZ2V0VW5pdEJveCgpOwogICAgY29uc3QgY3lsaW5kZXJHZW9tZXRyeSA9IEN5bGluZGVyR2VvbWV0cnlfZGVmYXVsdC5nZXRVbml0Q3lsaW5kZXIoKTsKICAgIGNvbnN0IGVsbGlwc29pZEdlb21ldHJ5ID0gRWxsaXBzb2lkR2VvbWV0cnlfZGVmYXVsdC5nZXRVbml0RWxsaXBzb2lkKCk7CiAgICBjb25zdCBib3hQb3NpdGlvbnMgPSBib3hHZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IGN5bGluZGVyUG9zaXRpb25zID0gY3lsaW5kZXJHZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uLnZhbHVlczsKICAgIGNvbnN0IGVsbGlwc29pZFBvc2l0aW9ucyA9IGVsbGlwc29pZEdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb24udmFsdWVzOwogICAgbGV0IG51bWJlck9mUG9zaXRpb25zID0gYm94UG9zaXRpb25zLmxlbmd0aCAqIG51bWJlck9mQm94ZXM7CiAgICBudW1iZXJPZlBvc2l0aW9ucyArPSBjeWxpbmRlclBvc2l0aW9ucy5sZW5ndGggKiBudW1iZXJPZkN5bGluZGVyczsKICAgIG51bWJlck9mUG9zaXRpb25zICs9IGVsbGlwc29pZFBvc2l0aW9ucy5sZW5ndGggKiAobnVtYmVyT2ZFbGxpcHNvaWRzICsgbnVtYmVyT2ZTcGhlcmVzKTsKICAgIGNvbnN0IGJveEluZGljZXMgPSBib3hHZW9tZXRyeS5pbmRpY2VzOwogICAgY29uc3QgY3lsaW5kZXJJbmRpY2VzID0gY3lsaW5kZXJHZW9tZXRyeS5pbmRpY2VzOwogICAgY29uc3QgZWxsaXBzb2lkSW5kaWNlcyA9IGVsbGlwc29pZEdlb21ldHJ5LmluZGljZXM7CiAgICBsZXQgbnVtYmVyT2ZJbmRpY2VzID0gYm94SW5kaWNlcy5sZW5ndGggKiBudW1iZXJPZkJveGVzOwogICAgbnVtYmVyT2ZJbmRpY2VzICs9IGN5bGluZGVySW5kaWNlcy5sZW5ndGggKiBudW1iZXJPZkN5bGluZGVyczsKICAgIG51bWJlck9mSW5kaWNlcyArPSBlbGxpcHNvaWRJbmRpY2VzLmxlbmd0aCAqIChudW1iZXJPZkVsbGlwc29pZHMgKyBudW1iZXJPZlNwaGVyZXMpOwogICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShudW1iZXJPZlBvc2l0aW9ucyk7CiAgICBjb25zdCB2ZXJ0ZXhCYXRjaElkcyA9IG5ldyBVaW50MTZBcnJheShudW1iZXJPZlBvc2l0aW9ucyAvIDMpOwogICAgY29uc3QgaW5kaWNlcyA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBudW1iZXJPZlBvc2l0aW9ucyAvIDMsCiAgICAgIG51bWJlck9mSW5kaWNlcwogICAgKTsKICAgIGNvbnN0IG51bWJlck9mR2VvbWV0cmllcyA9IG51bWJlck9mQm94ZXMgKyBudW1iZXJPZkN5bGluZGVycyArIG51bWJlck9mRWxsaXBzb2lkcyArIG51bWJlck9mU3BoZXJlczsKICAgIGNvbnN0IGJhdGNoSWRzID0gbmV3IFVpbnQxNkFycmF5KG51bWJlck9mR2VvbWV0cmllcyk7CiAgICBjb25zdCBiYXRjaGVkSW5kaWNlcyA9IG5ldyBBcnJheShudW1iZXJPZkdlb21ldHJpZXMpOwogICAgY29uc3QgaW5kZXhPZmZzZXRzID0gbmV3IFVpbnQzMkFycmF5KG51bWJlck9mR2VvbWV0cmllcyk7CiAgICBjb25zdCBpbmRleENvdW50cyA9IG5ldyBVaW50MzJBcnJheShudW1iZXJPZkdlb21ldHJpZXMpOwogICAgY29uc3QgYm91bmRpbmdWb2x1bWVzID0gbmV3IEFycmF5KG51bWJlck9mR2VvbWV0cmllcyk7CiAgICB1bnBhY2tCdWZmZXIocGFyYW1ldGVycy5wYWNrZWRCdWZmZXIpOwogICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgYmF0Y2hUYWJsZUNvbG9yczogbmV3IFVpbnQzMkFycmF5KHBhcmFtZXRlcnMuYmF0Y2hUYWJsZUNvbG9ycyksCiAgICAgIHBvc2l0aW9ucywKICAgICAgdmVydGV4QmF0Y2hJZHMsCiAgICAgIGluZGljZXMsCiAgICAgIGJhdGNoSWRzLAogICAgICBiYXRjaGVkSW5kaWNlcywKICAgICAgaW5kZXhPZmZzZXRzLAogICAgICBpbmRleENvdW50cywKICAgICAgYm91bmRpbmdWb2x1bWVzLAogICAgICBwb3NpdGlvbk9mZnNldDogMCwKICAgICAgYmF0Y2hJZEluZGV4OiAwLAogICAgICBpbmRleE9mZnNldDogMCwKICAgICAgYmF0Y2hlZEluZGljZXNPZmZzZXQ6IDAsCiAgICAgIG1vZGVsTWF0cml4OiBzY3JhdGNoTWF0cml4NCwKICAgICAgY2VudGVyOiBzY3JhdGNoQ2VudGVyNQogICAgfTsKICAgIGNyZWF0ZVByaW1pdGl2ZSgKICAgICAgb3B0aW9ucywKICAgICAgYm94ZXMsCiAgICAgIGJveEJhdGNoSWRzLAogICAgICBib3hHZW9tZXRyeSwKICAgICAgYm94TW9kZWxNYXRyaXhBbmRCb3VuZGluZ1ZvbHVtZQogICAgKTsKICAgIGNyZWF0ZVByaW1pdGl2ZSgKICAgICAgb3B0aW9ucywKICAgICAgY3lsaW5kZXJzLAogICAgICBjeWxpbmRlckJhdGNoSWRzLAogICAgICBjeWxpbmRlckdlb21ldHJ5LAogICAgICBjeWxpbmRlck1vZGVsTWF0cml4QW5kQm91bmRpbmdWb2x1bWUKICAgICk7CiAgICBjcmVhdGVQcmltaXRpdmUoCiAgICAgIG9wdGlvbnMsCiAgICAgIGVsbGlwc29pZHMsCiAgICAgIGVsbGlwc29pZEJhdGNoSWRzLAogICAgICBlbGxpcHNvaWRHZW9tZXRyeSwKICAgICAgZWxsaXBzb2lkTW9kZWxNYXRyaXhBbmRCb3VuZGluZ1ZvbHVtZQogICAgKTsKICAgIGNyZWF0ZVByaW1pdGl2ZSgKICAgICAgb3B0aW9ucywKICAgICAgc3BoZXJlcywKICAgICAgc3BoZXJlQmF0Y2hJZHMsCiAgICAgIGVsbGlwc29pZEdlb21ldHJ5LAogICAgICBzcGhlcmVNb2RlbE1hdHJpeEFuZEJvdW5kaW5nVm9sdW1lCiAgICApOwogICAgY29uc3QgcGFja2VkQnVmZmVyID0gcGFja0J1ZmZlcigKICAgICAgaW5kaWNlcy5CWVRFU19QRVJfRUxFTUVOVCwKICAgICAgYmF0Y2hlZEluZGljZXMsCiAgICAgIGJvdW5kaW5nVm9sdW1lcwogICAgKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCgKICAgICAgcG9zaXRpb25zLmJ1ZmZlciwKICAgICAgdmVydGV4QmF0Y2hJZHMuYnVmZmVyLAogICAgICBpbmRpY2VzLmJ1ZmZlcgogICAgKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCgKICAgICAgYmF0Y2hJZHMuYnVmZmVyLAogICAgICBpbmRleE9mZnNldHMuYnVmZmVyLAogICAgICBpbmRleENvdW50cy5idWZmZXIKICAgICk7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2gocGFja2VkQnVmZmVyLmJ1ZmZlcik7CiAgICByZXR1cm4gewogICAgICBwb3NpdGlvbnM6IHBvc2l0aW9ucy5idWZmZXIsCiAgICAgIHZlcnRleEJhdGNoSWRzOiB2ZXJ0ZXhCYXRjaElkcy5idWZmZXIsCiAgICAgIGluZGljZXM6IGluZGljZXMuYnVmZmVyLAogICAgICBpbmRleE9mZnNldHM6IGluZGV4T2Zmc2V0cy5idWZmZXIsCiAgICAgIGluZGV4Q291bnRzOiBpbmRleENvdW50cy5idWZmZXIsCiAgICAgIGJhdGNoSWRzOiBiYXRjaElkcy5idWZmZXIsCiAgICAgIHBhY2tlZEJ1ZmZlcjogcGFja2VkQnVmZmVyLmJ1ZmZlcgogICAgfTsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4xMSwgcGFja2VkQm94TGVuZ3RoLCBwYWNrZWRDeWxpbmRlckxlbmd0aCwgcGFja2VkRWxsaXBzb2lkTGVuZ3RoLCBwYWNrZWRTcGhlcmVMZW5ndGgsIHNjcmF0Y2hNb2RlbE1hdHJpeEFuZEJWLCBzY3JhdGNoUG9zaXRpb241LCBzY3JhdGNoQ2VudGVyNSwgc2NyYXRjaE1hdHJpeDQsIGNyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzLmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0JveEdlb21ldHJ5KCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbG9yKCk7CiAgICAgIGluaXRfQ3lsaW5kZXJHZW9tZXRyeSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRHZW9tZXRyeSgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfVmVjdG9yM0RUaWxlQmF0Y2goKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xMSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcGFja2VkQm94TGVuZ3RoID0gTWF0cml4NF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgIHBhY2tlZEN5bGluZGVyTGVuZ3RoID0gTWF0cml4NF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDI7CiAgICAgIHBhY2tlZEVsbGlwc29pZExlbmd0aCA9IE1hdHJpeDRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICBwYWNrZWRTcGhlcmVMZW5ndGggPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMTsKICAgICAgc2NyYXRjaE1vZGVsTWF0cml4QW5kQlYgPSB7CiAgICAgICAgbW9kZWxNYXRyaXg6IG5ldyBNYXRyaXg0X2RlZmF1bHQoKSwKICAgICAgICBib3VuZGluZ1ZvbHVtZTogbmV3IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQoKQogICAgICB9OwogICAgICBzY3JhdGNoUG9zaXRpb241ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2VudGVyNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1hdHJpeDQgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIGNyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQoY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVjdG9yVGlsZVBvaW50cy5qcwogIHZhciBjcmVhdGVWZWN0b3JUaWxlUG9pbnRzX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVWZWN0b3JUaWxlUG9pbnRzX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVZlY3RvclRpbGVQb2ludHNfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIHVucGFja0J1ZmZlcjIocGFja2VkQnVmZmVyKSB7CiAgICBwYWNrZWRCdWZmZXIgPSBuZXcgRmxvYXQ2NEFycmF5KHBhY2tlZEJ1ZmZlcik7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIHNjcmF0Y2hNaW5NYXhIZWlnaHRzLm1pbiA9IHBhY2tlZEJ1ZmZlcltvZmZzZXQrK107CiAgICBzY3JhdGNoTWluTWF4SGVpZ2h0cy5tYXggPSBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdOwogICAgUmVjdGFuZ2xlX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoUmVjdGFuZ2xlNCk7CiAgICBvZmZzZXQgKz0gUmVjdGFuZ2xlX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoRWxsaXBzb2lkMTQpOwogIH0KICBmdW5jdGlvbiBjcmVhdGVWZWN0b3JUaWxlUG9pbnRzKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLnBvc2l0aW9ucyk7CiAgICB1bnBhY2tCdWZmZXIyKHBhcmFtZXRlcnMucGFja2VkQnVmZmVyKTsKICAgIGNvbnN0IHJlY3RhbmdsZSA9IHNjcmF0Y2hSZWN0YW5nbGU0OwogICAgY29uc3QgZWxsaXBzb2lkID0gc2NyYXRjaEVsbGlwc29pZDE0OwogICAgY29uc3QgbWluaW11bUhlaWdodCA9IHNjcmF0Y2hNaW5NYXhIZWlnaHRzLm1pbjsKICAgIGNvbnN0IG1heGltdW1IZWlnaHQgPSBzY3JhdGNoTWluTWF4SGVpZ2h0cy5tYXg7CiAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IHVCdWZmZXIgPSBwb3NpdGlvbnMuc3ViYXJyYXkoMCwgcG9zaXRpb25zTGVuZ3RoKTsKICAgIGNvbnN0IHZCdWZmZXIgPSBwb3NpdGlvbnMuc3ViYXJyYXkocG9zaXRpb25zTGVuZ3RoLCAyICogcG9zaXRpb25zTGVuZ3RoKTsKICAgIGNvbnN0IGhlaWdodEJ1ZmZlciA9IHBvc2l0aW9ucy5zdWJhcnJheSgKICAgICAgMiAqIHBvc2l0aW9uc0xlbmd0aCwKICAgICAgMyAqIHBvc2l0aW9uc0xlbmd0aAogICAgKTsKICAgIEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuemlnWmFnRGVsdGFEZWNvZGUodUJ1ZmZlciwgdkJ1ZmZlciwgaGVpZ2h0QnVmZmVyKTsKICAgIGNvbnN0IGRlY29kZWQgPSBuZXcgRmxvYXQ2NEFycmF5KHBvc2l0aW9ucy5sZW5ndGgpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbnNMZW5ndGg7ICsraSkgewogICAgICBjb25zdCB1MyA9IHVCdWZmZXJbaV07CiAgICAgIGNvbnN0IHYzID0gdkJ1ZmZlcltpXTsKICAgICAgY29uc3QgaCA9IGhlaWdodEJ1ZmZlcltpXTsKICAgICAgY29uc3QgbG9uID0gTWF0aF9kZWZhdWx0LmxlcnAocmVjdGFuZ2xlLndlc3QsIHJlY3RhbmdsZS5lYXN0LCB1MyAvIG1heFNob3J0KTsKICAgICAgY29uc3QgbGF0ID0gTWF0aF9kZWZhdWx0LmxlcnAocmVjdGFuZ2xlLnNvdXRoLCByZWN0YW5nbGUubm9ydGgsIHYzIC8gbWF4U2hvcnQpOwogICAgICBjb25zdCBhbHQgPSBNYXRoX2RlZmF1bHQubGVycChtaW5pbXVtSGVpZ2h0LCBtYXhpbXVtSGVpZ2h0LCBoIC8gbWF4U2hvcnQpOwogICAgICBjb25zdCBjYXJ0b2dyYXBoaWMyID0gQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMoCiAgICAgICAgbG9uLAogICAgICAgIGxhdCwKICAgICAgICBhbHQsCiAgICAgICAgc2NyYXRjaEJWQ2FydG9ncmFwaGljMgogICAgICApOwogICAgICBjb25zdCBkZWNvZGVkUG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgY2FydG9ncmFwaGljMiwKICAgICAgICBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uMgogICAgICApOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhkZWNvZGVkUG9zaXRpb24sIGRlY29kZWQsIGkgKiAzKTsKICAgIH0KICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChkZWNvZGVkLmJ1ZmZlcik7CiAgICByZXR1cm4gewogICAgICBwb3NpdGlvbnM6IGRlY29kZWQuYnVmZmVyCiAgICB9OwogIH0KICB2YXIgbWF4U2hvcnQsIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYzIsIHNjcmF0Y2hFbmNvZGVkUG9zaXRpb24yLCBzY3JhdGNoUmVjdGFuZ2xlNCwgc2NyYXRjaEVsbGlwc29pZDE0LCBzY3JhdGNoTWluTWF4SGVpZ2h0cywgY3JlYXRlVmVjdG9yVGlsZVBvaW50c19kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVZlY3RvclRpbGVQb2ludHMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlY3RvclRpbGVQb2ludHMuanMiKCkgewogICAgICBpbml0X0F0dHJpYnV0ZUNvbXByZXNzaW9uKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIG1heFNob3J0ID0gMzI3Njc7CiAgICAgIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYzIgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hSZWN0YW5nbGU0ID0gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxNCA9IG5ldyBFbGxpcHNvaWRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWluTWF4SGVpZ2h0cyA9IHsKICAgICAgICBtaW46IHZvaWQgMCwKICAgICAgICBtYXg6IHZvaWQgMAogICAgICB9OwogICAgICBjcmVhdGVWZWN0b3JUaWxlUG9pbnRzX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQoY3JlYXRlVmVjdG9yVGlsZVBvaW50cyk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZWN0b3JUaWxlUG9seWdvbnMuanMKICB2YXIgY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnNfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zX2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiB1bnBhY2tCdWZmZXIzKGJ1ZmZlcikgewogICAgY29uc3QgcGFja2VkQnVmZmVyID0gbmV3IEZsb2F0NjRBcnJheShidWZmZXIpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBzY3JhdGNoU2NhbGFycy5pbmRleEJ5dGVzUGVyRWxlbWVudCA9IHBhY2tlZEJ1ZmZlcltvZmZzZXQrK107CiAgICBzY3JhdGNoU2NhbGFycy5taW4gPSBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdOwogICAgc2NyYXRjaFNjYWxhcnMubWF4ID0gcGFja2VkQnVmZmVyW29mZnNldCsrXTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socGFja2VkQnVmZmVyLCBvZmZzZXQsIHNjcmF0Y2hDZW50ZXI2KTsKICAgIG9mZnNldCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoRWxsaXBzb2lkMTUpOwogICAgb2Zmc2V0ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIFJlY3RhbmdsZV9kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgc2NyYXRjaFJlY3RhbmdsZTUpOwogIH0KICBmdW5jdGlvbiBwYWNrZWRCYXRjaGVkSW5kaWNlc0xlbmd0aDIoYmF0Y2hlZEluZGljZXMpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGJhdGNoZWRJbmRpY2VzLmxlbmd0aDsKICAgIGxldCBjb3VudCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvdW50ICs9IENvbG9yX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMyArIGJhdGNoZWRJbmRpY2VzW2ldLmJhdGNoSWRzLmxlbmd0aDsKICAgIH0KICAgIHJldHVybiBjb3VudDsKICB9CiAgZnVuY3Rpb24gcGFja0J1ZmZlcjIoaW5kZXhEYXRhdHlwZSwgYm91bmRpbmdWb2x1bWVzLCBiYXRjaGVkSW5kaWNlcykgewogICAgY29uc3QgbnVtQlZzID0gYm91bmRpbmdWb2x1bWVzLmxlbmd0aDsKICAgIGNvbnN0IGxlbmd0aCA9IDEgKyAxICsgbnVtQlZzICogT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LnBhY2tlZExlbmd0aCArIDEgKyBwYWNrZWRCYXRjaGVkSW5kaWNlc0xlbmd0aDIoYmF0Y2hlZEluZGljZXMpOwogICAgY29uc3QgcGFja2VkQnVmZmVyID0gbmV3IEZsb2F0NjRBcnJheShsZW5ndGgpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gaW5kZXhEYXRhdHlwZTsKICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBudW1CVnM7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bUJWczsgKytpKSB7CiAgICAgIE9yaWVudGVkQm91bmRpbmdCb3hfZGVmYXVsdC5wYWNrKGJvdW5kaW5nVm9sdW1lc1tpXSwgcGFja2VkQnVmZmVyLCBvZmZzZXQpOwogICAgICBvZmZzZXQgKz0gT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIH0KICAgIGNvbnN0IGluZGljZXNMZW5ndGggPSBiYXRjaGVkSW5kaWNlcy5sZW5ndGg7CiAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gaW5kaWNlc0xlbmd0aDsKICAgIGZvciAobGV0IGogPSAwOyBqIDwgaW5kaWNlc0xlbmd0aDsgKytqKSB7CiAgICAgIGNvbnN0IGJhdGNoZWRJbmRleCA9IGJhdGNoZWRJbmRpY2VzW2pdOwogICAgICBDb2xvcl9kZWZhdWx0LnBhY2soYmF0Y2hlZEluZGV4LmNvbG9yLCBwYWNrZWRCdWZmZXIsIG9mZnNldCk7CiAgICAgIG9mZnNldCArPSBDb2xvcl9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IGJhdGNoZWRJbmRleC5vZmZzZXQ7CiAgICAgIHBhY2tlZEJ1ZmZlcltvZmZzZXQrK10gPSBiYXRjaGVkSW5kZXguY291bnQ7CiAgICAgIGNvbnN0IGJhdGNoSWRzID0gYmF0Y2hlZEluZGV4LmJhdGNoSWRzOwogICAgICBjb25zdCBiYXRjaElkc0xlbmd0aCA9IGJhdGNoSWRzLmxlbmd0aDsKICAgICAgcGFja2VkQnVmZmVyW29mZnNldCsrXSA9IGJhdGNoSWRzTGVuZ3RoOwogICAgICBmb3IgKGxldCBrID0gMDsgayA8IGJhdGNoSWRzTGVuZ3RoOyArK2spIHsKICAgICAgICBwYWNrZWRCdWZmZXJbb2Zmc2V0KytdID0gYmF0Y2hJZHNba107CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwYWNrZWRCdWZmZXI7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVZlY3RvclRpbGVQb2x5Z29ucyhwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICB1bnBhY2tCdWZmZXIzKHBhcmFtZXRlcnMucGFja2VkQnVmZmVyKTsKICAgIGxldCBpbmRpY2VzOwogICAgY29uc3QgaW5kZXhCeXRlc1BlckVsZW1lbnQgPSBzY3JhdGNoU2NhbGFycy5pbmRleEJ5dGVzUGVyRWxlbWVudDsKICAgIGlmIChpbmRleEJ5dGVzUGVyRWxlbWVudCA9PT0gMikgewogICAgICBpbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KHBhcmFtZXRlcnMuaW5kaWNlcyk7CiAgICB9IGVsc2UgewogICAgICBpbmRpY2VzID0gbmV3IFVpbnQzMkFycmF5KHBhcmFtZXRlcnMuaW5kaWNlcyk7CiAgICB9CiAgICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5wb3NpdGlvbnMpOwogICAgY29uc3QgY291bnRzID0gbmV3IFVpbnQzMkFycmF5KHBhcmFtZXRlcnMuY291bnRzKTsKICAgIGNvbnN0IGluZGV4Q291bnRzID0gbmV3IFVpbnQzMkFycmF5KHBhcmFtZXRlcnMuaW5kZXhDb3VudHMpOwogICAgY29uc3QgYmF0Y2hJZHMgPSBuZXcgVWludDMyQXJyYXkocGFyYW1ldGVycy5iYXRjaElkcyk7CiAgICBjb25zdCBiYXRjaFRhYmxlQ29sb3JzID0gbmV3IFVpbnQzMkFycmF5KHBhcmFtZXRlcnMuYmF0Y2hUYWJsZUNvbG9ycyk7CiAgICBjb25zdCBib3VuZGluZ1ZvbHVtZXMgPSBuZXcgQXJyYXkoY291bnRzLmxlbmd0aCk7CiAgICBjb25zdCBjZW50ZXIgPSBzY3JhdGNoQ2VudGVyNjsKICAgIGNvbnN0IGVsbGlwc29pZCA9IHNjcmF0Y2hFbGxpcHNvaWQxNTsKICAgIGxldCByZWN0YW5nbGUgPSBzY3JhdGNoUmVjdGFuZ2xlNTsKICAgIGNvbnN0IG1pbkhlaWdodCA9IHNjcmF0Y2hTY2FsYXJzLm1pbjsKICAgIGNvbnN0IG1heEhlaWdodCA9IHNjcmF0Y2hTY2FsYXJzLm1heDsKICAgIGxldCBtaW5pbXVtSGVpZ2h0cyA9IHBhcmFtZXRlcnMubWluaW11bUhlaWdodHM7CiAgICBsZXQgbWF4aW11bUhlaWdodHMgPSBwYXJhbWV0ZXJzLm1heGltdW1IZWlnaHRzOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtaW5pbXVtSGVpZ2h0cykgJiYgZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHRzKSkgewogICAgICBtaW5pbXVtSGVpZ2h0cyA9IG5ldyBGbG9hdDMyQXJyYXkobWluaW11bUhlaWdodHMpOwogICAgICBtYXhpbXVtSGVpZ2h0cyA9IG5ldyBGbG9hdDMyQXJyYXkobWF4aW11bUhlaWdodHMpOwogICAgfQogICAgbGV0IGk7CiAgICBsZXQgajsKICAgIGxldCByZ2JhOwogICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDI7CiAgICBjb25zdCB1QnVmZmVyID0gcG9zaXRpb25zLnN1YmFycmF5KDAsIHBvc2l0aW9uc0xlbmd0aCk7CiAgICBjb25zdCB2QnVmZmVyID0gcG9zaXRpb25zLnN1YmFycmF5KHBvc2l0aW9uc0xlbmd0aCwgMiAqIHBvc2l0aW9uc0xlbmd0aCk7CiAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LnppZ1phZ0RlbHRhRGVjb2RlKHVCdWZmZXIsIHZCdWZmZXIpOwogICAgY29uc3QgZGVjb2RlZFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkocG9zaXRpb25zTGVuZ3RoICogMyk7CiAgICBmb3IgKGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgdTMgPSB1QnVmZmVyW2ldOwogICAgICBjb25zdCB2MyA9IHZCdWZmZXJbaV07CiAgICAgIGNvbnN0IHggPSBNYXRoX2RlZmF1bHQubGVycChyZWN0YW5nbGUud2VzdCwgcmVjdGFuZ2xlLmVhc3QsIHUzIC8gbWF4U2hvcnQyKTsKICAgICAgY29uc3QgeSA9IE1hdGhfZGVmYXVsdC5sZXJwKHJlY3RhbmdsZS5zb3V0aCwgcmVjdGFuZ2xlLm5vcnRoLCB2MyAvIG1heFNob3J0Mik7CiAgICAgIGNvbnN0IGNhcnQgPSBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5mcm9tUmFkaWFucyh4LCB5LCAwLCBzY3JhdGNoQlZDYXJ0b2dyYXBoaWMzKTsKICAgICAgY29uc3QgZGVjb2RlZFBvc2l0aW9uID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgIGNhcnQsCiAgICAgICAgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjMKICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soZGVjb2RlZFBvc2l0aW9uLCBkZWNvZGVkUG9zaXRpb25zLCBpICogMyk7CiAgICB9CiAgICBjb25zdCBjb3VudHNMZW5ndGggPSBjb3VudHMubGVuZ3RoOwogICAgY29uc3Qgb2Zmc2V0cyA9IG5ldyBBcnJheShjb3VudHNMZW5ndGgpOwogICAgY29uc3QgaW5kZXhPZmZzZXRzID0gbmV3IEFycmF5KGNvdW50c0xlbmd0aCk7CiAgICBsZXQgY3VycmVudE9mZnNldCA9IDA7CiAgICBsZXQgY3VycmVudEluZGV4T2Zmc2V0ID0gMDsKICAgIGZvciAoaSA9IDA7IGkgPCBjb3VudHNMZW5ndGg7ICsraSkgewogICAgICBvZmZzZXRzW2ldID0gY3VycmVudE9mZnNldDsKICAgICAgaW5kZXhPZmZzZXRzW2ldID0gY3VycmVudEluZGV4T2Zmc2V0OwogICAgICBjdXJyZW50T2Zmc2V0ICs9IGNvdW50c1tpXTsKICAgICAgY3VycmVudEluZGV4T2Zmc2V0ICs9IGluZGV4Q291bnRzW2ldOwogICAgfQogICAgY29uc3QgYmF0Y2hlZFBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkocG9zaXRpb25zTGVuZ3RoICogMyAqIDIpOwogICAgY29uc3QgYmF0Y2hlZElkcyA9IG5ldyBVaW50MTZBcnJheShwb3NpdGlvbnNMZW5ndGggKiAyKTsKICAgIGNvbnN0IGJhdGNoZWRJbmRleE9mZnNldHMgPSBuZXcgVWludDMyQXJyYXkoaW5kZXhPZmZzZXRzLmxlbmd0aCk7CiAgICBjb25zdCBiYXRjaGVkSW5kZXhDb3VudHMgPSBuZXcgVWludDMyQXJyYXkoaW5kZXhDb3VudHMubGVuZ3RoKTsKICAgIGxldCBiYXRjaGVkSW5kaWNlcyA9IFtdOwogICAgY29uc3QgY29sb3JUb0J1ZmZlcnMgPSB7fTsKICAgIGZvciAoaSA9IDA7IGkgPCBjb3VudHNMZW5ndGg7ICsraSkgewogICAgICByZ2JhID0gYmF0Y2hUYWJsZUNvbG9yc1tpXTsKICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoY29sb3JUb0J1ZmZlcnNbcmdiYV0pKSB7CiAgICAgICAgY29sb3JUb0J1ZmZlcnNbcmdiYV0gPSB7CiAgICAgICAgICBwb3NpdGlvbkxlbmd0aDogY291bnRzW2ldLAogICAgICAgICAgaW5kZXhMZW5ndGg6IGluZGV4Q291bnRzW2ldLAogICAgICAgICAgb2Zmc2V0OiAwLAogICAgICAgICAgaW5kZXhPZmZzZXQ6IDAsCiAgICAgICAgICBiYXRjaElkczogW2ldCiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb2xvclRvQnVmZmVyc1tyZ2JhXS5wb3NpdGlvbkxlbmd0aCArPSBjb3VudHNbaV07CiAgICAgICAgY29sb3JUb0J1ZmZlcnNbcmdiYV0uaW5kZXhMZW5ndGggKz0gaW5kZXhDb3VudHNbaV07CiAgICAgICAgY29sb3JUb0J1ZmZlcnNbcmdiYV0uYmF0Y2hJZHMucHVzaChpKTsKICAgICAgfQogICAgfQogICAgbGV0IGJ1ZmZlcjsKICAgIGxldCBieUNvbG9yUG9zaXRpb25PZmZzZXQgPSAwOwogICAgbGV0IGJ5Q29sb3JJbmRleE9mZnNldCA9IDA7CiAgICBmb3IgKHJnYmEgaW4gY29sb3JUb0J1ZmZlcnMpIHsKICAgICAgaWYgKGNvbG9yVG9CdWZmZXJzLmhhc093blByb3BlcnR5KHJnYmEpKSB7CiAgICAgICAgYnVmZmVyID0gY29sb3JUb0J1ZmZlcnNbcmdiYV07CiAgICAgICAgYnVmZmVyLm9mZnNldCA9IGJ5Q29sb3JQb3NpdGlvbk9mZnNldDsKICAgICAgICBidWZmZXIuaW5kZXhPZmZzZXQgPSBieUNvbG9ySW5kZXhPZmZzZXQ7CiAgICAgICAgY29uc3QgcG9zaXRpb25MZW5ndGggPSBidWZmZXIucG9zaXRpb25MZW5ndGggKiAyOwogICAgICAgIGNvbnN0IGluZGV4TGVuZ3RoID0gYnVmZmVyLmluZGV4TGVuZ3RoICogMiArIGJ1ZmZlci5wb3NpdGlvbkxlbmd0aCAqIDY7CiAgICAgICAgYnlDb2xvclBvc2l0aW9uT2Zmc2V0ICs9IHBvc2l0aW9uTGVuZ3RoOwogICAgICAgIGJ5Q29sb3JJbmRleE9mZnNldCArPSBpbmRleExlbmd0aDsKICAgICAgICBidWZmZXIuaW5kZXhMZW5ndGggPSBpbmRleExlbmd0aDsKICAgICAgfQogICAgfQogICAgY29uc3QgYmF0Y2hlZERyYXdDYWxscyA9IFtdOwogICAgZm9yIChyZ2JhIGluIGNvbG9yVG9CdWZmZXJzKSB7CiAgICAgIGlmIChjb2xvclRvQnVmZmVycy5oYXNPd25Qcm9wZXJ0eShyZ2JhKSkgewogICAgICAgIGJ1ZmZlciA9IGNvbG9yVG9CdWZmZXJzW3JnYmFdOwogICAgICAgIGJhdGNoZWREcmF3Q2FsbHMucHVzaCh7CiAgICAgICAgICBjb2xvcjogQ29sb3JfZGVmYXVsdC5mcm9tUmdiYShwYXJzZUludChyZ2JhKSksCiAgICAgICAgICBvZmZzZXQ6IGJ1ZmZlci5pbmRleE9mZnNldCwKICAgICAgICAgIGNvdW50OiBidWZmZXIuaW5kZXhMZW5ndGgsCiAgICAgICAgICBiYXRjaElkczogYnVmZmVyLmJhdGNoSWRzCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIGZvciAoaSA9IDA7IGkgPCBjb3VudHNMZW5ndGg7ICsraSkgewogICAgICByZ2JhID0gYmF0Y2hUYWJsZUNvbG9yc1tpXTsKICAgICAgYnVmZmVyID0gY29sb3JUb0J1ZmZlcnNbcmdiYV07CiAgICAgIGNvbnN0IHBvc2l0aW9uT2Zmc2V0ID0gYnVmZmVyLm9mZnNldDsKICAgICAgbGV0IHBvc2l0aW9uSW5kZXggPSBwb3NpdGlvbk9mZnNldCAqIDM7CiAgICAgIGxldCBiYXRjaElkSW5kZXggPSBwb3NpdGlvbk9mZnNldDsKICAgICAgY29uc3QgcG9seWdvbk9mZnNldCA9IG9mZnNldHNbaV07CiAgICAgIGNvbnN0IHBvbHlnb25Db3VudCA9IGNvdW50c1tpXTsKICAgICAgY29uc3QgYmF0Y2hJZCA9IGJhdGNoSWRzW2ldOwogICAgICBsZXQgcG9seWdvbk1pbmltdW1IZWlnaHQgPSBtaW5IZWlnaHQ7CiAgICAgIGxldCBwb2x5Z29uTWF4aW11bUhlaWdodCA9IG1heEhlaWdodDsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChtaW5pbXVtSGVpZ2h0cykgJiYgZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHRzKSkgewogICAgICAgIHBvbHlnb25NaW5pbXVtSGVpZ2h0ID0gbWluaW11bUhlaWdodHNbaV07CiAgICAgICAgcG9seWdvbk1heGltdW1IZWlnaHQgPSBtYXhpbXVtSGVpZ2h0c1tpXTsKICAgICAgfQogICAgICBsZXQgbWluTGF0ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICBsZXQgbWF4TGF0ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICBsZXQgbWluTG9uID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICBsZXQgbWF4TG9uID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICBmb3IgKGogPSAwOyBqIDwgcG9seWdvbkNvdW50OyArK2opIHsKICAgICAgICBjb25zdCBwb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBkZWNvZGVkUG9zaXRpb25zLAogICAgICAgICAgcG9seWdvbk9mZnNldCAqIDMgKyBqICogMywKICAgICAgICAgIHNjcmF0Y2hFbmNvZGVkUG9zaXRpb24zCiAgICAgICAgKTsKICAgICAgICBlbGxpcHNvaWQuc2NhbGVUb0dlb2RldGljU3VyZmFjZShwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICAgIGNvbnN0IGNhcnRvID0gZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBzY3JhdGNoQlZDYXJ0b2dyYXBoaWMzCiAgICAgICAgKTsKICAgICAgICBjb25zdCBsYXQgPSBjYXJ0by5sYXRpdHVkZTsKICAgICAgICBjb25zdCBsb24gPSBjYXJ0by5sb25naXR1ZGU7CiAgICAgICAgbWluTGF0ID0gTWF0aC5taW4obGF0LCBtaW5MYXQpOwogICAgICAgIG1heExhdCA9IE1hdGgubWF4KGxhdCwgbWF4TGF0KTsKICAgICAgICBtaW5Mb24gPSBNYXRoLm1pbihsb24sIG1pbkxvbik7CiAgICAgICAgbWF4TG9uID0gTWF0aC5tYXgobG9uLCBtYXhMb24pOwogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBlbGxpcHNvaWQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHBvc2l0aW9uLCBzY3JhdGNoTm9ybWFsNyk7CiAgICAgICAgbGV0IHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgIHBvbHlnb25NaW5pbXVtSGVpZ2h0LAogICAgICAgICAgc2NyYXRjaFNjYWxlZE5vcm1hbAogICAgICAgICk7CiAgICAgICAgY29uc3QgbWluSGVpZ2h0UG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKAogICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICBzY2FsZWROb3JtYWwsCiAgICAgICAgICBzY3JhdGNoTWluSGVpZ2h0UG9zaXRpb24KICAgICAgICApOwogICAgICAgIHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjNfZGVmYXVsdC5tdWx0aXBseUJ5U2NhbGFyKAogICAgICAgICAgbm9ybWFsMiwKICAgICAgICAgIHBvbHlnb25NYXhpbXVtSGVpZ2h0LAogICAgICAgICAgc2NhbGVkTm9ybWFsCiAgICAgICAgKTsKICAgICAgICBjb25zdCBtYXhIZWlnaHRQb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5hZGQoCiAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgIHNjYWxlZE5vcm1hbCwKICAgICAgICAgIHNjcmF0Y2hNYXhIZWlnaHRQb3NpdGlvbgogICAgICAgICk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG1heEhlaWdodFBvc2l0aW9uLCBjZW50ZXIsIG1heEhlaWdodFBvc2l0aW9uKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QobWluSGVpZ2h0UG9zaXRpb24sIGNlbnRlciwgbWluSGVpZ2h0UG9zaXRpb24pOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKG1heEhlaWdodFBvc2l0aW9uLCBiYXRjaGVkUG9zaXRpb25zLCBwb3NpdGlvbkluZGV4KTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhtaW5IZWlnaHRQb3NpdGlvbiwgYmF0Y2hlZFBvc2l0aW9ucywgcG9zaXRpb25JbmRleCArIDMpOwogICAgICAgIGJhdGNoZWRJZHNbYmF0Y2hJZEluZGV4XSA9IGJhdGNoSWQ7CiAgICAgICAgYmF0Y2hlZElkc1tiYXRjaElkSW5kZXggKyAxXSA9IGJhdGNoSWQ7CiAgICAgICAgcG9zaXRpb25JbmRleCArPSA2OwogICAgICAgIGJhdGNoSWRJbmRleCArPSAyOwogICAgICB9CiAgICAgIHJlY3RhbmdsZSA9IHNjcmF0Y2hCVlJlY3RhbmdsZTsKICAgICAgcmVjdGFuZ2xlLndlc3QgPSBtaW5Mb247CiAgICAgIHJlY3RhbmdsZS5lYXN0ID0gbWF4TG9uOwogICAgICByZWN0YW5nbGUuc291dGggPSBtaW5MYXQ7CiAgICAgIHJlY3RhbmdsZS5ub3J0aCA9IG1heExhdDsKICAgICAgYm91bmRpbmdWb2x1bWVzW2ldID0gT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LmZyb21SZWN0YW5nbGUoCiAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgIG1pbkhlaWdodCwKICAgICAgICBtYXhIZWlnaHQsCiAgICAgICAgZWxsaXBzb2lkCiAgICAgICk7CiAgICAgIGxldCBpbmRpY2VzSW5kZXggPSBidWZmZXIuaW5kZXhPZmZzZXQ7CiAgICAgIGNvbnN0IGluZGV4T2Zmc2V0ID0gaW5kZXhPZmZzZXRzW2ldOwogICAgICBjb25zdCBpbmRleENvdW50ID0gaW5kZXhDb3VudHNbaV07CiAgICAgIGJhdGNoZWRJbmRleE9mZnNldHNbaV0gPSBpbmRpY2VzSW5kZXg7CiAgICAgIGZvciAoaiA9IDA7IGogPCBpbmRleENvdW50OyBqICs9IDMpIHsKICAgICAgICBjb25zdCBpMCA9IGluZGljZXNbaW5kZXhPZmZzZXQgKyBqXSAtIHBvbHlnb25PZmZzZXQ7CiAgICAgICAgY29uc3QgaTEgPSBpbmRpY2VzW2luZGV4T2Zmc2V0ICsgaiArIDFdIC0gcG9seWdvbk9mZnNldDsKICAgICAgICBjb25zdCBpMiA9IGluZGljZXNbaW5kZXhPZmZzZXQgKyBqICsgMl0gLSBwb2x5Z29uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkwICogMiArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkxICogMiArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkyICogMiArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGkyICogMiArIDEgKyBwb3NpdGlvbk9mZnNldDsKICAgICAgICBiYXRjaGVkSW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpMSAqIDIgKyAxICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaTAgKiAyICsgMSArIHBvc2l0aW9uT2Zmc2V0OwogICAgICB9CiAgICAgIGZvciAoaiA9IDA7IGogPCBwb2x5Z29uQ291bnQ7ICsraikgewogICAgICAgIGNvbnN0IHYwMiA9IGo7CiAgICAgICAgY29uc3QgdjEyID0gKGogKyAxKSAlIHBvbHlnb25Db3VudDsKICAgICAgICBiYXRjaGVkSW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSB2MDIgKiAyICsgMSArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHYxMiAqIDIgKyBwb3NpdGlvbk9mZnNldDsKICAgICAgICBiYXRjaGVkSW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSB2MDIgKiAyICsgcG9zaXRpb25PZmZzZXQ7CiAgICAgICAgYmF0Y2hlZEluZGljZXNbaW5kaWNlc0luZGV4KytdID0gdjAyICogMiArIDEgKyBwb3NpdGlvbk9mZnNldDsKICAgICAgICBiYXRjaGVkSW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSB2MTIgKiAyICsgMSArIHBvc2l0aW9uT2Zmc2V0OwogICAgICAgIGJhdGNoZWRJbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IHYxMiAqIDIgKyBwb3NpdGlvbk9mZnNldDsKICAgICAgfQogICAgICBidWZmZXIub2Zmc2V0ICs9IHBvbHlnb25Db3VudCAqIDI7CiAgICAgIGJ1ZmZlci5pbmRleE9mZnNldCA9IGluZGljZXNJbmRleDsKICAgICAgYmF0Y2hlZEluZGV4Q291bnRzW2ldID0gaW5kaWNlc0luZGV4IC0gYmF0Y2hlZEluZGV4T2Zmc2V0c1tpXTsKICAgIH0KICAgIGJhdGNoZWRJbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoCiAgICAgIGJhdGNoZWRQb3NpdGlvbnMubGVuZ3RoIC8gMywKICAgICAgYmF0Y2hlZEluZGljZXMKICAgICk7CiAgICBjb25zdCBiYXRjaGVkSW5kaWNlc0xlbmd0aCA9IGJhdGNoZWREcmF3Q2FsbHMubGVuZ3RoOwogICAgZm9yIChsZXQgbSA9IDA7IG0gPCBiYXRjaGVkSW5kaWNlc0xlbmd0aDsgKyttKSB7CiAgICAgIGNvbnN0IHRlbXBJZHMgPSBiYXRjaGVkRHJhd0NhbGxzW21dLmJhdGNoSWRzOwogICAgICBsZXQgY291bnQgPSAwOwogICAgICBjb25zdCB0ZW1wSWRzTGVuZ3RoID0gdGVtcElkcy5sZW5ndGg7CiAgICAgIGZvciAobGV0IG4gPSAwOyBuIDwgdGVtcElkc0xlbmd0aDsgKytuKSB7CiAgICAgICAgY291bnQgKz0gYmF0Y2hlZEluZGV4Q291bnRzW3RlbXBJZHNbbl1dOwogICAgICB9CiAgICAgIGJhdGNoZWREcmF3Q2FsbHNbbV0uY291bnQgPSBjb3VudDsKICAgIH0KICAgIGNvbnN0IGluZGV4RGF0YXR5cGUgPSBiYXRjaGVkSW5kaWNlcy5CWVRFU19QRVJfRUxFTUVOVCA9PT0gMiA/IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9TSE9SVCA6IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9JTlQ7CiAgICBjb25zdCBwYWNrZWRCdWZmZXIgPSBwYWNrQnVmZmVyMigKICAgICAgaW5kZXhEYXRhdHlwZSwKICAgICAgYm91bmRpbmdWb2x1bWVzLAogICAgICBiYXRjaGVkRHJhd0NhbGxzCiAgICApOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKAogICAgICBiYXRjaGVkUG9zaXRpb25zLmJ1ZmZlciwKICAgICAgYmF0Y2hlZEluZGljZXMuYnVmZmVyLAogICAgICBiYXRjaGVkSW5kZXhPZmZzZXRzLmJ1ZmZlciwKICAgICAgYmF0Y2hlZEluZGV4Q291bnRzLmJ1ZmZlciwKICAgICAgYmF0Y2hlZElkcy5idWZmZXIsCiAgICAgIHBhY2tlZEJ1ZmZlci5idWZmZXIKICAgICk7CiAgICByZXR1cm4gewogICAgICBwb3NpdGlvbnM6IGJhdGNoZWRQb3NpdGlvbnMuYnVmZmVyLAogICAgICBpbmRpY2VzOiBiYXRjaGVkSW5kaWNlcy5idWZmZXIsCiAgICAgIGluZGV4T2Zmc2V0czogYmF0Y2hlZEluZGV4T2Zmc2V0cy5idWZmZXIsCiAgICAgIGluZGV4Q291bnRzOiBiYXRjaGVkSW5kZXhDb3VudHMuYnVmZmVyLAogICAgICBiYXRjaElkczogYmF0Y2hlZElkcy5idWZmZXIsCiAgICAgIHBhY2tlZEJ1ZmZlcjogcGFja2VkQnVmZmVyLmJ1ZmZlcgogICAgfTsKICB9CiAgdmFyIHNjcmF0Y2hDZW50ZXI2LCBzY3JhdGNoRWxsaXBzb2lkMTUsIHNjcmF0Y2hSZWN0YW5nbGU1LCBzY3JhdGNoU2NhbGFycywgbWF4U2hvcnQyLCBzY3JhdGNoRW5jb2RlZFBvc2l0aW9uMywgc2NyYXRjaE5vcm1hbDcsIHNjcmF0Y2hTY2FsZWROb3JtYWwsIHNjcmF0Y2hNaW5IZWlnaHRQb3NpdGlvbiwgc2NyYXRjaE1heEhlaWdodFBvc2l0aW9uLCBzY3JhdGNoQlZDYXJ0b2dyYXBoaWMzLCBzY3JhdGNoQlZSZWN0YW5nbGUsIGNyZWF0ZVZlY3RvclRpbGVQb2x5Z29uc19kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVZlY3RvclRpbGVQb2x5Z29ucyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zLmpzIigpIHsKICAgICAgaW5pdF9BdHRyaWJ1dGVDb21wcmVzc2lvbigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9Db2xvcigpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X09yaWVudGVkQm91bmRpbmdCb3goKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIHNjcmF0Y2hDZW50ZXI2ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoRWxsaXBzb2lkMTUgPSBuZXcgRWxsaXBzb2lkX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFJlY3RhbmdsZTUgPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFNjYWxhcnMgPSB7CiAgICAgICAgbWluOiB2b2lkIDAsCiAgICAgICAgbWF4OiB2b2lkIDAsCiAgICAgICAgaW5kZXhCeXRlc1BlckVsZW1lbnQ6IHZvaWQgMAogICAgICB9OwogICAgICBtYXhTaG9ydDIgPSAzMjc2NzsKICAgICAgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjMgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hOb3JtYWw3ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoU2NhbGVkTm9ybWFsID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWluSGVpZ2h0UG9zaXRpb24gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hNYXhIZWlnaHRQb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEJWQ2FydG9ncmFwaGljMyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQlZSZWN0YW5nbGUgPSBuZXcgUmVjdGFuZ2xlX2RlZmF1bHQoKTsKICAgICAgY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQoY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlY29kZVZlY3RvclBvbHlsaW5lUG9zaXRpb25zLmpzCiAgZnVuY3Rpb24gZGVjb2RlVmVjdG9yUG9seWxpbmVQb3NpdGlvbnMocG9zaXRpb25zLCByZWN0YW5nbGUsIG1pbmltdW1IZWlnaHQsIG1heGltdW1IZWlnaHQsIGVsbGlwc29pZCkgewogICAgY29uc3QgcG9zaXRpb25zTGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aCAvIDM7CiAgICBjb25zdCB1QnVmZmVyID0gcG9zaXRpb25zLnN1YmFycmF5KDAsIHBvc2l0aW9uc0xlbmd0aCk7CiAgICBjb25zdCB2QnVmZmVyID0gcG9zaXRpb25zLnN1YmFycmF5KHBvc2l0aW9uc0xlbmd0aCwgMiAqIHBvc2l0aW9uc0xlbmd0aCk7CiAgICBjb25zdCBoZWlnaHRCdWZmZXIgPSBwb3NpdGlvbnMuc3ViYXJyYXkoCiAgICAgIDIgKiBwb3NpdGlvbnNMZW5ndGgsCiAgICAgIDMgKiBwb3NpdGlvbnNMZW5ndGgKICAgICk7CiAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LnppZ1phZ0RlbHRhRGVjb2RlKHVCdWZmZXIsIHZCdWZmZXIsIGhlaWdodEJ1ZmZlcik7CiAgICBjb25zdCBkZWNvZGVkID0gbmV3IEZsb2F0NjRBcnJheShwb3NpdGlvbnMubGVuZ3RoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zTGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgdTMgPSB1QnVmZmVyW2ldOwogICAgICBjb25zdCB2MyA9IHZCdWZmZXJbaV07CiAgICAgIGNvbnN0IGggPSBoZWlnaHRCdWZmZXJbaV07CiAgICAgIGNvbnN0IGxvbiA9IE1hdGhfZGVmYXVsdC5sZXJwKHJlY3RhbmdsZS53ZXN0LCByZWN0YW5nbGUuZWFzdCwgdTMgLyBtYXhTaG9ydDMpOwogICAgICBjb25zdCBsYXQgPSBNYXRoX2RlZmF1bHQubGVycChyZWN0YW5nbGUuc291dGgsIHJlY3RhbmdsZS5ub3J0aCwgdjMgLyBtYXhTaG9ydDMpOwogICAgICBjb25zdCBhbHQgPSBNYXRoX2RlZmF1bHQubGVycChtaW5pbXVtSGVpZ2h0LCBtYXhpbXVtSGVpZ2h0LCBoIC8gbWF4U2hvcnQzKTsKICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IENhcnRvZ3JhcGhpY19kZWZhdWx0LmZyb21SYWRpYW5zKAogICAgICAgIGxvbiwKICAgICAgICBsYXQsCiAgICAgICAgYWx0LAogICAgICAgIHNjcmF0Y2hCVkNhcnRvZ3JhcGhpYzQKICAgICAgKTsKICAgICAgY29uc3QgZGVjb2RlZFBvc2l0aW9uID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgIGNhcnRvZ3JhcGhpYzIsCiAgICAgICAgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjQKICAgICAgKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soZGVjb2RlZFBvc2l0aW9uLCBkZWNvZGVkLCBpICogMyk7CiAgICB9CiAgICByZXR1cm4gZGVjb2RlZDsKICB9CiAgdmFyIG1heFNob3J0Mywgc2NyYXRjaEJWQ2FydG9ncmFwaGljNCwgc2NyYXRjaEVuY29kZWRQb3NpdGlvbjQsIGRlY29kZVZlY3RvclBvbHlsaW5lUG9zaXRpb25zX2RlZmF1bHQ7CiAgdmFyIGluaXRfZGVjb2RlVmVjdG9yUG9seWxpbmVQb3NpdGlvbnMgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlY29kZVZlY3RvclBvbHlsaW5lUG9zaXRpb25zLmpzIigpIHsKICAgICAgaW5pdF9BdHRyaWJ1dGVDb21wcmVzc2lvbigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIG1heFNob3J0MyA9IDMyNzY3OwogICAgICBzY3JhdGNoQlZDYXJ0b2dyYXBoaWM0ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbmNvZGVkUG9zaXRpb240ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBkZWNvZGVWZWN0b3JQb2x5bGluZVBvc2l0aW9uc19kZWZhdWx0ID0gZGVjb2RlVmVjdG9yUG9seWxpbmVQb3NpdGlvbnM7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzLmpzCiAgdmFyIGNyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXNfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVZlY3RvclRpbGVQb2x5bGluZXNfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lc19kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gdW5wYWNrQnVmZmVyNChwYWNrZWRCdWZmZXIpIHsKICAgIHBhY2tlZEJ1ZmZlciA9IG5ldyBGbG9hdDY0QXJyYXkocGFja2VkQnVmZmVyKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgc2NyYXRjaE1pbk1heEhlaWdodHMyLm1pbiA9IHBhY2tlZEJ1ZmZlcltvZmZzZXQrK107CiAgICBzY3JhdGNoTWluTWF4SGVpZ2h0czIubWF4ID0gcGFja2VkQnVmZmVyW29mZnNldCsrXTsKICAgIFJlY3RhbmdsZV9kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgc2NyYXRjaFJlY3RhbmdsZTYpOwogICAgb2Zmc2V0ICs9IFJlY3RhbmdsZV9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgIEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhwYWNrZWRCdWZmZXIsIG9mZnNldCwgc2NyYXRjaEVsbGlwc29pZDE2KTsKICAgIG9mZnNldCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHBhY2tlZEJ1ZmZlciwgb2Zmc2V0LCBzY3JhdGNoQ2VudGVyNyk7CiAgfQogIGZ1bmN0aW9uIGdldFBvc2l0aW9uT2Zmc2V0czIoY291bnRzKSB7CiAgICBjb25zdCBjb3VudHNMZW5ndGggPSBjb3VudHMubGVuZ3RoOwogICAgY29uc3QgcG9zaXRpb25PZmZzZXRzID0gbmV3IFVpbnQzMkFycmF5KGNvdW50c0xlbmd0aCArIDEpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50c0xlbmd0aDsgKytpKSB7CiAgICAgIHBvc2l0aW9uT2Zmc2V0c1tpXSA9IG9mZnNldDsKICAgICAgb2Zmc2V0ICs9IGNvdW50c1tpXTsKICAgIH0KICAgIHBvc2l0aW9uT2Zmc2V0c1tjb3VudHNMZW5ndGhdID0gb2Zmc2V0OwogICAgcmV0dXJuIHBvc2l0aW9uT2Zmc2V0czsKICB9CiAgZnVuY3Rpb24gY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lcyhwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCBlbmNvZGVkUG9zaXRpb25zID0gbmV3IFVpbnQxNkFycmF5KHBhcmFtZXRlcnMucG9zaXRpb25zKTsKICAgIGNvbnN0IHdpZHRocyA9IG5ldyBVaW50MTZBcnJheShwYXJhbWV0ZXJzLndpZHRocyk7CiAgICBjb25zdCBjb3VudHMgPSBuZXcgVWludDMyQXJyYXkocGFyYW1ldGVycy5jb3VudHMpOwogICAgY29uc3QgYmF0Y2hJZHMgPSBuZXcgVWludDE2QXJyYXkocGFyYW1ldGVycy5iYXRjaElkcyk7CiAgICB1bnBhY2tCdWZmZXI0KHBhcmFtZXRlcnMucGFja2VkQnVmZmVyKTsKICAgIGNvbnN0IHJlY3RhbmdsZSA9IHNjcmF0Y2hSZWN0YW5nbGU2OwogICAgY29uc3QgZWxsaXBzb2lkID0gc2NyYXRjaEVsbGlwc29pZDE2OwogICAgY29uc3QgY2VudGVyID0gc2NyYXRjaENlbnRlcjc7CiAgICBjb25zdCBtaW5pbXVtSGVpZ2h0ID0gc2NyYXRjaE1pbk1heEhlaWdodHMyLm1pbjsKICAgIGNvbnN0IG1heGltdW1IZWlnaHQgPSBzY3JhdGNoTWluTWF4SGVpZ2h0czIubWF4OwogICAgY29uc3QgcG9zaXRpb25zID0gZGVjb2RlVmVjdG9yUG9seWxpbmVQb3NpdGlvbnNfZGVmYXVsdCgKICAgICAgZW5jb2RlZFBvc2l0aW9ucywKICAgICAgcmVjdGFuZ2xlLAogICAgICBtaW5pbXVtSGVpZ2h0LAogICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICBlbGxpcHNvaWQKICAgICk7CiAgICBjb25zdCBwb3NpdGlvbnNMZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgIGNvbnN0IHNpemUgPSBwb3NpdGlvbnNMZW5ndGggKiA0IC0gNDsKICAgIGNvbnN0IGN1clBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDMpOwogICAgY29uc3QgcHJldlBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDMpOwogICAgY29uc3QgbmV4dFBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIDMpOwogICAgY29uc3QgZXhwYW5kQW5kV2lkdGggPSBuZXcgRmxvYXQzMkFycmF5KHNpemUgKiAyKTsKICAgIGNvbnN0IHZlcnRleEJhdGNoSWRzID0gbmV3IFVpbnQxNkFycmF5KHNpemUpOwogICAgbGV0IHBvc2l0aW9uSW5kZXggPSAwOwogICAgbGV0IGV4cGFuZEFuZFdpZHRoSW5kZXggPSAwOwogICAgbGV0IGJhdGNoSWRJbmRleCA9IDA7CiAgICBsZXQgaTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgbGV0IGxlbmd0aCA9IGNvdW50cy5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgY291bnQgPSBjb3VudHNbaV07CiAgICAgIGNvbnN0IHdpZHRoID0gd2lkdGhzW2ldOwogICAgICBjb25zdCBiYXRjaElkID0gYmF0Y2hJZHNbaV07CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgY291bnQ7ICsraikgewogICAgICAgIGxldCBwcmV2aW91czsKICAgICAgICBpZiAoaiA9PT0gMCkgewogICAgICAgICAgY29uc3QgcDAgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHBvc2l0aW9ucywgb2Zmc2V0ICogMywgc2NyYXRjaFAwMik7CiAgICAgICAgICBjb25zdCBwMSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2socG9zaXRpb25zLCAob2Zmc2V0ICsgMSkgKiAzLCBzY3JhdGNoUDEyKTsKICAgICAgICAgIHByZXZpb3VzID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KHAwLCBwMSwgc2NyYXRjaFByZXYyKTsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5hZGQocDAsIHByZXZpb3VzLCBwcmV2aW91cyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHByZXZpb3VzID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICAob2Zmc2V0ICsgaiAtIDEpICogMywKICAgICAgICAgICAgc2NyYXRjaFByZXYyCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBjdXJyZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0LnVucGFjaygKICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgIChvZmZzZXQgKyBqKSAqIDMsCiAgICAgICAgICBzY3JhdGNoQ3VyCiAgICAgICAgKTsKICAgICAgICBsZXQgbmV4dDsKICAgICAgICBpZiAoaiA9PT0gY291bnQgLSAxKSB7CiAgICAgICAgICBjb25zdCBwMiA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgKG9mZnNldCArIGNvdW50IC0gMSkgKiAzLAogICAgICAgICAgICBzY3JhdGNoUDAyCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcDMgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIChvZmZzZXQgKyBjb3VudCAtIDIpICogMywKICAgICAgICAgICAgc2NyYXRjaFAxMgogICAgICAgICAgKTsKICAgICAgICAgIG5leHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QocDIsIHAzLCBzY3JhdGNoTmV4dDIpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmFkZChwMiwgbmV4dCwgbmV4dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5leHQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKHBvc2l0aW9ucywgKG9mZnNldCArIGogKyAxKSAqIDMsIHNjcmF0Y2hOZXh0Mik7CiAgICAgICAgfQogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwcmV2aW91cywgY2VudGVyLCBwcmV2aW91cyk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KGN1cnJlbnQsIGNlbnRlciwgY3VycmVudCk7CiAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5leHQsIGNlbnRlciwgbmV4dCk7CiAgICAgICAgY29uc3Qgc3RhcnRLID0gaiA9PT0gMCA/IDIgOiAwOwogICAgICAgIGNvbnN0IGVuZEsgPSBqID09PSBjb3VudCAtIDEgPyAyIDogNDsKICAgICAgICBmb3IgKGxldCBrID0gc3RhcnRLOyBrIDwgZW5kSzsgKytrKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjdXJyZW50LCBjdXJQb3NpdGlvbnMsIHBvc2l0aW9uSW5kZXgpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2socHJldmlvdXMsIHByZXZQb3NpdGlvbnMsIHBvc2l0aW9uSW5kZXgpOwogICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2sobmV4dCwgbmV4dFBvc2l0aW9ucywgcG9zaXRpb25JbmRleCk7CiAgICAgICAgICBwb3NpdGlvbkluZGV4ICs9IDM7CiAgICAgICAgICBjb25zdCBkaXJlY3Rpb24yID0gayAtIDIgPCAwID8gLTEgOiAxOwogICAgICAgICAgZXhwYW5kQW5kV2lkdGhbZXhwYW5kQW5kV2lkdGhJbmRleCsrXSA9IDIgKiAoayAlIDIpIC0gMTsKICAgICAgICAgIGV4cGFuZEFuZFdpZHRoW2V4cGFuZEFuZFdpZHRoSW5kZXgrK10gPSBkaXJlY3Rpb24yICogd2lkdGg7CiAgICAgICAgICB2ZXJ0ZXhCYXRjaElkc1tiYXRjaElkSW5kZXgrK10gPSBiYXRjaElkOwogICAgICAgIH0KICAgICAgfQogICAgICBvZmZzZXQgKz0gY291bnQ7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkoc2l6ZSwgcG9zaXRpb25zTGVuZ3RoICogNiAtIDYpOwogICAgbGV0IGluZGV4ID0gMDsKICAgIGxldCBpbmRpY2VzSW5kZXggPSAwOwogICAgbGVuZ3RoID0gcG9zaXRpb25zTGVuZ3RoIC0gMTsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4OwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMjsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpbmRleCArIDE7CiAgICAgIGluZGljZXNbaW5kaWNlc0luZGV4KytdID0gaW5kZXggKyAxOwogICAgICBpbmRpY2VzW2luZGljZXNJbmRleCsrXSA9IGluZGV4ICsgMjsKICAgICAgaW5kaWNlc1tpbmRpY2VzSW5kZXgrK10gPSBpbmRleCArIDM7CiAgICAgIGluZGV4ICs9IDQ7CiAgICB9CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goCiAgICAgIGN1clBvc2l0aW9ucy5idWZmZXIsCiAgICAgIHByZXZQb3NpdGlvbnMuYnVmZmVyLAogICAgICBuZXh0UG9zaXRpb25zLmJ1ZmZlcgogICAgKTsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaCgKICAgICAgZXhwYW5kQW5kV2lkdGguYnVmZmVyLAogICAgICB2ZXJ0ZXhCYXRjaElkcy5idWZmZXIsCiAgICAgIGluZGljZXMuYnVmZmVyCiAgICApOwogICAgbGV0IHJlc3VsdHMgPSB7CiAgICAgIGluZGV4RGF0YXR5cGU6IGluZGljZXMuQllURVNfUEVSX0VMRU1FTlQgPT09IDIgPyBJbmRleERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfU0hPUlQgOiBJbmRleERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfSU5ULAogICAgICBjdXJyZW50UG9zaXRpb25zOiBjdXJQb3NpdGlvbnMuYnVmZmVyLAogICAgICBwcmV2aW91c1Bvc2l0aW9uczogcHJldlBvc2l0aW9ucy5idWZmZXIsCiAgICAgIG5leHRQb3NpdGlvbnM6IG5leHRQb3NpdGlvbnMuYnVmZmVyLAogICAgICBleHBhbmRBbmRXaWR0aDogZXhwYW5kQW5kV2lkdGguYnVmZmVyLAogICAgICBiYXRjaElkczogdmVydGV4QmF0Y2hJZHMuYnVmZmVyLAogICAgICBpbmRpY2VzOiBpbmRpY2VzLmJ1ZmZlcgogICAgfTsKICAgIGlmIChwYXJhbWV0ZXJzLmtlZXBEZWNvZGVkUG9zaXRpb25zKSB7CiAgICAgIGNvbnN0IHBvc2l0aW9uT2Zmc2V0cyA9IGdldFBvc2l0aW9uT2Zmc2V0czIoY291bnRzKTsKICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKHBvc2l0aW9ucy5idWZmZXIsIHBvc2l0aW9uT2Zmc2V0cy5idWZmZXIpOwogICAgICByZXN1bHRzID0gY29tYmluZV9kZWZhdWx0KHJlc3VsdHMsIHsKICAgICAgICBkZWNvZGVkUG9zaXRpb25zOiBwb3NpdGlvbnMuYnVmZmVyLAogICAgICAgIGRlY29kZWRQb3NpdGlvbk9mZnNldHM6IHBvc2l0aW9uT2Zmc2V0cy5idWZmZXIKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9CiAgdmFyIHNjcmF0Y2hSZWN0YW5nbGU2LCBzY3JhdGNoRWxsaXBzb2lkMTYsIHNjcmF0Y2hDZW50ZXI3LCBzY3JhdGNoTWluTWF4SGVpZ2h0czIsIHNjcmF0Y2hQMDIsIHNjcmF0Y2hQMTIsIHNjcmF0Y2hQcmV2Miwgc2NyYXRjaEN1ciwgc2NyYXRjaE5leHQyLCBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lcyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lcy5qcyIoKSB7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X2NvbWJpbmUoKTsKICAgICAgaW5pdF9kZWNvZGVWZWN0b3JQb2x5bGluZVBvc2l0aW9ucygpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIHNjcmF0Y2hSZWN0YW5nbGU2ID0gbmV3IFJlY3RhbmdsZV9kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxNiA9IG5ldyBFbGxpcHNvaWRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2VudGVyNyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1pbk1heEhlaWdodHMyID0gewogICAgICAgIG1pbjogdm9pZCAwLAogICAgICAgIG1heDogdm9pZCAwCiAgICAgIH07CiAgICAgIHNjcmF0Y2hQMDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQMTIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hQcmV2MiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEN1ciA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE5leHQyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQoY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lcyk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9FbGxpcHNvaWRhbE9jY2x1ZGVyLmpzCiAgZnVuY3Rpb24gRWxsaXBzb2lkYWxPY2NsdWRlcihlbGxpcHNvaWQsIGNhbWVyYVBvc2l0aW9uKSB7CiAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5vYmplY3QoImVsbGlwc29pZCIsIGVsbGlwc29pZCk7CiAgICB0aGlzLl9lbGxpcHNvaWQgPSBlbGxpcHNvaWQ7CiAgICB0aGlzLl9jYW1lcmFQb3NpdGlvbiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgIHRoaXMuX2NhbWVyYVBvc2l0aW9uSW5TY2FsZWRTcGFjZSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgIHRoaXMuX2Rpc3RhbmNlVG9MaW1iSW5TY2FsZWRTcGFjZVNxdWFyZWQgPSAwOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChjYW1lcmFQb3NpdGlvbikpIHsKICAgICAgdGhpcy5jYW1lcmFQb3NpdGlvbiA9IGNhbWVyYVBvc2l0aW9uOwogICAgfQogIH0KICBmdW5jdGlvbiBnZXRQb3NzaWJseVNocnVua0VsbGlwc29pZChlbGxpcHNvaWQsIG1pbmltdW1IZWlnaHQsIHJlc3VsdCkgewogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtaW5pbXVtSGVpZ2h0KSAmJiBtaW5pbXVtSGVpZ2h0IDwgMCAmJiBlbGxpcHNvaWQubWluaW11bVJhZGl1cyA+IC1taW5pbXVtSGVpZ2h0KSB7CiAgICAgIGNvbnN0IGVsbGlwc29pZFNocnVua1JhZGlpID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21FbGVtZW50cygKICAgICAgICBlbGxpcHNvaWQucmFkaWkueCArIG1pbmltdW1IZWlnaHQsCiAgICAgICAgZWxsaXBzb2lkLnJhZGlpLnkgKyBtaW5pbXVtSGVpZ2h0LAogICAgICAgIGVsbGlwc29pZC5yYWRpaS56ICsgbWluaW11bUhlaWdodCwKICAgICAgICBzY3JhdGNoRWxsaXBzb2lkU2hydW5rUmFkaWkKICAgICAgKTsKICAgICAgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuZnJvbUNhcnRlc2lhbjMoZWxsaXBzb2lkU2hydW5rUmFkaWksIHJlc3VsdCk7CiAgICB9CiAgICByZXR1cm4gZWxsaXBzb2lkOwogIH0KICBmdW5jdGlvbiBjb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21Qb3NpdGlvbnMoZWxsaXBzb2lkLCBkaXJlY3Rpb25Ub1BvaW50LCBwb3NpdGlvbnMsIHJlc3VsdCkgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkaXJlY3Rpb25Ub1BvaW50IiwgZGlyZWN0aW9uVG9Qb2ludCk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInBvc2l0aW9ucyIsIHBvc2l0aW9ucyk7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgIH0KICAgIGNvbnN0IHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCA9IGNvbXB1dGVTY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQoCiAgICAgIGVsbGlwc29pZCwKICAgICAgZGlyZWN0aW9uVG9Qb2ludAogICAgKTsKICAgIGxldCByZXN1bHRNYWduaXR1ZGUgPSAwOwogICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHBvc2l0aW9ucy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICBjb25zdCBwb3NpdGlvbiA9IHBvc2l0aW9uc1tpXTsKICAgICAgY29uc3QgY2FuZGlkYXRlTWFnbml0dWRlID0gY29tcHV0ZU1hZ25pdHVkZSgKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgcG9zaXRpb24sCiAgICAgICAgc2NhbGVkU3BhY2VEaXJlY3Rpb25Ub1BvaW50CiAgICAgICk7CiAgICAgIGlmIChjYW5kaWRhdGVNYWduaXR1ZGUgPCAwKSB7CiAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgfQogICAgICByZXN1bHRNYWduaXR1ZGUgPSBNYXRoLm1heChyZXN1bHRNYWduaXR1ZGUsIGNhbmRpZGF0ZU1hZ25pdHVkZSk7CiAgICB9CiAgICByZXR1cm4gbWFnbml0dWRlVG9Qb2ludChzY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQsIHJlc3VsdE1hZ25pdHVkZSwgcmVzdWx0KTsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnRGcm9tVmVydGljZXMoZWxsaXBzb2lkLCBkaXJlY3Rpb25Ub1BvaW50LCB2ZXJ0aWNlcywgc3RyaWRlLCBjZW50ZXIsIHJlc3VsdCkgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkaXJlY3Rpb25Ub1BvaW50IiwgZGlyZWN0aW9uVG9Qb2ludCk7CiAgICBDaGVja19kZWZhdWx0LmRlZmluZWQoInZlcnRpY2VzIiwgdmVydGljZXMpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJzdHJpZGUiLCBzdHJpZGUpOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICB9CiAgICBzdHJpZGUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdHJpZGUsIDMpOwogICAgY2VudGVyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoY2VudGVyLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTyk7CiAgICBjb25zdCBzY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQgPSBjb21wdXRlU2NhbGVkU3BhY2VEaXJlY3Rpb25Ub1BvaW50KAogICAgICBlbGxpcHNvaWQsCiAgICAgIGRpcmVjdGlvblRvUG9pbnQKICAgICk7CiAgICBsZXQgcmVzdWx0TWFnbml0dWRlID0gMDsKICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSB2ZXJ0aWNlcy5sZW5ndGg7IGkgPCBsZW47IGkgKz0gc3RyaWRlKSB7CiAgICAgIHBvc2l0aW9uU2NyYXRjaDUueCA9IHZlcnRpY2VzW2ldICsgY2VudGVyLng7CiAgICAgIHBvc2l0aW9uU2NyYXRjaDUueSA9IHZlcnRpY2VzW2kgKyAxXSArIGNlbnRlci55OwogICAgICBwb3NpdGlvblNjcmF0Y2g1LnogPSB2ZXJ0aWNlc1tpICsgMl0gKyBjZW50ZXIuejsKICAgICAgY29uc3QgY2FuZGlkYXRlTWFnbml0dWRlID0gY29tcHV0ZU1hZ25pdHVkZSgKICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgcG9zaXRpb25TY3JhdGNoNSwKICAgICAgICBzY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQKICAgICAgKTsKICAgICAgaWYgKGNhbmRpZGF0ZU1hZ25pdHVkZSA8IDApIHsKICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9CiAgICAgIHJlc3VsdE1hZ25pdHVkZSA9IE1hdGgubWF4KHJlc3VsdE1hZ25pdHVkZSwgY2FuZGlkYXRlTWFnbml0dWRlKTsKICAgIH0KICAgIHJldHVybiBtYWduaXR1ZGVUb1BvaW50KHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCwgcmVzdWx0TWFnbml0dWRlLCByZXN1bHQpOwogIH0KICBmdW5jdGlvbiBpc1NjYWxlZFNwYWNlUG9pbnRWaXNpYmxlKG9jY2x1ZGVlU2NhbGVkU3BhY2VQb3NpdGlvbiwgY2FtZXJhUG9zaXRpb25JblNjYWxlZFNwYWNlLCBkaXN0YW5jZVRvTGltYkluU2NhbGVkU3BhY2VTcXVhcmVkKSB7CiAgICBjb25zdCBjdiA9IGNhbWVyYVBvc2l0aW9uSW5TY2FsZWRTcGFjZTsKICAgIGNvbnN0IHZoTWFnbml0dWRlU3F1YXJlZCA9IGRpc3RhbmNlVG9MaW1iSW5TY2FsZWRTcGFjZVNxdWFyZWQ7CiAgICBjb25zdCB2dCA9IENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdCgKICAgICAgb2NjbHVkZWVTY2FsZWRTcGFjZVBvc2l0aW9uLAogICAgICBjdiwKICAgICAgc2NyYXRjaENhcnRlc2lhbjE5CiAgICApOwogICAgY29uc3QgdnREb3RWYyA9IC1DYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KHZ0LCBjdik7CiAgICBjb25zdCBpc09jY2x1ZGVkID0gdmhNYWduaXR1ZGVTcXVhcmVkIDwgMCA/IHZ0RG90VmMgPiAwIDogdnREb3RWYyA+IHZoTWFnbml0dWRlU3F1YXJlZCAmJiB2dERvdFZjICogdnREb3RWYyAvIENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGVTcXVhcmVkKHZ0KSA+IHZoTWFnbml0dWRlU3F1YXJlZDsKICAgIHJldHVybiAhaXNPY2NsdWRlZDsKICB9CiAgZnVuY3Rpb24gY29tcHV0ZU1hZ25pdHVkZShlbGxpcHNvaWQsIHBvc2l0aW9uLCBzY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQpIHsKICAgIGNvbnN0IHNjYWxlZFNwYWNlUG9zaXRpb24gPSBlbGxpcHNvaWQudHJhbnNmb3JtUG9zaXRpb25Ub1NjYWxlZFNwYWNlKAogICAgICBwb3NpdGlvbiwKICAgICAgc2NhbGVkU3BhY2VTY3JhdGNoCiAgICApOwogICAgbGV0IG1hZ25pdHVkZVNxdWFyZWQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZChzY2FsZWRTcGFjZVBvc2l0aW9uKTsKICAgIGxldCBtYWduaXR1ZGUgPSBNYXRoLnNxcnQobWFnbml0dWRlU3F1YXJlZCk7CiAgICBjb25zdCBkaXJlY3Rpb24yID0gQ2FydGVzaWFuM19kZWZhdWx0LmRpdmlkZUJ5U2NhbGFyKAogICAgICBzY2FsZWRTcGFjZVBvc2l0aW9uLAogICAgICBtYWduaXR1ZGUsCiAgICAgIGRpcmVjdGlvblNjcmF0Y2gKICAgICk7CiAgICBtYWduaXR1ZGVTcXVhcmVkID0gTWF0aC5tYXgoMSwgbWFnbml0dWRlU3F1YXJlZCk7CiAgICBtYWduaXR1ZGUgPSBNYXRoLm1heCgxLCBtYWduaXR1ZGUpOwogICAgY29uc3QgY29zQWxwaGEgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZG90KGRpcmVjdGlvbjIsIHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCk7CiAgICBjb25zdCBzaW5BbHBoYSA9IENhcnRlc2lhbjNfZGVmYXVsdC5tYWduaXR1ZGUoCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhkaXJlY3Rpb24yLCBzY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQsIGRpcmVjdGlvbjIpCiAgICApOwogICAgY29uc3QgY29zQmV0YSA9IDEgLyBtYWduaXR1ZGU7CiAgICBjb25zdCBzaW5CZXRhID0gTWF0aC5zcXJ0KG1hZ25pdHVkZVNxdWFyZWQgLSAxKSAqIGNvc0JldGE7CiAgICByZXR1cm4gMSAvIChjb3NBbHBoYSAqIGNvc0JldGEgLSBzaW5BbHBoYSAqIHNpbkJldGEpOwogIH0KICBmdW5jdGlvbiBtYWduaXR1ZGVUb1BvaW50KHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCwgcmVzdWx0TWFnbml0dWRlLCByZXN1bHQpIHsKICAgIGlmIChyZXN1bHRNYWduaXR1ZGUgPD0gMCB8fCByZXN1bHRNYWduaXR1ZGUgPT09IDEgLyAwIHx8IHJlc3VsdE1hZ25pdHVkZSAhPT0gcmVzdWx0TWFnbml0dWRlKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0Lm11bHRpcGx5QnlTY2FsYXIoCiAgICAgIHNjYWxlZFNwYWNlRGlyZWN0aW9uVG9Qb2ludCwKICAgICAgcmVzdWx0TWFnbml0dWRlLAogICAgICByZXN1bHQKICAgICk7CiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVTY2FsZWRTcGFjZURpcmVjdGlvblRvUG9pbnQoZWxsaXBzb2lkLCBkaXJlY3Rpb25Ub1BvaW50KSB7CiAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFscyhkaXJlY3Rpb25Ub1BvaW50LCBDYXJ0ZXNpYW4zX2RlZmF1bHQuWkVSTykpIHsKICAgICAgcmV0dXJuIGRpcmVjdGlvblRvUG9pbnQ7CiAgICB9CiAgICBlbGxpcHNvaWQudHJhbnNmb3JtUG9zaXRpb25Ub1NjYWxlZFNwYWNlKAogICAgICBkaXJlY3Rpb25Ub1BvaW50LAogICAgICBkaXJlY3Rpb25Ub1BvaW50U2NyYXRjaAogICAgKTsKICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQubm9ybWFsaXplKGRpcmVjdGlvblRvUG9pbnRTY3JhdGNoLCBkaXJlY3Rpb25Ub1BvaW50U2NyYXRjaCk7CiAgfQogIHZhciBzY3JhdGNoQ2FydGVzaWFuMTksIHNjcmF0Y2hDYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2VTaHJ1bmssIHNjcmF0Y2hFbGxpcHNvaWRTaHJ1bmssIHN1YnNhbXBsZVNjcmF0Y2gsIHNjcmF0Y2hFbGxpcHNvaWRTaHJ1bmtSYWRpaSwgcG9zaXRpb25TY3JhdGNoNSwgc2NhbGVkU3BhY2VTY3JhdGNoLCBkaXJlY3Rpb25TY3JhdGNoLCBkaXJlY3Rpb25Ub1BvaW50U2NyYXRjaCwgRWxsaXBzb2lkYWxPY2NsdWRlcl9kZWZhdWx0OwogIHZhciBpbml0X0VsbGlwc29pZGFsT2NjbHVkZXIgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0VsbGlwc29pZGFsT2NjbHVkZXIuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZSwgewogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIG9jY2x1ZGluZyBlbGxpcHNvaWQuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZGFsT2NjbHVkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0VsbGlwc29pZH0KICAgICAgICAgKi8KICAgICAgICBlbGxpcHNvaWQ6IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbGxpcHNvaWQ7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIG9yIHNldHMgdGhlIHBvc2l0aW9uIG9mIHRoZSBjYW1lcmEuCiAgICAgICAgICogQG1lbWJlcm9mIEVsbGlwc29pZGFsT2NjbHVkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0NhcnRlc2lhbjN9CiAgICAgICAgICovCiAgICAgICAgY2FtZXJhUG9zaXRpb246IHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jYW1lcmFQb3NpdGlvbjsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGNhbWVyYVBvc2l0aW9uKSB7CiAgICAgICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHRoaXMuX2VsbGlwc29pZDsKICAgICAgICAgICAgY29uc3QgY3YgPSBlbGxpcHNvaWQudHJhbnNmb3JtUG9zaXRpb25Ub1NjYWxlZFNwYWNlKAogICAgICAgICAgICAgIGNhbWVyYVBvc2l0aW9uLAogICAgICAgICAgICAgIHRoaXMuX2NhbWVyYVBvc2l0aW9uSW5TY2FsZWRTcGFjZQogICAgICAgICAgICApOwogICAgICAgICAgICBjb25zdCB2aE1hZ25pdHVkZVNxdWFyZWQgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlU3F1YXJlZChjdikgLSAxOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoY2FtZXJhUG9zaXRpb24sIHRoaXMuX2NhbWVyYVBvc2l0aW9uKTsKICAgICAgICAgICAgdGhpcy5fY2FtZXJhUG9zaXRpb25JblNjYWxlZFNwYWNlID0gY3Y7CiAgICAgICAgICAgIHRoaXMuX2Rpc3RhbmNlVG9MaW1iSW5TY2FsZWRTcGFjZVNxdWFyZWQgPSB2aE1hZ25pdHVkZVNxdWFyZWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjE5ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZS5pc1BvaW50VmlzaWJsZSA9IGZ1bmN0aW9uKG9jY2x1ZGVlKSB7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gdGhpcy5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IG9jY2x1ZGVlU2NhbGVkU3BhY2VQb3NpdGlvbiA9IGVsbGlwc29pZC50cmFuc2Zvcm1Qb3NpdGlvblRvU2NhbGVkU3BhY2UoCiAgICAgICAgICBvY2NsdWRlZSwKICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4xOQogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGlzU2NhbGVkU3BhY2VQb2ludFZpc2libGUoCiAgICAgICAgICBvY2NsdWRlZVNjYWxlZFNwYWNlUG9zaXRpb24sCiAgICAgICAgICB0aGlzLl9jYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2UsCiAgICAgICAgICB0aGlzLl9kaXN0YW5jZVRvTGltYkluU2NhbGVkU3BhY2VTcXVhcmVkCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkYWxPY2NsdWRlci5wcm90b3R5cGUuaXNTY2FsZWRTcGFjZVBvaW50VmlzaWJsZSA9IGZ1bmN0aW9uKG9jY2x1ZGVlU2NhbGVkU3BhY2VQb3NpdGlvbikgewogICAgICAgIHJldHVybiBpc1NjYWxlZFNwYWNlUG9pbnRWaXNpYmxlKAogICAgICAgICAgb2NjbHVkZWVTY2FsZWRTcGFjZVBvc2l0aW9uLAogICAgICAgICAgdGhpcy5fY2FtZXJhUG9zaXRpb25JblNjYWxlZFNwYWNlLAogICAgICAgICAgdGhpcy5fZGlzdGFuY2VUb0xpbWJJblNjYWxlZFNwYWNlU3F1YXJlZAogICAgICAgICk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hDYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2VTaHJ1bmsgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEVsbGlwc29pZGFsT2NjbHVkZXIucHJvdG90eXBlLmlzU2NhbGVkU3BhY2VQb2ludFZpc2libGVQb3NzaWJseVVuZGVyRWxsaXBzb2lkID0gZnVuY3Rpb24ob2NjbHVkZWVTY2FsZWRTcGFjZVBvc2l0aW9uLCBtaW5pbXVtSGVpZ2h0KSB7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gdGhpcy5fZWxsaXBzb2lkOwogICAgICAgIGxldCB2aE1hZ25pdHVkZVNxdWFyZWQ7CiAgICAgICAgbGV0IGN2OwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodCkgJiYgbWluaW11bUhlaWdodCA8IDAgJiYgZWxsaXBzb2lkLm1pbmltdW1SYWRpdXMgPiAtbWluaW11bUhlaWdodCkgewogICAgICAgICAgY3YgPSBzY3JhdGNoQ2FtZXJhUG9zaXRpb25JblNjYWxlZFNwYWNlU2hydW5rOwogICAgICAgICAgY3YueCA9IHRoaXMuX2NhbWVyYVBvc2l0aW9uLnggLyAoZWxsaXBzb2lkLnJhZGlpLnggKyBtaW5pbXVtSGVpZ2h0KTsKICAgICAgICAgIGN2LnkgPSB0aGlzLl9jYW1lcmFQb3NpdGlvbi55IC8gKGVsbGlwc29pZC5yYWRpaS55ICsgbWluaW11bUhlaWdodCk7CiAgICAgICAgICBjdi56ID0gdGhpcy5fY2FtZXJhUG9zaXRpb24ueiAvIChlbGxpcHNvaWQucmFkaWkueiArIG1pbmltdW1IZWlnaHQpOwogICAgICAgICAgdmhNYWduaXR1ZGVTcXVhcmVkID0gY3YueCAqIGN2LnggKyBjdi55ICogY3YueSArIGN2LnogKiBjdi56IC0gMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3YgPSB0aGlzLl9jYW1lcmFQb3NpdGlvbkluU2NhbGVkU3BhY2U7CiAgICAgICAgICB2aE1hZ25pdHVkZVNxdWFyZWQgPSB0aGlzLl9kaXN0YW5jZVRvTGltYkluU2NhbGVkU3BhY2VTcXVhcmVkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaXNTY2FsZWRTcGFjZVBvaW50VmlzaWJsZSgKICAgICAgICAgIG9jY2x1ZGVlU2NhbGVkU3BhY2VQb3NpdGlvbiwKICAgICAgICAgIGN2LAogICAgICAgICAgdmhNYWduaXR1ZGVTcXVhcmVkCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkYWxPY2NsdWRlci5wcm90b3R5cGUuY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnQgPSBmdW5jdGlvbihkaXJlY3Rpb25Ub1BvaW50LCBwb3NpdGlvbnMsIHJlc3VsdCkgewogICAgICAgIHJldHVybiBjb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21Qb3NpdGlvbnMoCiAgICAgICAgICB0aGlzLl9lbGxpcHNvaWQsCiAgICAgICAgICBkaXJlY3Rpb25Ub1BvaW50LAogICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgc2NyYXRjaEVsbGlwc29pZFNocnVuayA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgRWxsaXBzb2lkYWxPY2NsdWRlci5wcm90b3R5cGUuY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnRQb3NzaWJseVVuZGVyRWxsaXBzb2lkID0gZnVuY3Rpb24oZGlyZWN0aW9uVG9Qb2ludCwgcG9zaXRpb25zLCBtaW5pbXVtSGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBjb25zdCBwb3NzaWJseVNocnVua0VsbGlwc29pZCA9IGdldFBvc3NpYmx5U2hydW5rRWxsaXBzb2lkKAogICAgICAgICAgdGhpcy5fZWxsaXBzb2lkLAogICAgICAgICAgbWluaW11bUhlaWdodCwKICAgICAgICAgIHNjcmF0Y2hFbGxpcHNvaWRTaHJ1bmsKICAgICAgICApOwogICAgICAgIHJldHVybiBjb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21Qb3NpdGlvbnMoCiAgICAgICAgICBwb3NzaWJseVNocnVua0VsbGlwc29pZCwKICAgICAgICAgIGRpcmVjdGlvblRvUG9pbnQsCiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICByZXN1bHQKICAgICAgICApOwogICAgICB9OwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZS5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21WZXJ0aWNlcyA9IGZ1bmN0aW9uKGRpcmVjdGlvblRvUG9pbnQsIHZlcnRpY2VzLCBzdHJpZGUsIGNlbnRlciwgcmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVIb3Jpem9uQ3VsbGluZ1BvaW50RnJvbVZlcnRpY2VzKAogICAgICAgICAgdGhpcy5fZWxsaXBzb2lkLAogICAgICAgICAgZGlyZWN0aW9uVG9Qb2ludCwKICAgICAgICAgIHZlcnRpY2VzLAogICAgICAgICAgc3RyaWRlLAogICAgICAgICAgY2VudGVyLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgRWxsaXBzb2lkYWxPY2NsdWRlci5wcm90b3R5cGUuY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnRGcm9tVmVydGljZXNQb3NzaWJseVVuZGVyRWxsaXBzb2lkID0gZnVuY3Rpb24oZGlyZWN0aW9uVG9Qb2ludCwgdmVydGljZXMsIHN0cmlkZSwgY2VudGVyLCBtaW5pbXVtSGVpZ2h0LCByZXN1bHQpIHsKICAgICAgICBjb25zdCBwb3NzaWJseVNocnVua0VsbGlwc29pZCA9IGdldFBvc3NpYmx5U2hydW5rRWxsaXBzb2lkKAogICAgICAgICAgdGhpcy5fZWxsaXBzb2lkLAogICAgICAgICAgbWluaW11bUhlaWdodCwKICAgICAgICAgIHNjcmF0Y2hFbGxpcHNvaWRTaHJ1bmsKICAgICAgICApOwogICAgICAgIHJldHVybiBjb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21WZXJ0aWNlcygKICAgICAgICAgIHBvc3NpYmx5U2hydW5rRWxsaXBzb2lkLAogICAgICAgICAgZGlyZWN0aW9uVG9Qb2ludCwKICAgICAgICAgIHZlcnRpY2VzLAogICAgICAgICAgc3RyaWRlLAogICAgICAgICAgY2VudGVyLAogICAgICAgICAgcmVzdWx0CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgc3Vic2FtcGxlU2NyYXRjaCA9IFtdOwogICAgICBFbGxpcHNvaWRhbE9jY2x1ZGVyLnByb3RvdHlwZS5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludEZyb21SZWN0YW5nbGUgPSBmdW5jdGlvbihyZWN0YW5nbGUsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJyZWN0YW5nbGUiLCByZWN0YW5nbGUpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IFJlY3RhbmdsZV9kZWZhdWx0LnN1YnNhbXBsZSgKICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIDAsCiAgICAgICAgICBzdWJzYW1wbGVTY3JhdGNoCiAgICAgICAgKTsKICAgICAgICBjb25zdCBicyA9IEJvdW5kaW5nU3BoZXJlX2RlZmF1bHQuZnJvbVBvaW50cyhwb3NpdGlvbnMpOwogICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGJzLmNlbnRlcikgPCAwLjEgKiBlbGxpcHNvaWQubWluaW11bVJhZGl1cykgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnQoYnMuY2VudGVyLCBwb3NpdGlvbnMsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWRTaHJ1bmtSYWRpaSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgcG9zaXRpb25TY3JhdGNoNSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NhbGVkU3BhY2VTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBkaXJlY3Rpb25TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBkaXJlY3Rpb25Ub1BvaW50U2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgRWxsaXBzb2lkYWxPY2NsdWRlcl9kZWZhdWx0ID0gRWxsaXBzb2lkYWxPY2NsdWRlcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1ZlcnRpY2FsRXhhZ2dlcmF0aW9uLmpzCiAgdmFyIFZlcnRpY2FsRXhhZ2dlcmF0aW9uLCBzY3JhdGNoQ2FydG9ncmFwaGljNiwgVmVydGljYWxFeGFnZ2VyYXRpb25fZGVmYXVsdDsKICB2YXIgaW5pdF9WZXJ0aWNhbEV4YWdnZXJhdGlvbiA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVmVydGljYWxFeGFnZ2VyYXRpb24uanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgVmVydGljYWxFeGFnZ2VyYXRpb24gPSB7fTsKICAgICAgVmVydGljYWxFeGFnZ2VyYXRpb24uZ2V0SGVpZ2h0ID0gZnVuY3Rpb24oaGVpZ2h0LCBzY2FsZSwgcmVsYXRpdmVIZWlnaHQpIHsKICAgICAgICBpZiAoIU51bWJlci5pc0Zpbml0ZShzY2FsZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJzY2FsZSBtdXN0IGJlIGEgZmluaXRlIG51bWJlci4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFOdW1iZXIuaXNGaW5pdGUocmVsYXRpdmVIZWlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgicmVsYXRpdmVIZWlnaHQgbXVzdCBiZSBhIGZpbml0ZSBudW1iZXIuIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiAoaGVpZ2h0IC0gcmVsYXRpdmVIZWlnaHQpICogc2NhbGUgKyByZWxhdGl2ZUhlaWdodDsKICAgICAgfTsKICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzYgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgVmVydGljYWxFeGFnZ2VyYXRpb24uZ2V0UG9zaXRpb24gPSBmdW5jdGlvbihwb3NpdGlvbiwgZWxsaXBzb2lkLCB2ZXJ0aWNhbEV4YWdnZXJhdGlvbiwgdmVydGljYWxFeGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCwgcmVzdWx0KSB7CiAgICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzYKICAgICAgICApOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNhcnRvZ3JhcGhpYzIpKSB7CiAgICAgICAgICByZXR1cm4gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKHBvc2l0aW9uLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdIZWlnaHQgPSBWZXJ0aWNhbEV4YWdnZXJhdGlvbi5nZXRIZWlnaHQoCiAgICAgICAgICBjYXJ0b2dyYXBoaWMyLmhlaWdodCwKICAgICAgICAgIHZlcnRpY2FsRXhhZ2dlcmF0aW9uLAogICAgICAgICAgdmVydGljYWxFeGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodAogICAgICAgICk7CiAgICAgICAgcmV0dXJuIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tUmFkaWFucygKICAgICAgICAgIGNhcnRvZ3JhcGhpYzIubG9uZ2l0dWRlLAogICAgICAgICAgY2FydG9ncmFwaGljMi5sYXRpdHVkZSwKICAgICAgICAgIG5ld0hlaWdodCwKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHJlc3VsdAogICAgICAgICk7CiAgICAgIH07CiAgICAgIFZlcnRpY2FsRXhhZ2dlcmF0aW9uX2RlZmF1bHQgPSBWZXJ0aWNhbEV4YWdnZXJhdGlvbjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RlcnJhaW5RdWFudGl6YXRpb24uanMKICB2YXIgVGVycmFpblF1YW50aXphdGlvbiwgVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0OwogIHZhciBpbml0X1RlcnJhaW5RdWFudGl6YXRpb24gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1RlcnJhaW5RdWFudGl6YXRpb24uanMiKCkgewogICAgICBUZXJyYWluUXVhbnRpemF0aW9uID0gewogICAgICAgIC8qKgogICAgICAgICAqIFRoZSB2ZXJ0aWNlcyBhcmUgbm90IGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIE5PTkU6IDAsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIHZlcnRpY2VzIGFyZSBjb21wcmVzc2VkIHRvIDEyIGJpdHMuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIEJJVFMxMjogMQogICAgICB9OwogICAgICBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKFRlcnJhaW5RdWFudGl6YXRpb24pOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGVycmFpbkVuY29kaW5nLmpzCiAgZnVuY3Rpb24gVGVycmFpbkVuY29kaW5nKGNlbnRlciwgYXhpc0FsaWduZWRCb3VuZGluZ0JveCwgbWluaW11bUhlaWdodCwgbWF4aW11bUhlaWdodCwgZnJvbUVOVSwgaGFzVmVydGV4Tm9ybWFscywgaGFzV2ViTWVyY2F0b3JULCBoYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzLCBleGFnZ2VyYXRpb24sIGV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0KSB7CiAgICBsZXQgcXVhbnRpemF0aW9uID0gVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0Lk5PTkU7CiAgICBsZXQgdG9FTlU7CiAgICBsZXQgbWF0cml4OwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChheGlzQWxpZ25lZEJvdW5kaW5nQm94KSAmJiBkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodCkgJiYgZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHQpICYmIGRlZmluZWRfZGVmYXVsdChmcm9tRU5VKSkgewogICAgICBjb25zdCBtaW5pbXVtID0gYXhpc0FsaWduZWRCb3VuZGluZ0JveC5taW5pbXVtOwogICAgICBjb25zdCBtYXhpbXVtID0gYXhpc0FsaWduZWRCb3VuZGluZ0JveC5tYXhpbXVtOwogICAgICBjb25zdCBkaW1lbnNpb25zID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgIG1heGltdW0sCiAgICAgICAgbWluaW11bSwKICAgICAgICBjYXJ0ZXNpYW4zRGltU2NyYXRjaAogICAgICApOwogICAgICBjb25zdCBoRGltID0gbWF4aW11bUhlaWdodCAtIG1pbmltdW1IZWlnaHQ7CiAgICAgIGNvbnN0IG1heERpbSA9IE1hdGgubWF4KENhcnRlc2lhbjNfZGVmYXVsdC5tYXhpbXVtQ29tcG9uZW50KGRpbWVuc2lvbnMpLCBoRGltKTsKICAgICAgaWYgKG1heERpbSA8IFNISUZUX0xFRlRfMTIgLSAxKSB7CiAgICAgICAgcXVhbnRpemF0aW9uID0gVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0LkJJVFMxMjsKICAgICAgfSBlbHNlIHsKICAgICAgICBxdWFudGl6YXRpb24gPSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuTk9ORTsKICAgICAgfQogICAgICB0b0VOVSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oZnJvbUVOVSwgbmV3IE1hdHJpeDRfZGVmYXVsdCgpKTsKICAgICAgY29uc3QgdHJhbnNsYXRpb24yID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5lZ2F0ZShtaW5pbXVtLCBjYXJ0ZXNpYW4zU2NyYXRjaCk7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseSgKICAgICAgICBNYXRyaXg0X2RlZmF1bHQuZnJvbVRyYW5zbGF0aW9uKHRyYW5zbGF0aW9uMiwgbWF0cml4NFNjcmF0Y2gpLAogICAgICAgIHRvRU5VLAogICAgICAgIHRvRU5VCiAgICAgICk7CiAgICAgIGNvbnN0IHNjYWxlID0gY2FydGVzaWFuM1NjcmF0Y2g7CiAgICAgIHNjYWxlLnggPSAxIC8gZGltZW5zaW9ucy54OwogICAgICBzY2FsZS55ID0gMSAvIGRpbWVuc2lvbnMueTsKICAgICAgc2NhbGUueiA9IDEgLyBkaW1lbnNpb25zLno7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShNYXRyaXg0X2RlZmF1bHQuZnJvbVNjYWxlKHNjYWxlLCBtYXRyaXg0U2NyYXRjaCksIHRvRU5VLCB0b0VOVSk7CiAgICAgIG1hdHJpeCA9IE1hdHJpeDRfZGVmYXVsdC5jbG9uZShmcm9tRU5VKTsKICAgICAgTWF0cml4NF9kZWZhdWx0LnNldFRyYW5zbGF0aW9uKG1hdHJpeCwgQ2FydGVzaWFuM19kZWZhdWx0LlpFUk8sIG1hdHJpeCk7CiAgICAgIGZyb21FTlUgPSBNYXRyaXg0X2RlZmF1bHQuY2xvbmUoZnJvbUVOVSwgbmV3IE1hdHJpeDRfZGVmYXVsdCgpKTsKICAgICAgY29uc3QgdHJhbnNsYXRpb25NYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQuZnJvbVRyYW5zbGF0aW9uKG1pbmltdW0sIG1hdHJpeDRTY3JhdGNoKTsKICAgICAgY29uc3Qgc2NhbGVNYXRyaXgyID0gTWF0cml4NF9kZWZhdWx0LmZyb21TY2FsZShkaW1lbnNpb25zLCBtYXRyaXg0U2NyYXRjaDIpOwogICAgICBjb25zdCBzdCA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseSh0cmFuc2xhdGlvbk1hdHJpeCwgc2NhbGVNYXRyaXgyLCBtYXRyaXg0U2NyYXRjaCk7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShmcm9tRU5VLCBzdCwgZnJvbUVOVSk7CiAgICAgIE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseShtYXRyaXgsIHN0LCBtYXRyaXgpOwogICAgfQogICAgdGhpcy5xdWFudGl6YXRpb24gPSBxdWFudGl6YXRpb247CiAgICB0aGlzLm1pbmltdW1IZWlnaHQgPSBtaW5pbXVtSGVpZ2h0OwogICAgdGhpcy5tYXhpbXVtSGVpZ2h0ID0gbWF4aW11bUhlaWdodDsKICAgIHRoaXMuY2VudGVyID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKGNlbnRlcik7CiAgICB0aGlzLnRvU2NhbGVkRU5VID0gdG9FTlU7CiAgICB0aGlzLmZyb21TY2FsZWRFTlUgPSBmcm9tRU5VOwogICAgdGhpcy5tYXRyaXggPSBtYXRyaXg7CiAgICB0aGlzLmhhc1ZlcnRleE5vcm1hbHMgPSBoYXNWZXJ0ZXhOb3JtYWxzOwogICAgdGhpcy5oYXNXZWJNZXJjYXRvclQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChoYXNXZWJNZXJjYXRvclQsIGZhbHNlKTsKICAgIHRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBoYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBmYWxzZQogICAgKTsKICAgIHRoaXMuZXhhZ2dlcmF0aW9uID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZXhhZ2dlcmF0aW9uLCAxKTsKICAgIHRoaXMuZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQsCiAgICAgIDAKICAgICk7CiAgICB0aGlzLnN0cmlkZSA9IDA7CiAgICB0aGlzLl9vZmZzZXRHZW9kZXRpY1N1cmZhY2VOb3JtYWwgPSAwOwogICAgdGhpcy5fb2Zmc2V0VmVydGV4Tm9ybWFsID0gMDsKICAgIHRoaXMuX2NhbGN1bGF0ZVN0cmlkZUFuZE9mZnNldHMoKTsKICB9CiAgdmFyIGNhcnRlc2lhbjNTY3JhdGNoLCBjYXJ0ZXNpYW4zRGltU2NyYXRjaCwgY2FydGVzaWFuMlNjcmF0Y2gsIG1hdHJpeDRTY3JhdGNoLCBtYXRyaXg0U2NyYXRjaDIsIFNISUZUX0xFRlRfMTIsIHNjcmF0Y2hQb3NpdGlvbjYsIHNjcmF0Y2hHZW9kZXRpY1N1cmZhY2VOb3JtYWwsIGF0dHJpYnV0ZXNJbmRpY2VzTm9uZSwgYXR0cmlidXRlc0luZGljZXNCaXRzMTIsIFRlcnJhaW5FbmNvZGluZ19kZWZhdWx0OwogIHZhciBpbml0X1RlcnJhaW5FbmNvZGluZyA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVGVycmFpbkVuY29kaW5nLmpzIigpIHsKICAgICAgaW5pdF9BdHRyaWJ1dGVDb21wcmVzc2lvbigpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ29tcG9uZW50RGF0YXR5cGUoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9WZXJ0aWNhbEV4YWdnZXJhdGlvbigpOwogICAgICBpbml0X1RlcnJhaW5RdWFudGl6YXRpb24oKTsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjNEaW1TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYXJ0ZXNpYW4yU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgbWF0cml4NFNjcmF0Y2ggPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIG1hdHJpeDRTY3JhdGNoMiA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgU0hJRlRfTEVGVF8xMiA9IE1hdGgucG93KDIsIDEyKTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5lbmNvZGUgPSBmdW5jdGlvbih2ZXJ0ZXhCdWZmZXIsIGJ1ZmZlckluZGV4LCBwb3NpdGlvbiwgdXYsIGhlaWdodCwgbm9ybWFsVG9QYWNrLCB3ZWJNZXJjYXRvclQsIGdlb2RldGljU3VyZmFjZU5vcm1hbCkgewogICAgICAgIGNvbnN0IHUzID0gdXYueDsKICAgICAgICBjb25zdCB2MyA9IHV2Lnk7CiAgICAgICAgaWYgKHRoaXMucXVhbnRpemF0aW9uID09PSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuQklUUzEyKSB7CiAgICAgICAgICBwb3NpdGlvbiA9IE1hdHJpeDRfZGVmYXVsdC5tdWx0aXBseUJ5UG9pbnQoCiAgICAgICAgICAgIHRoaXMudG9TY2FsZWRFTlUsCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBjYXJ0ZXNpYW4zU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIHBvc2l0aW9uLnggPSBNYXRoX2RlZmF1bHQuY2xhbXAocG9zaXRpb24ueCwgMCwgMSk7CiAgICAgICAgICBwb3NpdGlvbi55ID0gTWF0aF9kZWZhdWx0LmNsYW1wKHBvc2l0aW9uLnksIDAsIDEpOwogICAgICAgICAgcG9zaXRpb24ueiA9IE1hdGhfZGVmYXVsdC5jbGFtcChwb3NpdGlvbi56LCAwLCAxKTsKICAgICAgICAgIGNvbnN0IGhEaW0gPSB0aGlzLm1heGltdW1IZWlnaHQgLSB0aGlzLm1pbmltdW1IZWlnaHQ7CiAgICAgICAgICBjb25zdCBoID0gTWF0aF9kZWZhdWx0LmNsYW1wKChoZWlnaHQgLSB0aGlzLm1pbmltdW1IZWlnaHQpIC8gaERpbSwgMCwgMSk7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHBvc2l0aW9uLngsIHBvc2l0aW9uLnksIGNhcnRlc2lhbjJTY3JhdGNoKTsKICAgICAgICAgIGNvbnN0IGNvbXByZXNzZWQwID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5jb21wcmVzc1RleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgY2FydGVzaWFuMlNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHBvc2l0aW9uLnosIGgsIGNhcnRlc2lhbjJTY3JhdGNoKTsKICAgICAgICAgIGNvbnN0IGNvbXByZXNzZWQxID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5jb21wcmVzc1RleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgY2FydGVzaWFuMlNjcmF0Y2gKICAgICAgICAgICk7CiAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHUzLCB2MywgY2FydGVzaWFuMlNjcmF0Y2gpOwogICAgICAgICAgY29uc3QgY29tcHJlc3NlZDIgPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmNvbXByZXNzVGV4dHVyZUNvb3JkaW5hdGVzKAogICAgICAgICAgICBjYXJ0ZXNpYW4yU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGNvbXByZXNzZWQwOwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gY29tcHJlc3NlZDE7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBjb21wcmVzc2VkMjsKICAgICAgICAgIGlmICh0aGlzLmhhc1dlYk1lcmNhdG9yVCkgewogICAgICAgICAgICBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKHdlYk1lcmNhdG9yVCwgMCwgY2FydGVzaWFuMlNjcmF0Y2gpOwogICAgICAgICAgICBjb25zdCBjb21wcmVzc2VkMyA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgICAgY2FydGVzaWFuMlNjcmF0Y2gKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gY29tcHJlc3NlZDM7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5zdWJ0cmFjdChwb3NpdGlvbiwgdGhpcy5jZW50ZXIsIGNhcnRlc2lhbjNTY3JhdGNoKTsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGNhcnRlc2lhbjNTY3JhdGNoLng7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBjYXJ0ZXNpYW4zU2NyYXRjaC55OwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gY2FydGVzaWFuM1NjcmF0Y2guejsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGhlaWdodDsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IHUzOwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gdjM7CiAgICAgICAgICBpZiAodGhpcy5oYXNXZWJNZXJjYXRvclQpIHsKICAgICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gd2ViTWVyY2F0b3JUOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5oYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0Lm9jdFBhY2tGbG9hdCgKICAgICAgICAgICAgbm9ybWFsVG9QYWNrCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzKSB7CiAgICAgICAgICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueDsKICAgICAgICAgIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGdlb2RldGljU3VyZmFjZU5vcm1hbC55OwogICAgICAgICAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gZ2VvZGV0aWNTdXJmYWNlTm9ybWFsLno7CiAgICAgICAgfQogICAgICAgIHJldHVybiBidWZmZXJJbmRleDsKICAgICAgfTsKICAgICAgc2NyYXRjaFBvc2l0aW9uNiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaEdlb2RldGljU3VyZmFjZU5vcm1hbCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5hZGRHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gZnVuY3Rpb24ob2xkQnVmZmVyLCBuZXdCdWZmZXIsIGVsbGlwc29pZCkgewogICAgICAgIGlmICh0aGlzLmhhc0dlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb2xkU3RyaWRlID0gdGhpcy5zdHJpZGU7CiAgICAgICAgY29uc3QgdmVydGV4Q291bnQgPSBvbGRCdWZmZXIubGVuZ3RoIC8gb2xkU3RyaWRlOwogICAgICAgIHRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IHRydWU7CiAgICAgICAgdGhpcy5fY2FsY3VsYXRlU3RyaWRlQW5kT2Zmc2V0cygpOwogICAgICAgIGNvbnN0IG5ld1N0cmlkZSA9IHRoaXMuc3RyaWRlOwogICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB2ZXJ0ZXhDb3VudDsgaW5kZXgrKykgewogICAgICAgICAgZm9yIChsZXQgb2Zmc2V0ID0gMDsgb2Zmc2V0IDwgb2xkU3RyaWRlOyBvZmZzZXQrKykgewogICAgICAgICAgICBjb25zdCBvbGRJbmRleCA9IGluZGV4ICogb2xkU3RyaWRlICsgb2Zmc2V0OwogICAgICAgICAgICBjb25zdCBuZXdJbmRleCA9IGluZGV4ICogbmV3U3RyaWRlICsgb2Zmc2V0OwogICAgICAgICAgICBuZXdCdWZmZXJbbmV3SW5kZXhdID0gb2xkQnVmZmVyW29sZEluZGV4XTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gdGhpcy5kZWNvZGVQb3NpdGlvbihuZXdCdWZmZXIsIGluZGV4LCBzY3JhdGNoUG9zaXRpb242KTsKICAgICAgICAgIGNvbnN0IGdlb2RldGljU3VyZmFjZU5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICBzY3JhdGNoR2VvZGV0aWNTdXJmYWNlTm9ybWFsCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgYnVmZmVySW5kZXggPSBpbmRleCAqIG5ld1N0cmlkZSArIHRoaXMuX29mZnNldEdlb2RldGljU3VyZmFjZU5vcm1hbDsKICAgICAgICAgIG5ld0J1ZmZlcltidWZmZXJJbmRleF0gPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueDsKICAgICAgICAgIG5ld0J1ZmZlcltidWZmZXJJbmRleCArIDFdID0gZ2VvZGV0aWNTdXJmYWNlTm9ybWFsLnk7CiAgICAgICAgICBuZXdCdWZmZXJbYnVmZmVySW5kZXggKyAyXSA9IGdlb2RldGljU3VyZmFjZU5vcm1hbC56OwogICAgICAgIH0KICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5yZW1vdmVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gZnVuY3Rpb24ob2xkQnVmZmVyLCBuZXdCdWZmZXIpIHsKICAgICAgICBpZiAoIXRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBvbGRTdHJpZGUgPSB0aGlzLnN0cmlkZTsKICAgICAgICBjb25zdCB2ZXJ0ZXhDb3VudCA9IG9sZEJ1ZmZlci5sZW5ndGggLyBvbGRTdHJpZGU7CiAgICAgICAgdGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gZmFsc2U7CiAgICAgICAgdGhpcy5fY2FsY3VsYXRlU3RyaWRlQW5kT2Zmc2V0cygpOwogICAgICAgIGNvbnN0IG5ld1N0cmlkZSA9IHRoaXMuc3RyaWRlOwogICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB2ZXJ0ZXhDb3VudDsgaW5kZXgrKykgewogICAgICAgICAgZm9yIChsZXQgb2Zmc2V0ID0gMDsgb2Zmc2V0IDwgbmV3U3RyaWRlOyBvZmZzZXQrKykgewogICAgICAgICAgICBjb25zdCBvbGRJbmRleCA9IGluZGV4ICogb2xkU3RyaWRlICsgb2Zmc2V0OwogICAgICAgICAgICBjb25zdCBuZXdJbmRleCA9IGluZGV4ICogbmV3U3RyaWRlICsgb2Zmc2V0OwogICAgICAgICAgICBuZXdCdWZmZXJbbmV3SW5kZXhdID0gb2xkQnVmZmVyW29sZEluZGV4XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZGVjb2RlUG9zaXRpb24gPSBmdW5jdGlvbihidWZmZXIsIGluZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgICAgfQogICAgICAgIGluZGV4ICo9IHRoaXMuc3RyaWRlOwogICAgICAgIGlmICh0aGlzLnF1YW50aXphdGlvbiA9PT0gVGVycmFpblF1YW50aXphdGlvbl9kZWZhdWx0LkJJVFMxMikgewogICAgICAgICAgY29uc3QgeHkgPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmRlY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIGJ1ZmZlcltpbmRleF0sCiAgICAgICAgICAgIGNhcnRlc2lhbjJTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgcmVzdWx0LnggPSB4eS54OwogICAgICAgICAgcmVzdWx0LnkgPSB4eS55OwogICAgICAgICAgY29uc3QgemggPSBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmRlY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIGJ1ZmZlcltpbmRleCArIDFdLAogICAgICAgICAgICBjYXJ0ZXNpYW4yU2NyYXRjaAogICAgICAgICAgKTsKICAgICAgICAgIHJlc3VsdC56ID0gemgueDsKICAgICAgICAgIHJldHVybiBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHRoaXMuZnJvbVNjYWxlZEVOVSwgcmVzdWx0LCByZXN1bHQpOwogICAgICAgIH0KICAgICAgICByZXN1bHQueCA9IGJ1ZmZlcltpbmRleF07CiAgICAgICAgcmVzdWx0LnkgPSBidWZmZXJbaW5kZXggKyAxXTsKICAgICAgICByZXN1bHQueiA9IGJ1ZmZlcltpbmRleCArIDJdOwogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4zX2RlZmF1bHQuYWRkKHJlc3VsdCwgdGhpcy5jZW50ZXIsIHJlc3VsdCk7CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZ2V0RXhhZ2dlcmF0ZWRQb3NpdGlvbiA9IGZ1bmN0aW9uKGJ1ZmZlciwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIHJlc3VsdCA9IHRoaXMuZGVjb2RlUG9zaXRpb24oYnVmZmVyLCBpbmRleCwgcmVzdWx0KTsKICAgICAgICBjb25zdCBleGFnZ2VyYXRpb24gPSB0aGlzLmV4YWdnZXJhdGlvbjsKICAgICAgICBjb25zdCBleGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCA9IHRoaXMuZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQ7CiAgICAgICAgY29uc3QgaGFzRXhhZ2dlcmF0aW9uID0gZXhhZ2dlcmF0aW9uICE9PSAxOwogICAgICAgIGlmIChoYXNFeGFnZ2VyYXRpb24gJiYgdGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzKSB7CiAgICAgICAgICBjb25zdCBnZW9kZXRpY1N1cmZhY2VOb3JtYWwgPSB0aGlzLmRlY29kZUdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICAgICAgYnVmZmVyLAogICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgc2NyYXRjaEdlb2RldGljU3VyZmFjZU5vcm1hbAogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHJhd0hlaWdodCA9IHRoaXMuZGVjb2RlSGVpZ2h0KGJ1ZmZlciwgaW5kZXgpOwogICAgICAgICAgY29uc3QgaGVpZ2h0RGlmZmVyZW5jZSA9IFZlcnRpY2FsRXhhZ2dlcmF0aW9uX2RlZmF1bHQuZ2V0SGVpZ2h0KAogICAgICAgICAgICByYXdIZWlnaHQsCiAgICAgICAgICAgIGV4YWdnZXJhdGlvbiwKICAgICAgICAgICAgZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQKICAgICAgICAgICkgLSByYXdIZWlnaHQ7CiAgICAgICAgICByZXN1bHQueCArPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueCAqIGhlaWdodERpZmZlcmVuY2U7CiAgICAgICAgICByZXN1bHQueSArPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueSAqIGhlaWdodERpZmZlcmVuY2U7CiAgICAgICAgICByZXN1bHQueiArPSBnZW9kZXRpY1N1cmZhY2VOb3JtYWwueiAqIGhlaWdodERpZmZlcmVuY2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZGVjb2RlVGV4dHVyZUNvb3JkaW5hdGVzID0gZnVuY3Rpb24oYnVmZmVyLCBpbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBpbmRleCAqPSB0aGlzLnN0cmlkZTsKICAgICAgICBpZiAodGhpcy5xdWFudGl6YXRpb24gPT09IFRlcnJhaW5RdWFudGl6YXRpb25fZGVmYXVsdC5CSVRTMTIpIHsKICAgICAgICAgIHJldHVybiBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmRlY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIGJ1ZmZlcltpbmRleCArIDJdLAogICAgICAgICAgICByZXN1bHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBDYXJ0ZXNpYW4yX2RlZmF1bHQuZnJvbUVsZW1lbnRzKGJ1ZmZlcltpbmRleCArIDRdLCBidWZmZXJbaW5kZXggKyA1XSwgcmVzdWx0KTsKICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5kZWNvZGVIZWlnaHQgPSBmdW5jdGlvbihidWZmZXIsIGluZGV4KSB7CiAgICAgICAgaW5kZXggKj0gdGhpcy5zdHJpZGU7CiAgICAgICAgaWYgKHRoaXMucXVhbnRpemF0aW9uID09PSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuQklUUzEyKSB7CiAgICAgICAgICBjb25zdCB6aCA9IEF0dHJpYnV0ZUNvbXByZXNzaW9uX2RlZmF1bHQuZGVjb21wcmVzc1RleHR1cmVDb29yZGluYXRlcygKICAgICAgICAgICAgYnVmZmVyW2luZGV4ICsgMV0sCiAgICAgICAgICAgIGNhcnRlc2lhbjJTY3JhdGNoCiAgICAgICAgICApOwogICAgICAgICAgcmV0dXJuIHpoLnkgKiAodGhpcy5tYXhpbXVtSGVpZ2h0IC0gdGhpcy5taW5pbXVtSGVpZ2h0KSArIHRoaXMubWluaW11bUhlaWdodDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJ1ZmZlcltpbmRleCArIDNdOwogICAgICB9OwogICAgICBUZXJyYWluRW5jb2RpbmcucHJvdG90eXBlLmRlY29kZVdlYk1lcmNhdG9yVCA9IGZ1bmN0aW9uKGJ1ZmZlciwgaW5kZXgpIHsKICAgICAgICBpbmRleCAqPSB0aGlzLnN0cmlkZTsKICAgICAgICBpZiAodGhpcy5xdWFudGl6YXRpb24gPT09IFRlcnJhaW5RdWFudGl6YXRpb25fZGVmYXVsdC5CSVRTMTIpIHsKICAgICAgICAgIHJldHVybiBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0LmRlY29tcHJlc3NUZXh0dXJlQ29vcmRpbmF0ZXMoCiAgICAgICAgICAgIGJ1ZmZlcltpbmRleCArIDNdLAogICAgICAgICAgICBjYXJ0ZXNpYW4yU2NyYXRjaAogICAgICAgICAgKS54OwogICAgICAgIH0KICAgICAgICByZXR1cm4gYnVmZmVyW2luZGV4ICsgNl07CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZ2V0T2N0RW5jb2RlZE5vcm1hbCA9IGZ1bmN0aW9uKGJ1ZmZlciwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIGluZGV4ID0gaW5kZXggKiB0aGlzLnN0cmlkZSArIHRoaXMuX29mZnNldFZlcnRleE5vcm1hbDsKICAgICAgICBjb25zdCB0ZW1wID0gYnVmZmVyW2luZGV4XSAvIDI1NjsKICAgICAgICBjb25zdCB4ID0gTWF0aC5mbG9vcih0ZW1wKTsKICAgICAgICBjb25zdCB5ID0gKHRlbXAgLSB4KSAqIDI1NjsKICAgICAgICByZXR1cm4gQ2FydGVzaWFuMl9kZWZhdWx0LmZyb21FbGVtZW50cyh4LCB5LCByZXN1bHQpOwogICAgICB9OwogICAgICBUZXJyYWluRW5jb2RpbmcucHJvdG90eXBlLmRlY29kZUdlb2RldGljU3VyZmFjZU5vcm1hbCA9IGZ1bmN0aW9uKGJ1ZmZlciwgaW5kZXgsIHJlc3VsdCkgewogICAgICAgIGluZGV4ID0gaW5kZXggKiB0aGlzLnN0cmlkZSArIHRoaXMuX29mZnNldEdlb2RldGljU3VyZmFjZU5vcm1hbDsKICAgICAgICByZXN1bHQueCA9IGJ1ZmZlcltpbmRleF07CiAgICAgICAgcmVzdWx0LnkgPSBidWZmZXJbaW5kZXggKyAxXTsKICAgICAgICByZXN1bHQueiA9IGJ1ZmZlcltpbmRleCArIDJdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuX2NhbGN1bGF0ZVN0cmlkZUFuZE9mZnNldHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBsZXQgdmVydGV4U3RyaWRlID0gMDsKICAgICAgICBzd2l0Y2ggKHRoaXMucXVhbnRpemF0aW9uKSB7CiAgICAgICAgICBjYXNlIFRlcnJhaW5RdWFudGl6YXRpb25fZGVmYXVsdC5CSVRTMTI6CiAgICAgICAgICAgIHZlcnRleFN0cmlkZSArPSAzOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHZlcnRleFN0cmlkZSArPSA2OwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5oYXNXZWJNZXJjYXRvclQpIHsKICAgICAgICAgIHZlcnRleFN0cmlkZSArPSAxOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5oYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICAgICAgICB0aGlzLl9vZmZzZXRWZXJ0ZXhOb3JtYWwgPSB2ZXJ0ZXhTdHJpZGU7CiAgICAgICAgICB2ZXJ0ZXhTdHJpZGUgKz0gMTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgICAgdGhpcy5fb2Zmc2V0R2VvZGV0aWNTdXJmYWNlTm9ybWFsID0gdmVydGV4U3RyaWRlOwogICAgICAgICAgdmVydGV4U3RyaWRlICs9IDM7CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RyaWRlID0gdmVydGV4U3RyaWRlOwogICAgICB9OwogICAgICBhdHRyaWJ1dGVzSW5kaWNlc05vbmUgPSB7CiAgICAgICAgcG9zaXRpb24zREFuZEhlaWdodDogMCwKICAgICAgICB0ZXh0dXJlQ29vcmRBbmRFbmNvZGVkTm9ybWFsczogMSwKICAgICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWw6IDIKICAgICAgfTsKICAgICAgYXR0cmlidXRlc0luZGljZXNCaXRzMTIgPSB7CiAgICAgICAgY29tcHJlc3NlZDA6IDAsCiAgICAgICAgY29tcHJlc3NlZDE6IDEsCiAgICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFsOiAyCiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5wcm90b3R5cGUuZ2V0QXR0cmlidXRlcyA9IGZ1bmN0aW9uKGJ1ZmZlcikgewogICAgICAgIGNvbnN0IGRhdGF0eXBlID0gQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVDsKICAgICAgICBjb25zdCBzaXplSW5CeXRlcyA9IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuZ2V0U2l6ZUluQnl0ZXMoZGF0YXR5cGUpOwogICAgICAgIGNvbnN0IHN0cmlkZUluQnl0ZXMgPSB0aGlzLnN0cmlkZSAqIHNpemVJbkJ5dGVzOwogICAgICAgIGxldCBvZmZzZXRJbkJ5dGVzID0gMDsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gW107CiAgICAgICAgZnVuY3Rpb24gYWRkQXR0cmlidXRlKGluZGV4LCBjb21wb25lbnRzUGVyQXR0cmlidXRlKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLnB1c2goewogICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgdmVydGV4QnVmZmVyOiBidWZmZXIsCiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBkYXRhdHlwZSwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZSwKICAgICAgICAgICAgb2Zmc2V0SW5CeXRlcywKICAgICAgICAgICAgc3RyaWRlSW5CeXRlcwogICAgICAgICAgfSk7CiAgICAgICAgICBvZmZzZXRJbkJ5dGVzICs9IGNvbXBvbmVudHNQZXJBdHRyaWJ1dGUgKiBzaXplSW5CeXRlczsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMucXVhbnRpemF0aW9uID09PSBUZXJyYWluUXVhbnRpemF0aW9uX2RlZmF1bHQuTk9ORSkgewogICAgICAgICAgYWRkQXR0cmlidXRlKGF0dHJpYnV0ZXNJbmRpY2VzTm9uZS5wb3NpdGlvbjNEQW5kSGVpZ2h0LCA0KTsKICAgICAgICAgIGxldCBjb21wb25lbnRzVGV4Q29vcmRBbmROb3JtYWxzID0gMjsKICAgICAgICAgIGNvbXBvbmVudHNUZXhDb29yZEFuZE5vcm1hbHMgKz0gdGhpcy5oYXNXZWJNZXJjYXRvclQgPyAxIDogMDsKICAgICAgICAgIGNvbXBvbmVudHNUZXhDb29yZEFuZE5vcm1hbHMgKz0gdGhpcy5oYXNWZXJ0ZXhOb3JtYWxzID8gMSA6IDA7CiAgICAgICAgICBhZGRBdHRyaWJ1dGUoCiAgICAgICAgICAgIGF0dHJpYnV0ZXNJbmRpY2VzTm9uZS50ZXh0dXJlQ29vcmRBbmRFbmNvZGVkTm9ybWFscywKICAgICAgICAgICAgY29tcG9uZW50c1RleENvb3JkQW5kTm9ybWFscwogICAgICAgICAgKTsKICAgICAgICAgIGlmICh0aGlzLmhhc0dlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICAgICAgYWRkQXR0cmlidXRlKGF0dHJpYnV0ZXNJbmRpY2VzTm9uZS5nZW9kZXRpY1N1cmZhY2VOb3JtYWwsIDMpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCB1c2luZ0F0dHJpYnV0ZTBDb21wb25lbnQ0ID0gdGhpcy5oYXNXZWJNZXJjYXRvclQgfHwgdGhpcy5oYXNWZXJ0ZXhOb3JtYWxzOwogICAgICAgICAgY29uc3QgdXNpbmdBdHRyaWJ1dGUxQ29tcG9uZW50MSA9IHRoaXMuaGFzV2ViTWVyY2F0b3JUICYmIHRoaXMuaGFzVmVydGV4Tm9ybWFsczsKICAgICAgICAgIGFkZEF0dHJpYnV0ZSgKICAgICAgICAgICAgYXR0cmlidXRlc0luZGljZXNCaXRzMTIuY29tcHJlc3NlZDAsCiAgICAgICAgICAgIHVzaW5nQXR0cmlidXRlMENvbXBvbmVudDQgPyA0IDogMwogICAgICAgICAgKTsKICAgICAgICAgIGlmICh1c2luZ0F0dHJpYnV0ZTFDb21wb25lbnQxKSB7CiAgICAgICAgICAgIGFkZEF0dHJpYnV0ZShhdHRyaWJ1dGVzSW5kaWNlc0JpdHMxMi5jb21wcmVzc2VkMSwgMSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5oYXNHZW9kZXRpY1N1cmZhY2VOb3JtYWxzKSB7CiAgICAgICAgICAgIGFkZEF0dHJpYnV0ZShhdHRyaWJ1dGVzSW5kaWNlc0JpdHMxMi5nZW9kZXRpY1N1cmZhY2VOb3JtYWwsIDMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgICAgfTsKICAgICAgVGVycmFpbkVuY29kaW5nLnByb3RvdHlwZS5nZXRBdHRyaWJ1dGVMb2NhdGlvbnMgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5xdWFudGl6YXRpb24gPT09IFRlcnJhaW5RdWFudGl6YXRpb25fZGVmYXVsdC5OT05FKSB7CiAgICAgICAgICByZXR1cm4gYXR0cmlidXRlc0luZGljZXNOb25lOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlc0luZGljZXNCaXRzMTI7CiAgICAgIH07CiAgICAgIFRlcnJhaW5FbmNvZGluZy5jbG9uZSA9IGZ1bmN0aW9uKGVuY29kaW5nLCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlbmNvZGluZykpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBUZXJyYWluRW5jb2RpbmcoKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnF1YW50aXphdGlvbiA9IGVuY29kaW5nLnF1YW50aXphdGlvbjsKICAgICAgICByZXN1bHQubWluaW11bUhlaWdodCA9IGVuY29kaW5nLm1pbmltdW1IZWlnaHQ7CiAgICAgICAgcmVzdWx0Lm1heGltdW1IZWlnaHQgPSBlbmNvZGluZy5tYXhpbXVtSGVpZ2h0OwogICAgICAgIHJlc3VsdC5jZW50ZXIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuY2xvbmUoZW5jb2RpbmcuY2VudGVyKTsKICAgICAgICByZXN1bHQudG9TY2FsZWRFTlUgPSBNYXRyaXg0X2RlZmF1bHQuY2xvbmUoZW5jb2RpbmcudG9TY2FsZWRFTlUpOwogICAgICAgIHJlc3VsdC5mcm9tU2NhbGVkRU5VID0gTWF0cml4NF9kZWZhdWx0LmNsb25lKGVuY29kaW5nLmZyb21TY2FsZWRFTlUpOwogICAgICAgIHJlc3VsdC5tYXRyaXggPSBNYXRyaXg0X2RlZmF1bHQuY2xvbmUoZW5jb2RpbmcubWF0cml4KTsKICAgICAgICByZXN1bHQuaGFzVmVydGV4Tm9ybWFscyA9IGVuY29kaW5nLmhhc1ZlcnRleE5vcm1hbHM7CiAgICAgICAgcmVzdWx0Lmhhc1dlYk1lcmNhdG9yVCA9IGVuY29kaW5nLmhhc1dlYk1lcmNhdG9yVDsKICAgICAgICByZXN1bHQuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGVuY29kaW5nLmhhc0dlb2RldGljU3VyZmFjZU5vcm1hbHM7CiAgICAgICAgcmVzdWx0LmV4YWdnZXJhdGlvbiA9IGVuY29kaW5nLmV4YWdnZXJhdGlvbjsKICAgICAgICByZXN1bHQuZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQgPSBlbmNvZGluZy5leGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodDsKICAgICAgICByZXN1bHQuX2NhbGN1bGF0ZVN0cmlkZUFuZE9mZnNldHMoKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBUZXJyYWluRW5jb2RpbmdfZGVmYXVsdCA9IFRlcnJhaW5FbmNvZGluZzsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlci5qcwogIHZhciBjcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXJfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcl9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXJfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGluZGV4T2ZFcHNpbG9uKGFyciwgZWxlbSwgZWxlbVR5cGUpIHsKICAgIGVsZW1UeXBlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoZWxlbVR5cGUsIE1hdGhfZGVmYXVsdCk7CiAgICBjb25zdCBjb3VudCA9IGFyci5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyArK2kpIHsKICAgICAgaWYgKGVsZW1UeXBlLmVxdWFsc0Vwc2lsb24oYXJyW2ldLCBlbGVtLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEyKSkgewogICAgICAgIHJldHVybiBpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcihwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBwYXJhbWV0ZXJzLmVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBhcmFtZXRlcnMuZWxsaXBzb2lkKTsKICAgIHBhcmFtZXRlcnMucmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5yZWN0YW5nbGUpOwogICAgY29uc3Qgc3RhdGlzdGljczIgPSBwcm9jZXNzQnVmZmVyKAogICAgICBwYXJhbWV0ZXJzLmJ1ZmZlciwKICAgICAgcGFyYW1ldGVycy5yZWxhdGl2ZVRvQ2VudGVyLAogICAgICBwYXJhbWV0ZXJzLmVsbGlwc29pZCwKICAgICAgcGFyYW1ldGVycy5yZWN0YW5nbGUsCiAgICAgIHBhcmFtZXRlcnMubmF0aXZlUmVjdGFuZ2xlLAogICAgICBwYXJhbWV0ZXJzLmV4YWdnZXJhdGlvbiwKICAgICAgcGFyYW1ldGVycy5leGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCwKICAgICAgcGFyYW1ldGVycy5za2lydEhlaWdodCwKICAgICAgcGFyYW1ldGVycy5pbmNsdWRlV2ViTWVyY2F0b3JULAogICAgICBwYXJhbWV0ZXJzLm5lZ2F0aXZlQWx0aXR1ZGVFeHBvbmVudEJpYXMsCiAgICAgIHBhcmFtZXRlcnMubmVnYXRpdmVFbGV2YXRpb25UaHJlc2hvbGQKICAgICk7CiAgICBjb25zdCB2ZXJ0aWNlcyA9IHN0YXRpc3RpY3MyLnZlcnRpY2VzOwogICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKHZlcnRpY2VzLmJ1ZmZlcik7CiAgICBjb25zdCBpbmRpY2VzID0gc3RhdGlzdGljczIuaW5kaWNlczsKICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChpbmRpY2VzLmJ1ZmZlcik7CiAgICByZXR1cm4gewogICAgICB2ZXJ0aWNlczogdmVydGljZXMuYnVmZmVyLAogICAgICBpbmRpY2VzOiBpbmRpY2VzLmJ1ZmZlciwKICAgICAgbnVtYmVyT2ZBdHRyaWJ1dGVzOiBzdGF0aXN0aWNzMi5lbmNvZGluZy5zdHJpZGUsCiAgICAgIG1pbmltdW1IZWlnaHQ6IHN0YXRpc3RpY3MyLm1pbmltdW1IZWlnaHQsCiAgICAgIG1heGltdW1IZWlnaHQ6IHN0YXRpc3RpY3MyLm1heGltdW1IZWlnaHQsCiAgICAgIGJvdW5kaW5nU3BoZXJlM0Q6IHN0YXRpc3RpY3MyLmJvdW5kaW5nU3BoZXJlM0QsCiAgICAgIG9yaWVudGVkQm91bmRpbmdCb3g6IHN0YXRpc3RpY3MyLm9yaWVudGVkQm91bmRpbmdCb3gsCiAgICAgIG9jY2x1ZGVlUG9pbnRJblNjYWxlZFNwYWNlOiBzdGF0aXN0aWNzMi5vY2NsdWRlZVBvaW50SW5TY2FsZWRTcGFjZSwKICAgICAgZW5jb2Rpbmc6IHN0YXRpc3RpY3MyLmVuY29kaW5nLAogICAgICB2ZXJ0ZXhDb3VudFdpdGhvdXRTa2lydHM6IHN0YXRpc3RpY3MyLnZlcnRleENvdW50V2l0aG91dFNraXJ0cywKICAgICAgaW5kZXhDb3VudFdpdGhvdXRTa2lydHM6IHN0YXRpc3RpY3MyLmluZGV4Q291bnRXaXRob3V0U2tpcnRzLAogICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aDogc3RhdGlzdGljczIud2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3Q6IHN0YXRpc3RpY3MyLnNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoOiBzdGF0aXN0aWNzMi5lYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwKICAgICAgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdDogc3RhdGlzdGljczIubm9ydGhJbmRpY2VzV2VzdFRvRWFzdAogICAgfTsKICB9CiAgZnVuY3Rpb24gcHJvY2Vzc0J1ZmZlcihidWZmZXIsIHJlbGF0aXZlVG9DZW50ZXIsIGVsbGlwc29pZCwgcmVjdGFuZ2xlLCBuYXRpdmVSZWN0YW5nbGUsIGV4YWdnZXJhdGlvbiwgZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQsIHNraXJ0SGVpZ2h0LCBpbmNsdWRlV2ViTWVyY2F0b3JULCBuZWdhdGl2ZUFsdGl0dWRlRXhwb25lbnRCaWFzLCBuZWdhdGl2ZUVsZXZhdGlvblRocmVzaG9sZCkgewogICAgbGV0IGdlb2dyYXBoaWNXZXN0OwogICAgbGV0IGdlb2dyYXBoaWNTb3V0aDsKICAgIGxldCBnZW9ncmFwaGljRWFzdDsKICAgIGxldCBnZW9ncmFwaGljTm9ydGg7CiAgICBsZXQgcmVjdGFuZ2xlV2lkdGgsIHJlY3RhbmdsZUhlaWdodDsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlY3RhbmdsZSkpIHsKICAgICAgZ2VvZ3JhcGhpY1dlc3QgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS53ZXN0KTsKICAgICAgZ2VvZ3JhcGhpY1NvdXRoID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhuYXRpdmVSZWN0YW5nbGUuc291dGgpOwogICAgICBnZW9ncmFwaGljRWFzdCA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMobmF0aXZlUmVjdGFuZ2xlLmVhc3QpOwogICAgICBnZW9ncmFwaGljTm9ydGggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS5ub3J0aCk7CiAgICAgIHJlY3RhbmdsZVdpZHRoID0gTWF0aF9kZWZhdWx0LnRvUmFkaWFucyhyZWN0YW5nbGUud2lkdGgpOwogICAgICByZWN0YW5nbGVIZWlnaHQgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKHJlY3RhbmdsZS5oZWlnaHQpOwogICAgfSBlbHNlIHsKICAgICAgZ2VvZ3JhcGhpY1dlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgZ2VvZ3JhcGhpY1NvdXRoID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgICBnZW9ncmFwaGljRWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgICBnZW9ncmFwaGljTm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgIHJlY3RhbmdsZVdpZHRoID0gcmVjdGFuZ2xlLndpZHRoOwogICAgICByZWN0YW5nbGVIZWlnaHQgPSByZWN0YW5nbGUuaGVpZ2h0OwogICAgfQogICAgY29uc3QgcXVhZEJvcmRlckxhdGl0dWRlcyA9IFtnZW9ncmFwaGljU291dGgsIGdlb2dyYXBoaWNOb3J0aF07CiAgICBjb25zdCBxdWFkQm9yZGVyTG9uZ2l0dWRlcyA9IFtnZW9ncmFwaGljV2VzdCwgZ2VvZ3JhcGhpY0Vhc3RdOwogICAgY29uc3QgZnJvbUVOVSA9IFRyYW5zZm9ybXNfZGVmYXVsdC5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZSgKICAgICAgcmVsYXRpdmVUb0NlbnRlciwKICAgICAgZWxsaXBzb2lkCiAgICApOwogICAgY29uc3QgdG9FTlUgPSBNYXRyaXg0X2RlZmF1bHQuaW52ZXJzZVRyYW5zZm9ybWF0aW9uKGZyb21FTlUsIG1hdHJpeDRTY3JhdGNoMyk7CiAgICBsZXQgc291dGhNZXJjYXRvclk7CiAgICBsZXQgb25lT3Zlck1lcmNhdG9ySGVpZ2h0OwogICAgaWYgKGluY2x1ZGVXZWJNZXJjYXRvclQpIHsKICAgICAgc291dGhNZXJjYXRvclkgPSBXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdC5nZW9kZXRpY0xhdGl0dWRlVG9NZXJjYXRvckFuZ2xlKAogICAgICAgIGdlb2dyYXBoaWNTb3V0aAogICAgICApOwogICAgICBvbmVPdmVyTWVyY2F0b3JIZWlnaHQgPSAxIC8gKFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoZ2VvZ3JhcGhpY05vcnRoKSAtIHNvdXRoTWVyY2F0b3JZKTsKICAgIH0KICAgIGNvbnN0IGhhc0V4YWdnZXJhdGlvbiA9IGV4YWdnZXJhdGlvbiAhPT0gMTsKICAgIGNvbnN0IGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gaGFzRXhhZ2dlcmF0aW9uOwogICAgY29uc3QgZHYgPSBuZXcgRGF0YVZpZXcoYnVmZmVyKTsKICAgIGxldCBtaW5IZWlnaHQgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWF4SGVpZ2h0ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgY29uc3QgbWluaW11bSA9IG1pbmltdW1TY3JhdGNoOwogICAgbWluaW11bS54ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbWluaW11bS55ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbWluaW11bS56ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgY29uc3QgbWF4aW11bSA9IG1heGltdW1TY3JhdGNoOwogICAgbWF4aW11bS54ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbWF4aW11bS55ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbWF4aW11bS56ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBsZXQgc2l6ZSA9IDA7CiAgICBsZXQgaW5kaWNlc1NpemUgPSAwOwogICAgbGV0IHF1YWRTaXplOwogICAgbGV0IHF1YWQ7CiAgICBmb3IgKHF1YWQgPSAwOyBxdWFkIDwgNDsgKytxdWFkKSB7CiAgICAgIGxldCBvID0gb2Zmc2V0OwogICAgICBxdWFkU2l6ZSA9IGR2LmdldFVpbnQzMihvLCB0cnVlKTsKICAgICAgbyArPSBzaXplT2ZVaW50MzI7CiAgICAgIGNvbnN0IHggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGR2LmdldEZsb2F0NjQobywgdHJ1ZSkgKiAxODApOwogICAgICBvICs9IHNpemVPZkRvdWJsZTsKICAgICAgaWYgKGluZGV4T2ZFcHNpbG9uKHF1YWRCb3JkZXJMb25naXR1ZGVzLCB4KSA9PT0gLTEpIHsKICAgICAgICBxdWFkQm9yZGVyTG9uZ2l0dWRlcy5wdXNoKHgpOwogICAgICB9CiAgICAgIGNvbnN0IHkgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGR2LmdldEZsb2F0NjQobywgdHJ1ZSkgKiAxODApOwogICAgICBvICs9IHNpemVPZkRvdWJsZTsKICAgICAgaWYgKGluZGV4T2ZFcHNpbG9uKHF1YWRCb3JkZXJMYXRpdHVkZXMsIHkpID09PSAtMSkgewogICAgICAgIHF1YWRCb3JkZXJMYXRpdHVkZXMucHVzaCh5KTsKICAgICAgfQogICAgICBvICs9IDIgKiBzaXplT2ZEb3VibGU7CiAgICAgIGxldCBjID0gZHYuZ2V0SW50MzIobywgdHJ1ZSk7CiAgICAgIG8gKz0gc2l6ZU9mSW50MzI7CiAgICAgIHNpemUgKz0gYzsKICAgICAgYyA9IGR2LmdldEludDMyKG8sIHRydWUpOwogICAgICBpbmRpY2VzU2l6ZSArPSBjICogMzsKICAgICAgb2Zmc2V0ICs9IHF1YWRTaXplICsgc2l6ZU9mVWludDMyOwogICAgfQogICAgY29uc3QgcXVhZEJvcmRlclBvaW50cyA9IFtdOwogICAgY29uc3QgcXVhZEJvcmRlckluZGljZXMgPSBbXTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShzaXplKTsKICAgIGNvbnN0IHV2cyA9IG5ldyBBcnJheShzaXplKTsKICAgIGNvbnN0IGhlaWdodHMgPSBuZXcgQXJyYXkoc2l6ZSk7CiAgICBjb25zdCB3ZWJNZXJjYXRvclRzID0gaW5jbHVkZVdlYk1lcmNhdG9yVCA/IG5ldyBBcnJheShzaXplKSA6IFtdOwogICAgY29uc3QgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID8gbmV3IEFycmF5KHNpemUpIDogW107CiAgICBjb25zdCBpbmRpY2VzID0gbmV3IEFycmF5KGluZGljZXNTaXplKTsKICAgIGNvbnN0IHdlc3RCb3JkZXIgPSBbXTsKICAgIGNvbnN0IHNvdXRoQm9yZGVyID0gW107CiAgICBjb25zdCBlYXN0Qm9yZGVyID0gW107CiAgICBjb25zdCBub3J0aEJvcmRlciA9IFtdOwogICAgbGV0IHBvaW50T2Zmc2V0ID0gMDsKICAgIGxldCBpbmRpY2VzT2Zmc2V0ID0gMDsKICAgIG9mZnNldCA9IDA7CiAgICBmb3IgKHF1YWQgPSAwOyBxdWFkIDwgNDsgKytxdWFkKSB7CiAgICAgIHF1YWRTaXplID0gZHYuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSBzaXplT2ZVaW50MzI7CiAgICAgIGNvbnN0IHN0YXJ0UXVhZCA9IG9mZnNldDsKICAgICAgY29uc3Qgb3JpZ2luWCA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoZHYuZ2V0RmxvYXQ2NChvZmZzZXQsIHRydWUpICogMTgwKTsKICAgICAgb2Zmc2V0ICs9IHNpemVPZkRvdWJsZTsKICAgICAgY29uc3Qgb3JpZ2luWSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoZHYuZ2V0RmxvYXQ2NChvZmZzZXQsIHRydWUpICogMTgwKTsKICAgICAgb2Zmc2V0ICs9IHNpemVPZkRvdWJsZTsKICAgICAgY29uc3Qgc3RlcFggPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKGR2LmdldEZsb2F0NjQob2Zmc2V0LCB0cnVlKSAqIDE4MCk7CiAgICAgIGNvbnN0IGhhbGZTdGVwWCA9IHN0ZXBYICogMC41OwogICAgICBvZmZzZXQgKz0gc2l6ZU9mRG91YmxlOwogICAgICBjb25zdCBzdGVwWSA9IE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoZHYuZ2V0RmxvYXQ2NChvZmZzZXQsIHRydWUpICogMTgwKTsKICAgICAgY29uc3QgaGFsZlN0ZXBZID0gc3RlcFkgKiAwLjU7CiAgICAgIG9mZnNldCArPSBzaXplT2ZEb3VibGU7CiAgICAgIGNvbnN0IG51bVBvaW50cyA9IGR2LmdldEludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSBzaXplT2ZJbnQzMjsKICAgICAgY29uc3QgbnVtRmFjZXMgPSBkdi5nZXRJbnQzMihvZmZzZXQsIHRydWUpOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzI7CiAgICAgIG9mZnNldCArPSBzaXplT2ZJbnQzMjsKICAgICAgY29uc3QgaW5kaWNlc01hcHBpbmcgPSBuZXcgQXJyYXkobnVtUG9pbnRzKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1Qb2ludHM7ICsraSkgewogICAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IG9yaWdpblggKyBkdi5nZXRVaW50OChvZmZzZXQrKykgKiBzdGVwWDsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNy5sb25naXR1ZGUgPSBsb25naXR1ZGU7CiAgICAgICAgY29uc3QgbGF0aXR1ZGUgPSBvcmlnaW5ZICsgZHYuZ2V0VWludDgob2Zmc2V0KyspICogc3RlcFk7CiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzcubGF0aXR1ZGUgPSBsYXRpdHVkZTsKICAgICAgICBsZXQgaGVpZ2h0ID0gZHYuZ2V0RmxvYXQzMihvZmZzZXQsIHRydWUpOwogICAgICAgIG9mZnNldCArPSBzaXplT2ZGbG9hdDsKICAgICAgICBpZiAoaGVpZ2h0ICE9PSAwICYmIGhlaWdodCA8IG5lZ2F0aXZlRWxldmF0aW9uVGhyZXNob2xkKSB7CiAgICAgICAgICBoZWlnaHQgKj0gLU1hdGgucG93KDIsIG5lZ2F0aXZlQWx0aXR1ZGVFeHBvbmVudEJpYXMpOwogICAgICAgIH0KICAgICAgICBoZWlnaHQgKj0gNjM3MTAxMDsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgaWYgKGluZGV4T2ZFcHNpbG9uKHF1YWRCb3JkZXJMb25naXR1ZGVzLCBsb25naXR1ZGUpICE9PSAtMSB8fCBpbmRleE9mRXBzaWxvbihxdWFkQm9yZGVyTGF0aXR1ZGVzLCBsYXRpdHVkZSkgIT09IC0xKSB7CiAgICAgICAgICBjb25zdCBpbmRleCA9IGluZGV4T2ZFcHNpbG9uKAogICAgICAgICAgICBxdWFkQm9yZGVyUG9pbnRzLAogICAgICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNywKICAgICAgICAgICAgQ2FydG9ncmFwaGljX2RlZmF1bHQKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgIHF1YWRCb3JkZXJQb2ludHMucHVzaChDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZShzY3JhdGNoQ2FydG9ncmFwaGljNykpOwogICAgICAgICAgICBxdWFkQm9yZGVySW5kaWNlcy5wdXNoKHBvaW50T2Zmc2V0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluZGljZXNNYXBwaW5nW2ldID0gcXVhZEJvcmRlckluZGljZXNbaW5kZXhdOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaW5kaWNlc01hcHBpbmdbaV0gPSBwb2ludE9mZnNldDsKICAgICAgICBpZiAoTWF0aC5hYnMobG9uZ2l0dWRlIC0gZ2VvZ3JhcGhpY1dlc3QpIDwgaGFsZlN0ZXBYKSB7CiAgICAgICAgICB3ZXN0Qm9yZGVyLnB1c2goewogICAgICAgICAgICBpbmRleDogcG9pbnRPZmZzZXQsCiAgICAgICAgICAgIGNhcnRvZ3JhcGhpYzogQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoc2NyYXRjaENhcnRvZ3JhcGhpYzcpCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKE1hdGguYWJzKGxvbmdpdHVkZSAtIGdlb2dyYXBoaWNFYXN0KSA8IGhhbGZTdGVwWCkgewogICAgICAgICAgZWFzdEJvcmRlci5wdXNoKHsKICAgICAgICAgICAgaW5kZXg6IHBvaW50T2Zmc2V0LAogICAgICAgICAgICBjYXJ0b2dyYXBoaWM6IENhcnRvZ3JhcGhpY19kZWZhdWx0LmNsb25lKHNjcmF0Y2hDYXJ0b2dyYXBoaWM3KQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmIChNYXRoLmFicyhsYXRpdHVkZSAtIGdlb2dyYXBoaWNTb3V0aCkgPCBoYWxmU3RlcFkpIHsKICAgICAgICAgIHNvdXRoQm9yZGVyLnB1c2goewogICAgICAgICAgICBpbmRleDogcG9pbnRPZmZzZXQsCiAgICAgICAgICAgIGNhcnRvZ3JhcGhpYzogQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoc2NyYXRjaENhcnRvZ3JhcGhpYzcpCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKE1hdGguYWJzKGxhdGl0dWRlIC0gZ2VvZ3JhcGhpY05vcnRoKSA8IGhhbGZTdGVwWSkgewogICAgICAgICAgbm9ydGhCb3JkZXIucHVzaCh7CiAgICAgICAgICAgIGluZGV4OiBwb2ludE9mZnNldCwKICAgICAgICAgICAgY2FydG9ncmFwaGljOiBDYXJ0b2dyYXBoaWNfZGVmYXVsdC5jbG9uZShzY3JhdGNoQ2FydG9ncmFwaGljNykKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBtaW5IZWlnaHQgPSBNYXRoLm1pbihoZWlnaHQsIG1pbkhlaWdodCk7CiAgICAgICAgbWF4SGVpZ2h0ID0gTWF0aC5tYXgoaGVpZ2h0LCBtYXhIZWlnaHQpOwogICAgICAgIGhlaWdodHNbcG9pbnRPZmZzZXRdID0gaGVpZ2h0OwogICAgICAgIGNvbnN0IHBvcyA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihzY3JhdGNoQ2FydG9ncmFwaGljNyk7CiAgICAgICAgcG9zaXRpb25zW3BvaW50T2Zmc2V0XSA9IHBvczsKICAgICAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICAgICAgd2ViTWVyY2F0b3JUc1twb2ludE9mZnNldF0gPSAoV2ViTWVyY2F0b3JQcm9qZWN0aW9uX2RlZmF1bHQuZ2VvZGV0aWNMYXRpdHVkZVRvTWVyY2F0b3JBbmdsZShsYXRpdHVkZSkgLSBzb3V0aE1lcmNhdG9yWSkgKiBvbmVPdmVyTWVyY2F0b3JIZWlnaHQ7CiAgICAgICAgfQogICAgICAgIGlmIChpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgICAgY29uc3Qgbm9ybWFsMiA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zKTsKICAgICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHNbcG9pbnRPZmZzZXRdID0gbm9ybWFsMjsKICAgICAgICB9CiAgICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludCh0b0VOVSwgcG9zLCBzY3JhdGNoQ2FydGVzaWFuMjApOwogICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5taW5pbXVtQnlDb21wb25lbnQoc2NyYXRjaENhcnRlc2lhbjIwLCBtaW5pbXVtLCBtaW5pbXVtKTsKICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWF4aW11bUJ5Q29tcG9uZW50KHNjcmF0Y2hDYXJ0ZXNpYW4yMCwgbWF4aW11bSwgbWF4aW11bSk7CiAgICAgICAgbGV0IHUzID0gKGxvbmdpdHVkZSAtIGdlb2dyYXBoaWNXZXN0KSAvIChnZW9ncmFwaGljRWFzdCAtIGdlb2dyYXBoaWNXZXN0KTsKICAgICAgICB1MyA9IE1hdGhfZGVmYXVsdC5jbGFtcCh1MywgMCwgMSk7CiAgICAgICAgbGV0IHYzID0gKGxhdGl0dWRlIC0gZ2VvZ3JhcGhpY1NvdXRoKSAvIChnZW9ncmFwaGljTm9ydGggLSBnZW9ncmFwaGljU291dGgpOwogICAgICAgIHYzID0gTWF0aF9kZWZhdWx0LmNsYW1wKHYzLCAwLCAxKTsKICAgICAgICB1dnNbcG9pbnRPZmZzZXRdID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCh1MywgdjMpOwogICAgICAgICsrcG9pbnRPZmZzZXQ7CiAgICAgIH0KICAgICAgY29uc3QgZmFjZXNFbGVtZW50Q291bnQgPSBudW1GYWNlcyAqIDM7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgZmFjZXNFbGVtZW50Q291bnQ7ICsraiwgKytpbmRpY2VzT2Zmc2V0KSB7CiAgICAgICAgaW5kaWNlc1tpbmRpY2VzT2Zmc2V0XSA9IGluZGljZXNNYXBwaW5nW2R2LmdldFVpbnQxNihvZmZzZXQsIHRydWUpXTsKICAgICAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDE2OwogICAgICB9CiAgICAgIGlmIChxdWFkU2l6ZSAhPT0gb2Zmc2V0IC0gc3RhcnRRdWFkKSB7CiAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJJbnZhbGlkIHRlcnJhaW4gdGlsZS4iKTsKICAgICAgfQogICAgfQogICAgcG9zaXRpb25zLmxlbmd0aCA9IHBvaW50T2Zmc2V0OwogICAgdXZzLmxlbmd0aCA9IHBvaW50T2Zmc2V0OwogICAgaGVpZ2h0cy5sZW5ndGggPSBwb2ludE9mZnNldDsKICAgIGlmIChpbmNsdWRlV2ViTWVyY2F0b3JUKSB7CiAgICAgIHdlYk1lcmNhdG9yVHMubGVuZ3RoID0gcG9pbnRPZmZzZXQ7CiAgICB9CiAgICBpZiAoaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscy5sZW5ndGggPSBwb2ludE9mZnNldDsKICAgIH0KICAgIGNvbnN0IHZlcnRleENvdW50V2l0aG91dFNraXJ0cyA9IHBvaW50T2Zmc2V0OwogICAgY29uc3QgaW5kZXhDb3VudFdpdGhvdXRTa2lydHMgPSBpbmRpY2VzT2Zmc2V0OwogICAgY29uc3Qgc2tpcnRPcHRpb25zID0gewogICAgICBoTWluOiBtaW5IZWlnaHQsCiAgICAgIGxhc3RCb3JkZXJQb2ludDogdm9pZCAwLAogICAgICBza2lydEhlaWdodCwKICAgICAgdG9FTlUsCiAgICAgIGVsbGlwc29pZCwKICAgICAgbWluaW11bSwKICAgICAgbWF4aW11bQogICAgfTsKICAgIHdlc3RCb3JkZXIuc29ydChmdW5jdGlvbihhMywgYikgewogICAgICByZXR1cm4gYi5jYXJ0b2dyYXBoaWMubGF0aXR1ZGUgLSBhMy5jYXJ0b2dyYXBoaWMubGF0aXR1ZGU7CiAgICB9KTsKICAgIHNvdXRoQm9yZGVyLnNvcnQoZnVuY3Rpb24oYTMsIGIpIHsKICAgICAgcmV0dXJuIGEzLmNhcnRvZ3JhcGhpYy5sb25naXR1ZGUgLSBiLmNhcnRvZ3JhcGhpYy5sb25naXR1ZGU7CiAgICB9KTsKICAgIGVhc3RCb3JkZXIuc29ydChmdW5jdGlvbihhMywgYikgewogICAgICByZXR1cm4gYTMuY2FydG9ncmFwaGljLmxhdGl0dWRlIC0gYi5jYXJ0b2dyYXBoaWMubGF0aXR1ZGU7CiAgICB9KTsKICAgIG5vcnRoQm9yZGVyLnNvcnQoZnVuY3Rpb24oYTMsIGIpIHsKICAgICAgcmV0dXJuIGIuY2FydG9ncmFwaGljLmxvbmdpdHVkZSAtIGEzLmNhcnRvZ3JhcGhpYy5sb25naXR1ZGU7CiAgICB9KTsKICAgIGNvbnN0IHBlcmNlbnRhZ2UgPSAxZS01OwogICAgYWRkU2tpcnQoCiAgICAgIHBvc2l0aW9ucywKICAgICAgaGVpZ2h0cywKICAgICAgdXZzLAogICAgICB3ZWJNZXJjYXRvclRzLAogICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBpbmRpY2VzLAogICAgICBza2lydE9wdGlvbnMsCiAgICAgIHdlc3RCb3JkZXIsCiAgICAgIC1wZXJjZW50YWdlICogcmVjdGFuZ2xlV2lkdGgsCiAgICAgIHRydWUsCiAgICAgIC1wZXJjZW50YWdlICogcmVjdGFuZ2xlSGVpZ2h0CiAgICApOwogICAgYWRkU2tpcnQoCiAgICAgIHBvc2l0aW9ucywKICAgICAgaGVpZ2h0cywKICAgICAgdXZzLAogICAgICB3ZWJNZXJjYXRvclRzLAogICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBpbmRpY2VzLAogICAgICBza2lydE9wdGlvbnMsCiAgICAgIHNvdXRoQm9yZGVyLAogICAgICAtcGVyY2VudGFnZSAqIHJlY3RhbmdsZUhlaWdodCwKICAgICAgZmFsc2UKICAgICk7CiAgICBhZGRTa2lydCgKICAgICAgcG9zaXRpb25zLAogICAgICBoZWlnaHRzLAogICAgICB1dnMsCiAgICAgIHdlYk1lcmNhdG9yVHMsCiAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHMsCiAgICAgIGluZGljZXMsCiAgICAgIHNraXJ0T3B0aW9ucywKICAgICAgZWFzdEJvcmRlciwKICAgICAgcGVyY2VudGFnZSAqIHJlY3RhbmdsZVdpZHRoLAogICAgICB0cnVlLAogICAgICBwZXJjZW50YWdlICogcmVjdGFuZ2xlSGVpZ2h0CiAgICApOwogICAgYWRkU2tpcnQoCiAgICAgIHBvc2l0aW9ucywKICAgICAgaGVpZ2h0cywKICAgICAgdXZzLAogICAgICB3ZWJNZXJjYXRvclRzLAogICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBpbmRpY2VzLAogICAgICBza2lydE9wdGlvbnMsCiAgICAgIG5vcnRoQm9yZGVyLAogICAgICBwZXJjZW50YWdlICogcmVjdGFuZ2xlSGVpZ2h0LAogICAgICBmYWxzZQogICAgKTsKICAgIGlmICh3ZXN0Qm9yZGVyLmxlbmd0aCA+IDAgJiYgbm9ydGhCb3JkZXIubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBmaXJzdEJvcmRlckluZGV4ID0gd2VzdEJvcmRlclswXS5pbmRleDsKICAgICAgY29uc3QgZmlyc3RTa2lydEluZGV4ID0gdmVydGV4Q291bnRXaXRob3V0U2tpcnRzOwogICAgICBjb25zdCBsYXN0Qm9yZGVySW5kZXggPSBub3J0aEJvcmRlcltub3J0aEJvcmRlci5sZW5ndGggLSAxXS5pbmRleDsKICAgICAgY29uc3QgbGFzdFNraXJ0SW5kZXggPSBwb3NpdGlvbnMubGVuZ3RoIC0gMTsKICAgICAgaW5kaWNlcy5wdXNoKAogICAgICAgIGxhc3RCb3JkZXJJbmRleCwKICAgICAgICBsYXN0U2tpcnRJbmRleCwKICAgICAgICBmaXJzdFNraXJ0SW5kZXgsCiAgICAgICAgZmlyc3RTa2lydEluZGV4LAogICAgICAgIGZpcnN0Qm9yZGVySW5kZXgsCiAgICAgICAgbGFzdEJvcmRlckluZGV4CiAgICAgICk7CiAgICB9CiAgICBzaXplID0gcG9zaXRpb25zLmxlbmd0aDsKICAgIGNvbnN0IGJvdW5kaW5nU3BoZXJlM0QgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21Qb2ludHMocG9zaXRpb25zKTsKICAgIGxldCBvcmllbnRlZEJvdW5kaW5nQm94OwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgIG9yaWVudGVkQm91bmRpbmdCb3ggPSBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQuZnJvbVJlY3RhbmdsZSgKICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgbWluSGVpZ2h0LAogICAgICAgIG1heEhlaWdodCwKICAgICAgICBlbGxpcHNvaWQKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IG9jY2x1ZGVyID0gbmV3IEVsbGlwc29pZGFsT2NjbHVkZXJfZGVmYXVsdChlbGxpcHNvaWQpOwogICAgY29uc3Qgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UgPSBvY2NsdWRlci5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludFBvc3NpYmx5VW5kZXJFbGxpcHNvaWQoCiAgICAgIHJlbGF0aXZlVG9DZW50ZXIsCiAgICAgIHBvc2l0aW9ucywKICAgICAgbWluSGVpZ2h0CiAgICApOwogICAgY29uc3QgYWFCb3ggPSBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0KG1pbmltdW0sIG1heGltdW0sIHJlbGF0aXZlVG9DZW50ZXIpOwogICAgY29uc3QgZW5jb2RpbmcgPSBuZXcgVGVycmFpbkVuY29kaW5nX2RlZmF1bHQoCiAgICAgIHJlbGF0aXZlVG9DZW50ZXIsCiAgICAgIGFhQm94LAogICAgICBza2lydE9wdGlvbnMuaE1pbiwKICAgICAgbWF4SGVpZ2h0LAogICAgICBmcm9tRU5VLAogICAgICBmYWxzZSwKICAgICAgaW5jbHVkZVdlYk1lcmNhdG9yVCwKICAgICAgaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMsCiAgICAgIGV4YWdnZXJhdGlvbiwKICAgICAgZXhhZ2dlcmF0aW9uUmVsYXRpdmVIZWlnaHQKICAgICk7CiAgICBjb25zdCB2ZXJ0aWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSAqIGVuY29kaW5nLnN0cmlkZSk7CiAgICBsZXQgYnVmZmVySW5kZXggPSAwOwogICAgZm9yIChsZXQgayA9IDA7IGsgPCBzaXplOyArK2spIHsKICAgICAgYnVmZmVySW5kZXggPSBlbmNvZGluZy5lbmNvZGUoCiAgICAgICAgdmVydGljZXMsCiAgICAgICAgYnVmZmVySW5kZXgsCiAgICAgICAgcG9zaXRpb25zW2tdLAogICAgICAgIHV2c1trXSwKICAgICAgICBoZWlnaHRzW2tdLAogICAgICAgIHZvaWQgMCwKICAgICAgICB3ZWJNZXJjYXRvclRzW2tdLAogICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHNba10KICAgICAgKTsKICAgIH0KICAgIGNvbnN0IHdlc3RJbmRpY2VzU291dGhUb05vcnRoID0gd2VzdEJvcmRlci5tYXAoZnVuY3Rpb24odmVydGV4KSB7CiAgICAgIHJldHVybiB2ZXJ0ZXguaW5kZXg7CiAgICB9KS5yZXZlcnNlKCk7CiAgICBjb25zdCBzb3V0aEluZGljZXNFYXN0VG9XZXN0ID0gc291dGhCb3JkZXIubWFwKGZ1bmN0aW9uKHZlcnRleCkgewogICAgICByZXR1cm4gdmVydGV4LmluZGV4OwogICAgfSkucmV2ZXJzZSgpOwogICAgY29uc3QgZWFzdEluZGljZXNOb3J0aFRvU291dGggPSBlYXN0Qm9yZGVyLm1hcChmdW5jdGlvbih2ZXJ0ZXgpIHsKICAgICAgcmV0dXJuIHZlcnRleC5pbmRleDsKICAgIH0pLnJldmVyc2UoKTsKICAgIGNvbnN0IG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QgPSBub3J0aEJvcmRlci5tYXAoZnVuY3Rpb24odmVydGV4KSB7CiAgICAgIHJldHVybiB2ZXJ0ZXguaW5kZXg7CiAgICB9KS5yZXZlcnNlKCk7CiAgICBzb3V0aEluZGljZXNFYXN0VG9XZXN0LnVuc2hpZnQoCiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoW2Vhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLmxlbmd0aCAtIDFdCiAgICApOwogICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdC5wdXNoKHdlc3RJbmRpY2VzU291dGhUb05vcnRoWzBdKTsKICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QudW5zaGlmdCgKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGhbd2VzdEluZGljZXNTb3V0aFRvTm9ydGgubGVuZ3RoIC0gMV0KICAgICk7CiAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0LnB1c2goZWFzdEluZGljZXNOb3J0aFRvU291dGhbMF0pOwogICAgcmV0dXJuIHsKICAgICAgdmVydGljZXMsCiAgICAgIGluZGljZXM6IG5ldyBVaW50MTZBcnJheShpbmRpY2VzKSwKICAgICAgbWF4aW11bUhlaWdodDogbWF4SGVpZ2h0LAogICAgICBtaW5pbXVtSGVpZ2h0OiBtaW5IZWlnaHQsCiAgICAgIGVuY29kaW5nLAogICAgICBib3VuZGluZ1NwaGVyZTNELAogICAgICBvcmllbnRlZEJvdW5kaW5nQm94LAogICAgICBvY2NsdWRlZVBvaW50SW5TY2FsZWRTcGFjZSwKICAgICAgdmVydGV4Q291bnRXaXRob3V0U2tpcnRzLAogICAgICBpbmRleENvdW50V2l0aG91dFNraXJ0cywKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0CiAgICB9OwogIH0KICBmdW5jdGlvbiBhZGRTa2lydChwb3NpdGlvbnMsIGhlaWdodHMsIHV2cywgd2ViTWVyY2F0b3JUcywgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscywgaW5kaWNlcywgc2tpcnRPcHRpb25zLCBib3JkZXJQb2ludHMsIGZ1ZGdlRmFjdG9yLCBlYXN0T3JXZXN0LCBjb3JuZXJGdWRnZSkgewogICAgY29uc3QgY291bnQgPSBib3JkZXJQb2ludHMubGVuZ3RoOwogICAgZm9yIChsZXQgaiA9IDA7IGogPCBjb3VudDsgKytqKSB7CiAgICAgIGNvbnN0IGJvcmRlclBvaW50ID0gYm9yZGVyUG9pbnRzW2pdOwogICAgICBjb25zdCBib3JkZXJDYXJ0b2dyYXBoaWMgPSBib3JkZXJQb2ludC5jYXJ0b2dyYXBoaWM7CiAgICAgIGNvbnN0IGJvcmRlckluZGV4ID0gYm9yZGVyUG9pbnQuaW5kZXg7CiAgICAgIGNvbnN0IGN1cnJlbnRJbmRleCA9IHBvc2l0aW9ucy5sZW5ndGg7CiAgICAgIGNvbnN0IGxvbmdpdHVkZSA9IGJvcmRlckNhcnRvZ3JhcGhpYy5sb25naXR1ZGU7CiAgICAgIGxldCBsYXRpdHVkZSA9IGJvcmRlckNhcnRvZ3JhcGhpYy5sYXRpdHVkZTsKICAgICAgbGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQuY2xhbXAoCiAgICAgICAgbGF0aXR1ZGUsCiAgICAgICAgLU1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTywKICAgICAgICBNYXRoX2RlZmF1bHQuUElfT1ZFUl9UV08KICAgICAgKTsKICAgICAgY29uc3QgaGVpZ2h0ID0gYm9yZGVyQ2FydG9ncmFwaGljLmhlaWdodCAtIHNraXJ0T3B0aW9ucy5za2lydEhlaWdodDsKICAgICAgc2tpcnRPcHRpb25zLmhNaW4gPSBNYXRoLm1pbihza2lydE9wdGlvbnMuaE1pbiwgaGVpZ2h0KTsKICAgICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuZnJvbVJhZGlhbnMobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCBzY3JhdGNoQ2FydG9ncmFwaGljNyk7CiAgICAgIGlmIChlYXN0T3JXZXN0KSB7CiAgICAgICAgc2NyYXRjaENhcnRvZ3JhcGhpYzcubG9uZ2l0dWRlICs9IGZ1ZGdlRmFjdG9yOwogICAgICB9CiAgICAgIGlmICghZWFzdE9yV2VzdCkgewogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3LmxhdGl0dWRlICs9IGZ1ZGdlRmFjdG9yOwogICAgICB9IGVsc2UgaWYgKGogPT09IGNvdW50IC0gMSkgewogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3LmxhdGl0dWRlICs9IGNvcm5lckZ1ZGdlOwogICAgICB9IGVsc2UgaWYgKGogPT09IDApIHsKICAgICAgICBzY3JhdGNoQ2FydG9ncmFwaGljNy5sYXRpdHVkZSAtPSBjb3JuZXJGdWRnZTsKICAgICAgfQogICAgICBjb25zdCBwb3MgPSBza2lydE9wdGlvbnMuZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3CiAgICAgICk7CiAgICAgIHBvc2l0aW9ucy5wdXNoKHBvcyk7CiAgICAgIGhlaWdodHMucHVzaChoZWlnaHQpOwogICAgICB1dnMucHVzaChDYXJ0ZXNpYW4yX2RlZmF1bHQuY2xvbmUodXZzW2JvcmRlckluZGV4XSkpOwogICAgICBpZiAod2ViTWVyY2F0b3JUcy5sZW5ndGggPiAwKSB7CiAgICAgICAgd2ViTWVyY2F0b3JUcy5wdXNoKHdlYk1lcmNhdG9yVHNbYm9yZGVySW5kZXhdKTsKICAgICAgfQogICAgICBpZiAoZ2VvZGV0aWNTdXJmYWNlTm9ybWFscy5sZW5ndGggPiAwKSB7CiAgICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFscy5wdXNoKGdlb2RldGljU3VyZmFjZU5vcm1hbHNbYm9yZGVySW5kZXhdKTsKICAgICAgfQogICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHNraXJ0T3B0aW9ucy50b0VOVSwgcG9zLCBzY3JhdGNoQ2FydGVzaWFuMjApOwogICAgICBjb25zdCBtaW5pbXVtID0gc2tpcnRPcHRpb25zLm1pbmltdW07CiAgICAgIGNvbnN0IG1heGltdW0gPSBza2lydE9wdGlvbnMubWF4aW11bTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1pbmltdW1CeUNvbXBvbmVudChzY3JhdGNoQ2FydGVzaWFuMjAsIG1pbmltdW0sIG1pbmltdW0pOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWF4aW11bUJ5Q29tcG9uZW50KHNjcmF0Y2hDYXJ0ZXNpYW4yMCwgbWF4aW11bSwgbWF4aW11bSk7CiAgICAgIGNvbnN0IGxhc3RCb3JkZXJQb2ludCA9IHNraXJ0T3B0aW9ucy5sYXN0Qm9yZGVyUG9pbnQ7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobGFzdEJvcmRlclBvaW50KSkgewogICAgICAgIGNvbnN0IGxhc3RCb3JkZXJJbmRleCA9IGxhc3RCb3JkZXJQb2ludC5pbmRleDsKICAgICAgICBpbmRpY2VzLnB1c2goCiAgICAgICAgICBsYXN0Qm9yZGVySW5kZXgsCiAgICAgICAgICBjdXJyZW50SW5kZXggLSAxLAogICAgICAgICAgY3VycmVudEluZGV4LAogICAgICAgICAgY3VycmVudEluZGV4LAogICAgICAgICAgYm9yZGVySW5kZXgsCiAgICAgICAgICBsYXN0Qm9yZGVySW5kZXgKICAgICAgICApOwogICAgICB9CiAgICAgIHNraXJ0T3B0aW9ucy5sYXN0Qm9yZGVyUG9pbnQgPSBib3JkZXJQb2ludDsKICAgIH0KICB9CiAgdmFyIHNpemVPZlVpbnQxNiwgc2l6ZU9mSW50MzIsIHNpemVPZlVpbnQzMiwgc2l6ZU9mRmxvYXQsIHNpemVPZkRvdWJsZSwgc2NyYXRjaENhcnRvZ3JhcGhpYzcsIHNjcmF0Y2hDYXJ0ZXNpYW4yMCwgbWluaW11bVNjcmF0Y2gsIG1heGltdW1TY3JhdGNoLCBtYXRyaXg0U2NyYXRjaDMsIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcl9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyLmpzIigpIHsKICAgICAgaW5pdF9BeGlzQWxpZ25lZEJvdW5kaW5nQm94KCk7CiAgICAgIGluaXRfQm91bmRpbmdTcGhlcmUoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4yKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWRhbE9jY2x1ZGVyKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9PcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICAgIGluaXRfUmVjdGFuZ2xlKCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIGluaXRfVGVycmFpbkVuY29kaW5nKCk7CiAgICAgIGluaXRfVHJhbnNmb3JtcygpOwogICAgICBpbml0X1dlYk1lcmNhdG9yUHJvamVjdGlvbigpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgc2l6ZU9mVWludDE2ID0gVWludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgIHNpemVPZkludDMyID0gSW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgc2l6ZU9mVWludDMyID0gVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgIHNpemVPZkZsb2F0ID0gRmxvYXQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICBzaXplT2ZEb3VibGUgPSBGbG9hdDY0QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWM3ID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4yMCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgbWluaW11bVNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG1heGltdW1TY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBtYXRyaXg0U2NyYXRjaDMgPSBuZXcgTWF0cml4NF9kZWZhdWx0KCk7CiAgICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcl9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KAogICAgICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcgogICAgICApOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVpZ2h0bWFwRW5jb2RpbmcuanMKICB2YXIgSGVpZ2h0bWFwRW5jb2RpbmcsIEhlaWdodG1hcEVuY29kaW5nX2RlZmF1bHQ7CiAgdmFyIGluaXRfSGVpZ2h0bWFwRW5jb2RpbmcgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0hlaWdodG1hcEVuY29kaW5nLmpzIigpIHsKICAgICAgSGVpZ2h0bWFwRW5jb2RpbmcgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogTm8gZW5jb2RpbmcKICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTk9ORTogMCwKICAgICAgICAvKioKICAgICAgICAgKiBMRVJDIGVuY29kaW5nCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqCiAgICAgICAgICogQHNlZSB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL0VzcmkvbGVyY3xUaGUgTEVSQyBzcGVjaWZpY2F0aW9ufQogICAgICAgICAqLwogICAgICAgIExFUkM6IDEKICAgICAgfTsKICAgICAgSGVpZ2h0bWFwRW5jb2RpbmdfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoSGVpZ2h0bWFwRW5jb2RpbmcpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVpZ2h0bWFwVGVzc2VsbGF0b3IuanMKICB2YXIgSGVpZ2h0bWFwVGVzc2VsbGF0b3IsIGNhcnRlc2lhbjNTY3JhdGNoNywgbWF0cml4NFNjcmF0Y2g0LCBtaW5pbXVtU2NyYXRjaDIsIG1heGltdW1TY3JhdGNoMiwgSGVpZ2h0bWFwVGVzc2VsbGF0b3JfZGVmYXVsdDsKICB2YXIgaW5pdF9IZWlnaHRtYXBUZXNzZWxsYXRvciA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSGVpZ2h0bWFwVGVzc2VsbGF0b3IuanMiKCkgewogICAgICBpbml0X0F4aXNBbGlnbmVkQm91bmRpbmdCb3goKTsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkYWxPY2NsdWRlcigpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW5pdF9NYXRyaXg0KCk7CiAgICAgIGluaXRfT3JpZW50ZWRCb3VuZGluZ0JveCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1RlcnJhaW5FbmNvZGluZygpOwogICAgICBpbml0X1RyYW5zZm9ybXMoKTsKICAgICAgaW5pdF9XZWJNZXJjYXRvclByb2plY3Rpb24oKTsKICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IgPSB7fTsKICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUgPSBPYmplY3QuZnJlZXplKHsKICAgICAgICBoZWlnaHRTY2FsZTogMSwKICAgICAgICBoZWlnaHRPZmZzZXQ6IDAsCiAgICAgICAgZWxlbWVudHNQZXJIZWlnaHQ6IDEsCiAgICAgICAgc3RyaWRlOiAxLAogICAgICAgIGVsZW1lbnRNdWx0aXBsaWVyOiAyNTYsCiAgICAgICAgaXNCaWdFbmRpYW46IGZhbHNlCiAgICAgIH0pOwogICAgICBjYXJ0ZXNpYW4zU2NyYXRjaDcgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIG1hdHJpeDRTY3JhdGNoNCA9IG5ldyBNYXRyaXg0X2RlZmF1bHQoKTsKICAgICAgbWluaW11bVNjcmF0Y2gyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBtYXhpbXVtU2NyYXRjaDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIEhlaWdodG1hcFRlc3NlbGxhdG9yLmNvbXB1dGVWZXJ0aWNlcyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zKSB8fCAhZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0bWFwKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMuaGVpZ2h0bWFwIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvcHRpb25zLndpZHRoKSB8fCAhZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuaGVpZ2h0KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMud2lkdGggYW5kIG9wdGlvbnMuaGVpZ2h0IGFyZSByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQob3B0aW9ucy5uYXRpdmVSZWN0YW5nbGUpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5uYXRpdmVSZWN0YW5nbGUgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KG9wdGlvbnMuc2tpcnRIZWlnaHQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgib3B0aW9ucy5za2lydEhlaWdodCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29zNCA9IE1hdGguY29zOwogICAgICAgIGNvbnN0IHNpbjQgPSBNYXRoLnNpbjsKICAgICAgICBjb25zdCBzcXJ0MiA9IE1hdGguc3FydDsKICAgICAgICBjb25zdCBhdGFuID0gTWF0aC5hdGFuOwogICAgICAgIGNvbnN0IGV4cCA9IE1hdGguZXhwOwogICAgICAgIGNvbnN0IHBpT3ZlclR3byA9IE1hdGhfZGVmYXVsdC5QSV9PVkVSX1RXTzsKICAgICAgICBjb25zdCB0b1JhZGlhbnMgPSBNYXRoX2RlZmF1bHQudG9SYWRpYW5zOwogICAgICAgIGNvbnN0IGhlaWdodG1hcCA9IG9wdGlvbnMuaGVpZ2h0bWFwOwogICAgICAgIGNvbnN0IHdpZHRoID0gb3B0aW9ucy53aWR0aDsKICAgICAgICBjb25zdCBoZWlnaHQgPSBvcHRpb25zLmhlaWdodDsKICAgICAgICBjb25zdCBza2lydEhlaWdodCA9IG9wdGlvbnMuc2tpcnRIZWlnaHQ7CiAgICAgICAgY29uc3QgaGFzU2tpcnRzID0gc2tpcnRIZWlnaHQgPiAwOwogICAgICAgIGNvbnN0IGlzR2VvZ3JhcGhpYyA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaXNHZW9ncmFwaGljLCB0cnVlKTsKICAgICAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgICAgIGNvbnN0IG9uZU92ZXJHbG9iZVNlbWltYWpvckF4aXMgPSAxIC8gZWxsaXBzb2lkLm1heGltdW1SYWRpdXM7CiAgICAgICAgY29uc3QgbmF0aXZlUmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUob3B0aW9ucy5uYXRpdmVSZWN0YW5nbGUpOwogICAgICAgIGNvbnN0IHJlY3RhbmdsZSA9IFJlY3RhbmdsZV9kZWZhdWx0LmNsb25lKG9wdGlvbnMucmVjdGFuZ2xlKTsKICAgICAgICBsZXQgZ2VvZ3JhcGhpY1dlc3Q7CiAgICAgICAgbGV0IGdlb2dyYXBoaWNTb3V0aDsKICAgICAgICBsZXQgZ2VvZ3JhcGhpY0Vhc3Q7CiAgICAgICAgbGV0IGdlb2dyYXBoaWNOb3J0aDsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgICAgICBpZiAoaXNHZW9ncmFwaGljKSB7CiAgICAgICAgICAgIGdlb2dyYXBoaWNXZXN0ID0gdG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS53ZXN0KTsKICAgICAgICAgICAgZ2VvZ3JhcGhpY1NvdXRoID0gdG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS5zb3V0aCk7CiAgICAgICAgICAgIGdlb2dyYXBoaWNFYXN0ID0gdG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS5lYXN0KTsKICAgICAgICAgICAgZ2VvZ3JhcGhpY05vcnRoID0gdG9SYWRpYW5zKG5hdGl2ZVJlY3RhbmdsZS5ub3J0aCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnZW9ncmFwaGljV2VzdCA9IG5hdGl2ZVJlY3RhbmdsZS53ZXN0ICogb25lT3Zlckdsb2JlU2VtaW1ham9yQXhpczsKICAgICAgICAgICAgZ2VvZ3JhcGhpY1NvdXRoID0gcGlPdmVyVHdvIC0gMiAqIGF0YW4oZXhwKC1uYXRpdmVSZWN0YW5nbGUuc291dGggKiBvbmVPdmVyR2xvYmVTZW1pbWFqb3JBeGlzKSk7CiAgICAgICAgICAgIGdlb2dyYXBoaWNFYXN0ID0gbmF0aXZlUmVjdGFuZ2xlLmVhc3QgKiBvbmVPdmVyR2xvYmVTZW1pbWFqb3JBeGlzOwogICAgICAgICAgICBnZW9ncmFwaGljTm9ydGggPSBwaU92ZXJUd28gLSAyICogYXRhbihleHAoLW5hdGl2ZVJlY3RhbmdsZS5ub3J0aCAqIG9uZU92ZXJHbG9iZVNlbWltYWpvckF4aXMpKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZ2VvZ3JhcGhpY1dlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgICAgICAgIGdlb2dyYXBoaWNTb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICAgICAgICAgIGdlb2dyYXBoaWNFYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICAgICAgICBnZW9ncmFwaGljTm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgICAgICAgfQogICAgICAgIGxldCByZWxhdGl2ZVRvQ2VudGVyID0gb3B0aW9ucy5yZWxhdGl2ZVRvQ2VudGVyOwogICAgICAgIGNvbnN0IGhhc1JlbGF0aXZlVG9DZW50ZXIgPSBkZWZpbmVkX2RlZmF1bHQocmVsYXRpdmVUb0NlbnRlcik7CiAgICAgICAgcmVsYXRpdmVUb0NlbnRlciA9IGhhc1JlbGF0aXZlVG9DZW50ZXIgPyByZWxhdGl2ZVRvQ2VudGVyIDogQ2FydGVzaWFuM19kZWZhdWx0LlpFUk87CiAgICAgICAgY29uc3QgaW5jbHVkZVdlYk1lcmNhdG9yVCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuaW5jbHVkZVdlYk1lcmNhdG9yVCwgZmFsc2UpOwogICAgICAgIGNvbnN0IGV4YWdnZXJhdGlvbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KG9wdGlvbnMuZXhhZ2dlcmF0aW9uLCAxKTsKICAgICAgICBjb25zdCBleGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgb3B0aW9ucy5leGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodCwKICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIGNvbnN0IGhhc0V4YWdnZXJhdGlvbiA9IGV4YWdnZXJhdGlvbiAhPT0gMTsKICAgICAgICBjb25zdCBpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA9IGhhc0V4YWdnZXJhdGlvbjsKICAgICAgICBjb25zdCBzdHJ1Y3R1cmUgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIG9wdGlvbnMuc3RydWN0dXJlLAogICAgICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUKICAgICAgICApOwogICAgICAgIGNvbnN0IGhlaWdodFNjYWxlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBzdHJ1Y3R1cmUuaGVpZ2h0U2NhbGUsCiAgICAgICAgICBIZWlnaHRtYXBUZXNzZWxsYXRvci5ERUZBVUxUX1NUUlVDVFVSRS5oZWlnaHRTY2FsZQogICAgICAgICk7CiAgICAgICAgY29uc3QgaGVpZ2h0T2Zmc2V0ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgICAgICBzdHJ1Y3R1cmUuaGVpZ2h0T2Zmc2V0LAogICAgICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUuaGVpZ2h0T2Zmc2V0CiAgICAgICAgKTsKICAgICAgICBjb25zdCBlbGVtZW50c1BlckhlaWdodCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgc3RydWN0dXJlLmVsZW1lbnRzUGVySGVpZ2h0LAogICAgICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUuZWxlbWVudHNQZXJIZWlnaHQKICAgICAgICApOwogICAgICAgIGNvbnN0IHN0cmlkZSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgc3RydWN0dXJlLnN0cmlkZSwKICAgICAgICAgIEhlaWdodG1hcFRlc3NlbGxhdG9yLkRFRkFVTFRfU1RSVUNUVVJFLnN0cmlkZQogICAgICAgICk7CiAgICAgICAgY29uc3QgZWxlbWVudE11bHRpcGxpZXIgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdCgKICAgICAgICAgIHN0cnVjdHVyZS5lbGVtZW50TXVsdGlwbGllciwKICAgICAgICAgIEhlaWdodG1hcFRlc3NlbGxhdG9yLkRFRkFVTFRfU1RSVUNUVVJFLmVsZW1lbnRNdWx0aXBsaWVyCiAgICAgICAgKTsKICAgICAgICBjb25zdCBpc0JpZ0VuZGlhbiA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICAgICAgc3RydWN0dXJlLmlzQmlnRW5kaWFuLAogICAgICAgICAgSGVpZ2h0bWFwVGVzc2VsbGF0b3IuREVGQVVMVF9TVFJVQ1RVUkUuaXNCaWdFbmRpYW4KICAgICAgICApOwogICAgICAgIGxldCByZWN0YW5nbGVXaWR0aCA9IFJlY3RhbmdsZV9kZWZhdWx0LmNvbXB1dGVXaWR0aChuYXRpdmVSZWN0YW5nbGUpOwogICAgICAgIGxldCByZWN0YW5nbGVIZWlnaHQgPSBSZWN0YW5nbGVfZGVmYXVsdC5jb21wdXRlSGVpZ2h0KG5hdGl2ZVJlY3RhbmdsZSk7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHlYID0gcmVjdGFuZ2xlV2lkdGggLyAod2lkdGggLSAxKTsKICAgICAgICBjb25zdCBncmFudWxhcml0eVkgPSByZWN0YW5nbGVIZWlnaHQgLyAoaGVpZ2h0IC0gMSk7CiAgICAgICAgaWYgKCFpc0dlb2dyYXBoaWMpIHsKICAgICAgICAgIHJlY3RhbmdsZVdpZHRoICo9IG9uZU92ZXJHbG9iZVNlbWltYWpvckF4aXM7CiAgICAgICAgICByZWN0YW5nbGVIZWlnaHQgKj0gb25lT3Zlckdsb2JlU2VtaW1ham9yQXhpczsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmFkaWlTcXVhcmVkID0gZWxsaXBzb2lkLnJhZGlpU3F1YXJlZDsKICAgICAgICBjb25zdCByYWRpaVNxdWFyZWRYID0gcmFkaWlTcXVhcmVkLng7CiAgICAgICAgY29uc3QgcmFkaWlTcXVhcmVkWSA9IHJhZGlpU3F1YXJlZC55OwogICAgICAgIGNvbnN0IHJhZGlpU3F1YXJlZFogPSByYWRpaVNxdWFyZWQuejsKICAgICAgICBsZXQgbWluaW11bUhlaWdodCA9IDY1NTM2OwogICAgICAgIGxldCBtYXhpbXVtSGVpZ2h0ID0gLTY1NTM2OwogICAgICAgIGNvbnN0IGZyb21FTlUgPSBUcmFuc2Zvcm1zX2RlZmF1bHQuZWFzdE5vcnRoVXBUb0ZpeGVkRnJhbWUoCiAgICAgICAgICByZWxhdGl2ZVRvQ2VudGVyLAogICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0b0VOVSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oZnJvbUVOVSwgbWF0cml4NFNjcmF0Y2g0KTsKICAgICAgICBsZXQgc291dGhNZXJjYXRvclk7CiAgICAgICAgbGV0IG9uZU92ZXJNZXJjYXRvckhlaWdodDsKICAgICAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICAgICAgc291dGhNZXJjYXRvclkgPSBXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdC5nZW9kZXRpY0xhdGl0dWRlVG9NZXJjYXRvckFuZ2xlKAogICAgICAgICAgICBnZW9ncmFwaGljU291dGgKICAgICAgICAgICk7CiAgICAgICAgICBvbmVPdmVyTWVyY2F0b3JIZWlnaHQgPSAxIC8gKFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoZ2VvZ3JhcGhpY05vcnRoKSAtIHNvdXRoTWVyY2F0b3JZKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWluaW11bSA9IG1pbmltdW1TY3JhdGNoMjsKICAgICAgICBtaW5pbXVtLnggPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbWluaW11bS55ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIG1pbmltdW0ueiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICBjb25zdCBtYXhpbXVtID0gbWF4aW11bVNjcmF0Y2gyOwogICAgICAgIG1heGltdW0ueCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgICAgICBtYXhpbXVtLnkgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgICAgbWF4aW11bS56ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgICAgIGxldCBoTWluID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICAgIGNvbnN0IGdyaWRWZXJ0ZXhDb3VudCA9IHdpZHRoICogaGVpZ2h0OwogICAgICAgIGNvbnN0IGVkZ2VWZXJ0ZXhDb3VudCA9IHNraXJ0SGVpZ2h0ID4gMCA/IHdpZHRoICogMiArIGhlaWdodCAqIDIgOiAwOwogICAgICAgIGNvbnN0IHZlcnRleENvdW50ID0gZ3JpZFZlcnRleENvdW50ICsgZWRnZVZlcnRleENvdW50OwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheSh2ZXJ0ZXhDb3VudCk7CiAgICAgICAgY29uc3QgaGVpZ2h0cyA9IG5ldyBBcnJheSh2ZXJ0ZXhDb3VudCk7CiAgICAgICAgY29uc3QgdXZzID0gbmV3IEFycmF5KHZlcnRleENvdW50KTsKICAgICAgICBjb25zdCB3ZWJNZXJjYXRvclRzID0gaW5jbHVkZVdlYk1lcmNhdG9yVCA/IG5ldyBBcnJheSh2ZXJ0ZXhDb3VudCkgOiBbXTsKICAgICAgICBjb25zdCBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMgPyBuZXcgQXJyYXkodmVydGV4Q291bnQpIDogW107CiAgICAgICAgbGV0IHN0YXJ0Um93ID0gMDsKICAgICAgICBsZXQgZW5kUm93ID0gaGVpZ2h0OwogICAgICAgIGxldCBzdGFydENvbCA9IDA7CiAgICAgICAgbGV0IGVuZENvbCA9IHdpZHRoOwogICAgICAgIGlmIChoYXNTa2lydHMpIHsKICAgICAgICAgIC0tc3RhcnRSb3c7CiAgICAgICAgICArK2VuZFJvdzsKICAgICAgICAgIC0tc3RhcnRDb2w7CiAgICAgICAgICArK2VuZENvbDsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2tpcnRPZmZzZXRQZXJjZW50YWdlID0gMWUtNTsKICAgICAgICBmb3IgKGxldCByb3dJbmRleCA9IHN0YXJ0Um93OyByb3dJbmRleCA8IGVuZFJvdzsgKytyb3dJbmRleCkgewogICAgICAgICAgbGV0IHJvdyA9IHJvd0luZGV4OwogICAgICAgICAgaWYgKHJvdyA8IDApIHsKICAgICAgICAgICAgcm93ID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyb3cgPj0gaGVpZ2h0KSB7CiAgICAgICAgICAgIHJvdyA9IGhlaWdodCAtIDE7CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgbGF0aXR1ZGUgPSBuYXRpdmVSZWN0YW5nbGUubm9ydGggLSBncmFudWxhcml0eVkgKiByb3c7CiAgICAgICAgICBpZiAoIWlzR2VvZ3JhcGhpYykgewogICAgICAgICAgICBsYXRpdHVkZSA9IHBpT3ZlclR3byAtIDIgKiBhdGFuKGV4cCgtbGF0aXR1ZGUgKiBvbmVPdmVyR2xvYmVTZW1pbWFqb3JBeGlzKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsYXRpdHVkZSA9IHRvUmFkaWFucyhsYXRpdHVkZSk7CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgdjMgPSAobGF0aXR1ZGUgLSBnZW9ncmFwaGljU291dGgpIC8gKGdlb2dyYXBoaWNOb3J0aCAtIGdlb2dyYXBoaWNTb3V0aCk7CiAgICAgICAgICB2MyA9IE1hdGhfZGVmYXVsdC5jbGFtcCh2MywgMCwgMSk7CiAgICAgICAgICBjb25zdCBpc05vcnRoRWRnZSA9IHJvd0luZGV4ID09PSBzdGFydFJvdzsKICAgICAgICAgIGNvbnN0IGlzU291dGhFZGdlID0gcm93SW5kZXggPT09IGVuZFJvdyAtIDE7CiAgICAgICAgICBpZiAoc2tpcnRIZWlnaHQgPiAwKSB7CiAgICAgICAgICAgIGlmIChpc05vcnRoRWRnZSkgewogICAgICAgICAgICAgIGxhdGl0dWRlICs9IHNraXJ0T2Zmc2V0UGVyY2VudGFnZSAqIHJlY3RhbmdsZUhlaWdodDsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1NvdXRoRWRnZSkgewogICAgICAgICAgICAgIGxhdGl0dWRlIC09IHNraXJ0T2Zmc2V0UGVyY2VudGFnZSAqIHJlY3RhbmdsZUhlaWdodDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3QgY29zTGF0aXR1ZGUgPSBjb3M0KGxhdGl0dWRlKTsKICAgICAgICAgIGNvbnN0IG5aID0gc2luNChsYXRpdHVkZSk7CiAgICAgICAgICBjb25zdCBrWiA9IHJhZGlpU3F1YXJlZFogKiBuWjsKICAgICAgICAgIGxldCB3ZWJNZXJjYXRvclQ7CiAgICAgICAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICAgICAgICB3ZWJNZXJjYXRvclQgPSAoV2ViTWVyY2F0b3JQcm9qZWN0aW9uX2RlZmF1bHQuZ2VvZGV0aWNMYXRpdHVkZVRvTWVyY2F0b3JBbmdsZShsYXRpdHVkZSkgLSBzb3V0aE1lcmNhdG9yWSkgKiBvbmVPdmVyTWVyY2F0b3JIZWlnaHQ7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGxldCBjb2xJbmRleCA9IHN0YXJ0Q29sOyBjb2xJbmRleCA8IGVuZENvbDsgKytjb2xJbmRleCkgewogICAgICAgICAgICBsZXQgY29sID0gY29sSW5kZXg7CiAgICAgICAgICAgIGlmIChjb2wgPCAwKSB7CiAgICAgICAgICAgICAgY29sID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29sID49IHdpZHRoKSB7CiAgICAgICAgICAgICAgY29sID0gd2lkdGggLSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHRlcnJhaW5PZmZzZXQgPSByb3cgKiAod2lkdGggKiBzdHJpZGUpICsgY29sICogc3RyaWRlOwogICAgICAgICAgICBsZXQgaGVpZ2h0U2FtcGxlOwogICAgICAgICAgICBpZiAoZWxlbWVudHNQZXJIZWlnaHQgPT09IDEpIHsKICAgICAgICAgICAgICBoZWlnaHRTYW1wbGUgPSBoZWlnaHRtYXBbdGVycmFpbk9mZnNldF07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaGVpZ2h0U2FtcGxlID0gMDsKICAgICAgICAgICAgICBsZXQgZWxlbWVudE9mZnNldDsKICAgICAgICAgICAgICBpZiAoaXNCaWdFbmRpYW4pIHsKICAgICAgICAgICAgICAgIGZvciAoZWxlbWVudE9mZnNldCA9IDA7IGVsZW1lbnRPZmZzZXQgPCBlbGVtZW50c1BlckhlaWdodDsgKytlbGVtZW50T2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAgIGhlaWdodFNhbXBsZSA9IGhlaWdodFNhbXBsZSAqIGVsZW1lbnRNdWx0aXBsaWVyICsgaGVpZ2h0bWFwW3RlcnJhaW5PZmZzZXQgKyBlbGVtZW50T2Zmc2V0XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yIChlbGVtZW50T2Zmc2V0ID0gZWxlbWVudHNQZXJIZWlnaHQgLSAxOyBlbGVtZW50T2Zmc2V0ID49IDA7IC0tZWxlbWVudE9mZnNldCkgewogICAgICAgICAgICAgICAgICBoZWlnaHRTYW1wbGUgPSBoZWlnaHRTYW1wbGUgKiBlbGVtZW50TXVsdGlwbGllciArIGhlaWdodG1hcFt0ZXJyYWluT2Zmc2V0ICsgZWxlbWVudE9mZnNldF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGhlaWdodFNhbXBsZSA9IGhlaWdodFNhbXBsZSAqIGhlaWdodFNjYWxlICsgaGVpZ2h0T2Zmc2V0OwogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0ID0gTWF0aC5tYXgobWF4aW11bUhlaWdodCwgaGVpZ2h0U2FtcGxlKTsKICAgICAgICAgICAgbWluaW11bUhlaWdodCA9IE1hdGgubWluKG1pbmltdW1IZWlnaHQsIGhlaWdodFNhbXBsZSk7CiAgICAgICAgICAgIGxldCBsb25naXR1ZGUgPSBuYXRpdmVSZWN0YW5nbGUud2VzdCArIGdyYW51bGFyaXR5WCAqIGNvbDsKICAgICAgICAgICAgaWYgKCFpc0dlb2dyYXBoaWMpIHsKICAgICAgICAgICAgICBsb25naXR1ZGUgPSBsb25naXR1ZGUgKiBvbmVPdmVyR2xvYmVTZW1pbWFqb3JBeGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxvbmdpdHVkZSA9IHRvUmFkaWFucyhsb25naXR1ZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCB1MyA9IChsb25naXR1ZGUgLSBnZW9ncmFwaGljV2VzdCkgLyAoZ2VvZ3JhcGhpY0Vhc3QgLSBnZW9ncmFwaGljV2VzdCk7CiAgICAgICAgICAgIHUzID0gTWF0aF9kZWZhdWx0LmNsYW1wKHUzLCAwLCAxKTsKICAgICAgICAgICAgbGV0IGluZGV4ID0gcm93ICogd2lkdGggKyBjb2w7CiAgICAgICAgICAgIGlmIChza2lydEhlaWdodCA+IDApIHsKICAgICAgICAgICAgICBjb25zdCBpc1dlc3RFZGdlID0gY29sSW5kZXggPT09IHN0YXJ0Q29sOwogICAgICAgICAgICAgIGNvbnN0IGlzRWFzdEVkZ2UgPSBjb2xJbmRleCA9PT0gZW5kQ29sIC0gMTsKICAgICAgICAgICAgICBjb25zdCBpc0VkZ2UyID0gaXNOb3J0aEVkZ2UgfHwgaXNTb3V0aEVkZ2UgfHwgaXNXZXN0RWRnZSB8fCBpc0Vhc3RFZGdlOwogICAgICAgICAgICAgIGNvbnN0IGlzQ29ybmVyID0gKGlzTm9ydGhFZGdlIHx8IGlzU291dGhFZGdlKSAmJiAoaXNXZXN0RWRnZSB8fCBpc0Vhc3RFZGdlKTsKICAgICAgICAgICAgICBpZiAoaXNDb3JuZXIpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFZGdlMikgewogICAgICAgICAgICAgICAgaGVpZ2h0U2FtcGxlIC09IHNraXJ0SGVpZ2h0OwogICAgICAgICAgICAgICAgaWYgKGlzV2VzdEVkZ2UpIHsKICAgICAgICAgICAgICAgICAgaW5kZXggPSBncmlkVmVydGV4Q291bnQgKyAoaGVpZ2h0IC0gcm93IC0gMSk7CiAgICAgICAgICAgICAgICAgIGxvbmdpdHVkZSAtPSBza2lydE9mZnNldFBlcmNlbnRhZ2UgKiByZWN0YW5nbGVXaWR0aDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNTb3V0aEVkZ2UpIHsKICAgICAgICAgICAgICAgICAgaW5kZXggPSBncmlkVmVydGV4Q291bnQgKyBoZWlnaHQgKyAod2lkdGggLSBjb2wgLSAxKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNFYXN0RWRnZSkgewogICAgICAgICAgICAgICAgICBpbmRleCA9IGdyaWRWZXJ0ZXhDb3VudCArIGhlaWdodCArIHdpZHRoICsgcm93OwogICAgICAgICAgICAgICAgICBsb25naXR1ZGUgKz0gc2tpcnRPZmZzZXRQZXJjZW50YWdlICogcmVjdGFuZ2xlV2lkdGg7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzTm9ydGhFZGdlKSB7CiAgICAgICAgICAgICAgICAgIGluZGV4ID0gZ3JpZFZlcnRleENvdW50ICsgaGVpZ2h0ICsgd2lkdGggKyBoZWlnaHQgKyBjb2w7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IG5YID0gY29zTGF0aXR1ZGUgKiBjb3M0KGxvbmdpdHVkZSk7CiAgICAgICAgICAgIGNvbnN0IG5ZID0gY29zTGF0aXR1ZGUgKiBzaW40KGxvbmdpdHVkZSk7CiAgICAgICAgICAgIGNvbnN0IGtYID0gcmFkaWlTcXVhcmVkWCAqIG5YOwogICAgICAgICAgICBjb25zdCBrWSA9IHJhZGlpU3F1YXJlZFkgKiBuWTsKICAgICAgICAgICAgY29uc3QgZ2FtbWEgPSBzcXJ0MihrWCAqIG5YICsga1kgKiBuWSArIGtaICogblopOwogICAgICAgICAgICBjb25zdCBvbmVPdmVyR2FtbWEgPSAxIC8gZ2FtbWE7CiAgICAgICAgICAgIGNvbnN0IHJTdXJmYWNlWCA9IGtYICogb25lT3ZlckdhbW1hOwogICAgICAgICAgICBjb25zdCByU3VyZmFjZVkgPSBrWSAqIG9uZU92ZXJHYW1tYTsKICAgICAgICAgICAgY29uc3QgclN1cmZhY2VaID0ga1ogKiBvbmVPdmVyR2FtbWE7CiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9uID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICAgICAgICBwb3NpdGlvbi54ID0gclN1cmZhY2VYICsgblggKiBoZWlnaHRTYW1wbGU7CiAgICAgICAgICAgIHBvc2l0aW9uLnkgPSByU3VyZmFjZVkgKyBuWSAqIGhlaWdodFNhbXBsZTsKICAgICAgICAgICAgcG9zaXRpb24ueiA9IHJTdXJmYWNlWiArIG5aICogaGVpZ2h0U2FtcGxlOwogICAgICAgICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHRvRU5VLCBwb3NpdGlvbiwgY2FydGVzaWFuM1NjcmF0Y2g3KTsKICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1pbmltdW1CeUNvbXBvbmVudChjYXJ0ZXNpYW4zU2NyYXRjaDcsIG1pbmltdW0sIG1pbmltdW0pOwogICAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWF4aW11bUJ5Q29tcG9uZW50KGNhcnRlc2lhbjNTY3JhdGNoNywgbWF4aW11bSwgbWF4aW11bSk7CiAgICAgICAgICAgIGhNaW4gPSBNYXRoLm1pbihoTWluLCBoZWlnaHRTYW1wbGUpOwogICAgICAgICAgICBwb3NpdGlvbnNbaW5kZXhdID0gcG9zaXRpb247CiAgICAgICAgICAgIHV2c1tpbmRleF0gPSBuZXcgQ2FydGVzaWFuMl9kZWZhdWx0KHUzLCB2Myk7CiAgICAgICAgICAgIGhlaWdodHNbaW5kZXhdID0gaGVpZ2h0U2FtcGxlOwogICAgICAgICAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICAgICAgICAgIHdlYk1lcmNhdG9yVHNbaW5kZXhdID0gd2ViTWVyY2F0b3JUOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHNbaW5kZXhdID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbCgKICAgICAgICAgICAgICAgIHBvc2l0aW9uCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBib3VuZGluZ1NwaGVyZTNEID0gQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tUG9pbnRzKHBvc2l0aW9ucyk7CiAgICAgICAgbGV0IG9yaWVudGVkQm91bmRpbmdCb3g7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZWN0YW5nbGUpKSB7CiAgICAgICAgICBvcmllbnRlZEJvdW5kaW5nQm94ID0gT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LmZyb21SZWN0YW5nbGUoCiAgICAgICAgICAgIHJlY3RhbmdsZSwKICAgICAgICAgICAgbWluaW11bUhlaWdodCwKICAgICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgICAgZWxsaXBzb2lkCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBsZXQgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2U7CiAgICAgICAgaWYgKGhhc1JlbGF0aXZlVG9DZW50ZXIpIHsKICAgICAgICAgIGNvbnN0IG9jY2x1ZGVyID0gbmV3IEVsbGlwc29pZGFsT2NjbHVkZXJfZGVmYXVsdChlbGxpcHNvaWQpOwogICAgICAgICAgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UgPSBvY2NsdWRlci5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludFBvc3NpYmx5VW5kZXJFbGxpcHNvaWQoCiAgICAgICAgICAgIHJlbGF0aXZlVG9DZW50ZXIsCiAgICAgICAgICAgIHBvc2l0aW9ucywKICAgICAgICAgICAgbWluaW11bUhlaWdodAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYWFCb3ggPSBuZXcgQXhpc0FsaWduZWRCb3VuZGluZ0JveF9kZWZhdWx0KG1pbmltdW0sIG1heGltdW0sIHJlbGF0aXZlVG9DZW50ZXIpOwogICAgICAgIGNvbnN0IGVuY29kaW5nID0gbmV3IFRlcnJhaW5FbmNvZGluZ19kZWZhdWx0KAogICAgICAgICAgcmVsYXRpdmVUb0NlbnRlciwKICAgICAgICAgIGFhQm94LAogICAgICAgICAgaE1pbiwKICAgICAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgICAgICBmcm9tRU5VLAogICAgICAgICAgZmFsc2UsCiAgICAgICAgICBpbmNsdWRlV2ViTWVyY2F0b3JULAogICAgICAgICAgaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMsCiAgICAgICAgICBleGFnZ2VyYXRpb24sCiAgICAgICAgICBleGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodAogICAgICAgICk7CiAgICAgICAgY29uc3QgdmVydGljZXMgPSBuZXcgRmxvYXQzMkFycmF5KHZlcnRleENvdW50ICogZW5jb2Rpbmcuc3RyaWRlKTsKICAgICAgICBsZXQgYnVmZmVySW5kZXggPSAwOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdmVydGV4Q291bnQ7ICsraikgewogICAgICAgICAgYnVmZmVySW5kZXggPSBlbmNvZGluZy5lbmNvZGUoCiAgICAgICAgICAgIHZlcnRpY2VzLAogICAgICAgICAgICBidWZmZXJJbmRleCwKICAgICAgICAgICAgcG9zaXRpb25zW2pdLAogICAgICAgICAgICB1dnNbal0sCiAgICAgICAgICAgIGhlaWdodHNbal0sCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgd2ViTWVyY2F0b3JUc1tqXSwKICAgICAgICAgICAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFsc1tqXQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHZlcnRpY2VzLAogICAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgICAgICBlbmNvZGluZywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlM0QsCiAgICAgICAgICBvcmllbnRlZEJvdW5kaW5nQm94LAogICAgICAgICAgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UKICAgICAgICB9OwogICAgICB9OwogICAgICBIZWlnaHRtYXBUZXNzZWxsYXRvcl9kZWZhdWx0ID0gSGVpZ2h0bWFwVGVzc2VsbGF0b3I7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9sZXJjL0xlcmNEZWNvZGUuanMKICB2YXIgcmVxdWlyZV9MZXJjRGVjb2RlID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL2xlcmMvTGVyY0RlY29kZS5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAvKiBDb3B5cmlnaHQgMjAxNS0yMDE4IEVzcmkuIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdCBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAgQHByZXNlcnZlICovCiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgTGVyY0RlY29kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIENudFpJbWFnZSA9IHt9OwogICAgICAgICAgQ250WkltYWdlLmRlZmF1bHROb0RhdGFWYWx1ZSA9IC0zNDAyNzk5OTM4NzkwMTQ4NGUyMjsKICAgICAgICAgIENudFpJbWFnZS5kZWNvZGUgPSBmdW5jdGlvbihpbnB1dCwgb3B0aW9ucykgewogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgdmFyIHNraXBNYXNrID0gb3B0aW9ucy5lbmNvZGVkTWFza0RhdGEgfHwgb3B0aW9ucy5lbmNvZGVkTWFza0RhdGEgPT09IG51bGw7CiAgICAgICAgICAgIHZhciBwYXJzZWREYXRhID0gcGFyc2UoaW5wdXQsIG9wdGlvbnMuaW5wdXRPZmZzZXQgfHwgMCwgc2tpcE1hc2spOwogICAgICAgICAgICB2YXIgbm9EYXRhVmFsdWUgPSBvcHRpb25zLm5vRGF0YVZhbHVlICE9PSBudWxsID8gb3B0aW9ucy5ub0RhdGFWYWx1ZSA6IENudFpJbWFnZS5kZWZhdWx0Tm9EYXRhVmFsdWU7CiAgICAgICAgICAgIHZhciB1bmNvbXByZXNzZWREYXRhID0gdW5jb21wcmVzc1BpeGVsVmFsdWVzKAogICAgICAgICAgICAgIHBhcnNlZERhdGEsCiAgICAgICAgICAgICAgb3B0aW9ucy5waXhlbFR5cGUgfHwgRmxvYXQzMkFycmF5LAogICAgICAgICAgICAgIG9wdGlvbnMuZW5jb2RlZE1hc2tEYXRhLAogICAgICAgICAgICAgIG5vRGF0YVZhbHVlLAogICAgICAgICAgICAgIG9wdGlvbnMucmV0dXJuTWFzawogICAgICAgICAgICApOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgICAgIHdpZHRoOiBwYXJzZWREYXRhLndpZHRoLAogICAgICAgICAgICAgIGhlaWdodDogcGFyc2VkRGF0YS5oZWlnaHQsCiAgICAgICAgICAgICAgcGl4ZWxEYXRhOiB1bmNvbXByZXNzZWREYXRhLnJlc3VsdFBpeGVscywKICAgICAgICAgICAgICBtaW5WYWx1ZTogdW5jb21wcmVzc2VkRGF0YS5taW5WYWx1ZSwKICAgICAgICAgICAgICBtYXhWYWx1ZTogcGFyc2VkRGF0YS5waXhlbHMubWF4VmFsdWUsCiAgICAgICAgICAgICAgbm9EYXRhVmFsdWUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHVuY29tcHJlc3NlZERhdGEucmVzdWx0TWFzaykgewogICAgICAgICAgICAgIHJlc3VsdC5tYXNrRGF0YSA9IHVuY29tcHJlc3NlZERhdGEucmVzdWx0TWFzazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9ucy5yZXR1cm5FbmNvZGVkTWFzayAmJiBwYXJzZWREYXRhLm1hc2spIHsKICAgICAgICAgICAgICByZXN1bHQuZW5jb2RlZE1hc2tEYXRhID0gcGFyc2VkRGF0YS5tYXNrLmJpdHNldCA/IHBhcnNlZERhdGEubWFzay5iaXRzZXQgOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zLnJldHVybkZpbGVJbmZvKSB7CiAgICAgICAgICAgICAgcmVzdWx0LmZpbGVJbmZvID0gZm9ybWF0RmlsZUluZm8ocGFyc2VkRGF0YSk7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29tcHV0ZVVzZWRCaXREZXB0aHMpIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5maWxlSW5mby5iaXREZXB0aHMgPSBjb21wdXRlVXNlZEJpdERlcHRocyhwYXJzZWREYXRhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgdW5jb21wcmVzc1BpeGVsVmFsdWVzID0gZnVuY3Rpb24oZGF0YSwgVHlwZWRBcnJheUNsYXNzLCBtYXNrQml0c2V0LCBub0RhdGFWYWx1ZSwgc3RvcmVEZWNvZGVkTWFzaykgewogICAgICAgICAgICB2YXIgYmxvY2tJZHggPSAwOwogICAgICAgICAgICB2YXIgbnVtWCA9IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1g7CiAgICAgICAgICAgIHZhciBudW1ZID0gZGF0YS5waXhlbHMubnVtQmxvY2tzWTsKICAgICAgICAgICAgdmFyIGJsb2NrV2lkdGggPSBNYXRoLmZsb29yKGRhdGEud2lkdGggLyBudW1YKTsKICAgICAgICAgICAgdmFyIGJsb2NrSGVpZ2h0ID0gTWF0aC5mbG9vcihkYXRhLmhlaWdodCAvIG51bVkpOwogICAgICAgICAgICB2YXIgc2NhbGUgPSAyICogZGF0YS5tYXhaRXJyb3I7CiAgICAgICAgICAgIHZhciBtaW5WYWx1ZSA9IE51bWJlci5NQVhfVkFMVUUsIGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgbWFza0JpdHNldCA9IG1hc2tCaXRzZXQgfHwgKGRhdGEubWFzayA/IGRhdGEubWFzay5iaXRzZXQgOiBudWxsKTsKICAgICAgICAgICAgdmFyIHJlc3VsdFBpeGVscywgcmVzdWx0TWFzazsKICAgICAgICAgICAgcmVzdWx0UGl4ZWxzID0gbmV3IFR5cGVkQXJyYXlDbGFzcyhkYXRhLndpZHRoICogZGF0YS5oZWlnaHQpOwogICAgICAgICAgICBpZiAoc3RvcmVEZWNvZGVkTWFzayAmJiBtYXNrQml0c2V0KSB7CiAgICAgICAgICAgICAgcmVzdWx0TWFzayA9IG5ldyBVaW50OEFycmF5KGRhdGEud2lkdGggKiBkYXRhLmhlaWdodCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGJsb2NrRGF0YUJ1ZmZlciA9IG5ldyBGbG9hdDMyQXJyYXkoYmxvY2tXaWR0aCAqIGJsb2NrSGVpZ2h0KTsKICAgICAgICAgICAgdmFyIHh4LCB5eTsKICAgICAgICAgICAgZm9yICh2YXIgeSA9IDA7IHkgPD0gbnVtWTsgeSsrKSB7CiAgICAgICAgICAgICAgdmFyIHRoaXNCbG9ja0hlaWdodCA9IHkgIT09IG51bVkgPyBibG9ja0hlaWdodCA6IGRhdGEuaGVpZ2h0ICUgbnVtWTsKICAgICAgICAgICAgICBpZiAodGhpc0Jsb2NrSGVpZ2h0ID09PSAwKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPD0gbnVtWDsgeCsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhpc0Jsb2NrV2lkdGggPSB4ICE9PSBudW1YID8gYmxvY2tXaWR0aCA6IGRhdGEud2lkdGggJSBudW1YOwogICAgICAgICAgICAgICAgaWYgKHRoaXNCbG9ja1dpZHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG91dFB0ciA9IHkgKiBkYXRhLndpZHRoICogYmxvY2tIZWlnaHQgKyB4ICogYmxvY2tXaWR0aDsKICAgICAgICAgICAgICAgIHZhciBvdXRTdHJpZGUgPSBkYXRhLndpZHRoIC0gdGhpc0Jsb2NrV2lkdGg7CiAgICAgICAgICAgICAgICB2YXIgYmxvY2sgPSBkYXRhLnBpeGVscy5ibG9ja3NbYmxvY2tJZHhdOwogICAgICAgICAgICAgICAgdmFyIGJsb2NrRGF0YSwgYmxvY2tQdHIsIGNvbnN0VmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPCAyKSB7CiAgICAgICAgICAgICAgICAgIGlmIChibG9jay5lbmNvZGluZyA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJsb2NrRGF0YSA9IGJsb2NrLnJhd0RhdGE7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdW5zdHVmZihibG9jay5zdHVmZmVkRGF0YSwgYmxvY2suYml0c1BlclBpeGVsLCBibG9jay5udW1WYWxpZFBpeGVscywgYmxvY2sub2Zmc2V0LCBzY2FsZSwgYmxvY2tEYXRhQnVmZmVyLCBkYXRhLnBpeGVscy5tYXhWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgYmxvY2tEYXRhID0gYmxvY2tEYXRhQnVmZmVyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJsb2NrUHRyID0gMDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgY29uc3RWYWx1ZSA9IDA7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb25zdFZhbHVlID0gYmxvY2sub2Zmc2V0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG1hc2tCeXRlOwogICAgICAgICAgICAgICAgaWYgKG1hc2tCaXRzZXQpIHsKICAgICAgICAgICAgICAgICAgZm9yICh5eSA9IDA7IHl5IDwgdGhpc0Jsb2NrSGVpZ2h0OyB5eSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG91dFB0ciAmIDcpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hc2tCeXRlID0gbWFza0JpdHNldFtvdXRQdHIgPj4gM107CiAgICAgICAgICAgICAgICAgICAgICBtYXNrQnl0ZSA8PD0gb3V0UHRyICYgNzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yICh4eCA9IDA7IHh4IDwgdGhpc0Jsb2NrV2lkdGg7IHh4KyspIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghKG91dFB0ciAmIDcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hc2tCeXRlID0gbWFza0JpdHNldFtvdXRQdHIgPj4gM107CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAobWFza0J5dGUgJiAxMjgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdE1hc2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRNYXNrW291dFB0cl0gPSAxOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGJsb2NrLmVuY29kaW5nIDwgMiA/IGJsb2NrRGF0YVtibG9ja1B0cisrXSA6IGNvbnN0VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIG1pblZhbHVlID0gbWluVmFsdWUgPiBjdXJyZW50VmFsdWUgPyBjdXJyZW50VmFsdWUgOiBtaW5WYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW291dFB0cisrXSA9IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHRNYXNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0TWFza1tvdXRQdHJdID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNbb3V0UHRyKytdID0gbm9EYXRhVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBtYXNrQnl0ZSA8PD0gMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKGJsb2NrLmVuY29kaW5nIDwgMikgewogICAgICAgICAgICAgICAgICAgIGZvciAoeXkgPSAwOyB5eSA8IHRoaXNCbG9ja0hlaWdodDsgeXkrKykgewogICAgICAgICAgICAgICAgICAgICAgZm9yICh4eCA9IDA7IHh4IDwgdGhpc0Jsb2NrV2lkdGg7IHh4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gYmxvY2tEYXRhW2Jsb2NrUHRyKytdOwogICAgICAgICAgICAgICAgICAgICAgICBtaW5WYWx1ZSA9IG1pblZhbHVlID4gY3VycmVudFZhbHVlID8gY3VycmVudFZhbHVlIDogbWluVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHIrK10gPSBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBvdXRQdHIgKz0gb3V0U3RyaWRlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtaW5WYWx1ZSA9IG1pblZhbHVlID4gY29uc3RWYWx1ZSA/IGNvbnN0VmFsdWUgOiBtaW5WYWx1ZTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHl5ID0gMDsgeXkgPCB0aGlzQmxvY2tIZWlnaHQ7IHl5KyspIHsKICAgICAgICAgICAgICAgICAgICAgIGZvciAoeHggPSAwOyB4eCA8IHRoaXNCbG9ja1dpZHRoOyB4eCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHIrK10gPSBjb25zdFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChibG9jay5lbmNvZGluZyA9PT0gMSAmJiBibG9ja1B0ciAhPT0gYmxvY2subnVtVmFsaWRQaXhlbHMpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgIkJsb2NrIGFuZCBNYXNrIGRvIG5vdCBtYXRjaCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBibG9ja0lkeCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHJlc3VsdFBpeGVscywKICAgICAgICAgICAgICByZXN1bHRNYXNrLAogICAgICAgICAgICAgIG1pblZhbHVlCiAgICAgICAgICAgIH07CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGZvcm1hdEZpbGVJbmZvID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICJmaWxlSWRlbnRpZmllclN0cmluZyI6IGRhdGEuZmlsZUlkZW50aWZpZXJTdHJpbmcsCiAgICAgICAgICAgICAgImZpbGVWZXJzaW9uIjogZGF0YS5maWxlVmVyc2lvbiwKICAgICAgICAgICAgICAiaW1hZ2VUeXBlIjogZGF0YS5pbWFnZVR5cGUsCiAgICAgICAgICAgICAgImhlaWdodCI6IGRhdGEuaGVpZ2h0LAogICAgICAgICAgICAgICJ3aWR0aCI6IGRhdGEud2lkdGgsCiAgICAgICAgICAgICAgIm1heFpFcnJvciI6IGRhdGEubWF4WkVycm9yLAogICAgICAgICAgICAgICJlb2ZPZmZzZXQiOiBkYXRhLmVvZk9mZnNldCwKICAgICAgICAgICAgICAibWFzayI6IGRhdGEubWFzayA/IHsKICAgICAgICAgICAgICAgICJudW1CbG9ja3NYIjogZGF0YS5tYXNrLm51bUJsb2Nrc1gsCiAgICAgICAgICAgICAgICAibnVtQmxvY2tzWSI6IGRhdGEubWFzay5udW1CbG9ja3NZLAogICAgICAgICAgICAgICAgIm51bUJ5dGVzIjogZGF0YS5tYXNrLm51bUJ5dGVzLAogICAgICAgICAgICAgICAgIm1heFZhbHVlIjogZGF0YS5tYXNrLm1heFZhbHVlCiAgICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgICAgInBpeGVscyI6IHsKICAgICAgICAgICAgICAgICJudW1CbG9ja3NYIjogZGF0YS5waXhlbHMubnVtQmxvY2tzWCwKICAgICAgICAgICAgICAgICJudW1CbG9ja3NZIjogZGF0YS5waXhlbHMubnVtQmxvY2tzWSwKICAgICAgICAgICAgICAgICJudW1CeXRlcyI6IGRhdGEucGl4ZWxzLm51bUJ5dGVzLAogICAgICAgICAgICAgICAgIm1heFZhbHVlIjogZGF0YS5waXhlbHMubWF4VmFsdWUsCiAgICAgICAgICAgICAgICAibm9EYXRhVmFsdWUiOiBkYXRhLm5vRGF0YVZhbHVlCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb21wdXRlVXNlZEJpdERlcHRocyA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgdmFyIG51bUJsb2NrcyA9IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1ggKiBkYXRhLnBpeGVscy5udW1CbG9ja3NZOwogICAgICAgICAgICB2YXIgYml0RGVwdGhzID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbnVtQmxvY2tzOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgYmxvY2sgPSBkYXRhLnBpeGVscy5ibG9ja3NbaV07CiAgICAgICAgICAgICAgaWYgKGJsb2NrLmVuY29kaW5nID09PSAwKSB7CiAgICAgICAgICAgICAgICBiaXREZXB0aHMuZmxvYXQzMiA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChibG9jay5lbmNvZGluZyA9PT0gMSkgewogICAgICAgICAgICAgICAgYml0RGVwdGhzW2Jsb2NrLmJpdHNQZXJQaXhlbF0gPSB0cnVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBiaXREZXB0aHNbMF0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMoYml0RGVwdGhzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGFyc2UgPSBmdW5jdGlvbihpbnB1dCwgZnAsIHNraXBNYXNrKSB7CiAgICAgICAgICAgIHZhciBkYXRhID0ge307CiAgICAgICAgICAgIHZhciBmaWxlSWRWaWV3ID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXQsIGZwLCAxMCk7CiAgICAgICAgICAgIGRhdGEuZmlsZUlkZW50aWZpZXJTdHJpbmcgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGZpbGVJZFZpZXcpOwogICAgICAgICAgICBpZiAoZGF0YS5maWxlSWRlbnRpZmllclN0cmluZy50cmltKCkgIT09ICJDbnRaSW1hZ2UiKSB7CiAgICAgICAgICAgICAgdGhyb3cgIlVuZXhwZWN0ZWQgZmlsZSBpZGVudGlmaWVyIHN0cmluZzogIiArIGRhdGEuZmlsZUlkZW50aWZpZXJTdHJpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnAgKz0gMTA7CiAgICAgICAgICAgIHZhciB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBmcCwgMjQpOwogICAgICAgICAgICBkYXRhLmZpbGVWZXJzaW9uID0gdmlldy5nZXRJbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgZGF0YS5pbWFnZVR5cGUgPSB2aWV3LmdldEludDMyKDQsIHRydWUpOwogICAgICAgICAgICBkYXRhLmhlaWdodCA9IHZpZXcuZ2V0VWludDMyKDgsIHRydWUpOwogICAgICAgICAgICBkYXRhLndpZHRoID0gdmlldy5nZXRVaW50MzIoMTIsIHRydWUpOwogICAgICAgICAgICBkYXRhLm1heFpFcnJvciA9IHZpZXcuZ2V0RmxvYXQ2NCgxNiwgdHJ1ZSk7CiAgICAgICAgICAgIGZwICs9IDI0OwogICAgICAgICAgICBpZiAoIXNraXBNYXNrKSB7CiAgICAgICAgICAgICAgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZnAsIDE2KTsKICAgICAgICAgICAgICBkYXRhLm1hc2sgPSB7fTsKICAgICAgICAgICAgICBkYXRhLm1hc2subnVtQmxvY2tzWSA9IHZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgICAgICAgIGRhdGEubWFzay5udW1CbG9ja3NYID0gdmlldy5nZXRVaW50MzIoNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgZGF0YS5tYXNrLm51bUJ5dGVzID0gdmlldy5nZXRVaW50MzIoOCwgdHJ1ZSk7CiAgICAgICAgICAgICAgZGF0YS5tYXNrLm1heFZhbHVlID0gdmlldy5nZXRGbG9hdDMyKDEyLCB0cnVlKTsKICAgICAgICAgICAgICBmcCArPSAxNjsKICAgICAgICAgICAgICBpZiAoZGF0YS5tYXNrLm51bUJ5dGVzID4gMCkgewogICAgICAgICAgICAgICAgdmFyIGJpdHNldCA9IG5ldyBVaW50OEFycmF5KE1hdGguY2VpbChkYXRhLndpZHRoICogZGF0YS5oZWlnaHQgLyA4KSk7CiAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBmcCwgZGF0YS5tYXNrLm51bUJ5dGVzKTsKICAgICAgICAgICAgICAgIHZhciBjbnQgPSB2aWV3LmdldEludDE2KDAsIHRydWUpOwogICAgICAgICAgICAgICAgdmFyIGlwID0gMiwgb3AgPSAwOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICBpZiAoY250ID4gMCkgewogICAgICAgICAgICAgICAgICAgIHdoaWxlIChjbnQtLSkgewogICAgICAgICAgICAgICAgICAgICAgYml0c2V0W29wKytdID0gdmlldy5nZXRVaW50OChpcCsrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IHZpZXcuZ2V0VWludDgoaXArKyk7CiAgICAgICAgICAgICAgICAgICAgY250ID0gLWNudDsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY250LS0pIHsKICAgICAgICAgICAgICAgICAgICAgIGJpdHNldFtvcCsrXSA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY250ID0gdmlldy5nZXRJbnQxNihpcCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGlwICs9IDI7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChpcCA8IGRhdGEubWFzay5udW1CeXRlcyk7CiAgICAgICAgICAgICAgICBpZiAoY250ICE9PSAtMzI3NjggfHwgb3AgPCBiaXRzZXQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHRocm93ICJVbmV4cGVjdGVkIGVuZCBvZiBtYXNrIFJMRSBlbmNvZGluZyI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkYXRhLm1hc2suYml0c2V0ID0gYml0c2V0OwogICAgICAgICAgICAgICAgZnAgKz0gZGF0YS5tYXNrLm51bUJ5dGVzOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGRhdGEubWFzay5udW1CeXRlcyB8IGRhdGEubWFzay5udW1CbG9ja3NZIHwgZGF0YS5tYXNrLm1heFZhbHVlKSA9PT0gMCkgewogICAgICAgICAgICAgICAgZGF0YS5tYXNrLmJpdHNldCA9IG5ldyBVaW50OEFycmF5KE1hdGguY2VpbChkYXRhLndpZHRoICogZGF0YS5oZWlnaHQgLyA4KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZpZXcgPSBuZXcgRGF0YVZpZXcoaW5wdXQsIGZwLCAxNik7CiAgICAgICAgICAgIGRhdGEucGl4ZWxzID0ge307CiAgICAgICAgICAgIGRhdGEucGl4ZWxzLm51bUJsb2Nrc1kgPSB2aWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgZGF0YS5waXhlbHMubnVtQmxvY2tzWCA9IHZpZXcuZ2V0VWludDMyKDQsIHRydWUpOwogICAgICAgICAgICBkYXRhLnBpeGVscy5udW1CeXRlcyA9IHZpZXcuZ2V0VWludDMyKDgsIHRydWUpOwogICAgICAgICAgICBkYXRhLnBpeGVscy5tYXhWYWx1ZSA9IHZpZXcuZ2V0RmxvYXQzMigxMiwgdHJ1ZSk7CiAgICAgICAgICAgIGZwICs9IDE2OwogICAgICAgICAgICB2YXIgbnVtQmxvY2tzWCA9IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1g7CiAgICAgICAgICAgIHZhciBudW1CbG9ja3NZID0gZGF0YS5waXhlbHMubnVtQmxvY2tzWTsKICAgICAgICAgICAgdmFyIGFjdHVhbE51bUJsb2Nrc1ggPSBudW1CbG9ja3NYICsgKGRhdGEud2lkdGggJSBudW1CbG9ja3NYID4gMCA/IDEgOiAwKTsKICAgICAgICAgICAgdmFyIGFjdHVhbE51bUJsb2Nrc1kgPSBudW1CbG9ja3NZICsgKGRhdGEuaGVpZ2h0ICUgbnVtQmxvY2tzWSA+IDAgPyAxIDogMCk7CiAgICAgICAgICAgIGRhdGEucGl4ZWxzLmJsb2NrcyA9IG5ldyBBcnJheShhY3R1YWxOdW1CbG9ja3NYICogYWN0dWFsTnVtQmxvY2tzWSk7CiAgICAgICAgICAgIHZhciBibG9ja0kgPSAwOwogICAgICAgICAgICBmb3IgKHZhciBibG9ja1kgPSAwOyBibG9ja1kgPCBhY3R1YWxOdW1CbG9ja3NZOyBibG9ja1krKykgewogICAgICAgICAgICAgIGZvciAodmFyIGJsb2NrWCA9IDA7IGJsb2NrWCA8IGFjdHVhbE51bUJsb2Nrc1g7IGJsb2NrWCsrKSB7CiAgICAgICAgICAgICAgICB2YXIgc2l6ZSA9IDA7CiAgICAgICAgICAgICAgICB2YXIgYnl0ZXNMZWZ0ID0gaW5wdXQuYnl0ZUxlbmd0aCAtIGZwOwogICAgICAgICAgICAgICAgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZnAsIE1hdGgubWluKDEwLCBieXRlc0xlZnQpKTsKICAgICAgICAgICAgICAgIHZhciBibG9jayA9IHt9OwogICAgICAgICAgICAgICAgZGF0YS5waXhlbHMuYmxvY2tzW2Jsb2NrSSsrXSA9IGJsb2NrOwogICAgICAgICAgICAgICAgdmFyIGhlYWRlckJ5dGUgPSB2aWV3LmdldFVpbnQ4KDApOwogICAgICAgICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgICAgICAgYmxvY2suZW5jb2RpbmcgPSBoZWFkZXJCeXRlICYgNjM7CiAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPiAzKSB7CiAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIGJsb2NrIGVuY29kaW5nICgiICsgYmxvY2suZW5jb2RpbmcgKyAiKSI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgZnArKzsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaGVhZGVyQnl0ZSAhPT0gMCAmJiBoZWFkZXJCeXRlICE9PSAyKSB7CiAgICAgICAgICAgICAgICAgIGhlYWRlckJ5dGUgPj49IDY7CiAgICAgICAgICAgICAgICAgIGJsb2NrLm9mZnNldFR5cGUgPSBoZWFkZXJCeXRlOwogICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyQnl0ZSA9PT0gMikgewogICAgICAgICAgICAgICAgICAgIGJsb2NrLm9mZnNldCA9IHZpZXcuZ2V0SW50OCgxKTsKICAgICAgICAgICAgICAgICAgICBzaXplKys7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGVhZGVyQnl0ZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIGJsb2NrLm9mZnNldCA9IHZpZXcuZ2V0SW50MTYoMSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgc2l6ZSArPSAyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhlYWRlckJ5dGUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBibG9jay5vZmZzZXQgPSB2aWV3LmdldEZsb2F0MzIoMSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgc2l6ZSArPSA0OwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIGJsb2NrIG9mZnNldCB0eXBlIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBoZWFkZXJCeXRlID0gdmlldy5nZXRVaW50OChzaXplKTsKICAgICAgICAgICAgICAgICAgICBzaXplKys7CiAgICAgICAgICAgICAgICAgICAgYmxvY2suYml0c1BlclBpeGVsID0gaGVhZGVyQnl0ZSAmIDYzOwogICAgICAgICAgICAgICAgICAgIGhlYWRlckJ5dGUgPj49IDY7CiAgICAgICAgICAgICAgICAgICAgYmxvY2subnVtVmFsaWRQaXhlbHNUeXBlID0gaGVhZGVyQnl0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyQnl0ZSA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgYmxvY2subnVtVmFsaWRQaXhlbHMgPSB2aWV3LmdldFVpbnQ4KHNpemUpOwogICAgICAgICAgICAgICAgICAgICAgc2l6ZSsrOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGVhZGVyQnl0ZSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgYmxvY2subnVtVmFsaWRQaXhlbHMgPSB2aWV3LmdldFVpbnQxNihzaXplLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgIHNpemUgKz0gMjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhlYWRlckJ5dGUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJsb2NrLm51bVZhbGlkUGl4ZWxzID0gdmlldy5nZXRVaW50MzIoc2l6ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICBzaXplICs9IDQ7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIHZhbGlkIHBpeGVsIGNvdW50IHR5cGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZnAgKz0gc2l6ZTsKICAgICAgICAgICAgICAgIGlmIChibG9jay5lbmNvZGluZyA9PT0gMykgewogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBhcnJheUJ1Ziwgc3RvcmU4OwogICAgICAgICAgICAgICAgaWYgKGJsb2NrLmVuY29kaW5nID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHZhciBudW1QaXhlbHMgPSAoZGF0YS5waXhlbHMubnVtQnl0ZXMgLSAxKSAvIDQ7CiAgICAgICAgICAgICAgICAgIGlmIChudW1QaXhlbHMgIT09IE1hdGguZmxvb3IobnVtUGl4ZWxzKSkgewogICAgICAgICAgICAgICAgICAgIHRocm93ICJ1bmNvbXByZXNzZWQgYmxvY2sgaGFzIGludmFsaWQgbGVuZ3RoIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihudW1QaXhlbHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBmcCwgbnVtUGl4ZWxzICogNCkpOwogICAgICAgICAgICAgICAgICB2YXIgcmF3RGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBibG9jay5yYXdEYXRhID0gcmF3RGF0YTsKICAgICAgICAgICAgICAgICAgZnAgKz0gbnVtUGl4ZWxzICogNDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2suZW5jb2RpbmcgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgdmFyIGRhdGFCeXRlcyA9IE1hdGguY2VpbChibG9jay5udW1WYWxpZFBpeGVscyAqIGJsb2NrLmJpdHNQZXJQaXhlbCAvIDgpOwogICAgICAgICAgICAgICAgICB2YXIgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBmcCwgZGF0YUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgIGJsb2NrLnN0dWZmZWREYXRhID0gbmV3IFVpbnQzMkFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgZnAgKz0gZGF0YUJ5dGVzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkYXRhLmVvZk9mZnNldCA9IGZwOwogICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgdW5zdHVmZiA9IGZ1bmN0aW9uKHNyYywgYml0c1BlclBpeGVsLCBudW1QaXhlbHMsIG9mZnNldCwgc2NhbGUsIGRlc3QsIG1heFZhbHVlKSB7CiAgICAgICAgICAgIHZhciBiaXRNYXNrID0gKDEgPDwgYml0c1BlclBpeGVsKSAtIDE7CiAgICAgICAgICAgIHZhciBpID0gMCwgbzsKICAgICAgICAgICAgdmFyIGJpdHNMZWZ0ID0gMDsKICAgICAgICAgICAgdmFyIG4sIGJ1ZmZlcjsKICAgICAgICAgICAgdmFyIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgdmFyIG51bUludmFsaWRUYWlsQnl0ZXMgPSBzcmMubGVuZ3RoICogNCAtIE1hdGguY2VpbChiaXRzUGVyUGl4ZWwgKiBudW1QaXhlbHMgLyA4KTsKICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgIGZvciAobyA9IDA7IG8gPCBudW1QaXhlbHM7IG8rKykgewogICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICBuID0gYnVmZmVyID4+PiBiaXRzTGVmdCAtIGJpdHNQZXJQaXhlbCAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBtaXNzaW5nQml0cyA9IGJpdHNQZXJQaXhlbCAtIGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgbiA9IChidWZmZXIgJiBiaXRNYXNrKSA8PCBtaXNzaW5nQml0cyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzIgLSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgIG4gKz0gYnVmZmVyID4+PiBiaXRzTGVmdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRlc3Q7CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIENudFpJbWFnZTsKICAgICAgICB9KCk7CiAgICAgICAgdmFyIExlcmMyRGVjb2RlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgICB2YXIgQml0U3R1ZmZlciA9IHsKICAgICAgICAgICAgLy9tZXRob2RzIGVuZGluZyB3aXRoIDIgYXJlIGZvciB0aGUgbmV3IGJ5dGUgb3JkZXIgdXNlZCBieSBMZXJjMi4zIGFuZCBhYm92ZS4KICAgICAgICAgICAgLy9vcmlnaW5hbFVuc3R1ZmYgaXMgdXNlZCB0byB1bnBhY2sgSHVmZm1hbiBjb2RlIHRhYmxlLiBjb2RlIGlzIGR1cGxpY2F0ZWQgdG8gdW5zdHVmZnggZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMuCiAgICAgICAgICAgIHVuc3R1ZmY6IGZ1bmN0aW9uKHNyYywgZGVzdCwgYml0c1BlclBpeGVsLCBudW1QaXhlbHMsIGx1dEFyciwgb2Zmc2V0LCBzY2FsZSwgbWF4VmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgYml0TWFzayA9ICgxIDw8IGJpdHNQZXJQaXhlbCkgLSAxOwogICAgICAgICAgICAgIHZhciBpID0gMCwgbzsKICAgICAgICAgICAgICB2YXIgYml0c0xlZnQgPSAwOwogICAgICAgICAgICAgIHZhciBuLCBidWZmZXIsIG1pc3NpbmdCaXRzLCBubWF4OwogICAgICAgICAgICAgIHZhciBudW1JbnZhbGlkVGFpbEJ5dGVzID0gc3JjLmxlbmd0aCAqIDQgLSBNYXRoLmNlaWwoYml0c1BlclBpeGVsICogbnVtUGl4ZWxzIC8gOCk7CiAgICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgICAgaWYgKGx1dEFycikgewogICAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGJpdHNMZWZ0ID49IGJpdHNQZXJQaXhlbCkgewogICAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdHNMZWZ0IC0gYml0c1BlclBpeGVsICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbWlzc2luZ0JpdHMgPSBiaXRzUGVyUGl4ZWwgLSBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgICBuID0gKGJ1ZmZlciAmIGJpdE1hc2spIDw8IG1pc3NpbmdCaXRzICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgICAgbiArPSBidWZmZXIgPj4+IGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBsdXRBcnJbbl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgICAgIGZvciAobyA9IDA7IG8gPCBudW1QaXhlbHM7IG8rKykgewogICAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgICBuID0gYnVmZmVyID4+PiBiaXRzTGVmdCAtIGJpdHNQZXJQaXhlbCAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgLT0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1pc3NpbmdCaXRzID0gYml0c1BlclBpeGVsIC0gYml0c0xlZnQ7CiAgICAgICAgICAgICAgICAgICAgbiA9IChidWZmZXIgJiBiaXRNYXNrKSA8PCBtaXNzaW5nQml0cyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMiAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICAgIG4gKz0gYnVmZmVyID4+PiBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkZXN0W29dID0gbiA8IG5tYXggPyBvZmZzZXQgKyBuICogc2NhbGUgOiBtYXhWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3R1ZmZMVVQ6IGZ1bmN0aW9uKHNyYywgYml0c1BlclBpeGVsLCBudW1QaXhlbHMsIG9mZnNldCwgc2NhbGUsIG1heFZhbHVlKSB7CiAgICAgICAgICAgICAgdmFyIGJpdE1hc2sgPSAoMSA8PCBiaXRzUGVyUGl4ZWwpIC0gMTsKICAgICAgICAgICAgICB2YXIgaSA9IDAsIG8gPSAwLCBtaXNzaW5nQml0cyA9IDAsIGJpdHNMZWZ0ID0gMCwgbiA9IDA7CiAgICAgICAgICAgICAgdmFyIGJ1ZmZlcjsKICAgICAgICAgICAgICB2YXIgZGVzdCA9IFtdOwogICAgICAgICAgICAgIHZhciBudW1JbnZhbGlkVGFpbEJ5dGVzID0gc3JjLmxlbmd0aCAqIDQgLSBNYXRoLmNlaWwoYml0c1BlclBpeGVsICogbnVtUGl4ZWxzIC8gOCk7CiAgICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgICAgdmFyIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgICBmb3IgKG8gPSAwOyBvIDwgbnVtUGl4ZWxzOyBvKyspIHsKICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0c0xlZnQgLSBiaXRzUGVyUGl4ZWwgJiBiaXRNYXNrOwogICAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBtaXNzaW5nQml0cyA9IGJpdHNQZXJQaXhlbCAtIGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgICBuID0gKGJ1ZmZlciAmIGJpdE1hc2spIDw8IG1pc3NpbmdCaXRzICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzIgLSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgICAgbiArPSBidWZmZXIgPj4+IGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlc3QudW5zaGlmdChvZmZzZXQpOwogICAgICAgICAgICAgIHJldHVybiBkZXN0OwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0dWZmMjogZnVuY3Rpb24oc3JjLCBkZXN0LCBiaXRzUGVyUGl4ZWwsIG51bVBpeGVscywgbHV0QXJyLCBvZmZzZXQsIHNjYWxlLCBtYXhWYWx1ZSkgewogICAgICAgICAgICAgIHZhciBiaXRNYXNrID0gKDEgPDwgYml0c1BlclBpeGVsKSAtIDE7CiAgICAgICAgICAgICAgdmFyIGkgPSAwLCBvOwogICAgICAgICAgICAgIHZhciBiaXRzTGVmdCA9IDAsIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgdmFyIG4sIGJ1ZmZlciwgbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgaWYgKGx1dEFycikgewogICAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICAgICAgYml0UG9zID0gMDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCAtPSBiaXRzUGVyUGl4ZWw7CiAgICAgICAgICAgICAgICAgICAgYml0UG9zICs9IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtaXNzaW5nQml0cyA9IGJpdHNQZXJQaXhlbCAtIGJpdHNMZWZ0OwogICAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdFBvcyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMiAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICAgIG4gfD0gKGJ1ZmZlciAmICgxIDw8IG1pc3NpbmdCaXRzKSAtIDEpIDw8IGJpdHNQZXJQaXhlbCAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBsdXRBcnJbbl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBubWF4ID0gTWF0aC5jZWlsKChtYXhWYWx1ZSAtIG9mZnNldCkgLyBzY2FsZSk7CiAgICAgICAgICAgICAgICBmb3IgKG8gPSAwOyBvIDwgbnVtUGl4ZWxzOyBvKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKGJpdHNMZWZ0ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMjsKICAgICAgICAgICAgICAgICAgICBiaXRQb3MgPSAwOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgICBuID0gYnVmZmVyID4+PiBiaXRQb3MgJiBiaXRNYXNrOwogICAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0IC09IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1pc3NpbmdCaXRzID0gYml0c1BlclBpeGVsIC0gYml0c0xlZnQ7CiAgICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgICAgbiB8PSAoYnVmZmVyICYgKDEgPDwgbWlzc2luZ0JpdHMpIC0gMSkgPDwgYml0c1BlclBpeGVsIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0UG9zID0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBkZXN0OwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0dWZmTFVUMjogZnVuY3Rpb24oc3JjLCBiaXRzUGVyUGl4ZWwsIG51bVBpeGVscywgb2Zmc2V0LCBzY2FsZSwgbWF4VmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgYml0TWFzayA9ICgxIDw8IGJpdHNQZXJQaXhlbCkgLSAxOwogICAgICAgICAgICAgIHZhciBpID0gMCwgbyA9IDAsIG1pc3NpbmdCaXRzID0gMCwgYml0c0xlZnQgPSAwLCBuID0gMCwgYml0UG9zID0gMDsKICAgICAgICAgICAgICB2YXIgYnVmZmVyOwogICAgICAgICAgICAgIHZhciBkZXN0ID0gW107CiAgICAgICAgICAgICAgdmFyIG5tYXggPSBNYXRoLmNlaWwoKG1heFZhbHVlIC0gb2Zmc2V0KSAvIHNjYWxlKTsKICAgICAgICAgICAgICBmb3IgKG8gPSAwOyBvIDwgbnVtUGl4ZWxzOyBvKyspIHsKICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBidWZmZXIgPSBzcmNbaSsrXTsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgPSAzMjsKICAgICAgICAgICAgICAgICAgYml0UG9zID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChiaXRzTGVmdCA+PSBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgLT0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbWlzc2luZ0JpdHMgPSBiaXRzUGVyUGl4ZWwgLSBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgbiA9IGJ1ZmZlciA+Pj4gYml0UG9zICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzIgLSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgICAgbiB8PSAoYnVmZmVyICYgKDEgPDwgbWlzc2luZ0JpdHMpIC0gMSkgPDwgYml0c1BlclBpeGVsIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVzdFtvXSA9IG4gPCBubWF4ID8gb2Zmc2V0ICsgbiAqIHNjYWxlIDogbWF4VmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlc3QudW5zaGlmdChvZmZzZXQpOwogICAgICAgICAgICAgIHJldHVybiBkZXN0OwogICAgICAgICAgICB9LAogICAgICAgICAgICBvcmlnaW5hbFVuc3R1ZmY6IGZ1bmN0aW9uKHNyYywgZGVzdCwgYml0c1BlclBpeGVsLCBudW1QaXhlbHMpIHsKICAgICAgICAgICAgICB2YXIgYml0TWFzayA9ICgxIDw8IGJpdHNQZXJQaXhlbCkgLSAxOwogICAgICAgICAgICAgIHZhciBpID0gMCwgbzsKICAgICAgICAgICAgICB2YXIgYml0c0xlZnQgPSAwOwogICAgICAgICAgICAgIHZhciBuLCBidWZmZXIsIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgIHZhciBudW1JbnZhbGlkVGFpbEJ5dGVzID0gc3JjLmxlbmd0aCAqIDQgLSBNYXRoLmNlaWwoYml0c1BlclBpeGVsICogbnVtUGl4ZWxzIC8gOCk7CiAgICAgICAgICAgICAgc3JjW3NyYy5sZW5ndGggLSAxXSA8PD0gOCAqIG51bUludmFsaWRUYWlsQnl0ZXM7CiAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdHNMZWZ0IC0gYml0c1BlclBpeGVsICYgYml0TWFzazsKICAgICAgICAgICAgICAgICAgYml0c0xlZnQgLT0gYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbWlzc2luZ0JpdHMgPSBiaXRzUGVyUGl4ZWwgLSBiaXRzTGVmdDsKICAgICAgICAgICAgICAgICAgbiA9IChidWZmZXIgJiBiaXRNYXNrKSA8PCBtaXNzaW5nQml0cyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIG4gKz0gYnVmZmVyID4+PiBiaXRzTGVmdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZGVzdDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb3JpZ2luYWxVbnN0dWZmMjogZnVuY3Rpb24oc3JjLCBkZXN0LCBiaXRzUGVyUGl4ZWwsIG51bVBpeGVscykgewogICAgICAgICAgICAgIHZhciBiaXRNYXNrID0gKDEgPDwgYml0c1BlclBpeGVsKSAtIDE7CiAgICAgICAgICAgICAgdmFyIGkgPSAwLCBvOwogICAgICAgICAgICAgIHZhciBiaXRzTGVmdCA9IDAsIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgdmFyIG4sIGJ1ZmZlciwgbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgZm9yIChvID0gMDsgbyA8IG51bVBpeGVsczsgbysrKSB7CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyID0gc3JjW2krK107CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0ID0gMzI7CiAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYml0c0xlZnQgPj0gYml0c1BlclBpeGVsKSB7CiAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdFBvcyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgIGJpdHNMZWZ0IC09IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgICAgYml0UG9zICs9IGJpdHNQZXJQaXhlbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG1pc3NpbmdCaXRzID0gYml0c1BlclBpeGVsIC0gYml0c0xlZnQ7CiAgICAgICAgICAgICAgICAgIG4gPSBidWZmZXIgPj4+IGJpdFBvcyAmIGJpdE1hc2s7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHNyY1tpKytdOwogICAgICAgICAgICAgICAgICBiaXRzTGVmdCA9IDMyIC0gbWlzc2luZ0JpdHM7CiAgICAgICAgICAgICAgICAgIG4gfD0gKGJ1ZmZlciAmICgxIDw8IG1pc3NpbmdCaXRzKSAtIDEpIDw8IGJpdHNQZXJQaXhlbCAtIG1pc3NpbmdCaXRzOwogICAgICAgICAgICAgICAgICBiaXRQb3MgPSBtaXNzaW5nQml0czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlc3Rbb10gPSBuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZGVzdDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBMZXJjMkhlbHBlcnMgPSB7CiAgICAgICAgICAgIEhVRkZNQU5fTFVUX0JJVFNfTUFYOiAxMiwKICAgICAgICAgICAgLy91c2UgMl4xMiBsdXQsIHRyZWF0IGl0IGxpa2UgY29uc3RhbnQKICAgICAgICAgICAgY29tcHV0ZUNoZWNrc3VtRmxldGNoZXIzMjogZnVuY3Rpb24oaW5wdXQpIHsKICAgICAgICAgICAgICB2YXIgc3VtMSA9IDY1NTM1LCBzdW0yID0gNjU1MzU7CiAgICAgICAgICAgICAgdmFyIGxlbiA9IGlucHV0Lmxlbmd0aDsKICAgICAgICAgICAgICB2YXIgd29yZHMgPSBNYXRoLmZsb29yKGxlbiAvIDIpOwogICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICB3aGlsZSAod29yZHMpIHsKICAgICAgICAgICAgICAgIHZhciB0bGVuID0gd29yZHMgPj0gMzU5ID8gMzU5IDogd29yZHM7CiAgICAgICAgICAgICAgICB3b3JkcyAtPSB0bGVuOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICBzdW0xICs9IGlucHV0W2krK10gPDwgODsKICAgICAgICAgICAgICAgICAgc3VtMiArPSBzdW0xICs9IGlucHV0W2krK107CiAgICAgICAgICAgICAgICB9IHdoaWxlICgtLXRsZW4pOwogICAgICAgICAgICAgICAgc3VtMSA9IChzdW0xICYgNjU1MzUpICsgKHN1bTEgPj4+IDE2KTsKICAgICAgICAgICAgICAgIHN1bTIgPSAoc3VtMiAmIDY1NTM1KSArIChzdW0yID4+PiAxNik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsZW4gJiAxKSB7CiAgICAgICAgICAgICAgICBzdW0yICs9IHN1bTEgKz0gaW5wdXRbaV0gPDwgODsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3VtMSA9IChzdW0xICYgNjU1MzUpICsgKHN1bTEgPj4+IDE2KTsKICAgICAgICAgICAgICBzdW0yID0gKHN1bTIgJiA2NTUzNSkgKyAoc3VtMiA+Pj4gMTYpOwogICAgICAgICAgICAgIHJldHVybiAoc3VtMiA8PCAxNiB8IHN1bTEpID4+PiAwOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkSGVhZGVySW5mbzogZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGZpbGVJZFZpZXcgPSBuZXcgVWludDhBcnJheShpbnB1dCwgcHRyLCA2KTsKICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IHt9OwogICAgICAgICAgICAgIGhlYWRlckluZm8uZmlsZUlkZW50aWZpZXJTdHJpbmcgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGZpbGVJZFZpZXcpOwogICAgICAgICAgICAgIGlmIChoZWFkZXJJbmZvLmZpbGVJZGVudGlmaWVyU3RyaW5nLmxhc3RJbmRleE9mKCJMZXJjMiIsIDApICE9PSAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAiVW5leHBlY3RlZCBmaWxlIGlkZW50aWZpZXIgc3RyaW5nIChleHBlY3QgTGVyYzIgKTogIiArIGhlYWRlckluZm8uZmlsZUlkZW50aWZpZXJTdHJpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHB0ciArPSA2OwogICAgICAgICAgICAgIHZhciB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBwdHIsIDgpOwogICAgICAgICAgICAgIHZhciBmaWxlVmVyc2lvbiA9IHZpZXcuZ2V0SW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgaGVhZGVySW5mby5maWxlVmVyc2lvbiA9IGZpbGVWZXJzaW9uOwogICAgICAgICAgICAgIHB0ciArPSA0OwogICAgICAgICAgICAgIGlmIChmaWxlVmVyc2lvbiA+PSAzKSB7CiAgICAgICAgICAgICAgICBoZWFkZXJJbmZvLmNoZWNrc3VtID0gdmlldy5nZXRVaW50MzIoNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBwdHIgKz0gNDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgcHRyLCAxMik7CiAgICAgICAgICAgICAgaGVhZGVySW5mby5oZWlnaHQgPSB2aWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgICBoZWFkZXJJbmZvLndpZHRoID0gdmlldy5nZXRVaW50MzIoNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgcHRyICs9IDg7CiAgICAgICAgICAgICAgaWYgKGZpbGVWZXJzaW9uID49IDQpIHsKICAgICAgICAgICAgICAgIGhlYWRlckluZm8ubnVtRGltcyA9IHZpZXcuZ2V0VWludDMyKDgsIHRydWUpOwogICAgICAgICAgICAgICAgcHRyICs9IDQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGhlYWRlckluZm8ubnVtRGltcyA9IDE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZpZXcgPSBuZXcgRGF0YVZpZXcoaW5wdXQsIHB0ciwgNDApOwogICAgICAgICAgICAgIGhlYWRlckluZm8ubnVtVmFsaWRQaXhlbCA9IHZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8ubWljcm9CbG9ja1NpemUgPSB2aWV3LmdldEludDMyKDQsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8uYmxvYlNpemUgPSB2aWV3LmdldEludDMyKDgsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8uaW1hZ2VUeXBlID0gdmlldy5nZXRJbnQzMigxMiwgdHJ1ZSk7CiAgICAgICAgICAgICAgaGVhZGVySW5mby5tYXhaRXJyb3IgPSB2aWV3LmdldEZsb2F0NjQoMTYsIHRydWUpOwogICAgICAgICAgICAgIGhlYWRlckluZm8uek1pbiA9IHZpZXcuZ2V0RmxvYXQ2NCgyNCwgdHJ1ZSk7CiAgICAgICAgICAgICAgaGVhZGVySW5mby56TWF4ID0gdmlldy5nZXRGbG9hdDY0KDMyLCB0cnVlKTsKICAgICAgICAgICAgICBwdHIgKz0gNDA7CiAgICAgICAgICAgICAgZGF0YS5oZWFkZXJJbmZvID0gaGVhZGVySW5mbzsKICAgICAgICAgICAgICBkYXRhLnB0ciA9IHB0cjsKICAgICAgICAgICAgICB2YXIgY2hlY2tzdW0sIGtleUxlbmd0aDsKICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAga2V5TGVuZ3RoID0gZmlsZVZlcnNpb24gPj0gNCA/IDUyIDogNDg7CiAgICAgICAgICAgICAgICBjaGVja3N1bSA9IHRoaXMuY29tcHV0ZUNoZWNrc3VtRmxldGNoZXIzMihuZXcgVWludDhBcnJheShpbnB1dCwgcHRyIC0ga2V5TGVuZ3RoLCBoZWFkZXJJbmZvLmJsb2JTaXplIC0gMTQpKTsKICAgICAgICAgICAgICAgIGlmIChjaGVja3N1bSAhPT0gaGVhZGVySW5mby5jaGVja3N1bSkgewogICAgICAgICAgICAgICAgICB0aHJvdyAiQ2hlY2tzdW0gZmFpbGVkLiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGVja01pbk1heFJhbmdlczogZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHsKICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IGRhdGEuaGVhZGVySW5mbzsKICAgICAgICAgICAgICB2YXIgT3V0UGl4ZWxUeXBlQXJyYXkgPSB0aGlzLmdldERhdGFUeXBlQXJyYXkoaGVhZGVySW5mby5pbWFnZVR5cGUpOwogICAgICAgICAgICAgIHZhciByYW5nZUJ5dGVzID0gaGVhZGVySW5mby5udW1EaW1zICogdGhpcy5nZXREYXRhVHlwZVNpemUoaGVhZGVySW5mby5pbWFnZVR5cGUpOwogICAgICAgICAgICAgIHZhciBtaW5WYWx1ZXMgPSB0aGlzLnJlYWRTdWJBcnJheShpbnB1dCwgZGF0YS5wdHIsIE91dFBpeGVsVHlwZUFycmF5LCByYW5nZUJ5dGVzKTsKICAgICAgICAgICAgICB2YXIgbWF4VmFsdWVzID0gdGhpcy5yZWFkU3ViQXJyYXkoaW5wdXQsIGRhdGEucHRyICsgcmFuZ2VCeXRlcywgT3V0UGl4ZWxUeXBlQXJyYXksIHJhbmdlQnl0ZXMpOwogICAgICAgICAgICAgIGRhdGEucHRyICs9IDIgKiByYW5nZUJ5dGVzOwogICAgICAgICAgICAgIHZhciBpLCBlcXVhbCA9IHRydWU7CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGhlYWRlckluZm8ubnVtRGltczsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAobWluVmFsdWVzW2ldICE9PSBtYXhWYWx1ZXNbaV0pIHsKICAgICAgICAgICAgICAgICAgZXF1YWwgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGhlYWRlckluZm8ubWluVmFsdWVzID0gbWluVmFsdWVzOwogICAgICAgICAgICAgIGhlYWRlckluZm8ubWF4VmFsdWVzID0gbWF4VmFsdWVzOwogICAgICAgICAgICAgIHJldHVybiBlcXVhbDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVhZFN1YkFycmF5OiBmdW5jdGlvbihpbnB1dCwgcHRyLCBPdXRQaXhlbFR5cGVBcnJheSwgbnVtQnl0ZXMpIHsKICAgICAgICAgICAgICB2YXIgcmF3RGF0YTsKICAgICAgICAgICAgICBpZiAoT3V0UGl4ZWxUeXBlQXJyYXkgPT09IFVpbnQ4QXJyYXkpIHsKICAgICAgICAgICAgICAgIHJhd0RhdGEgPSBuZXcgVWludDhBcnJheShpbnB1dCwgcHRyLCBudW1CeXRlcyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihudW1CeXRlcyk7CiAgICAgICAgICAgICAgICB2YXIgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgc3RvcmU4LnNldChuZXcgVWludDhBcnJheShpbnB1dCwgcHRyLCBudW1CeXRlcykpOwogICAgICAgICAgICAgICAgcmF3RGF0YSA9IG5ldyBPdXRQaXhlbFR5cGVBcnJheShhcnJheUJ1Zik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByYXdEYXRhOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkTWFzazogZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGhlYWRlckluZm8gPSBkYXRhLmhlYWRlckluZm87CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVscyA9IGhlYWRlckluZm8ud2lkdGggKiBoZWFkZXJJbmZvLmhlaWdodDsKICAgICAgICAgICAgICB2YXIgbnVtVmFsaWRQaXhlbCA9IGhlYWRlckluZm8ubnVtVmFsaWRQaXhlbDsKICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgcHRyLCA0KTsKICAgICAgICAgICAgICB2YXIgbWFzayA9IHt9OwogICAgICAgICAgICAgIG1hc2subnVtQnl0ZXMgPSB2aWV3LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICAgICAgICBwdHIgKz0gNDsKICAgICAgICAgICAgICBpZiAoKDAgPT09IG51bVZhbGlkUGl4ZWwgfHwgbnVtUGl4ZWxzID09PSBudW1WYWxpZFBpeGVsKSAmJiAwICE9PSBtYXNrLm51bUJ5dGVzKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAiaW52YWxpZCBtYXNrIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJpdHNldCwgcmVzdWx0TWFzazsKICAgICAgICAgICAgICBpZiAobnVtVmFsaWRQaXhlbCA9PT0gMCkgewogICAgICAgICAgICAgICAgYml0c2V0ID0gbmV3IFVpbnQ4QXJyYXkoTWF0aC5jZWlsKG51bVBpeGVscyAvIDgpKTsKICAgICAgICAgICAgICAgIG1hc2suYml0c2V0ID0gYml0c2V0OwogICAgICAgICAgICAgICAgcmVzdWx0TWFzayA9IG5ldyBVaW50OEFycmF5KG51bVBpeGVscyk7CiAgICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRNYXNrID0gcmVzdWx0TWFzazsKICAgICAgICAgICAgICAgIHB0ciArPSBtYXNrLm51bUJ5dGVzOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobWFzay5udW1CeXRlcyA+IDApIHsKICAgICAgICAgICAgICAgIGJpdHNldCA9IG5ldyBVaW50OEFycmF5KE1hdGguY2VpbChudW1QaXhlbHMgLyA4KSk7CiAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBwdHIsIG1hc2subnVtQnl0ZXMpOwogICAgICAgICAgICAgICAgdmFyIGNudCA9IHZpZXcuZ2V0SW50MTYoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB2YXIgaXAgPSAyLCBvcCA9IDAsIHZhbCA9IDA7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgIGlmIChjbnQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGNudC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzZXRbb3ArK10gPSB2aWV3LmdldFVpbnQ4KGlwKyspOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YWwgPSB2aWV3LmdldFVpbnQ4KGlwKyspOwogICAgICAgICAgICAgICAgICAgIGNudCA9IC1jbnQ7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGNudC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzZXRbb3ArK10gPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNudCA9IHZpZXcuZ2V0SW50MTYoaXAsIHRydWUpOwogICAgICAgICAgICAgICAgICBpcCArPSAyOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoaXAgPCBtYXNrLm51bUJ5dGVzKTsKICAgICAgICAgICAgICAgIGlmIChjbnQgIT09IC0zMjc2OCB8fCBvcCA8IGJpdHNldC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgIlVuZXhwZWN0ZWQgZW5kIG9mIG1hc2sgUkxFIGVuY29kaW5nIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc3VsdE1hc2sgPSBuZXcgVWludDhBcnJheShudW1QaXhlbHMpOwogICAgICAgICAgICAgICAgdmFyIG1iID0gMCwgayA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgbnVtUGl4ZWxzOyBrKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKGsgJiA3KSB7CiAgICAgICAgICAgICAgICAgICAgbWIgPSBiaXRzZXRbayA+PiAzXTsKICAgICAgICAgICAgICAgICAgICBtYiA8PD0gayAmIDc7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbWIgPSBiaXRzZXRbayA+PiAzXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAobWIgJiAxMjgpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRNYXNrW2tdID0gMTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0TWFzayA9IHJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgICBtYXNrLmJpdHNldCA9IGJpdHNldDsKICAgICAgICAgICAgICAgIHB0ciArPSBtYXNrLm51bUJ5dGVzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkYXRhLnB0ciA9IHB0cjsKICAgICAgICAgICAgICBkYXRhLm1hc2sgPSBtYXNrOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkRGF0YU9uZVN3ZWVwOiBmdW5jdGlvbihpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpIHsKICAgICAgICAgICAgICB2YXIgcHRyID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGhlYWRlckluZm8gPSBkYXRhLmhlYWRlckluZm87CiAgICAgICAgICAgICAgdmFyIG51bURpbXMgPSBoZWFkZXJJbmZvLm51bURpbXM7CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVscyA9IGhlYWRlckluZm8ud2lkdGggKiBoZWFkZXJJbmZvLmhlaWdodDsKICAgICAgICAgICAgICB2YXIgaW1hZ2VUeXBlID0gaGVhZGVySW5mby5pbWFnZVR5cGU7CiAgICAgICAgICAgICAgdmFyIG51bUJ5dGVzID0gaGVhZGVySW5mby5udW1WYWxpZFBpeGVsICogTGVyYzJIZWxwZXJzLmdldERhdGFUeXBlU2l6ZShpbWFnZVR5cGUpICogbnVtRGltczsKICAgICAgICAgICAgICB2YXIgcmF3RGF0YTsKICAgICAgICAgICAgICB2YXIgbWFzayA9IGRhdGEucGl4ZWxzLnJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgaWYgKE91dFBpeGVsVHlwZUFycmF5ID09PSBVaW50OEFycmF5KSB7CiAgICAgICAgICAgICAgICByYXdEYXRhID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXQsIHB0ciwgbnVtQnl0ZXMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgYXJyYXlCdWYgPSBuZXcgQXJyYXlCdWZmZXIobnVtQnl0ZXMpOwogICAgICAgICAgICAgICAgdmFyIHN0b3JlOCA9IG5ldyBVaW50OEFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgIHN0b3JlOC5zZXQobmV3IFVpbnQ4QXJyYXkoaW5wdXQsIHB0ciwgbnVtQnl0ZXMpKTsKICAgICAgICAgICAgICAgIHJhd0RhdGEgPSBuZXcgT3V0UGl4ZWxUeXBlQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmF3RGF0YS5sZW5ndGggPT09IG51bVBpeGVscyAqIG51bURpbXMpIHsKICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVscyA9IHJhd0RhdGE7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVscyA9IG5ldyBPdXRQaXhlbFR5cGVBcnJheShudW1QaXhlbHMgKiBudW1EaW1zKTsKICAgICAgICAgICAgICAgIHZhciB6ID0gMCwgayA9IDAsIGkgPSAwLCBuU3RhcnQgPSAwOwogICAgICAgICAgICAgICAgaWYgKG51bURpbXMgPiAxKSB7CiAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1EaW1zOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBuU3RhcnQgPSBpICogbnVtUGl4ZWxzOwogICAgICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBudW1QaXhlbHM7IGsrKykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2tba10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzW25TdGFydCArIGtdID0gcmF3RGF0YVt6KytdOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZm9yIChrID0gMDsgayA8IG51bVBpeGVsczsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2tba10pIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVsc1trXSA9IHJhd0RhdGFbeisrXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHRyICs9IG51bUJ5dGVzOwogICAgICAgICAgICAgIGRhdGEucHRyID0gcHRyOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkSHVmZm1hblRyZWU6IGZ1bmN0aW9uKGlucHV0LCBkYXRhKSB7CiAgICAgICAgICAgICAgdmFyIEJJVFNfTUFYID0gdGhpcy5IVUZGTUFOX0xVVF9CSVRTX01BWDsKICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZGF0YS5wdHIsIDE2KTsKICAgICAgICAgICAgICBkYXRhLnB0ciArPSAxNjsKICAgICAgICAgICAgICB2YXIgdmVyc2lvbiA9IHZpZXcuZ2V0SW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgaWYgKHZlcnNpb24gPCAyKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAidW5zdXBwb3J0ZWQgSHVmZm1hbiB2ZXJzaW9uIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHNpemUgPSB2aWV3LmdldEludDMyKDQsIHRydWUpOwogICAgICAgICAgICAgIHZhciBpMCA9IHZpZXcuZ2V0SW50MzIoOCwgdHJ1ZSk7CiAgICAgICAgICAgICAgdmFyIGkxID0gdmlldy5nZXRJbnQzMigxMiwgdHJ1ZSk7CiAgICAgICAgICAgICAgaWYgKGkwID49IGkxKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBibG9ja0RhdGFCdWZmZXIgPSBuZXcgVWludDMyQXJyYXkoaTEgLSBpMCk7CiAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLmRlY29kZUJpdHMoaW5wdXQsIGRhdGEsIGJsb2NrRGF0YUJ1ZmZlcik7CiAgICAgICAgICAgICAgdmFyIGNvZGVUYWJsZSA9IFtdOwogICAgICAgICAgICAgIHZhciBpLCBqLCBrLCBsZW47CiAgICAgICAgICAgICAgZm9yIChpID0gaTA7IGkgPCBpMTsgaSsrKSB7CiAgICAgICAgICAgICAgICBqID0gaSAtIChpIDwgc2l6ZSA/IDAgOiBzaXplKTsKICAgICAgICAgICAgICAgIGNvZGVUYWJsZVtqXSA9IHsgZmlyc3Q6IGJsb2NrRGF0YUJ1ZmZlcltpIC0gaTBdLCBzZWNvbmQ6IG51bGwgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGRhdGFCeXRlcyA9IGlucHV0LmJ5dGVMZW5ndGggLSBkYXRhLnB0cjsKICAgICAgICAgICAgICB2YXIgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgIHZhciBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICB2YXIgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgIHN0b3JlOC5zZXQobmV3IFVpbnQ4QXJyYXkoaW5wdXQsIGRhdGEucHRyLCBkYXRhQnl0ZXMpKTsKICAgICAgICAgICAgICB2YXIgc3R1ZmZlZERhdGEgPSBuZXcgVWludDMyQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgIHZhciBiaXRQb3MgPSAwLCB3b3JkLCBzcmNQdHIgPSAwOwogICAgICAgICAgICAgIHdvcmQgPSBzdHVmZmVkRGF0YVswXTsKICAgICAgICAgICAgICBmb3IgKGkgPSBpMDsgaSA8IGkxOyBpKyspIHsKICAgICAgICAgICAgICAgIGogPSBpIC0gKGkgPCBzaXplID8gMCA6IHNpemUpOwogICAgICAgICAgICAgICAgbGVuID0gY29kZVRhYmxlW2pdLmZpcnN0OwogICAgICAgICAgICAgICAgaWYgKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgICAgY29kZVRhYmxlW2pdLnNlY29uZCA9IHdvcmQgPDwgYml0UG9zID4+PiAzMiAtIGxlbjsKICAgICAgICAgICAgICAgICAgaWYgKDMyIC0gYml0UG9zID49IGxlbikgewogICAgICAgICAgICAgICAgICAgIGJpdFBvcyArPSBsZW47CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpdFBvcyA9PT0gMzIpIHsKICAgICAgICAgICAgICAgICAgICAgIGJpdFBvcyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICBzcmNQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgIHdvcmQgPSBzdHVmZmVkRGF0YVtzcmNQdHJdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gbGVuIC0gMzI7CiAgICAgICAgICAgICAgICAgICAgc3JjUHRyKys7CiAgICAgICAgICAgICAgICAgICAgd29yZCA9IHN0dWZmZWREYXRhW3NyY1B0cl07CiAgICAgICAgICAgICAgICAgICAgY29kZVRhYmxlW2pdLnNlY29uZCB8PSB3b3JkID4+PiAzMiAtIGJpdFBvczsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbnVtQml0c0xVVCA9IDAsIG51bUJpdHNMVVRRaWNrID0gMDsKICAgICAgICAgICAgICB2YXIgdHJlZSA9IG5ldyBUcmVlTm9kZSgpOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb2RlVGFibGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChjb2RlVGFibGVbaV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBudW1CaXRzTFVUID0gTWF0aC5tYXgobnVtQml0c0xVVCwgY29kZVRhYmxlW2ldLmZpcnN0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG51bUJpdHNMVVQgPj0gQklUU19NQVgpIHsKICAgICAgICAgICAgICAgIG51bUJpdHNMVVRRaWNrID0gQklUU19NQVg7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG51bUJpdHNMVVRRaWNrID0gbnVtQml0c0xVVDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG51bUJpdHNMVVQgPj0gMzApIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJXQVJuaW5nLCBsYXJnZSBOVU0gTFVUIEJJVFMgSVMgIiArIG51bUJpdHNMVVQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZGVjb2RlTHV0ID0gW10sIGVudHJ5LCBjb2RlLCBudW1FbnRyaWVzLCBqaiwgY3VycmVudEJpdCwgbm9kZTsKICAgICAgICAgICAgICBmb3IgKGkgPSBpMDsgaSA8IGkxOyBpKyspIHsKICAgICAgICAgICAgICAgIGogPSBpIC0gKGkgPCBzaXplID8gMCA6IHNpemUpOwogICAgICAgICAgICAgICAgbGVuID0gY29kZVRhYmxlW2pdLmZpcnN0OwogICAgICAgICAgICAgICAgaWYgKGxlbiA+IDApIHsKICAgICAgICAgICAgICAgICAgZW50cnkgPSBbbGVuLCBqXTsKICAgICAgICAgICAgICAgICAgaWYgKGxlbiA8PSBudW1CaXRzTFVUUWljaykgewogICAgICAgICAgICAgICAgICAgIGNvZGUgPSBjb2RlVGFibGVbal0uc2Vjb25kIDw8IG51bUJpdHNMVVRRaWNrIC0gbGVuOwogICAgICAgICAgICAgICAgICAgIG51bUVudHJpZXMgPSAxIDw8IG51bUJpdHNMVVRRaWNrIC0gbGVuOwogICAgICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBudW1FbnRyaWVzOyBrKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGRlY29kZUx1dFtjb2RlIHwga10gPSBlbnRyeTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29kZSA9IGNvZGVUYWJsZVtqXS5zZWNvbmQ7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHRyZWU7CiAgICAgICAgICAgICAgICAgICAgZm9yIChqaiA9IGxlbiAtIDE7IGpqID49IDA7IGpqLS0pIHsKICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRCaXQgPSBjb2RlID4+PiBqaiAmIDE7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudEJpdCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGUucmlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnJpZ2h0ID0gbmV3IFRyZWVOb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGUubGVmdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUubGVmdCA9IG5ldyBUcmVlTm9kZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLmxlZnQ7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoamogPT09IDAgJiYgIW5vZGUudmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUudmFsID0gZW50cnlbMV07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBkZWNvZGVMdXQsCiAgICAgICAgICAgICAgICBudW1CaXRzTFVUUWljaywKICAgICAgICAgICAgICAgIG51bUJpdHNMVVQsCiAgICAgICAgICAgICAgICB0cmVlLAogICAgICAgICAgICAgICAgc3R1ZmZlZERhdGEsCiAgICAgICAgICAgICAgICBzcmNQdHIsCiAgICAgICAgICAgICAgICBiaXRQb3MKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkSHVmZm1hbjogZnVuY3Rpb24oaW5wdXQsIGRhdGEsIE91dFBpeGVsVHlwZUFycmF5KSB7CiAgICAgICAgICAgICAgdmFyIGhlYWRlckluZm8gPSBkYXRhLmhlYWRlckluZm87CiAgICAgICAgICAgICAgdmFyIG51bURpbXMgPSBoZWFkZXJJbmZvLm51bURpbXM7CiAgICAgICAgICAgICAgdmFyIGhlaWdodCA9IGRhdGEuaGVhZGVySW5mby5oZWlnaHQ7CiAgICAgICAgICAgICAgdmFyIHdpZHRoID0gZGF0YS5oZWFkZXJJbmZvLndpZHRoOwogICAgICAgICAgICAgIHZhciBudW1QaXhlbHMgPSB3aWR0aCAqIGhlaWdodDsKICAgICAgICAgICAgICB2YXIgaHVmZm1hbkluZm8gPSB0aGlzLnJlYWRIdWZmbWFuVHJlZShpbnB1dCwgZGF0YSk7CiAgICAgICAgICAgICAgdmFyIGRlY29kZUx1dCA9IGh1ZmZtYW5JbmZvLmRlY29kZUx1dDsKICAgICAgICAgICAgICB2YXIgdHJlZSA9IGh1ZmZtYW5JbmZvLnRyZWU7CiAgICAgICAgICAgICAgdmFyIHN0dWZmZWREYXRhID0gaHVmZm1hbkluZm8uc3R1ZmZlZERhdGE7CiAgICAgICAgICAgICAgdmFyIHNyY1B0ciA9IGh1ZmZtYW5JbmZvLnNyY1B0cjsKICAgICAgICAgICAgICB2YXIgYml0UG9zID0gaHVmZm1hbkluZm8uYml0UG9zOwogICAgICAgICAgICAgIHZhciBudW1CaXRzTFVUUWljayA9IGh1ZmZtYW5JbmZvLm51bUJpdHNMVVRRaWNrOwogICAgICAgICAgICAgIHZhciBudW1CaXRzTFVUID0gaHVmZm1hbkluZm8ubnVtQml0c0xVVDsKICAgICAgICAgICAgICB2YXIgb2Zmc2V0ID0gZGF0YS5oZWFkZXJJbmZvLmltYWdlVHlwZSA9PT0gMCA/IDEyOCA6IDA7CiAgICAgICAgICAgICAgdmFyIG5vZGUsIHZhbCwgZGVsdGEsIG1hc2sgPSBkYXRhLnBpeGVscy5yZXN1bHRNYXNrLCB2YWxUbXAsIHZhbFRtcFF1aWNrLCBjdXJyZW50Qml0OwogICAgICAgICAgICAgIHZhciBpLCBqLCBrLCBpaTsKICAgICAgICAgICAgICB2YXIgcHJldlZhbCA9IDA7CiAgICAgICAgICAgICAgaWYgKGJpdFBvcyA+IDApIHsKICAgICAgICAgICAgICAgIHNyY1B0cisrOwogICAgICAgICAgICAgICAgYml0UG9zID0gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdvcmQgPSBzdHVmZmVkRGF0YVtzcmNQdHJdOwogICAgICAgICAgICAgIHZhciBkZWx0YUVuY29kZSA9IGRhdGEuZW5jb2RlTW9kZSA9PT0gMTsKICAgICAgICAgICAgICB2YXIgcmVzdWx0UGl4ZWxzQWxsRGltID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KG51bVBpeGVscyAqIG51bURpbXMpOwogICAgICAgICAgICAgIHZhciByZXN1bHRQaXhlbHMgPSByZXN1bHRQaXhlbHNBbGxEaW07CiAgICAgICAgICAgICAgdmFyIGlEaW07CiAgICAgICAgICAgICAgZm9yIChpRGltID0gMDsgaURpbSA8IGhlYWRlckluZm8ubnVtRGltczsgaURpbSsrKSB7CiAgICAgICAgICAgICAgICBpZiAobnVtRGltcyA+IDEpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KHJlc3VsdFBpeGVsc0FsbERpbS5idWZmZXIsIG51bVBpeGVscyAqIGlEaW0sIG51bVBpeGVscyk7CiAgICAgICAgICAgICAgICAgIHByZXZWYWwgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGRhdGEuaGVhZGVySW5mby5udW1WYWxpZFBpeGVsID09PSB3aWR0aCAqIGhlaWdodCkgewogICAgICAgICAgICAgICAgICBmb3IgKGsgPSAwLCBpID0gMDsgaSA8IGhlaWdodDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IHdpZHRoOyBqKyssIGsrKykgewogICAgICAgICAgICAgICAgICAgICAgdmFsID0gMDsKICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcCA9IHdvcmQgPDwgYml0UG9zID4+PiAzMiAtIG51bUJpdHNMVVRRaWNrOwogICAgICAgICAgICAgICAgICAgICAgdmFsVG1wUXVpY2sgPSB2YWxUbXA7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoMzIgLSBiaXRQb3MgPCBudW1CaXRzTFVUUWljaykgewogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgfD0gc3R1ZmZlZERhdGFbc3JjUHRyICsgMV0gPj4+IDY0IC0gYml0UG9zIC0gbnVtQml0c0xVVFFpY2s7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGRlY29kZUx1dFt2YWxUbXBRdWlja10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gZGVjb2RlTHV0W3ZhbFRtcFF1aWNrXVsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgYml0UG9zICs9IGRlY29kZUx1dFt2YWxUbXBRdWlja11bMF07CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgPSB3b3JkIDw8IGJpdFBvcyA+Pj4gMzIgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXBRdWljayA9IHZhbFRtcDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKDMyIC0gYml0UG9zIDwgbnVtQml0c0xVVCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcCB8PSBzdHVmZmVkRGF0YVtzcmNQdHIgKyAxXSA+Pj4gNjQgLSBiaXRQb3MgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSB0cmVlOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGlpID0gMDsgaWkgPCBudW1CaXRzTFVUOyBpaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEJpdCA9IHZhbFRtcCA+Pj4gbnVtQml0c0xVVCAtIGlpIC0gMSAmIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGN1cnJlbnRCaXQgPyBub2RlLnJpZ2h0IDogbm9kZS5sZWZ0OwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKG5vZGUubGVmdCB8fCBub2RlLnJpZ2h0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gbm9kZS52YWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRQb3MgPSBiaXRQb3MgKyBpaSArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChiaXRQb3MgPj0gMzIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYml0UG9zIC09IDMyOwogICAgICAgICAgICAgICAgICAgICAgICBzcmNQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgd29yZCA9IHN0dWZmZWREYXRhW3NyY1B0cl07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBkZWx0YSA9IHZhbCAtIG9mZnNldDsKICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWx0YUVuY29kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSArPSBwcmV2VmFsOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGkgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGEgKz0gcmVzdWx0UGl4ZWxzW2sgLSB3aWR0aF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGEgKz0gcHJldlZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSAmPSAyNTU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1trXSA9IGRlbHRhOwogICAgICAgICAgICAgICAgICAgICAgICBwcmV2VmFsID0gZGVsdGE7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNba10gPSBkZWx0YTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZvciAoayA9IDAsIGkgPSAwOyBpIDwgaGVpZ2h0OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgd2lkdGg7IGorKywgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAobWFza1trXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgPSB3b3JkIDw8IGJpdFBvcyA+Pj4gMzIgLSBudW1CaXRzTFVUUWljazsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsVG1wUXVpY2sgPSB2YWxUbXA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgzMiAtIGJpdFBvcyA8IG51bUJpdHNMVVRRaWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsVG1wIHw9IHN0dWZmZWREYXRhW3NyY1B0ciArIDFdID4+PiA2NCAtIGJpdFBvcyAtIG51bUJpdHNMVVRRaWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWNvZGVMdXRbdmFsVG1wUXVpY2tdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gZGVjb2RlTHV0W3ZhbFRtcFF1aWNrXVsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRQb3MgKz0gZGVjb2RlTHV0W3ZhbFRtcFF1aWNrXVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxUbXAgPSB3b3JkIDw8IGJpdFBvcyA+Pj4gMzIgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcFF1aWNrID0gdmFsVG1wOwogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgzMiAtIGJpdFBvcyA8IG51bUJpdHNMVVQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRtcCB8PSBzdHVmZmVkRGF0YVtzcmNQdHIgKyAxXSA+Pj4gNjQgLSBiaXRQb3MgLSBudW1CaXRzTFVUOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsVG1wUXVpY2sgPSB2YWxUbXA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSB0cmVlOwogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaWkgPSAwOyBpaSA8IG51bUJpdHNMVVQ7IGlpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRCaXQgPSB2YWxUbXAgPj4+IG51bUJpdHNMVVQgLSBpaSAtIDEgJiAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGN1cnJlbnRCaXQgPyBub2RlLnJpZ2h0IDogbm9kZS5sZWZ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEobm9kZS5sZWZ0IHx8IG5vZGUucmlnaHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IG5vZGUudmFsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRQb3MgPSBiaXRQb3MgKyBpaSArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYml0UG9zID49IDMyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYml0UG9zIC09IDMyOwogICAgICAgICAgICAgICAgICAgICAgICAgIHNyY1B0cisrOwogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmQgPSBzdHVmZmVkRGF0YVtzcmNQdHJdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhID0gdmFsIC0gb2Zmc2V0OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVsdGFFbmNvZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA+IDAgJiYgbWFza1trIC0gMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhICs9IHByZXZWYWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpID4gMCAmJiBtYXNrW2sgLSB3aWR0aF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbHRhICs9IHJlc3VsdFBpeGVsc1trIC0gd2lkdGhdOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSArPSBwcmV2VmFsOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSAmPSAyNTU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW2tdID0gZGVsdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldlZhbCA9IGRlbHRhOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1trXSA9IGRlbHRhOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkYXRhLnB0ciA9IGRhdGEucHRyICsgKHNyY1B0ciArIDEpICogNCArIChiaXRQb3MgPiAwID8gNCA6IDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMgPSByZXN1bHRQaXhlbHNBbGxEaW07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlY29kZUJpdHM6IGZ1bmN0aW9uKGlucHV0LCBkYXRhLCBibG9ja0RhdGFCdWZmZXIsIG9mZnNldCwgaURpbSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBoZWFkZXJJbmZvID0gZGF0YS5oZWFkZXJJbmZvOwogICAgICAgICAgICAgICAgdmFyIGZpbGVWZXJzaW9uID0gaGVhZGVySW5mby5maWxlVmVyc2lvbjsKICAgICAgICAgICAgICAgIHZhciBibG9ja1B0ciA9IDA7CiAgICAgICAgICAgICAgICB2YXIgdmlldyA9IG5ldyBEYXRhVmlldyhpbnB1dCwgZGF0YS5wdHIsIDUpOwogICAgICAgICAgICAgICAgdmFyIGhlYWRlckJ5dGUgPSB2aWV3LmdldFVpbnQ4KDApOwogICAgICAgICAgICAgICAgYmxvY2tQdHIrKzsKICAgICAgICAgICAgICAgIHZhciBiaXRzNjcgPSBoZWFkZXJCeXRlID4+IDY7CiAgICAgICAgICAgICAgICB2YXIgbiA9IGJpdHM2NyA9PT0gMCA/IDQgOiAzIC0gYml0czY3OwogICAgICAgICAgICAgICAgdmFyIGRvTHV0ID0gKGhlYWRlckJ5dGUgJiAzMikgPiAwID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgdmFyIG51bUJpdHMgPSBoZWFkZXJCeXRlICYgMzE7CiAgICAgICAgICAgICAgICB2YXIgbnVtRWxlbWVudHMgPSAwOwogICAgICAgICAgICAgICAgaWYgKG4gPT09IDEpIHsKICAgICAgICAgICAgICAgICAgbnVtRWxlbWVudHMgPSB2aWV3LmdldFVpbnQ4KGJsb2NrUHRyKTsKICAgICAgICAgICAgICAgICAgYmxvY2tQdHIrKzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobiA9PT0gMikgewogICAgICAgICAgICAgICAgICBudW1FbGVtZW50cyA9IHZpZXcuZ2V0VWludDE2KGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobiA9PT0gNCkgewogICAgICAgICAgICAgICAgICBudW1FbGVtZW50cyA9IHZpZXcuZ2V0VWludDMyKGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgKz0gNDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRocm93ICJJbnZhbGlkIHZhbGlkIHBpeGVsIGNvdW50IHR5cGUiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHNjYWxlID0gMiAqIGhlYWRlckluZm8ubWF4WkVycm9yOwogICAgICAgICAgICAgICAgdmFyIHN0dWZmZWREYXRhLCBhcnJheUJ1Ziwgc3RvcmU4LCBkYXRhQnl0ZXMsIGRhdGFXb3JkczsKICAgICAgICAgICAgICAgIHZhciBsdXRBcnIsIGx1dERhdGEsIGx1dEJ5dGVzLCBsdXRCaXRzUGVyRWxlbWVudCwgYml0c1BlclBpeGVsOwogICAgICAgICAgICAgICAgdmFyIHpNYXggPSBoZWFkZXJJbmZvLm51bURpbXMgPiAxID8gaGVhZGVySW5mby5tYXhWYWx1ZXNbaURpbV0gOiBoZWFkZXJJbmZvLnpNYXg7CiAgICAgICAgICAgICAgICBpZiAoZG9MdXQpIHsKICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLmx1dCsrOwogICAgICAgICAgICAgICAgICBsdXRCeXRlcyA9IHZpZXcuZ2V0VWludDgoYmxvY2tQdHIpOwogICAgICAgICAgICAgICAgICBsdXRCaXRzUGVyRWxlbWVudCA9IG51bUJpdHM7CiAgICAgICAgICAgICAgICAgIGJsb2NrUHRyKys7CiAgICAgICAgICAgICAgICAgIGRhdGFCeXRlcyA9IE1hdGguY2VpbCgobHV0Qnl0ZXMgLSAxKSAqIG51bUJpdHMgLyA4KTsKICAgICAgICAgICAgICAgICAgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBkYXRhLnB0ciArPSBibG9ja1B0cjsKICAgICAgICAgICAgICAgICAgc3RvcmU4LnNldChuZXcgVWludDhBcnJheShpbnB1dCwgZGF0YS5wdHIsIGRhdGFCeXRlcykpOwogICAgICAgICAgICAgICAgICBsdXREYXRhID0gbmV3IFVpbnQzMkFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gZGF0YUJ5dGVzOwogICAgICAgICAgICAgICAgICBiaXRzUGVyUGl4ZWwgPSAwOwogICAgICAgICAgICAgICAgICB3aGlsZSAobHV0Qnl0ZXMgLSAxID4+PiBiaXRzUGVyUGl4ZWwpIHsKICAgICAgICAgICAgICAgICAgICBiaXRzUGVyUGl4ZWwrKzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkYXRhQnl0ZXMgPSBNYXRoLmNlaWwobnVtRWxlbWVudHMgKiBiaXRzUGVyUGl4ZWwgLyA4KTsKICAgICAgICAgICAgICAgICAgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICBhcnJheUJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcihkYXRhV29yZHMgKiA0KTsKICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBkYXRhLnB0ciwgZGF0YUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgIHN0dWZmZWREYXRhID0gbmV3IFVpbnQzMkFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gZGF0YUJ5dGVzOwogICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAgICAgIGx1dEFyciA9IEJpdFN0dWZmZXIudW5zdHVmZkxVVDIobHV0RGF0YSwgbnVtQml0cywgbHV0Qnl0ZXMgLSAxLCBvZmZzZXQsIHNjYWxlLCB6TWF4KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsdXRBcnIgPSBCaXRTdHVmZmVyLnVuc3R1ZmZMVVQobHV0RGF0YSwgbnVtQml0cywgbHV0Qnl0ZXMgLSAxLCBvZmZzZXQsIHNjYWxlLCB6TWF4KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAgICAgIEJpdFN0dWZmZXIudW5zdHVmZjIoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgbHV0QXJyKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBCaXRTdHVmZmVyLnVuc3R1ZmYoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgbHV0QXJyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLmJpdHN0dWZmZXIrKzsKICAgICAgICAgICAgICAgICAgYml0c1BlclBpeGVsID0gbnVtQml0czsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gYmxvY2tQdHI7CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzUGVyUGl4ZWwgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YUJ5dGVzID0gTWF0aC5jZWlsKG51bUVsZW1lbnRzICogYml0c1BlclBpeGVsIC8gOCk7CiAgICAgICAgICAgICAgICAgICAgZGF0YVdvcmRzID0gTWF0aC5jZWlsKGRhdGFCeXRlcyAvIDQpOwogICAgICAgICAgICAgICAgICAgIGFycmF5QnVmID0gbmV3IEFycmF5QnVmZmVyKGRhdGFXb3JkcyAqIDQpOwogICAgICAgICAgICAgICAgICAgIHN0b3JlOCA9IG5ldyBVaW50OEFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgICBzdG9yZTguc2V0KG5ldyBVaW50OEFycmF5KGlucHV0LCBkYXRhLnB0ciwgZGF0YUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgICAgc3R1ZmZlZERhdGEgPSBuZXcgVWludDMyQXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IGRhdGFCeXRlczsKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPj0gMykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKG9mZnNldCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEJpdFN0dWZmZXIub3JpZ2luYWxVbnN0dWZmMihzdHVmZmVkRGF0YSwgYmxvY2tEYXRhQnVmZmVyLCBiaXRzUGVyUGl4ZWwsIG51bUVsZW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEJpdFN0dWZmZXIudW5zdHVmZjIoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgZmFsc2UsIG9mZnNldCwgc2NhbGUsIHpNYXgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAob2Zmc2V0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgQml0U3R1ZmZlci5vcmlnaW5hbFVuc3R1ZmYoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBCaXRTdHVmZmVyLnVuc3R1ZmYoc3R1ZmZlZERhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgYml0c1BlclBpeGVsLCBudW1FbGVtZW50cywgZmFsc2UsIG9mZnNldCwgc2NhbGUsIHpNYXgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVhZFRpbGVzOiBmdW5jdGlvbihpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpIHsKICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IGRhdGEuaGVhZGVySW5mbzsKICAgICAgICAgICAgICB2YXIgd2lkdGggPSBoZWFkZXJJbmZvLndpZHRoOwogICAgICAgICAgICAgIHZhciBoZWlnaHQgPSBoZWFkZXJJbmZvLmhlaWdodDsKICAgICAgICAgICAgICB2YXIgbWljcm9CbG9ja1NpemUgPSBoZWFkZXJJbmZvLm1pY3JvQmxvY2tTaXplOwogICAgICAgICAgICAgIHZhciBpbWFnZVR5cGUgPSBoZWFkZXJJbmZvLmltYWdlVHlwZTsKICAgICAgICAgICAgICB2YXIgZGF0YVR5cGVTaXplID0gTGVyYzJIZWxwZXJzLmdldERhdGFUeXBlU2l6ZShpbWFnZVR5cGUpOwogICAgICAgICAgICAgIHZhciBudW1CbG9ja3NYID0gTWF0aC5jZWlsKHdpZHRoIC8gbWljcm9CbG9ja1NpemUpOwogICAgICAgICAgICAgIHZhciBudW1CbG9ja3NZID0gTWF0aC5jZWlsKGhlaWdodCAvIG1pY3JvQmxvY2tTaXplKTsKICAgICAgICAgICAgICBkYXRhLnBpeGVscy5udW1CbG9ja3NZID0gbnVtQmxvY2tzWTsKICAgICAgICAgICAgICBkYXRhLnBpeGVscy5udW1CbG9ja3NYID0gbnVtQmxvY2tzWDsKICAgICAgICAgICAgICBkYXRhLnBpeGVscy5wdHIgPSAwOwogICAgICAgICAgICAgIHZhciByb3cgPSAwLCBjb2wgPSAwLCBibG9ja1kgPSAwLCBibG9ja1ggPSAwLCB0aGlzQmxvY2tIZWlnaHQgPSAwLCB0aGlzQmxvY2tXaWR0aCA9IDAsIGJ5dGVzTGVmdCA9IDAsIGhlYWRlckJ5dGUgPSAwLCBiaXRzNjcgPSAwLCB0ZXN0Q29kZSA9IDAsIG91dFB0ciA9IDAsIG91dFN0cmlkZSA9IDAsIG51bUJ5dGVzID0gMCwgYnl0ZXNsZWZ0ID0gMCwgeiA9IDAsIGJsb2NrUHRyID0gMDsKICAgICAgICAgICAgICB2YXIgdmlldywgYmxvY2ssIGFycmF5QnVmLCBzdG9yZTgsIHJhd0RhdGE7CiAgICAgICAgICAgICAgdmFyIGJsb2NrRW5jb2Rpbmc7CiAgICAgICAgICAgICAgdmFyIGJsb2NrRGF0YUJ1ZmZlciA9IG5ldyBPdXRQaXhlbFR5cGVBcnJheShtaWNyb0Jsb2NrU2l6ZSAqIG1pY3JvQmxvY2tTaXplKTsKICAgICAgICAgICAgICB2YXIgbGFzdEJsb2NrSGVpZ2h0ID0gaGVpZ2h0ICUgbWljcm9CbG9ja1NpemUgfHwgbWljcm9CbG9ja1NpemU7CiAgICAgICAgICAgICAgdmFyIGxhc3RCbG9ja1dpZHRoID0gd2lkdGggJSBtaWNyb0Jsb2NrU2l6ZSB8fCBtaWNyb0Jsb2NrU2l6ZTsKICAgICAgICAgICAgICB2YXIgb2Zmc2V0VHlwZSwgb2Zmc2V0OwogICAgICAgICAgICAgIHZhciBudW1EaW1zID0gaGVhZGVySW5mby5udW1EaW1zLCBpRGltOwogICAgICAgICAgICAgIHZhciBtYXNrID0gZGF0YS5waXhlbHMucmVzdWx0TWFzazsKICAgICAgICAgICAgICB2YXIgcmVzdWx0UGl4ZWxzID0gZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzOwogICAgICAgICAgICAgIGZvciAoYmxvY2tZID0gMDsgYmxvY2tZIDwgbnVtQmxvY2tzWTsgYmxvY2tZKyspIHsKICAgICAgICAgICAgICAgIHRoaXNCbG9ja0hlaWdodCA9IGJsb2NrWSAhPT0gbnVtQmxvY2tzWSAtIDEgPyBtaWNyb0Jsb2NrU2l6ZSA6IGxhc3RCbG9ja0hlaWdodDsKICAgICAgICAgICAgICAgIGZvciAoYmxvY2tYID0gMDsgYmxvY2tYIDwgbnVtQmxvY2tzWDsgYmxvY2tYKyspIHsKICAgICAgICAgICAgICAgICAgdGhpc0Jsb2NrV2lkdGggPSBibG9ja1ggIT09IG51bUJsb2Nrc1ggLSAxID8gbWljcm9CbG9ja1NpemUgOiBsYXN0QmxvY2tXaWR0aDsKICAgICAgICAgICAgICAgICAgb3V0UHRyID0gYmxvY2tZICogd2lkdGggKiBtaWNyb0Jsb2NrU2l6ZSArIGJsb2NrWCAqIG1pY3JvQmxvY2tTaXplOwogICAgICAgICAgICAgICAgICBvdXRTdHJpZGUgPSB3aWR0aCAtIHRoaXNCbG9ja1dpZHRoOwogICAgICAgICAgICAgICAgICBmb3IgKGlEaW0gPSAwOyBpRGltIDwgbnVtRGltczsgaURpbSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG51bURpbXMgPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHMgPSBuZXcgT3V0UGl4ZWxUeXBlQXJyYXkoZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzLmJ1ZmZlciwgd2lkdGggKiBoZWlnaHQgKiBpRGltICogZGF0YVR5cGVTaXplLCB3aWR0aCAqIGhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJ5dGVzTGVmdCA9IGlucHV0LmJ5dGVMZW5ndGggLSBkYXRhLnB0cjsKICAgICAgICAgICAgICAgICAgICB2aWV3ID0gbmV3IERhdGFWaWV3KGlucHV0LCBkYXRhLnB0ciwgTWF0aC5taW4oMTAsIGJ5dGVzTGVmdCkpOwogICAgICAgICAgICAgICAgICAgIGJsb2NrID0ge307CiAgICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgPSAwOwogICAgICAgICAgICAgICAgICAgIGhlYWRlckJ5dGUgPSB2aWV3LmdldFVpbnQ4KDApOwogICAgICAgICAgICAgICAgICAgIGJsb2NrUHRyKys7CiAgICAgICAgICAgICAgICAgICAgYml0czY3ID0gaGVhZGVyQnl0ZSA+PiA2ICYgMjU1OwogICAgICAgICAgICAgICAgICAgIHRlc3RDb2RlID0gaGVhZGVyQnl0ZSA+PiAyICYgMTU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RDb2RlICE9PSAoYmxvY2tYICogbWljcm9CbG9ja1NpemUgPj4gMyAmIDE1KSkgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgImludGVncml0eSBpc3N1ZSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJsb2NrRW5jb2RpbmcgPSBoZWFkZXJCeXRlICYgMzsKICAgICAgICAgICAgICAgICAgICBpZiAoYmxvY2tFbmNvZGluZyA+IDMpIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IGJsb2NrUHRyOwogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgIkludmFsaWQgYmxvY2sgZW5jb2RpbmcgKCIgKyBibG9ja0VuY29kaW5nICsgIikiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2tFbmNvZGluZyA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLmNvbnN0YW50Kys7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB0ciArPSBibG9ja1B0cjsKICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmxvY2tFbmNvZGluZyA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgZGF0YS5jb3VudGVyLnVuY29tcHJlc3NlZCsrOwogICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdHIgKz0gYmxvY2tQdHI7CiAgICAgICAgICAgICAgICAgICAgICBudW1CeXRlcyA9IHRoaXNCbG9ja0hlaWdodCAqIHRoaXNCbG9ja1dpZHRoICogZGF0YVR5cGVTaXplOwogICAgICAgICAgICAgICAgICAgICAgYnl0ZXNsZWZ0ID0gaW5wdXQuYnl0ZUxlbmd0aCAtIGRhdGEucHRyOwogICAgICAgICAgICAgICAgICAgICAgbnVtQnl0ZXMgPSBudW1CeXRlcyA8IGJ5dGVzbGVmdCA/IG51bUJ5dGVzIDogYnl0ZXNsZWZ0OwogICAgICAgICAgICAgICAgICAgICAgYXJyYXlCdWYgPSBuZXcgQXJyYXlCdWZmZXIobnVtQnl0ZXMgJSBkYXRhVHlwZVNpemUgPT09IDAgPyBudW1CeXRlcyA6IG51bUJ5dGVzICsgZGF0YVR5cGVTaXplIC0gbnVtQnl0ZXMgJSBkYXRhVHlwZVNpemUpOwogICAgICAgICAgICAgICAgICAgICAgc3RvcmU4ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWYpOwogICAgICAgICAgICAgICAgICAgICAgc3RvcmU4LnNldChuZXcgVWludDhBcnJheShpbnB1dCwgZGF0YS5wdHIsIG51bUJ5dGVzKSk7CiAgICAgICAgICAgICAgICAgICAgICByYXdEYXRhID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KGFycmF5QnVmKTsKICAgICAgICAgICAgICAgICAgICAgIHogPSAwOwogICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChyb3cgPSAwOyByb3cgPCB0aGlzQmxvY2tIZWlnaHQ7IHJvdysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW291dFB0cl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW291dFB0cl0gPSByYXdEYXRhW3orK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChyb3cgPSAwOyByb3cgPCB0aGlzQmxvY2tIZWlnaHQ7IHJvdysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHIrK10gPSByYXdEYXRhW3orK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0ciArPSBvdXRTdHJpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IHogKiBkYXRhVHlwZVNpemU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIG9mZnNldFR5cGUgPSBMZXJjMkhlbHBlcnMuZ2V0RGF0YVR5cGVVc2VkKGltYWdlVHlwZSwgYml0czY3KTsKICAgICAgICAgICAgICAgICAgICAgIG9mZnNldCA9IExlcmMySGVscGVycy5nZXRPbmVQaXhlbChibG9jaywgYmxvY2tQdHIsIG9mZnNldFR5cGUsIHZpZXcpOwogICAgICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgKz0gTGVyYzJIZWxwZXJzLmdldERhdGFUeXBlU2l6ZShvZmZzZXRUeXBlKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChibG9ja0VuY29kaW5nID09PSAzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyICs9IGJsb2NrUHRyOwogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmNvdW50ZXIuY29uc3RhbnRvZmZzZXQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHJvdyA9IDA7IHJvdyA8IHRoaXNCbG9ja0hlaWdodDsgcm93KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29sID0gMDsgY29sIDwgdGhpc0Jsb2NrV2lkdGg7IGNvbCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW291dFB0cl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNbb3V0UHRyXSA9IG9mZnNldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRQdHIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0ciArPSBvdXRTdHJpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAocm93ID0gMDsgcm93IDwgdGhpc0Jsb2NrSGVpZ2h0OyByb3crKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0UGl4ZWxzW291dFB0cisrXSA9IG9mZnNldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0ciArPSBvdXRTdHJpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB0ciArPSBibG9ja1B0cjsKICAgICAgICAgICAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLmRlY29kZUJpdHMoaW5wdXQsIGRhdGEsIGJsb2NrRGF0YUJ1ZmZlciwgb2Zmc2V0LCBpRGltKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tQdHIgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFzaykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAocm93ID0gMDsgcm93IDwgdGhpc0Jsb2NrSGVpZ2h0OyByb3crKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzQmxvY2tXaWR0aDsgY29sKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hc2tbb3V0UHRyXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFBpeGVsc1tvdXRQdHJdID0gYmxvY2tEYXRhQnVmZmVyW2Jsb2NrUHRyKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dFB0cisrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChyb3cgPSAwOyByb3cgPCB0aGlzQmxvY2tIZWlnaHQ7IHJvdysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbCA9IDA7IGNvbCA8IHRoaXNCbG9ja1dpZHRoOyBjb2wrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRQaXhlbHNbb3V0UHRyKytdID0gYmxvY2tEYXRhQnVmZmVyW2Jsb2NrUHRyKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0UHRyICs9IG91dFN0cmlkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKioqKioqKioqKioqKioqKgogICAgICAgICAgICAqICBwcml2YXRlIG1ldGhvZHMgKGhlbHBlciBtZXRob2RzKQogICAgICAgICAgICAqKioqKioqKioqKioqKioqKi8KICAgICAgICAgICAgZm9ybWF0RmlsZUluZm86IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgImZpbGVJZGVudGlmaWVyU3RyaW5nIjogZGF0YS5oZWFkZXJJbmZvLmZpbGVJZGVudGlmaWVyU3RyaW5nLAogICAgICAgICAgICAgICAgImZpbGVWZXJzaW9uIjogZGF0YS5oZWFkZXJJbmZvLmZpbGVWZXJzaW9uLAogICAgICAgICAgICAgICAgImltYWdlVHlwZSI6IGRhdGEuaGVhZGVySW5mby5pbWFnZVR5cGUsCiAgICAgICAgICAgICAgICAiaGVpZ2h0IjogZGF0YS5oZWFkZXJJbmZvLmhlaWdodCwKICAgICAgICAgICAgICAgICJ3aWR0aCI6IGRhdGEuaGVhZGVySW5mby53aWR0aCwKICAgICAgICAgICAgICAgICJudW1WYWxpZFBpeGVsIjogZGF0YS5oZWFkZXJJbmZvLm51bVZhbGlkUGl4ZWwsCiAgICAgICAgICAgICAgICAibWljcm9CbG9ja1NpemUiOiBkYXRhLmhlYWRlckluZm8ubWljcm9CbG9ja1NpemUsCiAgICAgICAgICAgICAgICAiYmxvYlNpemUiOiBkYXRhLmhlYWRlckluZm8uYmxvYlNpemUsCiAgICAgICAgICAgICAgICAibWF4WkVycm9yIjogZGF0YS5oZWFkZXJJbmZvLm1heFpFcnJvciwKICAgICAgICAgICAgICAgICJwaXhlbFR5cGUiOiBMZXJjMkhlbHBlcnMuZ2V0UGl4ZWxUeXBlKGRhdGEuaGVhZGVySW5mby5pbWFnZVR5cGUpLAogICAgICAgICAgICAgICAgImVvZk9mZnNldCI6IGRhdGEuZW9mT2Zmc2V0LAogICAgICAgICAgICAgICAgIm1hc2siOiBkYXRhLm1hc2sgPyB7CiAgICAgICAgICAgICAgICAgICJudW1CeXRlcyI6IGRhdGEubWFzay5udW1CeXRlcwogICAgICAgICAgICAgICAgfSA6IG51bGwsCiAgICAgICAgICAgICAgICAicGl4ZWxzIjogewogICAgICAgICAgICAgICAgICAibnVtQmxvY2tzWCI6IGRhdGEucGl4ZWxzLm51bUJsb2Nrc1gsCiAgICAgICAgICAgICAgICAgICJudW1CbG9ja3NZIjogZGF0YS5waXhlbHMubnVtQmxvY2tzWSwKICAgICAgICAgICAgICAgICAgLy8ibnVtQnl0ZXMiOiBkYXRhLnBpeGVscy5udW1CeXRlcywKICAgICAgICAgICAgICAgICAgIm1heFZhbHVlIjogZGF0YS5oZWFkZXJJbmZvLnpNYXgsCiAgICAgICAgICAgICAgICAgICJtaW5WYWx1ZSI6IGRhdGEuaGVhZGVySW5mby56TWluLAogICAgICAgICAgICAgICAgICAibm9EYXRhVmFsdWUiOiBkYXRhLm5vRGF0YVZhbHVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY29uc3RydWN0Q29uc3RhbnRTdXJmYWNlOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgdmFyIHZhbCA9IGRhdGEuaGVhZGVySW5mby56TWF4OwogICAgICAgICAgICAgIHZhciBudW1EaW1zID0gZGF0YS5oZWFkZXJJbmZvLm51bURpbXM7CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVscyA9IGRhdGEuaGVhZGVySW5mby5oZWlnaHQgKiBkYXRhLmhlYWRlckluZm8ud2lkdGg7CiAgICAgICAgICAgICAgdmFyIG51bVBpeGVsQWxsRGltcyA9IG51bVBpeGVscyAqIG51bURpbXM7CiAgICAgICAgICAgICAgdmFyIGkgPSAwLCBrID0gMCwgblN0YXJ0ID0gMDsKICAgICAgICAgICAgICB2YXIgbWFzayA9IGRhdGEucGl4ZWxzLnJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgaWYgKG1hc2spIHsKICAgICAgICAgICAgICAgIGlmIChudW1EaW1zID4gMSkgewogICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtRGltczsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgblN0YXJ0ID0gaSAqIG51bVBpeGVsczsKICAgICAgICAgICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgbnVtUGl4ZWxzOyBrKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW2tdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucGl4ZWxzLnJlc3VsdFBpeGVsc1tuU3RhcnQgKyBrXSA9IHZhbDsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBudW1QaXhlbHM7IGsrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChtYXNrW2tdKSB7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHNba10gPSB2YWw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMuZmlsbCkgewogICAgICAgICAgICAgICAgICBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMuZmlsbCh2YWwpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZm9yIChrID0gMDsgayA8IG51bVBpeGVsQWxsRGltczsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzW2tdID0gdmFsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0RGF0YVR5cGVBcnJheTogZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIHZhciB0cDsKICAgICAgICAgICAgICBzd2l0Y2ggKHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgdHAgPSBJbnQ4QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICB0cCA9IFVpbnQ4QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICB0cCA9IEludDE2QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICB0cCA9IFVpbnQxNkFycmF5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgICAgdHAgPSBJbnQzMkFycmF5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgICAgdHAgPSBVaW50MzJBcnJheTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgIHRwID0gRmxvYXQzMkFycmF5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgICAgdHAgPSBGbG9hdDY0QXJyYXk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgdHAgPSBGbG9hdDMyQXJyYXk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0cDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0UGl4ZWxUeXBlOiBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgdmFyIHRwOwogICAgICAgICAgICAgIHN3aXRjaCAodCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICB0cCA9ICJTOCI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICB0cCA9ICJVOCI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICB0cCA9ICJTMTYiOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgdHAgPSAiVTE2IjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgIHRwID0gIlMzMiI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICB0cCA9ICJVMzIiOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgICAgdHAgPSAiRjMyIjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICAgIHRwID0gIkY2NCI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgdHAgPSAiRjMyIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRwOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc1ZhbGlkUGl4ZWxWYWx1ZTogZnVuY3Rpb24odCwgdmFsKSB7CiAgICAgICAgICAgICAgaWYgKHZhbCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBpc1ZhbGlkOwogICAgICAgICAgICAgIHN3aXRjaCAodCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IC0xMjggJiYgdmFsIDw9IDEyNzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSB2YWwgPj0gMCAmJiB2YWwgPD0gMjU1OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IHZhbCA+PSAtMzI3NjggJiYgdmFsIDw9IDMyNzY3OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgaXNWYWxpZCA9IHZhbCA+PSAwICYmIHZhbCA8PSA2NTUzNjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSB2YWwgPj0gLTIxNDc0ODM2NDggJiYgdmFsIDw9IDIxNDc0ODM2NDc7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IDAgJiYgdmFsIDw9IDQyOTQ5NjcyOTY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IC0zNDAyNzk5OTM4NzkwMTQ4NGUyMiAmJiB2YWwgPD0gMzQwMjc5OTkzODc5MDE0ODRlMjI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICBpc1ZhbGlkID0gdmFsID49IDVlLTMyNCAmJiB2YWwgPD0gMTc5NzY5MzEzNDg2MjMxNTdlMjkyOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIGlzVmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGlzVmFsaWQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldERhdGFUeXBlU2l6ZTogZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIHZhciBzID0gMDsKICAgICAgICAgICAgICBzd2l0Y2ggKHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgICAgcyA9IDE7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICBzID0gMjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgIHMgPSA0OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgICAgcyA9IDg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgcyA9IHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXREYXRhVHlwZVVzZWQ6IGZ1bmN0aW9uKGR0LCB0YykgewogICAgICAgICAgICAgIHZhciB0ID0gZHQ7CiAgICAgICAgICAgICAgc3dpdGNoIChkdCkgewogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICB0ID0gZHQgLSB0YzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgICAgIHQgPSBkdCAtIDIgKiB0YzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgIGlmICgwID09PSB0YykgewogICAgICAgICAgICAgICAgICAgIHQgPSBkdDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgxID09PSB0YykgewogICAgICAgICAgICAgICAgICAgIHQgPSAyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHQgPSAxOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICBpZiAoMCA9PT0gdGMpIHsKICAgICAgICAgICAgICAgICAgICB0ID0gZHQ7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdCA9IGR0IC0gMiAqIHRjICsgMTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHQgPSBkdDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0OwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXRPbmVQaXhlbDogZnVuY3Rpb24oYmxvY2ssIGJsb2NrUHRyLCBvZmZzZXRUeXBlLCB2aWV3KSB7CiAgICAgICAgICAgICAgdmFyIHRlbXAgPSAwOwogICAgICAgICAgICAgIHN3aXRjaCAob2Zmc2V0VHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRJbnQ4KGJsb2NrUHRyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgIHRlbXAgPSB2aWV3LmdldFVpbnQ4KGJsb2NrUHRyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICAgIHRlbXAgPSB2aWV3LmdldEludDE2KGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgIHRlbXAgPSB2aWV3LmdldFVpbnQxNihibG9ja1B0ciwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRJbnQzMihibG9ja1B0ciwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRVSW50MzIoYmxvY2tQdHIsIHRydWUpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgICAgdGVtcCA9IHZpZXcuZ2V0RmxvYXQzMihibG9ja1B0ciwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICB0ZW1wID0gdmlldy5nZXRGbG9hdDY0KGJsb2NrUHRyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICB0aHJvdyAidGhlIGRlY29kZXIgZG9lcyBub3QgdW5kZXJzdGFuZCB0aGlzIHBpeGVsIHR5cGUiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdGVtcDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBUcmVlTm9kZSA9IGZ1bmN0aW9uKHZhbCwgbGVmdCwgcmlnaHQpIHsKICAgICAgICAgICAgdGhpcy52YWwgPSB2YWw7CiAgICAgICAgICAgIHRoaXMubGVmdCA9IGxlZnQ7CiAgICAgICAgICAgIHRoaXMucmlnaHQgPSByaWdodDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgTGVyYzJEZWNvZGUyID0gewogICAgICAgICAgICAvKgogICAgICAgICAgICAqICoqKioqKioqcmVtb3ZlZCBvcHRpb25zIGNvbXBhcmVkIHRvIExFUkMxLiBXZSBjYW4gYnJpbmcgc29tZSBvZiB0aGVtIGJhY2sgaWYgbmVlZGVkLgogICAgICAgICAgICAgKiByZW1vdmVkIHBpeGVsIHR5cGUuIExFUkMyIGlzIHR5cGVkIGFuZCBkb2Vzbid0IHJlcXVpcmUgdXNlciB0byBnaXZlIHBpeGVsIHR5cGUKICAgICAgICAgICAgICogY2hhbmdlZCBlbmNvZGVkTWFza0RhdGEgdG8gbWFza0RhdGEuIExFUkMyICdzIGpzIHZlcnNpb24gbWFrZSBpdCBmYXN0ZXIgdG8gdXNlIG1hc2tEYXRhIGRpcmVjdGx5LgogICAgICAgICAgICAgKiByZW1vdmVkIHJldHVybk1hc2suIG1hc2sgaXMgdXNlZCBieSBMRVJDMiBpbnRlcm5hbGx5IGFuZCBpcyBjb3N0IGZyZWUuIEluIGNhc2Ugb2YgdXNlciBpbnB1dCBtYXNrLCBpdCdzIHJldHVybmVkIGFzIHdlbGwgYW5kIGhhcyBuZWdsaWJsZSBjb3N0LgogICAgICAgICAgICAgKiByZW1vdmVkIG5vZGF0YXZhbHVlLiBCZWNhdXNlIExFUkMyIHBpeGVscyBhcmUgdHlwZWQsIG5vZGF0YXZhbHVlIHdpbGwgc2FjcmlmeSBhIHVzZWZ1bCB2YWx1ZSBmb3IgbWFueSB0eXBlcyAoOGJpdCwgMTZiaXQpIGV0YywKICAgICAgICAgICAgICogICAgICAgdXNlciBoYXMgdG8gYmUga25vd2xlZGdhYmxlIGVub3VnaCBhYm91dCByYXN0ZXIgYW5kIHRoZWlyIGRhdGEgdG8gYXZvaWQgdXNhYmlsaXR5IGlzc3Vlcy4gc28gbm9kYXRhIHZhbHVlIGlzIHNpbXBseSByZW1vdmVkIG5vdy4KICAgICAgICAgICAgICogICAgICAgV2UgY2FuIGFkZCBpdCBiYWNrIGxhdGVyIGlmIHRoZWlyJ3MgYSBjbGVhciByZXF1aXJlbWVudC4KICAgICAgICAgICAgICogcmVtb3ZlZCBlbmNvZGVkTWFzay4gVGhpcyBvcHRpb24gd2FzIG5vdCBpbXBsZW1lbnRlZCBpbiBMZXJjRGVjb2RlLiBJdCBjYW4gYmUgZG9uZSBhZnRlciBkZWNvZGluZyAobGVzcyBlZmZpY2llbnQpCiAgICAgICAgICAgICAqIHJlbW92ZWQgY29tcHV0ZVVzZWRCaXREZXB0aHMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIHJlc3BvbnNlIGNoYW5nZXMgY29tcGFyZWQgdG8gTEVSQzEKICAgICAgICAgICAgICogMS4gZW5jb2RlZE1hc2tEYXRhIGlzIG5vdCBhdmFpbGFibGUKICAgICAgICAgICAgICogMi4gbm9EYXRhVmFsdWUgaXMgb3B0aW9uYWwgKHJldHVybnMgb25seSBpZiB1c2VyJ3Mgbm9EYXRhVmFsdWUgaXMgd2l0aCBpbiB0aGUgdmFsaWQgZGF0YSB0eXBlIHJhbmdlKQogICAgICAgICAgICAgKiAzLiBtYXNrRGF0YSBpcyBhbHdheXMgYXZhaWxhYmxlCiAgICAgICAgICAgICovCiAgICAgICAgICAgIC8qKioqKioqKioqKioqKioqKgogICAgICAgICAgICAqICBwdWJsaWMgcHJvcGVydGllcwogICAgICAgICAgICAqKioqKioqKioqKioqKioqKiovCiAgICAgICAgICAgIC8vSFVGRk1BTl9MVVRfQklUU19NQVg6IDEyLCAvL3VzZSAyXjEyIGx1dCwgbm90IGNvbmZpZ3VyYWJsZQogICAgICAgICAgICAvKioqKioqKioqKioqKioqKioKICAgICAgICAgICAgKiAgcHVibGljIG1ldGhvZHMKICAgICAgICAgICAgKioqKioqKioqKioqKioqKiovCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBEZWNvZGUgYSBMRVJDMiBieXRlIHN0cmVhbSBhbmQgcmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIHRoZSBwaXhlbCBkYXRhIGFuZCBvcHRpb25hbCBtZXRhZGF0YS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtBcnJheUJ1ZmZlcn0gaW5wdXQgVGhlIExFUkMgaW5wdXQgYnl0ZSBzdHJlYW0KICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSBvcHRpb25zIERlY29kaW5nIG9wdGlvbnMKICAgICAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IFtvcHRpb25zLmlucHV0T2Zmc2V0XSBUaGUgbnVtYmVyIG9mIGJ5dGVzIHRvIHNraXAgaW4gdGhlIGlucHV0IGJ5dGUgc3RyZWFtLiBBIHZhbGlkIExFUkMgZmlsZSBpcyBleHBlY3RlZCBhdCB0aGF0IHBvc2l0aW9uCiAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMucmV0dXJuRmlsZUluZm9dIElmIHRydWUsIHRoZSByZXR1cm4gdmFsdWUgd2lsbCBoYXZlIGEgZmlsZUluZm8gcHJvcGVydHkgdGhhdCBjb250YWlucyBtZXRhZGF0YSBvYnRhaW5lZCBmcm9tIHRoZSBMRVJDIGhlYWRlcnMgYW5kIHRoZSBkZWNvZGluZyBwcm9jZXNzCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBkZWNvZGU6IGZ1bmN0aW9uKGlucHV0LCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICAgICAgdmFyIG5vRGF0YVZhbHVlID0gb3B0aW9ucy5ub0RhdGFWYWx1ZTsKICAgICAgICAgICAgICB2YXIgaSA9IDAsIGRhdGEgPSB7fTsKICAgICAgICAgICAgICBkYXRhLnB0ciA9IG9wdGlvbnMuaW5wdXRPZmZzZXQgfHwgMDsKICAgICAgICAgICAgICBkYXRhLnBpeGVscyA9IHt9OwogICAgICAgICAgICAgIGlmICghTGVyYzJIZWxwZXJzLnJlYWRIZWFkZXJJbmZvKGlucHV0LCBkYXRhKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgaGVhZGVySW5mbyA9IGRhdGEuaGVhZGVySW5mbzsKICAgICAgICAgICAgICB2YXIgZmlsZVZlcnNpb24gPSBoZWFkZXJJbmZvLmZpbGVWZXJzaW9uOwogICAgICAgICAgICAgIHZhciBPdXRQaXhlbFR5cGVBcnJheSA9IExlcmMySGVscGVycy5nZXREYXRhVHlwZUFycmF5KGhlYWRlckluZm8uaW1hZ2VUeXBlKTsKICAgICAgICAgICAgICBMZXJjMkhlbHBlcnMucmVhZE1hc2soaW5wdXQsIGRhdGEpOwogICAgICAgICAgICAgIGlmIChoZWFkZXJJbmZvLm51bVZhbGlkUGl4ZWwgIT09IGhlYWRlckluZm8ud2lkdGggKiBoZWFkZXJJbmZvLmhlaWdodCAmJiAhZGF0YS5waXhlbHMucmVzdWx0TWFzaykgewogICAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0TWFzayA9IG9wdGlvbnMubWFza0RhdGE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBudW1QaXhlbHMgPSBoZWFkZXJJbmZvLndpZHRoICogaGVhZGVySW5mby5oZWlnaHQ7CiAgICAgICAgICAgICAgZGF0YS5waXhlbHMucmVzdWx0UGl4ZWxzID0gbmV3IE91dFBpeGVsVHlwZUFycmF5KG51bVBpeGVscyAqIGhlYWRlckluZm8ubnVtRGltcyk7CiAgICAgICAgICAgICAgZGF0YS5jb3VudGVyID0gewogICAgICAgICAgICAgICAgb25lc3dlZXA6IDAsCiAgICAgICAgICAgICAgICB1bmNvbXByZXNzZWQ6IDAsCiAgICAgICAgICAgICAgICBsdXQ6IDAsCiAgICAgICAgICAgICAgICBiaXRzdHVmZmVyOiAwLAogICAgICAgICAgICAgICAgY29uc3RhbnQ6IDAsCiAgICAgICAgICAgICAgICBjb25zdGFudG9mZnNldDogMAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYgKGhlYWRlckluZm8ubnVtVmFsaWRQaXhlbCAhPT0gMCkgewogICAgICAgICAgICAgICAgaWYgKGhlYWRlckluZm8uek1heCA9PT0gaGVhZGVySW5mby56TWluKSB7CiAgICAgICAgICAgICAgICAgIExlcmMySGVscGVycy5jb25zdHJ1Y3RDb25zdGFudFN1cmZhY2UoZGF0YSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZpbGVWZXJzaW9uID49IDQgJiYgTGVyYzJIZWxwZXJzLmNoZWNrTWluTWF4UmFuZ2VzKGlucHV0LCBkYXRhKSkgewogICAgICAgICAgICAgICAgICBMZXJjMkhlbHBlcnMuY29uc3RydWN0Q29uc3RhbnRTdXJmYWNlKGRhdGEpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIHZpZXcgPSBuZXcgRGF0YVZpZXcoaW5wdXQsIGRhdGEucHRyLCAyKTsKICAgICAgICAgICAgICAgICAgdmFyIGJSZWFkRGF0YU9uZVN3ZWVwID0gdmlldy5nZXRVaW50OCgwKTsKICAgICAgICAgICAgICAgICAgZGF0YS5wdHIrKzsKICAgICAgICAgICAgICAgICAgaWYgKGJSZWFkRGF0YU9uZVN3ZWVwKSB7CiAgICAgICAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLnJlYWREYXRhT25lU3dlZXAoaW5wdXQsIGRhdGEsIE91dFBpeGVsVHlwZUFycmF5KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZVZlcnNpb24gPiAxICYmIGhlYWRlckluZm8uaW1hZ2VUeXBlIDw9IDEgJiYgTWF0aC5hYnMoaGVhZGVySW5mby5tYXhaRXJyb3IgLSAwLjUpIDwgMWUtNSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGZsYWdIdWZmbWFuID0gdmlldy5nZXRVaW50OCgxKTsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHRyKys7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLmVuY29kZU1vZGUgPSBmbGFnSHVmZm1hbjsKICAgICAgICAgICAgICAgICAgICAgIGlmIChmbGFnSHVmZm1hbiA+IDIgfHwgZmlsZVZlcnNpb24gPCA0ICYmIGZsYWdIdWZmbWFuID4gMSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAiSW52YWxpZCBIdWZmbWFuIGZsYWcgIiArIGZsYWdIdWZmbWFuOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWdIdWZmbWFuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIExlcmMySGVscGVycy5yZWFkSHVmZm1hbihpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgTGVyYzJIZWxwZXJzLnJlYWRUaWxlcyhpbnB1dCwgZGF0YSwgT3V0UGl4ZWxUeXBlQXJyYXkpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBMZXJjMkhlbHBlcnMucmVhZFRpbGVzKGlucHV0LCBkYXRhLCBPdXRQaXhlbFR5cGVBcnJheSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRhdGEuZW9mT2Zmc2V0ID0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgdmFyIGRpZmY7CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaW5wdXRPZmZzZXQpIHsKICAgICAgICAgICAgICAgIGRpZmYgPSBkYXRhLmhlYWRlckluZm8uYmxvYlNpemUgKyBvcHRpb25zLmlucHV0T2Zmc2V0IC0gZGF0YS5wdHI7CiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGlmZikgPj0gMSkgewogICAgICAgICAgICAgICAgICBkYXRhLmVvZk9mZnNldCA9IG9wdGlvbnMuaW5wdXRPZmZzZXQgKyBkYXRhLmhlYWRlckluZm8uYmxvYlNpemU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRpZmYgPSBkYXRhLmhlYWRlckluZm8uYmxvYlNpemUgLSBkYXRhLnB0cjsKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhkaWZmKSA+PSAxKSB7CiAgICAgICAgICAgICAgICAgIGRhdGEuZW9mT2Zmc2V0ID0gZGF0YS5oZWFkZXJJbmZvLmJsb2JTaXplOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgICAgICAgd2lkdGg6IGhlYWRlckluZm8ud2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGhlYWRlckluZm8uaGVpZ2h0LAogICAgICAgICAgICAgICAgcGl4ZWxEYXRhOiBkYXRhLnBpeGVscy5yZXN1bHRQaXhlbHMsCiAgICAgICAgICAgICAgICBtaW5WYWx1ZTogaGVhZGVySW5mby56TWluLAogICAgICAgICAgICAgICAgbWF4VmFsdWU6IGhlYWRlckluZm8uek1heCwKICAgICAgICAgICAgICAgIHZhbGlkUGl4ZWxDb3VudDogaGVhZGVySW5mby5udW1WYWxpZFBpeGVsLAogICAgICAgICAgICAgICAgZGltQ291bnQ6IGhlYWRlckluZm8ubnVtRGltcywKICAgICAgICAgICAgICAgIGRpbVN0YXRzOiB7CiAgICAgICAgICAgICAgICAgIG1pblZhbHVlczogaGVhZGVySW5mby5taW5WYWx1ZXMsCiAgICAgICAgICAgICAgICAgIG1heFZhbHVlczogaGVhZGVySW5mby5tYXhWYWx1ZXMKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBtYXNrRGF0YTogZGF0YS5waXhlbHMucmVzdWx0TWFzawogICAgICAgICAgICAgICAgLy9ub0RhdGFWYWx1ZTogbm9EYXRhVmFsdWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChkYXRhLnBpeGVscy5yZXN1bHRNYXNrICYmIExlcmMySGVscGVycy5pc1ZhbGlkUGl4ZWxWYWx1ZShoZWFkZXJJbmZvLmltYWdlVHlwZSwgbm9EYXRhVmFsdWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgbWFzayA9IGRhdGEucGl4ZWxzLnJlc3VsdE1hc2s7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbnVtUGl4ZWxzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKCFtYXNrW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnBpeGVsRGF0YVtpXSA9IG5vRGF0YVZhbHVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXN1bHQubm9EYXRhVmFsdWUgPSBub0RhdGFWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGF0YS5ub0RhdGFWYWx1ZSA9IG5vRGF0YVZhbHVlOwogICAgICAgICAgICAgIGlmIChvcHRpb25zLnJldHVybkZpbGVJbmZvKSB7CiAgICAgICAgICAgICAgICByZXN1bHQuZmlsZUluZm8gPSBMZXJjMkhlbHBlcnMuZm9ybWF0RmlsZUluZm8oZGF0YSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldEJhbmRDb3VudDogZnVuY3Rpb24oaW5wdXQpIHsKICAgICAgICAgICAgICB2YXIgY291bnQgPSAwOwogICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICB2YXIgdGVtcCA9IHt9OwogICAgICAgICAgICAgIHRlbXAucHRyID0gMDsKICAgICAgICAgICAgICB0ZW1wLnBpeGVscyA9IHt9OwogICAgICAgICAgICAgIHdoaWxlIChpIDwgaW5wdXQuYnl0ZUxlbmd0aCAtIDU4KSB7CiAgICAgICAgICAgICAgICBMZXJjMkhlbHBlcnMucmVhZEhlYWRlckluZm8oaW5wdXQsIHRlbXApOwogICAgICAgICAgICAgICAgaSArPSB0ZW1wLmhlYWRlckluZm8uYmxvYlNpemU7CiAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgdGVtcC5wdHIgPSBpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY291bnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gTGVyYzJEZWNvZGUyOwogICAgICAgIH0oKTsKICAgICAgICB2YXIgaXNQbGF0Zm9ybUxpdHRsZUVuZGlhbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGEzID0gbmV3IEFycmF5QnVmZmVyKDQpOwogICAgICAgICAgdmFyIGIgPSBuZXcgVWludDhBcnJheShhMyk7CiAgICAgICAgICB2YXIgYyA9IG5ldyBVaW50MzJBcnJheShhMyk7CiAgICAgICAgICBjWzBdID0gMTsKICAgICAgICAgIHJldHVybiBiWzBdID09PSAxOwogICAgICAgIH0oKTsKICAgICAgICB2YXIgTGVyYzIgPSB7CiAgICAgICAgICAvKioqKioqKioqKioqd3JhcHBlcioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEEgd3JhcHBlciBmb3IgZGVjb2RpbmcgYm90aCBMRVJDMSBhbmQgTEVSQzIgYnl0ZSBzdHJlYW1zIGNhcGFibGUgb2YgaGFuZGxpbmcgbXVsdGliYW5kIHBpeGVsIGJsb2NrcyBmb3IgdmFyaW91cyBwaXhlbCB0eXBlcy4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAYWxpYXMgbW9kdWxlOkxlcmMKICAgICAgICAgICAqIEBwYXJhbSB7QXJyYXlCdWZmZXJ9IGlucHV0IFRoZSBMRVJDIGlucHV0IGJ5dGUgc3RyZWFtCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIFRoZSBkZWNvZGluZyBvcHRpb25zIGJlbG93IGFyZSBvcHRpb25hbC4KICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbb3B0aW9ucy5pbnB1dE9mZnNldF0gVGhlIG51bWJlciBvZiBieXRlcyB0byBza2lwIGluIHRoZSBpbnB1dCBieXRlIHN0cmVhbS4gQSB2YWxpZCBMZXJjIGZpbGUgaXMgZXhwZWN0ZWQgYXQgdGhhdCBwb3NpdGlvbi4KICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbb3B0aW9ucy5waXhlbFR5cGVdIChMRVJDMSBvbmx5KSBEZWZhdWx0IHZhbHVlIGlzIEYzMi4gVmFsaWQgcGl4ZWwgdHlwZXMgZm9yIGlucHV0IGFyZSBVOC9TOC9TMTYvVTE2L1MzMi9VMzIvRjMyLgogICAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IFtvcHRpb25zLm5vRGF0YVZhbHVlXSAoTEVSQzEgb25seSkuIEl0IGlzIHJlY29tbWVuZGVkIHRvIHVzZSB0aGUgcmV0dXJuZWQgbWFzayBpbnN0ZWFkIG9mIHNldHRpbmcgdGhpcyB2YWx1ZS4KICAgICAgICAgICAqIEByZXR1cm5zIHt7d2lkdGgsIGhlaWdodCwgcGl4ZWxzLCBwaXhlbFR5cGUsIG1hc2ssIHN0YXRpc3RpY3N9fQogICAgICAgICAgICAgKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggV2lkdGggb2YgZGVjb2RlZCBpbWFnZS4KICAgICAgICAgICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCBIZWlnaHQgb2YgZGVjb2RlZCBpbWFnZS4KICAgICAgICAgICAgICogQHByb3BlcnR5IHthcnJheX0gcGl4ZWxzIFtiYW5kMSwgYmFuZDIsIOKApl0gRWFjaCBiYW5kIGlzIGEgdHlwZWQgYXJyYXkgb2Ygd2lkdGgqaGVpZ2h0LgogICAgICAgICAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gcGl4ZWxUeXBlIFRoZSB0eXBlIG9mIHBpeGVscyByZXByZXNlbnRlZCBpbiB0aGUgb3V0cHV0LgogICAgICAgICAgICAgKiBAcHJvcGVydHkge21hc2t9IG1hc2sgVHlwZWQgYXJyYXkgd2l0aCBhIHNpemUgb2Ygd2lkdGgqaGVpZ2h0LCBvciBudWxsIGlmIGFsbCBwaXhlbHMgYXJlIHZhbGlkLgogICAgICAgICAgICAgKiBAcHJvcGVydHkge2FycmF5fSBzdGF0aXN0aWNzIFtzdGF0aXN0aWNzX2JhbmQxLCBzdGF0aXN0aWNzX2JhbmQyLCDigKZdIEVhY2ggZWxlbWVudCBpcyBhIHN0YXRpc3RpY3Mgb2JqZWN0IHJlcHJlc2VudGluZyBtaW4gYW5kIG1heCB2YWx1ZXMKICAgICAgICAgICoqLwogICAgICAgICAgZGVjb2RlOiBmdW5jdGlvbihlbmNvZGVkRGF0YSwgb3B0aW9ucykgewogICAgICAgICAgICBpZiAoIWlzUGxhdGZvcm1MaXR0bGVFbmRpYW4pIHsKICAgICAgICAgICAgICB0aHJvdyAiQmlnIGVuZGlhbiBzeXN0ZW0gaXMgbm90IHN1cHBvcnRlZC4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgICAgICB2YXIgaW5wdXRPZmZzZXQgPSBvcHRpb25zLmlucHV0T2Zmc2V0IHx8IDA7CiAgICAgICAgICAgIHZhciBmaWxlSWRWaWV3ID0gbmV3IFVpbnQ4QXJyYXkoZW5jb2RlZERhdGEsIGlucHV0T2Zmc2V0LCAxMCk7CiAgICAgICAgICAgIHZhciBmaWxlSWRlbnRpZmllclN0cmluZyA9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkobnVsbCwgZmlsZUlkVmlldyk7CiAgICAgICAgICAgIHZhciBsZXJjLCBtYWpvclZlcnNpb247CiAgICAgICAgICAgIGlmIChmaWxlSWRlbnRpZmllclN0cmluZy50cmltKCkgPT09ICJDbnRaSW1hZ2UiKSB7CiAgICAgICAgICAgICAgbGVyYyA9IExlcmNEZWNvZGU7CiAgICAgICAgICAgICAgbWFqb3JWZXJzaW9uID0gMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChmaWxlSWRlbnRpZmllclN0cmluZy5zdWJzdHJpbmcoMCwgNSkgPT09ICJMZXJjMiIpIHsKICAgICAgICAgICAgICBsZXJjID0gTGVyYzJEZWNvZGU7CiAgICAgICAgICAgICAgbWFqb3JWZXJzaW9uID0gMjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aHJvdyAiVW5leHBlY3RlZCBmaWxlIGlkZW50aWZpZXIgc3RyaW5nOiAiICsgZmlsZUlkZW50aWZpZXJTdHJpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGlQbGFuZSA9IDAsIGVvZiA9IGVuY29kZWREYXRhLmJ5dGVMZW5ndGggLSAxMCwgZW5jb2RlZE1hc2tEYXRhLCBiYW5kTWFza3MgPSBbXSwgYmFuZE1hc2ssIG1hc2tEYXRhOwogICAgICAgICAgICB2YXIgZGVjb2RlZFBpeGVsQmxvY2sgPSB7CiAgICAgICAgICAgICAgd2lkdGg6IDAsCiAgICAgICAgICAgICAgaGVpZ2h0OiAwLAogICAgICAgICAgICAgIHBpeGVsczogW10sCiAgICAgICAgICAgICAgcGl4ZWxUeXBlOiBvcHRpb25zLnBpeGVsVHlwZSwKICAgICAgICAgICAgICBtYXNrOiBudWxsLAogICAgICAgICAgICAgIHN0YXRpc3RpY3M6IFtdCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdoaWxlIChpbnB1dE9mZnNldCA8IGVvZikgewogICAgICAgICAgICAgIHZhciByZXN1bHQgPSBsZXJjLmRlY29kZShlbmNvZGVkRGF0YSwgewogICAgICAgICAgICAgICAgaW5wdXRPZmZzZXQsCiAgICAgICAgICAgICAgICAvL2ZvciBib3RoIGxlcmMxIGFuZCBsZXJjMgogICAgICAgICAgICAgICAgZW5jb2RlZE1hc2tEYXRhLAogICAgICAgICAgICAgICAgLy9sZXJjMSBvbmx5CiAgICAgICAgICAgICAgICBtYXNrRGF0YSwKICAgICAgICAgICAgICAgIC8vbGVyYzIgb25seQogICAgICAgICAgICAgICAgcmV0dXJuTWFzazogaVBsYW5lID09PSAwID8gdHJ1ZSA6IGZhbHNlLAogICAgICAgICAgICAgICAgLy9sZXJjMSBvbmx5CiAgICAgICAgICAgICAgICByZXR1cm5FbmNvZGVkTWFzazogaVBsYW5lID09PSAwID8gdHJ1ZSA6IGZhbHNlLAogICAgICAgICAgICAgICAgLy9sZXJjMSBvbmx5CiAgICAgICAgICAgICAgICByZXR1cm5GaWxlSW5mbzogdHJ1ZSwKICAgICAgICAgICAgICAgIC8vZm9yIGJvdGggbGVyYzEgYW5kIGxlcmMyCiAgICAgICAgICAgICAgICBwaXhlbFR5cGU6IG9wdGlvbnMucGl4ZWxUeXBlIHx8IG51bGwsCiAgICAgICAgICAgICAgICAvL2xlcmMxIG9ubHkKICAgICAgICAgICAgICAgIG5vRGF0YVZhbHVlOiBvcHRpb25zLm5vRGF0YVZhbHVlIHx8IG51bGwKICAgICAgICAgICAgICAgIC8vbGVyYzEgb25seQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlucHV0T2Zmc2V0ID0gcmVzdWx0LmZpbGVJbmZvLmVvZk9mZnNldDsKICAgICAgICAgICAgICBpZiAoaVBsYW5lID09PSAwKSB7CiAgICAgICAgICAgICAgICBlbmNvZGVkTWFza0RhdGEgPSByZXN1bHQuZW5jb2RlZE1hc2tEYXRhOwogICAgICAgICAgICAgICAgbWFza0RhdGEgPSByZXN1bHQubWFza0RhdGE7CiAgICAgICAgICAgICAgICBkZWNvZGVkUGl4ZWxCbG9jay53aWR0aCA9IHJlc3VsdC53aWR0aDsKICAgICAgICAgICAgICAgIGRlY29kZWRQaXhlbEJsb2NrLmhlaWdodCA9IHJlc3VsdC5oZWlnaHQ7CiAgICAgICAgICAgICAgICBkZWNvZGVkUGl4ZWxCbG9jay5kaW1Db3VudCA9IHJlc3VsdC5kaW1Db3VudCB8fCAxOwogICAgICAgICAgICAgICAgZGVjb2RlZFBpeGVsQmxvY2sucGl4ZWxUeXBlID0gcmVzdWx0LnBpeGVsVHlwZSB8fCByZXN1bHQuZmlsZUluZm8ucGl4ZWxUeXBlOwogICAgICAgICAgICAgICAgZGVjb2RlZFBpeGVsQmxvY2subWFzayA9IHJlc3VsdC5tYXNrRGF0YTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG1ham9yVmVyc2lvbiA+IDEgJiYgcmVzdWx0LmZpbGVJbmZvLm1hc2sgJiYgcmVzdWx0LmZpbGVJbmZvLm1hc2subnVtQnl0ZXMgPiAwKSB7CiAgICAgICAgICAgICAgICBiYW5kTWFza3MucHVzaChyZXN1bHQubWFza0RhdGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpUGxhbmUrKzsKICAgICAgICAgICAgICBkZWNvZGVkUGl4ZWxCbG9jay5waXhlbHMucHVzaChyZXN1bHQucGl4ZWxEYXRhKTsKICAgICAgICAgICAgICBkZWNvZGVkUGl4ZWxCbG9jay5zdGF0aXN0aWNzLnB1c2goewogICAgICAgICAgICAgICAgbWluVmFsdWU6IHJlc3VsdC5taW5WYWx1ZSwKICAgICAgICAgICAgICAgIG1heFZhbHVlOiByZXN1bHQubWF4VmFsdWUsCiAgICAgICAgICAgICAgICBub0RhdGFWYWx1ZTogcmVzdWx0Lm5vRGF0YVZhbHVlLAogICAgICAgICAgICAgICAgZGltU3RhdHM6IHJlc3VsdC5kaW1TdGF0cwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpLCBqLCBudW1QaXhlbHM7CiAgICAgICAgICAgIGlmIChtYWpvclZlcnNpb24gPiAxICYmIGJhbmRNYXNrcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgbnVtUGl4ZWxzID0gZGVjb2RlZFBpeGVsQmxvY2sud2lkdGggKiBkZWNvZGVkUGl4ZWxCbG9jay5oZWlnaHQ7CiAgICAgICAgICAgICAgZGVjb2RlZFBpeGVsQmxvY2suYmFuZE1hc2tzID0gYmFuZE1hc2tzOwogICAgICAgICAgICAgIG1hc2tEYXRhID0gbmV3IFVpbnQ4QXJyYXkobnVtUGl4ZWxzKTsKICAgICAgICAgICAgICBtYXNrRGF0YS5zZXQoYmFuZE1hc2tzWzBdKTsKICAgICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgYmFuZE1hc2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBiYW5kTWFzayA9IGJhbmRNYXNrc1tpXTsKICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBudW1QaXhlbHM7IGorKykgewogICAgICAgICAgICAgICAgICBtYXNrRGF0YVtqXSA9IG1hc2tEYXRhW2pdICYgYmFuZE1hc2tbal07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlY29kZWRQaXhlbEJsb2NrLm1hc2tEYXRhID0gbWFza0RhdGE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRlY29kZWRQaXhlbEJsb2NrOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgICAgZGVmaW5lKFtdLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIExlcmMyOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlICE9PSAidW5kZWZpbmVkIiAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBMZXJjMjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5MZXJjID0gTGVyYzI7CiAgICAgICAgfQogICAgICB9KSgpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwLmpzCiAgdmFyIGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcF9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwX2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcF9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGlmIChwYXJhbWV0ZXJzLmVuY29kaW5nID09PSBIZWlnaHRtYXBFbmNvZGluZ19kZWZhdWx0LkxFUkMpIHsKICAgICAgbGV0IHJlc3VsdDsKICAgICAgdHJ5IHsKICAgICAgICByZXN1bHQgPSBpbXBvcnRfbGVyYy5kZWZhdWx0LmRlY29kZShwYXJhbWV0ZXJzLmhlaWdodG1hcCk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KGVycm9yKTsKICAgICAgfQogICAgICBjb25zdCBsZXJjU3RhdGlzdGljcyA9IHJlc3VsdC5zdGF0aXN0aWNzWzBdOwogICAgICBpZiAobGVyY1N0YXRpc3RpY3MubWluVmFsdWUgPT09IE51bWJlci5NQVhfVkFMVUUpIHsKICAgICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgdGlsZSBkYXRhIik7CiAgICAgIH0KICAgICAgcGFyYW1ldGVycy5oZWlnaHRtYXAgPSByZXN1bHQucGl4ZWxzWzBdOwogICAgICBwYXJhbWV0ZXJzLndpZHRoID0gcmVzdWx0LndpZHRoOwogICAgICBwYXJhbWV0ZXJzLmhlaWdodCA9IHJlc3VsdC5oZWlnaHQ7CiAgICB9CiAgICBwYXJhbWV0ZXJzLmVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBhcmFtZXRlcnMuZWxsaXBzb2lkKTsKICAgIHBhcmFtZXRlcnMucmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5yZWN0YW5nbGUpOwogICAgY29uc3Qgc3RhdGlzdGljczIgPSBIZWlnaHRtYXBUZXNzZWxsYXRvcl9kZWZhdWx0LmNvbXB1dGVWZXJ0aWNlcyhwYXJhbWV0ZXJzKTsKICAgIGNvbnN0IHZlcnRpY2VzID0gc3RhdGlzdGljczIudmVydGljZXM7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2godmVydGljZXMuYnVmZmVyKTsKICAgIHJldHVybiB7CiAgICAgIHZlcnRpY2VzOiB2ZXJ0aWNlcy5idWZmZXIsCiAgICAgIG51bWJlck9mQXR0cmlidXRlczogc3RhdGlzdGljczIuZW5jb2Rpbmcuc3RyaWRlLAogICAgICBtaW5pbXVtSGVpZ2h0OiBzdGF0aXN0aWNzMi5taW5pbXVtSGVpZ2h0LAogICAgICBtYXhpbXVtSGVpZ2h0OiBzdGF0aXN0aWNzMi5tYXhpbXVtSGVpZ2h0LAogICAgICBncmlkV2lkdGg6IHBhcmFtZXRlcnMud2lkdGgsCiAgICAgIGdyaWRIZWlnaHQ6IHBhcmFtZXRlcnMuaGVpZ2h0LAogICAgICBib3VuZGluZ1NwaGVyZTNEOiBzdGF0aXN0aWNzMi5ib3VuZGluZ1NwaGVyZTNELAogICAgICBvcmllbnRlZEJvdW5kaW5nQm94OiBzdGF0aXN0aWNzMi5vcmllbnRlZEJvdW5kaW5nQm94LAogICAgICBvY2NsdWRlZVBvaW50SW5TY2FsZWRTcGFjZTogc3RhdGlzdGljczIub2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UsCiAgICAgIGVuY29kaW5nOiBzdGF0aXN0aWNzMi5lbmNvZGluZywKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGg6IHN0YXRpc3RpY3MyLndlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICBzb3V0aEluZGljZXNFYXN0VG9XZXN0OiBzdGF0aXN0aWNzMi5zb3V0aEluZGljZXNFYXN0VG9XZXN0LAogICAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aDogc3RhdGlzdGljczIuZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3Q6IHN0YXRpc3RpY3MyLm5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QKICAgIH07CiAgfQogIHZhciBpbXBvcnRfbGVyYywgY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwX2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXAuanMiKCkgewogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0hlaWdodG1hcEVuY29kaW5nKCk7CiAgICAgIGluaXRfSGVpZ2h0bWFwVGVzc2VsbGF0b3IoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9SdW50aW1lRXJyb3IoKTsKICAgICAgaW1wb3J0X2xlcmMgPSBfX3RvRVNNKHJlcXVpcmVfTGVyY0RlY29kZSgpLCAxKTsKICAgICAgaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCk7CiAgICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcF9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcCk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9UZXJyYWluUHJvdmlkZXIuanMKICBmdW5jdGlvbiBUZXJyYWluUHJvdmlkZXIoKSB7CiAgICBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yKCk7CiAgfQogIGZ1bmN0aW9uIGdldEVkZ2VJbmRpY2VzKHdpZHRoLCBoZWlnaHQpIHsKICAgIGNvbnN0IHdlc3RJbmRpY2VzU291dGhUb05vcnRoID0gbmV3IEFycmF5KGhlaWdodCk7CiAgICBjb25zdCBzb3V0aEluZGljZXNFYXN0VG9XZXN0ID0gbmV3IEFycmF5KHdpZHRoKTsKICAgIGNvbnN0IGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoID0gbmV3IEFycmF5KGhlaWdodCk7CiAgICBjb25zdCBub3J0aEluZGljZXNXZXN0VG9FYXN0ID0gbmV3IEFycmF5KHdpZHRoKTsKICAgIGxldCBpOwogICAgZm9yIChpID0gMDsgaSA8IHdpZHRoOyArK2kpIHsKICAgICAgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdFtpXSA9IGk7CiAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3RbaV0gPSB3aWR0aCAqIGhlaWdodCAtIDEgLSBpOwogICAgfQogICAgZm9yIChpID0gMDsgaSA8IGhlaWdodDsgKytpKSB7CiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoW2ldID0gKGkgKyAxKSAqIHdpZHRoIC0gMTsKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGhbaV0gPSAoaGVpZ2h0IC0gaSAtIDEpICogd2lkdGg7CiAgICB9CiAgICByZXR1cm4gewogICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QKICAgIH07CiAgfQogIGZ1bmN0aW9uIGFkZFJlZ3VsYXJHcmlkSW5kaWNlcyh3aWR0aCwgaGVpZ2h0LCBpbmRpY2VzLCBvZmZzZXQpIHsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGhlaWdodCAtIDE7ICsraikgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdpZHRoIC0gMTsgKytpKSB7CiAgICAgICAgY29uc3QgdXBwZXJMZWZ0ID0gaW5kZXg7CiAgICAgICAgY29uc3QgbG93ZXJMZWZ0ID0gdXBwZXJMZWZ0ICsgd2lkdGg7CiAgICAgICAgY29uc3QgbG93ZXJSaWdodCA9IGxvd2VyTGVmdCArIDE7CiAgICAgICAgY29uc3QgdXBwZXJSaWdodCA9IHVwcGVyTGVmdCArIDE7CiAgICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB1cHBlckxlZnQ7CiAgICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSBsb3dlckxlZnQ7CiAgICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB1cHBlclJpZ2h0OwogICAgICAgIGluZGljZXNbb2Zmc2V0KytdID0gdXBwZXJSaWdodDsKICAgICAgICBpbmRpY2VzW29mZnNldCsrXSA9IGxvd2VyTGVmdDsKICAgICAgICBpbmRpY2VzW29mZnNldCsrXSA9IGxvd2VyUmlnaHQ7CiAgICAgICAgKytpbmRleDsKICAgICAgfQogICAgICArK2luZGV4OwogICAgfQogIH0KICBmdW5jdGlvbiBhZGRTa2lydEluZGljZXMoZWRnZUluZGljZXMsIHZlcnRleEluZGV4LCBpbmRpY2VzLCBvZmZzZXQpIHsKICAgIGxldCBwcmV2aW91c0luZGV4ID0gZWRnZUluZGljZXNbMF07CiAgICBjb25zdCBsZW5ndGggPSBlZGdlSW5kaWNlcy5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IGluZGV4ID0gZWRnZUluZGljZXNbaV07CiAgICAgIGluZGljZXNbb2Zmc2V0KytdID0gcHJldmlvdXNJbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSBpbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB2ZXJ0ZXhJbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB2ZXJ0ZXhJbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSBpbmRleDsKICAgICAgaW5kaWNlc1tvZmZzZXQrK10gPSB2ZXJ0ZXhJbmRleCArIDE7CiAgICAgIHByZXZpb3VzSW5kZXggPSBpbmRleDsKICAgICAgKyt2ZXJ0ZXhJbmRleDsKICAgIH0KICAgIHJldHVybiBvZmZzZXQ7CiAgfQogIHZhciByZWd1bGFyR3JpZEluZGljZXNDYWNoZSwgcmVndWxhckdyaWRBbmRFZGdlSW5kaWNlc0NhY2hlLCByZWd1bGFyR3JpZEFuZFNraXJ0QW5kRWRnZUluZGljZXNDYWNoZSwgVGVycmFpblByb3ZpZGVyX2RlZmF1bHQ7CiAgdmFyIGluaXRfVGVycmFpblByb3ZpZGVyID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9UZXJyYWluUHJvdmlkZXIuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUsIHsKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIGFuIGV2ZW50IHRoYXQgaXMgcmFpc2VkIHdoZW4gdGhlIHRlcnJhaW4gcHJvdmlkZXIgZW5jb3VudGVycyBhbiBhc3luY2hyb25vdXMgZXJyb3IuICBCeSBzdWJzY3JpYmluZwogICAgICAgICAqIHRvIHRoZSBldmVudCwgeW91IHdpbGwgYmUgbm90aWZpZWQgb2YgdGhlIGVycm9yIGFuZCBjYW4gcG90ZW50aWFsbHkgcmVjb3ZlciBmcm9tIGl0LiAgRXZlbnQgbGlzdGVuZXJzCiAgICAgICAgICogYXJlIHBhc3NlZCBhbiBpbnN0YW5jZSBvZiB7QGxpbmsgVGlsZVByb3ZpZGVyRXJyb3J9LgogICAgICAgICAqIEBtZW1iZXJvZiBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge0V2ZW50PFRlcnJhaW5Qcm92aWRlci5FcnJvckV2ZW50Pn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBlcnJvckV2ZW50OiB7CiAgICAgICAgICBnZXQ6IERldmVsb3BlckVycm9yX2RlZmF1bHQudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIGNyZWRpdCB0byBkaXNwbGF5IHdoZW4gdGhpcyB0ZXJyYWluIHByb3ZpZGVyIGlzIGFjdGl2ZS4gIFR5cGljYWxseSB0aGlzIGlzIHVzZWQgdG8gY3JlZGl0CiAgICAgICAgICogdGhlIHNvdXJjZSBvZiB0aGUgdGVycmFpbi4KICAgICAgICAgKiBAbWVtYmVyb2YgVGVycmFpblByb3ZpZGVyLnByb3RvdHlwZQogICAgICAgICAqIEB0eXBlIHtDcmVkaXR9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgY3JlZGl0OiB7CiAgICAgICAgICBnZXQ6IERldmVsb3BlckVycm9yX2RlZmF1bHQudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEdldHMgdGhlIHRpbGluZyBzY2hlbWUgdXNlZCBieSB0aGUgcHJvdmlkZXIuCiAgICAgICAgICogQG1lbWJlcm9mIFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7VGlsaW5nU2NoZW1lfQogICAgICAgICAqIEByZWFkb25seQogICAgICAgICAqLwogICAgICAgIHRpbGluZ1NjaGVtZTogewogICAgICAgICAgZ2V0OiBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yCiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIGEgdmFsdWUgaW5kaWNhdGluZyB3aGV0aGVyIG9yIG5vdCB0aGUgcHJvdmlkZXIgaW5jbHVkZXMgYSB3YXRlciBtYXNrLiAgVGhlIHdhdGVyIG1hc2sKICAgICAgICAgKiBpbmRpY2F0ZXMgd2hpY2ggYXJlYXMgb2YgdGhlIGdsb2JlIGFyZSB3YXRlciByYXRoZXIgdGhhbiBsYW5kLCBzbyB0aGV5IGNhbiBiZSByZW5kZXJlZAogICAgICAgICAqIGFzIGEgcmVmbGVjdGl2ZSBzdXJmYWNlIHdpdGggYW5pbWF0ZWQgd2F2ZXMuCiAgICAgICAgICogQG1lbWJlcm9mIFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUKICAgICAgICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICAgICAgKiBAcmVhZG9ubHkKICAgICAgICAgKi8KICAgICAgICBoYXNXYXRlck1hc2s6IHsKICAgICAgICAgIGdldDogRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdC50aHJvd0luc3RhbnRpYXRpb25FcnJvcgogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogR2V0cyBhIHZhbHVlIGluZGljYXRpbmcgd2hldGhlciBvciBub3QgdGhlIHJlcXVlc3RlZCB0aWxlcyBpbmNsdWRlIHZlcnRleCBub3JtYWxzLgogICAgICAgICAqIEBtZW1iZXJvZiBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgaGFzVmVydGV4Tm9ybWFsczogewogICAgICAgICAgZ2V0OiBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yCiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBHZXRzIGFuIG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIHRvIGRldGVybWluZSBhdmFpbGFiaWxpdHkgb2YgdGVycmFpbiBmcm9tIHRoaXMgcHJvdmlkZXIsIHN1Y2ggYXMKICAgICAgICAgKiBhdCBwb2ludHMgYW5kIGluIHJlY3RhbmdsZXMuIFRoaXMgcHJvcGVydHkgbWF5IGJlIHVuZGVmaW5lZCBpZiBhdmFpbGFiaWxpdHkKICAgICAgICAgKiBpbmZvcm1hdGlvbiBpcyBub3QgYXZhaWxhYmxlLgogICAgICAgICAqIEBtZW1iZXJvZiBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlCiAgICAgICAgICogQHR5cGUge1RpbGVBdmFpbGFiaWxpdHl9CiAgICAgICAgICogQHJlYWRvbmx5CiAgICAgICAgICovCiAgICAgICAgYXZhaWxhYmlsaXR5OiB7CiAgICAgICAgICBnZXQ6IERldmVsb3BlckVycm9yX2RlZmF1bHQudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZWd1bGFyR3JpZEluZGljZXNDYWNoZSA9IFtdOwogICAgICBUZXJyYWluUHJvdmlkZXIuZ2V0UmVndWxhckdyaWRJbmRpY2VzID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkgewogICAgICAgIGlmICh3aWR0aCAqIGhlaWdodCA+PSBNYXRoX2RlZmF1bHQuRk9VUl9HSUdBQllURVMpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiVGhlIHRvdGFsIG51bWJlciBvZiB2ZXJ0aWNlcyAod2lkdGggKiBoZWlnaHQpIG11c3QgYmUgbGVzcyB0aGFuIDQsMjk0LDk2NywyOTYuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgbGV0IGJ5V2lkdGggPSByZWd1bGFyR3JpZEluZGljZXNDYWNoZVt3aWR0aF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnlXaWR0aCkpIHsKICAgICAgICAgIHJlZ3VsYXJHcmlkSW5kaWNlc0NhY2hlW3dpZHRoXSA9IGJ5V2lkdGggPSBbXTsKICAgICAgICB9CiAgICAgICAgbGV0IGluZGljZXMgPSBieVdpZHRoW2hlaWdodF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW5kaWNlcykpIHsKICAgICAgICAgIGlmICh3aWR0aCAqIGhlaWdodCA8IE1hdGhfZGVmYXVsdC5TSVhUWV9GT1VSX0tJTE9CWVRFUykgewogICAgICAgICAgICBpbmRpY2VzID0gYnlXaWR0aFtoZWlnaHRdID0gbmV3IFVpbnQxNkFycmF5KAogICAgICAgICAgICAgICh3aWR0aCAtIDEpICogKGhlaWdodCAtIDEpICogNgogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5kaWNlcyA9IGJ5V2lkdGhbaGVpZ2h0XSA9IG5ldyBVaW50MzJBcnJheSgKICAgICAgICAgICAgICAod2lkdGggLSAxKSAqIChoZWlnaHQgLSAxKSAqIDYKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGFkZFJlZ3VsYXJHcmlkSW5kaWNlcyh3aWR0aCwgaGVpZ2h0LCBpbmRpY2VzLCAwKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGluZGljZXM7CiAgICAgIH07CiAgICAgIHJlZ3VsYXJHcmlkQW5kRWRnZUluZGljZXNDYWNoZSA9IFtdOwogICAgICBUZXJyYWluUHJvdmlkZXIuZ2V0UmVndWxhckdyaWRJbmRpY2VzQW5kRWRnZUluZGljZXMgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgaWYgKHdpZHRoICogaGVpZ2h0ID49IE1hdGhfZGVmYXVsdC5GT1VSX0dJR0FCWVRFUykgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgICAgICJUaGUgdG90YWwgbnVtYmVyIG9mIHZlcnRpY2VzICh3aWR0aCAqIGhlaWdodCkgbXVzdCBiZSBsZXNzIHRoYW4gNCwyOTQsOTY3LDI5Ni4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBsZXQgYnlXaWR0aCA9IHJlZ3VsYXJHcmlkQW5kRWRnZUluZGljZXNDYWNoZVt3aWR0aF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnlXaWR0aCkpIHsKICAgICAgICAgIHJlZ3VsYXJHcmlkQW5kRWRnZUluZGljZXNDYWNoZVt3aWR0aF0gPSBieVdpZHRoID0gW107CiAgICAgICAgfQogICAgICAgIGxldCBpbmRpY2VzQW5kRWRnZXMgPSBieVdpZHRoW2hlaWdodF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoaW5kaWNlc0FuZEVkZ2VzKSkgewogICAgICAgICAgY29uc3QgaW5kaWNlcyA9IFRlcnJhaW5Qcm92aWRlci5nZXRSZWd1bGFyR3JpZEluZGljZXMod2lkdGgsIGhlaWdodCk7CiAgICAgICAgICBjb25zdCBlZGdlSW5kaWNlcyA9IGdldEVkZ2VJbmRpY2VzKHdpZHRoLCBoZWlnaHQpOwogICAgICAgICAgY29uc3Qgd2VzdEluZGljZXNTb3V0aFRvTm9ydGggPSBlZGdlSW5kaWNlcy53ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aDsKICAgICAgICAgIGNvbnN0IHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QgPSBlZGdlSW5kaWNlcy5zb3V0aEluZGljZXNFYXN0VG9XZXN0OwogICAgICAgICAgY29uc3QgZWFzdEluZGljZXNOb3J0aFRvU291dGggPSBlZGdlSW5kaWNlcy5lYXN0SW5kaWNlc05vcnRoVG9Tb3V0aDsKICAgICAgICAgIGNvbnN0IG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QgPSBlZGdlSW5kaWNlcy5ub3J0aEluZGljZXNXZXN0VG9FYXN0OwogICAgICAgICAgaW5kaWNlc0FuZEVkZ2VzID0gYnlXaWR0aFtoZWlnaHRdID0gewogICAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgICAgICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgICAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbmRpY2VzQW5kRWRnZXM7CiAgICAgIH07CiAgICAgIHJlZ3VsYXJHcmlkQW5kU2tpcnRBbmRFZGdlSW5kaWNlc0NhY2hlID0gW107CiAgICAgIFRlcnJhaW5Qcm92aWRlci5nZXRSZWd1bGFyR3JpZEFuZFNraXJ0SW5kaWNlc0FuZEVkZ2VJbmRpY2VzID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkgewogICAgICAgIGlmICh3aWR0aCAqIGhlaWdodCA+PSBNYXRoX2RlZmF1bHQuRk9VUl9HSUdBQllURVMpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICAgICAiVGhlIHRvdGFsIG51bWJlciBvZiB2ZXJ0aWNlcyAod2lkdGggKiBoZWlnaHQpIG11c3QgYmUgbGVzcyB0aGFuIDQsMjk0LDk2NywyOTYuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgbGV0IGJ5V2lkdGggPSByZWd1bGFyR3JpZEFuZFNraXJ0QW5kRWRnZUluZGljZXNDYWNoZVt3aWR0aF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYnlXaWR0aCkpIHsKICAgICAgICAgIHJlZ3VsYXJHcmlkQW5kU2tpcnRBbmRFZGdlSW5kaWNlc0NhY2hlW3dpZHRoXSA9IGJ5V2lkdGggPSBbXTsKICAgICAgICB9CiAgICAgICAgbGV0IGluZGljZXNBbmRFZGdlcyA9IGJ5V2lkdGhbaGVpZ2h0XTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChpbmRpY2VzQW5kRWRnZXMpKSB7CiAgICAgICAgICBjb25zdCBncmlkVmVydGV4Q291bnQgPSB3aWR0aCAqIGhlaWdodDsKICAgICAgICAgIGNvbnN0IGdyaWRJbmRleENvdW50ID0gKHdpZHRoIC0gMSkgKiAoaGVpZ2h0IC0gMSkgKiA2OwogICAgICAgICAgY29uc3QgZWRnZVZlcnRleENvdW50ID0gd2lkdGggKiAyICsgaGVpZ2h0ICogMjsKICAgICAgICAgIGNvbnN0IGVkZ2VJbmRleENvdW50ID0gTWF0aC5tYXgoMCwgZWRnZVZlcnRleENvdW50IC0gNCkgKiA2OwogICAgICAgICAgY29uc3QgdmVydGV4Q291bnQgPSBncmlkVmVydGV4Q291bnQgKyBlZGdlVmVydGV4Q291bnQ7CiAgICAgICAgICBjb25zdCBpbmRleENvdW50ID0gZ3JpZEluZGV4Q291bnQgKyBlZGdlSW5kZXhDb3VudDsKICAgICAgICAgIGNvbnN0IGVkZ2VJbmRpY2VzID0gZ2V0RWRnZUluZGljZXMod2lkdGgsIGhlaWdodCk7CiAgICAgICAgICBjb25zdCB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCA9IGVkZ2VJbmRpY2VzLndlc3RJbmRpY2VzU291dGhUb05vcnRoOwogICAgICAgICAgY29uc3Qgc291dGhJbmRpY2VzRWFzdFRvV2VzdCA9IGVkZ2VJbmRpY2VzLnNvdXRoSW5kaWNlc0Vhc3RUb1dlc3Q7CiAgICAgICAgICBjb25zdCBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCA9IGVkZ2VJbmRpY2VzLmVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoOwogICAgICAgICAgY29uc3Qgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCA9IGVkZ2VJbmRpY2VzLm5vcnRoSW5kaWNlc1dlc3RUb0Vhc3Q7CiAgICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkodmVydGV4Q291bnQsIGluZGV4Q291bnQpOwogICAgICAgICAgYWRkUmVndWxhckdyaWRJbmRpY2VzKHdpZHRoLCBoZWlnaHQsIGluZGljZXMsIDApOwogICAgICAgICAgVGVycmFpblByb3ZpZGVyLmFkZFNraXJ0SW5kaWNlcygKICAgICAgICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgICAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgICAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICAgICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0LAogICAgICAgICAgICBncmlkVmVydGV4Q291bnQsCiAgICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICAgIGdyaWRJbmRleENvdW50CiAgICAgICAgICApOwogICAgICAgICAgaW5kaWNlc0FuZEVkZ2VzID0gYnlXaWR0aFtoZWlnaHRdID0gewogICAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgICAgICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgICAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QsCiAgICAgICAgICAgIGluZGV4Q291bnRXaXRob3V0U2tpcnRzOiBncmlkSW5kZXhDb3VudAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGluZGljZXNBbmRFZGdlczsKICAgICAgfTsKICAgICAgVGVycmFpblByb3ZpZGVyLmFkZFNraXJ0SW5kaWNlcyA9IGZ1bmN0aW9uKHdlc3RJbmRpY2VzU291dGhUb05vcnRoLCBzb3V0aEluZGljZXNFYXN0VG9XZXN0LCBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCwgdmVydGV4Q291bnQsIGluZGljZXMsIG9mZnNldCkgewogICAgICAgIGxldCB2ZXJ0ZXhJbmRleCA9IHZlcnRleENvdW50OwogICAgICAgIG9mZnNldCA9IGFkZFNraXJ0SW5kaWNlcygKICAgICAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICAgICAgdmVydGV4SW5kZXgsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgb2Zmc2V0CiAgICAgICAgKTsKICAgICAgICB2ZXJ0ZXhJbmRleCArPSB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aC5sZW5ndGg7CiAgICAgICAgb2Zmc2V0ID0gYWRkU2tpcnRJbmRpY2VzKAogICAgICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgICAgIHZlcnRleEluZGV4LAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIG9mZnNldAogICAgICAgICk7CiAgICAgICAgdmVydGV4SW5kZXggKz0gc291dGhJbmRpY2VzRWFzdFRvV2VzdC5sZW5ndGg7CiAgICAgICAgb2Zmc2V0ID0gYWRkU2tpcnRJbmRpY2VzKAogICAgICAgICAgZWFzdEluZGljZXNOb3J0aFRvU291dGgsCiAgICAgICAgICB2ZXJ0ZXhJbmRleCwKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBvZmZzZXQKICAgICAgICApOwogICAgICAgIHZlcnRleEluZGV4ICs9IGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLmxlbmd0aDsKICAgICAgICBhZGRTa2lydEluZGljZXMobm9ydGhJbmRpY2VzV2VzdFRvRWFzdCwgdmVydGV4SW5kZXgsIGluZGljZXMsIG9mZnNldCk7CiAgICAgIH07CiAgICAgIFRlcnJhaW5Qcm92aWRlci5oZWlnaHRtYXBUZXJyYWluUXVhbGl0eSA9IDAuMjU7CiAgICAgIFRlcnJhaW5Qcm92aWRlci5nZXRFc3RpbWF0ZWRMZXZlbFplcm9HZW9tZXRyaWNFcnJvckZvckFIZWlnaHRtYXAgPSBmdW5jdGlvbihlbGxpcHNvaWQsIHRpbGVJbWFnZVdpZHRoLCBudW1iZXJPZlRpbGVzQXRMZXZlbFplcm8pIHsKICAgICAgICByZXR1cm4gZWxsaXBzb2lkLm1heGltdW1SYWRpdXMgKiAyICogTWF0aC5QSSAqIFRlcnJhaW5Qcm92aWRlci5oZWlnaHRtYXBUZXJyYWluUXVhbGl0eSAvICh0aWxlSW1hZ2VXaWR0aCAqIG51bWJlck9mVGlsZXNBdExldmVsWmVybyk7CiAgICAgIH07CiAgICAgIFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUucmVxdWVzdFRpbGVHZW9tZXRyeSA9IERldmVsb3BlckVycm9yX2RlZmF1bHQudGhyb3dJbnN0YW50aWF0aW9uRXJyb3I7CiAgICAgIFRlcnJhaW5Qcm92aWRlci5wcm90b3R5cGUuZ2V0TGV2ZWxNYXhpbXVtR2VvbWV0cmljRXJyb3IgPSBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yOwogICAgICBUZXJyYWluUHJvdmlkZXIucHJvdG90eXBlLmdldFRpbGVEYXRhQXZhaWxhYmxlID0gRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdC50aHJvd0luc3RhbnRpYXRpb25FcnJvcjsKICAgICAgVGVycmFpblByb3ZpZGVyLnByb3RvdHlwZS5sb2FkVGlsZURhdGFBdmFpbGFiaWxpdHkgPSBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0LnRocm93SW5zdGFudGlhdGlvbkVycm9yOwogICAgICBUZXJyYWluUHJvdmlkZXJfZGVmYXVsdCA9IFRlcnJhaW5Qcm92aWRlcjsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoLmpzCiAgdmFyIGNyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2gocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgcXVhbnRpemVkVmVydGljZXMgPSBwYXJhbWV0ZXJzLnF1YW50aXplZFZlcnRpY2VzOwogICAgY29uc3QgcXVhbnRpemVkVmVydGV4Q291bnQgPSBxdWFudGl6ZWRWZXJ0aWNlcy5sZW5ndGggLyAzOwogICAgY29uc3Qgb2N0RW5jb2RlZE5vcm1hbHMgPSBwYXJhbWV0ZXJzLm9jdEVuY29kZWROb3JtYWxzOwogICAgY29uc3QgZWRnZVZlcnRleENvdW50ID0gcGFyYW1ldGVycy53ZXN0SW5kaWNlcy5sZW5ndGggKyBwYXJhbWV0ZXJzLmVhc3RJbmRpY2VzLmxlbmd0aCArIHBhcmFtZXRlcnMuc291dGhJbmRpY2VzLmxlbmd0aCArIHBhcmFtZXRlcnMubm9ydGhJbmRpY2VzLmxlbmd0aDsKICAgIGNvbnN0IGluY2x1ZGVXZWJNZXJjYXRvclQgPSBwYXJhbWV0ZXJzLmluY2x1ZGVXZWJNZXJjYXRvclQ7CiAgICBjb25zdCBleGFnZ2VyYXRpb24gPSBwYXJhbWV0ZXJzLmV4YWdnZXJhdGlvbjsKICAgIGNvbnN0IGV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0ID0gcGFyYW1ldGVycy5leGFnZ2VyYXRpb25SZWxhdGl2ZUhlaWdodDsKICAgIGNvbnN0IGhhc0V4YWdnZXJhdGlvbiA9IGV4YWdnZXJhdGlvbiAhPT0gMTsKICAgIGNvbnN0IGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzID0gaGFzRXhhZ2dlcmF0aW9uOwogICAgY29uc3QgcmVjdGFuZ2xlID0gUmVjdGFuZ2xlX2RlZmF1bHQuY2xvbmUocGFyYW1ldGVycy5yZWN0YW5nbGUpOwogICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgY29uc3Qgc291dGggPSByZWN0YW5nbGUuc291dGg7CiAgICBjb25zdCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKHBhcmFtZXRlcnMuZWxsaXBzb2lkKTsKICAgIGNvbnN0IG1pbmltdW1IZWlnaHQgPSBwYXJhbWV0ZXJzLm1pbmltdW1IZWlnaHQ7CiAgICBjb25zdCBtYXhpbXVtSGVpZ2h0ID0gcGFyYW1ldGVycy5tYXhpbXVtSGVpZ2h0OwogICAgY29uc3QgY2VudGVyID0gcGFyYW1ldGVycy5yZWxhdGl2ZVRvQ2VudGVyOwogICAgY29uc3QgZnJvbUVOVSA9IFRyYW5zZm9ybXNfZGVmYXVsdC5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZShjZW50ZXIsIGVsbGlwc29pZCk7CiAgICBjb25zdCB0b0VOVSA9IE1hdHJpeDRfZGVmYXVsdC5pbnZlcnNlVHJhbnNmb3JtYXRpb24oZnJvbUVOVSwgbmV3IE1hdHJpeDRfZGVmYXVsdCgpKTsKICAgIGxldCBzb3V0aE1lcmNhdG9yWTsKICAgIGxldCBvbmVPdmVyTWVyY2F0b3JIZWlnaHQ7CiAgICBpZiAoaW5jbHVkZVdlYk1lcmNhdG9yVCkgewogICAgICBzb3V0aE1lcmNhdG9yWSA9IFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoCiAgICAgICAgc291dGgKICAgICAgKTsKICAgICAgb25lT3Zlck1lcmNhdG9ySGVpZ2h0ID0gMSAvIChXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdC5nZW9kZXRpY0xhdGl0dWRlVG9NZXJjYXRvckFuZ2xlKG5vcnRoKSAtIHNvdXRoTWVyY2F0b3JZKTsKICAgIH0KICAgIGNvbnN0IHVCdWZmZXIgPSBxdWFudGl6ZWRWZXJ0aWNlcy5zdWJhcnJheSgwLCBxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCB2QnVmZmVyID0gcXVhbnRpemVkVmVydGljZXMuc3ViYXJyYXkoCiAgICAgIHF1YW50aXplZFZlcnRleENvdW50LAogICAgICAyICogcXVhbnRpemVkVmVydGV4Q291bnQKICAgICk7CiAgICBjb25zdCBoZWlnaHRCdWZmZXIgPSBxdWFudGl6ZWRWZXJ0aWNlcy5zdWJhcnJheSgKICAgICAgcXVhbnRpemVkVmVydGV4Q291bnQgKiAyLAogICAgICAzICogcXVhbnRpemVkVmVydGV4Q291bnQKICAgICk7CiAgICBjb25zdCBoYXNWZXJ0ZXhOb3JtYWxzID0gZGVmaW5lZF9kZWZhdWx0KG9jdEVuY29kZWROb3JtYWxzKTsKICAgIGNvbnN0IHV2cyA9IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCBoZWlnaHRzID0gbmV3IEFycmF5KHF1YW50aXplZFZlcnRleENvdW50KTsKICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCB3ZWJNZXJjYXRvclRzID0gaW5jbHVkZVdlYk1lcmNhdG9yVCA/IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCkgOiBbXTsKICAgIGNvbnN0IGdlb2RldGljU3VyZmFjZU5vcm1hbHMgPSBpbmNsdWRlR2VvZGV0aWNTdXJmYWNlTm9ybWFscyA/IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCkgOiBbXTsKICAgIGNvbnN0IG1pbmltdW0gPSBzY3JhdGNoTWluaW11bTsKICAgIG1pbmltdW0ueCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIG1pbmltdW0ueSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIG1pbmltdW0ueiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGNvbnN0IG1heGltdW0gPSBzY3JhdGNoTWF4aW11bTsKICAgIG1heGltdW0ueCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIG1heGltdW0ueSA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIG1heGltdW0ueiA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIGxldCBtaW5Mb25naXR1ZGUgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWF4TG9uZ2l0dWRlID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgbGV0IG1pbkxhdGl0dWRlID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbGV0IG1heExhdGl0dWRlID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBxdWFudGl6ZWRWZXJ0ZXhDb3VudDsgKytpKSB7CiAgICAgIGNvbnN0IHJhd1UgPSB1QnVmZmVyW2ldOwogICAgICBjb25zdCByYXdWID0gdkJ1ZmZlcltpXTsKICAgICAgY29uc3QgdTMgPSByYXdVIC8gbWF4U2hvcnQ0OwogICAgICBjb25zdCB2MyA9IHJhd1YgLyBtYXhTaG9ydDQ7CiAgICAgIGNvbnN0IGhlaWdodCA9IE1hdGhfZGVmYXVsdC5sZXJwKAogICAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgICBoZWlnaHRCdWZmZXJbaV0gLyBtYXhTaG9ydDQKICAgICAgKTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaC5sb25naXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycCh3ZXN0LCBlYXN0LCB1Myk7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycChzb3V0aCwgbm9ydGgsIHYzKTsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaC5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgIG1pbkxvbmdpdHVkZSA9IE1hdGgubWluKGNhcnRvZ3JhcGhpY1NjcmF0Y2gubG9uZ2l0dWRlLCBtaW5Mb25naXR1ZGUpOwogICAgICBtYXhMb25naXR1ZGUgPSBNYXRoLm1heChjYXJ0b2dyYXBoaWNTY3JhdGNoLmxvbmdpdHVkZSwgbWF4TG9uZ2l0dWRlKTsKICAgICAgbWluTGF0aXR1ZGUgPSBNYXRoLm1pbihjYXJ0b2dyYXBoaWNTY3JhdGNoLmxhdGl0dWRlLCBtaW5MYXRpdHVkZSk7CiAgICAgIG1heExhdGl0dWRlID0gTWF0aC5tYXgoY2FydG9ncmFwaGljU2NyYXRjaC5sYXRpdHVkZSwgbWF4TGF0aXR1ZGUpOwogICAgICBjb25zdCBwb3NpdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjYXJ0b2dyYXBoaWNTY3JhdGNoKTsKICAgICAgdXZzW2ldID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCh1MywgdjMpOwogICAgICBoZWlnaHRzW2ldID0gaGVpZ2h0OwogICAgICBwb3NpdGlvbnNbaV0gPSBwb3NpdGlvbjsKICAgICAgaWYgKGluY2x1ZGVXZWJNZXJjYXRvclQpIHsKICAgICAgICB3ZWJNZXJjYXRvclRzW2ldID0gKFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoCiAgICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmxhdGl0dWRlCiAgICAgICAgKSAtIHNvdXRoTWVyY2F0b3JZKSAqIG9uZU92ZXJNZXJjYXRvckhlaWdodDsKICAgICAgfQogICAgICBpZiAoaW5jbHVkZUdlb2RldGljU3VyZmFjZU5vcm1hbHMpIHsKICAgICAgICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxzW2ldID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbik7CiAgICAgIH0KICAgICAgTWF0cml4NF9kZWZhdWx0Lm11bHRpcGx5QnlQb2ludCh0b0VOVSwgcG9zaXRpb24sIGNhcnRlc2lhbjNTY3JhdGNoOCk7CiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5taW5pbXVtQnlDb21wb25lbnQoY2FydGVzaWFuM1NjcmF0Y2g4LCBtaW5pbXVtLCBtaW5pbXVtKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1heGltdW1CeUNvbXBvbmVudChjYXJ0ZXNpYW4zU2NyYXRjaDgsIG1heGltdW0sIG1heGltdW0pOwogICAgfQogICAgY29uc3Qgd2VzdEluZGljZXNTb3V0aFRvTm9ydGggPSBjb3B5QW5kU29ydChwYXJhbWV0ZXJzLndlc3RJbmRpY2VzLCBmdW5jdGlvbihhMywgYikgewogICAgICByZXR1cm4gdXZzW2EzXS55IC0gdXZzW2JdLnk7CiAgICB9KTsKICAgIGNvbnN0IGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoID0gY29weUFuZFNvcnQocGFyYW1ldGVycy5lYXN0SW5kaWNlcywgZnVuY3Rpb24oYTMsIGIpIHsKICAgICAgcmV0dXJuIHV2c1tiXS55IC0gdXZzW2EzXS55OwogICAgfSk7CiAgICBjb25zdCBzb3V0aEluZGljZXNFYXN0VG9XZXN0ID0gY29weUFuZFNvcnQocGFyYW1ldGVycy5zb3V0aEluZGljZXMsIGZ1bmN0aW9uKGEzLCBiKSB7CiAgICAgIHJldHVybiB1dnNbYl0ueCAtIHV2c1thM10ueDsKICAgIH0pOwogICAgY29uc3Qgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCA9IGNvcHlBbmRTb3J0KHBhcmFtZXRlcnMubm9ydGhJbmRpY2VzLCBmdW5jdGlvbihhMywgYikgewogICAgICByZXR1cm4gdXZzW2EzXS54IC0gdXZzW2JdLng7CiAgICB9KTsKICAgIGxldCBvY2NsdWRlZVBvaW50SW5TY2FsZWRTcGFjZTsKICAgIGlmIChtaW5pbXVtSGVpZ2h0IDwgMCkgewogICAgICBjb25zdCBvY2NsdWRlciA9IG5ldyBFbGxpcHNvaWRhbE9jY2x1ZGVyX2RlZmF1bHQoZWxsaXBzb2lkKTsKICAgICAgb2NjbHVkZWVQb2ludEluU2NhbGVkU3BhY2UgPSBvY2NsdWRlci5jb21wdXRlSG9yaXpvbkN1bGxpbmdQb2ludFBvc3NpYmx5VW5kZXJFbGxpcHNvaWQoCiAgICAgICAgY2VudGVyLAogICAgICAgIHBvc2l0aW9ucywKICAgICAgICBtaW5pbXVtSGVpZ2h0CiAgICAgICk7CiAgICB9CiAgICBsZXQgaE1pbiA9IG1pbmltdW1IZWlnaHQ7CiAgICBoTWluID0gTWF0aC5taW4oCiAgICAgIGhNaW4sCiAgICAgIGZpbmRNaW5NYXhTa2lydHMoCiAgICAgICAgcGFyYW1ldGVycy53ZXN0SW5kaWNlcywKICAgICAgICBwYXJhbWV0ZXJzLndlc3RTa2lydEhlaWdodCwKICAgICAgICBoZWlnaHRzLAogICAgICAgIHV2cywKICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIHRvRU5VLAogICAgICAgIG1pbmltdW0sCiAgICAgICAgbWF4aW11bQogICAgICApCiAgICApOwogICAgaE1pbiA9IE1hdGgubWluKAogICAgICBoTWluLAogICAgICBmaW5kTWluTWF4U2tpcnRzKAogICAgICAgIHBhcmFtZXRlcnMuc291dGhJbmRpY2VzLAogICAgICAgIHBhcmFtZXRlcnMuc291dGhTa2lydEhlaWdodCwKICAgICAgICBoZWlnaHRzLAogICAgICAgIHV2cywKICAgICAgICByZWN0YW5nbGUsCiAgICAgICAgZWxsaXBzb2lkLAogICAgICAgIHRvRU5VLAogICAgICAgIG1pbmltdW0sCiAgICAgICAgbWF4aW11bQogICAgICApCiAgICApOwogICAgaE1pbiA9IE1hdGgubWluKAogICAgICBoTWluLAogICAgICBmaW5kTWluTWF4U2tpcnRzKAogICAgICAgIHBhcmFtZXRlcnMuZWFzdEluZGljZXMsCiAgICAgICAgcGFyYW1ldGVycy5lYXN0U2tpcnRIZWlnaHQsCiAgICAgICAgaGVpZ2h0cywKICAgICAgICB1dnMsCiAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICB0b0VOVSwKICAgICAgICBtaW5pbXVtLAogICAgICAgIG1heGltdW0KICAgICAgKQogICAgKTsKICAgIGhNaW4gPSBNYXRoLm1pbigKICAgICAgaE1pbiwKICAgICAgZmluZE1pbk1heFNraXJ0cygKICAgICAgICBwYXJhbWV0ZXJzLm5vcnRoSW5kaWNlcywKICAgICAgICBwYXJhbWV0ZXJzLm5vcnRoU2tpcnRIZWlnaHQsCiAgICAgICAgaGVpZ2h0cywKICAgICAgICB1dnMsCiAgICAgICAgcmVjdGFuZ2xlLAogICAgICAgIGVsbGlwc29pZCwKICAgICAgICB0b0VOVSwKICAgICAgICBtaW5pbXVtLAogICAgICAgIG1heGltdW0KICAgICAgKQogICAgKTsKICAgIGNvbnN0IGFhQm94ID0gbmV3IEF4aXNBbGlnbmVkQm91bmRpbmdCb3hfZGVmYXVsdChtaW5pbXVtLCBtYXhpbXVtLCBjZW50ZXIpOwogICAgY29uc3QgZW5jb2RpbmcgPSBuZXcgVGVycmFpbkVuY29kaW5nX2RlZmF1bHQoCiAgICAgIGNlbnRlciwKICAgICAgYWFCb3gsCiAgICAgIGhNaW4sCiAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgIGZyb21FTlUsCiAgICAgIGhhc1ZlcnRleE5vcm1hbHMsCiAgICAgIGluY2x1ZGVXZWJNZXJjYXRvclQsCiAgICAgIGluY2x1ZGVHZW9kZXRpY1N1cmZhY2VOb3JtYWxzLAogICAgICBleGFnZ2VyYXRpb24sCiAgICAgIGV4YWdnZXJhdGlvblJlbGF0aXZlSGVpZ2h0CiAgICApOwogICAgY29uc3QgdmVydGV4U3RyaWRlID0gZW5jb2Rpbmcuc3RyaWRlOwogICAgY29uc3Qgc2l6ZSA9IHF1YW50aXplZFZlcnRleENvdW50ICogdmVydGV4U3RyaWRlICsgZWRnZVZlcnRleENvdW50ICogdmVydGV4U3RyaWRlOwogICAgY29uc3QgdmVydGV4QnVmZmVyID0gbmV3IEZsb2F0MzJBcnJheShzaXplKTsKICAgIGxldCBidWZmZXJJbmRleCA9IDA7CiAgICBmb3IgKGxldCBqID0gMDsgaiA8IHF1YW50aXplZFZlcnRleENvdW50OyArK2opIHsKICAgICAgaWYgKGhhc1ZlcnRleE5vcm1hbHMpIHsKICAgICAgICBjb25zdCBuID0gaiAqIDI7CiAgICAgICAgdG9QYWNrLnggPSBvY3RFbmNvZGVkTm9ybWFsc1tuXTsKICAgICAgICB0b1BhY2sueSA9IG9jdEVuY29kZWROb3JtYWxzW24gKyAxXTsKICAgICAgfQogICAgICBidWZmZXJJbmRleCA9IGVuY29kaW5nLmVuY29kZSgKICAgICAgICB2ZXJ0ZXhCdWZmZXIsCiAgICAgICAgYnVmZmVySW5kZXgsCiAgICAgICAgcG9zaXRpb25zW2pdLAogICAgICAgIHV2c1tqXSwKICAgICAgICBoZWlnaHRzW2pdLAogICAgICAgIHRvUGFjaywKICAgICAgICB3ZWJNZXJjYXRvclRzW2pdLAogICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbHNbal0KICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGVkZ2VUcmlhbmdsZUNvdW50ID0gTWF0aC5tYXgoMCwgKGVkZ2VWZXJ0ZXhDb3VudCAtIDQpICogMik7CiAgICBjb25zdCBpbmRleEJ1ZmZlckxlbmd0aCA9IHBhcmFtZXRlcnMuaW5kaWNlcy5sZW5ndGggKyBlZGdlVHJpYW5nbGVDb3VudCAqIDM7CiAgICBjb25zdCBpbmRleEJ1ZmZlciA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICBxdWFudGl6ZWRWZXJ0ZXhDb3VudCArIGVkZ2VWZXJ0ZXhDb3VudCwKICAgICAgaW5kZXhCdWZmZXJMZW5ndGgKICAgICk7CiAgICBpbmRleEJ1ZmZlci5zZXQocGFyYW1ldGVycy5pbmRpY2VzLCAwKTsKICAgIGNvbnN0IHBlcmNlbnRhZ2UgPSAxZS00OwogICAgY29uc3QgbG9uT2Zmc2V0ID0gKG1heExvbmdpdHVkZSAtIG1pbkxvbmdpdHVkZSkgKiBwZXJjZW50YWdlOwogICAgY29uc3QgbGF0T2Zmc2V0ID0gKG1heExhdGl0dWRlIC0gbWluTGF0aXR1ZGUpICogcGVyY2VudGFnZTsKICAgIGNvbnN0IHdlc3RMb25naXR1ZGVPZmZzZXQgPSAtbG9uT2Zmc2V0OwogICAgY29uc3Qgd2VzdExhdGl0dWRlT2Zmc2V0ID0gMDsKICAgIGNvbnN0IGVhc3RMb25naXR1ZGVPZmZzZXQgPSBsb25PZmZzZXQ7CiAgICBjb25zdCBlYXN0TGF0aXR1ZGVPZmZzZXQgPSAwOwogICAgY29uc3Qgbm9ydGhMb25naXR1ZGVPZmZzZXQgPSAwOwogICAgY29uc3Qgbm9ydGhMYXRpdHVkZU9mZnNldCA9IGxhdE9mZnNldDsKICAgIGNvbnN0IHNvdXRoTG9uZ2l0dWRlT2Zmc2V0ID0gMDsKICAgIGNvbnN0IHNvdXRoTGF0aXR1ZGVPZmZzZXQgPSAtbGF0T2Zmc2V0OwogICAgbGV0IHZlcnRleEJ1ZmZlckluZGV4ID0gcXVhbnRpemVkVmVydGV4Q291bnQgKiB2ZXJ0ZXhTdHJpZGU7CiAgICBhZGRTa2lydDIoCiAgICAgIHZlcnRleEJ1ZmZlciwKICAgICAgdmVydGV4QnVmZmVySW5kZXgsCiAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICBlbmNvZGluZywKICAgICAgaGVpZ2h0cywKICAgICAgdXZzLAogICAgICBvY3RFbmNvZGVkTm9ybWFscywKICAgICAgZWxsaXBzb2lkLAogICAgICByZWN0YW5nbGUsCiAgICAgIHBhcmFtZXRlcnMud2VzdFNraXJ0SGVpZ2h0LAogICAgICBzb3V0aE1lcmNhdG9yWSwKICAgICAgb25lT3Zlck1lcmNhdG9ySGVpZ2h0LAogICAgICB3ZXN0TG9uZ2l0dWRlT2Zmc2V0LAogICAgICB3ZXN0TGF0aXR1ZGVPZmZzZXQKICAgICk7CiAgICB2ZXJ0ZXhCdWZmZXJJbmRleCArPSBwYXJhbWV0ZXJzLndlc3RJbmRpY2VzLmxlbmd0aCAqIHZlcnRleFN0cmlkZTsKICAgIGFkZFNraXJ0MigKICAgICAgdmVydGV4QnVmZmVyLAogICAgICB2ZXJ0ZXhCdWZmZXJJbmRleCwKICAgICAgc291dGhJbmRpY2VzRWFzdFRvV2VzdCwKICAgICAgZW5jb2RpbmcsCiAgICAgIGhlaWdodHMsCiAgICAgIHV2cywKICAgICAgb2N0RW5jb2RlZE5vcm1hbHMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgcmVjdGFuZ2xlLAogICAgICBwYXJhbWV0ZXJzLnNvdXRoU2tpcnRIZWlnaHQsCiAgICAgIHNvdXRoTWVyY2F0b3JZLAogICAgICBvbmVPdmVyTWVyY2F0b3JIZWlnaHQsCiAgICAgIHNvdXRoTG9uZ2l0dWRlT2Zmc2V0LAogICAgICBzb3V0aExhdGl0dWRlT2Zmc2V0CiAgICApOwogICAgdmVydGV4QnVmZmVySW5kZXggKz0gcGFyYW1ldGVycy5zb3V0aEluZGljZXMubGVuZ3RoICogdmVydGV4U3RyaWRlOwogICAgYWRkU2tpcnQyKAogICAgICB2ZXJ0ZXhCdWZmZXIsCiAgICAgIHZlcnRleEJ1ZmZlckluZGV4LAogICAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwKICAgICAgZW5jb2RpbmcsCiAgICAgIGhlaWdodHMsCiAgICAgIHV2cywKICAgICAgb2N0RW5jb2RlZE5vcm1hbHMsCiAgICAgIGVsbGlwc29pZCwKICAgICAgcmVjdGFuZ2xlLAogICAgICBwYXJhbWV0ZXJzLmVhc3RTa2lydEhlaWdodCwKICAgICAgc291dGhNZXJjYXRvclksCiAgICAgIG9uZU92ZXJNZXJjYXRvckhlaWdodCwKICAgICAgZWFzdExvbmdpdHVkZU9mZnNldCwKICAgICAgZWFzdExhdGl0dWRlT2Zmc2V0CiAgICApOwogICAgdmVydGV4QnVmZmVySW5kZXggKz0gcGFyYW1ldGVycy5lYXN0SW5kaWNlcy5sZW5ndGggKiB2ZXJ0ZXhTdHJpZGU7CiAgICBhZGRTa2lydDIoCiAgICAgIHZlcnRleEJ1ZmZlciwKICAgICAgdmVydGV4QnVmZmVySW5kZXgsCiAgICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QsCiAgICAgIGVuY29kaW5nLAogICAgICBoZWlnaHRzLAogICAgICB1dnMsCiAgICAgIG9jdEVuY29kZWROb3JtYWxzLAogICAgICBlbGxpcHNvaWQsCiAgICAgIHJlY3RhbmdsZSwKICAgICAgcGFyYW1ldGVycy5ub3J0aFNraXJ0SGVpZ2h0LAogICAgICBzb3V0aE1lcmNhdG9yWSwKICAgICAgb25lT3Zlck1lcmNhdG9ySGVpZ2h0LAogICAgICBub3J0aExvbmdpdHVkZU9mZnNldCwKICAgICAgbm9ydGhMYXRpdHVkZU9mZnNldAogICAgKTsKICAgIFRlcnJhaW5Qcm92aWRlcl9kZWZhdWx0LmFkZFNraXJ0SW5kaWNlcygKICAgICAgd2VzdEluZGljZXNTb3V0aFRvTm9ydGgsCiAgICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICAgIGVhc3RJbmRpY2VzTm9ydGhUb1NvdXRoLAogICAgICBub3J0aEluZGljZXNXZXN0VG9FYXN0LAogICAgICBxdWFudGl6ZWRWZXJ0ZXhDb3VudCwKICAgICAgaW5kZXhCdWZmZXIsCiAgICAgIHBhcmFtZXRlcnMuaW5kaWNlcy5sZW5ndGgKICAgICk7CiAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2godmVydGV4QnVmZmVyLmJ1ZmZlciwgaW5kZXhCdWZmZXIuYnVmZmVyKTsKICAgIHJldHVybiB7CiAgICAgIHZlcnRpY2VzOiB2ZXJ0ZXhCdWZmZXIuYnVmZmVyLAogICAgICBpbmRpY2VzOiBpbmRleEJ1ZmZlci5idWZmZXIsCiAgICAgIHdlc3RJbmRpY2VzU291dGhUb05vcnRoLAogICAgICBzb3V0aEluZGljZXNFYXN0VG9XZXN0LAogICAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwKICAgICAgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCwKICAgICAgdmVydGV4U3RyaWRlLAogICAgICBjZW50ZXIsCiAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgIG9jY2x1ZGVlUG9pbnRJblNjYWxlZFNwYWNlLAogICAgICBlbmNvZGluZywKICAgICAgaW5kZXhDb3VudFdpdGhvdXRTa2lydHM6IHBhcmFtZXRlcnMuaW5kaWNlcy5sZW5ndGgKICAgIH07CiAgfQogIGZ1bmN0aW9uIGZpbmRNaW5NYXhTa2lydHMoZWRnZUluZGljZXMsIGVkZ2VIZWlnaHQsIGhlaWdodHMsIHV2cywgcmVjdGFuZ2xlLCBlbGxpcHNvaWQsIHRvRU5VLCBtaW5pbXVtLCBtYXhpbXVtKSB7CiAgICBsZXQgaE1pbiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGNvbnN0IG5vcnRoID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgY29uc3Qgc291dGggPSByZWN0YW5nbGUuc291dGg7CiAgICBsZXQgZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgaWYgKGVhc3QgPCB3ZXN0KSB7CiAgICAgIGVhc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgIH0KICAgIGNvbnN0IGxlbmd0aCA9IGVkZ2VJbmRpY2VzLmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgY29uc3QgaW5kZXggPSBlZGdlSW5kaWNlc1tpXTsKICAgICAgY29uc3QgaCA9IGhlaWdodHNbaW5kZXhdOwogICAgICBjb25zdCB1diA9IHV2c1tpbmRleF07CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0LmxlcnAod2VzdCwgZWFzdCwgdXYueCk7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycChzb3V0aCwgbm9ydGgsIHV2LnkpOwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmhlaWdodCA9IGggLSBlZGdlSGVpZ2h0OwogICAgICBjb25zdCBwb3NpdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLAogICAgICAgIGNhcnRlc2lhbjNTY3JhdGNoOAogICAgICApOwogICAgICBNYXRyaXg0X2RlZmF1bHQubXVsdGlwbHlCeVBvaW50KHRvRU5VLCBwb3NpdGlvbiwgcG9zaXRpb24pOwogICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQubWluaW11bUJ5Q29tcG9uZW50KHBvc2l0aW9uLCBtaW5pbXVtLCBtaW5pbXVtKTsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0Lm1heGltdW1CeUNvbXBvbmVudChwb3NpdGlvbiwgbWF4aW11bSwgbWF4aW11bSk7CiAgICAgIGhNaW4gPSBNYXRoLm1pbihoTWluLCBjYXJ0b2dyYXBoaWNTY3JhdGNoLmhlaWdodCk7CiAgICB9CiAgICByZXR1cm4gaE1pbjsKICB9CiAgZnVuY3Rpb24gYWRkU2tpcnQyKHZlcnRleEJ1ZmZlciwgdmVydGV4QnVmZmVySW5kZXgsIGVkZ2VWZXJ0aWNlcywgZW5jb2RpbmcsIGhlaWdodHMsIHV2cywgb2N0RW5jb2RlZE5vcm1hbHMsIGVsbGlwc29pZCwgcmVjdGFuZ2xlLCBza2lydExlbmd0aCwgc291dGhNZXJjYXRvclksIG9uZU92ZXJNZXJjYXRvckhlaWdodCwgbG9uZ2l0dWRlT2Zmc2V0LCBsYXRpdHVkZU9mZnNldCkgewogICAgY29uc3QgaGFzVmVydGV4Tm9ybWFscyA9IGRlZmluZWRfZGVmYXVsdChvY3RFbmNvZGVkTm9ybWFscyk7CiAgICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICAgIGNvbnN0IHNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoOwogICAgbGV0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICAgIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICAgIGlmIChlYXN0IDwgd2VzdCkgewogICAgICBlYXN0ICs9IE1hdGhfZGVmYXVsdC5UV09fUEk7CiAgICB9CiAgICBjb25zdCBsZW5ndGggPSBlZGdlVmVydGljZXMubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb25zdCBpbmRleCA9IGVkZ2VWZXJ0aWNlc1tpXTsKICAgICAgY29uc3QgaCA9IGhlaWdodHNbaW5kZXhdOwogICAgICBjb25zdCB1diA9IHV2c1tpbmRleF07CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubG9uZ2l0dWRlID0gTWF0aF9kZWZhdWx0LmxlcnAod2VzdCwgZWFzdCwgdXYueCkgKyBsb25naXR1ZGVPZmZzZXQ7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gubGF0aXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycChzb3V0aCwgbm9ydGgsIHV2LnkpICsgbGF0aXR1ZGVPZmZzZXQ7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2guaGVpZ2h0ID0gaCAtIHNraXJ0TGVuZ3RoOwogICAgICBjb25zdCBwb3NpdGlvbiA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLAogICAgICAgIGNhcnRlc2lhbjNTY3JhdGNoOAogICAgICApOwogICAgICBpZiAoaGFzVmVydGV4Tm9ybWFscykgewogICAgICAgIGNvbnN0IG4gPSBpbmRleCAqIDI7CiAgICAgICAgdG9QYWNrLnggPSBvY3RFbmNvZGVkTm9ybWFsc1tuXTsKICAgICAgICB0b1BhY2sueSA9IG9jdEVuY29kZWROb3JtYWxzW24gKyAxXTsKICAgICAgfQogICAgICBsZXQgd2ViTWVyY2F0b3JUOwogICAgICBpZiAoZW5jb2RpbmcuaGFzV2ViTWVyY2F0b3JUKSB7CiAgICAgICAgd2ViTWVyY2F0b3JUID0gKFdlYk1lcmNhdG9yUHJvamVjdGlvbl9kZWZhdWx0Lmdlb2RldGljTGF0aXR1ZGVUb01lcmNhdG9yQW5nbGUoCiAgICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmxhdGl0dWRlCiAgICAgICAgKSAtIHNvdXRoTWVyY2F0b3JZKSAqIG9uZU92ZXJNZXJjYXRvckhlaWdodDsKICAgICAgfQogICAgICBsZXQgZ2VvZGV0aWNTdXJmYWNlTm9ybWFsOwogICAgICBpZiAoZW5jb2RpbmcuaGFzR2VvZGV0aWNTdXJmYWNlTm9ybWFscykgewogICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbCA9IGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocG9zaXRpb24pOwogICAgICB9CiAgICAgIHZlcnRleEJ1ZmZlckluZGV4ID0gZW5jb2RpbmcuZW5jb2RlKAogICAgICAgIHZlcnRleEJ1ZmZlciwKICAgICAgICB2ZXJ0ZXhCdWZmZXJJbmRleCwKICAgICAgICBwb3NpdGlvbiwKICAgICAgICB1diwKICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLmhlaWdodCwKICAgICAgICB0b1BhY2ssCiAgICAgICAgd2ViTWVyY2F0b3JULAogICAgICAgIGdlb2RldGljU3VyZmFjZU5vcm1hbAogICAgICApOwogICAgfQogIH0KICBmdW5jdGlvbiBjb3B5QW5kU29ydCh0eXBlZEFycmF5LCBjb21wYXJhdG9yKSB7CiAgICBsZXQgY29weTsKICAgIGlmICh0eXBlb2YgdHlwZWRBcnJheS5zbGljZSA9PT0gImZ1bmN0aW9uIikgewogICAgICBjb3B5ID0gdHlwZWRBcnJheS5zbGljZSgpOwogICAgICBpZiAodHlwZW9mIGNvcHkuc29ydCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIGNvcHkgPSB2b2lkIDA7CiAgICAgIH0KICAgIH0KICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNvcHkpKSB7CiAgICAgIGNvcHkgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0eXBlZEFycmF5KTsKICAgIH0KICAgIGNvcHkuc29ydChjb21wYXJhdG9yKTsKICAgIHJldHVybiBjb3B5OwogIH0KICB2YXIgbWF4U2hvcnQ0LCBjYXJ0ZXNpYW4zU2NyYXRjaDgsIHNjcmF0Y2hNaW5pbXVtLCBzY3JhdGNoTWF4aW11bSwgY2FydG9ncmFwaGljU2NyYXRjaCwgdG9QYWNrLCBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaC5qcyIoKSB7CiAgICAgIGluaXRfQXhpc0FsaWduZWRCb3VuZGluZ0JveCgpOwogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0VsbGlwc29pZGFsT2NjbHVkZXIoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X01hdHJpeDQoKTsKICAgICAgaW5pdF9SZWN0YW5nbGUoKTsKICAgICAgaW5pdF9UZXJyYWluRW5jb2RpbmcoKTsKICAgICAgaW5pdF9UZXJyYWluUHJvdmlkZXIoKTsKICAgICAgaW5pdF9UcmFuc2Zvcm1zKCk7CiAgICAgIGluaXRfV2ViTWVyY2F0b3JQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpOwogICAgICBtYXhTaG9ydDQgPSAzMjc2NzsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2g4ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTWluaW11bSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaE1heGltdW0gPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2ggPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgdG9QYWNrID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaF9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KAogICAgICAgIGNyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoCiAgICAgICk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9XYWxsR2VvbWV0cnlMaWJyYXJ5LmpzCiAgZnVuY3Rpb24gbGF0TG9uRXF1YWxzKGMwLCBjMSkgewogICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5lcXVhbHNFcHNpbG9uKGMwLmxhdGl0dWRlLCBjMS5sYXRpdHVkZSwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkgJiYgTWF0aF9kZWZhdWx0LmVxdWFsc0Vwc2lsb24oYzAubG9uZ2l0dWRlLCBjMS5sb25naXR1ZGUsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApOwogIH0KICBmdW5jdGlvbiByZW1vdmVEdXBsaWNhdGVzMihlbGxpcHNvaWQsIHBvc2l0aW9ucywgdG9wSGVpZ2h0cywgYm90dG9tSGVpZ2h0cykgewogICAgcG9zaXRpb25zID0gYXJyYXlSZW1vdmVEdXBsaWNhdGVzX2RlZmF1bHQocG9zaXRpb25zLCBDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbik7CiAgICBjb25zdCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgaWYgKGxlbmd0aCA8IDIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgaGFzQm90dG9tSGVpZ2h0cyA9IGRlZmluZWRfZGVmYXVsdChib3R0b21IZWlnaHRzKTsKICAgIGNvbnN0IGhhc1RvcEhlaWdodHMgPSBkZWZpbmVkX2RlZmF1bHQodG9wSGVpZ2h0cyk7CiAgICBjb25zdCBjbGVhbmVkUG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICBjb25zdCBjbGVhbmVkVG9wSGVpZ2h0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgY29uc3QgY2xlYW5lZEJvdHRvbUhlaWdodHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGNvbnN0IHYwMiA9IHBvc2l0aW9uc1swXTsKICAgIGNsZWFuZWRQb3NpdGlvbnNbMF0gPSB2MDI7CiAgICBjb25zdCBjMCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyh2MDIsIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxMyk7CiAgICBpZiAoaGFzVG9wSGVpZ2h0cykgewogICAgICBjMC5oZWlnaHQgPSB0b3BIZWlnaHRzWzBdOwogICAgfQogICAgY2xlYW5lZFRvcEhlaWdodHNbMF0gPSBjMC5oZWlnaHQ7CiAgICBpZiAoaGFzQm90dG9tSGVpZ2h0cykgewogICAgICBjbGVhbmVkQm90dG9tSGVpZ2h0c1swXSA9IGJvdHRvbUhlaWdodHNbMF07CiAgICB9IGVsc2UgewogICAgICBjbGVhbmVkQm90dG9tSGVpZ2h0c1swXSA9IDA7CiAgICB9CiAgICBjb25zdCBzdGFydFRvcEhlaWdodCA9IGNsZWFuZWRUb3BIZWlnaHRzWzBdOwogICAgY29uc3Qgc3RhcnRCb3R0b21IZWlnaHQgPSBjbGVhbmVkQm90dG9tSGVpZ2h0c1swXTsKICAgIGxldCBoYXNBbGxTYW1lSGVpZ2h0cyA9IHN0YXJ0VG9wSGVpZ2h0ID09PSBzdGFydEJvdHRvbUhlaWdodDsKICAgIGxldCBpbmRleCA9IDE7CiAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IHYxMiA9IHBvc2l0aW9uc1tpXTsKICAgICAgY29uc3QgYzEgPSBlbGxpcHNvaWQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWModjEyLCBzY3JhdGNoQ2FydG9ncmFwaGljMjMpOwogICAgICBpZiAoaGFzVG9wSGVpZ2h0cykgewogICAgICAgIGMxLmhlaWdodCA9IHRvcEhlaWdodHNbaV07CiAgICAgIH0KICAgICAgaGFzQWxsU2FtZUhlaWdodHMgPSBoYXNBbGxTYW1lSGVpZ2h0cyAmJiBjMS5oZWlnaHQgPT09IDA7CiAgICAgIGlmICghbGF0TG9uRXF1YWxzKGMwLCBjMSkpIHsKICAgICAgICBjbGVhbmVkUG9zaXRpb25zW2luZGV4XSA9IHYxMjsKICAgICAgICBjbGVhbmVkVG9wSGVpZ2h0c1tpbmRleF0gPSBjMS5oZWlnaHQ7CiAgICAgICAgaWYgKGhhc0JvdHRvbUhlaWdodHMpIHsKICAgICAgICAgIGNsZWFuZWRCb3R0b21IZWlnaHRzW2luZGV4XSA9IGJvdHRvbUhlaWdodHNbaV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNsZWFuZWRCb3R0b21IZWlnaHRzW2luZGV4XSA9IDA7CiAgICAgICAgfQogICAgICAgIGhhc0FsbFNhbWVIZWlnaHRzID0gaGFzQWxsU2FtZUhlaWdodHMgJiYgY2xlYW5lZFRvcEhlaWdodHNbaW5kZXhdID09PSBjbGVhbmVkQm90dG9tSGVpZ2h0c1tpbmRleF07CiAgICAgICAgQ2FydG9ncmFwaGljX2RlZmF1bHQuY2xvbmUoYzEsIGMwKTsKICAgICAgICArK2luZGV4OwogICAgICB9IGVsc2UgaWYgKGMwLmhlaWdodCA8IGMxLmhlaWdodCkgewogICAgICAgIGNsZWFuZWRUb3BIZWlnaHRzW2luZGV4IC0gMV0gPSBjMS5oZWlnaHQ7CiAgICAgIH0KICAgIH0KICAgIGlmIChoYXNBbGxTYW1lSGVpZ2h0cyB8fCBpbmRleCA8IDIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY2xlYW5lZFBvc2l0aW9ucy5sZW5ndGggPSBpbmRleDsKICAgIGNsZWFuZWRUb3BIZWlnaHRzLmxlbmd0aCA9IGluZGV4OwogICAgY2xlYW5lZEJvdHRvbUhlaWdodHMubGVuZ3RoID0gaW5kZXg7CiAgICByZXR1cm4gewogICAgICBwb3NpdGlvbnM6IGNsZWFuZWRQb3NpdGlvbnMsCiAgICAgIHRvcEhlaWdodHM6IGNsZWFuZWRUb3BIZWlnaHRzLAogICAgICBib3R0b21IZWlnaHRzOiBjbGVhbmVkQm90dG9tSGVpZ2h0cwogICAgfTsKICB9CiAgdmFyIFdhbGxHZW9tZXRyeUxpYnJhcnksIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxMywgc2NyYXRjaENhcnRvZ3JhcGhpYzIzLCBwb3NpdGlvbnNBcnJheVNjcmF0Y2gsIGhlaWdodHNBcnJheVNjcmF0Y2gsIGdlbmVyYXRlQXJjT3B0aW9uc1NjcmF0Y2gyLCBXYWxsR2VvbWV0cnlMaWJyYXJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfV2FsbEdlb21ldHJ5TGlicmFyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2FsbEdlb21ldHJ5TGlicmFyeS5qcyIoKSB7CiAgICAgIGluaXRfYXJyYXlSZW1vdmVEdXBsaWNhdGVzKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NhcnRvZ3JhcGhpYygpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUG9seWxpbmVQaXBlbGluZSgpOwogICAgICBXYWxsR2VvbWV0cnlMaWJyYXJ5ID0ge307CiAgICAgIHNjcmF0Y2hDYXJ0b2dyYXBoaWMxMyA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljMjMgPSBuZXcgQ2FydG9ncmFwaGljX2RlZmF1bHQoKTsKICAgICAgcG9zaXRpb25zQXJyYXlTY3JhdGNoID0gbmV3IEFycmF5KDIpOwogICAgICBoZWlnaHRzQXJyYXlTY3JhdGNoID0gbmV3IEFycmF5KDIpOwogICAgICBnZW5lcmF0ZUFyY09wdGlvbnNTY3JhdGNoMiA9IHsKICAgICAgICBwb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgICBoZWlnaHQ6IHZvaWQgMCwKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwLAogICAgICAgIGVsbGlwc29pZDogdm9pZCAwCiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeUxpYnJhcnkuY29tcHV0ZVBvc2l0aW9ucyA9IGZ1bmN0aW9uKGVsbGlwc29pZCwgd2FsbFBvc2l0aW9ucywgbWF4aW11bUhlaWdodHMsIG1pbmltdW1IZWlnaHRzLCBncmFudWxhcml0eSwgZHVwbGljYXRlQ29ybmVycykgewogICAgICAgIGNvbnN0IG8gPSByZW1vdmVEdXBsaWNhdGVzMigKICAgICAgICAgIGVsbGlwc29pZCwKICAgICAgICAgIHdhbGxQb3NpdGlvbnMsCiAgICAgICAgICBtYXhpbXVtSGVpZ2h0cywKICAgICAgICAgIG1pbmltdW1IZWlnaHRzCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChvKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB3YWxsUG9zaXRpb25zID0gby5wb3NpdGlvbnM7CiAgICAgICAgbWF4aW11bUhlaWdodHMgPSBvLnRvcEhlaWdodHM7CiAgICAgICAgbWluaW11bUhlaWdodHMgPSBvLmJvdHRvbUhlaWdodHM7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gd2FsbFBvc2l0aW9ucy5sZW5ndGg7CiAgICAgICAgY29uc3QgbnVtQ29ybmVycyA9IGxlbmd0aCAtIDI7CiAgICAgICAgbGV0IHRvcFBvc2l0aW9uczsKICAgICAgICBsZXQgYm90dG9tUG9zaXRpb25zOwogICAgICAgIGNvbnN0IG1pbkRpc3RhbmNlID0gTWF0aF9kZWZhdWx0LmNob3JkTGVuZ3RoKAogICAgICAgICAgZ3JhbnVsYXJpdHksCiAgICAgICAgICBlbGxpcHNvaWQubWF4aW11bVJhZGl1cwogICAgICAgICk7CiAgICAgICAgY29uc3QgZ2VuZXJhdGVBcmNPcHRpb25zID0gZ2VuZXJhdGVBcmNPcHRpb25zU2NyYXRjaDI7CiAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLm1pbkRpc3RhbmNlID0gbWluRGlzdGFuY2U7CiAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLmVsbGlwc29pZCA9IGVsbGlwc29pZDsKICAgICAgICBpZiAoZHVwbGljYXRlQ29ybmVycykgewogICAgICAgICAgbGV0IGNvdW50ID0gMDsKICAgICAgICAgIGxldCBpOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgICBjb3VudCArPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQubnVtYmVyT2ZQb2ludHMoCiAgICAgICAgICAgICAgd2FsbFBvc2l0aW9uc1tpXSwKICAgICAgICAgICAgICB3YWxsUG9zaXRpb25zW2kgKyAxXSwKICAgICAgICAgICAgICBtaW5EaXN0YW5jZQogICAgICAgICAgICApICsgMTsKICAgICAgICAgIH0KICAgICAgICAgIHRvcFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoY291bnQgKiAzKTsKICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoY291bnQgKiAzKTsKICAgICAgICAgIGNvbnN0IGdlbmVyYXRlQXJjUG9zaXRpb25zID0gcG9zaXRpb25zQXJyYXlTY3JhdGNoOwogICAgICAgICAgY29uc3QgZ2VuZXJhdGVBcmNIZWlnaHRzID0gaGVpZ2h0c0FycmF5U2NyYXRjaDsKICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5wb3NpdGlvbnMgPSBnZW5lcmF0ZUFyY1Bvc2l0aW9uczsKICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5oZWlnaHQgPSBnZW5lcmF0ZUFyY0hlaWdodHM7CiAgICAgICAgICBsZXQgb2Zmc2V0ID0gMDsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNQb3NpdGlvbnNbMF0gPSB3YWxsUG9zaXRpb25zW2ldOwogICAgICAgICAgICBnZW5lcmF0ZUFyY1Bvc2l0aW9uc1sxXSA9IHdhbGxQb3NpdGlvbnNbaSArIDFdOwogICAgICAgICAgICBnZW5lcmF0ZUFyY0hlaWdodHNbMF0gPSBtYXhpbXVtSGVpZ2h0c1tpXTsKICAgICAgICAgICAgZ2VuZXJhdGVBcmNIZWlnaHRzWzFdID0gbWF4aW11bUhlaWdodHNbaSArIDFdOwogICAgICAgICAgICBjb25zdCBwb3MgPSBQb2x5bGluZVBpcGVsaW5lX2RlZmF1bHQuZ2VuZXJhdGVBcmMoZ2VuZXJhdGVBcmNPcHRpb25zKTsKICAgICAgICAgICAgdG9wUG9zaXRpb25zLnNldChwb3MsIG9mZnNldCk7CiAgICAgICAgICAgIGdlbmVyYXRlQXJjSGVpZ2h0c1swXSA9IG1pbmltdW1IZWlnaHRzW2ldOwogICAgICAgICAgICBnZW5lcmF0ZUFyY0hlaWdodHNbMV0gPSBtaW5pbXVtSGVpZ2h0c1tpICsgMV07CiAgICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucy5zZXQoCiAgICAgICAgICAgICAgUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKGdlbmVyYXRlQXJjT3B0aW9ucyksCiAgICAgICAgICAgICAgb2Zmc2V0CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIG9mZnNldCArPSBwb3MubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBnZW5lcmF0ZUFyY09wdGlvbnMucG9zaXRpb25zID0gd2FsbFBvc2l0aW9uczsKICAgICAgICAgIGdlbmVyYXRlQXJjT3B0aW9ucy5oZWlnaHQgPSBtYXhpbXVtSGVpZ2h0czsKICAgICAgICAgIHRvcFBvc2l0aW9ucyA9IG5ldyBGbG9hdDY0QXJyYXkoCiAgICAgICAgICAgIFBvbHlsaW5lUGlwZWxpbmVfZGVmYXVsdC5nZW5lcmF0ZUFyYyhnZW5lcmF0ZUFyY09wdGlvbnMpCiAgICAgICAgICApOwogICAgICAgICAgZ2VuZXJhdGVBcmNPcHRpb25zLmhlaWdodCA9IG1pbmltdW1IZWlnaHRzOwogICAgICAgICAgYm90dG9tUG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheSgKICAgICAgICAgICAgUG9seWxpbmVQaXBlbGluZV9kZWZhdWx0LmdlbmVyYXRlQXJjKGdlbmVyYXRlQXJjT3B0aW9ucykKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBib3R0b21Qb3NpdGlvbnMsCiAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICBudW1Db3JuZXJzCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgV2FsbEdlb21ldHJ5TGlicmFyeV9kZWZhdWx0ID0gV2FsbEdlb21ldHJ5TGlicmFyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dhbGxHZW9tZXRyeS5qcwogIGZ1bmN0aW9uIFdhbGxHZW9tZXRyeShvcHRpb25zKSB7CiAgICBvcHRpb25zID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucywgZGVmYXVsdFZhbHVlX2RlZmF1bHQuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHdhbGxQb3NpdGlvbnMgPSBvcHRpb25zLnBvc2l0aW9uczsKICAgIGNvbnN0IG1heGltdW1IZWlnaHRzID0gb3B0aW9ucy5tYXhpbXVtSGVpZ2h0czsKICAgIGNvbnN0IG1pbmltdW1IZWlnaHRzID0gb3B0aW9ucy5taW5pbXVtSGVpZ2h0czsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHdhbGxQb3NpdGlvbnMpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvc2l0aW9ucyBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpICYmIG1heGltdW1IZWlnaHRzLmxlbmd0aCAhPT0gd2FsbFBvc2l0aW9ucy5sZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoCiAgICAgICAgIm9wdGlvbnMucG9zaXRpb25zIGFuZCBvcHRpb25zLm1heGltdW1IZWlnaHRzIG11c3QgaGF2ZSB0aGUgc2FtZSBsZW5ndGguIgogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtaW5pbXVtSGVpZ2h0cykgJiYgbWluaW11bUhlaWdodHMubGVuZ3RoICE9PSB3YWxsUG9zaXRpb25zLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5wb3NpdGlvbnMgYW5kIG9wdGlvbnMubWluaW11bUhlaWdodHMgbXVzdCBoYXZlIHRoZSBzYW1lIGxlbmd0aC4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLnZlcnRleEZvcm1hdCwgVmVydGV4Rm9ybWF0X2RlZmF1bHQuREVGQVVMVCk7CiAgICBjb25zdCBncmFudWxhcml0eSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBvcHRpb25zLmdyYW51bGFyaXR5LAogICAgICBNYXRoX2RlZmF1bHQuUkFESUFOU19QRVJfREVHUkVFCiAgICApOwogICAgY29uc3QgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQob3B0aW9ucy5lbGxpcHNvaWQsIEVsbGlwc29pZF9kZWZhdWx0LldHUzg0KTsKICAgIHRoaXMuX3Bvc2l0aW9ucyA9IHdhbGxQb3NpdGlvbnM7CiAgICB0aGlzLl9taW5pbXVtSGVpZ2h0cyA9IG1pbmltdW1IZWlnaHRzOwogICAgdGhpcy5fbWF4aW11bUhlaWdodHMgPSBtYXhpbXVtSGVpZ2h0czsKICAgIHRoaXMuX3ZlcnRleEZvcm1hdCA9IFZlcnRleEZvcm1hdF9kZWZhdWx0LmNsb25lKHZlcnRleEZvcm1hdCk7CiAgICB0aGlzLl9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgdGhpcy5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUoZWxsaXBzb2lkKTsKICAgIHRoaXMuX3dvcmtlck5hbWUgPSAiY3JlYXRlV2FsbEdlb21ldHJ5IjsKICAgIGxldCBudW1Db21wb25lbnRzID0gMSArIHdhbGxQb3NpdGlvbnMubGVuZ3RoICogQ2FydGVzaWFuM19kZWZhdWx0LnBhY2tlZExlbmd0aCArIDI7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSkgewogICAgICBudW1Db21wb25lbnRzICs9IG1pbmltdW1IZWlnaHRzLmxlbmd0aDsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpKSB7CiAgICAgIG51bUNvbXBvbmVudHMgKz0gbWF4aW11bUhlaWdodHMubGVuZ3RoOwogICAgfQogICAgdGhpcy5wYWNrZWRMZW5ndGggPSBudW1Db21wb25lbnRzICsgRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMTsKICB9CiAgdmFyIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xLCBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMiwgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjQsIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241LCBzY3JhdGNoQml0YW5nZW50NSwgc2NyYXRjaFRhbmdlbnQ1LCBzY3JhdGNoTm9ybWFsOCwgc2NyYXRjaEVsbGlwc29pZDE3LCBzY3JhdGNoVmVydGV4Rm9ybWF0MTMsIHNjcmF0Y2hPcHRpb25zMjMsIFdhbGxHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1dhbGxHZW9tZXRyeSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvV2FsbEdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9Cb3VuZGluZ1NwaGVyZSgpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X0dlb21ldHJ5KCk7CiAgICAgIGluaXRfR2VvbWV0cnlBdHRyaWJ1dGUoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZXMoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfTWF0aCgpOwogICAgICBpbml0X1ByaW1pdGl2ZVR5cGUoKTsKICAgICAgaW5pdF9WZXJ0ZXhGb3JtYXQoKTsKICAgICAgaW5pdF9XYWxsR2VvbWV0cnlMaWJyYXJ5KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjQgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQml0YW5nZW50NSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgc2NyYXRjaFRhbmdlbnQ1ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoTm9ybWFsOCA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgV2FsbEdlb21ldHJ5LnBhY2sgPSBmdW5jdGlvbih2YWx1ZSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh2YWx1ZSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ2YWx1ZSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gdmFsdWUuX3Bvc2l0aW9uczsKICAgICAgICBsZXQgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhwb3NpdGlvbnNbaV0sIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWluaW11bUhlaWdodHMgPSB2YWx1ZS5fbWluaW11bUhlaWdodHM7CiAgICAgICAgbGVuZ3RoID0gZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSA/IG1pbmltdW1IZWlnaHRzLmxlbmd0aCA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBtaW5pbXVtSGVpZ2h0c1tpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgbWF4aW11bUhlaWdodHMgPSB2YWx1ZS5fbWF4aW11bUhlaWdodHM7CiAgICAgICAgbGVuZ3RoID0gZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHRzKSA/IG1heGltdW1IZWlnaHRzLmxlbmd0aCA6IDA7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IGxlbmd0aDsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1heGltdW1IZWlnaHRzKSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBtYXhpbXVtSGVpZ2h0c1tpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgRWxsaXBzb2lkX2RlZmF1bHQucGFjayh2YWx1ZS5fZWxsaXBzb2lkLCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFjayh2YWx1ZS5fdmVydGV4Rm9ybWF0LCBhcnJheSwgc3RhcnRpbmdJbmRleCk7CiAgICAgICAgc3RhcnRpbmdJbmRleCArPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC5wYWNrZWRMZW5ndGg7CiAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleF0gPSB2YWx1ZS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICB9OwogICAgICBzY3JhdGNoRWxsaXBzb2lkMTcgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShFbGxpcHNvaWRfZGVmYXVsdC5VTklUX1NQSEVSRSk7CiAgICAgIHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMyA9IG5ldyBWZXJ0ZXhGb3JtYXRfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoT3B0aW9uczIzID0gewogICAgICAgIHBvc2l0aW9uczogdm9pZCAwLAogICAgICAgIG1pbmltdW1IZWlnaHRzOiB2b2lkIDAsCiAgICAgICAgbWF4aW11bUhlaWdodHM6IHZvaWQgMCwKICAgICAgICBlbGxpcHNvaWQ6IHNjcmF0Y2hFbGxpcHNvaWQxNywKICAgICAgICB2ZXJ0ZXhGb3JtYXQ6IHNjcmF0Y2hWZXJ0ZXhGb3JtYXQxMywKICAgICAgICBncmFudWxhcml0eTogdm9pZCAwCiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeS51bnBhY2sgPSBmdW5jdGlvbihhcnJheSwgc3RhcnRpbmdJbmRleCwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoYXJyYXkpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgiYXJyYXkgaXMgcmVxdWlyZWQiKTsKICAgICAgICB9CiAgICAgICAgc3RhcnRpbmdJbmRleCA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KHN0YXJ0aW5nSW5kZXgsIDApOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSwgc3RhcnRpbmdJbmRleCArPSBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoKSB7CiAgICAgICAgICBwb3NpdGlvbnNbaV0gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICB9CiAgICAgICAgbGVuZ3RoID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICBsZXQgbWluaW11bUhlaWdodHM7CiAgICAgICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgICAgIG1pbmltdW1IZWlnaHRzID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgbWluaW11bUhlaWdodHNbaV0gPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGxldCBtYXhpbXVtSGVpZ2h0czsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgbWF4aW11bUhlaWdodHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBtYXhpbXVtSGVpZ2h0c1tpXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LnVucGFjayhhcnJheSwgc3RhcnRpbmdJbmRleCwgc2NyYXRjaEVsbGlwc29pZDE3KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSBWZXJ0ZXhGb3JtYXRfZGVmYXVsdC51bnBhY2soCiAgICAgICAgICBhcnJheSwKICAgICAgICAgIHN0YXJ0aW5nSW5kZXgsCiAgICAgICAgICBzY3JhdGNoVmVydGV4Rm9ybWF0MTMKICAgICAgICApOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gVmVydGV4Rm9ybWF0X2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyMy5wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIzLm1pbmltdW1IZWlnaHRzID0gbWluaW11bUhlaWdodHM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIzLm1heGltdW1IZWlnaHRzID0gbWF4aW11bUhlaWdodHM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczIzLmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICByZXR1cm4gbmV3IFdhbGxHZW9tZXRyeShzY3JhdGNoT3B0aW9uczIzKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0Ll9wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgcmVzdWx0Ll9taW5pbXVtSGVpZ2h0cyA9IG1pbmltdW1IZWlnaHRzOwogICAgICAgIHJlc3VsdC5fbWF4aW11bUhlaWdodHMgPSBtYXhpbXVtSGVpZ2h0czsKICAgICAgICByZXN1bHQuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCwgcmVzdWx0Ll9lbGxpcHNvaWQpOwogICAgICAgIHJlc3VsdC5fdmVydGV4Rm9ybWF0ID0gVmVydGV4Rm9ybWF0X2RlZmF1bHQuY2xvbmUodmVydGV4Rm9ybWF0LCByZXN1bHQuX3ZlcnRleEZvcm1hdCk7CiAgICAgICAgcmVzdWx0Ll9ncmFudWxhcml0eSA9IGdyYW51bGFyaXR5OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeS5mcm9tQ29uc3RhbnRIZWlnaHRzID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvc2l0aW9ucyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IG1pbkhlaWdodHM7CiAgICAgICAgbGV0IG1heEhlaWdodHM7CiAgICAgICAgY29uc3QgbWluMyA9IG9wdGlvbnMubWluaW11bUhlaWdodDsKICAgICAgICBjb25zdCBtYXgzID0gb3B0aW9ucy5tYXhpbXVtSGVpZ2h0OwogICAgICAgIGNvbnN0IGRvTWluID0gZGVmaW5lZF9kZWZhdWx0KG1pbjMpOwogICAgICAgIGNvbnN0IGRvTWF4ID0gZGVmaW5lZF9kZWZhdWx0KG1heDMpOwogICAgICAgIGlmIChkb01pbiB8fCBkb01heCkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIG1pbkhlaWdodHMgPSBkb01pbiA/IG5ldyBBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgICAgICAgbWF4SGVpZ2h0cyA9IGRvTWF4ID8gbmV3IEFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGlmIChkb01pbikgewogICAgICAgICAgICAgIG1pbkhlaWdodHNbaV0gPSBtaW4zOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkb01heCkgewogICAgICAgICAgICAgIG1heEhlaWdodHNbaV0gPSBtYXgzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBtYXhpbXVtSGVpZ2h0czogbWF4SGVpZ2h0cywKICAgICAgICAgIG1pbmltdW1IZWlnaHRzOiBtaW5IZWlnaHRzLAogICAgICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZCwKICAgICAgICAgIHZlcnRleEZvcm1hdDogb3B0aW9ucy52ZXJ0ZXhGb3JtYXQKICAgICAgICB9OwogICAgICAgIHJldHVybiBuZXcgV2FsbEdlb21ldHJ5KG5ld09wdGlvbnMpOwogICAgICB9OwogICAgICBXYWxsR2VvbWV0cnkuY3JlYXRlR2VvbWV0cnkgPSBmdW5jdGlvbih3YWxsR2VvbWV0cnkpIHsKICAgICAgICBjb25zdCB3YWxsUG9zaXRpb25zID0gd2FsbEdlb21ldHJ5Ll9wb3NpdGlvbnM7CiAgICAgICAgY29uc3QgbWluaW11bUhlaWdodHMgPSB3YWxsR2VvbWV0cnkuX21pbmltdW1IZWlnaHRzOwogICAgICAgIGNvbnN0IG1heGltdW1IZWlnaHRzID0gd2FsbEdlb21ldHJ5Ll9tYXhpbXVtSGVpZ2h0czsKICAgICAgICBjb25zdCB2ZXJ0ZXhGb3JtYXQgPSB3YWxsR2VvbWV0cnkuX3ZlcnRleEZvcm1hdDsKICAgICAgICBjb25zdCBncmFudWxhcml0eSA9IHdhbGxHZW9tZXRyeS5fZ3JhbnVsYXJpdHk7CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gd2FsbEdlb21ldHJ5Ll9lbGxpcHNvaWQ7CiAgICAgICAgY29uc3QgcG9zID0gV2FsbEdlb21ldHJ5TGlicmFyeV9kZWZhdWx0LmNvbXB1dGVQb3NpdGlvbnMoCiAgICAgICAgICBlbGxpcHNvaWQsCiAgICAgICAgICB3YWxsUG9zaXRpb25zLAogICAgICAgICAgbWF4aW11bUhlaWdodHMsCiAgICAgICAgICBtaW5pbXVtSGVpZ2h0cywKICAgICAgICAgIGdyYW51bGFyaXR5LAogICAgICAgICAgdHJ1ZQogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocG9zKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3R0b21Qb3NpdGlvbnMgPSBwb3MuYm90dG9tUG9zaXRpb25zOwogICAgICAgIGNvbnN0IHRvcFBvc2l0aW9ucyA9IHBvcy50b3BQb3NpdGlvbnM7CiAgICAgICAgY29uc3QgbnVtQ29ybmVycyA9IHBvcy5udW1Db3JuZXJzOwogICAgICAgIGxldCBsZW5ndGggPSB0b3BQb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGxldCBzaXplID0gbGVuZ3RoICogMjsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2ZXJ0ZXhGb3JtYXQucG9zaXRpb24gPyBuZXcgRmxvYXQ2NEFycmF5KHNpemUpIDogdm9pZCAwOwogICAgICAgIGNvbnN0IG5vcm1hbHMgPSB2ZXJ0ZXhGb3JtYXQubm9ybWFsID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCB0YW5nZW50cyA9IHZlcnRleEZvcm1hdC50YW5nZW50ID8gbmV3IEZsb2F0MzJBcnJheShzaXplKSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBiaXRhbmdlbnRzID0gdmVydGV4Rm9ybWF0LmJpdGFuZ2VudCA/IG5ldyBGbG9hdDMyQXJyYXkoc2l6ZSkgOiB2b2lkIDA7CiAgICAgICAgY29uc3QgdGV4dHVyZUNvb3JkaW5hdGVzID0gdmVydGV4Rm9ybWF0LnN0ID8gbmV3IEZsb2F0MzJBcnJheShzaXplIC8gMyAqIDIpIDogdm9pZCAwOwogICAgICAgIGxldCBwb3NpdGlvbkluZGV4ID0gMDsKICAgICAgICBsZXQgbm9ybWFsSW5kZXggPSAwOwogICAgICAgIGxldCBiaXRhbmdlbnRJbmRleCA9IDA7CiAgICAgICAgbGV0IHRhbmdlbnRJbmRleCA9IDA7CiAgICAgICAgbGV0IHN0SW5kZXggPSAwOwogICAgICAgIGxldCBub3JtYWwyID0gc2NyYXRjaE5vcm1hbDg7CiAgICAgICAgbGV0IHRhbmdlbnQgPSBzY3JhdGNoVGFuZ2VudDU7CiAgICAgICAgbGV0IGJpdGFuZ2VudCA9IHNjcmF0Y2hCaXRhbmdlbnQ1OwogICAgICAgIGxldCByZWNvbXB1dGVOb3JtYWwgPSB0cnVlOwogICAgICAgIGxlbmd0aCAvPSAzOwogICAgICAgIGxldCBpOwogICAgICAgIGxldCBzID0gMDsKICAgICAgICBjb25zdCBkcyA9IDEgLyAobGVuZ3RoIC0gbnVtQ29ybmVycyAtIDEpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY29uc3QgaTMgPSBpICogMzsKICAgICAgICAgIGNvbnN0IHRvcFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgdG9wUG9zaXRpb25zLAogICAgICAgICAgICBpMywKICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjEKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBib3R0b21Qb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucywKICAgICAgICAgICAgaTMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IGJvdHRvbVBvc2l0aW9uLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gYm90dG9tUG9zaXRpb24ueTsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSBib3R0b21Qb3NpdGlvbi56OwogICAgICAgICAgICBwb3NpdGlvbnNbcG9zaXRpb25JbmRleCsrXSA9IHRvcFBvc2l0aW9uLng7CiAgICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gdG9wUG9zaXRpb24ueTsKICAgICAgICAgICAgcG9zaXRpb25zW3Bvc2l0aW9uSW5kZXgrK10gPSB0b3BQb3NpdGlvbi56OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5zdCkgewogICAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IHM7CiAgICAgICAgICAgIHRleHR1cmVDb29yZGluYXRlc1tzdEluZGV4KytdID0gMDsKICAgICAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzW3N0SW5kZXgrK10gPSBzOwogICAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNbc3RJbmRleCsrXSA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmVydGV4Rm9ybWF0Lm5vcm1hbCB8fCB2ZXJ0ZXhGb3JtYXQudGFuZ2VudCB8fCB2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICAgIGxldCBuZXh0VG9wID0gQ2FydGVzaWFuM19kZWZhdWx0LmNsb25lKAogICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IGdyb3VuZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICAgIHRvcFBvc2l0aW9uLAogICAgICAgICAgICAgIGVsbGlwc29pZC5nZW9kZXRpY1N1cmZhY2VOb3JtYWwoCiAgICAgICAgICAgICAgICB0b3BQb3NpdGlvbiwKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yCiAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMgogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoaSArIDEgPCBsZW5ndGgpIHsKICAgICAgICAgICAgICBuZXh0VG9wID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgICAgIHRvcFBvc2l0aW9ucywKICAgICAgICAgICAgICAgIGkzICsgMywKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb241CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVjb21wdXRlTm9ybWFsKSB7CiAgICAgICAgICAgICAgY29uc3Qgc2NhbGVkbmV4dFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICAgICAgbmV4dFRvcCwKICAgICAgICAgICAgICAgIHRvcFBvc2l0aW9uLAogICAgICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGNvbnN0IHNjYWxlZEdyb3VuZFBvc2l0aW9uID0gQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KAogICAgICAgICAgICAgICAgZ3JvdW5kUG9zaXRpb24sCiAgICAgICAgICAgICAgICB0b3BQb3NpdGlvbiwKICAgICAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBub3JtYWwyID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhzY2FsZWRHcm91bmRQb3NpdGlvbiwgc2NhbGVkbmV4dFBvc2l0aW9uLCBub3JtYWwyKSwKICAgICAgICAgICAgICAgIG5vcm1hbDIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJlY29tcHV0ZU5vcm1hbCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbih0b3BQb3NpdGlvbiwgbmV4dFRvcCwgTWF0aF9kZWZhdWx0LkVQU0lMT04xMCkpIHsKICAgICAgICAgICAgICByZWNvbXB1dGVOb3JtYWwgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHMgKz0gZHM7CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgICB0YW5nZW50ID0gQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZSgKICAgICAgICAgICAgICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LnN1YnRyYWN0KG5leHRUb3AsIHRvcFBvc2l0aW9uLCB0YW5nZW50KSwKICAgICAgICAgICAgICAgICAgdGFuZ2VudAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICAgIGJpdGFuZ2VudCA9IENhcnRlc2lhbjNfZGVmYXVsdC5ub3JtYWxpemUoCiAgICAgICAgICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5jcm9zcyhub3JtYWwyLCB0YW5nZW50LCBiaXRhbmdlbnQpLAogICAgICAgICAgICAgICAgICBiaXRhbmdlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi55OwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgICAgICAgbm9ybWFsc1tub3JtYWxJbmRleCsrXSA9IG5vcm1hbDIueDsKICAgICAgICAgICAgICBub3JtYWxzW25vcm1hbEluZGV4KytdID0gbm9ybWFsMi55OwogICAgICAgICAgICAgIG5vcm1hbHNbbm9ybWFsSW5kZXgrK10gPSBub3JtYWwyLno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC50YW5nZW50KSB7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lno7CiAgICAgICAgICAgICAgdGFuZ2VudHNbdGFuZ2VudEluZGV4KytdID0gdGFuZ2VudC54OwogICAgICAgICAgICAgIHRhbmdlbnRzW3RhbmdlbnRJbmRleCsrXSA9IHRhbmdlbnQueTsKICAgICAgICAgICAgICB0YW5nZW50c1t0YW5nZW50SW5kZXgrK10gPSB0YW5nZW50Lno7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5iaXRhbmdlbnQpIHsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgICBiaXRhbmdlbnRzW2JpdGFuZ2VudEluZGV4KytdID0gYml0YW5nZW50Lng7CiAgICAgICAgICAgICAgYml0YW5nZW50c1tiaXRhbmdlbnRJbmRleCsrXSA9IGJpdGFuZ2VudC55OwogICAgICAgICAgICAgIGJpdGFuZ2VudHNbYml0YW5nZW50SW5kZXgrK10gPSBiaXRhbmdlbnQuejsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlc19kZWZhdWx0KCk7CiAgICAgICAgaWYgKHZlcnRleEZvcm1hdC5wb3NpdGlvbikgewogICAgICAgICAgYXR0cmlidXRlcy5wb3NpdGlvbiA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRE9VQkxFLAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAzLAogICAgICAgICAgICB2YWx1ZXM6IHBvc2l0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQubm9ybWFsKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLm5vcm1hbCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogbm9ybWFscwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQudGFuZ2VudCkgewogICAgICAgICAgYXR0cmlidXRlcy50YW5nZW50ID0gbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5GTE9BVCwKICAgICAgICAgICAgY29tcG9uZW50c1BlckF0dHJpYnV0ZTogMywKICAgICAgICAgICAgdmFsdWVzOiB0YW5nZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuYml0YW5nZW50KSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLmJpdGFuZ2VudCA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZV9kZWZhdWx0KHsKICAgICAgICAgICAgY29tcG9uZW50RGF0YXR5cGU6IENvbXBvbmVudERhdGF0eXBlX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogYml0YW5nZW50cwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJ0ZXhGb3JtYXQuc3QpIHsKICAgICAgICAgIGF0dHJpYnV0ZXMuc3QgPSBuZXcgR2VvbWV0cnlBdHRyaWJ1dGVfZGVmYXVsdCh7CiAgICAgICAgICAgIGNvbXBvbmVudERhdGF0eXBlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LkZMT0FULAogICAgICAgICAgICBjb21wb25lbnRzUGVyQXR0cmlidXRlOiAyLAogICAgICAgICAgICB2YWx1ZXM6IHRleHR1cmVDb29yZGluYXRlcwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG51bVZlcnRpY2VzID0gc2l6ZSAvIDM7CiAgICAgICAgc2l6ZSAtPSA2ICogKG51bUNvcm5lcnMgKyAxKTsKICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtVmVydGljZXMsIHNpemUpOwogICAgICAgIGxldCBlZGdlSW5kZXggPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlcyAtIDI7IGkgKz0gMikgewogICAgICAgICAgY29uc3QgTEwgPSBpOwogICAgICAgICAgY29uc3QgTFIgPSBpICsgMjsKICAgICAgICAgIGNvbnN0IHBsID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBMTCAqIDMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgcHIgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIExSICogMywKICAgICAgICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjIKICAgICAgICAgICk7CiAgICAgICAgICBpZiAoQ2FydGVzaWFuM19kZWZhdWx0LmVxdWFsc0Vwc2lsb24ocGwsIHByLCBNYXRoX2RlZmF1bHQuRVBTSUxPTjEwKSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IFVMID0gaSArIDE7CiAgICAgICAgICBjb25zdCBVUiA9IGkgKyAzOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBVTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTEw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IFVSOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBVUjsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTEw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IExSOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEdlb21ldHJ5X2RlZmF1bHQoewogICAgICAgICAgYXR0cmlidXRlcywKICAgICAgICAgIGluZGljZXMsCiAgICAgICAgICBwcmltaXRpdmVUeXBlOiBQcmltaXRpdmVUeXBlX2RlZmF1bHQuVFJJQU5HTEVTLAogICAgICAgICAgYm91bmRpbmdTcGhlcmU6IG5ldyBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcyhwb3NpdGlvbnMpCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFdhbGxHZW9tZXRyeV9kZWZhdWx0ID0gV2FsbEdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlV2FsbEdlb21ldHJ5LmpzCiAgdmFyIGNyZWF0ZVdhbGxHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlV2FsbEdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVdhbGxHZW9tZXRyeV9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gY3JlYXRlV2FsbEdlb21ldHJ5KHdhbGxHZW9tZXRyeSwgb2Zmc2V0KSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG9mZnNldCkpIHsKICAgICAgd2FsbEdlb21ldHJ5ID0gV2FsbEdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHdhbGxHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHdhbGxHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUod2FsbEdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmV0dXJuIFdhbGxHZW9tZXRyeV9kZWZhdWx0LmNyZWF0ZUdlb21ldHJ5KHdhbGxHZW9tZXRyeSk7CiAgfQogIHZhciBjcmVhdGVXYWxsR2VvbWV0cnlfZGVmYXVsdDsKICB2YXIgaW5pdF9jcmVhdGVXYWxsR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVdhbGxHZW9tZXRyeS5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0VsbGlwc29pZCgpOwogICAgICBpbml0X1dhbGxHZW9tZXRyeSgpOwogICAgICBjcmVhdGVXYWxsR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVdhbGxHZW9tZXRyeTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dhbGxPdXRsaW5lR2VvbWV0cnkuanMKICBmdW5jdGlvbiBXYWxsT3V0bGluZUdlb21ldHJ5KG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgY29uc3Qgd2FsbFBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgY29uc3QgbWF4aW11bUhlaWdodHMgPSBvcHRpb25zLm1heGltdW1IZWlnaHRzOwogICAgY29uc3QgbWluaW11bUhlaWdodHMgPSBvcHRpb25zLm1pbmltdW1IZWlnaHRzOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQod2FsbFBvc2l0aW9ucykpIHsKICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIm9wdGlvbnMucG9zaXRpb25zIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtYXhpbXVtSGVpZ2h0cykgJiYgbWF4aW11bUhlaWdodHMubGVuZ3RoICE9PSB3YWxsUG9zaXRpb25zLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgKICAgICAgICAib3B0aW9ucy5wb3NpdGlvbnMgYW5kIG9wdGlvbnMubWF4aW11bUhlaWdodHMgbXVzdCBoYXZlIHRoZSBzYW1lIGxlbmd0aC4iCiAgICAgICk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1pbmltdW1IZWlnaHRzKSAmJiBtaW5pbXVtSGVpZ2h0cy5sZW5ndGggIT09IHdhbGxQb3NpdGlvbnMubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KAogICAgICAgICJvcHRpb25zLnBvc2l0aW9ucyBhbmQgb3B0aW9ucy5taW5pbXVtSGVpZ2h0cyBtdXN0IGhhdmUgdGhlIHNhbWUgbGVuZ3RoLiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoCiAgICAgIG9wdGlvbnMuZ3JhbnVsYXJpdHksCiAgICAgIE1hdGhfZGVmYXVsdC5SQURJQU5TX1BFUl9ERUdSRUUKICAgICk7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLmVsbGlwc29pZCwgRWxsaXBzb2lkX2RlZmF1bHQuV0dTODQpOwogICAgdGhpcy5fcG9zaXRpb25zID0gd2FsbFBvc2l0aW9uczsKICAgIHRoaXMuX21pbmltdW1IZWlnaHRzID0gbWluaW11bUhlaWdodHM7CiAgICB0aGlzLl9tYXhpbXVtSGVpZ2h0cyA9IG1heGltdW1IZWlnaHRzOwogICAgdGhpcy5fZ3JhbnVsYXJpdHkgPSBncmFudWxhcml0eTsKICAgIHRoaXMuX2VsbGlwc29pZCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKGVsbGlwc29pZCk7CiAgICB0aGlzLl93b3JrZXJOYW1lID0gImNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkiOwogICAgbGV0IG51bUNvbXBvbmVudHMgPSAxICsgd2FsbFBvc2l0aW9ucy5sZW5ndGggKiBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFja2VkTGVuZ3RoICsgMjsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodHMpKSB7CiAgICAgIG51bUNvbXBvbmVudHMgKz0gbWluaW11bUhlaWdodHMubGVuZ3RoOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtYXhpbXVtSGVpZ2h0cykpIHsKICAgICAgbnVtQ29tcG9uZW50cyArPSBtYXhpbXVtSGVpZ2h0cy5sZW5ndGg7CiAgICB9CiAgICB0aGlzLnBhY2tlZExlbmd0aCA9IG51bUNvbXBvbmVudHMgKyBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrZWRMZW5ndGggKyAxOwogIH0KICB2YXIgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjEyLCBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMjIsIHNjcmF0Y2hFbGxpcHNvaWQxOCwgc2NyYXRjaE9wdGlvbnMyNCwgV2FsbE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X1dhbGxPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1dhbGxPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbXBvbmVudERhdGF0eXBlKCk7CiAgICAgIGluaXRfZGVmYXVsdFZhbHVlKCk7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X0RldmVsb3BlckVycm9yKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfR2VvbWV0cnkoKTsKICAgICAgaW5pdF9HZW9tZXRyeUF0dHJpYnV0ZSgpOwogICAgICBpbml0X0dlb21ldHJ5QXR0cmlidXRlcygpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfUHJpbWl0aXZlVHlwZSgpOwogICAgICBpbml0X1dhbGxHZW9tZXRyeUxpYnJhcnkoKTsKICAgICAgc2NyYXRjaENhcnRlc2lhbjNQb3NpdGlvbjEyID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMjIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFdhbGxPdXRsaW5lR2VvbWV0cnkucGFjayA9IGZ1bmN0aW9uKHZhbHVlLCBhcnJheSwgc3RhcnRpbmdJbmRleCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHZhbHVlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInZhbHVlIGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImFycmF5IGlzIHJlcXVpcmVkIik7CiAgICAgICAgfQogICAgICAgIHN0YXJ0aW5nSW5kZXggPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChzdGFydGluZ0luZGV4LCAwKTsKICAgICAgICBsZXQgaTsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB2YWx1ZS5fcG9zaXRpb25zOwogICAgICAgIGxldCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGFycmF5W3N0YXJ0aW5nSW5kZXgrK10gPSBsZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKHBvc2l0aW9uc1tpXSwgYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBtaW5pbXVtSGVpZ2h0cyA9IHZhbHVlLl9taW5pbXVtSGVpZ2h0czsKICAgICAgICBsZW5ndGggPSBkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodHMpID8gbWluaW11bUhlaWdodHMubGVuZ3RoIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWluaW11bUhlaWdodHMpKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IG1pbmltdW1IZWlnaHRzW2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBtYXhpbXVtSGVpZ2h0cyA9IHZhbHVlLl9tYXhpbXVtSGVpZ2h0czsKICAgICAgICBsZW5ndGggPSBkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpID8gbWF4aW11bUhlaWdodHMubGVuZ3RoIDogMDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4KytdID0gbGVuZ3RoOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWF4aW11bUhlaWdodHMpKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgYXJyYXlbc3RhcnRpbmdJbmRleCsrXSA9IG1heGltdW1IZWlnaHRzW2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBFbGxpcHNvaWRfZGVmYXVsdC5wYWNrKHZhbHVlLl9lbGxpcHNvaWQsIGFycmF5LCBzdGFydGluZ0luZGV4KTsKICAgICAgICBzdGFydGluZ0luZGV4ICs9IEVsbGlwc29pZF9kZWZhdWx0LnBhY2tlZExlbmd0aDsKICAgICAgICBhcnJheVtzdGFydGluZ0luZGV4XSA9IHZhbHVlLl9ncmFudWxhcml0eTsKICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH07CiAgICAgIHNjcmF0Y2hFbGxpcHNvaWQxOCA9IEVsbGlwc29pZF9kZWZhdWx0LmNsb25lKEVsbGlwc29pZF9kZWZhdWx0LlVOSVRfU1BIRVJFKTsKICAgICAgc2NyYXRjaE9wdGlvbnMyNCA9IHsKICAgICAgICBwb3NpdGlvbnM6IHZvaWQgMCwKICAgICAgICBtaW5pbXVtSGVpZ2h0czogdm9pZCAwLAogICAgICAgIG1heGltdW1IZWlnaHRzOiB2b2lkIDAsCiAgICAgICAgZWxsaXBzb2lkOiBzY3JhdGNoRWxsaXBzb2lkMTgsCiAgICAgICAgZ3JhbnVsYXJpdHk6IHZvaWQgMAogICAgICB9OwogICAgICBXYWxsT3V0bGluZUdlb21ldHJ5LnVucGFjayA9IGZ1bmN0aW9uKGFycmF5LCBzdGFydGluZ0luZGV4LCByZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChhcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJhcnJheSBpcyByZXF1aXJlZCIpOwogICAgICAgIH0KICAgICAgICBzdGFydGluZ0luZGV4ID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoc3RhcnRpbmdJbmRleCwgMCk7CiAgICAgICAgbGV0IGk7CiAgICAgICAgbGV0IGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpLCBzdGFydGluZ0luZGV4ICs9IENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrZWRMZW5ndGgpIHsKICAgICAgICAgIHBvc2l0aW9uc1tpXSA9IENhcnRlc2lhbjNfZGVmYXVsdC51bnBhY2soYXJyYXksIHN0YXJ0aW5nSW5kZXgpOwogICAgICAgIH0KICAgICAgICBsZW5ndGggPSBhcnJheVtzdGFydGluZ0luZGV4KytdOwogICAgICAgIGxldCBtaW5pbXVtSGVpZ2h0czsKICAgICAgICBpZiAobGVuZ3RoID4gMCkgewogICAgICAgICAgbWluaW11bUhlaWdodHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICBtaW5pbXVtSGVpZ2h0c1tpXSA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxlbmd0aCA9IGFycmF5W3N0YXJ0aW5nSW5kZXgrK107CiAgICAgICAgbGV0IG1heGltdW1IZWlnaHRzOwogICAgICAgIGlmIChsZW5ndGggPiAwKSB7CiAgICAgICAgICBtYXhpbXVtSGVpZ2h0cyA9IG5ldyBBcnJheShsZW5ndGgpOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIG1heGltdW1IZWlnaHRzW2ldID0gYXJyYXlbc3RhcnRpbmdJbmRleCsrXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQudW5wYWNrKGFycmF5LCBzdGFydGluZ0luZGV4LCBzY3JhdGNoRWxsaXBzb2lkMTgpOwogICAgICAgIHN0YXJ0aW5nSW5kZXggKz0gRWxsaXBzb2lkX2RlZmF1bHQucGFja2VkTGVuZ3RoOwogICAgICAgIGNvbnN0IGdyYW51bGFyaXR5ID0gYXJyYXlbc3RhcnRpbmdJbmRleF07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgc2NyYXRjaE9wdGlvbnMyNC5wb3NpdGlvbnMgPSBwb3NpdGlvbnM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczI0Lm1pbmltdW1IZWlnaHRzID0gbWluaW11bUhlaWdodHM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczI0Lm1heGltdW1IZWlnaHRzID0gbWF4aW11bUhlaWdodHM7CiAgICAgICAgICBzY3JhdGNoT3B0aW9uczI0LmdyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgICByZXR1cm4gbmV3IFdhbGxPdXRsaW5lR2VvbWV0cnkoc2NyYXRjaE9wdGlvbnMyNCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5fcG9zaXRpb25zID0gcG9zaXRpb25zOwogICAgICAgIHJlc3VsdC5fbWluaW11bUhlaWdodHMgPSBtaW5pbXVtSGVpZ2h0czsKICAgICAgICByZXN1bHQuX21heGltdW1IZWlnaHRzID0gbWF4aW11bUhlaWdodHM7CiAgICAgICAgcmVzdWx0Ll9lbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShlbGxpcHNvaWQsIHJlc3VsdC5fZWxsaXBzb2lkKTsKICAgICAgICByZXN1bHQuX2dyYW51bGFyaXR5ID0gZ3JhbnVsYXJpdHk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgV2FsbE91dGxpbmVHZW9tZXRyeS5mcm9tQ29uc3RhbnRIZWlnaHRzID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBkZWZhdWx0VmFsdWVfZGVmYXVsdChvcHRpb25zLCBkZWZhdWx0VmFsdWVfZGVmYXVsdC5FTVBUWV9PQkpFQ1QpOwogICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IG9wdGlvbnMucG9zaXRpb25zOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJvcHRpb25zLnBvc2l0aW9ucyBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IG1pbkhlaWdodHM7CiAgICAgICAgbGV0IG1heEhlaWdodHM7CiAgICAgICAgY29uc3QgbWluMyA9IG9wdGlvbnMubWluaW11bUhlaWdodDsKICAgICAgICBjb25zdCBtYXgzID0gb3B0aW9ucy5tYXhpbXVtSGVpZ2h0OwogICAgICAgIGNvbnN0IGRvTWluID0gZGVmaW5lZF9kZWZhdWx0KG1pbjMpOwogICAgICAgIGNvbnN0IGRvTWF4ID0gZGVmaW5lZF9kZWZhdWx0KG1heDMpOwogICAgICAgIGlmIChkb01pbiB8fCBkb01heCkgewogICAgICAgICAgY29uc3QgbGVuZ3RoID0gcG9zaXRpb25zLmxlbmd0aDsKICAgICAgICAgIG1pbkhlaWdodHMgPSBkb01pbiA/IG5ldyBBcnJheShsZW5ndGgpIDogdm9pZCAwOwogICAgICAgICAgbWF4SGVpZ2h0cyA9IGRvTWF4ID8gbmV3IEFycmF5KGxlbmd0aCkgOiB2b2lkIDA7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGlmIChkb01pbikgewogICAgICAgICAgICAgIG1pbkhlaWdodHNbaV0gPSBtaW4zOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkb01heCkgewogICAgICAgICAgICAgIG1heEhlaWdodHNbaV0gPSBtYXgzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICBtYXhpbXVtSGVpZ2h0czogbWF4SGVpZ2h0cywKICAgICAgICAgIG1pbmltdW1IZWlnaHRzOiBtaW5IZWlnaHRzLAogICAgICAgICAgZWxsaXBzb2lkOiBvcHRpb25zLmVsbGlwc29pZAogICAgICAgIH07CiAgICAgICAgcmV0dXJuIG5ldyBXYWxsT3V0bGluZUdlb21ldHJ5KG5ld09wdGlvbnMpOwogICAgICB9OwogICAgICBXYWxsT3V0bGluZUdlb21ldHJ5LmNyZWF0ZUdlb21ldHJ5ID0gZnVuY3Rpb24od2FsbEdlb21ldHJ5KSB7CiAgICAgICAgY29uc3Qgd2FsbFBvc2l0aW9ucyA9IHdhbGxHZW9tZXRyeS5fcG9zaXRpb25zOwogICAgICAgIGNvbnN0IG1pbmltdW1IZWlnaHRzID0gd2FsbEdlb21ldHJ5Ll9taW5pbXVtSGVpZ2h0czsKICAgICAgICBjb25zdCBtYXhpbXVtSGVpZ2h0cyA9IHdhbGxHZW9tZXRyeS5fbWF4aW11bUhlaWdodHM7CiAgICAgICAgY29uc3QgZ3JhbnVsYXJpdHkgPSB3YWxsR2VvbWV0cnkuX2dyYW51bGFyaXR5OwogICAgICAgIGNvbnN0IGVsbGlwc29pZCA9IHdhbGxHZW9tZXRyeS5fZWxsaXBzb2lkOwogICAgICAgIGNvbnN0IHBvcyA9IFdhbGxHZW9tZXRyeUxpYnJhcnlfZGVmYXVsdC5jb21wdXRlUG9zaXRpb25zKAogICAgICAgICAgZWxsaXBzb2lkLAogICAgICAgICAgd2FsbFBvc2l0aW9ucywKICAgICAgICAgIG1heGltdW1IZWlnaHRzLAogICAgICAgICAgbWluaW11bUhlaWdodHMsCiAgICAgICAgICBncmFudWxhcml0eSwKICAgICAgICAgIGZhbHNlCiAgICAgICAgKTsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChwb3MpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJvdHRvbVBvc2l0aW9ucyA9IHBvcy5ib3R0b21Qb3NpdGlvbnM7CiAgICAgICAgY29uc3QgdG9wUG9zaXRpb25zID0gcG9zLnRvcFBvc2l0aW9uczsKICAgICAgICBsZXQgbGVuZ3RoID0gdG9wUG9zaXRpb25zLmxlbmd0aDsKICAgICAgICBsZXQgc2l6ZSA9IGxlbmd0aCAqIDI7CiAgICAgICAgY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0NjRBcnJheShzaXplKTsKICAgICAgICBsZXQgcG9zaXRpb25JbmRleCA9IDA7CiAgICAgICAgbGVuZ3RoIC89IDM7CiAgICAgICAgbGV0IGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjb25zdCBpMyA9IGkgKiAzOwogICAgICAgICAgY29uc3QgdG9wUG9zaXRpb24gPSBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KAogICAgICAgICAgICB0b3BQb3NpdGlvbnMsCiAgICAgICAgICAgIGkzLAogICAgICAgICAgICBzY3JhdGNoQ2FydGVzaWFuM1Bvc2l0aW9uMTIKICAgICAgICAgICk7CiAgICAgICAgICBjb25zdCBib3R0b21Qb3NpdGlvbiA9IENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkoCiAgICAgICAgICAgIGJvdHRvbVBvc2l0aW9ucywKICAgICAgICAgICAgaTMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yMgogICAgICAgICAgKTsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gYm90dG9tUG9zaXRpb24ueDsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gYm90dG9tUG9zaXRpb24ueTsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gYm90dG9tUG9zaXRpb24uejsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gdG9wUG9zaXRpb24ueDsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gdG9wUG9zaXRpb24ueTsKICAgICAgICAgIHBvc2l0aW9uc1twb3NpdGlvbkluZGV4KytdID0gdG9wUG9zaXRpb24uejsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5ldyBHZW9tZXRyeUF0dHJpYnV0ZXNfZGVmYXVsdCh7CiAgICAgICAgICBwb3NpdGlvbjogbmV3IEdlb21ldHJ5QXR0cmlidXRlX2RlZmF1bHQoewogICAgICAgICAgICBjb21wb25lbnREYXRhdHlwZTogQ29tcG9uZW50RGF0YXR5cGVfZGVmYXVsdC5ET1VCTEUsCiAgICAgICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IDMsCiAgICAgICAgICAgIHZhbHVlczogcG9zaXRpb25zCiAgICAgICAgICB9KQogICAgICAgIH0pOwogICAgICAgIGNvbnN0IG51bVZlcnRpY2VzID0gc2l6ZSAvIDM7CiAgICAgICAgc2l6ZSA9IDIgKiBudW1WZXJ0aWNlcyAtIDQgKyBudW1WZXJ0aWNlczsKICAgICAgICBjb25zdCBpbmRpY2VzID0gSW5kZXhEYXRhdHlwZV9kZWZhdWx0LmNyZWF0ZVR5cGVkQXJyYXkobnVtVmVydGljZXMsIHNpemUpOwogICAgICAgIGxldCBlZGdlSW5kZXggPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBudW1WZXJ0aWNlcyAtIDI7IGkgKz0gMikgewogICAgICAgICAgY29uc3QgTEwgPSBpOwogICAgICAgICAgY29uc3QgTFIgPSBpICsgMjsKICAgICAgICAgIGNvbnN0IHBsID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBMTCAqIDMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24xMgogICAgICAgICAgKTsKICAgICAgICAgIGNvbnN0IHByID0gQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheSgKICAgICAgICAgICAgcG9zaXRpb25zLAogICAgICAgICAgICBMUiAqIDMsCiAgICAgICAgICAgIHNjcmF0Y2hDYXJ0ZXNpYW4zUG9zaXRpb24yMgogICAgICAgICAgKTsKICAgICAgICAgIGlmIChDYXJ0ZXNpYW4zX2RlZmF1bHQuZXF1YWxzRXBzaWxvbihwbCwgcHIsIE1hdGhfZGVmYXVsdC5FUFNJTE9OMTApKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgVUwgPSBpICsgMTsKICAgICAgICAgIGNvbnN0IFVSID0gaSArIDM7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IFVMOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBMTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gVUw7CiAgICAgICAgICBpbmRpY2VzW2VkZ2VJbmRleCsrXSA9IFVSOwogICAgICAgICAgaW5kaWNlc1tlZGdlSW5kZXgrK10gPSBMTDsKICAgICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gTFI7CiAgICAgICAgfQogICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gbnVtVmVydGljZXMgLSAyOwogICAgICAgIGluZGljZXNbZWRnZUluZGV4KytdID0gbnVtVmVydGljZXMgLSAxOwogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnlfZGVmYXVsdCh7CiAgICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgICAgaW5kaWNlcywKICAgICAgICAgIHByaW1pdGl2ZVR5cGU6IFByaW1pdGl2ZVR5cGVfZGVmYXVsdC5MSU5FUywKICAgICAgICAgIGJvdW5kaW5nU3BoZXJlOiBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdC5mcm9tVmVydGljZXMocG9zaXRpb25zKQogICAgICAgIH0pOwogICAgICB9OwogICAgICBXYWxsT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQgPSBXYWxsT3V0bGluZUdlb21ldHJ5OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChjcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMsIHsKICAgIGRlZmF1bHQ6ICgpID0+IGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGZ1bmN0aW9uIGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkod2FsbEdlb21ldHJ5LCBvZmZzZXQpIHsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob2Zmc2V0KSkgewogICAgICB3YWxsR2VvbWV0cnkgPSBXYWxsT3V0bGluZUdlb21ldHJ5X2RlZmF1bHQudW5wYWNrKHdhbGxHZW9tZXRyeSwgb2Zmc2V0KTsKICAgIH0KICAgIHdhbGxHZW9tZXRyeS5fZWxsaXBzb2lkID0gRWxsaXBzb2lkX2RlZmF1bHQuY2xvbmUod2FsbEdlb21ldHJ5Ll9lbGxpcHNvaWQpOwogICAgcmV0dXJuIFdhbGxPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdC5jcmVhdGVHZW9tZXRyeSh3YWxsR2VvbWV0cnkpOwogIH0KICB2YXIgY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeV9kZWZhdWx0OwogIHZhciBpbml0X2NyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkuanMiKCkgewogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9FbGxpcHNvaWQoKTsKICAgICAgaW5pdF9XYWxsT3V0bGluZUdlb21ldHJ5KCk7CiAgICAgIGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnk7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9kcmFjbzNkL2RyYWNvX2RlY29kZXJfbm9kZWpzLmpzCiAgdmFyIHJlcXVpcmVfZHJhY29fZGVjb2Rlcl9ub2RlanMgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvZHJhY28zZC9kcmFjb19kZWNvZGVyX25vZGVqcy5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICB2YXIgJGpzY29tcCA9ICRqc2NvbXAgfHwge307CiAgICAgICRqc2NvbXAuc2NvcGUgPSB7fTsKICAgICAgJGpzY29tcC5hcnJheUl0ZXJhdG9ySW1wbCA9IGZ1bmN0aW9uKGspIHsKICAgICAgICB2YXIgbiA9IDA7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIG4gPCBrLmxlbmd0aCA/IHsgZG9uZTogZmFsc2UsIHZhbHVlOiBrW24rK10gfSA6IHsgZG9uZTogdHJ1ZSB9OwogICAgICAgIH07CiAgICAgIH07CiAgICAgICRqc2NvbXAuYXJyYXlJdGVyYXRvciA9IGZ1bmN0aW9uKGspIHsKICAgICAgICByZXR1cm4geyBuZXh0OiAkanNjb21wLmFycmF5SXRlcmF0b3JJbXBsKGspIH07CiAgICAgIH07CiAgICAgICRqc2NvbXAubWFrZUl0ZXJhdG9yID0gZnVuY3Rpb24oaykgewogICAgICAgIHZhciBuID0gInVuZGVmaW5lZCIgIT0gdHlwZW9mIFN5bWJvbCAmJiBTeW1ib2wuaXRlcmF0b3IgJiYga1tTeW1ib2wuaXRlcmF0b3JdOwogICAgICAgIHJldHVybiBuID8gbi5jYWxsKGspIDogJGpzY29tcC5hcnJheUl0ZXJhdG9yKGspOwogICAgICB9OwogICAgICAkanNjb21wLkFTU1VNRV9FUzUgPSBmYWxzZTsKICAgICAgJGpzY29tcC5BU1NVTUVfTk9fTkFUSVZFX01BUCA9IGZhbHNlOwogICAgICAkanNjb21wLkFTU1VNRV9OT19OQVRJVkVfU0VUID0gZmFsc2U7CiAgICAgICRqc2NvbXAuU0lNUExFX0ZST1VORF9QT0xZRklMTCA9IGZhbHNlOwogICAgICAkanNjb21wLklTT0xBVEVfUE9MWUZJTExTID0gZmFsc2U7CiAgICAgICRqc2NvbXAuRk9SQ0VfUE9MWUZJTExfUFJPTUlTRSA9IGZhbHNlOwogICAgICAkanNjb21wLkZPUkNFX1BPTFlGSUxMX1BST01JU0VfV0hFTl9OT19VTkhBTkRMRURfUkVKRUNUSU9OID0gZmFsc2U7CiAgICAgICRqc2NvbXAuZ2V0R2xvYmFsID0gZnVuY3Rpb24oaykgewogICAgICAgIGsgPSBbIm9iamVjdCIgPT0gdHlwZW9mIGdsb2JhbFRoaXMgJiYgZ2xvYmFsVGhpcywgaywgIm9iamVjdCIgPT0gdHlwZW9mIHdpbmRvdyAmJiB3aW5kb3csICJvYmplY3QiID09IHR5cGVvZiBzZWxmICYmIHNlbGYsICJvYmplY3QiID09IHR5cGVvZiBnbG9iYWwgJiYgZ2xvYmFsXTsKICAgICAgICBmb3IgKHZhciBuID0gMDsgbiA8IGsubGVuZ3RoOyArK24pIHsKICAgICAgICAgIHZhciBsID0ga1tuXTsKICAgICAgICAgIGlmIChsICYmIGwuTWF0aCA9PSBNYXRoKSByZXR1cm4gbDsKICAgICAgICB9CiAgICAgICAgdGhyb3cgRXJyb3IoIkNhbm5vdCBmaW5kIGdsb2JhbCBvYmplY3QiKTsKICAgICAgfTsKICAgICAgJGpzY29tcC5nbG9iYWwgPSAkanNjb21wLmdldEdsb2JhbChleHBvcnRzMik7CiAgICAgICRqc2NvbXAuZGVmaW5lUHJvcGVydHkgPSAkanNjb21wLkFTU1VNRV9FUzUgfHwgImZ1bmN0aW9uIiA9PSB0eXBlb2YgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkgOiBmdW5jdGlvbihrLCBuLCBsKSB7CiAgICAgICAgaWYgKGsgPT0gQXJyYXkucHJvdG90eXBlIHx8IGsgPT0gT2JqZWN0LnByb3RvdHlwZSkgcmV0dXJuIGs7CiAgICAgICAga1tuXSA9IGwudmFsdWU7CiAgICAgICAgcmV0dXJuIGs7CiAgICAgIH07CiAgICAgICRqc2NvbXAuSVNfU1lNQk9MX05BVElWRSA9ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBTeW1ib2wgJiYgInN5bWJvbCIgPT09IHR5cGVvZiBTeW1ib2woIngiKTsKICAgICAgJGpzY29tcC5UUlVTVF9FUzZfUE9MWUZJTExTID0gISRqc2NvbXAuSVNPTEFURV9QT0xZRklMTFMgfHwgJGpzY29tcC5JU19TWU1CT0xfTkFUSVZFOwogICAgICAkanNjb21wLnBvbHlmaWxscyA9IHt9OwogICAgICAkanNjb21wLnByb3BlcnR5VG9Qb2x5ZmlsbFN5bWJvbCA9IHt9OwogICAgICAkanNjb21wLlBPTFlGSUxMX1BSRUZJWCA9ICIkanNjcCQiOwogICAgICAkanNjb21wLnBvbHlmaWxsID0gZnVuY3Rpb24oaywgbiwgbCwgcCkgewogICAgICAgIG4gJiYgKCRqc2NvbXAuSVNPTEFURV9QT0xZRklMTFMgPyAkanNjb21wLnBvbHlmaWxsSXNvbGF0ZWQoaywgbiwgbCwgcCkgOiAkanNjb21wLnBvbHlmaWxsVW5pc29sYXRlZChrLCBuLCBsLCBwKSk7CiAgICAgIH07CiAgICAgICRqc2NvbXAucG9seWZpbGxVbmlzb2xhdGVkID0gZnVuY3Rpb24oaywgbiwgbCwgcCkgewogICAgICAgIGwgPSAkanNjb21wLmdsb2JhbDsKICAgICAgICBrID0gay5zcGxpdCgiLiIpOwogICAgICAgIGZvciAocCA9IDA7IHAgPCBrLmxlbmd0aCAtIDE7IHArKykgewogICAgICAgICAgdmFyIGggPSBrW3BdOwogICAgICAgICAgaWYgKCEoaCBpbiBsKSkgcmV0dXJuOwogICAgICAgICAgbCA9IGxbaF07CiAgICAgICAgfQogICAgICAgIGsgPSBrW2subGVuZ3RoIC0gMV07CiAgICAgICAgcCA9IGxba107CiAgICAgICAgbiA9IG4ocCk7CiAgICAgICAgbiAhPSBwICYmIG51bGwgIT0gbiAmJiAkanNjb21wLmRlZmluZVByb3BlcnR5KGwsIGssIHsgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSwgdmFsdWU6IG4gfSk7CiAgICAgIH07CiAgICAgICRqc2NvbXAucG9seWZpbGxJc29sYXRlZCA9IGZ1bmN0aW9uKGssIG4sIGwsIHApIHsKICAgICAgICB2YXIgaCA9IGsuc3BsaXQoIi4iKTsKICAgICAgICBrID0gMSA9PT0gaC5sZW5ndGg7CiAgICAgICAgcCA9IGhbMF07CiAgICAgICAgcCA9ICFrICYmIHAgaW4gJGpzY29tcC5wb2x5ZmlsbHMgPyAkanNjb21wLnBvbHlmaWxscyA6ICRqc2NvbXAuZ2xvYmFsOwogICAgICAgIGZvciAodmFyIEEgPSAwOyBBIDwgaC5sZW5ndGggLSAxOyBBKyspIHsKICAgICAgICAgIHZhciBmID0gaFtBXTsKICAgICAgICAgIGlmICghKGYgaW4gcCkpIHJldHVybjsKICAgICAgICAgIHAgPSBwW2ZdOwogICAgICAgIH0KICAgICAgICBoID0gaFtoLmxlbmd0aCAtIDFdOwogICAgICAgIGwgPSAkanNjb21wLklTX1NZTUJPTF9OQVRJVkUgJiYgImVzNiIgPT09IGwgPyBwW2hdIDogbnVsbDsKICAgICAgICBuID0gbihsKTsKICAgICAgICBudWxsICE9IG4gJiYgKGsgPyAkanNjb21wLmRlZmluZVByb3BlcnR5KCRqc2NvbXAucG9seWZpbGxzLCBoLCB7IGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUsIHZhbHVlOiBuIH0pIDogbiAhPT0gbCAmJiAodm9pZCAwID09PSAkanNjb21wLnByb3BlcnR5VG9Qb2x5ZmlsbFN5bWJvbFtoXSAmJiAobCA9IDFlOSAqIE1hdGgucmFuZG9tKCkgPj4+IDAsICRqc2NvbXAucHJvcGVydHlUb1BvbHlmaWxsU3ltYm9sW2hdID0gJGpzY29tcC5JU19TWU1CT0xfTkFUSVZFID8gJGpzY29tcC5nbG9iYWwuU3ltYm9sKGgpIDogJGpzY29tcC5QT0xZRklMTF9QUkVGSVggKyBsICsgIiQiICsgaCksICRqc2NvbXAuZGVmaW5lUHJvcGVydHkocCwgJGpzY29tcC5wcm9wZXJ0eVRvUG9seWZpbGxTeW1ib2xbaF0sIHsgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSwgdmFsdWU6IG4gfSkpKTsKICAgICAgfTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiUHJvbWlzZSIsIGZ1bmN0aW9uKGspIHsKICAgICAgICBmdW5jdGlvbiBuKCkgewogICAgICAgICAgdGhpcy5iYXRjaF8gPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsKGYpIHsKICAgICAgICAgIHJldHVybiBmIGluc3RhbmNlb2YgaCA/IGYgOiBuZXcgaChmdW5jdGlvbihxLCB2MykgewogICAgICAgICAgICBxKGYpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmIChrICYmICghKCRqc2NvbXAuRk9SQ0VfUE9MWUZJTExfUFJPTUlTRSB8fCAkanNjb21wLkZPUkNFX1BPTFlGSUxMX1BST01JU0VfV0hFTl9OT19VTkhBTkRMRURfUkVKRUNUSU9OICYmICJ1bmRlZmluZWQiID09PSB0eXBlb2YgJGpzY29tcC5nbG9iYWwuUHJvbWlzZVJlamVjdGlvbkV2ZW50KSB8fCAhJGpzY29tcC5nbG9iYWwuUHJvbWlzZSB8fCAtMSA9PT0gJGpzY29tcC5nbG9iYWwuUHJvbWlzZS50b1N0cmluZygpLmluZGV4T2YoIltuYXRpdmUgY29kZV0iKSkpIHJldHVybiBrOwogICAgICAgIG4ucHJvdG90eXBlLmFzeW5jRXhlY3V0ZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgICAgIGlmIChudWxsID09IHRoaXMuYmF0Y2hfKSB7CiAgICAgICAgICAgIHRoaXMuYmF0Y2hfID0gW107CiAgICAgICAgICAgIHZhciBxID0gdGhpczsKICAgICAgICAgICAgdGhpcy5hc3luY0V4ZWN1dGVGdW5jdGlvbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBxLmV4ZWN1dGVCYXRjaF8oKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJhdGNoXy5wdXNoKGYpOwogICAgICAgIH07CiAgICAgICAgdmFyIHAgPSAkanNjb21wLmdsb2JhbC5zZXRUaW1lb3V0OwogICAgICAgIG4ucHJvdG90eXBlLmFzeW5jRXhlY3V0ZUZ1bmN0aW9uID0gZnVuY3Rpb24oZikgewogICAgICAgICAgcChmLCAwKTsKICAgICAgICB9OwogICAgICAgIG4ucHJvdG90eXBlLmV4ZWN1dGVCYXRjaF8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGZvciAoOyB0aGlzLmJhdGNoXyAmJiB0aGlzLmJhdGNoXy5sZW5ndGg7ICkgewogICAgICAgICAgICB2YXIgZiA9IHRoaXMuYmF0Y2hfOwogICAgICAgICAgICB0aGlzLmJhdGNoXyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBxID0gMDsgcSA8IGYubGVuZ3RoOyArK3EpIHsKICAgICAgICAgICAgICB2YXIgdjMgPSBmW3FdOwogICAgICAgICAgICAgIGZbcV0gPSBudWxsOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB2MygpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHopIHsKICAgICAgICAgICAgICAgIHRoaXMuYXN5bmNUaHJvd18oeik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJhdGNoXyA9IG51bGw7CiAgICAgICAgfTsKICAgICAgICBuLnByb3RvdHlwZS5hc3luY1Rocm93XyA9IGZ1bmN0aW9uKGYpIHsKICAgICAgICAgIHRoaXMuYXN5bmNFeGVjdXRlRnVuY3Rpb24oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRocm93IGY7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIHZhciBoID0gZnVuY3Rpb24oZikgewogICAgICAgICAgdGhpcy5zdGF0ZV8gPSAwOwogICAgICAgICAgdGhpcy5yZXN1bHRfID0gdm9pZCAwOwogICAgICAgICAgdGhpcy5vblNldHRsZWRDYWxsYmFja3NfID0gW107CiAgICAgICAgICB0aGlzLmlzUmVqZWN0aW9uSGFuZGxlZF8gPSBmYWxzZTsKICAgICAgICAgIHZhciBxID0gdGhpcy5jcmVhdGVSZXNvbHZlQW5kUmVqZWN0XygpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZihxLnJlc29sdmUsIHEucmVqZWN0KTsKICAgICAgICAgIH0gY2F0Y2ggKHYzKSB7CiAgICAgICAgICAgIHEucmVqZWN0KHYzKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLmNyZWF0ZVJlc29sdmVBbmRSZWplY3RfID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBmdW5jdGlvbiBmKHopIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKE8pIHsKICAgICAgICAgICAgICB2MyB8fCAodjMgPSB0cnVlLCB6LmNhbGwocSwgTykpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgdmFyIHEgPSB0aGlzLCB2MyA9IGZhbHNlOwogICAgICAgICAgcmV0dXJuIHsgcmVzb2x2ZTogZih0aGlzLnJlc29sdmVUb18pLCByZWplY3Q6IGYodGhpcy5yZWplY3RfKSB9OwogICAgICAgIH07CiAgICAgICAgaC5wcm90b3R5cGUucmVzb2x2ZVRvXyA9IGZ1bmN0aW9uKGYpIHsKICAgICAgICAgIGlmIChmID09PSB0aGlzKSB0aGlzLnJlamVjdF8obmV3IFR5cGVFcnJvcigiQSBQcm9taXNlIGNhbm5vdCByZXNvbHZlIHRvIGl0c2VsZiIpKTsKICAgICAgICAgIGVsc2UgaWYgKGYgaW5zdGFuY2VvZiBoKSB0aGlzLnNldHRsZVNhbWVBc1Byb21pc2VfKGYpOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGE6IHN3aXRjaCAodHlwZW9mIGYpIHsKICAgICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgICAgdmFyIHEgPSBudWxsICE9IGY7CiAgICAgICAgICAgICAgICBicmVhayBhOwogICAgICAgICAgICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgICAgICAgICAgIHEgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWsgYTsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHEgPyB0aGlzLnJlc29sdmVUb05vblByb21pc2VPYmpfKGYpIDogdGhpcy5mdWxmaWxsXyhmKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLnJlc29sdmVUb05vblByb21pc2VPYmpfID0gZnVuY3Rpb24oZikgewogICAgICAgICAgdmFyIHEgPSB2b2lkIDA7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBxID0gZi50aGVuOwogICAgICAgICAgfSBjYXRjaCAodjMpIHsKICAgICAgICAgICAgdGhpcy5yZWplY3RfKHYzKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgImZ1bmN0aW9uIiA9PSB0eXBlb2YgcSA/IHRoaXMuc2V0dGxlU2FtZUFzVGhlbmFibGVfKHEsIGYpIDogdGhpcy5mdWxmaWxsXyhmKTsKICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLnJlamVjdF8gPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICB0aGlzLnNldHRsZV8oMiwgZik7CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5mdWxmaWxsXyA9IGZ1bmN0aW9uKGYpIHsKICAgICAgICAgIHRoaXMuc2V0dGxlXygxLCBmKTsKICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLnNldHRsZV8gPSBmdW5jdGlvbihmLCBxKSB7CiAgICAgICAgICBpZiAoMCAhPSB0aGlzLnN0YXRlXykgdGhyb3cgRXJyb3IoIkNhbm5vdCBzZXR0bGUoIiArIGYgKyAiLCAiICsgcSArICIpOiBQcm9taXNlIGFscmVhZHkgc2V0dGxlZCBpbiBzdGF0ZSIgKyB0aGlzLnN0YXRlXyk7CiAgICAgICAgICB0aGlzLnN0YXRlXyA9IGY7CiAgICAgICAgICB0aGlzLnJlc3VsdF8gPSBxOwogICAgICAgICAgMiA9PT0gdGhpcy5zdGF0ZV8gJiYgdGhpcy5zY2hlZHVsZVVuaGFuZGxlZFJlamVjdGlvbkNoZWNrXygpOwogICAgICAgICAgdGhpcy5leGVjdXRlT25TZXR0bGVkQ2FsbGJhY2tzXygpOwogICAgICAgIH07CiAgICAgICAgaC5wcm90b3R5cGUuc2NoZWR1bGVVbmhhbmRsZWRSZWplY3Rpb25DaGVja18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBmID0gdGhpczsKICAgICAgICAgIHAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChmLm5vdGlmeVVuaGFuZGxlZFJlamVjdGlvbl8oKSkgewogICAgICAgICAgICAgIHZhciBxID0gJGpzY29tcC5nbG9iYWwuY29uc29sZTsKICAgICAgICAgICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIHEgJiYgcS5lcnJvcihmLnJlc3VsdF8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCAxKTsKICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLm5vdGlmeVVuaGFuZGxlZFJlamVjdGlvbl8gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICh0aGlzLmlzUmVqZWN0aW9uSGFuZGxlZF8pIHJldHVybiBmYWxzZTsKICAgICAgICAgIHZhciBmID0gJGpzY29tcC5nbG9iYWwuQ3VzdG9tRXZlbnQsIHEgPSAkanNjb21wLmdsb2JhbC5FdmVudCwgdjMgPSAkanNjb21wLmdsb2JhbC5kaXNwYXRjaEV2ZW50OwogICAgICAgICAgaWYgKCJ1bmRlZmluZWQiID09PSB0eXBlb2YgdjMpIHJldHVybiB0cnVlOwogICAgICAgICAgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIGYgPyBmID0gbmV3IGYoInVuaGFuZGxlZHJlamVjdGlvbiIsIHsgY2FuY2VsYWJsZTogdHJ1ZSB9KSA6ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBxID8gZiA9IG5ldyBxKCJ1bmhhbmRsZWRyZWplY3Rpb24iLCB7IGNhbmNlbGFibGU6IHRydWUgfSkgOiAoZiA9ICRqc2NvbXAuZ2xvYmFsLmRvY3VtZW50LmNyZWF0ZUV2ZW50KCJDdXN0b21FdmVudCIpLCBmLmluaXRDdXN0b21FdmVudCgidW5oYW5kbGVkcmVqZWN0aW9uIiwgZmFsc2UsIHRydWUsIGYpKTsKICAgICAgICAgIGYucHJvbWlzZSA9IHRoaXM7CiAgICAgICAgICBmLnJlYXNvbiA9IHRoaXMucmVzdWx0XzsKICAgICAgICAgIHJldHVybiB2MyhmKTsKICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLmV4ZWN1dGVPblNldHRsZWRDYWxsYmFja3NfID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAobnVsbCAhPSB0aGlzLm9uU2V0dGxlZENhbGxiYWNrc18pIHsKICAgICAgICAgICAgZm9yICh2YXIgZiA9IDA7IGYgPCB0aGlzLm9uU2V0dGxlZENhbGxiYWNrc18ubGVuZ3RoOyArK2YpIEEuYXN5bmNFeGVjdXRlKHRoaXMub25TZXR0bGVkQ2FsbGJhY2tzX1tmXSk7CiAgICAgICAgICAgIHRoaXMub25TZXR0bGVkQ2FsbGJhY2tzXyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgQSA9IG5ldyBuKCk7CiAgICAgICAgaC5wcm90b3R5cGUuc2V0dGxlU2FtZUFzUHJvbWlzZV8gPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICB2YXIgcSA9IHRoaXMuY3JlYXRlUmVzb2x2ZUFuZFJlamVjdF8oKTsKICAgICAgICAgIGYuY2FsbFdoZW5TZXR0bGVkXyhxLnJlc29sdmUsIHEucmVqZWN0KTsKICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLnNldHRsZVNhbWVBc1RoZW5hYmxlXyA9IGZ1bmN0aW9uKGYsIHEpIHsKICAgICAgICAgIHZhciB2MyA9IHRoaXMuY3JlYXRlUmVzb2x2ZUFuZFJlamVjdF8oKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGYuY2FsbChxLCB2My5yZXNvbHZlLCB2My5yZWplY3QpOwogICAgICAgICAgfSBjYXRjaCAoeikgewogICAgICAgICAgICB2My5yZWplY3Qoeik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS50aGVuID0gZnVuY3Rpb24oZiwgcSkgewogICAgICAgICAgZnVuY3Rpb24gdjModCwgeCkgewogICAgICAgICAgICByZXR1cm4gImZ1bmN0aW9uIiA9PSB0eXBlb2YgdCA/IGZ1bmN0aW9uKEQpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgeih0KEQpKTsKICAgICAgICAgICAgICB9IGNhdGNoIChSKSB7CiAgICAgICAgICAgICAgICBPKFIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSA6IHg7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgeiwgTywgYmEgPSBuZXcgaChmdW5jdGlvbih0LCB4KSB7CiAgICAgICAgICAgIHogPSB0OwogICAgICAgICAgICBPID0geDsKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5jYWxsV2hlblNldHRsZWRfKHYzKGYsIHopLCB2MyhxLCBPKSk7CiAgICAgICAgICByZXR1cm4gYmE7CiAgICAgICAgfTsKICAgICAgICBoLnByb3RvdHlwZS5jYXRjaCA9IGZ1bmN0aW9uKGYpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnRoZW4odm9pZCAwLCBmKTsKICAgICAgICB9OwogICAgICAgIGgucHJvdG90eXBlLmNhbGxXaGVuU2V0dGxlZF8gPSBmdW5jdGlvbihmLCBxKSB7CiAgICAgICAgICBmdW5jdGlvbiB2MygpIHsKICAgICAgICAgICAgc3dpdGNoICh6LnN0YXRlXykgewogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIGYoei5yZXN1bHRfKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHEoei5yZXN1bHRfKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiVW5leHBlY3RlZCBzdGF0ZTogIiArIHouc3RhdGVfKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHogPSB0aGlzOwogICAgICAgICAgbnVsbCA9PSB0aGlzLm9uU2V0dGxlZENhbGxiYWNrc18gPyBBLmFzeW5jRXhlY3V0ZSh2MykgOiB0aGlzLm9uU2V0dGxlZENhbGxiYWNrc18ucHVzaCh2Myk7CiAgICAgICAgICB0aGlzLmlzUmVqZWN0aW9uSGFuZGxlZF8gPSB0cnVlOwogICAgICAgIH07CiAgICAgICAgaC5yZXNvbHZlID0gbDsKICAgICAgICBoLnJlamVjdCA9IGZ1bmN0aW9uKGYpIHsKICAgICAgICAgIHJldHVybiBuZXcgaChmdW5jdGlvbihxLCB2MykgewogICAgICAgICAgICB2MyhmKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgaC5yYWNlID0gZnVuY3Rpb24oZikgewogICAgICAgICAgcmV0dXJuIG5ldyBoKGZ1bmN0aW9uKHEsIHYzKSB7CiAgICAgICAgICAgIGZvciAodmFyIHogPSAkanNjb21wLm1ha2VJdGVyYXRvcihmKSwgTyA9IHoubmV4dCgpOyAhTy5kb25lOyBPID0gei5uZXh0KCkpIGwoTy52YWx1ZSkuY2FsbFdoZW5TZXR0bGVkXyhxLCB2Myk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIGguYWxsID0gZnVuY3Rpb24oZikgewogICAgICAgICAgdmFyIHEgPSAkanNjb21wLm1ha2VJdGVyYXRvcihmKSwgdjMgPSBxLm5leHQoKTsKICAgICAgICAgIHJldHVybiB2My5kb25lID8gbChbXSkgOiBuZXcgaChmdW5jdGlvbih6LCBPKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIGJhKEQpIHsKICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oUikgewogICAgICAgICAgICAgICAgdFtEXSA9IFI7CiAgICAgICAgICAgICAgICB4LS07CiAgICAgICAgICAgICAgICAwID09IHggJiYgeih0KTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0ID0gW10sIHggPSAwOwogICAgICAgICAgICBkbwogICAgICAgICAgICAgIHQucHVzaCh2b2lkIDApLCB4KyssIGwodjMudmFsdWUpLmNhbGxXaGVuU2V0dGxlZF8oYmEodC5sZW5ndGggLSAxKSwgTyksIHYzID0gcS5uZXh0KCk7CiAgICAgICAgICAgIHdoaWxlICghdjMuZG9uZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBoOwogICAgICB9LCAiZXM2IiwgImVzMyIpOwogICAgICAkanNjb21wLm93bnMgPSBmdW5jdGlvbihrLCBuKSB7CiAgICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChrLCBuKTsKICAgICAgfTsKICAgICAgJGpzY29tcC5hc3NpZ24gPSAkanNjb21wLlRSVVNUX0VTNl9QT0xZRklMTFMgJiYgImZ1bmN0aW9uIiA9PSB0eXBlb2YgT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24gOiBmdW5jdGlvbihrLCBuKSB7CiAgICAgICAgZm9yICh2YXIgbCA9IDE7IGwgPCBhcmd1bWVudHMubGVuZ3RoOyBsKyspIHsKICAgICAgICAgIHZhciBwID0gYXJndW1lbnRzW2xdOwogICAgICAgICAgaWYgKHApIGZvciAodmFyIGggaW4gcCkgJGpzY29tcC5vd25zKHAsIGgpICYmIChrW2hdID0gcFtoXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBrOwogICAgICB9OwogICAgICAkanNjb21wLnBvbHlmaWxsKCJPYmplY3QuYXNzaWduIiwgZnVuY3Rpb24oaykgewogICAgICAgIHJldHVybiBrIHx8ICRqc2NvbXAuYXNzaWduOwogICAgICB9LCAiZXM2IiwgImVzMyIpOwogICAgICAkanNjb21wLmNoZWNrU3RyaW5nQXJncyA9IGZ1bmN0aW9uKGssIG4sIGwpIHsKICAgICAgICBpZiAobnVsbCA9PSBrKSB0aHJvdyBuZXcgVHlwZUVycm9yKCJUaGUgJ3RoaXMnIHZhbHVlIGZvciBTdHJpbmcucHJvdG90eXBlLiIgKyBsICsgIiBtdXN0IG5vdCBiZSBudWxsIG9yIHVuZGVmaW5lZCIpOwogICAgICAgIGlmIChuIGluc3RhbmNlb2YgUmVnRXhwKSB0aHJvdyBuZXcgVHlwZUVycm9yKCJGaXJzdCBhcmd1bWVudCB0byBTdHJpbmcucHJvdG90eXBlLiIgKyBsICsgIiBtdXN0IG5vdCBiZSBhIHJlZ3VsYXIgZXhwcmVzc2lvbiIpOwogICAgICAgIHJldHVybiBrICsgIiI7CiAgICAgIH07CiAgICAgICRqc2NvbXAucG9seWZpbGwoIlN0cmluZy5wcm90b3R5cGUuc3RhcnRzV2l0aCIsIGZ1bmN0aW9uKGspIHsKICAgICAgICByZXR1cm4gayA/IGsgOiBmdW5jdGlvbihuLCBsKSB7CiAgICAgICAgICB2YXIgcCA9ICRqc2NvbXAuY2hlY2tTdHJpbmdBcmdzKHRoaXMsIG4sICJzdGFydHNXaXRoIik7CiAgICAgICAgICBuICs9ICIiOwogICAgICAgICAgdmFyIGggPSBwLmxlbmd0aCwgQSA9IG4ubGVuZ3RoOwogICAgICAgICAgbCA9IE1hdGgubWF4KDAsIE1hdGgubWluKGwgfCAwLCBwLmxlbmd0aCkpOwogICAgICAgICAgZm9yICh2YXIgZiA9IDA7IGYgPCBBICYmIGwgPCBoOyApIGlmIChwW2wrK10gIT0gbltmKytdKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICByZXR1cm4gZiA+PSBBOwogICAgICAgIH07CiAgICAgIH0sICJlczYiLCAiZXMzIik7CiAgICAgICRqc2NvbXAucG9seWZpbGwoIkFycmF5LnByb3RvdHlwZS5jb3B5V2l0aGluIiwgZnVuY3Rpb24oaykgewogICAgICAgIGZ1bmN0aW9uIG4obCkgewogICAgICAgICAgbCA9IE51bWJlcihsKTsKICAgICAgICAgIHJldHVybiBJbmZpbml0eSA9PT0gbCB8fCAtSW5maW5pdHkgPT09IGwgPyBsIDogbCB8IDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBrID8gayA6IGZ1bmN0aW9uKGwsIHAsIGgpIHsKICAgICAgICAgIHZhciBBID0gdGhpcy5sZW5ndGg7CiAgICAgICAgICBsID0gbihsKTsKICAgICAgICAgIHAgPSBuKHApOwogICAgICAgICAgaCA9IHZvaWQgMCA9PT0gaCA/IEEgOiBuKGgpOwogICAgICAgICAgbCA9IDAgPiBsID8gTWF0aC5tYXgoQSArIGwsIDApIDogTWF0aC5taW4obCwgQSk7CiAgICAgICAgICBwID0gMCA+IHAgPyBNYXRoLm1heChBICsgcCwgMCkgOiBNYXRoLm1pbihwLCBBKTsKICAgICAgICAgIGggPSAwID4gaCA/IE1hdGgubWF4KEEgKyBoLCAwKSA6IE1hdGgubWluKGgsIEEpOwogICAgICAgICAgaWYgKGwgPCBwKSBmb3IgKDsgcCA8IGg7ICkgcCBpbiB0aGlzID8gdGhpc1tsKytdID0gdGhpc1twKytdIDogKGRlbGV0ZSB0aGlzW2wrK10sIHArKyk7CiAgICAgICAgICBlbHNlIGZvciAoaCA9IE1hdGgubWluKGgsIEEgKyBwIC0gbCksIGwgKz0gaCAtIHA7IGggPiBwOyApIC0taCBpbiB0aGlzID8gdGhpc1stLWxdID0gdGhpc1toXSA6IGRlbGV0ZSB0aGlzWy0tbF07CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwogICAgICB9LCAiZXM2IiwgImVzMyIpOwogICAgICAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluID0gZnVuY3Rpb24oaykgewogICAgICAgIHJldHVybiBrID8gayA6IEFycmF5LnByb3RvdHlwZS5jb3B5V2l0aGluOwogICAgICB9OwogICAgICAkanNjb21wLnBvbHlmaWxsKCJJbnQ4QXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJVaW50OEFycmF5LnByb3RvdHlwZS5jb3B5V2l0aGluIiwgJGpzY29tcC50eXBlZEFycmF5Q29weVdpdGhpbiwgImVzNiIsICJlczUiKTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiVWludDhDbGFtcGVkQXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJJbnQxNkFycmF5LnByb3RvdHlwZS5jb3B5V2l0aGluIiwgJGpzY29tcC50eXBlZEFycmF5Q29weVdpdGhpbiwgImVzNiIsICJlczUiKTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiVWludDE2QXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJJbnQzMkFycmF5LnByb3RvdHlwZS5jb3B5V2l0aGluIiwgJGpzY29tcC50eXBlZEFycmF5Q29weVdpdGhpbiwgImVzNiIsICJlczUiKTsKICAgICAgJGpzY29tcC5wb2x5ZmlsbCgiVWludDMyQXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJGbG9hdDMyQXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICAkanNjb21wLnBvbHlmaWxsKCJGbG9hdDY0QXJyYXkucHJvdG90eXBlLmNvcHlXaXRoaW4iLCAkanNjb21wLnR5cGVkQXJyYXlDb3B5V2l0aGluLCAiZXM2IiwgImVzNSIpOwogICAgICB2YXIgRHJhY29EZWNvZGVyTW9kdWxlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGsgPSAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIGRvY3VtZW50ICYmIGRvY3VtZW50LmN1cnJlbnRTY3JpcHQgPyBkb2N1bWVudC5jdXJyZW50U2NyaXB0LnNyYyA6IHZvaWQgMDsKICAgICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fZmlsZW5hbWUgJiYgKGsgPSBrIHx8IF9fZmlsZW5hbWUpOwogICAgICAgIHJldHVybiBmdW5jdGlvbihuKSB7CiAgICAgICAgICBmdW5jdGlvbiBsKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGEzLmxvY2F0ZUZpbGUgPyBhMy5sb2NhdGVGaWxlKGUsIFUpIDogVSArIGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwKGUsIGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSBiICsgYzsKICAgICAgICAgICAgZm9yIChjID0gYjsgZVtjXSAmJiAhKGMgPj0gZCk7ICkgKytjOwogICAgICAgICAgICBpZiAoMTYgPCBjIC0gYiAmJiBlLmJ1ZmZlciAmJiB2YSkgcmV0dXJuIHZhLmRlY29kZShlLnN1YmFycmF5KGIsIGMpKTsKICAgICAgICAgICAgZm9yIChkID0gIiI7IGIgPCBjOyApIHsKICAgICAgICAgICAgICB2YXIgZyA9IGVbYisrXTsKICAgICAgICAgICAgICBpZiAoZyAmIDEyOCkgewogICAgICAgICAgICAgICAgdmFyIHUzID0gZVtiKytdICYgNjM7CiAgICAgICAgICAgICAgICBpZiAoMTkyID09IChnICYgMjI0KSkgZCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKChnICYgMzEpIDw8IDYgfCB1Myk7CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIFggPSBlW2IrK10gJiA2MzsKICAgICAgICAgICAgICAgICAgZyA9IDIyNCA9PSAoZyAmIDI0MCkgPyAoZyAmIDE1KSA8PCAxMiB8IHUzIDw8IDYgfCBYIDogKGcgJiA3KSA8PCAxOCB8IHUzIDw8IDEyIHwgWCA8PCA2IHwgZVtiKytdICYgNjM7CiAgICAgICAgICAgICAgICAgIDY1NTM2ID4gZyA/IGQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShnKSA6IChnIC09IDY1NTM2LCBkICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoNTUyOTYgfCBnID4+IDEwLCA1NjMyMCB8IGcgJiAxMDIzKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGgoZSwgYikgewogICAgICAgICAgICByZXR1cm4gZSA/IHAoZWEsIGUsIGIpIDogIiI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBBKCkgewogICAgICAgICAgICB2YXIgZSA9IGphLmJ1ZmZlcjsKICAgICAgICAgICAgYTMuSEVBUDggPSBZID0gbmV3IEludDhBcnJheShlKTsKICAgICAgICAgICAgYTMuSEVBUDE2ID0gbmV3IEludDE2QXJyYXkoZSk7CiAgICAgICAgICAgIGEzLkhFQVAzMiA9IGNhID0gbmV3IEludDMyQXJyYXkoZSk7CiAgICAgICAgICAgIGEzLkhFQVBVOCA9IGVhID0gbmV3IFVpbnQ4QXJyYXkoZSk7CiAgICAgICAgICAgIGEzLkhFQVBVMTYgPSBuZXcgVWludDE2QXJyYXkoZSk7CiAgICAgICAgICAgIGEzLkhFQVBVMzIgPSBWID0gbmV3IFVpbnQzMkFycmF5KGUpOwogICAgICAgICAgICBhMy5IRUFQRjMyID0gbmV3IEZsb2F0MzJBcnJheShlKTsKICAgICAgICAgICAgYTMuSEVBUEY2NCA9IG5ldyBGbG9hdDY0QXJyYXkoZSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBmKGUpIHsKICAgICAgICAgICAgaWYgKGEzLm9uQWJvcnQpIGEzLm9uQWJvcnQoZSk7CiAgICAgICAgICAgIGUgPSAiQWJvcnRlZCgiICsgZSArICIpIjsKICAgICAgICAgICAgZGEoZSk7CiAgICAgICAgICAgIHdhID0gdHJ1ZTsKICAgICAgICAgICAgZSA9IG5ldyBXZWJBc3NlbWJseS5SdW50aW1lRXJyb3IoZSArICIuIEJ1aWxkIHdpdGggLXNBU1NFUlRJT05TIGZvciBtb3JlIGluZm8uIik7CiAgICAgICAgICAgIGthKGUpOwogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcShlKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKGUgPT0gUCAmJiBmYSkgcmV0dXJuIG5ldyBVaW50OEFycmF5KGZhKTsKICAgICAgICAgICAgICBpZiAobWEpIHJldHVybiBtYShlKTsKICAgICAgICAgICAgICB0aHJvdyAiYm90aCBhc3luYyBhbmQgc3luYyBmZXRjaGluZyBvZiB0aGUgd2FzbSBmYWlsZWQiOwogICAgICAgICAgICB9IGNhdGNoIChiKSB7CiAgICAgICAgICAgICAgZihiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdjMoKSB7CiAgICAgICAgICAgIGlmICghZmEgJiYgKHhhIHx8IGhhKSkgewogICAgICAgICAgICAgIGlmICgiZnVuY3Rpb24iID09IHR5cGVvZiBmZXRjaCAmJiAhUC5zdGFydHNXaXRoKCJmaWxlOi8vIikpIHJldHVybiBmZXRjaChQLCB7IGNyZWRlbnRpYWxzOiAic2FtZS1vcmlnaW4iIH0pLnRoZW4oZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgaWYgKCFlLm9rKSB0aHJvdyAiZmFpbGVkIHRvIGxvYWQgd2FzbSBiaW5hcnkgZmlsZSBhdCAnIiArIFAgKyAiJyI7CiAgICAgICAgICAgICAgICByZXR1cm4gZS5hcnJheUJ1ZmZlcigpOwogICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHEoUCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKG5hKSByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24oZSwgYikgewogICAgICAgICAgICAgICAgbmEoUCwgZnVuY3Rpb24oYykgewogICAgICAgICAgICAgICAgICBlKG5ldyBVaW50OEFycmF5KGMpKTsKICAgICAgICAgICAgICAgIH0sIGIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBxKFApOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHooZSkgewogICAgICAgICAgICBmb3IgKDsgMCA8IGUubGVuZ3RoOyApIGUuc2hpZnQoKShhMyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBPKGUpIHsKICAgICAgICAgICAgdGhpcy5leGNQdHIgPSBlOwogICAgICAgICAgICB0aGlzLnB0ciA9IGUgLSAyNDsKICAgICAgICAgICAgdGhpcy5zZXRfdHlwZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICBWW3RoaXMucHRyICsgNCA+PiAyXSA9IGI7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZ2V0X3R5cGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gVlt0aGlzLnB0ciArIDQgPj4gMl07CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2V0X2Rlc3RydWN0b3IgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgICAgVlt0aGlzLnB0ciArIDggPj4gMl0gPSBiOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmdldF9kZXN0cnVjdG9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFZbdGhpcy5wdHIgKyA4ID4+IDJdOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLnNldF9yZWZjb3VudCA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICBjYVt0aGlzLnB0ciA+PiAyXSA9IGI7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2V0X2NhdWdodCA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICBZW3RoaXMucHRyICsgMTIgPj4gMF0gPSBiID8gMSA6IDA7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuZ2V0X2NhdWdodCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAwICE9IFlbdGhpcy5wdHIgKyAxMiA+PiAwXTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5zZXRfcmV0aHJvd24gPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgICAgWVt0aGlzLnB0ciArIDEzID4+IDBdID0gYiA/IDEgOiAwOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmdldF9yZXRocm93biA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAwICE9IFlbdGhpcy5wdHIgKyAxMyA+PiAwXTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5pbml0ID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICAgIHRoaXMuc2V0X2FkanVzdGVkX3B0cigwKTsKICAgICAgICAgICAgICB0aGlzLnNldF90eXBlKGIpOwogICAgICAgICAgICAgIHRoaXMuc2V0X2Rlc3RydWN0b3IoYyk7CiAgICAgICAgICAgICAgdGhpcy5zZXRfcmVmY291bnQoMCk7CiAgICAgICAgICAgICAgdGhpcy5zZXRfY2F1Z2h0KGZhbHNlKTsKICAgICAgICAgICAgICB0aGlzLnNldF9yZXRocm93bihmYWxzZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuYWRkX3JlZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGNhW3RoaXMucHRyID4+IDJdICs9IDE7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMucmVsZWFzZV9yZWYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB2YXIgYiA9IGNhW3RoaXMucHRyID4+IDJdOwogICAgICAgICAgICAgIGNhW3RoaXMucHRyID4+IDJdID0gYiAtIDE7CiAgICAgICAgICAgICAgcmV0dXJuIDEgPT09IGI7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2V0X2FkanVzdGVkX3B0ciA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICBWW3RoaXMucHRyICsgMTYgPj4gMl0gPSBiOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmdldF9hZGp1c3RlZF9wdHIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gVlt0aGlzLnB0ciArIDE2ID4+IDJdOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmdldF9leGNlcHRpb25fcHRyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKHlhKHRoaXMuZ2V0X3R5cGUoKSkpIHJldHVybiBWW3RoaXMuZXhjUHRyID4+IDJdOwogICAgICAgICAgICAgIHZhciBiID0gdGhpcy5nZXRfYWRqdXN0ZWRfcHRyKCk7CiAgICAgICAgICAgICAgcmV0dXJuIDAgIT09IGIgPyBiIDogdGhpcy5leGNQdHI7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBiYSgpIHsKICAgICAgICAgICAgZnVuY3Rpb24gZSgpIHsKICAgICAgICAgICAgICBpZiAoIWxhICYmIChsYSA9IHRydWUsIGEzLmNhbGxlZFJ1biA9IHRydWUsICF3YSkpIHsKICAgICAgICAgICAgICAgIHphID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHoob2EpOwogICAgICAgICAgICAgICAgQWEoYTMpOwogICAgICAgICAgICAgICAgaWYgKGEzLm9uUnVudGltZUluaXRpYWxpemVkKSBhMy5vblJ1bnRpbWVJbml0aWFsaXplZCgpOwogICAgICAgICAgICAgICAgaWYgKGEzLnBvc3RSdW4pIGZvciAoImZ1bmN0aW9uIiA9PSB0eXBlb2YgYTMucG9zdFJ1biAmJiAoYTMucG9zdFJ1biA9IFthMy5wb3N0UnVuXSk7IGEzLnBvc3RSdW4ubGVuZ3RoOyApIEJhLnVuc2hpZnQoYTMucG9zdFJ1bi5zaGlmdCgpKTsKICAgICAgICAgICAgICAgIHooQmEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoISgwIDwgYWEpKSB7CiAgICAgICAgICAgICAgaWYgKGEzLnByZVJ1bikgZm9yICgiZnVuY3Rpb24iID09IHR5cGVvZiBhMy5wcmVSdW4gJiYgKGEzLnByZVJ1biA9IFthMy5wcmVSdW5dKTsgYTMucHJlUnVuLmxlbmd0aDsgKSBDYS51bnNoaWZ0KGEzLnByZVJ1bi5zaGlmdCgpKTsKICAgICAgICAgICAgICB6KENhKTsKICAgICAgICAgICAgICAwIDwgYWEgfHwgKGEzLnNldFN0YXR1cyA/IChhMy5zZXRTdGF0dXMoIlJ1bm5pbmcuLi4iKSwgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGEzLnNldFN0YXR1cygiIik7CiAgICAgICAgICAgICAgICB9LCAxKTsKICAgICAgICAgICAgICAgIGUoKTsKICAgICAgICAgICAgICB9LCAxKSkgOiBlKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB0KCkgewogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24geChlKSB7CiAgICAgICAgICAgIHJldHVybiAoZSB8fCB0KS5fX2NhY2hlX187CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBEKGUsIGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB4KGIpLCBkID0gY1tlXTsKICAgICAgICAgICAgaWYgKGQpIHJldHVybiBkOwogICAgICAgICAgICBkID0gT2JqZWN0LmNyZWF0ZSgoYiB8fCB0KS5wcm90b3R5cGUpOwogICAgICAgICAgICBkLnB0ciA9IGU7CiAgICAgICAgICAgIHJldHVybiBjW2VdID0gZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFIoZSkgewogICAgICAgICAgICBpZiAoInN0cmluZyIgPT09IHR5cGVvZiBlKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgYiA9IDAsIGMgPSAwOyBjIDwgZS5sZW5ndGg7ICsrYykgewogICAgICAgICAgICAgICAgdmFyIGQgPSBlLmNoYXJDb2RlQXQoYyk7CiAgICAgICAgICAgICAgICAxMjcgPj0gZCA/IGIrKyA6IDIwNDcgPj0gZCA/IGIgKz0gMiA6IDU1Mjk2IDw9IGQgJiYgNTczNDMgPj0gZCA/IChiICs9IDQsICsrYykgOiBiICs9IDM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGIgPSBBcnJheShiICsgMSk7CiAgICAgICAgICAgICAgYyA9IDA7CiAgICAgICAgICAgICAgZCA9IGIubGVuZ3RoOwogICAgICAgICAgICAgIGlmICgwIDwgZCkgewogICAgICAgICAgICAgICAgZCA9IGMgKyBkIC0gMTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGcgPSAwOyBnIDwgZS5sZW5ndGg7ICsrZykgewogICAgICAgICAgICAgICAgICB2YXIgdTMgPSBlLmNoYXJDb2RlQXQoZyk7CiAgICAgICAgICAgICAgICAgIGlmICg1NTI5NiA8PSB1MyAmJiA1NzM0MyA+PSB1MykgewogICAgICAgICAgICAgICAgICAgIHZhciBYID0gZS5jaGFyQ29kZUF0KCsrZyk7CiAgICAgICAgICAgICAgICAgICAgdTMgPSA2NTUzNiArICgodTMgJiAxMDIzKSA8PCAxMCkgfCBYICYgMTAyMzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoMTI3ID49IHUzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGMgPj0gZCkgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgYltjKytdID0gdTM7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKDIwNDcgPj0gdTMpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjICsgMSA+PSBkKSBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGJbYysrXSA9IDE5MiB8IHUzID4+IDY7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICg2NTUzNSA+PSB1MykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYyArIDIgPj0gZCkgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGJbYysrXSA9IDIyNCB8IHUzID4+IDEyOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMgKyAzID49IGQpIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBiW2MrK10gPSAyNDAgfCB1MyA+PiAxODsKICAgICAgICAgICAgICAgICAgICAgICAgYltjKytdID0gMTI4IHwgdTMgPj4gMTIgJiA2MzsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGJbYysrXSA9IDEyOCB8IHUzID4+IDYgJiA2MzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYltjKytdID0gMTI4IHwgdTMgJiA2MzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYltjXSA9IDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGUgPSByLmFsbG9jKGIsIFkpOwogICAgICAgICAgICAgIHIuY29weShiLCBZLCBlKTsKICAgICAgICAgICAgICByZXR1cm4gZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBhKGUpIHsKICAgICAgICAgICAgaWYgKCJvYmplY3QiID09PSB0eXBlb2YgZSkgewogICAgICAgICAgICAgIHZhciBiID0gci5hbGxvYyhlLCBZKTsKICAgICAgICAgICAgICByLmNvcHkoZSwgWSwgYik7CiAgICAgICAgICAgICAgcmV0dXJuIGI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBaKCkgewogICAgICAgICAgICB0aHJvdyAiY2Fubm90IGNvbnN0cnVjdCBhIFZvaWRQdHIsIG5vIGNvbnN0cnVjdG9yIGluIElETCI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBTKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IERhKCk7CiAgICAgICAgICAgIHgoUylbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFEoKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gRWEoKTsKICAgICAgICAgICAgeChRKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gVygpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBGYSgpOwogICAgICAgICAgICB4KFcpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3KCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IEdhKCk7CiAgICAgICAgICAgIHgodylbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEMoKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gSGEoKTsKICAgICAgICAgICAgeChDKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gRigpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBJYSgpOwogICAgICAgICAgICB4KEYpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBHKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IEphKCk7CiAgICAgICAgICAgIHgoRylbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEUoKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gS2EoKTsKICAgICAgICAgICAgeChFKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gVCgpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBMYSgpOwogICAgICAgICAgICB4KFQpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBCKCkgewogICAgICAgICAgICB0aHJvdyAiY2Fubm90IGNvbnN0cnVjdCBhIFN0YXR1cywgbm8gY29uc3RydWN0b3IgaW4gSURMIjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEgoKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gTWEoKTsKICAgICAgICAgICAgeChIKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gSSgpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBOYSgpOwogICAgICAgICAgICB4KEkpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBKKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IE9hKCk7CiAgICAgICAgICAgIHgoSilbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIEsoKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gUGEoKTsKICAgICAgICAgICAgeChLKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gTCgpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBRYSgpOwogICAgICAgICAgICB4KEwpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBNKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IFJhKCk7CiAgICAgICAgICAgIHgoTSlbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIE4oKSB7CiAgICAgICAgICAgIHRoaXMucHRyID0gU2EoKTsKICAgICAgICAgICAgeChOKVt0aGlzLnB0cl0gPSB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24geSgpIHsKICAgICAgICAgICAgdGhpcy5wdHIgPSBUYSgpOwogICAgICAgICAgICB4KHkpW3RoaXMucHRyXSA9IHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtKCkgewogICAgICAgICAgICB0aGlzLnB0ciA9IFVhKCk7CiAgICAgICAgICAgIHgobSlbdGhpcy5wdHJdID0gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIG4gPSB2b2lkIDAgPT09IG4gPyB7fSA6IG47CiAgICAgICAgICB2YXIgYTMgPSAidW5kZWZpbmVkIiAhPSB0eXBlb2YgbiA/IG4gOiB7fSwgQWEsIGthOwogICAgICAgICAgYTMucmVhZHkgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihlLCBiKSB7CiAgICAgICAgICAgIEFhID0gZTsKICAgICAgICAgICAga2EgPSBiOwogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgVmEgPSBmYWxzZSwgV2EgPSBmYWxzZTsKICAgICAgICAgIGEzLm9uUnVudGltZUluaXRpYWxpemVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIFZhID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKFdhICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBhMy5vbk1vZHVsZUxvYWRlZCkgYTMub25Nb2R1bGVMb2FkZWQoYTMpOwogICAgICAgICAgfTsKICAgICAgICAgIGEzLm9uTW9kdWxlUGFyc2VkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIFdhID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKFZhICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBhMy5vbk1vZHVsZUxvYWRlZCkgYTMub25Nb2R1bGVMb2FkZWQoYTMpOwogICAgICAgICAgfTsKICAgICAgICAgIGEzLmlzVmVyc2lvblN1cHBvcnRlZCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgaWYgKCJzdHJpbmciICE9PSB0eXBlb2YgZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBlID0gZS5zcGxpdCgiLiIpOwogICAgICAgICAgICByZXR1cm4gMiA+IGUubGVuZ3RoIHx8IDMgPCBlLmxlbmd0aCA/IGZhbHNlIDogMSA9PSBlWzBdICYmIDAgPD0gZVsxXSAmJiA1ID49IGVbMV0gPyB0cnVlIDogMCAhPSBlWzBdIHx8IDEwIDwgZVsxXSA/IGZhbHNlIDogdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgWGEgPSBPYmplY3QuYXNzaWduKHt9LCBhMyksIHhhID0gIm9iamVjdCIgPT0gdHlwZW9mIHdpbmRvdywgaGEgPSAiZnVuY3Rpb24iID09IHR5cGVvZiBpbXBvcnRTY3JpcHRzLCBZYSA9ICJvYmplY3QiID09IHR5cGVvZiBwcm9jZXNzICYmICJvYmplY3QiID09IHR5cGVvZiBwcm9jZXNzLnZlcnNpb25zICYmICJzdHJpbmciID09IHR5cGVvZiBwcm9jZXNzLnZlcnNpb25zLm5vZGUsIFUgPSAiIjsKICAgICAgICAgIGlmIChZYSkgewogICAgICAgICAgICB2YXIgWmEgPSBfX3JlcXVpcmUoImZzIiksIHFhID0gX19yZXF1aXJlKCJwYXRoIik7CiAgICAgICAgICAgIFUgPSBoYSA/IHFhLmRpcm5hbWUoVSkgKyAiLyIgOiBfX2Rpcm5hbWUgKyAiLyI7CiAgICAgICAgICAgIHZhciAkYSA9IGZ1bmN0aW9uKGUsIGIpIHsKICAgICAgICAgICAgICBlID0gZS5zdGFydHNXaXRoKCJmaWxlOi8vIikgPyBuZXcgVVJMKGUpIDogcWEubm9ybWFsaXplKGUpOwogICAgICAgICAgICAgIHJldHVybiBaYS5yZWFkRmlsZVN5bmMoZSwgYiA/IHZvaWQgMCA6ICJ1dGY4Iik7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBtYSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICBlID0gJGEoZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgZS5idWZmZXIgfHwgKGUgPSBuZXcgVWludDhBcnJheShlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIGU7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciBuYSA9IGZ1bmN0aW9uKGUsIGIsIGMpIHsKICAgICAgICAgICAgICBlID0gZS5zdGFydHNXaXRoKCJmaWxlOi8vIikgPyBuZXcgVVJMKGUpIDogcWEubm9ybWFsaXplKGUpOwogICAgICAgICAgICAgIFphLnJlYWRGaWxlKGUsIGZ1bmN0aW9uKGQsIGcpIHsKICAgICAgICAgICAgICAgIGQgPyBjKGQpIDogYihnLmJ1ZmZlcik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIDEgPCBwcm9jZXNzLmFyZ3YubGVuZ3RoICYmIHByb2Nlc3MuYXJndlsxXS5yZXBsYWNlKC9cXC9nLCAiLyIpOwogICAgICAgICAgICBwcm9jZXNzLmFyZ3Yuc2xpY2UoMik7CiAgICAgICAgICAgIGEzLmluc3BlY3QgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gIltFbXNjcmlwdGVuIE1vZHVsZSBvYmplY3RdIjsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSBpZiAoeGEgfHwgaGEpIGhhID8gVSA9IHNlbGYubG9jYXRpb24uaHJlZiA6ICJ1bmRlZmluZWQiICE9IHR5cGVvZiBkb2N1bWVudCAmJiBkb2N1bWVudC5jdXJyZW50U2NyaXB0ICYmIChVID0gZG9jdW1lbnQuY3VycmVudFNjcmlwdC5zcmMpLCBrICYmIChVID0gayksIFUgPSAwICE9PSBVLmluZGV4T2YoImJsb2I6IikgPyBVLnN1YnN0cigwLCBVLnJlcGxhY2UoL1s/I10uKi8sICIiKS5sYXN0SW5kZXhPZigiLyIpICsgMSkgOiAiIiwgJGEgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHZhciBiID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgICAgIGIub3BlbigiR0VUIiwgZSwgZmFsc2UpOwogICAgICAgICAgICBiLnNlbmQobnVsbCk7CiAgICAgICAgICAgIHJldHVybiBiLnJlc3BvbnNlVGV4dDsKICAgICAgICAgIH0sIGhhICYmIChtYSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdmFyIGIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgICAgICAgICAgYi5vcGVuKCJHRVQiLCBlLCBmYWxzZSk7CiAgICAgICAgICAgIGIucmVzcG9uc2VUeXBlID0gImFycmF5YnVmZmVyIjsKICAgICAgICAgICAgYi5zZW5kKG51bGwpOwogICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoYi5yZXNwb25zZSk7CiAgICAgICAgICB9KSwgbmEgPSBmdW5jdGlvbihlLCBiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgICAgIGQub3BlbigiR0VUIiwgZSwgdHJ1ZSk7CiAgICAgICAgICAgIGQucmVzcG9uc2VUeXBlID0gImFycmF5YnVmZmVyIjsKICAgICAgICAgICAgZC5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAyMDAgPT0gZC5zdGF0dXMgfHwgMCA9PSBkLnN0YXR1cyAmJiBkLnJlc3BvbnNlID8gYihkLnJlc3BvbnNlKSA6IGMoKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgZC5vbmVycm9yID0gYzsKICAgICAgICAgICAgZC5zZW5kKG51bGwpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB1ZCA9IGEzLnByaW50IHx8IGNvbnNvbGUubG9nLmJpbmQoY29uc29sZSksIGRhID0gYTMucHJpbnRFcnIgfHwgY29uc29sZS53YXJuLmJpbmQoY29uc29sZSk7CiAgICAgICAgICBPYmplY3QuYXNzaWduKGEzLCBYYSk7CiAgICAgICAgICBYYSA9IG51bGw7CiAgICAgICAgICB2YXIgZmE7CiAgICAgICAgICBhMy53YXNtQmluYXJ5ICYmIChmYSA9IGEzLndhc21CaW5hcnkpOwogICAgICAgICAgIm9iamVjdCIgIT0gdHlwZW9mIFdlYkFzc2VtYmx5ICYmIGYoIm5vIG5hdGl2ZSB3YXNtIHN1cHBvcnQgZGV0ZWN0ZWQiKTsKICAgICAgICAgIHZhciBqYSwgd2EgPSBmYWxzZSwgdmEgPSAidW5kZWZpbmVkIiAhPSB0eXBlb2YgVGV4dERlY29kZXIgPyBuZXcgVGV4dERlY29kZXIoInV0ZjgiKSA6IHZvaWQgMCwgWSwgZWEsIGNhLCBWLCBDYSA9IFtdLCBvYSA9IFtdLCBCYSA9IFtdLCB6YSA9IGZhbHNlLCBhYSA9IDAsIHJhID0gbnVsbCwgaWEgPSBudWxsOwogICAgICAgICAgdmFyIFAgPSAiZHJhY29fZGVjb2Rlci53YXNtIjsKICAgICAgICAgIFAuc3RhcnRzV2l0aCgiZGF0YTphcHBsaWNhdGlvbi9vY3RldC1zdHJlYW07YmFzZTY0LCIpIHx8IChQID0gbChQKSk7CiAgICAgICAgICB2YXIgdmQgPSAwLCB3ZCA9IFtudWxsLCBbXSwgW11dLCB4ZCA9IHsgYjogZnVuY3Rpb24oZSwgYiwgYykgewogICAgICAgICAgICBuZXcgTyhlKS5pbml0KGIsIGMpOwogICAgICAgICAgICB2ZCsrOwogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgfSwgYTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGYoIiIpOwogICAgICAgICAgfSwgZzogZnVuY3Rpb24oZSwgYiwgYykgewogICAgICAgICAgICBlYS5jb3B5V2l0aGluKGUsIGIsIGIgKyBjKTsKICAgICAgICAgIH0sIGU6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgdmFyIGIgPSBlYS5sZW5ndGg7CiAgICAgICAgICAgIGUgPj4+PSAwOwogICAgICAgICAgICBpZiAoMjE0NzQ4MzY0OCA8IGUpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgZm9yICh2YXIgYyA9IDE7IDQgPj0gYzsgYyAqPSAyKSB7CiAgICAgICAgICAgICAgdmFyIGQgPSBiICogKDEgKyAwLjIgLyBjKTsKICAgICAgICAgICAgICBkID0gTWF0aC5taW4oZCwgZSArIDEwMDY2MzI5Nik7CiAgICAgICAgICAgICAgdmFyIGcgPSBNYXRoOwogICAgICAgICAgICAgIGQgPSBNYXRoLm1heChlLCBkKTsKICAgICAgICAgICAgICBnID0gZy5taW4uY2FsbChnLCAyMTQ3NDgzNjQ4LCBkICsgKDY1NTM2IC0gZCAlIDY1NTM2KSAlIDY1NTM2KTsKICAgICAgICAgICAgICBhOiB7CiAgICAgICAgICAgICAgICBkID0gamEuYnVmZmVyOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgamEuZ3JvdyhnIC0gZC5ieXRlTGVuZ3RoICsgNjU1MzUgPj4+IDE2KTsKICAgICAgICAgICAgICAgICAgQSgpOwogICAgICAgICAgICAgICAgICB2YXIgdTMgPSAxOwogICAgICAgICAgICAgICAgICBicmVhayBhOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoWCkgewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdTMgPSB2b2lkIDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh1MykgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSwgZjogZnVuY3Rpb24oZSkgewogICAgICAgICAgICByZXR1cm4gNTI7CiAgICAgICAgICB9LCBkOiBmdW5jdGlvbihlLCBiLCBjLCBkLCBnKSB7CiAgICAgICAgICAgIHJldHVybiA3MDsKICAgICAgICAgIH0sIGM6IGZ1bmN0aW9uKGUsIGIsIGMsIGQpIHsKICAgICAgICAgICAgZm9yICh2YXIgZyA9IDAsIHUzID0gMDsgdTMgPCBjOyB1MysrKSB7CiAgICAgICAgICAgICAgdmFyIFggPSBWW2IgPj4gMl0sIGFiID0gVltiICsgNCA+PiAyXTsKICAgICAgICAgICAgICBiICs9IDg7CiAgICAgICAgICAgICAgZm9yICh2YXIgc2EgPSAwOyBzYSA8IGFiOyBzYSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgdGEgPSBlYVtYICsgc2FdLCB1YSA9IHdkW2VdOwogICAgICAgICAgICAgICAgMCA9PT0gdGEgfHwgMTAgPT09IHRhID8gKCgxID09PSBlID8gdWQgOiBkYSkocCh1YSwgMCkpLCB1YS5sZW5ndGggPSAwKSA6IHVhLnB1c2godGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBnICs9IGFiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIFZbZCA+PiAyXSA9IGc7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfSB9OwogICAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmdW5jdGlvbiBlKGcsIHUzKSB7CiAgICAgICAgICAgICAgYTMuYXNtID0gZy5leHBvcnRzOwogICAgICAgICAgICAgIGphID0gYTMuYXNtLmg7CiAgICAgICAgICAgICAgQSgpOwogICAgICAgICAgICAgIG9hLnVuc2hpZnQoYTMuYXNtLmkpOwogICAgICAgICAgICAgIGFhLS07CiAgICAgICAgICAgICAgYTMubW9uaXRvclJ1bkRlcGVuZGVuY2llcyAmJiBhMy5tb25pdG9yUnVuRGVwZW5kZW5jaWVzKGFhKTsKICAgICAgICAgICAgICAwID09IGFhICYmIChudWxsICE9PSByYSAmJiAoY2xlYXJJbnRlcnZhbChyYSksIHJhID0gbnVsbCksIGlhICYmIChnID0gaWEsIGlhID0gbnVsbCwgZygpKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gYihnKSB7CiAgICAgICAgICAgICAgZShnLmluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBjKGcpIHsKICAgICAgICAgICAgICByZXR1cm4gdjMoKS50aGVuKGZ1bmN0aW9uKHUzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gV2ViQXNzZW1ibHkuaW5zdGFudGlhdGUodTMsIGQpOwogICAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24odTMpIHsKICAgICAgICAgICAgICAgIHJldHVybiB1MzsKICAgICAgICAgICAgICB9KS50aGVuKGcsIGZ1bmN0aW9uKHUzKSB7CiAgICAgICAgICAgICAgICBkYSgiZmFpbGVkIHRvIGFzeW5jaHJvbm91c2x5IHByZXBhcmUgd2FzbTogIiArIHUzKTsKICAgICAgICAgICAgICAgIGYodTMpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkID0geyBhOiB4ZCB9OwogICAgICAgICAgICBhYSsrOwogICAgICAgICAgICBhMy5tb25pdG9yUnVuRGVwZW5kZW5jaWVzICYmIGEzLm1vbml0b3JSdW5EZXBlbmRlbmNpZXMoYWEpOwogICAgICAgICAgICBpZiAoYTMuaW5zdGFudGlhdGVXYXNtKSB0cnkgewogICAgICAgICAgICAgIHJldHVybiBhMy5pbnN0YW50aWF0ZVdhc20oZCwgZSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGcpIHsKICAgICAgICAgICAgICBkYSgiTW9kdWxlLmluc3RhbnRpYXRlV2FzbSBjYWxsYmFjayBmYWlsZWQgd2l0aCBlcnJvcjogIiArIGcpLCBrYShnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhIHx8ICJmdW5jdGlvbiIgIT0gdHlwZW9mIFdlYkFzc2VtYmx5Lmluc3RhbnRpYXRlU3RyZWFtaW5nIHx8IFAuc3RhcnRzV2l0aCgiZGF0YTphcHBsaWNhdGlvbi9vY3RldC1zdHJlYW07YmFzZTY0LCIpIHx8IFAuc3RhcnRzV2l0aCgiZmlsZTovLyIpIHx8IFlhIHx8ICJmdW5jdGlvbiIgIT0gdHlwZW9mIGZldGNoID8gYyhiKSA6IGZldGNoKFAsIHsgY3JlZGVudGlhbHM6ICJzYW1lLW9yaWdpbiIgfSkudGhlbihmdW5jdGlvbihnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gV2ViQXNzZW1ibHkuaW5zdGFudGlhdGVTdHJlYW1pbmcoZywgZCkudGhlbihiLCBmdW5jdGlvbih1MykgewogICAgICAgICAgICAgICAgICBkYSgid2FzbSBzdHJlYW1pbmcgY29tcGlsZSBmYWlsZWQ6ICIgKyB1Myk7CiAgICAgICAgICAgICAgICAgIGRhKCJmYWxsaW5nIGJhY2sgdG8gQXJyYXlCdWZmZXIgaW5zdGFudGlhdGlvbiIpOwogICAgICAgICAgICAgICAgICByZXR1cm4gYyhiKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KSgpLmNhdGNoKGthKTsKICAgICAgICAgICAgcmV0dXJuIHt9OwogICAgICAgICAgfSkoKTsKICAgICAgICAgIHZhciBiYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfVm9pZFB0cl9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoYmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1ZvaWRQdHJfX19kZXN0cm95X19fMCA9IGEzLmFzbS5rKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgRGEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJCdWZmZXJfRGVjb2RlckJ1ZmZlcl8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoRGEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJCdWZmZXJfRGVjb2RlckJ1ZmZlcl8wID0gYTMuYXNtLmwpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBjYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2RlckJ1ZmZlcl9Jbml0XzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChjYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2RlckJ1ZmZlcl9Jbml0XzIgPSBhMy5hc20ubSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGRiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyQnVmZmVyX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChkYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2RlckJ1ZmZlcl9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLm4pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBFYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlVHJhbnNmb3JtRGF0YV9BdHRyaWJ1dGVUcmFuc2Zvcm1EYXRhXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChFYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlVHJhbnNmb3JtRGF0YV9BdHRyaWJ1dGVUcmFuc2Zvcm1EYXRhXzAgPSBhMy5hc20ubykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGViID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVUcmFuc2Zvcm1EYXRhX3RyYW5zZm9ybV90eXBlXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChlYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlVHJhbnNmb3JtRGF0YV90cmFuc2Zvcm1fdHlwZV8wID0gYTMuYXNtLnApLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBmYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlVHJhbnNmb3JtRGF0YV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVRyYW5zZm9ybURhdGFfX19kZXN0cm95X19fMCA9IGEzLmFzbS5xKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgRmEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0dlb21ldHJ5QXR0cmlidXRlX0dlb21ldHJ5QXR0cmlidXRlXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChGYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfR2VvbWV0cnlBdHRyaWJ1dGVfR2VvbWV0cnlBdHRyaWJ1dGVfMCA9IGEzLmFzbS5yKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZ2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0dlb21ldHJ5QXR0cmlidXRlX19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChnYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfR2VvbWV0cnlBdHRyaWJ1dGVfX19kZXN0cm95X19fMCA9IGEzLmFzbS5zKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgR2EgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX1BvaW50QXR0cmlidXRlXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChHYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfUG9pbnRBdHRyaWJ1dGVfMCA9IGEzLmFzbS50KS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgaGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX3NpemVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGhiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9zaXplXzAgPSBhMy5hc20udSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGliID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9HZXRBdHRyaWJ1dGVUcmFuc2Zvcm1EYXRhXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChpYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfR2V0QXR0cmlidXRlVHJhbnNmb3JtRGF0YV8wID0gYTMuYXNtLnYpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBqYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfYXR0cmlidXRlX3R5cGVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGpiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9hdHRyaWJ1dGVfdHlwZV8wID0gYTMuYXNtLncpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBrYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfZGF0YV90eXBlXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChrYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfZGF0YV90eXBlXzAgPSBhMy5hc20ueCkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGxiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9udW1fY29tcG9uZW50c18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAobGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX251bV9jb21wb25lbnRzXzAgPSBhMy5hc20ueSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIG1iID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9ub3JtYWxpemVkXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChtYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfbm9ybWFsaXplZF8wID0gYTMuYXNtLnopLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBuYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfYnl0ZV9zdHJpZGVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKG5iID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9ieXRlX3N0cmlkZV8wID0gYTMuYXNtLkEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBvYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfYnl0ZV9vZmZzZXRfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKG9iID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9ieXRlX29mZnNldF8wID0gYTMuYXNtLkIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBwYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfdW5pcXVlX2lkXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChwYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfUG9pbnRBdHRyaWJ1dGVfdW5pcXVlX2lkXzAgPSBhMy5hc20uQykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHFiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludEF0dHJpYnV0ZV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAocWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50QXR0cmlidXRlX19fZGVzdHJveV9fXzAgPSBhMy5hc20uRCkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEhhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChIYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV8wID0gYTMuYXNtLkUpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCByYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX0luaXRGcm9tQXR0cmlidXRlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChyYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtX0luaXRGcm9tQXR0cmlidXRlXzEgPSBhMy5hc20uRikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHNiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fcXVhbnRpemF0aW9uX2JpdHNfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHNiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fcXVhbnRpemF0aW9uX2JpdHNfMCA9IGEzLmFzbS5HKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgdGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9taW5fdmFsdWVfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHRiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fbWluX3ZhbHVlXzEgPSBhMy5hc20uSCkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHViID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fcmFuZ2VfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHViID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVRdWFudGl6YXRpb25UcmFuc2Zvcm1fcmFuZ2VfMCA9IGEzLmFzbS5JKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgdmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAodmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLkopLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBJYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybV9BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChJYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybV9BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtXzAgPSBhMy5hc20uSykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHdiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtX0luaXRGcm9tQXR0cmlidXRlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh3YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybV9Jbml0RnJvbUF0dHJpYnV0ZV8xID0gYTMuYXNtLkwpLmFwcGx5KAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgYXJndW1lbnRzCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LCB4YiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybV9xdWFudGl6YXRpb25fYml0c18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoeGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm1fcXVhbnRpemF0aW9uX2JpdHNfMCA9IGEzLmFzbS5NKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgeWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0F0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm1fX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHliID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9BdHRyaWJ1dGVPY3RhaGVkcm9uVHJhbnNmb3JtX19fZGVzdHJveV9fXzAgPSBhMy5hc20uTikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEphID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludENsb3VkX1BvaW50Q2xvdWRfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEphID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludENsb3VkX1BvaW50Q2xvdWRfMCA9IGEzLmFzbS5PKS5hcHBseSgKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIGFyZ3VtZW50cwogICAgICAgICAgICApOwogICAgICAgICAgfSwgemIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50Q2xvdWRfbnVtX2F0dHJpYnV0ZXNfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHpiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludENsb3VkX251bV9hdHRyaWJ1dGVzXzAgPSBhMy5hc20uUCkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEFiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludENsb3VkX251bV9wb2ludHNfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEFiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludENsb3VkX251bV9wb2ludHNfMCA9IGEzLmFzbS5RKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgQmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1BvaW50Q2xvdWRfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEJiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9Qb2ludENsb3VkX19fZGVzdHJveV9fXzAgPSBhMy5hc20uUikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEthID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXNoX01lc2hfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEthID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXNoX01lc2hfMCA9IGEzLmFzbS5TKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgQ2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01lc2hfbnVtX2ZhY2VzXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChDYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWVzaF9udW1fZmFjZXNfMCA9IGEzLmFzbS5UKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgRGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01lc2hfbnVtX2F0dHJpYnV0ZXNfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKERiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXNoX251bV9hdHRyaWJ1dGVzXzAgPSBhMy5hc20uVSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEViID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXNoX251bV9wb2ludHNfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEViID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXNoX251bV9wb2ludHNfMCA9IGEzLmFzbS5WKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgRmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01lc2hfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEZiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXNoX19fZGVzdHJveV9fXzAgPSBhMy5hc20uVykuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIExhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YV9NZXRhZGF0YV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoTGEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhX01ldGFkYXRhXzAgPSBhMy5hc20uWCkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEdiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoR2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhX19fZGVzdHJveV9fXzAgPSBhMy5hc20uWSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEhiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9TdGF0dXNfY29kZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoSGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1N0YXR1c19jb2RlXzAgPSBhMy5hc20uWikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEliID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9TdGF0dXNfb2tfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEliID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9TdGF0dXNfb2tfMCA9IGEzLmFzbS5fKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgSmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX1N0YXR1c19lcnJvcl9tc2dfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEpiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9TdGF0dXNfZXJyb3JfbXNnXzAgPSBhMy5hc20uJCkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEtiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9TdGF0dXNfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEtiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9TdGF0dXNfX19kZXN0cm95X19fMCA9IGEzLmFzbS5hYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIE1hID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0Zsb2F0MzJBcnJheV9EcmFjb0Zsb2F0MzJBcnJheV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoTWEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvRmxvYXQzMkFycmF5X0RyYWNvRmxvYXQzMkFycmF5XzAgPSBhMy5hc20uYmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBMYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29GbG9hdDMyQXJyYXlfR2V0VmFsdWVfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKExiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0Zsb2F0MzJBcnJheV9HZXRWYWx1ZV8xID0gYTMuYXNtLmNhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgTWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvRmxvYXQzMkFycmF5X3NpemVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKE1iID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0Zsb2F0MzJBcnJheV9zaXplXzAgPSBhMy5hc20uZGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBOYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29GbG9hdDMyQXJyYXlfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKE5iID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0Zsb2F0MzJBcnJheV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLmVhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgTmEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50OEFycmF5X0RyYWNvSW50OEFycmF5XzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChOYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQ4QXJyYXlfRHJhY29JbnQ4QXJyYXlfMCA9IGEzLmFzbS5mYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIE9iID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDhBcnJheV9HZXRWYWx1ZV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoT2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50OEFycmF5X0dldFZhbHVlXzEgPSBhMy5hc20uZ2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBQYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQ4QXJyYXlfc2l6ZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoUGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50OEFycmF5X3NpemVfMCA9IGEzLmFzbS5oYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFFiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDhBcnJheV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoUWIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50OEFycmF5X19fZGVzdHJveV9fXzAgPSBhMy5hc20uaWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBPYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50OEFycmF5X0RyYWNvVUludDhBcnJheV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoT2EgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDhBcnJheV9EcmFjb1VJbnQ4QXJyYXlfMCA9IGEzLmFzbS5qYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFJiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQ4QXJyYXlfR2V0VmFsdWVfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFJiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQ4QXJyYXlfR2V0VmFsdWVfMSA9IGEzLmFzbS5rYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFNiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQ4QXJyYXlfc2l6ZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoU2IgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDhBcnJheV9zaXplXzAgPSBhMy5hc20ubGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBUYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50OEFycmF5X19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChUYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50OEFycmF5X19fZGVzdHJveV9fXzAgPSBhMy5hc20ubWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBQYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQxNkFycmF5X0RyYWNvSW50MTZBcnJheV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoUGEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MTZBcnJheV9EcmFjb0ludDE2QXJyYXlfMCA9IGEzLmFzbS5uYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFViID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDE2QXJyYXlfR2V0VmFsdWVfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFViID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDE2QXJyYXlfR2V0VmFsdWVfMSA9IGEzLmFzbS5vYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFZiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDE2QXJyYXlfc2l6ZV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoVmIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MTZBcnJheV9zaXplXzAgPSBhMy5hc20ucGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBXYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQxNkFycmF5X19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChXYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQxNkFycmF5X19fZGVzdHJveV9fXzAgPSBhMy5hc20ucWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBRYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MTZBcnJheV9EcmFjb1VJbnQxNkFycmF5XzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChRYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MTZBcnJheV9EcmFjb1VJbnQxNkFycmF5XzAgPSBhMy5hc20ucmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBYYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MTZBcnJheV9HZXRWYWx1ZV8xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoWGIgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDE2QXJyYXlfR2V0VmFsdWVfMSA9IGEzLmFzbS5zYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFliID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQxNkFycmF5X3NpemVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFliID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQxNkFycmF5X3NpemVfMCA9IGEzLmFzbS50YSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFpiID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQxNkFycmF5X19fZGVzdHJveV9fXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChaYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MTZBcnJheV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLnVhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgUmEgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MzJBcnJheV9EcmFjb0ludDMyQXJyYXlfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFJhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDMyQXJyYXlfRHJhY29JbnQzMkFycmF5XzAgPSBhMy5hc20udmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCAkYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQzMkFycmF5X0dldFZhbHVlXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICgkYiA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQzMkFycmF5X0dldFZhbHVlXzEgPSBhMy5hc20ud2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBhYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29JbnQzMkFycmF5X3NpemVfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGFjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb0ludDMyQXJyYXlfc2l6ZV8wID0gYTMuYXNtLnhhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgYmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MzJBcnJheV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoYmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvSW50MzJBcnJheV9fX2Rlc3Ryb3lfX18wID0gYTMuYXNtLnlhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgU2EgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDMyQXJyYXlfRHJhY29VSW50MzJBcnJheV8wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoU2EgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDMyQXJyYXlfRHJhY29VSW50MzJBcnJheV8wID0gYTMuYXNtLnphKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgY2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDMyQXJyYXlfR2V0VmFsdWVfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGNjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EcmFjb1VJbnQzMkFycmF5X0dldFZhbHVlXzEgPSBhMy5hc20uQWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBkYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MzJBcnJheV9zaXplXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChkYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MzJBcnJheV9zaXplXzAgPSBhMy5hc20uQmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBlYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRHJhY29VSW50MzJBcnJheV9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RyYWNvVUludDMyQXJyYXlfX19kZXN0cm95X19fMCA9IGEzLmFzbS5DYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFRhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfTWV0YWRhdGFRdWVyaWVyXzAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChUYSA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX01ldGFkYXRhUXVlcmllcl8wID0gYTMuYXNtLkRhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9IYXNFbnRyeV8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9IYXNFbnRyeV8yID0gYTMuYXNtLkVhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZ2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9HZXRJbnRFbnRyeV8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZ2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9HZXRJbnRFbnRyeV8yID0gYTMuYXNtLkZhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgaGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9HZXRJbnRFbnRyeUFycmF5XzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChoYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0dldEludEVudHJ5QXJyYXlfMyA9IGEzLmFzbS5HYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGljID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfR2V0RG91YmxlRW50cnlfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGljID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfR2V0RG91YmxlRW50cnlfMiA9IGEzLmFzbS5IYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGpjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfR2V0U3RyaW5nRW50cnlfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGpjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfR2V0U3RyaW5nRW50cnlfMiA9IGEzLmFzbS5JYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGtjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfTnVtRW50cmllc18xID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoa2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9OdW1FbnRyaWVzXzEgPSBhMy5hc20uSmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBsYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfTWV0YWRhdGFRdWVyaWVyX0dldEVudHJ5TmFtZV8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAobGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX01ldGFkYXRhUXVlcmllcl9HZXRFbnRyeU5hbWVfMiA9IGEzLmFzbS5LYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIG1jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfX19kZXN0cm95X19fMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKG1jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9NZXRhZGF0YVF1ZXJpZXJfX19kZXN0cm95X19fMCA9IGEzLmFzbS5MYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFVhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0RlY29kZXJfMCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFVhID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0RlY29kZXJfMCA9IGEzLmFzbS5NYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIG5jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0RlY29kZUFycmF5VG9Qb2ludENsb3VkXzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChuYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVBcnJheVRvUG9pbnRDbG91ZF8zID0gYTMuYXNtLk5hKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgb2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfRGVjb2RlQXJyYXlUb01lc2hfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKG9jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0RlY29kZUFycmF5VG9NZXNoXzMgPSBhMy5hc20uT2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBwYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJZF8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAocGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSWRfMiA9IGEzLmFzbS5QYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHFjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUlkQnlOYW1lXzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChxYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJZEJ5TmFtZV8yID0gYTMuYXNtLlFhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgcmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSWRCeU1ldGFkYXRhRW50cnlfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHJjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUlkQnlNZXRhZGF0YUVudHJ5XzMgPSBhMy5hc20uUmEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBzYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVfMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHNjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZV8yID0gYTMuYXNtLlNhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgdGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlQnlVbmlxdWVJZF8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAodGMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlQnlVbmlxdWVJZF8yID0gYTMuYXNtLlRhKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgdWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0TWV0YWRhdGFfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHVjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldE1ldGFkYXRhXzEgPSBhMy5hc20uVWEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB2YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVNZXRhZGF0YV8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAodmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlTWV0YWRhdGFfMiA9IGEzLmFzbS5WYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHdjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEZhY2VGcm9tTWVzaF8zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAod2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0RmFjZUZyb21NZXNoXzMgPSBhMy5hc20uV2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB4YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRUcmlhbmdsZVN0cmlwc0Zyb21NZXNoXzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh4YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRUcmlhbmdsZVN0cmlwc0Zyb21NZXNoXzIgPSBhMy5hc20uWGEpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCB5YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRUcmlhbmdsZXNVSW50MTZBcnJheV8zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoeWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0VHJpYW5nbGVzVUludDE2QXJyYXlfMyA9IGEzLmFzbS5ZYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHpjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldFRyaWFuZ2xlc1VJbnQzMkFycmF5XzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICh6YyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRUcmlhbmdsZXNVSW50MzJBcnJheV8zID0gYTMuYXNtLlphKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgQWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlRmxvYXRfMyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKEFjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUZsb2F0XzMgPSBhMy5hc20uX2EpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBCYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVGbG9hdEZvckFsbFBvaW50c18zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoQmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlRmxvYXRGb3JBbGxQb2ludHNfMyA9IGEzLmFzbS4kYSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIENjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUludEZvckFsbFBvaW50c18zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoQ2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlSW50Rm9yQWxsUG9pbnRzXzMgPSBhMy5hc20uYWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBEYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJbnQ4Rm9yQWxsUG9pbnRzXzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChEYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJbnQ4Rm9yQWxsUG9pbnRzXzMgPSBhMy5hc20uYmIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBFYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVVSW50OEZvckFsbFBvaW50c18zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoRWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlVUludDhGb3JBbGxQb2ludHNfMyA9IGEzLmFzbS5jYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEZjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUludDE2Rm9yQWxsUG9pbnRzXzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChGYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJbnQxNkZvckFsbFBvaW50c18zID0gYTMuYXNtLmRiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgR2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlVUludDE2Rm9yQWxsUG9pbnRzXzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChHYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVVSW50MTZGb3JBbGxQb2ludHNfMyA9IGEzLmFzbS5lYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEhjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZUludDMyRm9yQWxsUG9pbnRzXzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChIYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVJbnQzMkZvckFsbFBvaW50c18zID0gYTMuYXNtLmZiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgSWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlVUludDMyRm9yQWxsUG9pbnRzXzMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChJYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRBdHRyaWJ1dGVVSW50MzJGb3JBbGxQb2ludHNfMyA9IGEzLmFzbS5nYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIEpjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEF0dHJpYnV0ZURhdGFBcnJheUZvckFsbFBvaW50c181ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoSmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfR2V0QXR0cmlidXRlRGF0YUFycmF5Rm9yQWxsUG9pbnRzXzUgPSBhMy5hc20uaGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBLYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9Ta2lwQXR0cmlidXRlVHJhbnNmb3JtXzEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChLYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9Ta2lwQXR0cmlidXRlVHJhbnNmb3JtXzEgPSBhMy5hc20uaWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBMYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9HZXRFbmNvZGVkR2VvbWV0cnlUeXBlX0RlcHJlY2F0ZWRfMSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKExjID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0dldEVuY29kZWRHZW9tZXRyeVR5cGVfRGVwcmVjYXRlZF8xID0gYTMuYXNtLmpiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgTWMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfRGVjb2RlQnVmZmVyVG9Qb2ludENsb3VkXzIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChNYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9EZWNvZGVCdWZmZXJUb1BvaW50Q2xvdWRfMiA9IGEzLmFzbS5rYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIE5jID0gYTMuX2Vtc2NyaXB0ZW5fYmluZF9EZWNvZGVyX0RlY29kZUJ1ZmZlclRvTWVzaF8yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoTmMgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfRGVjb2RlQnVmZmVyVG9NZXNoXzIgPSBhMy5hc20ubGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBPYyA9IGEzLl9lbXNjcmlwdGVuX2JpbmRfRGVjb2Rlcl9fX2Rlc3Ryb3lfX18wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoT2MgPSBhMy5fZW1zY3JpcHRlbl9iaW5kX0RlY29kZXJfX19kZXN0cm95X19fMCA9IGEzLmFzbS5tYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFBjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19BdHRyaWJ1dGVUcmFuc2Zvcm1UeXBlX0FUVFJJQlVURV9JTlZBTElEX1RSQU5TRk9STSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFBjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19BdHRyaWJ1dGVUcmFuc2Zvcm1UeXBlX0FUVFJJQlVURV9JTlZBTElEX1RSQU5TRk9STSA9IGEzLmFzbS5uYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFFjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19BdHRyaWJ1dGVUcmFuc2Zvcm1UeXBlX0FUVFJJQlVURV9OT19UUkFOU0ZPUk0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChRYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fQXR0cmlidXRlVHJhbnNmb3JtVHlwZV9BVFRSSUJVVEVfTk9fVFJBTlNGT1JNID0gYTMuYXNtLm9iKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgUmMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0F0dHJpYnV0ZVRyYW5zZm9ybVR5cGVfQVRUUklCVVRFX1FVQU5USVpBVElPTl9UUkFOU0ZPUk0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChSYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fQXR0cmlidXRlVHJhbnNmb3JtVHlwZV9BVFRSSUJVVEVfUVVBTlRJWkFUSU9OX1RSQU5TRk9STSA9IGEzLmFzbS5wYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFNjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19BdHRyaWJ1dGVUcmFuc2Zvcm1UeXBlX0FUVFJJQlVURV9PQ1RBSEVEUk9OX1RSQU5TRk9STSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFNjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19BdHRyaWJ1dGVUcmFuc2Zvcm1UeXBlX0FUVFJJQlVURV9PQ1RBSEVEUk9OX1RSQU5TRk9STSA9IGEzLmFzbS5xYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFRjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX0lOVkFMSUQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChUYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9JTlZBTElEID0gYTMuYXNtLnJiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgVWMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfUE9TSVRJT04gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChVYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9QT1NJVElPTiA9IGEzLmFzbS5zYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFZjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX05PUk1BTCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFZjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX05PUk1BTCA9IGEzLmFzbS50YikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFdjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19HZW9tZXRyeUF0dHJpYnV0ZV9UeXBlX0NPTE9SID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoV2MgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfQ09MT1IgPSBhMy5hc20udWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBYYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9URVhfQ09PUkQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChYYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9URVhfQ09PUkQgPSBhMy5hc20udmIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBZYyA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fR2VvbWV0cnlBdHRyaWJ1dGVfVHlwZV9HRU5FUklDID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoWWMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0dlb21ldHJ5QXR0cmlidXRlX1R5cGVfR0VORVJJQyA9IGEzLmFzbS53YikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIFpjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19FbmNvZGVkR2VvbWV0cnlUeXBlX0lOVkFMSURfR0VPTUVUUllfVFlQRSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKFpjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19FbmNvZGVkR2VvbWV0cnlUeXBlX0lOVkFMSURfR0VPTUVUUllfVFlQRSA9IGEzLmFzbS54YikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sICRjID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19FbmNvZGVkR2VvbWV0cnlUeXBlX1BPSU5UX0NMT1VEID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoJGMgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0VuY29kZWRHZW9tZXRyeVR5cGVfUE9JTlRfQ0xPVUQgPSBhMy5hc20ueWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBhZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRW5jb2RlZEdlb21ldHJ5VHlwZV9UUklBTkdVTEFSX01FU0ggPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChhZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRW5jb2RlZEdlb21ldHJ5VHlwZV9UUklBTkdVTEFSX01FU0ggPSBhMy5hc20uemIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBiZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfSU5WQUxJRCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGJkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9JTlZBTElEID0gYTMuYXNtLkFiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgY2QgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0lOVDggPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChjZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfSU5UOCA9IGEzLmFzbS5CYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGRkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9VSU5UOCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGRkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9VSU5UOCA9IGEzLmFzbS5DYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGVkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9JTlQxNiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGVkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9JTlQxNiA9IGEzLmFzbS5EYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGZkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9VSU5UMTYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChmZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVUlOVDE2ID0gYTMuYXNtLkViKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZ2QgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0lOVDMyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoZ2QgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0lOVDMyID0gYTMuYXNtLkZiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgaGQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX1VJTlQzMiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGhkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9VSU5UMzIgPSBhMy5hc20uR2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBpZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfSU5UNjQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChpZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfSU5UNjQgPSBhMy5hc20uSGIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBqZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfVUlOVDY0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoamQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX1VJTlQ2NCA9IGEzLmFzbS5JYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGtkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9GTE9BVDMyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoa2QgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0ZMT0FUMzIgPSBhMy5hc20uSmIpLmFwcGx5KAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgYXJndW1lbnRzCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LCBsZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfRkxPQVQ2NCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGxkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9GTE9BVDY0ID0gYTMuYXNtLktiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgbWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX0RhdGFUeXBlX0RUX0JPT0wgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChtZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fRGF0YVR5cGVfRFRfQk9PTCA9IGEzLmFzbS5MYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIG5kID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9UWVBFU19DT1VOVCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKG5kID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19EYXRhVHlwZV9EVF9UWVBFU19DT1VOVCA9IGEzLmFzbS5NYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIG9kID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX09LID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAob2QgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfT0sgPSBhMy5hc20uTmIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBwZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9EUkFDT19FUlJPUiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHBkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX0RSQUNPX0VSUk9SID0gYTMuYXNtLk9iKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgcWQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfSU9fRVJST1IgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChxZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9JT19FUlJPUiA9IGEzLmFzbS5QYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHJkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX0lOVkFMSURfUEFSQU1FVEVSID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAocmQgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfSU5WQUxJRF9QQVJBTUVURVIgPSBhMy5hc20uUWIpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9LCBzZCA9IGEzLl9lbXNjcmlwdGVuX2VudW1fZHJhY29fU3RhdHVzQ29kZV9VTlNVUFBPUlRFRF9WRVJTSU9OID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoc2QgPSBhMy5fZW1zY3JpcHRlbl9lbnVtX2RyYWNvX1N0YXR1c0NvZGVfVU5TVVBQT1JURURfVkVSU0lPTiA9IGEzLmFzbS5SYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIHRkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX1VOS05PV05fVkVSU0lPTiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHRkID0gYTMuX2Vtc2NyaXB0ZW5fZW51bV9kcmFjb19TdGF0dXNDb2RlX1VOS05PV05fVkVSU0lPTiA9IGEzLmFzbS5TYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICBhMy5fbWFsbG9jID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoYTMuX21hbGxvYyA9IGEzLmFzbS5UYikuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICBhMy5fZnJlZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKGEzLl9mcmVlID0gYTMuYXNtLlViKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB5YSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKHlhID0gYTMuYXNtLlZiKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfTsKICAgICAgICAgIGEzLl9fX3N0YXJ0X2VtX2pzID0gMTU4NTY7CiAgICAgICAgICBhMy5fX19zdG9wX2VtX2pzID0gMTU5NTQ7CiAgICAgICAgICB2YXIgbGE7CiAgICAgICAgICBpYSA9IGZ1bmN0aW9uIGIoKSB7CiAgICAgICAgICAgIGxhIHx8IGJhKCk7CiAgICAgICAgICAgIGxhIHx8IChpYSA9IGIpOwogICAgICAgICAgfTsKICAgICAgICAgIGlmIChhMy5wcmVJbml0KSBmb3IgKCJmdW5jdGlvbiIgPT0gdHlwZW9mIGEzLnByZUluaXQgJiYgKGEzLnByZUluaXQgPSBbYTMucHJlSW5pdF0pOyAwIDwgYTMucHJlSW5pdC5sZW5ndGg7ICkgYTMucHJlSW5pdC5wb3AoKSgpOwogICAgICAgICAgYmEoKTsKICAgICAgICAgIHQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICB0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHQ7CiAgICAgICAgICB0LnByb3RvdHlwZS5fX2NsYXNzX18gPSB0OwogICAgICAgICAgdC5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLldyYXBwZXJPYmplY3QgPSB0OwogICAgICAgICAgYTMuZ2V0Q2FjaGUgPSB4OwogICAgICAgICAgYTMud3JhcFBvaW50ZXIgPSBEOwogICAgICAgICAgYTMuY2FzdE9iamVjdCA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgcmV0dXJuIEQoYi5wdHIsIGMpOwogICAgICAgICAgfTsKICAgICAgICAgIGEzLk5VTEwgPSBEKDApOwogICAgICAgICAgYTMuZGVzdHJveSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgaWYgKCFiLl9fZGVzdHJveV9fKSB0aHJvdyAiRXJyb3I6IENhbm5vdCBkZXN0cm95IG9iamVjdC4gKERpZCB5b3UgY3JlYXRlIGl0IHlvdXJzZWxmPykiOwogICAgICAgICAgICBiLl9fZGVzdHJveV9fKCk7CiAgICAgICAgICAgIGRlbGV0ZSB4KGIuX19jbGFzc19fKVtiLnB0cl07CiAgICAgICAgICB9OwogICAgICAgICAgYTMuY29tcGFyZSA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgcmV0dXJuIGIucHRyID09PSBjLnB0cjsKICAgICAgICAgIH07CiAgICAgICAgICBhMy5nZXRQb2ludGVyID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICByZXR1cm4gYi5wdHI7CiAgICAgICAgICB9OwogICAgICAgICAgYTMuZ2V0Q2xhc3MgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHJldHVybiBiLl9fY2xhc3NfXzsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgciA9IHsgYnVmZmVyOiAwLCBzaXplOiAwLCBwb3M6IDAsIHRlbXBzOiBbXSwgbmVlZGVkOiAwLCBwcmVwYXJlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHIubmVlZGVkKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgYiA9IDA7IGIgPCByLnRlbXBzLmxlbmd0aDsgYisrKSBhMy5fZnJlZShyLnRlbXBzW2JdKTsKICAgICAgICAgICAgICByLnRlbXBzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgYTMuX2ZyZWUoci5idWZmZXIpOwogICAgICAgICAgICAgIHIuYnVmZmVyID0gMDsKICAgICAgICAgICAgICByLnNpemUgKz0gci5uZWVkZWQ7CiAgICAgICAgICAgICAgci5uZWVkZWQgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHIuYnVmZmVyIHx8IChyLnNpemUgKz0gMTI4LCByLmJ1ZmZlciA9IGEzLl9tYWxsb2Moci5zaXplKSwgci5idWZmZXIgfHwgZih2b2lkIDApKTsKICAgICAgICAgICAgci5wb3MgPSAwOwogICAgICAgICAgfSwgYWxsb2M6IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgci5idWZmZXIgfHwgZih2b2lkIDApOwogICAgICAgICAgICBiID0gYi5sZW5ndGggKiBjLkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICAgICAgICBiID0gYiArIDcgJiAtODsKICAgICAgICAgICAgci5wb3MgKyBiID49IHIuc2l6ZSA/ICgwIDwgYiB8fCBmKHZvaWQgMCksIHIubmVlZGVkICs9IGIsIGMgPSBhMy5fbWFsbG9jKGIpLCByLnRlbXBzLnB1c2goYykpIDogKGMgPSByLmJ1ZmZlciArIHIucG9zLCByLnBvcyArPSBiKTsKICAgICAgICAgICAgcmV0dXJuIGM7CiAgICAgICAgICB9LCBjb3B5OiBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIGQgPj4+PSAwOwogICAgICAgICAgICBzd2l0Y2ggKGMuQllURVNfUEVSX0VMRU1FTlQpIHsKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBkID4+Pj0gMTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgIGQgPj4+PSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgZCA+Pj49IDM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgZyA9IDA7IGcgPCBiLmxlbmd0aDsgZysrKSBjW2QgKyBnXSA9IGJbZ107CiAgICAgICAgICB9IH07CiAgICAgICAgICBaLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgWi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBaOwogICAgICAgICAgWi5wcm90b3R5cGUuX19jbGFzc19fID0gWjsKICAgICAgICAgIFouX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5Wb2lkUHRyID0gWjsKICAgICAgICAgIFoucHJvdG90eXBlLl9fZGVzdHJveV9fID0gWi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgYmIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIFMucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBTLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFM7CiAgICAgICAgICBTLnByb3RvdHlwZS5fX2NsYXNzX18gPSBTOwogICAgICAgICAgUy5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRlY29kZXJCdWZmZXIgPSBTOwogICAgICAgICAgUy5wcm90b3R5cGUuSW5pdCA9IFMucHJvdG90eXBlLkluaXQgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIHIucHJlcGFyZSgpOwogICAgICAgICAgICAib2JqZWN0IiA9PSB0eXBlb2YgYiAmJiAoYiA9IHBhKGIpKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGNiKGQsIGIsIGMpOwogICAgICAgICAgfTsKICAgICAgICAgIFMucHJvdG90eXBlLl9fZGVzdHJveV9fID0gUy5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZGIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIFEucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBRLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFE7CiAgICAgICAgICBRLnByb3RvdHlwZS5fX2NsYXNzX18gPSBROwogICAgICAgICAgUS5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkF0dHJpYnV0ZVRyYW5zZm9ybURhdGEgPSBROwogICAgICAgICAgUS5wcm90b3R5cGUudHJhbnNmb3JtX3R5cGUgPSBRLnByb3RvdHlwZS50cmFuc2Zvcm1fdHlwZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIFEucHJvdG90eXBlLl9fZGVzdHJveV9fID0gUS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZmIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIFcucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBXLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFc7CiAgICAgICAgICBXLnByb3RvdHlwZS5fX2NsYXNzX18gPSBXOwogICAgICAgICAgVy5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkdlb21ldHJ5QXR0cmlidXRlID0gVzsKICAgICAgICAgIFcucHJvdG90eXBlLl9fZGVzdHJveV9fID0gVy5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZ2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIHcucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICB3LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHc7CiAgICAgICAgICB3LnByb3RvdHlwZS5fX2NsYXNzX18gPSB3OwogICAgICAgICAgdy5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLlBvaW50QXR0cmlidXRlID0gdzsKICAgICAgICAgIHcucHJvdG90eXBlLnNpemUgPSB3LnByb3RvdHlwZS5zaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBoYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUuR2V0QXR0cmlidXRlVHJhbnNmb3JtRGF0YSA9IHcucHJvdG90eXBlLkdldEF0dHJpYnV0ZVRyYW5zZm9ybURhdGEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEQoaWIodGhpcy5wdHIpLCBRKTsKICAgICAgICAgIH07CiAgICAgICAgICB3LnByb3RvdHlwZS5hdHRyaWJ1dGVfdHlwZSA9IHcucHJvdG90eXBlLmF0dHJpYnV0ZV90eXBlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBqYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUuZGF0YV90eXBlID0gdy5wcm90b3R5cGUuZGF0YV90eXBlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBrYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUubnVtX2NvbXBvbmVudHMgPSB3LnByb3RvdHlwZS5udW1fY29tcG9uZW50cyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gbGIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIHcucHJvdG90eXBlLm5vcm1hbGl6ZWQgPSB3LnByb3RvdHlwZS5ub3JtYWxpemVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAhIW1iKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICB3LnByb3RvdHlwZS5ieXRlX3N0cmlkZSA9IHcucHJvdG90eXBlLmJ5dGVfc3RyaWRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBuYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgdy5wcm90b3R5cGUuYnl0ZV9vZmZzZXQgPSB3LnByb3RvdHlwZS5ieXRlX29mZnNldCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gb2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIHcucHJvdG90eXBlLnVuaXF1ZV9pZCA9IHcucHJvdG90eXBlLnVuaXF1ZV9pZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gcGIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIHcucHJvdG90eXBlLl9fZGVzdHJveV9fID0gdy5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEMucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBDLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEM7CiAgICAgICAgICBDLnByb3RvdHlwZS5fX2NsYXNzX18gPSBDOwogICAgICAgICAgQy5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkF0dHJpYnV0ZVF1YW50aXphdGlvblRyYW5zZm9ybSA9IEM7CiAgICAgICAgICBDLnByb3RvdHlwZS5Jbml0RnJvbUF0dHJpYnV0ZSA9IEMucHJvdG90eXBlLkluaXRGcm9tQXR0cmlidXRlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhcmIoYywgYik7CiAgICAgICAgICB9OwogICAgICAgICAgQy5wcm90b3R5cGUucXVhbnRpemF0aW9uX2JpdHMgPSBDLnByb3RvdHlwZS5xdWFudGl6YXRpb25fYml0cyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gc2IodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEMucHJvdG90eXBlLm1pbl92YWx1ZSA9IEMucHJvdG90eXBlLm1pbl92YWx1ZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiB0YihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBDLnByb3RvdHlwZS5yYW5nZSA9IEMucHJvdG90eXBlLnJhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB1Yih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgQy5wcm90b3R5cGUuX19kZXN0cm95X18gPSBDLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2Yih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgRi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIEYucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRjsKICAgICAgICAgIEYucHJvdG90eXBlLl9fY2xhc3NfXyA9IEY7CiAgICAgICAgICBGLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuQXR0cmlidXRlT2N0YWhlZHJvblRyYW5zZm9ybSA9IEY7CiAgICAgICAgICBGLnByb3RvdHlwZS5Jbml0RnJvbUF0dHJpYnV0ZSA9IEYucHJvdG90eXBlLkluaXRGcm9tQXR0cmlidXRlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhd2IoYywgYik7CiAgICAgICAgICB9OwogICAgICAgICAgRi5wcm90b3R5cGUucXVhbnRpemF0aW9uX2JpdHMgPSBGLnByb3RvdHlwZS5xdWFudGl6YXRpb25fYml0cyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4geGIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEYucHJvdG90eXBlLl9fZGVzdHJveV9fID0gRi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgeWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEcucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBHLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEc7CiAgICAgICAgICBHLnByb3RvdHlwZS5fX2NsYXNzX18gPSBHOwogICAgICAgICAgRy5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLlBvaW50Q2xvdWQgPSBHOwogICAgICAgICAgRy5wcm90b3R5cGUubnVtX2F0dHJpYnV0ZXMgPSBHLnByb3RvdHlwZS5udW1fYXR0cmlidXRlcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gemIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEcucHJvdG90eXBlLm51bV9wb2ludHMgPSBHLnByb3RvdHlwZS5udW1fcG9pbnRzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBBYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgRy5wcm90b3R5cGUuX19kZXN0cm95X18gPSBHLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBCYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgRS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIEUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRTsKICAgICAgICAgIEUucHJvdG90eXBlLl9fY2xhc3NfXyA9IEU7CiAgICAgICAgICBFLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuTWVzaCA9IEU7CiAgICAgICAgICBFLnByb3RvdHlwZS5udW1fZmFjZXMgPSBFLnByb3RvdHlwZS5udW1fZmFjZXMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIENiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBFLnByb3RvdHlwZS5udW1fYXR0cmlidXRlcyA9IEUucHJvdG90eXBlLm51bV9hdHRyaWJ1dGVzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBEYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgRS5wcm90b3R5cGUubnVtX3BvaW50cyA9IEUucHJvdG90eXBlLm51bV9wb2ludHMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEViKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBFLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEUucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIEZiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBULnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgVC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBUOwogICAgICAgICAgVC5wcm90b3R5cGUuX19jbGFzc19fID0gVDsKICAgICAgICAgIFQuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5NZXRhZGF0YSA9IFQ7CiAgICAgICAgICBULnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IFQucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIEdiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBCLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgQi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBCOwogICAgICAgICAgQi5wcm90b3R5cGUuX19jbGFzc19fID0gQjsKICAgICAgICAgIEIuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5TdGF0dXMgPSBCOwogICAgICAgICAgQi5wcm90b3R5cGUuY29kZSA9IEIucHJvdG90eXBlLmNvZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIEhiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBCLnByb3RvdHlwZS5vayA9IEIucHJvdG90eXBlLm9rID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAhIUliKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBCLnByb3RvdHlwZS5lcnJvcl9tc2cgPSBCLnByb3RvdHlwZS5lcnJvcl9tc2cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGgoSmIodGhpcy5wdHIpKTsKICAgICAgICAgIH07CiAgICAgICAgICBCLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEIucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIEtiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBILnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgSC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBIOwogICAgICAgICAgSC5wcm90b3R5cGUuX19jbGFzc19fID0gSDsKICAgICAgICAgIEguX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5EcmFjb0Zsb2F0MzJBcnJheSA9IEg7CiAgICAgICAgICBILnByb3RvdHlwZS5HZXRWYWx1ZSA9IEgucHJvdG90eXBlLkdldFZhbHVlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuIExiKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIEgucHJvdG90eXBlLnNpemUgPSBILnByb3RvdHlwZS5zaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBNYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgSC5wcm90b3R5cGUuX19kZXN0cm95X18gPSBILnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBOYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgSS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIEkucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gSTsKICAgICAgICAgIEkucHJvdG90eXBlLl9fY2xhc3NfXyA9IEk7CiAgICAgICAgICBJLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuRHJhY29JbnQ4QXJyYXkgPSBJOwogICAgICAgICAgSS5wcm90b3R5cGUuR2V0VmFsdWUgPSBJLnByb3RvdHlwZS5HZXRWYWx1ZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiBPYihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBJLnByb3RvdHlwZS5zaXplID0gSS5wcm90b3R5cGUuc2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gUGIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEkucHJvdG90eXBlLl9fZGVzdHJveV9fID0gSS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgUWIodGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIEoucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBKLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEo7CiAgICAgICAgICBKLnByb3RvdHlwZS5fX2NsYXNzX18gPSBKOwogICAgICAgICAgSi5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRyYWNvVUludDhBcnJheSA9IEo7CiAgICAgICAgICBKLnByb3RvdHlwZS5HZXRWYWx1ZSA9IEoucHJvdG90eXBlLkdldFZhbHVlID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuIFJiKGMsIGIpOwogICAgICAgICAgfTsKICAgICAgICAgIEoucHJvdG90eXBlLnNpemUgPSBKLnByb3RvdHlwZS5zaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBTYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgSi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBKLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBUYih0aGlzLnB0cik7CiAgICAgICAgICB9OwogICAgICAgICAgSy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHQucHJvdG90eXBlKTsKICAgICAgICAgIEsucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gSzsKICAgICAgICAgIEsucHJvdG90eXBlLl9fY2xhc3NfXyA9IEs7CiAgICAgICAgICBLLl9fY2FjaGVfXyA9IHt9OwogICAgICAgICAgYTMuRHJhY29JbnQxNkFycmF5ID0gSzsKICAgICAgICAgIEsucHJvdG90eXBlLkdldFZhbHVlID0gSy5wcm90b3R5cGUuR2V0VmFsdWUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gVWIoYywgYik7CiAgICAgICAgICB9OwogICAgICAgICAgSy5wcm90b3R5cGUuc2l6ZSA9IEsucHJvdG90eXBlLnNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIFZiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBLLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEsucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIFdiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBMLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgTC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBMOwogICAgICAgICAgTC5wcm90b3R5cGUuX19jbGFzc19fID0gTDsKICAgICAgICAgIEwuX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5EcmFjb1VJbnQxNkFycmF5ID0gTDsKICAgICAgICAgIEwucHJvdG90eXBlLkdldFZhbHVlID0gTC5wcm90b3R5cGUuR2V0VmFsdWUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gWGIoYywgYik7CiAgICAgICAgICB9OwogICAgICAgICAgTC5wcm90b3R5cGUuc2l6ZSA9IEwucHJvdG90eXBlLnNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIFliKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBMLnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IEwucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIFpiKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBNLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgTS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBNOwogICAgICAgICAgTS5wcm90b3R5cGUuX19jbGFzc19fID0gTTsKICAgICAgICAgIE0uX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5EcmFjb0ludDMyQXJyYXkgPSBNOwogICAgICAgICAgTS5wcm90b3R5cGUuR2V0VmFsdWUgPSBNLnByb3RvdHlwZS5HZXRWYWx1ZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiAkYihjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBNLnByb3RvdHlwZS5zaXplID0gTS5wcm90b3R5cGUuc2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gYWModGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIE0ucHJvdG90eXBlLl9fZGVzdHJveV9fID0gTS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgYmModGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIE4ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICBOLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IE47CiAgICAgICAgICBOLnByb3RvdHlwZS5fX2NsYXNzX18gPSBOOwogICAgICAgICAgTi5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLkRyYWNvVUludDMyQXJyYXkgPSBOOwogICAgICAgICAgTi5wcm90b3R5cGUuR2V0VmFsdWUgPSBOLnByb3RvdHlwZS5HZXRWYWx1ZSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGMgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIHJldHVybiBjYyhjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBOLnByb3RvdHlwZS5zaXplID0gTi5wcm90b3R5cGUuc2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZGModGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIE4ucHJvdG90eXBlLl9fZGVzdHJveV9fID0gTi5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZWModGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIHkucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSh0LnByb3RvdHlwZSk7CiAgICAgICAgICB5LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHk7CiAgICAgICAgICB5LnByb3RvdHlwZS5fX2NsYXNzX18gPSB5OwogICAgICAgICAgeS5fX2NhY2hlX18gPSB7fTsKICAgICAgICAgIGEzLk1ldGFkYXRhUXVlcmllciA9IHk7CiAgICAgICAgICB5LnByb3RvdHlwZS5IYXNFbnRyeSA9IHkucHJvdG90eXBlLkhhc0VudHJ5ID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICB2YXIgZCA9IHRoaXMucHRyOwogICAgICAgICAgICByLnByZXBhcmUoKTsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgPSBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyA/IGMucHRyIDogUihjKTsKICAgICAgICAgICAgcmV0dXJuICEhZmMoZCwgYiwgYyk7CiAgICAgICAgICB9OwogICAgICAgICAgeS5wcm90b3R5cGUuR2V0SW50RW50cnkgPSB5LnByb3RvdHlwZS5HZXRJbnRFbnRyeSA9IGZ1bmN0aW9uKGIsIGMpIHsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjID0gYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgPyBjLnB0ciA6IFIoYyk7CiAgICAgICAgICAgIHJldHVybiBnYyhkLCBiLCBjKTsKICAgICAgICAgIH07CiAgICAgICAgICB5LnByb3RvdHlwZS5HZXRJbnRFbnRyeUFycmF5ID0geS5wcm90b3R5cGUuR2V0SW50RW50cnlBcnJheSA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjID0gYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgPyBjLnB0ciA6IFIoYyk7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICBoYyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICB5LnByb3RvdHlwZS5HZXREb3VibGVFbnRyeSA9IHkucHJvdG90eXBlLkdldERvdWJsZUVudHJ5ID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICB2YXIgZCA9IHRoaXMucHRyOwogICAgICAgICAgICByLnByZXBhcmUoKTsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgPSBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyA/IGMucHRyIDogUihjKTsKICAgICAgICAgICAgcmV0dXJuIGljKGQsIGIsIGMpOwogICAgICAgICAgfTsKICAgICAgICAgIHkucHJvdG90eXBlLkdldFN0cmluZ0VudHJ5ID0geS5wcm90b3R5cGUuR2V0U3RyaW5nRW50cnkgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIHIucHJlcGFyZSgpOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyA9IGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjID8gYy5wdHIgOiBSKGMpOwogICAgICAgICAgICByZXR1cm4gaChqYyhkLCBiLCBjKSk7CiAgICAgICAgICB9OwogICAgICAgICAgeS5wcm90b3R5cGUuTnVtRW50cmllcyA9IHkucHJvdG90eXBlLk51bUVudHJpZXMgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4ga2MoYywgYik7CiAgICAgICAgICB9OwogICAgICAgICAgeS5wcm90b3R5cGUuR2V0RW50cnlOYW1lID0geS5wcm90b3R5cGUuR2V0RW50cnlOYW1lID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICB2YXIgZCA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIHJldHVybiBoKGxjKGQsIGIsIGMpKTsKICAgICAgICAgIH07CiAgICAgICAgICB5LnByb3RvdHlwZS5fX2Rlc3Ryb3lfXyA9IHkucHJvdG90eXBlLl9fZGVzdHJveV9fID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG1jKHRoaXMucHRyKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodC5wcm90b3R5cGUpOwogICAgICAgICAgbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBtOwogICAgICAgICAgbS5wcm90b3R5cGUuX19jbGFzc19fID0gbTsKICAgICAgICAgIG0uX19jYWNoZV9fID0ge307CiAgICAgICAgICBhMy5EZWNvZGVyID0gbTsKICAgICAgICAgIG0ucHJvdG90eXBlLkRlY29kZUFycmF5VG9Qb2ludENsb3VkID0gbS5wcm90b3R5cGUuRGVjb2RlQXJyYXlUb1BvaW50Q2xvdWQgPSBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIHZhciBnID0gdGhpcy5wdHI7CiAgICAgICAgICAgIHIucHJlcGFyZSgpOwogICAgICAgICAgICAib2JqZWN0IiA9PSB0eXBlb2YgYiAmJiAoYiA9IHBhKGIpKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICByZXR1cm4gRChuYyhnLCBiLCBjLCBkKSwgQik7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuRGVjb2RlQXJyYXlUb01lc2ggPSBtLnByb3RvdHlwZS5EZWNvZGVBcnJheVRvTWVzaCA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgci5wcmVwYXJlKCk7CiAgICAgICAgICAgICJvYmplY3QiID09IHR5cGVvZiBiICYmIChiID0gcGEoYikpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIHJldHVybiBEKG9jKGcsIGIsIGMsIGQpLCBCKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJZCA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUlkID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICB2YXIgZCA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIHJldHVybiBwYyhkLCBiLCBjKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJZEJ5TmFtZSA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUlkQnlOYW1lID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICB2YXIgZCA9IHRoaXMucHRyOwogICAgICAgICAgICByLnByZXBhcmUoKTsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgPSBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyA/IGMucHRyIDogUihjKTsKICAgICAgICAgICAgcmV0dXJuIHFjKGQsIGIsIGMpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUlkQnlNZXRhZGF0YUVudHJ5ID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSWRCeU1ldGFkYXRhRW50cnkgPSBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIHZhciBnID0gdGhpcy5wdHI7CiAgICAgICAgICAgIHIucHJlcGFyZSgpOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyA9IGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjID8gYy5wdHIgOiBSKGMpOwogICAgICAgICAgICBkID0gZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgPyBkLnB0ciA6IFIoZCk7CiAgICAgICAgICAgIHJldHVybiByYyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGUgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIEQoc2MoZCwgYiwgYyksIHcpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUJ5VW5pcXVlSWQgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVCeVVuaXF1ZUlkID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICB2YXIgZCA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIHJldHVybiBEKHRjKGQsIGIsIGMpLCB3KTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRNZXRhZGF0YSA9IG0ucHJvdG90eXBlLkdldE1ldGFkYXRhID0gZnVuY3Rpb24oYikgewogICAgICAgICAgICB2YXIgYyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgcmV0dXJuIEQodWMoYywgYiksIFQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZU1ldGFkYXRhID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlTWV0YWRhdGEgPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIEQodmMoZCwgYiwgYyksIFQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEZhY2VGcm9tTWVzaCA9IG0ucHJvdG90eXBlLkdldEZhY2VGcm9tTWVzaCA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhd2MoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0VHJpYW5nbGVTdHJpcHNGcm9tTWVzaCA9IG0ucHJvdG90eXBlLkdldFRyaWFuZ2xlU3RyaXBzRnJvbU1lc2ggPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIHhjKGQsIGIsIGMpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldFRyaWFuZ2xlc1VJbnQxNkFycmF5ID0gbS5wcm90b3R5cGUuR2V0VHJpYW5nbGVzVUludDE2QXJyYXkgPSBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIHZhciBnID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIHJldHVybiAhIXljKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldFRyaWFuZ2xlc1VJbnQzMkFycmF5ID0gbS5wcm90b3R5cGUuR2V0VHJpYW5nbGVzVUludDMyQXJyYXkgPSBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIHZhciBnID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIHJldHVybiAhIXpjKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUZsb2F0ID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlRmxvYXQgPSBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIHZhciBnID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIHJldHVybiAhIUFjKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUZsb2F0Rm9yQWxsUG9pbnRzID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlRmxvYXRGb3JBbGxQb2ludHMgPSBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIHZhciBnID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIHJldHVybiAhIUJjKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUludEZvckFsbFBvaW50cyA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUludEZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhQ2MoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50OEZvckFsbFBvaW50cyA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUludDhGb3JBbGxQb2ludHMgPSBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIHZhciBnID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIHJldHVybiAhIURjKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZVVJbnQ4Rm9yQWxsUG9pbnRzID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlVUludDhGb3JBbGxQb2ludHMgPSBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIHZhciBnID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIHJldHVybiAhIUVjKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZUludDE2Rm9yQWxsUG9pbnRzID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50MTZGb3JBbGxQb2ludHMgPSBmdW5jdGlvbihiLCBjLCBkKSB7CiAgICAgICAgICAgIHZhciBnID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgZCAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGQgJiYgKGQgPSBkLnB0cik7CiAgICAgICAgICAgIHJldHVybiAhIUZjKGcsIGIsIGMsIGQpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZVVJbnQxNkZvckFsbFBvaW50cyA9IG0ucHJvdG90eXBlLkdldEF0dHJpYnV0ZVVJbnQxNkZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhR2MoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlSW50MzJGb3JBbGxQb2ludHMgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVJbnQzMkZvckFsbFBvaW50cyA9IGZ1bmN0aW9uKGIsIGMsIGQpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLnB0cjsKICAgICAgICAgICAgYiAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGIgJiYgKGIgPSBiLnB0cik7CiAgICAgICAgICAgIGMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBjICYmIChjID0gYy5wdHIpOwogICAgICAgICAgICBkICYmICJvYmplY3QiID09PSB0eXBlb2YgZCAmJiAoZCA9IGQucHRyKTsKICAgICAgICAgICAgcmV0dXJuICEhSGMoZywgYiwgYywgZCk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlVUludDMyRm9yQWxsUG9pbnRzID0gbS5wcm90b3R5cGUuR2V0QXR0cmlidXRlVUludDMyRm9yQWxsUG9pbnRzID0gZnVuY3Rpb24oYiwgYywgZCkgewogICAgICAgICAgICB2YXIgZyA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICByZXR1cm4gISFJYyhnLCBiLCBjLCBkKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVEYXRhQXJyYXlGb3JBbGxQb2ludHMgPSBtLnByb3RvdHlwZS5HZXRBdHRyaWJ1dGVEYXRhQXJyYXlGb3JBbGxQb2ludHMgPSBmdW5jdGlvbihiLCBjLCBkLCBnLCB1MykgewogICAgICAgICAgICB2YXIgWCA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIGQgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBkICYmIChkID0gZC5wdHIpOwogICAgICAgICAgICBnICYmICJvYmplY3QiID09PSB0eXBlb2YgZyAmJiAoZyA9IGcucHRyKTsKICAgICAgICAgICAgdTMgJiYgIm9iamVjdCIgPT09IHR5cGVvZiB1MyAmJiAodTMgPSB1My5wdHIpOwogICAgICAgICAgICByZXR1cm4gISFKYyhYLCBiLCBjLCBkLCBnLCB1Myk7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybSA9IG0ucHJvdG90eXBlLlNraXBBdHRyaWJ1dGVUcmFuc2Zvcm0gPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBLYyhjLCBiKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5HZXRFbmNvZGVkR2VvbWV0cnlUeXBlX0RlcHJlY2F0ZWQgPSBtLnByb3RvdHlwZS5HZXRFbmNvZGVkR2VvbWV0cnlUeXBlX0RlcHJlY2F0ZWQgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIHZhciBjID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICByZXR1cm4gTGMoYywgYik7CiAgICAgICAgICB9OwogICAgICAgICAgbS5wcm90b3R5cGUuRGVjb2RlQnVmZmVyVG9Qb2ludENsb3VkID0gbS5wcm90b3R5cGUuRGVjb2RlQnVmZmVyVG9Qb2ludENsb3VkID0gZnVuY3Rpb24oYiwgYykgewogICAgICAgICAgICB2YXIgZCA9IHRoaXMucHRyOwogICAgICAgICAgICBiICYmICJvYmplY3QiID09PSB0eXBlb2YgYiAmJiAoYiA9IGIucHRyKTsKICAgICAgICAgICAgYyAmJiAib2JqZWN0IiA9PT0gdHlwZW9mIGMgJiYgKGMgPSBjLnB0cik7CiAgICAgICAgICAgIHJldHVybiBEKE1jKGQsIGIsIGMpLCBCKTsKICAgICAgICAgIH07CiAgICAgICAgICBtLnByb3RvdHlwZS5EZWNvZGVCdWZmZXJUb01lc2ggPSBtLnByb3RvdHlwZS5EZWNvZGVCdWZmZXJUb01lc2ggPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5wdHI7CiAgICAgICAgICAgIGIgJiYgIm9iamVjdCIgPT09IHR5cGVvZiBiICYmIChiID0gYi5wdHIpOwogICAgICAgICAgICBjICYmICJvYmplY3QiID09PSB0eXBlb2YgYyAmJiAoYyA9IGMucHRyKTsKICAgICAgICAgICAgcmV0dXJuIEQoTmMoZCwgYiwgYyksIEIpOwogICAgICAgICAgfTsKICAgICAgICAgIG0ucHJvdG90eXBlLl9fZGVzdHJveV9fID0gbS5wcm90b3R5cGUuX19kZXN0cm95X18gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgT2ModGhpcy5wdHIpOwogICAgICAgICAgfTsKICAgICAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAgICAgZnVuY3Rpb24gYigpIHsKICAgICAgICAgICAgICBhMy5BVFRSSUJVVEVfSU5WQUxJRF9UUkFOU0ZPUk0gPSBQYygpOwogICAgICAgICAgICAgIGEzLkFUVFJJQlVURV9OT19UUkFOU0ZPUk0gPSBRYygpOwogICAgICAgICAgICAgIGEzLkFUVFJJQlVURV9RVUFOVElaQVRJT05fVFJBTlNGT1JNID0gUmMoKTsKICAgICAgICAgICAgICBhMy5BVFRSSUJVVEVfT0NUQUhFRFJPTl9UUkFOU0ZPUk0gPSBTYygpOwogICAgICAgICAgICAgIGEzLklOVkFMSUQgPSBUYygpOwogICAgICAgICAgICAgIGEzLlBPU0lUSU9OID0gVWMoKTsKICAgICAgICAgICAgICBhMy5OT1JNQUwgPSBWYygpOwogICAgICAgICAgICAgIGEzLkNPTE9SID0gV2MoKTsKICAgICAgICAgICAgICBhMy5URVhfQ09PUkQgPSBYYygpOwogICAgICAgICAgICAgIGEzLkdFTkVSSUMgPSBZYygpOwogICAgICAgICAgICAgIGEzLklOVkFMSURfR0VPTUVUUllfVFlQRSA9IFpjKCk7CiAgICAgICAgICAgICAgYTMuUE9JTlRfQ0xPVUQgPSAkYygpOwogICAgICAgICAgICAgIGEzLlRSSUFOR1VMQVJfTUVTSCA9IGFkKCk7CiAgICAgICAgICAgICAgYTMuRFRfSU5WQUxJRCA9IGJkKCk7CiAgICAgICAgICAgICAgYTMuRFRfSU5UOCA9IGNkKCk7CiAgICAgICAgICAgICAgYTMuRFRfVUlOVDggPSBkZCgpOwogICAgICAgICAgICAgIGEzLkRUX0lOVDE2ID0gZWQoKTsKICAgICAgICAgICAgICBhMy5EVF9VSU5UMTYgPSBmZCgpOwogICAgICAgICAgICAgIGEzLkRUX0lOVDMyID0gZ2QoKTsKICAgICAgICAgICAgICBhMy5EVF9VSU5UMzIgPSBoZCgpOwogICAgICAgICAgICAgIGEzLkRUX0lOVDY0ID0gaWQoKTsKICAgICAgICAgICAgICBhMy5EVF9VSU5UNjQgPSBqZCgpOwogICAgICAgICAgICAgIGEzLkRUX0ZMT0FUMzIgPSBrZCgpOwogICAgICAgICAgICAgIGEzLkRUX0ZMT0FUNjQgPSBsZCgpOwogICAgICAgICAgICAgIGEzLkRUX0JPT0wgPSBtZCgpOwogICAgICAgICAgICAgIGEzLkRUX1RZUEVTX0NPVU5UID0gbmQoKTsKICAgICAgICAgICAgICBhMy5PSyA9IG9kKCk7CiAgICAgICAgICAgICAgYTMuRFJBQ09fRVJST1IgPSBwZCgpOwogICAgICAgICAgICAgIGEzLklPX0VSUk9SID0gcWQoKTsKICAgICAgICAgICAgICBhMy5JTlZBTElEX1BBUkFNRVRFUiA9IHJkKCk7CiAgICAgICAgICAgICAgYTMuVU5TVVBQT1JURURfVkVSU0lPTiA9IHNkKCk7CiAgICAgICAgICAgICAgYTMuVU5LTk9XTl9WRVJTSU9OID0gdGQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB6YSA/IGIoKSA6IG9hLnVuc2hpZnQoYik7CiAgICAgICAgICB9KSgpOwogICAgICAgICAgaWYgKCJmdW5jdGlvbiIgPT09IHR5cGVvZiBhMy5vbk1vZHVsZVBhcnNlZCkgYTMub25Nb2R1bGVQYXJzZWQoKTsKICAgICAgICAgIGEzLkRlY29kZXIucHJvdG90eXBlLkdldEVuY29kZWRHZW9tZXRyeVR5cGUgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgICAgIGlmIChiLl9fY2xhc3NfXyAmJiBiLl9fY2xhc3NfXyA9PT0gYTMuRGVjb2RlckJ1ZmZlcikgcmV0dXJuIGEzLkRlY29kZXIucHJvdG90eXBlLkdldEVuY29kZWRHZW9tZXRyeVR5cGVfRGVwcmVjYXRlZChiKTsKICAgICAgICAgICAgaWYgKDggPiBiLmJ5dGVMZW5ndGgpIHJldHVybiBhMy5JTlZBTElEX0dFT01FVFJZX1RZUEU7CiAgICAgICAgICAgIHN3aXRjaCAoYls3XSkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJldHVybiBhMy5QT0lOVF9DTE9VRDsKICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICByZXR1cm4gYTMuVFJJQU5HVUxBUl9NRVNIOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gYTMuSU5WQUxJRF9HRU9NRVRSWV9UWVBFOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIG4ucmVhZHk7CiAgICAgICAgfTsKICAgICAgfSgpOwogICAgICAib2JqZWN0IiA9PT0gdHlwZW9mIGV4cG9ydHMyICYmICJvYmplY3QiID09PSB0eXBlb2YgbW9kdWxlID8gbW9kdWxlLmV4cG9ydHMgPSBEcmFjb0RlY29kZXJNb2R1bGUgOiAiZnVuY3Rpb24iID09PSB0eXBlb2YgZGVmaW5lICYmIGRlZmluZS5hbWQgPyBkZWZpbmUoW10sIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBEcmFjb0RlY29kZXJNb2R1bGU7CiAgICAgIH0pIDogIm9iamVjdCIgPT09IHR5cGVvZiBleHBvcnRzMiAmJiAoZXhwb3J0czIuRHJhY29EZWNvZGVyTW9kdWxlID0gRHJhY29EZWNvZGVyTW9kdWxlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2RlY29kZURyYWNvLmpzCiAgdmFyIGRlY29kZURyYWNvX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChkZWNvZGVEcmFjb19leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiBkZWNvZGVEcmFjb19kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gZGVjb2RlSW5kZXhBcnJheShkcmFjb0dlb21ldHJ5LCBkcmFjb0RlY29kZXIpIHsKICAgIGNvbnN0IG51bVBvaW50cyA9IGRyYWNvR2VvbWV0cnkubnVtX3BvaW50cygpOwogICAgY29uc3QgbnVtRmFjZXMgPSBkcmFjb0dlb21ldHJ5Lm51bV9mYWNlcygpOwogICAgY29uc3QgZmFjZUluZGljZXMgPSBuZXcgZHJhY28uRHJhY29JbnQzMkFycmF5KCk7CiAgICBjb25zdCBudW1JbmRpY2VzID0gbnVtRmFjZXMgKiAzOwogICAgY29uc3QgaW5kZXhBcnJheSA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KG51bVBvaW50cywgbnVtSW5kaWNlcyk7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtRmFjZXM7ICsraSkgewogICAgICBkcmFjb0RlY29kZXIuR2V0RmFjZUZyb21NZXNoKGRyYWNvR2VvbWV0cnksIGksIGZhY2VJbmRpY2VzKTsKICAgICAgaW5kZXhBcnJheVtvZmZzZXQgKyAwXSA9IGZhY2VJbmRpY2VzLkdldFZhbHVlKDApOwogICAgICBpbmRleEFycmF5W29mZnNldCArIDFdID0gZmFjZUluZGljZXMuR2V0VmFsdWUoMSk7CiAgICAgIGluZGV4QXJyYXlbb2Zmc2V0ICsgMl0gPSBmYWNlSW5kaWNlcy5HZXRWYWx1ZSgyKTsKICAgICAgb2Zmc2V0ICs9IDM7CiAgICB9CiAgICBkcmFjby5kZXN0cm95KGZhY2VJbmRpY2VzKTsKICAgIHJldHVybiB7CiAgICAgIHR5cGVkQXJyYXk6IGluZGV4QXJyYXksCiAgICAgIG51bWJlck9mSW5kaWNlczogbnVtSW5kaWNlcwogICAgfTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlUXVhbnRpemVkRHJhY29UeXBlZEFycmF5KGRyYWNvR2VvbWV0cnksIGRyYWNvRGVjb2RlciwgZHJhY29BdHRyaWJ1dGUsIHF1YW50aXphdGlvbiwgdmVydGV4QXJyYXlMZW5ndGgpIHsKICAgIGxldCB2ZXJ0ZXhBcnJheTsKICAgIGxldCBhdHRyaWJ1dGVEYXRhOwogICAgaWYgKHF1YW50aXphdGlvbi5xdWFudGl6YXRpb25CaXRzIDw9IDgpIHsKICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjby5EcmFjb1VJbnQ4QXJyYXkoKTsKICAgICAgdmVydGV4QXJyYXkgPSBuZXcgVWludDhBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgIGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVVSW50OEZvckFsbFBvaW50cygKICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgKTsKICAgIH0gZWxzZSBpZiAocXVhbnRpemF0aW9uLnF1YW50aXphdGlvbkJpdHMgPD0gMTYpIHsKICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjby5EcmFjb1VJbnQxNkFycmF5KCk7CiAgICAgIHZlcnRleEFycmF5ID0gbmV3IFVpbnQxNkFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQxNkZvckFsbFBvaW50cygKICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIGF0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY28uRHJhY29GbG9hdDMyQXJyYXkoKTsKICAgICAgdmVydGV4QXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUZsb2F0Rm9yQWxsUG9pbnRzKAogICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICApOwogICAgfQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2ZXJ0ZXhBcnJheUxlbmd0aDsgKytpKSB7CiAgICAgIHZlcnRleEFycmF5W2ldID0gYXR0cmlidXRlRGF0YS5HZXRWYWx1ZShpKTsKICAgIH0KICAgIGRyYWNvLmRlc3Ryb3koYXR0cmlidXRlRGF0YSk7CiAgICByZXR1cm4gdmVydGV4QXJyYXk7CiAgfQogIGZ1bmN0aW9uIGRlY29kZURyYWNvVHlwZWRBcnJheShkcmFjb0dlb21ldHJ5LCBkcmFjb0RlY29kZXIsIGRyYWNvQXR0cmlidXRlLCB2ZXJ0ZXhBcnJheUxlbmd0aCkgewogICAgbGV0IHZlcnRleEFycmF5OwogICAgbGV0IGF0dHJpYnV0ZURhdGE7CiAgICBzd2l0Y2ggKGRyYWNvQXR0cmlidXRlLmRhdGFfdHlwZSgpKSB7CiAgICAgIGNhc2UgMToKICAgICAgY2FzZSAxMToKICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvSW50OEFycmF5KCk7CiAgICAgICAgdmVydGV4QXJyYXkgPSBuZXcgSW50OEFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgICBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlSW50OEZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjby5EcmFjb1VJbnQ4QXJyYXkoKTsKICAgICAgICB2ZXJ0ZXhBcnJheSA9IG5ldyBVaW50OEFycmF5KHZlcnRleEFycmF5TGVuZ3RoKTsKICAgICAgICBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlVUludDhGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBhdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAzOgogICAgICAgIGF0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY28uRHJhY29JbnQxNkFycmF5KCk7CiAgICAgICAgdmVydGV4QXJyYXkgPSBuZXcgSW50MTZBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUludDE2Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgNDoKICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvVUludDE2QXJyYXkoKTsKICAgICAgICB2ZXJ0ZXhBcnJheSA9IG5ldyBVaW50MTZBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQxNkZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDU6CiAgICAgIGNhc2UgNzoKICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvSW50MzJBcnJheSgpOwogICAgICAgIHZlcnRleEFycmF5ID0gbmV3IEludDMyQXJyYXkodmVydGV4QXJyYXlMZW5ndGgpOwogICAgICAgIGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVJbnQzMkZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDY6CiAgICAgIGNhc2UgODoKICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvLkRyYWNvVUludDMyQXJyYXkoKTsKICAgICAgICB2ZXJ0ZXhBcnJheSA9IG5ldyBVaW50MzJBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQzMkZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGF0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDk6CiAgICAgIGNhc2UgMTA6CiAgICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjby5EcmFjb0Zsb2F0MzJBcnJheSgpOwogICAgICAgIHZlcnRleEFycmF5ID0gbmV3IEZsb2F0MzJBcnJheSh2ZXJ0ZXhBcnJheUxlbmd0aCk7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUZsb2F0Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgYXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRleEFycmF5TGVuZ3RoOyArK2kpIHsKICAgICAgdmVydGV4QXJyYXlbaV0gPSBhdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgfQogICAgZHJhY28uZGVzdHJveShhdHRyaWJ1dGVEYXRhKTsKICAgIHJldHVybiB2ZXJ0ZXhBcnJheTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlQXR0cmlidXRlKGRyYWNvR2VvbWV0cnksIGRyYWNvRGVjb2RlciwgZHJhY29BdHRyaWJ1dGUpIHsKICAgIGNvbnN0IG51bVBvaW50cyA9IGRyYWNvR2VvbWV0cnkubnVtX3BvaW50cygpOwogICAgY29uc3QgbnVtQ29tcG9uZW50cyA9IGRyYWNvQXR0cmlidXRlLm51bV9jb21wb25lbnRzKCk7CiAgICBsZXQgcXVhbnRpemF0aW9uOwogICAgbGV0IHRyYW5zZm9ybTIgPSBuZXcgZHJhY28uQXR0cmlidXRlUXVhbnRpemF0aW9uVHJhbnNmb3JtKCk7CiAgICBpZiAodHJhbnNmb3JtMi5Jbml0RnJvbUF0dHJpYnV0ZShkcmFjb0F0dHJpYnV0ZSkpIHsKICAgICAgY29uc3QgbWluVmFsdWVzID0gbmV3IEFycmF5KG51bUNvbXBvbmVudHMpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bUNvbXBvbmVudHM7ICsraSkgewogICAgICAgIG1pblZhbHVlc1tpXSA9IHRyYW5zZm9ybTIubWluX3ZhbHVlKGkpOwogICAgICB9CiAgICAgIHF1YW50aXphdGlvbiA9IHsKICAgICAgICBxdWFudGl6YXRpb25CaXRzOiB0cmFuc2Zvcm0yLnF1YW50aXphdGlvbl9iaXRzKCksCiAgICAgICAgbWluVmFsdWVzLAogICAgICAgIHJhbmdlOiB0cmFuc2Zvcm0yLnJhbmdlKCksCiAgICAgICAgb2N0RW5jb2RlZDogZmFsc2UKICAgICAgfTsKICAgIH0KICAgIGRyYWNvLmRlc3Ryb3kodHJhbnNmb3JtMik7CiAgICB0cmFuc2Zvcm0yID0gbmV3IGRyYWNvLkF0dHJpYnV0ZU9jdGFoZWRyb25UcmFuc2Zvcm0oKTsKICAgIGlmICh0cmFuc2Zvcm0yLkluaXRGcm9tQXR0cmlidXRlKGRyYWNvQXR0cmlidXRlKSkgewogICAgICBxdWFudGl6YXRpb24gPSB7CiAgICAgICAgcXVhbnRpemF0aW9uQml0czogdHJhbnNmb3JtMi5xdWFudGl6YXRpb25fYml0cygpLAogICAgICAgIG9jdEVuY29kZWQ6IHRydWUKICAgICAgfTsKICAgIH0KICAgIGRyYWNvLmRlc3Ryb3kodHJhbnNmb3JtMik7CiAgICBjb25zdCB2ZXJ0ZXhBcnJheUxlbmd0aCA9IG51bVBvaW50cyAqIG51bUNvbXBvbmVudHM7CiAgICBsZXQgdmVydGV4QXJyYXk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHF1YW50aXphdGlvbikpIHsKICAgICAgdmVydGV4QXJyYXkgPSBkZWNvZGVRdWFudGl6ZWREcmFjb1R5cGVkQXJyYXkoCiAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICBkcmFjb0RlY29kZXIsCiAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgcXVhbnRpemF0aW9uLAogICAgICAgIHZlcnRleEFycmF5TGVuZ3RoCiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICB2ZXJ0ZXhBcnJheSA9IGRlY29kZURyYWNvVHlwZWRBcnJheSgKICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgIGRyYWNvRGVjb2RlciwKICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICB2ZXJ0ZXhBcnJheUxlbmd0aAogICAgICApOwogICAgfQogICAgY29uc3QgY29tcG9uZW50RGF0YXR5cGUgPSBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LmZyb21UeXBlZEFycmF5KHZlcnRleEFycmF5KTsKICAgIHJldHVybiB7CiAgICAgIGFycmF5OiB2ZXJ0ZXhBcnJheSwKICAgICAgZGF0YTogewogICAgICAgIGNvbXBvbmVudHNQZXJBdHRyaWJ1dGU6IG51bUNvbXBvbmVudHMsCiAgICAgICAgY29tcG9uZW50RGF0YXR5cGUsCiAgICAgICAgYnl0ZU9mZnNldDogZHJhY29BdHRyaWJ1dGUuYnl0ZV9vZmZzZXQoKSwKICAgICAgICBieXRlU3RyaWRlOiBDb21wb25lbnREYXRhdHlwZV9kZWZhdWx0LmdldFNpemVJbkJ5dGVzKGNvbXBvbmVudERhdGF0eXBlKSAqIG51bUNvbXBvbmVudHMsCiAgICAgICAgbm9ybWFsaXplZDogZHJhY29BdHRyaWJ1dGUubm9ybWFsaXplZCgpLAogICAgICAgIHF1YW50aXphdGlvbgogICAgICB9CiAgICB9OwogIH0KICBmdW5jdGlvbiBkZWNvZGVQb2ludENsb3VkKHBhcmFtZXRlcnMpIHsKICAgIGNvbnN0IGRyYWNvRGVjb2RlciA9IG5ldyBkcmFjby5EZWNvZGVyKCk7CiAgICBpZiAocGFyYW1ldGVycy5kZXF1YW50aXplSW5TaGFkZXIpIHsKICAgICAgZHJhY29EZWNvZGVyLlNraXBBdHRyaWJ1dGVUcmFuc2Zvcm0oZHJhY28uUE9TSVRJT04pOwogICAgICBkcmFjb0RlY29kZXIuU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybShkcmFjby5OT1JNQUwpOwogICAgfQogICAgY29uc3QgYnVmZmVyID0gbmV3IGRyYWNvLkRlY29kZXJCdWZmZXIoKTsKICAgIGJ1ZmZlci5Jbml0KHBhcmFtZXRlcnMuYnVmZmVyLCBwYXJhbWV0ZXJzLmJ1ZmZlci5sZW5ndGgpOwogICAgY29uc3QgZ2VvbWV0cnlUeXBlID0gZHJhY29EZWNvZGVyLkdldEVuY29kZWRHZW9tZXRyeVR5cGUoYnVmZmVyKTsKICAgIGlmIChnZW9tZXRyeVR5cGUgIT09IGRyYWNvLlBPSU5UX0NMT1VEKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiRHJhY28gZ2VvbWV0cnkgdHlwZSBtdXN0IGJlIFBPSU5UX0NMT1VELiIpOwogICAgfQogICAgY29uc3QgZHJhY29Qb2ludENsb3VkID0gbmV3IGRyYWNvLlBvaW50Q2xvdWQoKTsKICAgIGNvbnN0IGRlY29kaW5nU3RhdHVzID0gZHJhY29EZWNvZGVyLkRlY29kZUJ1ZmZlclRvUG9pbnRDbG91ZCgKICAgICAgYnVmZmVyLAogICAgICBkcmFjb1BvaW50Q2xvdWQKICAgICk7CiAgICBpZiAoIWRlY29kaW5nU3RhdHVzLm9rKCkgfHwgZHJhY29Qb2ludENsb3VkLnB0ciA9PT0gMCkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgYEVycm9yIGRlY29kaW5nIGRyYWNvIHBvaW50IGNsb3VkOiAke2RlY29kaW5nU3RhdHVzLmVycm9yX21zZygpfWAKICAgICAgKTsKICAgIH0KICAgIGRyYWNvLmRlc3Ryb3koYnVmZmVyKTsKICAgIGNvbnN0IHJlc3VsdCA9IHt9OwogICAgY29uc3QgcHJvcGVydGllcyA9IHBhcmFtZXRlcnMucHJvcGVydGllczsKICAgIGZvciAoY29uc3QgcHJvcGVydHlOYW1lIGluIHByb3BlcnRpZXMpIHsKICAgICAgaWYgKHByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkocHJvcGVydHlOYW1lKSkgewogICAgICAgIGxldCBkcmFjb0F0dHJpYnV0ZTsKICAgICAgICBpZiAocHJvcGVydHlOYW1lID09PSAiUE9TSVRJT04iIHx8IHByb3BlcnR5TmFtZSA9PT0gIk5PUk1BTCIpIHsKICAgICAgICAgIGNvbnN0IGRyYWNvQXR0cmlidXRlSWQgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlSWQoCiAgICAgICAgICAgIGRyYWNvUG9pbnRDbG91ZCwKICAgICAgICAgICAgZHJhY29bcHJvcGVydHlOYW1lXQogICAgICAgICAgKTsKICAgICAgICAgIGRyYWNvQXR0cmlidXRlID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZSgKICAgICAgICAgICAgZHJhY29Qb2ludENsb3VkLAogICAgICAgICAgICBkcmFjb0F0dHJpYnV0ZUlkCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVJZCA9IHByb3BlcnRpZXNbcHJvcGVydHlOYW1lXTsKICAgICAgICAgIGRyYWNvQXR0cmlidXRlID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUJ5VW5pcXVlSWQoCiAgICAgICAgICAgIGRyYWNvUG9pbnRDbG91ZCwKICAgICAgICAgICAgYXR0cmlidXRlSWQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdFtwcm9wZXJ0eU5hbWVdID0gZGVjb2RlQXR0cmlidXRlKAogICAgICAgICAgZHJhY29Qb2ludENsb3VkLAogICAgICAgICAgZHJhY29EZWNvZGVyLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICBkcmFjby5kZXN0cm95KGRyYWNvUG9pbnRDbG91ZCk7CiAgICBkcmFjby5kZXN0cm95KGRyYWNvRGVjb2Rlcik7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBkZWNvZGVQcmltaXRpdmUocGFyYW1ldGVycykgewogICAgY29uc3QgZHJhY29EZWNvZGVyID0gbmV3IGRyYWNvLkRlY29kZXIoKTsKICAgIGNvbnN0IGF0dHJpYnV0ZXNUb1NraXAgPSBbIlBPU0lUSU9OIiwgIk5PUk1BTCIsICJDT0xPUiIsICJURVhfQ09PUkQiXTsKICAgIGlmIChwYXJhbWV0ZXJzLmRlcXVhbnRpemVJblNoYWRlcikgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGF0dHJpYnV0ZXNUb1NraXAubGVuZ3RoOyArK2kpIHsKICAgICAgICBkcmFjb0RlY29kZXIuU2tpcEF0dHJpYnV0ZVRyYW5zZm9ybShkcmFjb1thdHRyaWJ1dGVzVG9Ta2lwW2ldXSk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGJ1ZmZlclZpZXcgPSBwYXJhbWV0ZXJzLmJ1ZmZlclZpZXc7CiAgICBjb25zdCBidWZmZXIgPSBuZXcgZHJhY28uRGVjb2RlckJ1ZmZlcigpOwogICAgYnVmZmVyLkluaXQocGFyYW1ldGVycy5hcnJheSwgYnVmZmVyVmlldy5ieXRlTGVuZ3RoKTsKICAgIGNvbnN0IGdlb21ldHJ5VHlwZSA9IGRyYWNvRGVjb2Rlci5HZXRFbmNvZGVkR2VvbWV0cnlUeXBlKGJ1ZmZlcik7CiAgICBpZiAoZ2VvbWV0cnlUeXBlICE9PSBkcmFjby5UUklBTkdVTEFSX01FU0gpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJVbnN1cHBvcnRlZCBkcmFjbyBtZXNoIGdlb21ldHJ5IHR5cGUuIik7CiAgICB9CiAgICBjb25zdCBkcmFjb0dlb21ldHJ5ID0gbmV3IGRyYWNvLk1lc2goKTsKICAgIGNvbnN0IGRlY29kaW5nU3RhdHVzID0gZHJhY29EZWNvZGVyLkRlY29kZUJ1ZmZlclRvTWVzaChidWZmZXIsIGRyYWNvR2VvbWV0cnkpOwogICAgaWYgKCFkZWNvZGluZ1N0YXR1cy5vaygpIHx8IGRyYWNvR2VvbWV0cnkucHRyID09PSAwKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICBgRXJyb3IgZGVjb2RpbmcgZHJhY28gbWVzaCBnZW9tZXRyeTogJHtkZWNvZGluZ1N0YXR1cy5lcnJvcl9tc2coKX1gCiAgICAgICk7CiAgICB9CiAgICBkcmFjby5kZXN0cm95KGJ1ZmZlcik7CiAgICBjb25zdCBhdHRyaWJ1dGVEYXRhID0ge307CiAgICBjb25zdCBjb21wcmVzc2VkQXR0cmlidXRlcyA9IHBhcmFtZXRlcnMuY29tcHJlc3NlZEF0dHJpYnV0ZXM7CiAgICBmb3IgKGNvbnN0IGF0dHJpYnV0ZU5hbWUgaW4gY29tcHJlc3NlZEF0dHJpYnV0ZXMpIHsKICAgICAgaWYgKGNvbXByZXNzZWRBdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgY29uc3QgY29tcHJlc3NlZEF0dHJpYnV0ZSA9IGNvbXByZXNzZWRBdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdOwogICAgICAgIGNvbnN0IGRyYWNvQXR0cmlidXRlID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUJ5VW5pcXVlSWQoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgY29tcHJlc3NlZEF0dHJpYnV0ZQogICAgICAgICk7CiAgICAgICAgYXR0cmlidXRlRGF0YVthdHRyaWJ1dGVOYW1lXSA9IGRlY29kZUF0dHJpYnV0ZSgKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0RlY29kZXIsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZQogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHJlc3VsdCA9IHsKICAgICAgaW5kZXhBcnJheTogZGVjb2RlSW5kZXhBcnJheShkcmFjb0dlb21ldHJ5LCBkcmFjb0RlY29kZXIpLAogICAgICBhdHRyaWJ1dGVEYXRhCiAgICB9OwogICAgZHJhY28uZGVzdHJveShkcmFjb0dlb21ldHJ5KTsKICAgIGRyYWNvLmRlc3Ryb3koZHJhY29EZWNvZGVyKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGFzeW5jIGZ1bmN0aW9uIGRlY29kZShwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBhcmFtZXRlcnMuYnVmZmVyVmlldykpIHsKICAgICAgcmV0dXJuIGRlY29kZVByaW1pdGl2ZShwYXJhbWV0ZXJzKTsKICAgIH0KICAgIHJldHVybiBkZWNvZGVQb2ludENsb3VkKHBhcmFtZXRlcnMpOwogIH0KICBhc3luYyBmdW5jdGlvbiBpbml0V29ya2VyKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHdhc21Db25maWcgPSBwYXJhbWV0ZXJzLndlYkFzc2VtYmx5Q29uZmlnOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdCh3YXNtQ29uZmlnKSAmJiBkZWZpbmVkX2RlZmF1bHQod2FzbUNvbmZpZy53YXNtQmluYXJ5RmlsZSkpIHsKICAgICAgZHJhY28gPSBhd2FpdCAoMCwgaW1wb3J0X2RyYWNvX2RlY29kZXJfbm9kZWpzLmRlZmF1bHQpKHdhc21Db25maWcpOwogICAgfSBlbHNlIHsKICAgICAgZHJhY28gPSBhd2FpdCAoMCwgaW1wb3J0X2RyYWNvX2RlY29kZXJfbm9kZWpzLmRlZmF1bHQpKCk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgYXN5bmMgZnVuY3Rpb24gZGVjb2RlRHJhY28ocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3Qgd2FzbUNvbmZpZyA9IHBhcmFtZXRlcnMud2ViQXNzZW1ibHlDb25maWc7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHdhc21Db25maWcpKSB7CiAgICAgIHJldHVybiBpbml0V29ya2VyKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogICAgfQogICAgcmV0dXJuIGRlY29kZShwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKTsKICB9CiAgdmFyIGltcG9ydF9kcmFjb19kZWNvZGVyX25vZGVqcywgZHJhY28sIGRlY29kZURyYWNvX2RlZmF1bHQ7CiAgdmFyIGluaXRfZGVjb2RlRHJhY28gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2RlY29kZURyYWNvLmpzIigpIHsKICAgICAgaW5pdF9Db21wb25lbnREYXRhdHlwZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9JbmRleERhdGF0eXBlKCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpOwogICAgICBpbXBvcnRfZHJhY29fZGVjb2Rlcl9ub2RlanMgPSBfX3RvRVNNKHJlcXVpcmVfZHJhY29fZGVjb2Rlcl9ub2RlanMoKSwgMSk7CiAgICAgIGRlY29kZURyYWNvX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQoZGVjb2RlRHJhY28pOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YS5qcwogIGZ1bmN0aW9uIGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZURhdGEoa2V5LCBkYXRhKSB7CiAgICBpZiAoZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YS5wYXNzVGhyb3VnaERhdGFGb3JUZXN0aW5nKSB7CiAgICAgIHJldHVybiBkYXRhOwogICAgfQogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJrZXkiLCBrZXkpOwogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJkYXRhIiwgZGF0YSk7CiAgICBjb25zdCBrZXlMZW5ndGggPSBrZXkuYnl0ZUxlbmd0aDsKICAgIGlmIChrZXlMZW5ndGggPT09IDAgfHwga2V5TGVuZ3RoICUgNCAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgIlRoZSBsZW5ndGggb2Yga2V5IG11c3QgYmUgZ3JlYXRlciB0aGFuIDAgYW5kIGEgbXVsdGlwbGUgb2YgNC4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBkYXRhVmlldyA9IG5ldyBEYXRhVmlldyhkYXRhKTsKICAgIGNvbnN0IG1hZ2ljID0gZGF0YVZpZXcuZ2V0VWludDMyKDAsIHRydWUpOwogICAgaWYgKG1hZ2ljID09PSBjb21wcmVzc2VkTWFnaWMgfHwgbWFnaWMgPT09IGNvbXByZXNzZWRNYWdpY1N3YXApIHsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9CiAgICBjb25zdCBrZXlWaWV3ID0gbmV3IERhdGFWaWV3KGtleSk7CiAgICBsZXQgZHAgPSAwOwogICAgY29uc3QgZHBlbmQgPSBkYXRhLmJ5dGVMZW5ndGg7CiAgICBjb25zdCBkcGVuZDY0ID0gZHBlbmQgLSBkcGVuZCAlIDg7CiAgICBjb25zdCBrcGVuZCA9IGtleUxlbmd0aDsKICAgIGxldCBrcDsKICAgIGxldCBvZmYgPSA4OwogICAgd2hpbGUgKGRwIDwgZHBlbmQ2NCkgewogICAgICBvZmYgPSAob2ZmICsgOCkgJSAyNDsKICAgICAga3AgPSBvZmY7CiAgICAgIHdoaWxlIChkcCA8IGRwZW5kNjQgJiYga3AgPCBrcGVuZCkgewogICAgICAgIGRhdGFWaWV3LnNldFVpbnQzMigKICAgICAgICAgIGRwLAogICAgICAgICAgZGF0YVZpZXcuZ2V0VWludDMyKGRwLCB0cnVlKSBeIGtleVZpZXcuZ2V0VWludDMyKGtwLCB0cnVlKSwKICAgICAgICAgIHRydWUKICAgICAgICApOwogICAgICAgIGRhdGFWaWV3LnNldFVpbnQzMigKICAgICAgICAgIGRwICsgNCwKICAgICAgICAgIGRhdGFWaWV3LmdldFVpbnQzMihkcCArIDQsIHRydWUpIF4ga2V5Vmlldy5nZXRVaW50MzIoa3AgKyA0LCB0cnVlKSwKICAgICAgICAgIHRydWUKICAgICAgICApOwogICAgICAgIGRwICs9IDg7CiAgICAgICAga3AgKz0gMjQ7CiAgICAgIH0KICAgIH0KICAgIGlmIChkcCA8IGRwZW5kKSB7CiAgICAgIGlmIChrcCA+PSBrcGVuZCkgewogICAgICAgIG9mZiA9IChvZmYgKyA4KSAlIDI0OwogICAgICAgIGtwID0gb2ZmOwogICAgICB9CiAgICAgIHdoaWxlIChkcCA8IGRwZW5kKSB7CiAgICAgICAgZGF0YVZpZXcuc2V0VWludDgoZHAsIGRhdGFWaWV3LmdldFVpbnQ4KGRwKSBeIGtleVZpZXcuZ2V0VWludDgoa3ApKTsKICAgICAgICBkcCsrOwogICAgICAgIGtwKys7CiAgICAgIH0KICAgIH0KICB9CiAgdmFyIGNvbXByZXNzZWRNYWdpYywgY29tcHJlc3NlZE1hZ2ljU3dhcCwgZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YV9kZWZhdWx0OwogIHZhciBpbml0X2RlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZURhdGEgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2RlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZURhdGEuanMiKCkgewogICAgICBpbml0X0NoZWNrKCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIGNvbXByZXNzZWRNYWdpYyA9IDE5NTMwMjk4MDU7CiAgICAgIGNvbXByZXNzZWRNYWdpY1N3YXAgPSAyOTE3MDM0MTAwOwogICAgICBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VEYXRhLnBhc3NUaHJvdWdoRGF0YUZvclRlc3RpbmcgPSBmYWxzZTsKICAgICAgZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YV9kZWZhdWx0ID0gZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlRGF0YTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL2lzQml0U2V0LmpzCiAgZnVuY3Rpb24gaXNCaXRTZXQoYml0cywgbWFzaykgewogICAgcmV0dXJuIChiaXRzICYgbWFzaykgIT09IDA7CiAgfQogIHZhciBpc0JpdFNldF9kZWZhdWx0OwogIHZhciBpbml0X2lzQml0U2V0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9pc0JpdFNldC5qcyIoKSB7CiAgICAgIGlzQml0U2V0X2RlZmF1bHQgPSBpc0JpdFNldDsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbi5qcwogIGZ1bmN0aW9uIEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbihiaXRzLCBjbm9kZVZlcnNpb24sIGltYWdlcnlWZXJzaW9uLCB0ZXJyYWluVmVyc2lvbiwgaW1hZ2VyeVByb3ZpZGVyLCB0ZXJyYWluUHJvdmlkZXIpIHsKICAgIHRoaXMuX2JpdHMgPSBiaXRzOwogICAgdGhpcy5jbm9kZVZlcnNpb24gPSBjbm9kZVZlcnNpb247CiAgICB0aGlzLmltYWdlcnlWZXJzaW9uID0gaW1hZ2VyeVZlcnNpb247CiAgICB0aGlzLnRlcnJhaW5WZXJzaW9uID0gdGVycmFpblZlcnNpb247CiAgICB0aGlzLmltYWdlcnlQcm92aWRlciA9IGltYWdlcnlQcm92aWRlcjsKICAgIHRoaXMudGVycmFpblByb3ZpZGVyID0gdGVycmFpblByb3ZpZGVyOwogICAgdGhpcy5hbmNlc3Rvckhhc1RlcnJhaW4gPSBmYWxzZTsKICAgIHRoaXMudGVycmFpblN0YXRlID0gdm9pZCAwOwogIH0KICB2YXIgY2hpbGRyZW5CaXRtYXNrcywgYW55Q2hpbGRCaXRtYXNrLCBjYWNoZUZsYWdCaXRtYXNrLCBpbWFnZUJpdG1hc2ssIHRlcnJhaW5CaXRtYXNrLCBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb25fZGVmYXVsdDsKICB2YXIgaW5pdF9Hb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24gPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL0dvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbi5qcyIoKSB7CiAgICAgIGluaXRfZGVmaW5lZCgpOwogICAgICBpbml0X2lzQml0U2V0KCk7CiAgICAgIGNoaWxkcmVuQml0bWFza3MgPSBbMSwgMiwgNCwgOF07CiAgICAgIGFueUNoaWxkQml0bWFzayA9IDE1OwogICAgICBjYWNoZUZsYWdCaXRtYXNrID0gMTY7CiAgICAgIGltYWdlQml0bWFzayA9IDY0OwogICAgICB0ZXJyYWluQml0bWFzayA9IDEyODsKICAgICAgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLmNsb25lID0gZnVuY3Rpb24oaW5mbywgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQocmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbmV3IEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbigKICAgICAgICAgICAgaW5mby5fYml0cywKICAgICAgICAgICAgaW5mby5jbm9kZVZlcnNpb24sCiAgICAgICAgICAgIGluZm8uaW1hZ2VyeVZlcnNpb24sCiAgICAgICAgICAgIGluZm8udGVycmFpblZlcnNpb24sCiAgICAgICAgICAgIGluZm8uaW1hZ2VyeVByb3ZpZGVyLAogICAgICAgICAgICBpbmZvLnRlcnJhaW5Qcm92aWRlcgogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Ll9iaXRzID0gaW5mby5fYml0czsKICAgICAgICAgIHJlc3VsdC5jbm9kZVZlcnNpb24gPSBpbmZvLmNub2RlVmVyc2lvbjsKICAgICAgICAgIHJlc3VsdC5pbWFnZXJ5VmVyc2lvbiA9IGluZm8uaW1hZ2VyeVZlcnNpb247CiAgICAgICAgICByZXN1bHQudGVycmFpblZlcnNpb24gPSBpbmZvLnRlcnJhaW5WZXJzaW9uOwogICAgICAgICAgcmVzdWx0LmltYWdlcnlQcm92aWRlciA9IGluZm8uaW1hZ2VyeVByb3ZpZGVyOwogICAgICAgICAgcmVzdWx0LnRlcnJhaW5Qcm92aWRlciA9IGluZm8udGVycmFpblByb3ZpZGVyOwogICAgICAgIH0KICAgICAgICByZXN1bHQuYW5jZXN0b3JIYXNUZXJyYWluID0gaW5mby5hbmNlc3Rvckhhc1RlcnJhaW47CiAgICAgICAgcmVzdWx0LnRlcnJhaW5TdGF0ZSA9IGluZm8udGVycmFpblN0YXRlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbi5wcm90b3R5cGUuc2V0UGFyZW50ID0gZnVuY3Rpb24ocGFyZW50KSB7CiAgICAgICAgdGhpcy5hbmNlc3Rvckhhc1RlcnJhaW4gPSBwYXJlbnQuYW5jZXN0b3JIYXNUZXJyYWluIHx8IHRoaXMuaGFzVGVycmFpbigpOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24ucHJvdG90eXBlLmhhc1N1YnRyZWUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gaXNCaXRTZXRfZGVmYXVsdCh0aGlzLl9iaXRzLCBjYWNoZUZsYWdCaXRtYXNrKTsKICAgICAgfTsKICAgICAgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLnByb3RvdHlwZS5oYXNJbWFnZXJ5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGlzQml0U2V0X2RlZmF1bHQodGhpcy5fYml0cywgaW1hZ2VCaXRtYXNrKTsKICAgICAgfTsKICAgICAgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLnByb3RvdHlwZS5oYXNUZXJyYWluID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGlzQml0U2V0X2RlZmF1bHQodGhpcy5fYml0cywgdGVycmFpbkJpdG1hc2spOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24ucHJvdG90eXBlLmhhc0NoaWxkcmVuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGlzQml0U2V0X2RlZmF1bHQodGhpcy5fYml0cywgYW55Q2hpbGRCaXRtYXNrKTsKICAgICAgfTsKICAgICAgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uLnByb3RvdHlwZS5oYXNDaGlsZCA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgcmV0dXJuIGlzQml0U2V0X2RlZmF1bHQodGhpcy5fYml0cywgY2hpbGRyZW5CaXRtYXNrc1tpbmRleF0pOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb24ucHJvdG90eXBlLmdldENoaWxkQml0bWFzayA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLl9iaXRzICYgYW55Q2hpbGRCaXRtYXNrOwogICAgICB9OwogICAgICBHb29nbGVFYXJ0aEVudGVycHJpc2VUaWxlSW5mb3JtYXRpb25fZGVmYXVsdCA9IEdvb2dsZUVhcnRoRW50ZXJwcmlzZVRpbGVJbmZvcm1hdGlvbjsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvYWRsZXIzMi5qcwogIHZhciByZXF1aXJlX2FkbGVyMzIgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9hZGxlcjMyLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIGFkbGVyMzIgPSAoYWRsZXIsIGJ1ZiwgbGVuLCBwb3MpID0+IHsKICAgICAgICBsZXQgczEgPSBhZGxlciAmIDY1NTM1IHwgMCwgczIgPSBhZGxlciA+Pj4gMTYgJiA2NTUzNSB8IDAsIG4gPSAwOwogICAgICAgIHdoaWxlIChsZW4gIT09IDApIHsKICAgICAgICAgIG4gPSBsZW4gPiAyZTMgPyAyZTMgOiBsZW47CiAgICAgICAgICBsZW4gLT0gbjsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgczEgPSBzMSArIGJ1Zltwb3MrK10gfCAwOwogICAgICAgICAgICBzMiA9IHMyICsgczEgfCAwOwogICAgICAgICAgfSB3aGlsZSAoLS1uKTsKICAgICAgICAgIHMxICU9IDY1NTIxOwogICAgICAgICAgczIgJT0gNjU1MjE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzMSB8IHMyIDw8IDE2IHwgMDsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBhZGxlcjMyOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9jcmMzMi5qcwogIHZhciByZXF1aXJlX2NyYzMyID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvY3JjMzIuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgbWFrZVRhYmxlID0gKCkgPT4gewogICAgICAgIGxldCBjLCB0YWJsZSA9IFtdOwogICAgICAgIGZvciAodmFyIG4gPSAwOyBuIDwgMjU2OyBuKyspIHsKICAgICAgICAgIGMgPSBuOwogICAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCA4OyBrKyspIHsKICAgICAgICAgICAgYyA9IGMgJiAxID8gMzk4ODI5MjM4NCBeIGMgPj4+IDEgOiBjID4+PiAxOwogICAgICAgICAgfQogICAgICAgICAgdGFibGVbbl0gPSBjOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGFibGU7CiAgICAgIH07CiAgICAgIHZhciBjcmNUYWJsZSA9IG5ldyBVaW50MzJBcnJheShtYWtlVGFibGUoKSk7CiAgICAgIHZhciBjcmMzMiA9IChjcmMsIGJ1ZiwgbGVuLCBwb3MpID0+IHsKICAgICAgICBjb25zdCB0ID0gY3JjVGFibGU7CiAgICAgICAgY29uc3QgZW5kID0gcG9zICsgbGVuOwogICAgICAgIGNyYyBePSAtMTsKICAgICAgICBmb3IgKGxldCBpID0gcG9zOyBpIDwgZW5kOyBpKyspIHsKICAgICAgICAgIGNyYyA9IGNyYyA+Pj4gOCBeIHRbKGNyYyBeIGJ1ZltpXSkgJiAyNTVdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY3JjIF4gLTE7CiAgICAgIH07CiAgICAgIG1vZHVsZS5leHBvcnRzID0gY3JjMzI7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2luZmZhc3QuanMKICB2YXIgcmVxdWlyZV9pbmZmYXN0ID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvaW5mZmFzdC5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIHZhciBCQUQgPSAxNjIwOTsKICAgICAgdmFyIFRZUEUgPSAxNjE5MTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpbmZsYXRlX2Zhc3Qoc3RybSwgc3RhcnQpIHsKICAgICAgICBsZXQgX2luOwogICAgICAgIGxldCBsYXN0OwogICAgICAgIGxldCBfb3V0OwogICAgICAgIGxldCBiZWc7CiAgICAgICAgbGV0IGVuZDsKICAgICAgICBsZXQgZG1heDsKICAgICAgICBsZXQgd3NpemU7CiAgICAgICAgbGV0IHdoYXZlOwogICAgICAgIGxldCB3bmV4dDsKICAgICAgICBsZXQgc193aW5kb3c7CiAgICAgICAgbGV0IGhvbGQ7CiAgICAgICAgbGV0IGJpdHM7CiAgICAgICAgbGV0IGxjb2RlOwogICAgICAgIGxldCBkY29kZTsKICAgICAgICBsZXQgbG1hc2s7CiAgICAgICAgbGV0IGRtYXNrOwogICAgICAgIGxldCBoZXJlOwogICAgICAgIGxldCBvcDsKICAgICAgICBsZXQgbGVuOwogICAgICAgIGxldCBkaXN0OwogICAgICAgIGxldCBmcm9tOwogICAgICAgIGxldCBmcm9tX3NvdXJjZTsKICAgICAgICBsZXQgaW5wdXQsIG91dHB1dDsKICAgICAgICBjb25zdCBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgX2luID0gc3RybS5uZXh0X2luOwogICAgICAgIGlucHV0ID0gc3RybS5pbnB1dDsKICAgICAgICBsYXN0ID0gX2luICsgKHN0cm0uYXZhaWxfaW4gLSA1KTsKICAgICAgICBfb3V0ID0gc3RybS5uZXh0X291dDsKICAgICAgICBvdXRwdXQgPSBzdHJtLm91dHB1dDsKICAgICAgICBiZWcgPSBfb3V0IC0gKHN0YXJ0IC0gc3RybS5hdmFpbF9vdXQpOwogICAgICAgIGVuZCA9IF9vdXQgKyAoc3RybS5hdmFpbF9vdXQgLSAyNTcpOwogICAgICAgIGRtYXggPSBzdGF0ZS5kbWF4OwogICAgICAgIHdzaXplID0gc3RhdGUud3NpemU7CiAgICAgICAgd2hhdmUgPSBzdGF0ZS53aGF2ZTsKICAgICAgICB3bmV4dCA9IHN0YXRlLnduZXh0OwogICAgICAgIHNfd2luZG93ID0gc3RhdGUud2luZG93OwogICAgICAgIGhvbGQgPSBzdGF0ZS5ob2xkOwogICAgICAgIGJpdHMgPSBzdGF0ZS5iaXRzOwogICAgICAgIGxjb2RlID0gc3RhdGUubGVuY29kZTsKICAgICAgICBkY29kZSA9IHN0YXRlLmRpc3Rjb2RlOwogICAgICAgIGxtYXNrID0gKDEgPDwgc3RhdGUubGVuYml0cykgLSAxOwogICAgICAgIGRtYXNrID0gKDEgPDwgc3RhdGUuZGlzdGJpdHMpIC0gMTsKICAgICAgICB0b3A6CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGlmIChiaXRzIDwgMTUpIHsKICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgfQogICAgICAgICAgICBoZXJlID0gbGNvZGVbaG9sZCAmIGxtYXNrXTsKICAgICAgICAgICAgZG9sZW46CiAgICAgICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgICAgICBvcCA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgaG9sZCA+Pj49IG9wOwogICAgICAgICAgICAgICAgYml0cyAtPSBvcDsKICAgICAgICAgICAgICAgIG9wID0gaGVyZSA+Pj4gMTYgJiAyNTU7CiAgICAgICAgICAgICAgICBpZiAob3AgPT09IDApIHsKICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBoZXJlICYgNjU1MzU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wICYgMTYpIHsKICAgICAgICAgICAgICAgICAgbGVuID0gaGVyZSAmIDY1NTM1OwogICAgICAgICAgICAgICAgICBvcCAmPSAxNTsKICAgICAgICAgICAgICAgICAgaWYgKG9wKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpdHMgPCBvcCkgewogICAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtfaW4rK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGVuICs9IGhvbGQgJiAoMSA8PCBvcCkgLSAxOwogICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBvcDsKICAgICAgICAgICAgICAgICAgICBiaXRzIC09IG9wOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChiaXRzIDwgMTUpIHsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoZXJlID0gZGNvZGVbaG9sZCAmIGRtYXNrXTsKICAgICAgICAgICAgICAgICAgZG9kaXN0OgogICAgICAgICAgICAgICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgICAgICAgICAgICAgb3AgPSBoZXJlID4+PiAyNDsKICAgICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBvcDsKICAgICAgICAgICAgICAgICAgICAgIGJpdHMgLT0gb3A7CiAgICAgICAgICAgICAgICAgICAgICBvcCA9IGhlcmUgPj4+IDE2ICYgMjU1OwogICAgICAgICAgICAgICAgICAgICAgaWYgKG9wICYgMTYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlzdCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgICAgICAgb3AgJj0gMTU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiaXRzIDwgb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYml0cyA8IG9wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W19pbisrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBkaXN0ICs9IGhvbGQgJiAoMSA8PCBvcCkgLSAxOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdCA+IGRtYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGRpc3RhbmNlIHRvbyBmYXIgYmFjayI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayB0b3A7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IG9wOwogICAgICAgICAgICAgICAgICAgICAgICBiaXRzIC09IG9wOwogICAgICAgICAgICAgICAgICAgICAgICBvcCA9IF9vdXQgLSBiZWc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXN0ID4gb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBvcCA9IGRpc3QgLSBvcDsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3AgPiB3aGF2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLnNhbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBkaXN0YW5jZSB0b28gZmFyIGJhY2siOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayB0b3A7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgIGZyb21fc291cmNlID0gc193aW5kb3c7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHduZXh0ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tICs9IHdzaXplIC0gb3A7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3AgPCBsZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuIC09IG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBzX3dpbmRvd1tmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgtLW9wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSA9IF9vdXQgLSBkaXN0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tX3NvdXJjZSA9IG91dHB1dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHduZXh0IDwgb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gKz0gd3NpemUgKyB3bmV4dCAtIG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3AgLT0gd25leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3AgPCBsZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuIC09IG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBzX3dpbmRvd1tmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgtLW9wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3bmV4dCA8IGxlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wID0gd25leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuIC09IG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gc193aW5kb3dbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlICgtLW9wKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tID0gX291dCAtIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbV9zb3VyY2UgPSBvdXRwdXQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSArPSB3bmV4dCAtIG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wIDwgbGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbiAtPSBvcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gc193aW5kb3dbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoLS1vcCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gPSBfb3V0IC0gZGlzdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbV9zb3VyY2UgPSBvdXRwdXQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChsZW4gPiAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IGZyb21fc291cmNlW2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IGZyb21fc291cmNlW2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IGZyb21fc291cmNlW2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW4gLT0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBmcm9tX3NvdXJjZVtmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxlbiA+IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBmcm9tX3NvdXJjZVtmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tID0gX291dCAtIGRpc3Q7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBvdXRwdXRbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gb3V0cHV0W2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXRbX291dCsrXSA9IG91dHB1dFtmcm9tKytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuIC09IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAobGVuID4gMik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0W19vdXQrK10gPSBvdXRwdXRbZnJvbSsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsZW4gPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dFtfb3V0KytdID0gb3V0cHV0W2Zyb20rK107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChvcCAmIDY0KSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBoZXJlID0gZGNvZGVbKGhlcmUgJiA2NTUzNSkgKyAoaG9sZCAmICgxIDw8IG9wKSAtIDEpXTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUgZG9kaXN0OwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBkaXN0YW5jZSBjb2RlIjsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgdG9wOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgob3AgJiA2NCkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgaGVyZSA9IGxjb2RlWyhoZXJlICYgNjU1MzUpICsgKGhvbGQgJiAoMSA8PCBvcCkgLSAxKV07CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlIGRvbGVuOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcCAmIDMyKSB7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBUWVBFOwogICAgICAgICAgICAgICAgICBicmVhayB0b3A7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGxpdGVyYWwvbGVuZ3RoIGNvZGUiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhayB0b3A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9IHdoaWxlIChfaW4gPCBsYXN0ICYmIF9vdXQgPCBlbmQpOwogICAgICAgIGxlbiA9IGJpdHMgPj4gMzsKICAgICAgICBfaW4gLT0gbGVuOwogICAgICAgIGJpdHMgLT0gbGVuIDw8IDM7CiAgICAgICAgaG9sZCAmPSAoMSA8PCBiaXRzKSAtIDE7CiAgICAgICAgc3RybS5uZXh0X2luID0gX2luOwogICAgICAgIHN0cm0ubmV4dF9vdXQgPSBfb3V0OwogICAgICAgIHN0cm0uYXZhaWxfaW4gPSBfaW4gPCBsYXN0ID8gNSArIChsYXN0IC0gX2luKSA6IDUgLSAoX2luIC0gbGFzdCk7CiAgICAgICAgc3RybS5hdmFpbF9vdXQgPSBfb3V0IDwgZW5kID8gMjU3ICsgKGVuZCAtIF9vdXQpIDogMjU3IC0gKF9vdXQgLSBlbmQpOwogICAgICAgIHN0YXRlLmhvbGQgPSBob2xkOwogICAgICAgIHN0YXRlLmJpdHMgPSBiaXRzOwogICAgICAgIHJldHVybjsKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvaW5mdHJlZXMuanMKICB2YXIgcmVxdWlyZV9pbmZ0cmVlcyA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2luZnRyZWVzLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIE1BWEJJVFMgPSAxNTsKICAgICAgdmFyIEVOT1VHSF9MRU5TID0gODUyOwogICAgICB2YXIgRU5PVUdIX0RJU1RTID0gNTkyOwogICAgICB2YXIgQ09ERVMgPSAwOwogICAgICB2YXIgTEVOUyA9IDE7CiAgICAgIHZhciBESVNUUyA9IDI7CiAgICAgIHZhciBsYmFzZSA9IG5ldyBVaW50MTZBcnJheShbCiAgICAgICAgLyogTGVuZ3RoIGNvZGVzIDI1Ny4uMjg1IGJhc2UgKi8KICAgICAgICAzLAogICAgICAgIDQsCiAgICAgICAgNSwKICAgICAgICA2LAogICAgICAgIDcsCiAgICAgICAgOCwKICAgICAgICA5LAogICAgICAgIDEwLAogICAgICAgIDExLAogICAgICAgIDEzLAogICAgICAgIDE1LAogICAgICAgIDE3LAogICAgICAgIDE5LAogICAgICAgIDIzLAogICAgICAgIDI3LAogICAgICAgIDMxLAogICAgICAgIDM1LAogICAgICAgIDQzLAogICAgICAgIDUxLAogICAgICAgIDU5LAogICAgICAgIDY3LAogICAgICAgIDgzLAogICAgICAgIDk5LAogICAgICAgIDExNSwKICAgICAgICAxMzEsCiAgICAgICAgMTYzLAogICAgICAgIDE5NSwKICAgICAgICAyMjcsCiAgICAgICAgMjU4LAogICAgICAgIDAsCiAgICAgICAgMAogICAgICBdKTsKICAgICAgdmFyIGxleHQgPSBuZXcgVWludDhBcnJheShbCiAgICAgICAgLyogTGVuZ3RoIGNvZGVzIDI1Ny4uMjg1IGV4dHJhICovCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTcsCiAgICAgICAgMTcsCiAgICAgICAgMTcsCiAgICAgICAgMTcsCiAgICAgICAgMTgsCiAgICAgICAgMTgsCiAgICAgICAgMTgsCiAgICAgICAgMTgsCiAgICAgICAgMTksCiAgICAgICAgMTksCiAgICAgICAgMTksCiAgICAgICAgMTksCiAgICAgICAgMjAsCiAgICAgICAgMjAsCiAgICAgICAgMjAsCiAgICAgICAgMjAsCiAgICAgICAgMjEsCiAgICAgICAgMjEsCiAgICAgICAgMjEsCiAgICAgICAgMjEsCiAgICAgICAgMTYsCiAgICAgICAgNzIsCiAgICAgICAgNzgKICAgICAgXSk7CiAgICAgIHZhciBkYmFzZSA9IG5ldyBVaW50MTZBcnJheShbCiAgICAgICAgLyogRGlzdGFuY2UgY29kZXMgMC4uMjkgYmFzZSAqLwogICAgICAgIDEsCiAgICAgICAgMiwKICAgICAgICAzLAogICAgICAgIDQsCiAgICAgICAgNSwKICAgICAgICA3LAogICAgICAgIDksCiAgICAgICAgMTMsCiAgICAgICAgMTcsCiAgICAgICAgMjUsCiAgICAgICAgMzMsCiAgICAgICAgNDksCiAgICAgICAgNjUsCiAgICAgICAgOTcsCiAgICAgICAgMTI5LAogICAgICAgIDE5MywKICAgICAgICAyNTcsCiAgICAgICAgMzg1LAogICAgICAgIDUxMywKICAgICAgICA3NjksCiAgICAgICAgMTAyNSwKICAgICAgICAxNTM3LAogICAgICAgIDIwNDksCiAgICAgICAgMzA3MywKICAgICAgICA0MDk3LAogICAgICAgIDYxNDUsCiAgICAgICAgODE5MywKICAgICAgICAxMjI4OSwKICAgICAgICAxNjM4NSwKICAgICAgICAyNDU3NywKICAgICAgICAwLAogICAgICAgIDAKICAgICAgXSk7CiAgICAgIHZhciBkZXh0ID0gbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIC8qIERpc3RhbmNlIGNvZGVzIDAuLjI5IGV4dHJhICovCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTYsCiAgICAgICAgMTcsCiAgICAgICAgMTcsCiAgICAgICAgMTgsCiAgICAgICAgMTgsCiAgICAgICAgMTksCiAgICAgICAgMTksCiAgICAgICAgMjAsCiAgICAgICAgMjAsCiAgICAgICAgMjEsCiAgICAgICAgMjEsCiAgICAgICAgMjIsCiAgICAgICAgMjIsCiAgICAgICAgMjMsCiAgICAgICAgMjMsCiAgICAgICAgMjQsCiAgICAgICAgMjQsCiAgICAgICAgMjUsCiAgICAgICAgMjUsCiAgICAgICAgMjYsCiAgICAgICAgMjYsCiAgICAgICAgMjcsCiAgICAgICAgMjcsCiAgICAgICAgMjgsCiAgICAgICAgMjgsCiAgICAgICAgMjksCiAgICAgICAgMjksCiAgICAgICAgNjQsCiAgICAgICAgNjQKICAgICAgXSk7CiAgICAgIHZhciBpbmZsYXRlX3RhYmxlID0gKHR5cGUsIGxlbnMsIGxlbnNfaW5kZXgsIGNvZGVzLCB0YWJsZSwgdGFibGVfaW5kZXgsIHdvcmssIG9wdHMpID0+IHsKICAgICAgICBjb25zdCBiaXRzID0gb3B0cy5iaXRzOwogICAgICAgIGxldCBsZW4gPSAwOwogICAgICAgIGxldCBzeW0gPSAwOwogICAgICAgIGxldCBtaW4zID0gMCwgbWF4MyA9IDA7CiAgICAgICAgbGV0IHJvb3QgPSAwOwogICAgICAgIGxldCBjdXJyID0gMDsKICAgICAgICBsZXQgZHJvcCA9IDA7CiAgICAgICAgbGV0IGxlZnQgPSAwOwogICAgICAgIGxldCB1c2VkID0gMDsKICAgICAgICBsZXQgaHVmZiA9IDA7CiAgICAgICAgbGV0IGluY3I7CiAgICAgICAgbGV0IGZpbGw7CiAgICAgICAgbGV0IGxvdzsKICAgICAgICBsZXQgbWFzazsKICAgICAgICBsZXQgbmV4dDsKICAgICAgICBsZXQgYmFzZSA9IG51bGw7CiAgICAgICAgbGV0IG1hdGNoOwogICAgICAgIGNvbnN0IGNvdW50ID0gbmV3IFVpbnQxNkFycmF5KE1BWEJJVFMgKyAxKTsKICAgICAgICBjb25zdCBvZmZzID0gbmV3IFVpbnQxNkFycmF5KE1BWEJJVFMgKyAxKTsKICAgICAgICBsZXQgZXh0cmEgPSBudWxsOwogICAgICAgIGxldCBoZXJlX2JpdHMsIGhlcmVfb3AsIGhlcmVfdmFsOwogICAgICAgIGZvciAobGVuID0gMDsgbGVuIDw9IE1BWEJJVFM7IGxlbisrKSB7CiAgICAgICAgICBjb3VudFtsZW5dID0gMDsKICAgICAgICB9CiAgICAgICAgZm9yIChzeW0gPSAwOyBzeW0gPCBjb2Rlczsgc3ltKyspIHsKICAgICAgICAgIGNvdW50W2xlbnNbbGVuc19pbmRleCArIHN5bV1dKys7CiAgICAgICAgfQogICAgICAgIHJvb3QgPSBiaXRzOwogICAgICAgIGZvciAobWF4MyA9IE1BWEJJVFM7IG1heDMgPj0gMTsgbWF4My0tKSB7CiAgICAgICAgICBpZiAoY291bnRbbWF4M10gIT09IDApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChyb290ID4gbWF4MykgewogICAgICAgICAgcm9vdCA9IG1heDM7CiAgICAgICAgfQogICAgICAgIGlmIChtYXgzID09PSAwKSB7CiAgICAgICAgICB0YWJsZVt0YWJsZV9pbmRleCsrXSA9IDEgPDwgMjQgfCA2NCA8PCAxNiB8IDA7CiAgICAgICAgICB0YWJsZVt0YWJsZV9pbmRleCsrXSA9IDEgPDwgMjQgfCA2NCA8PCAxNiB8IDA7CiAgICAgICAgICBvcHRzLmJpdHMgPSAxOwogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIGZvciAobWluMyA9IDE7IG1pbjMgPCBtYXgzOyBtaW4zKyspIHsKICAgICAgICAgIGlmIChjb3VudFttaW4zXSAhPT0gMCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJvb3QgPCBtaW4zKSB7CiAgICAgICAgICByb290ID0gbWluMzsKICAgICAgICB9CiAgICAgICAgbGVmdCA9IDE7CiAgICAgICAgZm9yIChsZW4gPSAxOyBsZW4gPD0gTUFYQklUUzsgbGVuKyspIHsKICAgICAgICAgIGxlZnQgPDw9IDE7CiAgICAgICAgICBsZWZ0IC09IGNvdW50W2xlbl07CiAgICAgICAgICBpZiAobGVmdCA8IDApIHsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobGVmdCA+IDAgJiYgKHR5cGUgPT09IENPREVTIHx8IG1heDMgIT09IDEpKSB7CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICAgIG9mZnNbMV0gPSAwOwogICAgICAgIGZvciAobGVuID0gMTsgbGVuIDwgTUFYQklUUzsgbGVuKyspIHsKICAgICAgICAgIG9mZnNbbGVuICsgMV0gPSBvZmZzW2xlbl0gKyBjb3VudFtsZW5dOwogICAgICAgIH0KICAgICAgICBmb3IgKHN5bSA9IDA7IHN5bSA8IGNvZGVzOyBzeW0rKykgewogICAgICAgICAgaWYgKGxlbnNbbGVuc19pbmRleCArIHN5bV0gIT09IDApIHsKICAgICAgICAgICAgd29ya1tvZmZzW2xlbnNbbGVuc19pbmRleCArIHN5bV1dKytdID0gc3ltOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodHlwZSA9PT0gQ09ERVMpIHsKICAgICAgICAgIGJhc2UgPSBleHRyYSA9IHdvcms7CiAgICAgICAgICBtYXRjaCA9IDIwOwogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gTEVOUykgewogICAgICAgICAgYmFzZSA9IGxiYXNlOwogICAgICAgICAgZXh0cmEgPSBsZXh0OwogICAgICAgICAgbWF0Y2ggPSAyNTc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2UgPSBkYmFzZTsKICAgICAgICAgIGV4dHJhID0gZGV4dDsKICAgICAgICAgIG1hdGNoID0gMDsKICAgICAgICB9CiAgICAgICAgaHVmZiA9IDA7CiAgICAgICAgc3ltID0gMDsKICAgICAgICBsZW4gPSBtaW4zOwogICAgICAgIG5leHQgPSB0YWJsZV9pbmRleDsKICAgICAgICBjdXJyID0gcm9vdDsKICAgICAgICBkcm9wID0gMDsKICAgICAgICBsb3cgPSAtMTsKICAgICAgICB1c2VkID0gMSA8PCByb290OwogICAgICAgIG1hc2sgPSB1c2VkIC0gMTsKICAgICAgICBpZiAodHlwZSA9PT0gTEVOUyAmJiB1c2VkID4gRU5PVUdIX0xFTlMgfHwgdHlwZSA9PT0gRElTVFMgJiYgdXNlZCA+IEVOT1VHSF9ESVNUUykgewogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfQogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgaGVyZV9iaXRzID0gbGVuIC0gZHJvcDsKICAgICAgICAgIGlmICh3b3JrW3N5bV0gKyAxIDwgbWF0Y2gpIHsKICAgICAgICAgICAgaGVyZV9vcCA9IDA7CiAgICAgICAgICAgIGhlcmVfdmFsID0gd29ya1tzeW1dOwogICAgICAgICAgfSBlbHNlIGlmICh3b3JrW3N5bV0gPj0gbWF0Y2gpIHsKICAgICAgICAgICAgaGVyZV9vcCA9IGV4dHJhW3dvcmtbc3ltXSAtIG1hdGNoXTsKICAgICAgICAgICAgaGVyZV92YWwgPSBiYXNlW3dvcmtbc3ltXSAtIG1hdGNoXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhlcmVfb3AgPSAzMiArIDY0OwogICAgICAgICAgICBoZXJlX3ZhbCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBpbmNyID0gMSA8PCBsZW4gLSBkcm9wOwogICAgICAgICAgZmlsbCA9IDEgPDwgY3VycjsKICAgICAgICAgIG1pbjMgPSBmaWxsOwogICAgICAgICAgZG8gewogICAgICAgICAgICBmaWxsIC09IGluY3I7CiAgICAgICAgICAgIHRhYmxlW25leHQgKyAoaHVmZiA+PiBkcm9wKSArIGZpbGxdID0gaGVyZV9iaXRzIDw8IDI0IHwgaGVyZV9vcCA8PCAxNiB8IGhlcmVfdmFsIHwgMDsKICAgICAgICAgIH0gd2hpbGUgKGZpbGwgIT09IDApOwogICAgICAgICAgaW5jciA9IDEgPDwgbGVuIC0gMTsKICAgICAgICAgIHdoaWxlIChodWZmICYgaW5jcikgewogICAgICAgICAgICBpbmNyID4+PSAxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGluY3IgIT09IDApIHsKICAgICAgICAgICAgaHVmZiAmPSBpbmNyIC0gMTsKICAgICAgICAgICAgaHVmZiArPSBpbmNyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaHVmZiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBzeW0rKzsKICAgICAgICAgIGlmICgtLWNvdW50W2xlbl0gPT09IDApIHsKICAgICAgICAgICAgaWYgKGxlbiA9PT0gbWF4MykgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxlbiA9IGxlbnNbbGVuc19pbmRleCArIHdvcmtbc3ltXV07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobGVuID4gcm9vdCAmJiAoaHVmZiAmIG1hc2spICE9PSBsb3cpIHsKICAgICAgICAgICAgaWYgKGRyb3AgPT09IDApIHsKICAgICAgICAgICAgICBkcm9wID0gcm9vdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0ICs9IG1pbjM7CiAgICAgICAgICAgIGN1cnIgPSBsZW4gLSBkcm9wOwogICAgICAgICAgICBsZWZ0ID0gMSA8PCBjdXJyOwogICAgICAgICAgICB3aGlsZSAoY3VyciArIGRyb3AgPCBtYXgzKSB7CiAgICAgICAgICAgICAgbGVmdCAtPSBjb3VudFtjdXJyICsgZHJvcF07CiAgICAgICAgICAgICAgaWYgKGxlZnQgPD0gMCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnIrKzsKICAgICAgICAgICAgICBsZWZ0IDw8PSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVzZWQgKz0gMSA8PCBjdXJyOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gTEVOUyAmJiB1c2VkID4gRU5PVUdIX0xFTlMgfHwgdHlwZSA9PT0gRElTVFMgJiYgdXNlZCA+IEVOT1VHSF9ESVNUUykgewogICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxvdyA9IGh1ZmYgJiBtYXNrOwogICAgICAgICAgICB0YWJsZVtsb3ddID0gcm9vdCA8PCAyNCB8IGN1cnIgPDwgMTYgfCBuZXh0IC0gdGFibGVfaW5kZXggfCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaHVmZiAhPT0gMCkgewogICAgICAgICAgdGFibGVbbmV4dCArIGh1ZmZdID0gbGVuIC0gZHJvcCA8PCAyNCB8IDY0IDw8IDE2IHwgMDsKICAgICAgICB9CiAgICAgICAgb3B0cy5iaXRzID0gcm9vdDsKICAgICAgICByZXR1cm4gMDsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBpbmZsYXRlX3RhYmxlOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9jb25zdGFudHMuanMKICB2YXIgcmVxdWlyZV9jb25zdGFudHMgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9jb25zdGFudHMuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgICAvKiBBbGxvd2VkIGZsdXNoIHZhbHVlczsgc2VlIGRlZmxhdGUoKSBhbmQgaW5mbGF0ZSgpIGJlbG93IGZvciBkZXRhaWxzICovCiAgICAgICAgWl9OT19GTFVTSDogMCwKICAgICAgICBaX1BBUlRJQUxfRkxVU0g6IDEsCiAgICAgICAgWl9TWU5DX0ZMVVNIOiAyLAogICAgICAgIFpfRlVMTF9GTFVTSDogMywKICAgICAgICBaX0ZJTklTSDogNCwKICAgICAgICBaX0JMT0NLOiA1LAogICAgICAgIFpfVFJFRVM6IDYsCiAgICAgICAgLyogUmV0dXJuIGNvZGVzIGZvciB0aGUgY29tcHJlc3Npb24vZGVjb21wcmVzc2lvbiBmdW5jdGlvbnMuIE5lZ2F0aXZlIHZhbHVlcwogICAgICAgICogYXJlIGVycm9ycywgcG9zaXRpdmUgdmFsdWVzIGFyZSB1c2VkIGZvciBzcGVjaWFsIGJ1dCBub3JtYWwgZXZlbnRzLgogICAgICAgICovCiAgICAgICAgWl9PSzogMCwKICAgICAgICBaX1NUUkVBTV9FTkQ6IDEsCiAgICAgICAgWl9ORUVEX0RJQ1Q6IDIsCiAgICAgICAgWl9FUlJOTzogLTEsCiAgICAgICAgWl9TVFJFQU1fRVJST1I6IC0yLAogICAgICAgIFpfREFUQV9FUlJPUjogLTMsCiAgICAgICAgWl9NRU1fRVJST1I6IC00LAogICAgICAgIFpfQlVGX0VSUk9SOiAtNSwKICAgICAgICAvL1pfVkVSU0lPTl9FUlJPUjogLTYsCiAgICAgICAgLyogY29tcHJlc3Npb24gbGV2ZWxzICovCiAgICAgICAgWl9OT19DT01QUkVTU0lPTjogMCwKICAgICAgICBaX0JFU1RfU1BFRUQ6IDEsCiAgICAgICAgWl9CRVNUX0NPTVBSRVNTSU9OOiA5LAogICAgICAgIFpfREVGQVVMVF9DT01QUkVTU0lPTjogLTEsCiAgICAgICAgWl9GSUxURVJFRDogMSwKICAgICAgICBaX0hVRkZNQU5fT05MWTogMiwKICAgICAgICBaX1JMRTogMywKICAgICAgICBaX0ZJWEVEOiA0LAogICAgICAgIFpfREVGQVVMVF9TVFJBVEVHWTogMCwKICAgICAgICAvKiBQb3NzaWJsZSB2YWx1ZXMgb2YgdGhlIGRhdGFfdHlwZSBmaWVsZCAodGhvdWdoIHNlZSBpbmZsYXRlKCkpICovCiAgICAgICAgWl9CSU5BUlk6IDAsCiAgICAgICAgWl9URVhUOiAxLAogICAgICAgIC8vWl9BU0NJSTogICAgICAgICAgICAgICAgMSwgLy8gPSBaX1RFWFQgKGRlcHJlY2F0ZWQpCiAgICAgICAgWl9VTktOT1dOOiAyLAogICAgICAgIC8qIFRoZSBkZWZsYXRlIGNvbXByZXNzaW9uIG1ldGhvZCAqLwogICAgICAgIFpfREVGTEFURUQ6IDgKICAgICAgICAvL1pfTlVMTDogICAgICAgICAgICAgICAgIG51bGwgLy8gVXNlIC0xIG9yIG51bGwgaW5saW5lLCBkZXBlbmRpbmcgb24gdmFyIHR5cGUKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvaW5mbGF0ZS5qcwogIHZhciByZXF1aXJlX2luZmxhdGUgPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi9pbmZsYXRlLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIGFkbGVyMzIgPSByZXF1aXJlX2FkbGVyMzIoKTsKICAgICAgdmFyIGNyYzMyID0gcmVxdWlyZV9jcmMzMigpOwogICAgICB2YXIgaW5mbGF0ZV9mYXN0ID0gcmVxdWlyZV9pbmZmYXN0KCk7CiAgICAgIHZhciBpbmZsYXRlX3RhYmxlID0gcmVxdWlyZV9pbmZ0cmVlcygpOwogICAgICB2YXIgQ09ERVMgPSAwOwogICAgICB2YXIgTEVOUyA9IDE7CiAgICAgIHZhciBESVNUUyA9IDI7CiAgICAgIHZhciB7CiAgICAgICAgWl9GSU5JU0gsCiAgICAgICAgWl9CTE9DSywKICAgICAgICBaX1RSRUVTLAogICAgICAgIFpfT0ssCiAgICAgICAgWl9TVFJFQU1fRU5ELAogICAgICAgIFpfTkVFRF9ESUNULAogICAgICAgIFpfU1RSRUFNX0VSUk9SLAogICAgICAgIFpfREFUQV9FUlJPUiwKICAgICAgICBaX01FTV9FUlJPUiwKICAgICAgICBaX0JVRl9FUlJPUiwKICAgICAgICBaX0RFRkxBVEVECiAgICAgIH0gPSByZXF1aXJlX2NvbnN0YW50cygpOwogICAgICB2YXIgSEVBRCA9IDE2MTgwOwogICAgICB2YXIgRkxBR1MgPSAxNjE4MTsKICAgICAgdmFyIFRJTUUgPSAxNjE4MjsKICAgICAgdmFyIE9TID0gMTYxODM7CiAgICAgIHZhciBFWExFTiA9IDE2MTg0OwogICAgICB2YXIgRVhUUkEgPSAxNjE4NTsKICAgICAgdmFyIE5BTUUgPSAxNjE4NjsKICAgICAgdmFyIENPTU1FTlQgPSAxNjE4NzsKICAgICAgdmFyIEhDUkMgPSAxNjE4ODsKICAgICAgdmFyIERJQ1RJRCA9IDE2MTg5OwogICAgICB2YXIgRElDVCA9IDE2MTkwOwogICAgICB2YXIgVFlQRSA9IDE2MTkxOwogICAgICB2YXIgVFlQRURPID0gMTYxOTI7CiAgICAgIHZhciBTVE9SRUQgPSAxNjE5MzsKICAgICAgdmFyIENPUFlfID0gMTYxOTQ7CiAgICAgIHZhciBDT1BZID0gMTYxOTU7CiAgICAgIHZhciBUQUJMRSA9IDE2MTk2OwogICAgICB2YXIgTEVOTEVOUyA9IDE2MTk3OwogICAgICB2YXIgQ09ERUxFTlMgPSAxNjE5ODsKICAgICAgdmFyIExFTl8gPSAxNjE5OTsKICAgICAgdmFyIExFTiA9IDE2MjAwOwogICAgICB2YXIgTEVORVhUID0gMTYyMDE7CiAgICAgIHZhciBESVNUID0gMTYyMDI7CiAgICAgIHZhciBESVNURVhUID0gMTYyMDM7CiAgICAgIHZhciBNQVRDSCA9IDE2MjA0OwogICAgICB2YXIgTElUID0gMTYyMDU7CiAgICAgIHZhciBDSEVDSyA9IDE2MjA2OwogICAgICB2YXIgTEVOR1RIID0gMTYyMDc7CiAgICAgIHZhciBET05FID0gMTYyMDg7CiAgICAgIHZhciBCQUQgPSAxNjIwOTsKICAgICAgdmFyIE1FTSA9IDE2MjEwOwogICAgICB2YXIgU1lOQyA9IDE2MjExOwogICAgICB2YXIgRU5PVUdIX0xFTlMgPSA4NTI7CiAgICAgIHZhciBFTk9VR0hfRElTVFMgPSA1OTI7CiAgICAgIHZhciBNQVhfV0JJVFMgPSAxNTsKICAgICAgdmFyIERFRl9XQklUUyA9IE1BWF9XQklUUzsKICAgICAgdmFyIHpzd2FwMzIgPSAocSkgPT4gewogICAgICAgIHJldHVybiAocSA+Pj4gMjQgJiAyNTUpICsgKHEgPj4+IDggJiA2NTI4MCkgKyAoKHEgJiA2NTI4MCkgPDwgOCkgKyAoKHEgJiAyNTUpIDw8IDI0KTsKICAgICAgfTsKICAgICAgZnVuY3Rpb24gSW5mbGF0ZVN0YXRlKCkgewogICAgICAgIHRoaXMuc3RybSA9IG51bGw7CiAgICAgICAgdGhpcy5tb2RlID0gMDsKICAgICAgICB0aGlzLmxhc3QgPSBmYWxzZTsKICAgICAgICB0aGlzLndyYXAgPSAwOwogICAgICAgIHRoaXMuaGF2ZWRpY3QgPSBmYWxzZTsKICAgICAgICB0aGlzLmZsYWdzID0gMDsKICAgICAgICB0aGlzLmRtYXggPSAwOwogICAgICAgIHRoaXMuY2hlY2sgPSAwOwogICAgICAgIHRoaXMudG90YWwgPSAwOwogICAgICAgIHRoaXMuaGVhZCA9IG51bGw7CiAgICAgICAgdGhpcy53Yml0cyA9IDA7CiAgICAgICAgdGhpcy53c2l6ZSA9IDA7CiAgICAgICAgdGhpcy53aGF2ZSA9IDA7CiAgICAgICAgdGhpcy53bmV4dCA9IDA7CiAgICAgICAgdGhpcy53aW5kb3cgPSBudWxsOwogICAgICAgIHRoaXMuaG9sZCA9IDA7CiAgICAgICAgdGhpcy5iaXRzID0gMDsKICAgICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICAgIHRoaXMuZXh0cmEgPSAwOwogICAgICAgIHRoaXMubGVuY29kZSA9IG51bGw7CiAgICAgICAgdGhpcy5kaXN0Y29kZSA9IG51bGw7CiAgICAgICAgdGhpcy5sZW5iaXRzID0gMDsKICAgICAgICB0aGlzLmRpc3RiaXRzID0gMDsKICAgICAgICB0aGlzLm5jb2RlID0gMDsKICAgICAgICB0aGlzLm5sZW4gPSAwOwogICAgICAgIHRoaXMubmRpc3QgPSAwOwogICAgICAgIHRoaXMuaGF2ZSA9IDA7CiAgICAgICAgdGhpcy5uZXh0ID0gbnVsbDsKICAgICAgICB0aGlzLmxlbnMgPSBuZXcgVWludDE2QXJyYXkoMzIwKTsKICAgICAgICB0aGlzLndvcmsgPSBuZXcgVWludDE2QXJyYXkoMjg4KTsKICAgICAgICB0aGlzLmxlbmR5biA9IG51bGw7CiAgICAgICAgdGhpcy5kaXN0ZHluID0gbnVsbDsKICAgICAgICB0aGlzLnNhbmUgPSAwOwogICAgICAgIHRoaXMuYmFjayA9IDA7CiAgICAgICAgdGhpcy53YXMgPSAwOwogICAgICB9CiAgICAgIHZhciBpbmZsYXRlU3RhdGVDaGVjayA9IChzdHJtKSA9PiB7CiAgICAgICAgaWYgKCFzdHJtKSB7CiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc3RhdGUgPSBzdHJtLnN0YXRlOwogICAgICAgIGlmICghc3RhdGUgfHwgc3RhdGUuc3RybSAhPT0gc3RybSB8fCBzdGF0ZS5tb2RlIDwgSEVBRCB8fCBzdGF0ZS5tb2RlID4gU1lOQykgewogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgICB9OwogICAgICB2YXIgaW5mbGF0ZVJlc2V0S2VlcCA9IChzdHJtKSA9PiB7CiAgICAgICAgaWYgKGluZmxhdGVTdGF0ZUNoZWNrKHN0cm0pKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBzdHJtLnRvdGFsX2luID0gc3RybS50b3RhbF9vdXQgPSBzdGF0ZS50b3RhbCA9IDA7CiAgICAgICAgc3RybS5tc2cgPSAiIjsKICAgICAgICBpZiAoc3RhdGUud3JhcCkgewogICAgICAgICAgc3RybS5hZGxlciA9IHN0YXRlLndyYXAgJiAxOwogICAgICAgIH0KICAgICAgICBzdGF0ZS5tb2RlID0gSEVBRDsKICAgICAgICBzdGF0ZS5sYXN0ID0gMDsKICAgICAgICBzdGF0ZS5oYXZlZGljdCA9IDA7CiAgICAgICAgc3RhdGUuZmxhZ3MgPSAtMTsKICAgICAgICBzdGF0ZS5kbWF4ID0gMzI3Njg7CiAgICAgICAgc3RhdGUuaGVhZCA9IG51bGw7CiAgICAgICAgc3RhdGUuaG9sZCA9IDA7CiAgICAgICAgc3RhdGUuYml0cyA9IDA7CiAgICAgICAgc3RhdGUubGVuY29kZSA9IHN0YXRlLmxlbmR5biA9IG5ldyBJbnQzMkFycmF5KEVOT1VHSF9MRU5TKTsKICAgICAgICBzdGF0ZS5kaXN0Y29kZSA9IHN0YXRlLmRpc3RkeW4gPSBuZXcgSW50MzJBcnJheShFTk9VR0hfRElTVFMpOwogICAgICAgIHN0YXRlLnNhbmUgPSAxOwogICAgICAgIHN0YXRlLmJhY2sgPSAtMTsKICAgICAgICByZXR1cm4gWl9PSzsKICAgICAgfTsKICAgICAgdmFyIGluZmxhdGVSZXNldCA9IChzdHJtKSA9PiB7CiAgICAgICAgaWYgKGluZmxhdGVTdGF0ZUNoZWNrKHN0cm0pKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBzdGF0ZS53c2l6ZSA9IDA7CiAgICAgICAgc3RhdGUud2hhdmUgPSAwOwogICAgICAgIHN0YXRlLnduZXh0ID0gMDsKICAgICAgICByZXR1cm4gaW5mbGF0ZVJlc2V0S2VlcChzdHJtKTsKICAgICAgfTsKICAgICAgdmFyIGluZmxhdGVSZXNldDIgPSAoc3RybSwgd2luZG93Qml0cykgPT4gewogICAgICAgIGxldCB3cmFwOwogICAgICAgIGlmIChpbmZsYXRlU3RhdGVDaGVjayhzdHJtKSkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBjb25zdCBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgaWYgKHdpbmRvd0JpdHMgPCAwKSB7CiAgICAgICAgICB3cmFwID0gMDsKICAgICAgICAgIHdpbmRvd0JpdHMgPSAtd2luZG93Qml0czsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd3JhcCA9ICh3aW5kb3dCaXRzID4+IDQpICsgNTsKICAgICAgICAgIGlmICh3aW5kb3dCaXRzIDwgNDgpIHsKICAgICAgICAgICAgd2luZG93Qml0cyAmPSAxNTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHdpbmRvd0JpdHMgJiYgKHdpbmRvd0JpdHMgPCA4IHx8IHdpbmRvd0JpdHMgPiAxNSkpIHsKICAgICAgICAgIHJldHVybiBaX1NUUkVBTV9FUlJPUjsKICAgICAgICB9CiAgICAgICAgaWYgKHN0YXRlLndpbmRvdyAhPT0gbnVsbCAmJiBzdGF0ZS53Yml0cyAhPT0gd2luZG93Qml0cykgewogICAgICAgICAgc3RhdGUud2luZG93ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgc3RhdGUud3JhcCA9IHdyYXA7CiAgICAgICAgc3RhdGUud2JpdHMgPSB3aW5kb3dCaXRzOwogICAgICAgIHJldHVybiBpbmZsYXRlUmVzZXQoc3RybSk7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlSW5pdDIgPSAoc3RybSwgd2luZG93Qml0cykgPT4gewogICAgICAgIGlmICghc3RybSkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBjb25zdCBzdGF0ZSA9IG5ldyBJbmZsYXRlU3RhdGUoKTsKICAgICAgICBzdHJtLnN0YXRlID0gc3RhdGU7CiAgICAgICAgc3RhdGUuc3RybSA9IHN0cm07CiAgICAgICAgc3RhdGUud2luZG93ID0gbnVsbDsKICAgICAgICBzdGF0ZS5tb2RlID0gSEVBRDsKICAgICAgICBjb25zdCByZXQgPSBpbmZsYXRlUmVzZXQyKHN0cm0sIHdpbmRvd0JpdHMpOwogICAgICAgIGlmIChyZXQgIT09IFpfT0spIHsKICAgICAgICAgIHN0cm0uc3RhdGUgPSBudWxsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgICB9OwogICAgICB2YXIgaW5mbGF0ZUluaXQgPSAoc3RybSkgPT4gewogICAgICAgIHJldHVybiBpbmZsYXRlSW5pdDIoc3RybSwgREVGX1dCSVRTKTsKICAgICAgfTsKICAgICAgdmFyIHZpcmdpbiA9IHRydWU7CiAgICAgIHZhciBsZW5maXg7CiAgICAgIHZhciBkaXN0Zml4OwogICAgICB2YXIgZml4ZWR0YWJsZXMgPSAoc3RhdGUpID0+IHsKICAgICAgICBpZiAodmlyZ2luKSB7CiAgICAgICAgICBsZW5maXggPSBuZXcgSW50MzJBcnJheSg1MTIpOwogICAgICAgICAgZGlzdGZpeCA9IG5ldyBJbnQzMkFycmF5KDMyKTsKICAgICAgICAgIGxldCBzeW0gPSAwOwogICAgICAgICAgd2hpbGUgKHN5bSA8IDE0NCkgewogICAgICAgICAgICBzdGF0ZS5sZW5zW3N5bSsrXSA9IDg7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoc3ltIDwgMjU2KSB7CiAgICAgICAgICAgIHN0YXRlLmxlbnNbc3ltKytdID0gOTsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChzeW0gPCAyODApIHsKICAgICAgICAgICAgc3RhdGUubGVuc1tzeW0rK10gPSA3OwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHN5bSA8IDI4OCkgewogICAgICAgICAgICBzdGF0ZS5sZW5zW3N5bSsrXSA9IDg7CiAgICAgICAgICB9CiAgICAgICAgICBpbmZsYXRlX3RhYmxlKExFTlMsIHN0YXRlLmxlbnMsIDAsIDI4OCwgbGVuZml4LCAwLCBzdGF0ZS53b3JrLCB7IGJpdHM6IDkgfSk7CiAgICAgICAgICBzeW0gPSAwOwogICAgICAgICAgd2hpbGUgKHN5bSA8IDMyKSB7CiAgICAgICAgICAgIHN0YXRlLmxlbnNbc3ltKytdID0gNTsKICAgICAgICAgIH0KICAgICAgICAgIGluZmxhdGVfdGFibGUoRElTVFMsIHN0YXRlLmxlbnMsIDAsIDMyLCBkaXN0Zml4LCAwLCBzdGF0ZS53b3JrLCB7IGJpdHM6IDUgfSk7CiAgICAgICAgICB2aXJnaW4gPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgc3RhdGUubGVuY29kZSA9IGxlbmZpeDsKICAgICAgICBzdGF0ZS5sZW5iaXRzID0gOTsKICAgICAgICBzdGF0ZS5kaXN0Y29kZSA9IGRpc3RmaXg7CiAgICAgICAgc3RhdGUuZGlzdGJpdHMgPSA1OwogICAgICB9OwogICAgICB2YXIgdXBkYXRld2luZG93ID0gKHN0cm0sIHNyYywgZW5kLCBjb3B5KSA9PiB7CiAgICAgICAgbGV0IGRpc3Q7CiAgICAgICAgY29uc3Qgc3RhdGUgPSBzdHJtLnN0YXRlOwogICAgICAgIGlmIChzdGF0ZS53aW5kb3cgPT09IG51bGwpIHsKICAgICAgICAgIHN0YXRlLndzaXplID0gMSA8PCBzdGF0ZS53Yml0czsKICAgICAgICAgIHN0YXRlLnduZXh0ID0gMDsKICAgICAgICAgIHN0YXRlLndoYXZlID0gMDsKICAgICAgICAgIHN0YXRlLndpbmRvdyA9IG5ldyBVaW50OEFycmF5KHN0YXRlLndzaXplKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNvcHkgPj0gc3RhdGUud3NpemUpIHsKICAgICAgICAgIHN0YXRlLndpbmRvdy5zZXQoc3JjLnN1YmFycmF5KGVuZCAtIHN0YXRlLndzaXplLCBlbmQpLCAwKTsKICAgICAgICAgIHN0YXRlLnduZXh0ID0gMDsKICAgICAgICAgIHN0YXRlLndoYXZlID0gc3RhdGUud3NpemU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRpc3QgPSBzdGF0ZS53c2l6ZSAtIHN0YXRlLnduZXh0OwogICAgICAgICAgaWYgKGRpc3QgPiBjb3B5KSB7CiAgICAgICAgICAgIGRpc3QgPSBjb3B5OwogICAgICAgICAgfQogICAgICAgICAgc3RhdGUud2luZG93LnNldChzcmMuc3ViYXJyYXkoZW5kIC0gY29weSwgZW5kIC0gY29weSArIGRpc3QpLCBzdGF0ZS53bmV4dCk7CiAgICAgICAgICBjb3B5IC09IGRpc3Q7CiAgICAgICAgICBpZiAoY29weSkgewogICAgICAgICAgICBzdGF0ZS53aW5kb3cuc2V0KHNyYy5zdWJhcnJheShlbmQgLSBjb3B5LCBlbmQpLCAwKTsKICAgICAgICAgICAgc3RhdGUud25leHQgPSBjb3B5OwogICAgICAgICAgICBzdGF0ZS53aGF2ZSA9IHN0YXRlLndzaXplOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdGUud25leHQgKz0gZGlzdDsKICAgICAgICAgICAgaWYgKHN0YXRlLnduZXh0ID09PSBzdGF0ZS53c2l6ZSkgewogICAgICAgICAgICAgIHN0YXRlLnduZXh0ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3RhdGUud2hhdmUgPCBzdGF0ZS53c2l6ZSkgewogICAgICAgICAgICAgIHN0YXRlLndoYXZlICs9IGRpc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlID0gKHN0cm0sIGZsdXNoKSA9PiB7CiAgICAgICAgbGV0IHN0YXRlOwogICAgICAgIGxldCBpbnB1dCwgb3V0cHV0OwogICAgICAgIGxldCBuZXh0OwogICAgICAgIGxldCBwdXQ7CiAgICAgICAgbGV0IGhhdmUsIGxlZnQ7CiAgICAgICAgbGV0IGhvbGQ7CiAgICAgICAgbGV0IGJpdHM7CiAgICAgICAgbGV0IF9pbiwgX291dDsKICAgICAgICBsZXQgY29weTsKICAgICAgICBsZXQgZnJvbTsKICAgICAgICBsZXQgZnJvbV9zb3VyY2U7CiAgICAgICAgbGV0IGhlcmUgPSAwOwogICAgICAgIGxldCBoZXJlX2JpdHMsIGhlcmVfb3AsIGhlcmVfdmFsOwogICAgICAgIGxldCBsYXN0X2JpdHMsIGxhc3Rfb3AsIGxhc3RfdmFsOwogICAgICAgIGxldCBsZW47CiAgICAgICAgbGV0IHJldDsKICAgICAgICBjb25zdCBoYnVmID0gbmV3IFVpbnQ4QXJyYXkoNCk7CiAgICAgICAgbGV0IG9wdHM7CiAgICAgICAgbGV0IG47CiAgICAgICAgY29uc3Qgb3JkZXIgPSAoCiAgICAgICAgICAvKiBwZXJtdXRhdGlvbiBvZiBjb2RlIGxlbmd0aHMgKi8KICAgICAgICAgIG5ldyBVaW50OEFycmF5KFsxNiwgMTcsIDE4LCAwLCA4LCA3LCA5LCA2LCAxMCwgNSwgMTEsIDQsIDEyLCAzLCAxMywgMiwgMTQsIDEsIDE1XSkKICAgICAgICApOwogICAgICAgIGlmIChpbmZsYXRlU3RhdGVDaGVjayhzdHJtKSB8fCAhc3RybS5vdXRwdXQgfHwgIXN0cm0uaW5wdXQgJiYgc3RybS5hdmFpbF9pbiAhPT0gMCkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgaWYgKHN0YXRlLm1vZGUgPT09IFRZUEUpIHsKICAgICAgICAgIHN0YXRlLm1vZGUgPSBUWVBFRE87CiAgICAgICAgfQogICAgICAgIHB1dCA9IHN0cm0ubmV4dF9vdXQ7CiAgICAgICAgb3V0cHV0ID0gc3RybS5vdXRwdXQ7CiAgICAgICAgbGVmdCA9IHN0cm0uYXZhaWxfb3V0OwogICAgICAgIG5leHQgPSBzdHJtLm5leHRfaW47CiAgICAgICAgaW5wdXQgPSBzdHJtLmlucHV0OwogICAgICAgIGhhdmUgPSBzdHJtLmF2YWlsX2luOwogICAgICAgIGhvbGQgPSBzdGF0ZS5ob2xkOwogICAgICAgIGJpdHMgPSBzdGF0ZS5iaXRzOwogICAgICAgIF9pbiA9IGhhdmU7CiAgICAgICAgX291dCA9IGxlZnQ7CiAgICAgICAgcmV0ID0gWl9PSzsKICAgICAgICBpbmZfbGVhdmU6CiAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgc3dpdGNoIChzdGF0ZS5tb2RlKSB7CiAgICAgICAgICAgICAgY2FzZSBIRUFEOgogICAgICAgICAgICAgICAgaWYgKHN0YXRlLndyYXAgPT09IDApIHsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFRZUEVETzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IDE2KSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYgMiAmJiBob2xkID09PSAzNTYxNSkgewogICAgICAgICAgICAgICAgICBpZiAoc3RhdGUud2JpdHMgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS53Yml0cyA9IDE1OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHN0YXRlLmNoZWNrID0gMDsKICAgICAgICAgICAgICAgICAgaGJ1ZlswXSA9IGhvbGQgJiAyNTU7CiAgICAgICAgICAgICAgICAgIGhidWZbMV0gPSBob2xkID4+PiA4ICYgMjU1OwogICAgICAgICAgICAgICAgICBzdGF0ZS5jaGVjayA9IGNyYzMyKHN0YXRlLmNoZWNrLCBoYnVmLCAyLCAwKTsKICAgICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gRkxBR1M7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5kb25lID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIShzdGF0ZS53cmFwICYgMSkgfHwgLyogY2hlY2sgaWYgemxpYiBoZWFkZXIgYWxsb3dlZCAqLwogICAgICAgICAgICAgICAgKCgoaG9sZCAmIDI1NSkgPDwgOCkgKyAoaG9sZCA+PiA4KSkgJSAzMSkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbmNvcnJlY3QgaGVhZGVyIGNoZWNrIjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoKGhvbGQgJiAxNSkgIT09IFpfREVGTEFURUQpIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAidW5rbm93biBjb21wcmVzc2lvbiBtZXRob2QiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPj4+PSA0OwogICAgICAgICAgICAgICAgYml0cyAtPSA0OwogICAgICAgICAgICAgICAgbGVuID0gKGhvbGQgJiAxNSkgKyA4OwogICAgICAgICAgICAgICAgaWYgKHN0YXRlLndiaXRzID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHN0YXRlLndiaXRzID0gbGVuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGxlbiA+IDE1IHx8IGxlbiA+IHN0YXRlLndiaXRzKSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgd2luZG93IHNpemUiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmRtYXggPSAxIDw8IHN0YXRlLndiaXRzOwogICAgICAgICAgICAgICAgc3RhdGUuZmxhZ3MgPSAwOwogICAgICAgICAgICAgICAgc3RybS5hZGxlciA9IHN0YXRlLmNoZWNrID0gMTsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBob2xkICYgNTEyID8gRElDVElEIDogVFlQRTsKICAgICAgICAgICAgICAgIGhvbGQgPSAwOwogICAgICAgICAgICAgICAgYml0cyA9IDA7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZMQUdTOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAxNikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5mbGFncyA9IGhvbGQ7CiAgICAgICAgICAgICAgICBpZiAoKHN0YXRlLmZsYWdzICYgMjU1KSAhPT0gWl9ERUZMQVRFRCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJ1bmtub3duIGNvbXByZXNzaW9uIG1ldGhvZCI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTczNDQpIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAidW5rbm93biBoZWFkZXIgZmxhZ3Mgc2V0IjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLnRleHQgPSBob2xkID4+IDggJiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgIGhidWZbMF0gPSBob2xkICYgMjU1OwogICAgICAgICAgICAgICAgICBoYnVmWzFdID0gaG9sZCA+Pj4gOCAmIDI1NTsKICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaGJ1ZiwgMiwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFRJTUU7CiAgICAgICAgICAgICAgY2FzZSBUSU1FOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzMikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLnRpbWUgPSBob2xkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgIGhidWZbMF0gPSBob2xkICYgMjU1OwogICAgICAgICAgICAgICAgICBoYnVmWzFdID0gaG9sZCA+Pj4gOCAmIDI1NTsKICAgICAgICAgICAgICAgICAgaGJ1ZlsyXSA9IGhvbGQgPj4+IDE2ICYgMjU1OwogICAgICAgICAgICAgICAgICBoYnVmWzNdID0gaG9sZCA+Pj4gMjQgJiAyNTU7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmNoZWNrID0gY3JjMzIoc3RhdGUuY2hlY2ssIGhidWYsIDQsIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICBiaXRzID0gMDsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBPUzsKICAgICAgICAgICAgICBjYXNlIE9TOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAxNikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLnhmbGFncyA9IGhvbGQgJiAyNTU7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmhlYWQub3MgPSBob2xkID4+IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiA1MTIgJiYgc3RhdGUud3JhcCAmIDQpIHsKICAgICAgICAgICAgICAgICAgaGJ1ZlswXSA9IGhvbGQgJiAyNTU7CiAgICAgICAgICAgICAgICAgIGhidWZbMV0gPSBob2xkID4+PiA4ICYgMjU1OwogICAgICAgICAgICAgICAgICBzdGF0ZS5jaGVjayA9IGNyYzMyKHN0YXRlLmNoZWNrLCBoYnVmLCAyLCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPSAwOwogICAgICAgICAgICAgICAgYml0cyA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gRVhMRU47CiAgICAgICAgICAgICAgY2FzZSBFWExFTjoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5mbGFncyAmIDEwMjQpIHsKICAgICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAxNikgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3RhdGUubGVuZ3RoID0gaG9sZDsKICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmV4dHJhX2xlbiA9IGhvbGQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgICAgaGJ1ZlswXSA9IGhvbGQgJiAyNTU7CiAgICAgICAgICAgICAgICAgICAgaGJ1ZlsxXSA9IGhvbGQgPj4+IDggJiAyNTU7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaGJ1ZiwgMiwgMCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS5oZWFkKSB7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmhlYWQuZXh0cmEgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEVYVFJBOwogICAgICAgICAgICAgIGNhc2UgRVhUUkE6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiAxMDI0KSB7CiAgICAgICAgICAgICAgICAgIGNvcHkgPSBzdGF0ZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID4gaGF2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvcHkgPSBoYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgICAgIGxlbiA9IHN0YXRlLmhlYWQuZXh0cmFfbGVuIC0gc3RhdGUubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdGF0ZS5oZWFkLmV4dHJhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLmhlYWQuZXh0cmEgPSBuZXcgVWludDhBcnJheShzdGF0ZS5oZWFkLmV4dHJhX2xlbik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmV4dHJhLnNldCgKICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQuc3ViYXJyYXkoCiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBleHRyYSBmaWVsZCBpcyBsaW1pdGVkIHRvIDY1NTM2IGJ5dGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gLSBubyBuZWVkIGZvciBhZGRpdGlvbmFsIHNpemUgY2hlY2sKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0ICsgY29weQogICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAvKmxlbiArIGNvcHkgPiBzdGF0ZS5oZWFkLmV4dHJhX21heCAtIGxlbiA/IHN0YXRlLmhlYWQuZXh0cmFfbWF4IDogY29weSwqLwogICAgICAgICAgICAgICAgICAgICAgICBsZW4KICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5mbGFncyAmIDUxMiAmJiBzdGF0ZS53cmFwICYgNCkgewogICAgICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaW5wdXQsIGNvcHksIG5leHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlIC09IGNvcHk7CiAgICAgICAgICAgICAgICAgICAgbmV4dCArPSBjb3B5OwogICAgICAgICAgICAgICAgICAgIHN0YXRlLmxlbmd0aCAtPSBjb3B5OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTkFNRTsKICAgICAgICAgICAgICBjYXNlIE5BTUU6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiAyMDQ4KSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvcHkgPSAwOwogICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgbGVuID0gaW5wdXRbbmV4dCArIGNvcHkrK107CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQgJiYgbGVuICYmIHN0YXRlLmxlbmd0aCA8IDY1NTM2KSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLm5hbWUgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShsZW4pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSB3aGlsZSAobGVuICYmIGNvcHkgPCBoYXZlKTsKICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaW5wdXQsIGNvcHksIG5leHQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUgLT0gY29weTsKICAgICAgICAgICAgICAgICAgbmV4dCArPSBjb3B5OwogICAgICAgICAgICAgICAgICBpZiAobGVuKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5uYW1lID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQ09NTUVOVDsKICAgICAgICAgICAgICBjYXNlIENPTU1FTlQ6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZmxhZ3MgJiA0MDk2KSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvcHkgPSAwOwogICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgbGVuID0gaW5wdXRbbmV4dCArIGNvcHkrK107CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhlYWQgJiYgbGVuICYmIHN0YXRlLmxlbmd0aCA8IDY1NTM2KSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmNvbW1lbnQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShsZW4pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSB3aGlsZSAobGVuICYmIGNvcHkgPCBoYXZlKTsKICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmZsYWdzICYgNTEyICYmIHN0YXRlLndyYXAgJiA0KSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUuY2hlY2sgPSBjcmMzMihzdGF0ZS5jaGVjaywgaW5wdXQsIGNvcHksIG5leHQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUgLT0gY29weTsKICAgICAgICAgICAgICAgICAgbmV4dCArPSBjb3B5OwogICAgICAgICAgICAgICAgICBpZiAobGVuKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLmhlYWQpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5jb21tZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBIQ1JDOwogICAgICAgICAgICAgIGNhc2UgSENSQzoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5mbGFncyAmIDUxMikgewogICAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IDE2KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoc3RhdGUud3JhcCAmIDQgJiYgaG9sZCAhPT0gKHN0YXRlLmNoZWNrICYgNjU1MzUpKSB7CiAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaGVhZGVyIGNyYyBtaXNtYXRjaCI7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgICAgYml0cyA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGVhZCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5oZWFkLmhjcmMgPSBzdGF0ZS5mbGFncyA+PiA5ICYgMTsKICAgICAgICAgICAgICAgICAgc3RhdGUuaGVhZC5kb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0cm0uYWRsZXIgPSBzdGF0ZS5jaGVjayA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gVFlQRTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRElDVElEOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzMikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHJtLmFkbGVyID0gc3RhdGUuY2hlY2sgPSB6c3dhcDMyKGhvbGQpOwogICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICBiaXRzID0gMDsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBESUNUOwogICAgICAgICAgICAgIGNhc2UgRElDVDoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5oYXZlZGljdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBzdHJtLm5leHRfb3V0ID0gcHV0OwogICAgICAgICAgICAgICAgICBzdHJtLmF2YWlsX291dCA9IGxlZnQ7CiAgICAgICAgICAgICAgICAgIHN0cm0ubmV4dF9pbiA9IG5leHQ7CiAgICAgICAgICAgICAgICAgIHN0cm0uYXZhaWxfaW4gPSBoYXZlOwogICAgICAgICAgICAgICAgICBzdGF0ZS5ob2xkID0gaG9sZDsKICAgICAgICAgICAgICAgICAgc3RhdGUuYml0cyA9IGJpdHM7CiAgICAgICAgICAgICAgICAgIHJldHVybiBaX05FRURfRElDVDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0cm0uYWRsZXIgPSBzdGF0ZS5jaGVjayA9IDE7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gVFlQRTsKICAgICAgICAgICAgICBjYXNlIFRZUEU6CiAgICAgICAgICAgICAgICBpZiAoZmx1c2ggPT09IFpfQkxPQ0sgfHwgZmx1c2ggPT09IFpfVFJFRVMpIHsKICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgVFlQRURPOgogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmxhc3QpIHsKICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IGJpdHMgJiA3OwogICAgICAgICAgICAgICAgICBiaXRzIC09IGJpdHMgJiA3OwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQ0hFQ0s7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxhc3QgPSBob2xkICYgMTsKICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAxOwogICAgICAgICAgICAgICAgYml0cyAtPSAxOwogICAgICAgICAgICAgICAgc3dpdGNoIChob2xkICYgMykgewogICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFNUT1JFRDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICAgIGZpeGVkdGFibGVzKHN0YXRlKTsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTEVOXzsKICAgICAgICAgICAgICAgICAgICBpZiAoZmx1c2ggPT09IFpfVFJFRVMpIHsKICAgICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAyOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSAyOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBUQUJMRTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgYmxvY2sgdHlwZSI7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAyOwogICAgICAgICAgICAgICAgYml0cyAtPSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBTVE9SRUQ6CiAgICAgICAgICAgICAgICBob2xkID4+Pj0gYml0cyAmIDc7CiAgICAgICAgICAgICAgICBiaXRzIC09IGJpdHMgJiA3OwogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAzMikgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoKGhvbGQgJiA2NTUzNSkgIT09IChob2xkID4+PiAxNiBeIDY1NTM1KSkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIHN0b3JlZCBibG9jayBsZW5ndGhzIjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5ndGggPSBob2xkICYgNjU1MzU7CiAgICAgICAgICAgICAgICBob2xkID0gMDsKICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IENPUFlfOwogICAgICAgICAgICAgICAgaWYgKGZsdXNoID09PSBaX1RSRUVTKSB7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENPUFlfOgogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IENPUFk7CiAgICAgICAgICAgICAgY2FzZSBDT1BZOgogICAgICAgICAgICAgICAgY29weSA9IHN0YXRlLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChjb3B5KSB7CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID4gaGF2ZSkgewogICAgICAgICAgICAgICAgICAgIGNvcHkgPSBoYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID4gbGVmdCkgewogICAgICAgICAgICAgICAgICAgIGNvcHkgPSBsZWZ0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIG91dHB1dC5zZXQoaW5wdXQuc3ViYXJyYXkobmV4dCwgbmV4dCArIGNvcHkpLCBwdXQpOwogICAgICAgICAgICAgICAgICBoYXZlIC09IGNvcHk7CiAgICAgICAgICAgICAgICAgIG5leHQgKz0gY29weTsKICAgICAgICAgICAgICAgICAgbGVmdCAtPSBjb3B5OwogICAgICAgICAgICAgICAgICBwdXQgKz0gY29weTsKICAgICAgICAgICAgICAgICAgc3RhdGUubGVuZ3RoIC09IGNvcHk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IFRZUEU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIFRBQkxFOgogICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCAxNCkgewogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5ubGVuID0gKGhvbGQgJiAzMSkgKyAyNTc7CiAgICAgICAgICAgICAgICBob2xkID4+Pj0gNTsKICAgICAgICAgICAgICAgIGJpdHMgLT0gNTsKICAgICAgICAgICAgICAgIHN0YXRlLm5kaXN0ID0gKGhvbGQgJiAzMSkgKyAxOwogICAgICAgICAgICAgICAgaG9sZCA+Pj49IDU7CiAgICAgICAgICAgICAgICBiaXRzIC09IDU7CiAgICAgICAgICAgICAgICBzdGF0ZS5uY29kZSA9IChob2xkICYgMTUpICsgNDsKICAgICAgICAgICAgICAgIGhvbGQgPj4+PSA0OwogICAgICAgICAgICAgICAgYml0cyAtPSA0OwogICAgICAgICAgICAgICAgaWYgKHN0YXRlLm5sZW4gPiAyODYgfHwgc3RhdGUubmRpc3QgPiAzMCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJ0b28gbWFueSBsZW5ndGggb3IgZGlzdGFuY2Ugc3ltYm9scyI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuaGF2ZSA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTEVOTEVOUzsKICAgICAgICAgICAgICBjYXNlIExFTkxFTlM6CiAgICAgICAgICAgICAgICB3aGlsZSAoc3RhdGUuaGF2ZSA8IHN0YXRlLm5jb2RlKSB7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgMykgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3RhdGUubGVuc1tvcmRlcltzdGF0ZS5oYXZlKytdXSA9IGhvbGQgJiA3OwogICAgICAgICAgICAgICAgICBob2xkID4+Pj0gMzsKICAgICAgICAgICAgICAgICAgYml0cyAtPSAzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2hpbGUgKHN0YXRlLmhhdmUgPCAxOSkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5sZW5zW29yZGVyW3N0YXRlLmhhdmUrK11dID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmxlbmNvZGUgPSBzdGF0ZS5sZW5keW47CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5iaXRzID0gNzsKICAgICAgICAgICAgICAgIG9wdHMgPSB7IGJpdHM6IHN0YXRlLmxlbmJpdHMgfTsKICAgICAgICAgICAgICAgIHJldCA9IGluZmxhdGVfdGFibGUoQ09ERVMsIHN0YXRlLmxlbnMsIDAsIDE5LCBzdGF0ZS5sZW5jb2RlLCAwLCBzdGF0ZS53b3JrLCBvcHRzKTsKICAgICAgICAgICAgICAgIHN0YXRlLmxlbmJpdHMgPSBvcHRzLmJpdHM7CiAgICAgICAgICAgICAgICBpZiAocmV0KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgY29kZSBsZW5ndGhzIHNldCI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuaGF2ZSA9IDA7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQ09ERUxFTlM7CiAgICAgICAgICAgICAgY2FzZSBDT0RFTEVOUzoKICAgICAgICAgICAgICAgIHdoaWxlIChzdGF0ZS5oYXZlIDwgc3RhdGUubmxlbiArIHN0YXRlLm5kaXN0KSB7CiAgICAgICAgICAgICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgICAgICAgICAgIGhlcmUgPSBzdGF0ZS5sZW5jb2RlW2hvbGQgJiAoMSA8PCBzdGF0ZS5sZW5iaXRzKSAtIDFdOwogICAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICAgIGhlcmVfb3AgPSBoZXJlID4+PiAxNiAmIDI1NTsKICAgICAgICAgICAgICAgICAgICBoZXJlX3ZhbCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgICBpZiAoaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChoZXJlX3ZhbCA8IDE2KSB7CiAgICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IGhlcmVfYml0czsKICAgICAgICAgICAgICAgICAgICBiaXRzIC09IGhlcmVfYml0czsKICAgICAgICAgICAgICAgICAgICBzdGF0ZS5sZW5zW3N0YXRlLmhhdmUrK10gPSBoZXJlX3ZhbDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGVyZV92YWwgPT09IDE2KSB7CiAgICAgICAgICAgICAgICAgICAgICBuID0gaGVyZV9iaXRzICsgMjsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBob2xkID4+Pj0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGJpdCBsZW5ndGggcmVwZWF0IjsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBsZW4gPSBzdGF0ZS5sZW5zW3N0YXRlLmhhdmUgLSAxXTsKICAgICAgICAgICAgICAgICAgICAgIGNvcHkgPSAzICsgKGhvbGQgJiAzKTsKICAgICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSAyOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSAyOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGVyZV92YWwgPT09IDE3KSB7CiAgICAgICAgICAgICAgICAgICAgICBuID0gaGVyZV9iaXRzICsgMzsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgbikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBob2xkID4+Pj0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgICAgICAgYml0cyAtPSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgICAgICBsZW4gPSAwOwogICAgICAgICAgICAgICAgICAgICAgY29weSA9IDMgKyAoaG9sZCAmIDcpOwogICAgICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IDM7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzIC09IDM7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIG4gPSBoZXJlX2JpdHMgKyA3OwogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCBuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXZlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGhhdmUtLTsKICAgICAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgICAgICBiaXRzIC09IGhlcmVfYml0czsKICAgICAgICAgICAgICAgICAgICAgIGxlbiA9IDA7CiAgICAgICAgICAgICAgICAgICAgICBjb3B5ID0gMTEgKyAoaG9sZCAmIDEyNyk7CiAgICAgICAgICAgICAgICAgICAgICBob2xkID4+Pj0gNzsKICAgICAgICAgICAgICAgICAgICAgIGJpdHMgLT0gNzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlLmhhdmUgKyBjb3B5ID4gc3RhdGUubmxlbiArIHN0YXRlLm5kaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGJpdCBsZW5ndGggcmVwZWF0IjsKICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGNvcHktLSkgewogICAgICAgICAgICAgICAgICAgICAgc3RhdGUubGVuc1tzdGF0ZS5oYXZlKytdID0gbGVuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLm1vZGUgPT09IEJBRCkgewogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5sZW5zWzI1Nl0gPT09IDApIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBjb2RlIC0tIG1pc3NpbmcgZW5kLW9mLWJsb2NrIjsKICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5iaXRzID0gOTsKICAgICAgICAgICAgICAgIG9wdHMgPSB7IGJpdHM6IHN0YXRlLmxlbmJpdHMgfTsKICAgICAgICAgICAgICAgIHJldCA9IGluZmxhdGVfdGFibGUoTEVOUywgc3RhdGUubGVucywgMCwgc3RhdGUubmxlbiwgc3RhdGUubGVuY29kZSwgMCwgc3RhdGUud29yaywgb3B0cyk7CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5iaXRzID0gb3B0cy5iaXRzOwogICAgICAgICAgICAgICAgaWYgKHJldCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGxpdGVyYWwvbGVuZ3RocyBzZXQiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLmRpc3RiaXRzID0gNjsKICAgICAgICAgICAgICAgIHN0YXRlLmRpc3Rjb2RlID0gc3RhdGUuZGlzdGR5bjsKICAgICAgICAgICAgICAgIG9wdHMgPSB7IGJpdHM6IHN0YXRlLmRpc3RiaXRzIH07CiAgICAgICAgICAgICAgICByZXQgPSBpbmZsYXRlX3RhYmxlKERJU1RTLCBzdGF0ZS5sZW5zLCBzdGF0ZS5ubGVuLCBzdGF0ZS5uZGlzdCwgc3RhdGUuZGlzdGNvZGUsIDAsIHN0YXRlLndvcmssIG9wdHMpOwogICAgICAgICAgICAgICAgc3RhdGUuZGlzdGJpdHMgPSBvcHRzLmJpdHM7CiAgICAgICAgICAgICAgICBpZiAocmV0KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgZGlzdGFuY2VzIHNldCI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IExFTl87CiAgICAgICAgICAgICAgICBpZiAoZmx1c2ggPT09IFpfVFJFRVMpIHsKICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgTEVOXzoKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBMRU47CiAgICAgICAgICAgICAgY2FzZSBMRU46CiAgICAgICAgICAgICAgICBpZiAoaGF2ZSA+PSA2ICYmIGxlZnQgPj0gMjU4KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubmV4dF9vdXQgPSBwdXQ7CiAgICAgICAgICAgICAgICAgIHN0cm0uYXZhaWxfb3V0ID0gbGVmdDsKICAgICAgICAgICAgICAgICAgc3RybS5uZXh0X2luID0gbmV4dDsKICAgICAgICAgICAgICAgICAgc3RybS5hdmFpbF9pbiA9IGhhdmU7CiAgICAgICAgICAgICAgICAgIHN0YXRlLmhvbGQgPSBob2xkOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iaXRzID0gYml0czsKICAgICAgICAgICAgICAgICAgaW5mbGF0ZV9mYXN0KHN0cm0sIF9vdXQpOwogICAgICAgICAgICAgICAgICBwdXQgPSBzdHJtLm5leHRfb3V0OwogICAgICAgICAgICAgICAgICBvdXRwdXQgPSBzdHJtLm91dHB1dDsKICAgICAgICAgICAgICAgICAgbGVmdCA9IHN0cm0uYXZhaWxfb3V0OwogICAgICAgICAgICAgICAgICBuZXh0ID0gc3RybS5uZXh0X2luOwogICAgICAgICAgICAgICAgICBpbnB1dCA9IHN0cm0uaW5wdXQ7CiAgICAgICAgICAgICAgICAgIGhhdmUgPSBzdHJtLmF2YWlsX2luOwogICAgICAgICAgICAgICAgICBob2xkID0gc3RhdGUuaG9sZDsKICAgICAgICAgICAgICAgICAgYml0cyA9IHN0YXRlLmJpdHM7CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5tb2RlID09PSBUWVBFKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhdGUuYmFjayA9IC0xOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuYmFjayA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgICAgICAgaGVyZSA9IHN0YXRlLmxlbmNvZGVbaG9sZCAmICgxIDw8IHN0YXRlLmxlbmJpdHMpIC0gMV07CiAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICBoZXJlX29wID0gaGVyZSA+Pj4gMTYgJiAyNTU7CiAgICAgICAgICAgICAgICAgIGhlcmVfdmFsID0gaGVyZSAmIDY1NTM1OwogICAgICAgICAgICAgICAgICBpZiAoaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICBiaXRzICs9IDg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaGVyZV9vcCAmJiAoaGVyZV9vcCAmIDI0MCkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgbGFzdF9iaXRzID0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgICBsYXN0X29wID0gaGVyZV9vcDsKICAgICAgICAgICAgICAgICAgbGFzdF92YWwgPSBoZXJlX3ZhbDsKICAgICAgICAgICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgICAgICAgICAgaGVyZSA9IHN0YXRlLmxlbmNvZGVbbGFzdF92YWwgKyAoKGhvbGQgJiAoMSA8PCBsYXN0X2JpdHMgKyBsYXN0X29wKSAtIDEpID4+IGxhc3RfYml0cyldOwogICAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICAgIGhlcmVfb3AgPSBoZXJlID4+PiAxNiAmIDI1NTsKICAgICAgICAgICAgICAgICAgICBoZXJlX3ZhbCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgICBpZiAobGFzdF9iaXRzICsgaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBsYXN0X2JpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgLT0gbGFzdF9iaXRzOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iYWNrICs9IGxhc3RfYml0czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICBiaXRzIC09IGhlcmVfYml0czsKICAgICAgICAgICAgICAgIHN0YXRlLmJhY2sgKz0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgc3RhdGUubGVuZ3RoID0gaGVyZV92YWw7CiAgICAgICAgICAgICAgICBpZiAoaGVyZV9vcCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTElUOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChoZXJlX29wICYgMzIpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUuYmFjayA9IC0xOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gVFlQRTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaGVyZV9vcCAmIDY0KSB7CiAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImludmFsaWQgbGl0ZXJhbC9sZW5ndGggY29kZSI7CiAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUuZXh0cmEgPSBoZXJlX29wICYgMTU7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTEVORVhUOwogICAgICAgICAgICAgIGNhc2UgTEVORVhUOgogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmV4dHJhKSB7CiAgICAgICAgICAgICAgICAgIG4gPSBzdGF0ZS5leHRyYTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKGJpdHMgPCBuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICAgIGhvbGQgKz0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdGF0ZS5sZW5ndGggKz0gaG9sZCAmICgxIDw8IHN0YXRlLmV4dHJhKSAtIDE7CiAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBzdGF0ZS5leHRyYTsKICAgICAgICAgICAgICAgICAgYml0cyAtPSBzdGF0ZS5leHRyYTsKICAgICAgICAgICAgICAgICAgc3RhdGUuYmFjayArPSBzdGF0ZS5leHRyYTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLndhcyA9IHN0YXRlLmxlbmd0aDsKICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBESVNUOwogICAgICAgICAgICAgIGNhc2UgRElTVDoKICAgICAgICAgICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgICAgICAgICBoZXJlID0gc3RhdGUuZGlzdGNvZGVbaG9sZCAmICgxIDw8IHN0YXRlLmRpc3RiaXRzKSAtIDFdOwogICAgICAgICAgICAgICAgICBoZXJlX2JpdHMgPSBoZXJlID4+PiAyNDsKICAgICAgICAgICAgICAgICAgaGVyZV9vcCA9IGhlcmUgPj4+IDE2ICYgMjU1OwogICAgICAgICAgICAgICAgICBoZXJlX3ZhbCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgaWYgKGhlcmVfYml0cyA8PSBiaXRzKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICBob2xkICs9IGlucHV0W25leHQrK10gPDwgYml0czsKICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChoZXJlX29wICYgMjQwKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICBsYXN0X2JpdHMgPSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICAgIGxhc3Rfb3AgPSBoZXJlX29wOwogICAgICAgICAgICAgICAgICBsYXN0X3ZhbCA9IGhlcmVfdmFsOwogICAgICAgICAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgICAgICAgICBoZXJlID0gc3RhdGUuZGlzdGNvZGVbbGFzdF92YWwgKyAoKGhvbGQgJiAoMSA8PCBsYXN0X2JpdHMgKyBsYXN0X29wKSAtIDEpID4+IGxhc3RfYml0cyldOwogICAgICAgICAgICAgICAgICAgIGhlcmVfYml0cyA9IGhlcmUgPj4+IDI0OwogICAgICAgICAgICAgICAgICAgIGhlcmVfb3AgPSBoZXJlID4+PiAxNiAmIDI1NTsKICAgICAgICAgICAgICAgICAgICBoZXJlX3ZhbCA9IGhlcmUgJiA2NTUzNTsKICAgICAgICAgICAgICAgICAgICBpZiAobGFzdF9iaXRzICsgaGVyZV9iaXRzIDw9IGJpdHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBsYXN0X2JpdHM7CiAgICAgICAgICAgICAgICAgIGJpdHMgLT0gbGFzdF9iaXRzOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iYWNrICs9IGxhc3RfYml0czsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGhvbGQgPj4+PSBoZXJlX2JpdHM7CiAgICAgICAgICAgICAgICBiaXRzIC09IGhlcmVfYml0czsKICAgICAgICAgICAgICAgIHN0YXRlLmJhY2sgKz0gaGVyZV9iaXRzOwogICAgICAgICAgICAgICAgaWYgKGhlcmVfb3AgJiA2NCkgewogICAgICAgICAgICAgICAgICBzdHJtLm1zZyA9ICJpbnZhbGlkIGRpc3RhbmNlIGNvZGUiOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLm9mZnNldCA9IGhlcmVfdmFsOwogICAgICAgICAgICAgICAgc3RhdGUuZXh0cmEgPSBoZXJlX29wICYgMTU7CiAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gRElTVEVYVDsKICAgICAgICAgICAgICBjYXNlIERJU1RFWFQ6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZXh0cmEpIHsKICAgICAgICAgICAgICAgICAgbiA9IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IG4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHN0YXRlLm9mZnNldCArPSBob2xkICYgKDEgPDwgc3RhdGUuZXh0cmEpIC0gMTsKICAgICAgICAgICAgICAgICAgaG9sZCA+Pj49IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgICBiaXRzIC09IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgICBzdGF0ZS5iYWNrICs9IHN0YXRlLmV4dHJhOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9mZnNldCA+IHN0YXRlLmRtYXgpIHsKICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBkaXN0YW5jZSB0b28gZmFyIGJhY2siOwogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gQkFEOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBNQVRDSDsKICAgICAgICAgICAgICBjYXNlIE1BVENIOgogICAgICAgICAgICAgICAgaWYgKGxlZnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29weSA9IF9vdXQgLSBsZWZ0OwogICAgICAgICAgICAgICAgaWYgKHN0YXRlLm9mZnNldCA+IGNvcHkpIHsKICAgICAgICAgICAgICAgICAgY29weSA9IHN0YXRlLm9mZnNldCAtIGNvcHk7CiAgICAgICAgICAgICAgICAgIGlmIChjb3B5ID4gc3RhdGUud2hhdmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUuc2FuZSkgewogICAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW52YWxpZCBkaXN0YW5jZSB0b28gZmFyIGJhY2siOwogICAgICAgICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IEJBRDsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoY29weSA+IHN0YXRlLnduZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgY29weSAtPSBzdGF0ZS53bmV4dDsKICAgICAgICAgICAgICAgICAgICBmcm9tID0gc3RhdGUud3NpemUgLSBjb3B5OwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZyb20gPSBzdGF0ZS53bmV4dCAtIGNvcHk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKGNvcHkgPiBzdGF0ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjb3B5ID0gc3RhdGUubGVuZ3RoOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGZyb21fc291cmNlID0gc3RhdGUud2luZG93OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZnJvbV9zb3VyY2UgPSBvdXRwdXQ7CiAgICAgICAgICAgICAgICAgIGZyb20gPSBwdXQgLSBzdGF0ZS5vZmZzZXQ7CiAgICAgICAgICAgICAgICAgIGNvcHkgPSBzdGF0ZS5sZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY29weSA+IGxlZnQpIHsKICAgICAgICAgICAgICAgICAgY29weSA9IGxlZnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsZWZ0IC09IGNvcHk7CiAgICAgICAgICAgICAgICBzdGF0ZS5sZW5ndGggLT0gY29weTsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgb3V0cHV0W3B1dCsrXSA9IGZyb21fc291cmNlW2Zyb20rK107CiAgICAgICAgICAgICAgICB9IHdoaWxlICgtLWNvcHkpOwogICAgICAgICAgICAgICAgaWYgKHN0YXRlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBzdGF0ZS5tb2RlID0gTEVOOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBMSVQ6CiAgICAgICAgICAgICAgICBpZiAobGVmdCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBicmVhayBpbmZfbGVhdmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvdXRwdXRbcHV0KytdID0gc3RhdGUubGVuZ3RoOwogICAgICAgICAgICAgICAgbGVmdC0tOwogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IExFTjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgQ0hFQ0s6CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUud3JhcCkgewogICAgICAgICAgICAgICAgICB3aGlsZSAoYml0cyA8IDMyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhdmUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGluZl9sZWF2ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGF2ZS0tOwogICAgICAgICAgICAgICAgICAgIGhvbGQgfD0gaW5wdXRbbmV4dCsrXSA8PCBiaXRzOwogICAgICAgICAgICAgICAgICAgIGJpdHMgKz0gODsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBfb3V0IC09IGxlZnQ7CiAgICAgICAgICAgICAgICAgIHN0cm0udG90YWxfb3V0ICs9IF9vdXQ7CiAgICAgICAgICAgICAgICAgIHN0YXRlLnRvdGFsICs9IF9vdXQ7CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYgNCAmJiBfb3V0KSB7CiAgICAgICAgICAgICAgICAgICAgc3RybS5hZGxlciA9IHN0YXRlLmNoZWNrID0gLypVUERBVEVfQ0hFQ0soc3RhdGUuY2hlY2ssIHB1dCAtIF9vdXQsIF9vdXQpOyovCiAgICAgICAgICAgICAgICAgICAgc3RhdGUuZmxhZ3MgPyBjcmMzMihzdGF0ZS5jaGVjaywgb3V0cHV0LCBfb3V0LCBwdXQgLSBfb3V0KSA6IGFkbGVyMzIoc3RhdGUuY2hlY2ssIG91dHB1dCwgX291dCwgcHV0IC0gX291dCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgX291dCA9IGxlZnQ7CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYgNCAmJiAoc3RhdGUuZmxhZ3MgPyBob2xkIDogenN3YXAzMihob2xkKSkgIT09IHN0YXRlLmNoZWNrKSB7CiAgICAgICAgICAgICAgICAgICAgc3RybS5tc2cgPSAiaW5jb3JyZWN0IGRhdGEgY2hlY2siOwogICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IExFTkdUSDsKICAgICAgICAgICAgICBjYXNlIExFTkdUSDoKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYmIHN0YXRlLmZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChiaXRzIDwgMzIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGF2ZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBoYXZlLS07CiAgICAgICAgICAgICAgICAgICAgaG9sZCArPSBpbnB1dFtuZXh0KytdIDw8IGJpdHM7CiAgICAgICAgICAgICAgICAgICAgYml0cyArPSA4OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZS53cmFwICYgNCAmJiBob2xkICE9PSAoc3RhdGUudG90YWwgJiA0Mjk0OTY3Mjk1KSkgewogICAgICAgICAgICAgICAgICAgIHN0cm0ubXNnID0gImluY29ycmVjdCBsZW5ndGggY2hlY2siOwogICAgICAgICAgICAgICAgICAgIHN0YXRlLm1vZGUgPSBCQUQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaG9sZCA9IDA7CiAgICAgICAgICAgICAgICAgIGJpdHMgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RhdGUubW9kZSA9IERPTkU7CiAgICAgICAgICAgICAgY2FzZSBET05FOgogICAgICAgICAgICAgICAgcmV0ID0gWl9TVFJFQU1fRU5EOwogICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgIGNhc2UgQkFEOgogICAgICAgICAgICAgICAgcmV0ID0gWl9EQVRBX0VSUk9SOwogICAgICAgICAgICAgICAgYnJlYWsgaW5mX2xlYXZlOwogICAgICAgICAgICAgIGNhc2UgTUVNOgogICAgICAgICAgICAgICAgcmV0dXJuIFpfTUVNX0VSUk9SOwogICAgICAgICAgICAgIGNhc2UgU1lOQzoKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgc3RybS5uZXh0X291dCA9IHB1dDsKICAgICAgICBzdHJtLmF2YWlsX291dCA9IGxlZnQ7CiAgICAgICAgc3RybS5uZXh0X2luID0gbmV4dDsKICAgICAgICBzdHJtLmF2YWlsX2luID0gaGF2ZTsKICAgICAgICBzdGF0ZS5ob2xkID0gaG9sZDsKICAgICAgICBzdGF0ZS5iaXRzID0gYml0czsKICAgICAgICBpZiAoc3RhdGUud3NpemUgfHwgX291dCAhPT0gc3RybS5hdmFpbF9vdXQgJiYgc3RhdGUubW9kZSA8IEJBRCAmJiAoc3RhdGUubW9kZSA8IENIRUNLIHx8IGZsdXNoICE9PSBaX0ZJTklTSCkpIHsKICAgICAgICAgIGlmICh1cGRhdGV3aW5kb3coc3RybSwgc3RybS5vdXRwdXQsIHN0cm0ubmV4dF9vdXQsIF9vdXQgLSBzdHJtLmF2YWlsX291dCkpIHsKICAgICAgICAgICAgc3RhdGUubW9kZSA9IE1FTTsKICAgICAgICAgICAgcmV0dXJuIFpfTUVNX0VSUk9SOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBfaW4gLT0gc3RybS5hdmFpbF9pbjsKICAgICAgICBfb3V0IC09IHN0cm0uYXZhaWxfb3V0OwogICAgICAgIHN0cm0udG90YWxfaW4gKz0gX2luOwogICAgICAgIHN0cm0udG90YWxfb3V0ICs9IF9vdXQ7CiAgICAgICAgc3RhdGUudG90YWwgKz0gX291dDsKICAgICAgICBpZiAoc3RhdGUud3JhcCAmIDQgJiYgX291dCkgewogICAgICAgICAgc3RybS5hZGxlciA9IHN0YXRlLmNoZWNrID0gLypVUERBVEVfQ0hFQ0soc3RhdGUuY2hlY2ssIHN0cm0ubmV4dF9vdXQgLSBfb3V0LCBfb3V0KTsqLwogICAgICAgICAgc3RhdGUuZmxhZ3MgPyBjcmMzMihzdGF0ZS5jaGVjaywgb3V0cHV0LCBfb3V0LCBzdHJtLm5leHRfb3V0IC0gX291dCkgOiBhZGxlcjMyKHN0YXRlLmNoZWNrLCBvdXRwdXQsIF9vdXQsIHN0cm0ubmV4dF9vdXQgLSBfb3V0KTsKICAgICAgICB9CiAgICAgICAgc3RybS5kYXRhX3R5cGUgPSBzdGF0ZS5iaXRzICsgKHN0YXRlLmxhc3QgPyA2NCA6IDApICsgKHN0YXRlLm1vZGUgPT09IFRZUEUgPyAxMjggOiAwKSArIChzdGF0ZS5tb2RlID09PSBMRU5fIHx8IHN0YXRlLm1vZGUgPT09IENPUFlfID8gMjU2IDogMCk7CiAgICAgICAgaWYgKChfaW4gPT09IDAgJiYgX291dCA9PT0gMCB8fCBmbHVzaCA9PT0gWl9GSU5JU0gpICYmIHJldCA9PT0gWl9PSykgewogICAgICAgICAgcmV0ID0gWl9CVUZfRVJST1I7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlRW5kID0gKHN0cm0pID0+IHsKICAgICAgICBpZiAoaW5mbGF0ZVN0YXRlQ2hlY2soc3RybSkpIHsKICAgICAgICAgIHJldHVybiBaX1NUUkVBTV9FUlJPUjsKICAgICAgICB9CiAgICAgICAgbGV0IHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBpZiAoc3RhdGUud2luZG93KSB7CiAgICAgICAgICBzdGF0ZS53aW5kb3cgPSBudWxsOwogICAgICAgIH0KICAgICAgICBzdHJtLnN0YXRlID0gbnVsbDsKICAgICAgICByZXR1cm4gWl9PSzsKICAgICAgfTsKICAgICAgdmFyIGluZmxhdGVHZXRIZWFkZXIgPSAoc3RybSwgaGVhZCkgPT4gewogICAgICAgIGlmIChpbmZsYXRlU3RhdGVDaGVjayhzdHJtKSkgewogICAgICAgICAgcmV0dXJuIFpfU1RSRUFNX0VSUk9SOwogICAgICAgIH0KICAgICAgICBjb25zdCBzdGF0ZSA9IHN0cm0uc3RhdGU7CiAgICAgICAgaWYgKChzdGF0ZS53cmFwICYgMikgPT09IDApIHsKICAgICAgICAgIHJldHVybiBaX1NUUkVBTV9FUlJPUjsKICAgICAgICB9CiAgICAgICAgc3RhdGUuaGVhZCA9IGhlYWQ7CiAgICAgICAgaGVhZC5kb25lID0gZmFsc2U7CiAgICAgICAgcmV0dXJuIFpfT0s7CiAgICAgIH07CiAgICAgIHZhciBpbmZsYXRlU2V0RGljdGlvbmFyeSA9IChzdHJtLCBkaWN0aW9uYXJ5KSA9PiB7CiAgICAgICAgY29uc3QgZGljdExlbmd0aCA9IGRpY3Rpb25hcnkubGVuZ3RoOwogICAgICAgIGxldCBzdGF0ZTsKICAgICAgICBsZXQgZGljdGlkOwogICAgICAgIGxldCByZXQ7CiAgICAgICAgaWYgKGluZmxhdGVTdGF0ZUNoZWNrKHN0cm0pKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIHN0YXRlID0gc3RybS5zdGF0ZTsKICAgICAgICBpZiAoc3RhdGUud3JhcCAhPT0gMCAmJiBzdGF0ZS5tb2RlICE9PSBESUNUKSB7CiAgICAgICAgICByZXR1cm4gWl9TVFJFQU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIGlmIChzdGF0ZS5tb2RlID09PSBESUNUKSB7CiAgICAgICAgICBkaWN0aWQgPSAxOwogICAgICAgICAgZGljdGlkID0gYWRsZXIzMihkaWN0aWQsIGRpY3Rpb25hcnksIGRpY3RMZW5ndGgsIDApOwogICAgICAgICAgaWYgKGRpY3RpZCAhPT0gc3RhdGUuY2hlY2spIHsKICAgICAgICAgICAgcmV0dXJuIFpfREFUQV9FUlJPUjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0ID0gdXBkYXRld2luZG93KHN0cm0sIGRpY3Rpb25hcnksIGRpY3RMZW5ndGgsIGRpY3RMZW5ndGgpOwogICAgICAgIGlmIChyZXQpIHsKICAgICAgICAgIHN0YXRlLm1vZGUgPSBNRU07CiAgICAgICAgICByZXR1cm4gWl9NRU1fRVJST1I7CiAgICAgICAgfQogICAgICAgIHN0YXRlLmhhdmVkaWN0ID0gMTsKICAgICAgICByZXR1cm4gWl9PSzsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZVJlc2V0ID0gaW5mbGF0ZVJlc2V0OwogICAgICBtb2R1bGUuZXhwb3J0cy5pbmZsYXRlUmVzZXQyID0gaW5mbGF0ZVJlc2V0MjsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZVJlc2V0S2VlcCA9IGluZmxhdGVSZXNldEtlZXA7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVJbml0ID0gaW5mbGF0ZUluaXQ7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVJbml0MiA9IGluZmxhdGVJbml0MjsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZSA9IGluZmxhdGU7CiAgICAgIG1vZHVsZS5leHBvcnRzLmluZmxhdGVFbmQgPSBpbmZsYXRlRW5kOwogICAgICBtb2R1bGUuZXhwb3J0cy5pbmZsYXRlR2V0SGVhZGVyID0gaW5mbGF0ZUdldEhlYWRlcjsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZVNldERpY3Rpb25hcnkgPSBpbmZsYXRlU2V0RGljdGlvbmFyeTsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZUluZm8gPSAicGFrbyBpbmZsYXRlIChmcm9tIE5vZGVjYSBwcm9qZWN0KSI7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9wYWtvL2xpYi91dGlscy9jb21tb24uanMKICB2YXIgcmVxdWlyZV9jb21tb24gPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvdXRpbHMvY29tbW9uLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIF9oYXMgPSAob2JqLCBrZXkpID0+IHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKICAgICAgfTsKICAgICAgbW9kdWxlLmV4cG9ydHMuYXNzaWduID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgY29uc3Qgc291cmNlcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgd2hpbGUgKHNvdXJjZXMubGVuZ3RoKSB7CiAgICAgICAgICBjb25zdCBzb3VyY2UgPSBzb3VyY2VzLnNoaWZ0KCk7CiAgICAgICAgICBpZiAoIXNvdXJjZSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2Ygc291cmNlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKHNvdXJjZSArICJtdXN0IGJlIG5vbi1vYmplY3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoY29uc3QgcCBpbiBzb3VyY2UpIHsKICAgICAgICAgICAgaWYgKF9oYXMoc291cmNlLCBwKSkgewogICAgICAgICAgICAgIG9ialtwXSA9IHNvdXJjZVtwXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gb2JqOwogICAgICB9OwogICAgICBtb2R1bGUuZXhwb3J0cy5mbGF0dGVuQ2h1bmtzID0gKGNodW5rcykgPT4gewogICAgICAgIGxldCBsZW4gPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gY2h1bmtzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgbGVuICs9IGNodW5rc1tpXS5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBVaW50OEFycmF5KGxlbik7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIHBvcyA9IDAsIGwgPSBjaHVua3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBsZXQgY2h1bmsgPSBjaHVua3NbaV07CiAgICAgICAgICByZXN1bHQuc2V0KGNodW5rLCBwb3MpOwogICAgICAgICAgcG9zICs9IGNodW5rLmxlbmd0aDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3V0aWxzL3N0cmluZ3MuanMKICB2YXIgcmVxdWlyZV9zdHJpbmdzID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL3V0aWxzL3N0cmluZ3MuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgU1RSX0FQUExZX1VJQV9PSyA9IHRydWU7CiAgICAgIHRyeSB7CiAgICAgICAgU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShudWxsLCBuZXcgVWludDhBcnJheSgxKSk7CiAgICAgIH0gY2F0Y2ggKF9fKSB7CiAgICAgICAgU1RSX0FQUExZX1VJQV9PSyA9IGZhbHNlOwogICAgICB9CiAgICAgIHZhciBfdXRmOGxlbiA9IG5ldyBVaW50OEFycmF5KDI1Nik7CiAgICAgIGZvciAobGV0IHEgPSAwOyBxIDwgMjU2OyBxKyspIHsKICAgICAgICBfdXRmOGxlbltxXSA9IHEgPj0gMjUyID8gNiA6IHEgPj0gMjQ4ID8gNSA6IHEgPj0gMjQwID8gNCA6IHEgPj0gMjI0ID8gMyA6IHEgPj0gMTkyID8gMiA6IDE7CiAgICAgIH0KICAgICAgX3V0ZjhsZW5bMjU0XSA9IF91dGY4bGVuWzI1NF0gPSAxOwogICAgICBtb2R1bGUuZXhwb3J0cy5zdHJpbmcyYnVmID0gKHN0cikgPT4gewogICAgICAgIGlmICh0eXBlb2YgVGV4dEVuY29kZXIgPT09ICJmdW5jdGlvbiIgJiYgVGV4dEVuY29kZXIucHJvdG90eXBlLmVuY29kZSkgewogICAgICAgICAgcmV0dXJuIG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShzdHIpOwogICAgICAgIH0KICAgICAgICBsZXQgYnVmLCBjLCBjMiwgbV9wb3MsIGksIHN0cl9sZW4gPSBzdHIubGVuZ3RoLCBidWZfbGVuID0gMDsKICAgICAgICBmb3IgKG1fcG9zID0gMDsgbV9wb3MgPCBzdHJfbGVuOyBtX3BvcysrKSB7CiAgICAgICAgICBjID0gc3RyLmNoYXJDb2RlQXQobV9wb3MpOwogICAgICAgICAgaWYgKChjICYgNjQ1MTIpID09PSA1NTI5NiAmJiBtX3BvcyArIDEgPCBzdHJfbGVuKSB7CiAgICAgICAgICAgIGMyID0gc3RyLmNoYXJDb2RlQXQobV9wb3MgKyAxKTsKICAgICAgICAgICAgaWYgKChjMiAmIDY0NTEyKSA9PT0gNTYzMjApIHsKICAgICAgICAgICAgICBjID0gNjU1MzYgKyAoYyAtIDU1Mjk2IDw8IDEwKSArIChjMiAtIDU2MzIwKTsKICAgICAgICAgICAgICBtX3BvcysrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBidWZfbGVuICs9IGMgPCAxMjggPyAxIDogYyA8IDIwNDggPyAyIDogYyA8IDY1NTM2ID8gMyA6IDQ7CiAgICAgICAgfQogICAgICAgIGJ1ZiA9IG5ldyBVaW50OEFycmF5KGJ1Zl9sZW4pOwogICAgICAgIGZvciAoaSA9IDAsIG1fcG9zID0gMDsgaSA8IGJ1Zl9sZW47IG1fcG9zKyspIHsKICAgICAgICAgIGMgPSBzdHIuY2hhckNvZGVBdChtX3Bvcyk7CiAgICAgICAgICBpZiAoKGMgJiA2NDUxMikgPT09IDU1Mjk2ICYmIG1fcG9zICsgMSA8IHN0cl9sZW4pIHsKICAgICAgICAgICAgYzIgPSBzdHIuY2hhckNvZGVBdChtX3BvcyArIDEpOwogICAgICAgICAgICBpZiAoKGMyICYgNjQ1MTIpID09PSA1NjMyMCkgewogICAgICAgICAgICAgIGMgPSA2NTUzNiArIChjIC0gNTUyOTYgPDwgMTApICsgKGMyIC0gNTYzMjApOwogICAgICAgICAgICAgIG1fcG9zKys7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjIDwgMTI4KSB7CiAgICAgICAgICAgIGJ1ZltpKytdID0gYzsKICAgICAgICAgIH0gZWxzZSBpZiAoYyA8IDIwNDgpIHsKICAgICAgICAgICAgYnVmW2krK10gPSAxOTIgfCBjID4+PiA2OwogICAgICAgICAgICBidWZbaSsrXSA9IDEyOCB8IGMgJiA2MzsKICAgICAgICAgIH0gZWxzZSBpZiAoYyA8IDY1NTM2KSB7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMjI0IHwgYyA+Pj4gMTI7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMTI4IHwgYyA+Pj4gNiAmIDYzOwogICAgICAgICAgICBidWZbaSsrXSA9IDEyOCB8IGMgJiA2MzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMjQwIHwgYyA+Pj4gMTg7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMTI4IHwgYyA+Pj4gMTIgJiA2MzsKICAgICAgICAgICAgYnVmW2krK10gPSAxMjggfCBjID4+PiA2ICYgNjM7CiAgICAgICAgICAgIGJ1ZltpKytdID0gMTI4IHwgYyAmIDYzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYnVmOwogICAgICB9OwogICAgICB2YXIgYnVmMmJpbnN0cmluZyA9IChidWYsIGxlbikgPT4gewogICAgICAgIGlmIChsZW4gPCA2NTUzNCkgewogICAgICAgICAgaWYgKGJ1Zi5zdWJhcnJheSAmJiBTVFJfQVBQTFlfVUlBX09LKSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGJ1Zi5sZW5ndGggPT09IGxlbiA/IGJ1ZiA6IGJ1Zi5zdWJhcnJheSgwLCBsZW4pKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IHJlc3VsdCA9ICIiOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIHJlc3VsdCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ1ZltpXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIG1vZHVsZS5leHBvcnRzLmJ1ZjJzdHJpbmcgPSAoYnVmLCBtYXgzKSA9PiB7CiAgICAgICAgY29uc3QgbGVuID0gbWF4MyB8fCBidWYubGVuZ3RoOwogICAgICAgIGlmICh0eXBlb2YgVGV4dERlY29kZXIgPT09ICJmdW5jdGlvbiIgJiYgVGV4dERlY29kZXIucHJvdG90eXBlLmRlY29kZSkgewogICAgICAgICAgcmV0dXJuIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShidWYuc3ViYXJyYXkoMCwgbWF4MykpOwogICAgICAgIH0KICAgICAgICBsZXQgaSwgb3V0OwogICAgICAgIGNvbnN0IHV0ZjE2YnVmID0gbmV3IEFycmF5KGxlbiAqIDIpOwogICAgICAgIGZvciAob3V0ID0gMCwgaSA9IDA7IGkgPCBsZW47ICkgewogICAgICAgICAgbGV0IGMgPSBidWZbaSsrXTsKICAgICAgICAgIGlmIChjIDwgMTI4KSB7CiAgICAgICAgICAgIHV0ZjE2YnVmW291dCsrXSA9IGM7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgbGV0IGNfbGVuID0gX3V0ZjhsZW5bY107CiAgICAgICAgICBpZiAoY19sZW4gPiA0KSB7CiAgICAgICAgICAgIHV0ZjE2YnVmW291dCsrXSA9IDY1NTMzOwogICAgICAgICAgICBpICs9IGNfbGVuIC0gMTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjICY9IGNfbGVuID09PSAyID8gMzEgOiBjX2xlbiA9PT0gMyA/IDE1IDogNzsKICAgICAgICAgIHdoaWxlIChjX2xlbiA+IDEgJiYgaSA8IGxlbikgewogICAgICAgICAgICBjID0gYyA8PCA2IHwgYnVmW2krK10gJiA2MzsKICAgICAgICAgICAgY19sZW4tLTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjX2xlbiA+IDEpIHsKICAgICAgICAgICAgdXRmMTZidWZbb3V0KytdID0gNjU1MzM7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGMgPCA2NTUzNikgewogICAgICAgICAgICB1dGYxNmJ1ZltvdXQrK10gPSBjOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYyAtPSA2NTUzNjsKICAgICAgICAgICAgdXRmMTZidWZbb3V0KytdID0gNTUyOTYgfCBjID4+IDEwICYgMTAyMzsKICAgICAgICAgICAgdXRmMTZidWZbb3V0KytdID0gNTYzMjAgfCBjICYgMTAyMzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJ1ZjJiaW5zdHJpbmcodXRmMTZidWYsIG91dCk7CiAgICAgIH07CiAgICAgIG1vZHVsZS5leHBvcnRzLnV0Zjhib3JkZXIgPSAoYnVmLCBtYXgzKSA9PiB7CiAgICAgICAgbWF4MyA9IG1heDMgfHwgYnVmLmxlbmd0aDsKICAgICAgICBpZiAobWF4MyA+IGJ1Zi5sZW5ndGgpIHsKICAgICAgICAgIG1heDMgPSBidWYubGVuZ3RoOwogICAgICAgIH0KICAgICAgICBsZXQgcG9zID0gbWF4MyAtIDE7CiAgICAgICAgd2hpbGUgKHBvcyA+PSAwICYmIChidWZbcG9zXSAmIDE5MikgPT09IDEyOCkgewogICAgICAgICAgcG9zLS07CiAgICAgICAgfQogICAgICAgIGlmIChwb3MgPCAwKSB7CiAgICAgICAgICByZXR1cm4gbWF4MzsKICAgICAgICB9CiAgICAgICAgaWYgKHBvcyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIG1heDM7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwb3MgKyBfdXRmOGxlbltidWZbcG9zXV0gPiBtYXgzID8gcG9zIDogbWF4MzsKICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvbWVzc2FnZXMuanMKICB2YXIgcmVxdWlyZV9tZXNzYWdlcyA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL21lc3NhZ2VzLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgICAgMjogIm5lZWQgZGljdGlvbmFyeSIsCiAgICAgICAgLyogWl9ORUVEX0RJQ1QgICAgICAgMiAgKi8KICAgICAgICAxOiAic3RyZWFtIGVuZCIsCiAgICAgICAgLyogWl9TVFJFQU1fRU5EICAgICAgMSAgKi8KICAgICAgICAwOiAiIiwKICAgICAgICAvKiBaX09LICAgICAgICAgICAgICAwICAqLwogICAgICAgICItMSI6ICJmaWxlIGVycm9yIiwKICAgICAgICAvKiBaX0VSUk5PICAgICAgICAgKC0xKSAqLwogICAgICAgICItMiI6ICJzdHJlYW0gZXJyb3IiLAogICAgICAgIC8qIFpfU1RSRUFNX0VSUk9SICAoLTIpICovCiAgICAgICAgIi0zIjogImRhdGEgZXJyb3IiLAogICAgICAgIC8qIFpfREFUQV9FUlJPUiAgICAoLTMpICovCiAgICAgICAgIi00IjogImluc3VmZmljaWVudCBtZW1vcnkiLAogICAgICAgIC8qIFpfTUVNX0VSUk9SICAgICAoLTQpICovCiAgICAgICAgIi01IjogImJ1ZmZlciBlcnJvciIsCiAgICAgICAgLyogWl9CVUZfRVJST1IgICAgICgtNSkgKi8KICAgICAgICAiLTYiOiAiaW5jb21wYXRpYmxlIHZlcnNpb24iCiAgICAgICAgLyogWl9WRVJTSU9OX0VSUk9SICgtNikgKi8KICAgICAgfTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvenN0cmVhbS5qcwogIHZhciByZXF1aXJlX3pzdHJlYW0gPSBfX2NvbW1vbkpTKHsKICAgICJub2RlX21vZHVsZXMvcGFrby9saWIvemxpYi96c3RyZWFtLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgZnVuY3Rpb24gWlN0cmVhbSgpIHsKICAgICAgICB0aGlzLmlucHV0ID0gbnVsbDsKICAgICAgICB0aGlzLm5leHRfaW4gPSAwOwogICAgICAgIHRoaXMuYXZhaWxfaW4gPSAwOwogICAgICAgIHRoaXMudG90YWxfaW4gPSAwOwogICAgICAgIHRoaXMub3V0cHV0ID0gbnVsbDsKICAgICAgICB0aGlzLm5leHRfb3V0ID0gMDsKICAgICAgICB0aGlzLmF2YWlsX291dCA9IDA7CiAgICAgICAgdGhpcy50b3RhbF9vdXQgPSAwOwogICAgICAgIHRoaXMubXNnID0gIiI7CiAgICAgICAgdGhpcy5zdGF0ZSA9IG51bGw7CiAgICAgICAgdGhpcy5kYXRhX3R5cGUgPSAyOwogICAgICAgIHRoaXMuYWRsZXIgPSAwOwogICAgICB9CiAgICAgIG1vZHVsZS5leHBvcnRzID0gWlN0cmVhbTsKICAgIH0KICB9KTsKCiAgLy8gbm9kZV9tb2R1bGVzL3Bha28vbGliL3psaWIvZ3poZWFkZXIuanMKICB2YXIgcmVxdWlyZV9nemhlYWRlciA9IF9fY29tbW9uSlMoewogICAgIm5vZGVfbW9kdWxlcy9wYWtvL2xpYi96bGliL2d6aGVhZGVyLmpzIihleHBvcnRzMiwgbW9kdWxlKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgZnVuY3Rpb24gR1poZWFkZXIoKSB7CiAgICAgICAgdGhpcy50ZXh0ID0gMDsKICAgICAgICB0aGlzLnRpbWUgPSAwOwogICAgICAgIHRoaXMueGZsYWdzID0gMDsKICAgICAgICB0aGlzLm9zID0gMDsKICAgICAgICB0aGlzLmV4dHJhID0gbnVsbDsKICAgICAgICB0aGlzLmV4dHJhX2xlbiA9IDA7CiAgICAgICAgdGhpcy5uYW1lID0gIiI7CiAgICAgICAgdGhpcy5jb21tZW50ID0gIiI7CiAgICAgICAgdGhpcy5oY3JjID0gMDsKICAgICAgICB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgfQogICAgICBtb2R1bGUuZXhwb3J0cyA9IEdaaGVhZGVyOwogICAgfQogIH0pOwoKICAvLyBub2RlX21vZHVsZXMvcGFrby9saWIvaW5mbGF0ZS5qcwogIHZhciByZXF1aXJlX2luZmxhdGUyID0gX19jb21tb25KUyh7CiAgICAibm9kZV9tb2R1bGVzL3Bha28vbGliL2luZmxhdGUuanMiKGV4cG9ydHMyLCBtb2R1bGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgemxpYl9pbmZsYXRlID0gcmVxdWlyZV9pbmZsYXRlKCk7CiAgICAgIHZhciB1dGlscyA9IHJlcXVpcmVfY29tbW9uKCk7CiAgICAgIHZhciBzdHJpbmdzID0gcmVxdWlyZV9zdHJpbmdzKCk7CiAgICAgIHZhciBtc2cgPSByZXF1aXJlX21lc3NhZ2VzKCk7CiAgICAgIHZhciBaU3RyZWFtID0gcmVxdWlyZV96c3RyZWFtKCk7CiAgICAgIHZhciBHWmhlYWRlciA9IHJlcXVpcmVfZ3poZWFkZXIoKTsKICAgICAgdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKICAgICAgdmFyIHsKICAgICAgICBaX05PX0ZMVVNILAogICAgICAgIFpfRklOSVNILAogICAgICAgIFpfT0ssCiAgICAgICAgWl9TVFJFQU1fRU5ELAogICAgICAgIFpfTkVFRF9ESUNULAogICAgICAgIFpfU1RSRUFNX0VSUk9SLAogICAgICAgIFpfREFUQV9FUlJPUiwKICAgICAgICBaX01FTV9FUlJPUgogICAgICB9ID0gcmVxdWlyZV9jb25zdGFudHMoKTsKICAgICAgZnVuY3Rpb24gSW5mbGF0ZShvcHRpb25zKSB7CiAgICAgICAgdGhpcy5vcHRpb25zID0gdXRpbHMuYXNzaWduKHsKICAgICAgICAgIGNodW5rU2l6ZTogMTAyNCAqIDY0LAogICAgICAgICAgd2luZG93Qml0czogMTUsCiAgICAgICAgICB0bzogIiIKICAgICAgICB9LCBvcHRpb25zIHx8IHt9KTsKICAgICAgICBjb25zdCBvcHQgPSB0aGlzLm9wdGlvbnM7CiAgICAgICAgaWYgKG9wdC5yYXcgJiYgb3B0LndpbmRvd0JpdHMgPj0gMCAmJiBvcHQud2luZG93Qml0cyA8IDE2KSB7CiAgICAgICAgICBvcHQud2luZG93Qml0cyA9IC1vcHQud2luZG93Qml0czsKICAgICAgICAgIGlmIChvcHQud2luZG93Qml0cyA9PT0gMCkgewogICAgICAgICAgICBvcHQud2luZG93Qml0cyA9IC0xNTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG9wdC53aW5kb3dCaXRzID49IDAgJiYgb3B0LndpbmRvd0JpdHMgPCAxNiAmJiAhKG9wdGlvbnMgJiYgb3B0aW9ucy53aW5kb3dCaXRzKSkgewogICAgICAgICAgb3B0LndpbmRvd0JpdHMgKz0gMzI7CiAgICAgICAgfQogICAgICAgIGlmIChvcHQud2luZG93Qml0cyA+IDE1ICYmIG9wdC53aW5kb3dCaXRzIDwgNDgpIHsKICAgICAgICAgIGlmICgob3B0LndpbmRvd0JpdHMgJiAxNSkgPT09IDApIHsKICAgICAgICAgICAgb3B0LndpbmRvd0JpdHMgfD0gMTU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuZXJyID0gMDsKICAgICAgICB0aGlzLm1zZyA9ICIiOwogICAgICAgIHRoaXMuZW5kZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLmNodW5rcyA9IFtdOwogICAgICAgIHRoaXMuc3RybSA9IG5ldyBaU3RyZWFtKCk7CiAgICAgICAgdGhpcy5zdHJtLmF2YWlsX291dCA9IDA7CiAgICAgICAgbGV0IHN0YXR1cyA9IHpsaWJfaW5mbGF0ZS5pbmZsYXRlSW5pdDIoCiAgICAgICAgICB0aGlzLnN0cm0sCiAgICAgICAgICBvcHQud2luZG93Qml0cwogICAgICAgICk7CiAgICAgICAgaWYgKHN0YXR1cyAhPT0gWl9PSykgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZ1tzdGF0dXNdKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5oZWFkZXIgPSBuZXcgR1poZWFkZXIoKTsKICAgICAgICB6bGliX2luZmxhdGUuaW5mbGF0ZUdldEhlYWRlcih0aGlzLnN0cm0sIHRoaXMuaGVhZGVyKTsKICAgICAgICBpZiAob3B0LmRpY3Rpb25hcnkpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygb3B0LmRpY3Rpb25hcnkgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIG9wdC5kaWN0aW9uYXJ5ID0gc3RyaW5ncy5zdHJpbmcyYnVmKG9wdC5kaWN0aW9uYXJ5KTsKICAgICAgICAgIH0gZWxzZSBpZiAodG9TdHJpbmcuY2FsbChvcHQuZGljdGlvbmFyeSkgPT09ICJbb2JqZWN0IEFycmF5QnVmZmVyXSIpIHsKICAgICAgICAgICAgb3B0LmRpY3Rpb25hcnkgPSBuZXcgVWludDhBcnJheShvcHQuZGljdGlvbmFyeSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob3B0LnJhdykgewogICAgICAgICAgICBzdGF0dXMgPSB6bGliX2luZmxhdGUuaW5mbGF0ZVNldERpY3Rpb25hcnkodGhpcy5zdHJtLCBvcHQuZGljdGlvbmFyeSk7CiAgICAgICAgICAgIGlmIChzdGF0dXMgIT09IFpfT0spIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnW3N0YXR1c10pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIEluZmxhdGUucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbihkYXRhLCBmbHVzaF9tb2RlKSB7CiAgICAgICAgY29uc3Qgc3RybSA9IHRoaXMuc3RybTsKICAgICAgICBjb25zdCBjaHVua1NpemUgPSB0aGlzLm9wdGlvbnMuY2h1bmtTaXplOwogICAgICAgIGNvbnN0IGRpY3Rpb25hcnkgPSB0aGlzLm9wdGlvbnMuZGljdGlvbmFyeTsKICAgICAgICBsZXQgc3RhdHVzLCBfZmx1c2hfbW9kZSwgbGFzdF9hdmFpbF9vdXQ7CiAgICAgICAgaWYgKHRoaXMuZW5kZWQpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoZmx1c2hfbW9kZSA9PT0gfn5mbHVzaF9tb2RlKSBfZmx1c2hfbW9kZSA9IGZsdXNoX21vZGU7CiAgICAgICAgZWxzZSBfZmx1c2hfbW9kZSA9IGZsdXNoX21vZGUgPT09IHRydWUgPyBaX0ZJTklTSCA6IFpfTk9fRkxVU0g7CiAgICAgICAgaWYgKHRvU3RyaW5nLmNhbGwoZGF0YSkgPT09ICJbb2JqZWN0IEFycmF5QnVmZmVyXSIpIHsKICAgICAgICAgIHN0cm0uaW5wdXQgPSBuZXcgVWludDhBcnJheShkYXRhKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RybS5pbnB1dCA9IGRhdGE7CiAgICAgICAgfQogICAgICAgIHN0cm0ubmV4dF9pbiA9IDA7CiAgICAgICAgc3RybS5hdmFpbF9pbiA9IHN0cm0uaW5wdXQubGVuZ3RoOwogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgaWYgKHN0cm0uYXZhaWxfb3V0ID09PSAwKSB7CiAgICAgICAgICAgIHN0cm0ub3V0cHV0ID0gbmV3IFVpbnQ4QXJyYXkoY2h1bmtTaXplKTsKICAgICAgICAgICAgc3RybS5uZXh0X291dCA9IDA7CiAgICAgICAgICAgIHN0cm0uYXZhaWxfb3V0ID0gY2h1bmtTaXplOwogICAgICAgICAgfQogICAgICAgICAgc3RhdHVzID0gemxpYl9pbmZsYXRlLmluZmxhdGUoc3RybSwgX2ZsdXNoX21vZGUpOwogICAgICAgICAgaWYgKHN0YXR1cyA9PT0gWl9ORUVEX0RJQ1QgJiYgZGljdGlvbmFyeSkgewogICAgICAgICAgICBzdGF0dXMgPSB6bGliX2luZmxhdGUuaW5mbGF0ZVNldERpY3Rpb25hcnkoc3RybSwgZGljdGlvbmFyeSk7CiAgICAgICAgICAgIGlmIChzdGF0dXMgPT09IFpfT0spIHsKICAgICAgICAgICAgICBzdGF0dXMgPSB6bGliX2luZmxhdGUuaW5mbGF0ZShzdHJtLCBfZmx1c2hfbW9kZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID09PSBaX0RBVEFfRVJST1IpIHsKICAgICAgICAgICAgICBzdGF0dXMgPSBaX05FRURfRElDVDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHN0cm0uYXZhaWxfaW4gPiAwICYmIHN0YXR1cyA9PT0gWl9TVFJFQU1fRU5EICYmIHN0cm0uc3RhdGUud3JhcCA+IDAgJiYgZGF0YVtzdHJtLm5leHRfaW5dICE9PSAwKSB7CiAgICAgICAgICAgIHpsaWJfaW5mbGF0ZS5pbmZsYXRlUmVzZXQoc3RybSk7CiAgICAgICAgICAgIHN0YXR1cyA9IHpsaWJfaW5mbGF0ZS5pbmZsYXRlKHN0cm0sIF9mbHVzaF9tb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAoc3RhdHVzKSB7CiAgICAgICAgICAgIGNhc2UgWl9TVFJFQU1fRVJST1I6CiAgICAgICAgICAgIGNhc2UgWl9EQVRBX0VSUk9SOgogICAgICAgICAgICBjYXNlIFpfTkVFRF9ESUNUOgogICAgICAgICAgICBjYXNlIFpfTUVNX0VSUk9SOgogICAgICAgICAgICAgIHRoaXMub25FbmQoc3RhdHVzKTsKICAgICAgICAgICAgICB0aGlzLmVuZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBsYXN0X2F2YWlsX291dCA9IHN0cm0uYXZhaWxfb3V0OwogICAgICAgICAgaWYgKHN0cm0ubmV4dF9vdXQpIHsKICAgICAgICAgICAgaWYgKHN0cm0uYXZhaWxfb3V0ID09PSAwIHx8IHN0YXR1cyA9PT0gWl9TVFJFQU1fRU5EKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy50byA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGxldCBuZXh0X291dF91dGY4ID0gc3RyaW5ncy51dGY4Ym9yZGVyKHN0cm0ub3V0cHV0LCBzdHJtLm5leHRfb3V0KTsKICAgICAgICAgICAgICAgIGxldCB0YWlsID0gc3RybS5uZXh0X291dCAtIG5leHRfb3V0X3V0Zjg7CiAgICAgICAgICAgICAgICBsZXQgdXRmOHN0ciA9IHN0cmluZ3MuYnVmMnN0cmluZyhzdHJtLm91dHB1dCwgbmV4dF9vdXRfdXRmOCk7CiAgICAgICAgICAgICAgICBzdHJtLm5leHRfb3V0ID0gdGFpbDsKICAgICAgICAgICAgICAgIHN0cm0uYXZhaWxfb3V0ID0gY2h1bmtTaXplIC0gdGFpbDsKICAgICAgICAgICAgICAgIGlmICh0YWlsKSBzdHJtLm91dHB1dC5zZXQoc3RybS5vdXRwdXQuc3ViYXJyYXkobmV4dF9vdXRfdXRmOCwgbmV4dF9vdXRfdXRmOCArIHRhaWwpLCAwKTsKICAgICAgICAgICAgICAgIHRoaXMub25EYXRhKHV0ZjhzdHIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLm9uRGF0YShzdHJtLm91dHB1dC5sZW5ndGggPT09IHN0cm0ubmV4dF9vdXQgPyBzdHJtLm91dHB1dCA6IHN0cm0ub3V0cHV0LnN1YmFycmF5KDAsIHN0cm0ubmV4dF9vdXQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdGF0dXMgPT09IFpfT0sgJiYgbGFzdF9hdmFpbF9vdXQgPT09IDApIGNvbnRpbnVlOwogICAgICAgICAgaWYgKHN0YXR1cyA9PT0gWl9TVFJFQU1fRU5EKSB7CiAgICAgICAgICAgIHN0YXR1cyA9IHpsaWJfaW5mbGF0ZS5pbmZsYXRlRW5kKHRoaXMuc3RybSk7CiAgICAgICAgICAgIHRoaXMub25FbmQoc3RhdHVzKTsKICAgICAgICAgICAgdGhpcy5lbmRlZCA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHN0cm0uYXZhaWxfaW4gPT09IDApIGJyZWFrOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfTsKICAgICAgSW5mbGF0ZS5wcm90b3R5cGUub25EYXRhID0gZnVuY3Rpb24oY2h1bmspIHsKICAgICAgICB0aGlzLmNodW5rcy5wdXNoKGNodW5rKTsKICAgICAgfTsKICAgICAgSW5mbGF0ZS5wcm90b3R5cGUub25FbmQgPSBmdW5jdGlvbihzdGF0dXMpIHsKICAgICAgICBpZiAoc3RhdHVzID09PSBaX09LKSB7CiAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnRvID09PSAic3RyaW5nIikgewogICAgICAgICAgICB0aGlzLnJlc3VsdCA9IHRoaXMuY2h1bmtzLmpvaW4oIiIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5yZXN1bHQgPSB1dGlscy5mbGF0dGVuQ2h1bmtzKHRoaXMuY2h1bmtzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5jaHVua3MgPSBbXTsKICAgICAgICB0aGlzLmVyciA9IHN0YXR1czsKICAgICAgICB0aGlzLm1zZyA9IHRoaXMuc3RybS5tc2c7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIGluZmxhdGUoaW5wdXQsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBpbmZsYXRvciA9IG5ldyBJbmZsYXRlKG9wdGlvbnMpOwogICAgICAgIGluZmxhdG9yLnB1c2goaW5wdXQpOwogICAgICAgIGlmIChpbmZsYXRvci5lcnIpIHRocm93IGluZmxhdG9yLm1zZyB8fCBtc2dbaW5mbGF0b3IuZXJyXTsKICAgICAgICByZXR1cm4gaW5mbGF0b3IucmVzdWx0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGluZmxhdGVSYXcoaW5wdXQsIG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICBvcHRpb25zLnJhdyA9IHRydWU7CiAgICAgICAgcmV0dXJuIGluZmxhdGUoaW5wdXQsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIG1vZHVsZS5leHBvcnRzLkluZmxhdGUgPSBJbmZsYXRlOwogICAgICBtb2R1bGUuZXhwb3J0cy5pbmZsYXRlID0gaW5mbGF0ZTsKICAgICAgbW9kdWxlLmV4cG9ydHMuaW5mbGF0ZVJhdyA9IGluZmxhdGVSYXc7CiAgICAgIG1vZHVsZS5leHBvcnRzLnVuZ3ppcCA9IGluZmxhdGU7CiAgICAgIG1vZHVsZS5leHBvcnRzLmNvbnN0YW50cyA9IHJlcXVpcmVfY29uc3RhbnRzKCk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9kZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQuanMKICB2YXIgZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0X2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXRfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0X2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgdHlwZSA9IFR5cGVzLmZyb21TdHJpbmcocGFyYW1ldGVycy50eXBlKTsKICAgIGxldCBidWZmZXIgPSBwYXJhbWV0ZXJzLmJ1ZmZlcjsKICAgIGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZURhdGFfZGVmYXVsdChwYXJhbWV0ZXJzLmtleSwgYnVmZmVyKTsKICAgIGNvbnN0IHVuY29tcHJlc3NlZFRlcnJhaW4gPSB1bmNvbXByZXNzUGFja2V0KGJ1ZmZlcik7CiAgICBidWZmZXIgPSB1bmNvbXByZXNzZWRUZXJyYWluLmJ1ZmZlcjsKICAgIGNvbnN0IGxlbmd0aCA9IHVuY29tcHJlc3NlZFRlcnJhaW4ubGVuZ3RoOwogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgVHlwZXMuTUVUQURBVEE6CiAgICAgICAgcmV0dXJuIHByb2Nlc3NNZXRhZGF0YShidWZmZXIsIGxlbmd0aCwgcGFyYW1ldGVycy5xdWFkS2V5KTsKICAgICAgY2FzZSBUeXBlcy5URVJSQUlOOgogICAgICAgIHJldHVybiBwcm9jZXNzVGVycmFpbihidWZmZXIsIGxlbmd0aCwgdHJhbnNmZXJhYmxlT2JqZWN0cyk7CiAgICAgIGNhc2UgVHlwZXMuREJST09UOgogICAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMucHVzaChidWZmZXIpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBidWZmZXIKICAgICAgICB9OwogICAgfQogIH0KICBmdW5jdGlvbiBwcm9jZXNzTWV0YWRhdGEoYnVmZmVyLCB0b3RhbFNpemUsIHF1YWRLZXkpIHsKICAgIGNvbnN0IGR2ID0gbmV3IERhdGFWaWV3KGJ1ZmZlcik7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGNvbnN0IG1hZ2ljID0gZHYuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDMyMjsKICAgIGlmIChtYWdpYyAhPT0gcXRNYWdpYykgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgbWFnaWMiKTsKICAgIH0KICAgIGNvbnN0IGRhdGFUeXBlSWQgPSBkdi5nZXRVaW50MzIob2Zmc2V0LCB0cnVlKTsKICAgIG9mZnNldCArPSBzaXplT2ZVaW50MzIyOwogICAgaWYgKGRhdGFUeXBlSWQgIT09IDEpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJJbnZhbGlkIGRhdGEgdHlwZS4gTXVzdCBiZSAxIGZvciBRdWFkVHJlZVBhY2tldCIpOwogICAgfQogICAgY29uc3QgcXVhZFZlcnNpb24gPSBkdi5nZXRVaW50MzIob2Zmc2V0LCB0cnVlKTsKICAgIG9mZnNldCArPSBzaXplT2ZVaW50MzIyOwogICAgaWYgKHF1YWRWZXJzaW9uICE9PSAyKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgKICAgICAgICAiSW52YWxpZCBRdWFkVHJlZVBhY2tldCB2ZXJzaW9uLiBPbmx5IHZlcnNpb24gMiBpcyBzdXBwb3J0ZWQuIgogICAgICApOwogICAgfQogICAgY29uc3QgbnVtSW5zdGFuY2VzID0gZHYuZ2V0SW50MzIob2Zmc2V0LCB0cnVlKTsKICAgIG9mZnNldCArPSBzaXplT2ZJbnQzMjI7CiAgICBjb25zdCBkYXRhSW5zdGFuY2VTaXplID0gZHYuZ2V0SW50MzIob2Zmc2V0LCB0cnVlKTsKICAgIG9mZnNldCArPSBzaXplT2ZJbnQzMjI7CiAgICBpZiAoZGF0YUluc3RhbmNlU2l6ZSAhPT0gMzIpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJJbnZhbGlkIGluc3RhbmNlIHNpemUuIik7CiAgICB9CiAgICBjb25zdCBkYXRhQnVmZmVyT2Zmc2V0ID0gZHYuZ2V0SW50MzIob2Zmc2V0LCB0cnVlKTsKICAgIG9mZnNldCArPSBzaXplT2ZJbnQzMjI7CiAgICBjb25zdCBkYXRhQnVmZmVyU2l6ZSA9IGR2LmdldEludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICBvZmZzZXQgKz0gc2l6ZU9mSW50MzIyOwogICAgY29uc3QgbWV0YUJ1ZmZlclNpemUgPSBkdi5nZXRJbnQzMihvZmZzZXQsIHRydWUpOwogICAgb2Zmc2V0ICs9IHNpemVPZkludDMyMjsKICAgIGlmIChkYXRhQnVmZmVyT2Zmc2V0ICE9PSBudW1JbnN0YW5jZXMgKiBkYXRhSW5zdGFuY2VTaXplICsgb2Zmc2V0KSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiSW52YWxpZCBkYXRhQnVmZmVyT2Zmc2V0Iik7CiAgICB9CiAgICBpZiAoZGF0YUJ1ZmZlck9mZnNldCArIGRhdGFCdWZmZXJTaXplICsgbWV0YUJ1ZmZlclNpemUgIT09IHRvdGFsU2l6ZSkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIkludmFsaWQgcGFja2V0IG9mZnNldHMiKTsKICAgIH0KICAgIGNvbnN0IGluc3RhbmNlcyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1JbnN0YW5jZXM7ICsraSkgewogICAgICBjb25zdCBiaXRmaWVsZCA9IGR2LmdldFVpbnQ4KG9mZnNldCk7CiAgICAgICsrb2Zmc2V0OwogICAgICArK29mZnNldDsKICAgICAgY29uc3QgY25vZGVWZXJzaW9uID0gZHYuZ2V0VWludDE2KG9mZnNldCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSBzaXplT2ZVaW50MTYyOwogICAgICBjb25zdCBpbWFnZVZlcnNpb24gPSBkdi5nZXRVaW50MTYob2Zmc2V0LCB0cnVlKTsKICAgICAgb2Zmc2V0ICs9IHNpemVPZlVpbnQxNjI7CiAgICAgIGNvbnN0IHRlcnJhaW5WZXJzaW9uID0gZHYuZ2V0VWludDE2KG9mZnNldCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSBzaXplT2ZVaW50MTYyOwogICAgICBvZmZzZXQgKz0gc2l6ZU9mVWludDE2MjsKICAgICAgb2Zmc2V0ICs9IHNpemVPZlVpbnQxNjI7CiAgICAgIG9mZnNldCArPSBzaXplT2ZJbnQzMjI7CiAgICAgIG9mZnNldCArPSBzaXplT2ZJbnQzMjI7CiAgICAgIG9mZnNldCArPSA4OwogICAgICBjb25zdCBpbWFnZVByb3ZpZGVyID0gZHYuZ2V0VWludDgob2Zmc2V0KyspOwogICAgICBjb25zdCB0ZXJyYWluUHJvdmlkZXIgPSBkdi5nZXRVaW50OChvZmZzZXQrKyk7CiAgICAgIG9mZnNldCArPSBzaXplT2ZVaW50MTYyOwogICAgICBpbnN0YW5jZXMucHVzaCgKICAgICAgICBuZXcgR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uX2RlZmF1bHQoCiAgICAgICAgICBiaXRmaWVsZCwKICAgICAgICAgIGNub2RlVmVyc2lvbiwKICAgICAgICAgIGltYWdlVmVyc2lvbiwKICAgICAgICAgIHRlcnJhaW5WZXJzaW9uLAogICAgICAgICAgaW1hZ2VQcm92aWRlciwKICAgICAgICAgIHRlcnJhaW5Qcm92aWRlcgogICAgICAgICkKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IHRpbGVJbmZvID0gW107CiAgICBsZXQgaW5kZXggPSAwOwogICAgZnVuY3Rpb24gcG9wdWxhdGVUaWxlcyhwYXJlbnRLZXksIHBhcmVudCwgbGV2ZWwyKSB7CiAgICAgIGxldCBpc0xlYWYgPSBmYWxzZTsKICAgICAgaWYgKGxldmVsMiA9PT0gNCkgewogICAgICAgIGlmIChwYXJlbnQuaGFzU3VidHJlZSgpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlzTGVhZiA9IHRydWU7CiAgICAgIH0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyArK2kpIHsKICAgICAgICBjb25zdCBjaGlsZEtleSA9IHBhcmVudEtleSArIGkudG9TdHJpbmcoKTsKICAgICAgICBpZiAoaXNMZWFmKSB7CiAgICAgICAgICB0aWxlSW5mb1tjaGlsZEtleV0gPSBudWxsOwogICAgICAgIH0gZWxzZSBpZiAobGV2ZWwyIDwgNCkgewogICAgICAgICAgaWYgKCFwYXJlbnQuaGFzQ2hpbGQoaSkpIHsKICAgICAgICAgICAgdGlsZUluZm9bY2hpbGRLZXldID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gbnVtSW5zdGFuY2VzKSB7CiAgICAgICAgICAgICAgY29uc29sZS5sb2coIkluY29ycmVjdCBudW1iZXIgb2YgaW5zdGFuY2VzIik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGluc3RhbmNlID0gaW5zdGFuY2VzW2luZGV4KytdOwogICAgICAgICAgICB0aWxlSW5mb1tjaGlsZEtleV0gPSBpbnN0YW5jZTsKICAgICAgICAgICAgcG9wdWxhdGVUaWxlcyhjaGlsZEtleSwgaW5zdGFuY2UsIGxldmVsMiArIDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgbGV0IGxldmVsID0gMDsKICAgIGNvbnN0IHJvb3QgPSBpbnN0YW5jZXNbaW5kZXgrK107CiAgICBpZiAocXVhZEtleSA9PT0gIiIpIHsKICAgICAgKytsZXZlbDsKICAgIH0gZWxzZSB7CiAgICAgIHRpbGVJbmZvW3F1YWRLZXldID0gcm9vdDsKICAgIH0KICAgIHBvcHVsYXRlVGlsZXMocXVhZEtleSwgcm9vdCwgbGV2ZWwpOwogICAgcmV0dXJuIHRpbGVJbmZvOwogIH0KICBmdW5jdGlvbiBwcm9jZXNzVGVycmFpbihidWZmZXIsIHRvdGFsU2l6ZSwgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3QgZHYgPSBuZXcgRGF0YVZpZXcoYnVmZmVyKTsKICAgIGNvbnN0IGFkdmFuY2VNZXNoID0gZnVuY3Rpb24ocG9zKSB7CiAgICAgIGZvciAobGV0IHN1YiA9IDA7IHN1YiA8IG51bVN1Yk1lc2hlc1Blck1lc2g7ICsrc3ViKSB7CiAgICAgICAgY29uc3Qgc2l6ZSA9IGR2LmdldFVpbnQzMihwb3MsIHRydWUpOwogICAgICAgIHBvcyArPSBzaXplT2ZVaW50MzIyOwogICAgICAgIHBvcyArPSBzaXplOwogICAgICAgIGlmIChwb3MgPiB0b3RhbFNpemUpIHsKICAgICAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiTWFsZm9ybWVkIHRlcnJhaW4gcGFja2V0IGZvdW5kLiIpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcG9zOwogICAgfTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgY29uc3QgdGVycmFpbk1lc2hlcyA9IFtdOwogICAgd2hpbGUgKHRlcnJhaW5NZXNoZXMubGVuZ3RoIDwgbnVtTWVzaGVzUGVyUGFja2V0KSB7CiAgICAgIGNvbnN0IHN0YXJ0ID0gb2Zmc2V0OwogICAgICBvZmZzZXQgPSBhZHZhbmNlTWVzaChvZmZzZXQpOwogICAgICBjb25zdCBtZXNoID0gYnVmZmVyLnNsaWNlKHN0YXJ0LCBvZmZzZXQpOwogICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2gobWVzaCk7CiAgICAgIHRlcnJhaW5NZXNoZXMucHVzaChtZXNoKTsKICAgIH0KICAgIHJldHVybiB0ZXJyYWluTWVzaGVzOwogIH0KICBmdW5jdGlvbiB1bmNvbXByZXNzUGFja2V0KGRhdGEpIHsKICAgIGNvbnN0IGR2ID0gbmV3IERhdGFWaWV3KGRhdGEpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBjb25zdCBtYWdpYyA9IGR2LmdldFVpbnQzMihvZmZzZXQsIHRydWUpOwogICAgb2Zmc2V0ICs9IHNpemVPZlVpbnQzMjI7CiAgICBpZiAobWFnaWMgIT09IGNvbXByZXNzZWRNYWdpYzIgJiYgbWFnaWMgIT09IGNvbXByZXNzZWRNYWdpY1N3YXAyKSB7CiAgICAgIHRocm93IG5ldyBSdW50aW1lRXJyb3JfZGVmYXVsdCgiSW52YWxpZCBtYWdpYyIpOwogICAgfQogICAgY29uc3Qgc2l6ZSA9IGR2LmdldFVpbnQzMihvZmZzZXQsIG1hZ2ljID09PSBjb21wcmVzc2VkTWFnaWMyKTsKICAgIG9mZnNldCArPSBzaXplT2ZVaW50MzIyOwogICAgY29uc3QgY29tcHJlc3NlZFBhY2tldCA9IG5ldyBVaW50OEFycmF5KGRhdGEsIG9mZnNldCk7CiAgICBjb25zdCB1bmNvbXByZXNzZWRQYWNrZXQgPSBpbXBvcnRfaW5mbGF0ZS5kZWZhdWx0LmluZmxhdGUoY29tcHJlc3NlZFBhY2tldCk7CiAgICBpZiAodW5jb21wcmVzc2VkUGFja2V0Lmxlbmd0aCAhPT0gc2l6ZSkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIlNpemUgb2YgcGFja2V0IGRvZXNuJ3QgbWF0Y2ggaGVhZGVyIik7CiAgICB9CiAgICByZXR1cm4gdW5jb21wcmVzc2VkUGFja2V0OwogIH0KICB2YXIgaW1wb3J0X2luZmxhdGUsIHNpemVPZlVpbnQxNjIsIHNpemVPZkludDMyMiwgc2l6ZU9mVWludDMyMiwgVHlwZXMsIHF0TWFnaWMsIG51bU1lc2hlc1BlclBhY2tldCwgbnVtU3ViTWVzaGVzUGVyTWVzaCwgY29tcHJlc3NlZE1hZ2ljMiwgY29tcHJlc3NlZE1hZ2ljU3dhcDIsIGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldF9kZWZhdWx0OwogIHZhciBpbml0X2RlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldCA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0LmpzIigpIHsKICAgICAgaW5pdF9kZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VEYXRhKCk7CiAgICAgIGluaXRfR29vZ2xlRWFydGhFbnRlcnByaXNlVGlsZUluZm9ybWF0aW9uKCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIGltcG9ydF9pbmZsYXRlID0gX190b0VTTShyZXF1aXJlX2luZmxhdGUyKCksIDEpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgc2l6ZU9mVWludDE2MiA9IFVpbnQxNkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICBzaXplT2ZJbnQzMjIgPSBJbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgICBzaXplT2ZVaW50MzIyID0gVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgIFR5cGVzID0gewogICAgICAgIE1FVEFEQVRBOiAwLAogICAgICAgIFRFUlJBSU46IDEsCiAgICAgICAgREJST09UOiAyCiAgICAgIH07CiAgICAgIFR5cGVzLmZyb21TdHJpbmcgPSBmdW5jdGlvbihzKSB7CiAgICAgICAgaWYgKHMgPT09ICJNZXRhZGF0YSIpIHsKICAgICAgICAgIHJldHVybiBUeXBlcy5NRVRBREFUQTsKICAgICAgICB9IGVsc2UgaWYgKHMgPT09ICJUZXJyYWluIikgewogICAgICAgICAgcmV0dXJuIFR5cGVzLlRFUlJBSU47CiAgICAgICAgfSBlbHNlIGlmIChzID09PSAiRGJSb290IikgewogICAgICAgICAgcmV0dXJuIFR5cGVzLkRCUk9PVDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHF0TWFnaWMgPSAzMjMwMTsKICAgICAgbnVtTWVzaGVzUGVyUGFja2V0ID0gNTsKICAgICAgbnVtU3ViTWVzaGVzUGVyTWVzaCA9IDQ7CiAgICAgIGNvbXByZXNzZWRNYWdpYzIgPSAxOTUzMDI5ODA1OwogICAgICBjb21wcmVzc2VkTWFnaWNTd2FwMiA9IDI5MTcwMzQxMDA7CiAgICAgIGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldF9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldCk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9zcmdiVG9MaW5lYXIuanMKICBmdW5jdGlvbiBzcmdiVG9MaW5lYXIodmFsdWUpIHsKICAgIENoZWNrX2RlZmF1bHQuZGVmaW5lZCgidmFsdWUiLCB2YWx1ZSk7CiAgICBpZiAodmFsdWUgPD0gMC4wNDA0NSkgewogICAgICByZXR1cm4gdmFsdWUgKiAwLjA3NzM5OTM4MDgwNDk1MzU3OwogICAgfQogICAgcmV0dXJuIE1hdGgucG93KAogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tbG9zcy1vZi1wcmVjaXNpb24KICAgICAgKHZhbHVlICsgMC4wNTUpICogMC45NDc4NjcyOTg1NzgxOTkxLAogICAgICAyLjQKICAgICk7CiAgfQogIHZhciBzcmdiVG9MaW5lYXJfZGVmYXVsdDsKICB2YXIgaW5pdF9zcmdiVG9MaW5lYXIgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL3NyZ2JUb0xpbmVhci5qcyIoKSB7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgc3JnYlRvTGluZWFyX2RlZmF1bHQgPSBzcmdiVG9MaW5lYXI7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9kZWNvZGVJM1MuanMKICB2YXIgZGVjb2RlSTNTX2V4cG9ydHMgPSB7fTsKICBfX2V4cG9ydChkZWNvZGVJM1NfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gZGVjb2RlSTNTX2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiBiaWxpbmVhckludGVycG9sYXRlKHR4LCB0eSwgaDAwLCBoMTAsIGgwMSwgaDExKSB7CiAgICBjb25zdCBhMyA9IGgwMCAqICgxIC0gdHgpICsgaDEwICogdHg7CiAgICBjb25zdCBiID0gaDAxICogKDEgLSB0eCkgKyBoMTEgKiB0eDsKICAgIHJldHVybiBhMyAqICgxIC0gdHkpICsgYiAqIHR5OwogIH0KICBmdW5jdGlvbiBzYW1wbGVNYXAodTMsIHYzLCB3aWR0aCwgZGF0YSkgewogICAgY29uc3QgYWRkcmVzcyA9IHUzICsgdjMgKiB3aWR0aDsKICAgIHJldHVybiBkYXRhW2FkZHJlc3NdOwogIH0KICBmdW5jdGlvbiBzYW1wbGVHZW9pZChzYW1wbGVYLCBzYW1wbGVZLCBnZW9pZERhdGEpIHsKICAgIGNvbnN0IGV4dGVudCA9IGdlb2lkRGF0YS5uYXRpdmVFeHRlbnQ7CiAgICBsZXQgeCA9IChzYW1wbGVYIC0gZXh0ZW50Lndlc3QpIC8gKGV4dGVudC5lYXN0IC0gZXh0ZW50Lndlc3QpICogKGdlb2lkRGF0YS53aWR0aCAtIDEpOwogICAgbGV0IHkgPSAoc2FtcGxlWSAtIGV4dGVudC5zb3V0aCkgLyAoZXh0ZW50Lm5vcnRoIC0gZXh0ZW50LnNvdXRoKSAqIChnZW9pZERhdGEuaGVpZ2h0IC0gMSk7CiAgICBjb25zdCB4aSA9IE1hdGguZmxvb3IoeCk7CiAgICBsZXQgeWkgPSBNYXRoLmZsb29yKHkpOwogICAgeCAtPSB4aTsKICAgIHkgLT0geWk7CiAgICBjb25zdCB4TmV4dCA9IHhpIDwgZ2VvaWREYXRhLndpZHRoID8geGkgKyAxIDogeGk7CiAgICBsZXQgeU5leHQgPSB5aSA8IGdlb2lkRGF0YS5oZWlnaHQgPyB5aSArIDEgOiB5aTsKICAgIHlpID0gZ2VvaWREYXRhLmhlaWdodCAtIDEgLSB5aTsKICAgIHlOZXh0ID0gZ2VvaWREYXRhLmhlaWdodCAtIDEgLSB5TmV4dDsKICAgIGNvbnN0IGgwMCA9IHNhbXBsZU1hcCh4aSwgeWksIGdlb2lkRGF0YS53aWR0aCwgZ2VvaWREYXRhLmJ1ZmZlcik7CiAgICBjb25zdCBoMTAgPSBzYW1wbGVNYXAoeE5leHQsIHlpLCBnZW9pZERhdGEud2lkdGgsIGdlb2lkRGF0YS5idWZmZXIpOwogICAgY29uc3QgaDAxID0gc2FtcGxlTWFwKHhpLCB5TmV4dCwgZ2VvaWREYXRhLndpZHRoLCBnZW9pZERhdGEuYnVmZmVyKTsKICAgIGNvbnN0IGgxMSA9IHNhbXBsZU1hcCh4TmV4dCwgeU5leHQsIGdlb2lkRGF0YS53aWR0aCwgZ2VvaWREYXRhLmJ1ZmZlcik7CiAgICBsZXQgZmluYWxIZWlnaHQgPSBiaWxpbmVhckludGVycG9sYXRlKHgsIHksIGgwMCwgaDEwLCBoMDEsIGgxMSk7CiAgICBmaW5hbEhlaWdodCA9IGZpbmFsSGVpZ2h0ICogZ2VvaWREYXRhLnNjYWxlICsgZ2VvaWREYXRhLm9mZnNldDsKICAgIHJldHVybiBmaW5hbEhlaWdodDsKICB9CiAgZnVuY3Rpb24gc2FtcGxlR2VvaWRGcm9tTGlzdChsb24sIGxhdCwgZ2VvaWREYXRhTGlzdCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBnZW9pZERhdGFMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGxvY2FsRXh0ZW50ID0gZ2VvaWREYXRhTGlzdFtpXS5uYXRpdmVFeHRlbnQ7CiAgICAgIGxldCBsb2NhbFB0ID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBpZiAoZ2VvaWREYXRhTGlzdFtpXS5wcm9qZWN0aW9uVHlwZSA9PT0gIldlYk1lcmNhdG9yIikgewogICAgICAgIGNvbnN0IHJhZGlpID0gZ2VvaWREYXRhTGlzdFtpXS5wcm9qZWN0aW9uLl9lbGxpcHNvaWQuX3JhZGlpOwogICAgICAgIGNvbnN0IHdlYk1lcmNhdG9yUHJvaiA9IG5ldyBXZWJNZXJjYXRvclByb2plY3Rpb25fZGVmYXVsdCgKICAgICAgICAgIG5ldyBFbGxpcHNvaWRfZGVmYXVsdChyYWRpaS54LCByYWRpaS55LCByYWRpaS56KQogICAgICAgICk7CiAgICAgICAgbG9jYWxQdCA9IHdlYk1lcmNhdG9yUHJvai5wcm9qZWN0KG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdChsb24sIGxhdCwgMCkpOwogICAgICB9IGVsc2UgewogICAgICAgIGxvY2FsUHQueCA9IGxvbjsKICAgICAgICBsb2NhbFB0LnkgPSBsYXQ7CiAgICAgIH0KICAgICAgaWYgKGxvY2FsUHQueCA+IGxvY2FsRXh0ZW50Lndlc3QgJiYgbG9jYWxQdC54IDwgbG9jYWxFeHRlbnQuZWFzdCAmJiBsb2NhbFB0LnkgPiBsb2NhbEV4dGVudC5zb3V0aCAmJiBsb2NhbFB0LnkgPCBsb2NhbEV4dGVudC5ub3J0aCkgewogICAgICAgIHJldHVybiBzYW1wbGVHZW9pZChsb2NhbFB0LngsIGxvY2FsUHQueSwgZ2VvaWREYXRhTGlzdFtpXSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAwOwogIH0KICBmdW5jdGlvbiBvcnRob21ldHJpY1RvRWxsaXBzb2lkYWwodmVydGV4Q291bnQsIHBvc2l0aW9uLCBzY2FsZV94LCBzY2FsZV95LCBjZW50ZXIsIGdlb2lkRGF0YUxpc3QsIGZhc3QpIHsKICAgIGlmIChmYXN0KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGNlbnRlckhlaWdodCA9IHNhbXBsZUdlb2lkRnJvbUxpc3QoCiAgICAgIGNlbnRlci5sb25naXR1ZGUsCiAgICAgIGNlbnRlci5sYXRpdHVkZSwKICAgICAgZ2VvaWREYXRhTGlzdAogICAgKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydGV4Q291bnQ7ICsraSkgewogICAgICBjb25zdCBoZWlnaHQgPSBzYW1wbGVHZW9pZEZyb21MaXN0KAogICAgICAgIGNlbnRlci5sb25naXR1ZGUgKyBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKHNjYWxlX3ggKiBwb3NpdGlvbltpICogM10pLAogICAgICAgIGNlbnRlci5sYXRpdHVkZSArIE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoc2NhbGVfeSAqIHBvc2l0aW9uW2kgKiAzICsgMV0pLAogICAgICAgIGdlb2lkRGF0YUxpc3QKICAgICAgKTsKICAgICAgcG9zaXRpb25baSAqIDMgKyAyXSArPSBoZWlnaHQgLSBjZW50ZXJIZWlnaHQ7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyYW5zZm9ybVRvTG9jYWwodmVydGV4Q291bnQsIHBvc2l0aW9ucywgbm9ybWFscywgY2FydG9ncmFwaGljQ2VudGVyLCBjYXJ0ZXNpYW5DZW50ZXIsIHBhcmVudFJvdGF0aW9uLCBlbGxpcHNvaWRSYWRpaVNxdWFyZSwgc2NhbGVfeCwgc2NhbGVfeSkgewogICAgaWYgKHZlcnRleENvdW50ID09PSAwIHx8ICFkZWZpbmVkX2RlZmF1bHQocG9zaXRpb25zKSB8fCBwb3NpdGlvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGVsbGlwc29pZCA9IG5ldyBFbGxpcHNvaWRfZGVmYXVsdCgKICAgICAgTWF0aC5zcXJ0KGVsbGlwc29pZFJhZGlpU3F1YXJlLngpLAogICAgICBNYXRoLnNxcnQoZWxsaXBzb2lkUmFkaWlTcXVhcmUueSksCiAgICAgIE1hdGguc3FydChlbGxpcHNvaWRSYWRpaVNxdWFyZS56KQogICAgKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydGV4Q291bnQ7ICsraSkgewogICAgICBjb25zdCBpbmRleE9mZnNldCA9IGkgKiAzOwogICAgICBjb25zdCBpbmRleE9mZnNldDEgPSBpbmRleE9mZnNldCArIDE7CiAgICAgIGNvbnN0IGluZGV4T2Zmc2V0MiA9IGluZGV4T2Zmc2V0ICsgMjsKICAgICAgY29uc3QgY2FydG9ncmFwaGljMiA9IG5ldyBDYXJ0b2dyYXBoaWNfZGVmYXVsdCgpOwogICAgICBjYXJ0b2dyYXBoaWMyLmxvbmdpdHVkZSA9IGNhcnRvZ3JhcGhpY0NlbnRlci5sb25naXR1ZGUgKyBNYXRoX2RlZmF1bHQudG9SYWRpYW5zKHNjYWxlX3ggKiBwb3NpdGlvbnNbaW5kZXhPZmZzZXRdKTsKICAgICAgY2FydG9ncmFwaGljMi5sYXRpdHVkZSA9IGNhcnRvZ3JhcGhpY0NlbnRlci5sYXRpdHVkZSArIE1hdGhfZGVmYXVsdC50b1JhZGlhbnMoc2NhbGVfeSAqIHBvc2l0aW9uc1tpbmRleE9mZnNldDFdKTsKICAgICAgY2FydG9ncmFwaGljMi5oZWlnaHQgPSBjYXJ0b2dyYXBoaWNDZW50ZXIuaGVpZ2h0ICsgcG9zaXRpb25zW2luZGV4T2Zmc2V0Ml07CiAgICAgIGNvbnN0IHBvc2l0aW9uID0ge307CiAgICAgIGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjYXJ0b2dyYXBoaWMyLCBwb3NpdGlvbik7CiAgICAgIHBvc2l0aW9uLnggLT0gY2FydGVzaWFuQ2VudGVyLng7CiAgICAgIHBvc2l0aW9uLnkgLT0gY2FydGVzaWFuQ2VudGVyLnk7CiAgICAgIHBvc2l0aW9uLnogLT0gY2FydGVzaWFuQ2VudGVyLno7CiAgICAgIGNvbnN0IHJvdGF0ZWRQb3NpdGlvbiA9IHt9OwogICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcihwYXJlbnRSb3RhdGlvbiwgcG9zaXRpb24sIHJvdGF0ZWRQb3NpdGlvbik7CiAgICAgIHBvc2l0aW9uc1tpbmRleE9mZnNldF0gPSByb3RhdGVkUG9zaXRpb24ueDsKICAgICAgcG9zaXRpb25zW2luZGV4T2Zmc2V0MV0gPSByb3RhdGVkUG9zaXRpb24ueTsKICAgICAgcG9zaXRpb25zW2luZGV4T2Zmc2V0Ml0gPSByb3RhdGVkUG9zaXRpb24uejsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChub3JtYWxzKSkgewogICAgICAgIGNvbnN0IG5vcm1hbDIgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KAogICAgICAgICAgbm9ybWFsc1tpbmRleE9mZnNldF0sCiAgICAgICAgICBub3JtYWxzW2luZGV4T2Zmc2V0MV0sCiAgICAgICAgICBub3JtYWxzW2luZGV4T2Zmc2V0Ml0KICAgICAgICApOwogICAgICAgIGNvbnN0IHJvdGF0ZWROb3JtYWwgPSB7fTsKICAgICAgICBNYXRyaXgzX2RlZmF1bHQubXVsdGlwbHlCeVZlY3RvcihwYXJlbnRSb3RhdGlvbiwgbm9ybWFsMiwgcm90YXRlZE5vcm1hbCk7CiAgICAgICAgbm9ybWFsc1tpbmRleE9mZnNldF0gPSByb3RhdGVkTm9ybWFsLng7CiAgICAgICAgbm9ybWFsc1tpbmRleE9mZnNldDFdID0gcm90YXRlZE5vcm1hbC55OwogICAgICAgIG5vcm1hbHNbaW5kZXhPZmZzZXQyXSA9IHJvdGF0ZWROb3JtYWwuejsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBjcm9wVVZzKHZlcnRleENvdW50LCB1djBzLCB1dlJlZ2lvbnMpIHsKICAgIGZvciAobGV0IHZlcnRleEluZGV4ID0gMDsgdmVydGV4SW5kZXggPCB2ZXJ0ZXhDb3VudDsgKyt2ZXJ0ZXhJbmRleCkgewogICAgICBjb25zdCBtaW5VID0gdXZSZWdpb25zW3ZlcnRleEluZGV4ICogNF0gLyA2NTUzNTsKICAgICAgY29uc3QgbWluViA9IHV2UmVnaW9uc1t2ZXJ0ZXhJbmRleCAqIDQgKyAxXSAvIDY1NTM1OwogICAgICBjb25zdCBzY2FsZVUgPSAodXZSZWdpb25zW3ZlcnRleEluZGV4ICogNCArIDJdIC0gdXZSZWdpb25zW3ZlcnRleEluZGV4ICogNF0pIC8gNjU1MzU7CiAgICAgIGNvbnN0IHNjYWxlViA9ICh1dlJlZ2lvbnNbdmVydGV4SW5kZXggKiA0ICsgM10gLSB1dlJlZ2lvbnNbdmVydGV4SW5kZXggKiA0ICsgMV0pIC8gNjU1MzU7CiAgICAgIHV2MHNbdmVydGV4SW5kZXggKiAyXSAqPSBzY2FsZVU7CiAgICAgIHV2MHNbdmVydGV4SW5kZXggKiAyXSArPSBtaW5VOwogICAgICB1djBzW3ZlcnRleEluZGV4ICogMiArIDFdICo9IHNjYWxlVjsKICAgICAgdXYwc1t2ZXJ0ZXhJbmRleCAqIDIgKyAxXSArPSBtaW5WOwogICAgfQogIH0KICBmdW5jdGlvbiBnZW5lcmF0ZUluZGV4QXJyYXkodmVydGV4Q291bnQsIGluZGljZXMsIGNvbG9ycywgc3BsaXRHZW9tZXRyeUJ5Q29sb3JUcmFuc3BhcmVuY3kpIHsKICAgIGNvbnN0IGluZGV4QXJyYXkgPSBuZXcgVWludDMyQXJyYXkodmVydGV4Q291bnQpOwogICAgY29uc3QgdmVydGV4SW5kZXhGbiA9IGRlZmluZWRfZGVmYXVsdChpbmRpY2VzKSA/ICh2ZXJ0ZXhJbmRleCkgPT4gaW5kaWNlc1t2ZXJ0ZXhJbmRleF0gOiAodmVydGV4SW5kZXgpID0+IHZlcnRleEluZGV4OwogICAgbGV0IHRyYW5zcGFyZW50VmVydGV4T2Zmc2V0ID0gMDsKICAgIGlmIChzcGxpdEdlb21ldHJ5QnlDb2xvclRyYW5zcGFyZW5jeSAmJiBkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSkgewogICAgICBjb25zdCBpc1ZlcnRleFRyYW5zcGFyZW50Rm4gPSAodmVydGV4SW5kZXgpID0+IGNvbG9yc1t2ZXJ0ZXhJbmRleEZuKHZlcnRleEluZGV4KSAqIDQgKyAzXSA8IDI1NTsKICAgICAgZm9yIChsZXQgdmVydGV4SW5kZXggPSAwOyB2ZXJ0ZXhJbmRleCA8IHZlcnRleENvdW50OyB2ZXJ0ZXhJbmRleCArPSAzKSB7CiAgICAgICAgaWYgKCFpc1ZlcnRleFRyYW5zcGFyZW50Rm4odmVydGV4SW5kZXgpICYmICFpc1ZlcnRleFRyYW5zcGFyZW50Rm4odmVydGV4SW5kZXggKyAxKSAmJiAhaXNWZXJ0ZXhUcmFuc3BhcmVudEZuKHZlcnRleEluZGV4ICsgMikpIHsKICAgICAgICAgIGluZGV4QXJyYXlbdHJhbnNwYXJlbnRWZXJ0ZXhPZmZzZXQrK10gPSB2ZXJ0ZXhJbmRleEZuKHZlcnRleEluZGV4KTsKICAgICAgICAgIGluZGV4QXJyYXlbdHJhbnNwYXJlbnRWZXJ0ZXhPZmZzZXQrK10gPSB2ZXJ0ZXhJbmRleEZuKHZlcnRleEluZGV4ICsgMSk7CiAgICAgICAgICBpbmRleEFycmF5W3RyYW5zcGFyZW50VmVydGV4T2Zmc2V0KytdID0gdmVydGV4SW5kZXhGbih2ZXJ0ZXhJbmRleCArIDIpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAodHJhbnNwYXJlbnRWZXJ0ZXhPZmZzZXQgPiAwKSB7CiAgICAgICAgbGV0IG9mZnNldCA9IHRyYW5zcGFyZW50VmVydGV4T2Zmc2V0OwogICAgICAgIGZvciAobGV0IHZlcnRleEluZGV4ID0gMDsgdmVydGV4SW5kZXggPCB2ZXJ0ZXhDb3VudDsgdmVydGV4SW5kZXggKz0gMykgewogICAgICAgICAgaWYgKGlzVmVydGV4VHJhbnNwYXJlbnRGbih2ZXJ0ZXhJbmRleCkgfHwgaXNWZXJ0ZXhUcmFuc3BhcmVudEZuKHZlcnRleEluZGV4ICsgMSkgfHwgaXNWZXJ0ZXhUcmFuc3BhcmVudEZuKHZlcnRleEluZGV4ICsgMikpIHsKICAgICAgICAgICAgaW5kZXhBcnJheVtvZmZzZXQrK10gPSB2ZXJ0ZXhJbmRleEZuKHZlcnRleEluZGV4KTsKICAgICAgICAgICAgaW5kZXhBcnJheVtvZmZzZXQrK10gPSB2ZXJ0ZXhJbmRleEZuKHZlcnRleEluZGV4ICsgMSk7CiAgICAgICAgICAgIGluZGV4QXJyYXlbb2Zmc2V0KytdID0gdmVydGV4SW5kZXhGbih2ZXJ0ZXhJbmRleCArIDIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKGxldCB2ZXJ0ZXhJbmRleCA9IDA7IHZlcnRleEluZGV4IDwgdmVydGV4Q291bnQ7ICsrdmVydGV4SW5kZXgpIHsKICAgICAgICAgIGluZGV4QXJyYXlbdmVydGV4SW5kZXhdID0gdmVydGV4SW5kZXhGbih2ZXJ0ZXhJbmRleCk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0cmFuc3BhcmVudFZlcnRleE9mZnNldCA9IHZlcnRleENvdW50OwogICAgICBmb3IgKGxldCB2ZXJ0ZXhJbmRleCA9IDA7IHZlcnRleEluZGV4IDwgdmVydGV4Q291bnQ7ICsrdmVydGV4SW5kZXgpIHsKICAgICAgICBpbmRleEFycmF5W3ZlcnRleEluZGV4XSA9IHZlcnRleEluZGV4Rm4odmVydGV4SW5kZXgpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICBpbmRleEFycmF5LAogICAgICB0cmFuc3BhcmVudFZlcnRleE9mZnNldAogICAgfTsKICB9CiAgZnVuY3Rpb24gZ2V0RmVhdHVyZUhhc2goc3ltYm9sb2d5RGF0YSwgb3V0bGluZXNIYXNoLCBmZWF0dXJlSW5kZXgpIHsKICAgIGNvbnN0IGZlYXR1cmVIYXNoID0gb3V0bGluZXNIYXNoW2ZlYXR1cmVJbmRleF07CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVIYXNoKSkgewogICAgICByZXR1cm4gZmVhdHVyZUhhc2g7CiAgICB9CiAgICBjb25zdCBuZXdGZWF0dXJlSGFzaCA9IG91dGxpbmVzSGFzaFtmZWF0dXJlSW5kZXhdID0gewogICAgICBwb3NpdGlvbnM6IHt9LAogICAgICBpbmRpY2VzOiB7fSwKICAgICAgZWRnZXM6IHt9CiAgICB9OwogICAgY29uc3QgZmVhdHVyZVN5bWJvbG9neSA9IGRlZmF1bHRWYWx1ZV9kZWZhdWx0KAogICAgICBzeW1ib2xvZ3lEYXRhW2ZlYXR1cmVJbmRleF0sCiAgICAgIHN5bWJvbG9neURhdGEuZGVmYXVsdAogICAgKTsKICAgIG5ld0ZlYXR1cmVIYXNoLmhhc091dGxpbmUgPSBkZWZpbmVkX2RlZmF1bHQoZmVhdHVyZVN5bWJvbG9neT8uZWRnZXMpOwogICAgcmV0dXJuIG5ld0ZlYXR1cmVIYXNoOwogIH0KICBmdW5jdGlvbiBhZGRWZXJ0ZXhUb0hhc2goaW5kZXhIYXNoLCBwb3NpdGlvbkhhc2gsIHZlcnRleEluZGV4LCBwb3NpdGlvbnMpIHsKICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGluZGV4SGFzaFt2ZXJ0ZXhJbmRleF0pKSB7CiAgICAgIGNvbnN0IHN0YXJ0UG9zaXRpb25JbmRleCA9IHZlcnRleEluZGV4ICogMzsKICAgICAgbGV0IGNvb3JkaW5hdGVIYXNoID0gcG9zaXRpb25IYXNoOwogICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgMzsgaW5kZXgrKykgewogICAgICAgIGNvbnN0IGNvb3JkaW5hdGUgPSBwb3NpdGlvbnNbc3RhcnRQb3NpdGlvbkluZGV4ICsgaW5kZXhdOwogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KGNvb3JkaW5hdGVIYXNoW2Nvb3JkaW5hdGVdKSkgewogICAgICAgICAgY29vcmRpbmF0ZUhhc2hbY29vcmRpbmF0ZV0gPSB7fTsKICAgICAgICB9CiAgICAgICAgY29vcmRpbmF0ZUhhc2ggPSBjb29yZGluYXRlSGFzaFtjb29yZGluYXRlXTsKICAgICAgfQogICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChjb29yZGluYXRlSGFzaC5pbmRleCkpIHsKICAgICAgICBjb29yZGluYXRlSGFzaC5pbmRleCA9IHZlcnRleEluZGV4OwogICAgICB9CiAgICAgIGluZGV4SGFzaFt2ZXJ0ZXhJbmRleF0gPSBjb29yZGluYXRlSGFzaC5pbmRleDsKICAgIH0KICB9CiAgZnVuY3Rpb24gYWRkRWRnZVRvSGFzaChlZGdlSGFzaCwgdmVydGV4QUluZGV4LCB2ZXJ0ZXhCSW5kZXgsIHZlcnRleEFJbmRleFVuaXF1ZSwgdmVydGV4QkluZGV4VW5pcXVlLCBub3JtYWxJbmRleCkgewogICAgbGV0IHN0YXJ0VmVydGV4SW5kZXg7CiAgICBsZXQgZW5kVmVydGV4SW5kZXg7CiAgICBpZiAodmVydGV4QUluZGV4VW5pcXVlIDwgdmVydGV4QkluZGV4VW5pcXVlKSB7CiAgICAgIHN0YXJ0VmVydGV4SW5kZXggPSB2ZXJ0ZXhBSW5kZXhVbmlxdWU7CiAgICAgIGVuZFZlcnRleEluZGV4ID0gdmVydGV4QkluZGV4VW5pcXVlOwogICAgfSBlbHNlIHsKICAgICAgc3RhcnRWZXJ0ZXhJbmRleCA9IHZlcnRleEJJbmRleFVuaXF1ZTsKICAgICAgZW5kVmVydGV4SW5kZXggPSB2ZXJ0ZXhBSW5kZXhVbmlxdWU7CiAgICB9CiAgICBsZXQgZWRnZVN0YXJ0ID0gZWRnZUhhc2hbc3RhcnRWZXJ0ZXhJbmRleF07CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlZGdlU3RhcnQpKSB7CiAgICAgIGVkZ2VTdGFydCA9IGVkZ2VIYXNoW3N0YXJ0VmVydGV4SW5kZXhdID0ge307CiAgICB9CiAgICBsZXQgZWRnZUVuZCA9IGVkZ2VTdGFydFtlbmRWZXJ0ZXhJbmRleF07CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChlZGdlRW5kKSkgewogICAgICBlZGdlRW5kID0gZWRnZVN0YXJ0W2VuZFZlcnRleEluZGV4XSA9IHsKICAgICAgICBub3JtYWxzSW5kZXg6IFtdLAogICAgICAgIG91dGxpbmVzOiBbXQogICAgICB9OwogICAgfQogICAgZWRnZUVuZC5ub3JtYWxzSW5kZXgucHVzaChub3JtYWxJbmRleCk7CiAgICBpZiAoZWRnZUVuZC5vdXRsaW5lcy5sZW5ndGggPT09IDAgfHwgdmVydGV4QUluZGV4ICE9PSB2ZXJ0ZXhBSW5kZXhVbmlxdWUgfHwgdmVydGV4QkluZGV4ICE9PSB2ZXJ0ZXhCSW5kZXhVbmlxdWUpIHsKICAgICAgZWRnZUVuZC5vdXRsaW5lcy5wdXNoKHZlcnRleEFJbmRleCwgdmVydGV4QkluZGV4KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuZXJhdGVPdXRsaW5lc0hhc2goc3ltYm9sb2d5RGF0YSwgZmVhdHVyZUluZGV4QXJyYXksIGluZGV4QXJyYXksIHBvc2l0aW9ucykgewogICAgY29uc3Qgb3V0bGluZXNIYXNoID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZGV4QXJyYXkubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgY29uc3QgZmVhdHVyZUluZGV4ID0gZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVJbmRleEFycmF5KSA/IGZlYXR1cmVJbmRleEFycmF5W2luZGV4QXJyYXlbaV1dIDogImRlZmF1bHQiOwogICAgICBjb25zdCBmZWF0dXJlSGFzaCA9IGdldEZlYXR1cmVIYXNoKAogICAgICAgIHN5bWJvbG9neURhdGEsCiAgICAgICAgb3V0bGluZXNIYXNoLAogICAgICAgIGZlYXR1cmVJbmRleAogICAgICApOwogICAgICBpZiAoIWZlYXR1cmVIYXNoLmhhc091dGxpbmUpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCBpbmRleEhhc2ggPSBmZWF0dXJlSGFzaC5pbmRpY2VzOwogICAgICBjb25zdCBwb3NpdGlvbkhhc2ggPSBmZWF0dXJlSGFzaC5wb3NpdGlvbnM7CiAgICAgIGZvciAobGV0IHZlcnRleCA9IDA7IHZlcnRleCA8IDM7IHZlcnRleCsrKSB7CiAgICAgICAgY29uc3QgdmVydGV4SW5kZXggPSBpbmRleEFycmF5W2kgKyB2ZXJ0ZXhdOwogICAgICAgIGFkZFZlcnRleFRvSGFzaChpbmRleEhhc2gsIHBvc2l0aW9uSGFzaCwgdmVydGV4SW5kZXgsIHBvc2l0aW9ucyk7CiAgICAgIH0KICAgICAgY29uc3QgZWRnZUhhc2ggPSBmZWF0dXJlSGFzaC5lZGdlczsKICAgICAgZm9yIChsZXQgdmVydGV4ID0gMDsgdmVydGV4IDwgMzsgdmVydGV4KyspIHsKICAgICAgICBjb25zdCB2ZXJ0ZXhJbmRleCA9IGluZGV4QXJyYXlbaSArIHZlcnRleF07CiAgICAgICAgY29uc3QgbmV4dFZlcnRleEluZGV4ID0gaW5kZXhBcnJheVtpICsgKHZlcnRleCArIDEpICUgM107CiAgICAgICAgY29uc3QgdW5pcXVlVmVydGV4SW5kZXggPSBpbmRleEhhc2hbdmVydGV4SW5kZXhdOwogICAgICAgIGNvbnN0IHVuaXF1ZU5leHRWZXJ0ZXhJbmRleCA9IGluZGV4SGFzaFtuZXh0VmVydGV4SW5kZXhdOwogICAgICAgIGFkZEVkZ2VUb0hhc2goCiAgICAgICAgICBlZGdlSGFzaCwKICAgICAgICAgIHZlcnRleEluZGV4LAogICAgICAgICAgbmV4dFZlcnRleEluZGV4LAogICAgICAgICAgdW5pcXVlVmVydGV4SW5kZXgsCiAgICAgICAgICB1bmlxdWVOZXh0VmVydGV4SW5kZXgsCiAgICAgICAgICBpCiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG91dGxpbmVzSGFzaDsKICB9CiAgZnVuY3Rpb24gY2FsY3VsYXRlRmFjZU5vcm1hbChub3JtYWxzLCB2ZXJ0ZXhBSW5kZXgsIGluZGV4QXJyYXksIHBvc2l0aW9ucykgewogICAgY29uc3QgcG9zaXRpb25BSW5kZXggPSBpbmRleEFycmF5W3ZlcnRleEFJbmRleF0gKiAzOwogICAgY29uc3QgcG9zaXRpb25CSW5kZXggPSBpbmRleEFycmF5W3ZlcnRleEFJbmRleCArIDFdICogMzsKICAgIGNvbnN0IHBvc2l0aW9uQ0luZGV4ID0gaW5kZXhBcnJheVt2ZXJ0ZXhBSW5kZXggKyAyXSAqIDM7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuZnJvbUFycmF5KHBvc2l0aW9ucywgcG9zaXRpb25BSW5kZXgsIGNhbGN1bGF0ZUZhY2VOb3JtYWxBKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkocG9zaXRpb25zLCBwb3NpdGlvbkJJbmRleCwgY2FsY3VsYXRlRmFjZU5vcm1hbEIpOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LmZyb21BcnJheShwb3NpdGlvbnMsIHBvc2l0aW9uQ0luZGV4LCBjYWxjdWxhdGVGYWNlTm9ybWFsQyk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWxCLAogICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQSwKICAgICAgY2FsY3VsYXRlRmFjZU5vcm1hbEIKICAgICk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuc3VidHJhY3QoCiAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWxDLAogICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQSwKICAgICAgY2FsY3VsYXRlRmFjZU5vcm1hbEMKICAgICk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQuY3Jvc3MoCiAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWxCLAogICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQywKICAgICAgY2FsY3VsYXRlRmFjZU5vcm1hbEEKICAgICk7CiAgICBjb25zdCBtYWduaXR1ZGUgPSBDYXJ0ZXNpYW4zX2RlZmF1bHQubWFnbml0dWRlKGNhbGN1bGF0ZUZhY2VOb3JtYWxBKTsKICAgIGlmIChtYWduaXR1ZGUgIT09IDApIHsKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmRpdmlkZUJ5U2NhbGFyKAogICAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWxBLAogICAgICAgIG1hZ25pdHVkZSwKICAgICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQQogICAgICApOwogICAgfQogICAgY29uc3Qgbm9ybWFsQUluZGV4ID0gdmVydGV4QUluZGV4ICogMzsKICAgIGNvbnN0IG5vcm1hbEJJbmRleCA9ICh2ZXJ0ZXhBSW5kZXggKyAxKSAqIDM7CiAgICBjb25zdCBub3JtYWxDSW5kZXggPSAodmVydGV4QUluZGV4ICsgMikgKiAzOwogICAgQ2FydGVzaWFuM19kZWZhdWx0LnBhY2soY2FsY3VsYXRlRmFjZU5vcm1hbEEsIG5vcm1hbHMsIG5vcm1hbEFJbmRleCk7CiAgICBDYXJ0ZXNpYW4zX2RlZmF1bHQucGFjayhjYWxjdWxhdGVGYWNlTm9ybWFsQSwgbm9ybWFscywgbm9ybWFsQkluZGV4KTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5wYWNrKGNhbGN1bGF0ZUZhY2VOb3JtYWxBLCBub3JtYWxzLCBub3JtYWxDSW5kZXgpOwogIH0KICBmdW5jdGlvbiBpc0VkZ2VTbW9vdGgobm9ybWFscywgbm9ybWFsQUluZGV4LCBub3JtYWxCSW5kZXgpIHsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobm9ybWFscywgbm9ybWFsQUluZGV4LCBpc0VkZ2VTbW9vdGhBKTsKICAgIENhcnRlc2lhbjNfZGVmYXVsdC5mcm9tQXJyYXkobm9ybWFscywgbm9ybWFsQkluZGV4LCBpc0VkZ2VTbW9vdGhCKTsKICAgIGNvbnN0IGNvc2luZSA9IENhcnRlc2lhbjNfZGVmYXVsdC5kb3QoaXNFZGdlU21vb3RoQSwgaXNFZGdlU21vb3RoQik7CiAgICBjb25zdCBzaW5lID0gQ2FydGVzaWFuM19kZWZhdWx0Lm1hZ25pdHVkZSgKICAgICAgQ2FydGVzaWFuM19kZWZhdWx0LmNyb3NzKGlzRWRnZVNtb290aEEsIGlzRWRnZVNtb290aEIsIGlzRWRnZVNtb290aEEpCiAgICApOwogICAgcmV0dXJuIE1hdGguYXRhbjIoc2luZSwgY29zaW5lKSA8IDAuMjU7CiAgfQogIGZ1bmN0aW9uIGFkZE91dGxpbmVzRm9yRWRnZShvdXRsaW5lcywgZWRnZURhdGEsIGluZGV4QXJyYXksIHBvc2l0aW9ucywgbm9ybWFscykgewogICAgaWYgKGVkZ2VEYXRhLm5vcm1hbHNJbmRleC5sZW5ndGggPiAxKSB7CiAgICAgIGNvbnN0IG5vcm1hbHNCeUluZGV4ID0gcG9zaXRpb25zLmxlbmd0aCA9PT0gbm9ybWFscy5sZW5ndGg7CiAgICAgIGZvciAobGV0IGluZGV4QSA9IDA7IGluZGV4QSA8IGVkZ2VEYXRhLm5vcm1hbHNJbmRleC5sZW5ndGg7IGluZGV4QSsrKSB7CiAgICAgICAgY29uc3QgdmVydGV4QUluZGV4ID0gZWRnZURhdGEubm9ybWFsc0luZGV4W2luZGV4QV07CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobm9ybWFsc1t2ZXJ0ZXhBSW5kZXggKiAzXSkpIHsKICAgICAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWwobm9ybWFscywgdmVydGV4QUluZGV4LCBpbmRleEFycmF5LCBwb3NpdGlvbnMpOwogICAgICAgIH0KICAgICAgICBpZiAoaW5kZXhBID09PSAwKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaW5kZXhCID0gMDsgaW5kZXhCIDwgaW5kZXhBOyBpbmRleEIrKykgewogICAgICAgICAgY29uc3QgdmVydGV4QkluZGV4ID0gZWRnZURhdGEubm9ybWFsc0luZGV4W2luZGV4Ql07CiAgICAgICAgICBjb25zdCBub3JtYWxBSW5kZXggPSBub3JtYWxzQnlJbmRleCA/IGluZGV4QXJyYXlbdmVydGV4QUluZGV4XSAqIDMgOiB2ZXJ0ZXhBSW5kZXggKiAzOwogICAgICAgICAgY29uc3Qgbm9ybWFsQkluZGV4ID0gbm9ybWFsc0J5SW5kZXggPyBpbmRleEFycmF5W3ZlcnRleEJJbmRleF0gKiAzIDogdmVydGV4QkluZGV4ICogMzsKICAgICAgICAgIGlmIChpc0VkZ2VTbW9vdGgobm9ybWFscywgbm9ybWFsQUluZGV4LCBub3JtYWxCSW5kZXgpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIG91dGxpbmVzLnB1c2goLi4uZWRnZURhdGEub3V0bGluZXMpOwogIH0KICBmdW5jdGlvbiBhZGRPdXRsaW5lc0ZvckZlYXR1cmUob3V0bGluZXMsIGVkZ2VIYXNoLCBpbmRleEFycmF5LCBwb3NpdGlvbnMsIG5vcm1hbHMpIHsKICAgIGNvbnN0IGVkZ2VTdGFydEtleXMgPSBPYmplY3Qua2V5cyhlZGdlSGFzaCk7CiAgICBmb3IgKGxldCBzdGFydEluZGV4ID0gMDsgc3RhcnRJbmRleCA8IGVkZ2VTdGFydEtleXMubGVuZ3RoOyBzdGFydEluZGV4KyspIHsKICAgICAgY29uc3QgZWRnZUVuZHMgPSBlZGdlSGFzaFtlZGdlU3RhcnRLZXlzW3N0YXJ0SW5kZXhdXTsKICAgICAgY29uc3QgZWRnZUVuZEtleXMgPSBPYmplY3Qua2V5cyhlZGdlRW5kcyk7CiAgICAgIGZvciAobGV0IGVuZEluZGV4ID0gMDsgZW5kSW5kZXggPCBlZGdlRW5kS2V5cy5sZW5ndGg7IGVuZEluZGV4KyspIHsKICAgICAgICBjb25zdCBlZGdlRGF0YSA9IGVkZ2VFbmRzW2VkZ2VFbmRLZXlzW2VuZEluZGV4XV07CiAgICAgICAgYWRkT3V0bGluZXNGb3JFZGdlKG91dGxpbmVzLCBlZGdlRGF0YSwgaW5kZXhBcnJheSwgcG9zaXRpb25zLCBub3JtYWxzKTsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBnZW5lcmF0ZU91dGxpbmVzRnJvbUhhc2gob3V0bGluZXNIYXNoLCBpbmRleEFycmF5LCBwb3NpdGlvbnMsIG5vcm1hbHMpIHsKICAgIGNvbnN0IG91dGxpbmVzID0gW107CiAgICBjb25zdCBmZWF0dXJlcyA9IE9iamVjdC5rZXlzKG91dGxpbmVzSGFzaCk7CiAgICBmb3IgKGxldCBmZWF0dXJlSW5kZXggPSAwOyBmZWF0dXJlSW5kZXggPCBmZWF0dXJlcy5sZW5ndGg7IGZlYXR1cmVJbmRleCsrKSB7CiAgICAgIGNvbnN0IGVkZ2VIYXNoID0gb3V0bGluZXNIYXNoW2ZlYXR1cmVzW2ZlYXR1cmVJbmRleF1dLmVkZ2VzOwogICAgICBhZGRPdXRsaW5lc0ZvckZlYXR1cmUob3V0bGluZXMsIGVkZ2VIYXNoLCBpbmRleEFycmF5LCBwb3NpdGlvbnMsIG5vcm1hbHMpOwogICAgfQogICAgcmV0dXJuIG91dGxpbmVzOwogIH0KICBmdW5jdGlvbiBnZW5lcmF0ZU91dGxpbmVzSW5kZXhBcnJheShzeW1ib2xvZ3lEYXRhLCBmZWF0dXJlSW5kZXhBcnJheSwgaW5kZXhBcnJheSwgcG9zaXRpb25zLCBub3JtYWxzKSB7CiAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChzeW1ib2xvZ3lEYXRhKSB8fCBPYmplY3Qua2V5cyhzeW1ib2xvZ3lEYXRhKS5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIGNvbnN0IG91dGxpbmVzSGFzaCA9IGdlbmVyYXRlT3V0bGluZXNIYXNoKAogICAgICBzeW1ib2xvZ3lEYXRhLAogICAgICBmZWF0dXJlSW5kZXhBcnJheSwKICAgICAgaW5kZXhBcnJheSwKICAgICAgcG9zaXRpb25zCiAgICApOwogICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQobm9ybWFscykgfHwgaW5kZXhBcnJheS5sZW5ndGggKiAzICE9PSBub3JtYWxzLmxlbmd0aCkgewogICAgICBub3JtYWxzID0gW107CiAgICB9CiAgICBjb25zdCBvdXRsaW5lcyA9IGdlbmVyYXRlT3V0bGluZXNGcm9tSGFzaCgKICAgICAgb3V0bGluZXNIYXNoLAogICAgICBpbmRleEFycmF5LAogICAgICBwb3NpdGlvbnMsCiAgICAgIG5vcm1hbHMKICAgICk7CiAgICBjb25zdCBvdXRsaW5lc0luZGV4QXJyYXkgPSBvdXRsaW5lcy5sZW5ndGggPiAwID8gbmV3IFVpbnQzMkFycmF5KG91dGxpbmVzKSA6IHZvaWQgMDsKICAgIHJldHVybiBvdXRsaW5lc0luZGV4QXJyYXk7CiAgfQogIGZ1bmN0aW9uIGNvbnZlcnRDb2xvcnNBcnJheShjb2xvcnMpIHsKICAgIGNvbnN0IGNvbG9yc0FycmF5ID0gbmV3IEZsb2F0MzJBcnJheShjb2xvcnMubGVuZ3RoKTsKICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBjb2xvcnMubGVuZ3RoOyBpbmRleCArPSA0KSB7CiAgICAgIGNvbG9yc0FycmF5W2luZGV4XSA9IHNyZ2JUb0xpbmVhcl9kZWZhdWx0KENvbG9yX2RlZmF1bHQuYnl0ZVRvRmxvYXQoY29sb3JzW2luZGV4XSkpOwogICAgICBjb2xvcnNBcnJheVtpbmRleCArIDFdID0gc3JnYlRvTGluZWFyX2RlZmF1bHQoQ29sb3JfZGVmYXVsdC5ieXRlVG9GbG9hdChjb2xvcnNbaW5kZXggKyAxXSkpOwogICAgICBjb2xvcnNBcnJheVtpbmRleCArIDJdID0gc3JnYlRvTGluZWFyX2RlZmF1bHQoQ29sb3JfZGVmYXVsdC5ieXRlVG9GbG9hdChjb2xvcnNbaW5kZXggKyAyXSkpOwogICAgICBjb2xvcnNBcnJheVtpbmRleCArIDNdID0gQ29sb3JfZGVmYXVsdC5ieXRlVG9GbG9hdChjb2xvcnNbaW5kZXggKyAzXSk7CiAgICB9CiAgICByZXR1cm4gY29sb3JzQXJyYXk7CiAgfQogIGZ1bmN0aW9uIGdlbmVyYXRlTm9ybWFscyh2ZXJ0ZXhDb3VudCwgaW5kaWNlcywgcG9zaXRpb25zLCBub3JtYWxzLCB1djBzLCBjb2xvcnMsIGZlYXR1cmVJbmRleCkgewogICAgY29uc3QgcmVzdWx0ID0gewogICAgICBub3JtYWxzOiB2b2lkIDAsCiAgICAgIHBvc2l0aW9uczogdm9pZCAwLAogICAgICB1djBzOiB2b2lkIDAsCiAgICAgIGNvbG9yczogdm9pZCAwLAogICAgICBmZWF0dXJlSW5kZXg6IHZvaWQgMCwKICAgICAgdmVydGV4Q291bnQ6IHZvaWQgMAogICAgfTsKICAgIGlmICh2ZXJ0ZXhDb3VudCA9PT0gMCB8fCAhZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCB8fCBkZWZpbmVkX2RlZmF1bHQobm9ybWFscykpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoaW5kaWNlcykpIHsKICAgICAgcmVzdWx0LnZlcnRleENvdW50ID0gaW5kaWNlcy5sZW5ndGg7CiAgICAgIHJlc3VsdC5wb3NpdGlvbnMgPSBuZXcgRmxvYXQzMkFycmF5KGluZGljZXMubGVuZ3RoICogMyk7CiAgICAgIHJlc3VsdC51djBzID0gZGVmaW5lZF9kZWZhdWx0KHV2MHMpID8gbmV3IEZsb2F0MzJBcnJheShpbmRpY2VzLmxlbmd0aCAqIDIpIDogdm9pZCAwOwogICAgICByZXN1bHQuY29sb3JzID0gZGVmaW5lZF9kZWZhdWx0KGNvbG9ycykgPyBuZXcgVWludDhBcnJheShpbmRpY2VzLmxlbmd0aCAqIDQpIDogdm9pZCAwOwogICAgICByZXN1bHQuZmVhdHVyZUluZGV4ID0gZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVJbmRleCkgPyBuZXcgQXJyYXkoaW5kaWNlcy5sZW5ndGgpIDogdm9pZCAwOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZGljZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBpbmRleCA9IGluZGljZXNbaV07CiAgICAgICAgcmVzdWx0LnBvc2l0aW9uc1tpICogM10gPSBwb3NpdGlvbnNbaW5kZXggKiAzXTsKICAgICAgICByZXN1bHQucG9zaXRpb25zW2kgKiAzICsgMV0gPSBwb3NpdGlvbnNbaW5kZXggKiAzICsgMV07CiAgICAgICAgcmVzdWx0LnBvc2l0aW9uc1tpICogMyArIDJdID0gcG9zaXRpb25zW2luZGV4ICogMyArIDJdOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocmVzdWx0LnV2MHMpKSB7CiAgICAgICAgICByZXN1bHQudXYwc1tpICogMl0gPSB1djBzW2luZGV4ICogMl07CiAgICAgICAgICByZXN1bHQudXYwc1tpICogMiArIDFdID0gdXYwc1tpbmRleCAqIDIgKyAxXTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXN1bHQuY29sb3JzKSkgewogICAgICAgICAgcmVzdWx0LmNvbG9yc1tpICogNF0gPSBjb2xvcnNbaW5kZXggKiA0XTsKICAgICAgICAgIHJlc3VsdC5jb2xvcnNbaSAqIDQgKyAxXSA9IGNvbG9yc1tpbmRleCAqIDQgKyAxXTsKICAgICAgICAgIHJlc3VsdC5jb2xvcnNbaSAqIDQgKyAyXSA9IGNvbG9yc1tpbmRleCAqIDQgKyAyXTsKICAgICAgICAgIHJlc3VsdC5jb2xvcnNbaSAqIDQgKyAzXSA9IGNvbG9yc1tpbmRleCAqIDQgKyAzXTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChyZXN1bHQuZmVhdHVyZUluZGV4KSkgewogICAgICAgICAgcmVzdWx0LmZlYXR1cmVJbmRleFtpXSA9IGZlYXR1cmVJbmRleFtpbmRleF07CiAgICAgICAgfQogICAgICB9CiAgICAgIHZlcnRleENvdW50ID0gaW5kaWNlcy5sZW5ndGg7CiAgICAgIHBvc2l0aW9ucyA9IHJlc3VsdC5wb3NpdGlvbnM7CiAgICB9CiAgICBpbmRpY2VzID0gbmV3IEFycmF5KHZlcnRleENvdW50KTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydGV4Q291bnQ7IGkrKykgewogICAgICBpbmRpY2VzW2ldID0gaTsKICAgIH0KICAgIHJlc3VsdC5ub3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheShpbmRpY2VzLmxlbmd0aCAqIDMpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRpY2VzLmxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWwocmVzdWx0Lm5vcm1hbHMsIGksIGluZGljZXMsIHBvc2l0aW9ucyk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBnZW5lcmF0ZUdsdGZCdWZmZXIodmVydGV4Q291bnQsIGluZGljZXMsIHBvc2l0aW9ucywgbm9ybWFscywgdXYwcywgY29sb3JzLCBmZWF0dXJlSW5kZXgsIHBhcmFtZXRlcnMpIHsKICAgIGlmICh2ZXJ0ZXhDb3VudCA9PT0gMCB8fCAhZGVmaW5lZF9kZWZhdWx0KHBvc2l0aW9ucykgfHwgcG9zaXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gewogICAgICAgIGJ1ZmZlcnM6IFtdLAogICAgICAgIGJ1ZmZlclZpZXdzOiBbXSwKICAgICAgICBhY2Nlc3NvcnM6IFtdLAogICAgICAgIG1lc2hlczogW10sCiAgICAgICAgbm9kZXM6IFtdLAogICAgICAgIG5vZGVzSW5TY2VuZTogW10KICAgICAgfTsKICAgIH0KICAgIGNvbnN0IGJ1ZmZlcnMgPSBbXTsKICAgIGNvbnN0IGJ1ZmZlclZpZXdzID0gW107CiAgICBjb25zdCBhY2Nlc3NvcnMgPSBbXTsKICAgIGNvbnN0IG1lc2hlcyA9IFtdOwogICAgY29uc3Qgbm9kZXMgPSBbXTsKICAgIGNvbnN0IG5vZGVzSW5TY2VuZSA9IFtdOwogICAgY29uc3Qgcm9vdEV4dGVuc2lvbnMgPSB7fTsKICAgIGNvbnN0IGV4dGVuc2lvbnNVc2VkID0gW107CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGluZGljZXMpKSB7CiAgICAgIHZlcnRleENvdW50ID0gaW5kaWNlcy5sZW5ndGg7CiAgICB9CiAgICBjb25zdCB7IGluZGV4QXJyYXksIHRyYW5zcGFyZW50VmVydGV4T2Zmc2V0IH0gPSBnZW5lcmF0ZUluZGV4QXJyYXkoCiAgICAgIHZlcnRleENvdW50LAogICAgICBpbmRpY2VzLAogICAgICBjb2xvcnMsCiAgICAgIHBhcmFtZXRlcnMuc3BsaXRHZW9tZXRyeUJ5Q29sb3JUcmFuc3BhcmVuY3kKICAgICk7CiAgICBjb25zdCBpbmRpY2VzQmxvYiA9IG5ldyBCbG9iKFtpbmRleEFycmF5XSwgeyB0eXBlOiAiYXBwbGljYXRpb24vYmluYXJ5IiB9KTsKICAgIGNvbnN0IGluZGljZXNVUkwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGluZGljZXNCbG9iKTsKICAgIGNvbnN0IGVuZEluZGV4ID0gdmVydGV4Q291bnQ7CiAgICBjb25zdCBmZWF0dXJlSW5kZXhBcnJheSA9IHBhcmFtZXRlcnMuZW5hYmxlRmVhdHVyZXMgJiYgZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVJbmRleCkgPyBuZXcgRmxvYXQzMkFycmF5KGZlYXR1cmVJbmRleC5sZW5ndGgpIDogdm9pZCAwOwogICAgbGV0IGZlYXR1cmVDb3VudCA9IDA7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVJbmRleEFycmF5KSkgewogICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgZmVhdHVyZUluZGV4Lmxlbmd0aDsgKytpbmRleCkgewogICAgICAgIGZlYXR1cmVJbmRleEFycmF5W2luZGV4XSA9IGZlYXR1cmVJbmRleFtpbmRleF07CiAgICAgICAgY29uc3QgY291bnRCeUluZGV4ID0gZmVhdHVyZUluZGV4W2luZGV4XSArIDE7CiAgICAgICAgaWYgKGZlYXR1cmVDb3VudCA8IGNvdW50QnlJbmRleCkgewogICAgICAgICAgZmVhdHVyZUNvdW50ID0gY291bnRCeUluZGV4OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgbGV0IG91dGxpbmVzSW5kaWNlc1VSTDsKICAgIGNvbnN0IG91dGxpbmVzSW5kZXhBcnJheSA9IGdlbmVyYXRlT3V0bGluZXNJbmRleEFycmF5KAogICAgICBwYXJhbWV0ZXJzLnN5bWJvbG9neURhdGEsCiAgICAgIGZlYXR1cmVJbmRleCwKICAgICAgaW5kZXhBcnJheSwKICAgICAgcG9zaXRpb25zLAogICAgICBub3JtYWxzCiAgICApOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChvdXRsaW5lc0luZGV4QXJyYXkpKSB7CiAgICAgIGNvbnN0IG91dGxpbmVzSW5kaWNlc0Jsb2IgPSBuZXcgQmxvYihbb3V0bGluZXNJbmRleEFycmF5XSwgewogICAgICAgIHR5cGU6ICJhcHBsaWNhdGlvbi9iaW5hcnkiCiAgICAgIH0pOwogICAgICBvdXRsaW5lc0luZGljZXNVUkwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKG91dGxpbmVzSW5kaWNlc0Jsb2IpOwogICAgfQogICAgY29uc3QgbWVzaFBvc2l0aW9ucyA9IHBvc2l0aW9ucy5zdWJhcnJheSgwLCBlbmRJbmRleCAqIDMpOwogICAgY29uc3QgcG9zaXRpb25zQmxvYiA9IG5ldyBCbG9iKFttZXNoUG9zaXRpb25zXSwgewogICAgICB0eXBlOiAiYXBwbGljYXRpb24vYmluYXJ5IgogICAgfSk7CiAgICBjb25zdCBwb3NpdGlvbnNVUkwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHBvc2l0aW9uc0Jsb2IpOwogICAgbGV0IG1pblggPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWF4WCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIGxldCBtaW5ZID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgbGV0IG1heFkgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICBsZXQgbWluWiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGxldCBtYXhaID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtZXNoUG9zaXRpb25zLmxlbmd0aCAvIDM7IGkrKykgewogICAgICBtaW5YID0gTWF0aC5taW4obWluWCwgbWVzaFBvc2l0aW9uc1tpICogMyArIDBdKTsKICAgICAgbWF4WCA9IE1hdGgubWF4KG1heFgsIG1lc2hQb3NpdGlvbnNbaSAqIDMgKyAwXSk7CiAgICAgIG1pblkgPSBNYXRoLm1pbihtaW5ZLCBtZXNoUG9zaXRpb25zW2kgKiAzICsgMV0pOwogICAgICBtYXhZID0gTWF0aC5tYXgobWF4WSwgbWVzaFBvc2l0aW9uc1tpICogMyArIDFdKTsKICAgICAgbWluWiA9IE1hdGgubWluKG1pblosIG1lc2hQb3NpdGlvbnNbaSAqIDMgKyAyXSk7CiAgICAgIG1heFogPSBNYXRoLm1heChtYXhaLCBtZXNoUG9zaXRpb25zW2kgKiAzICsgMl0pOwogICAgfQogICAgY29uc3QgbWVzaE5vcm1hbHMgPSBub3JtYWxzID8gbm9ybWFscy5zdWJhcnJheSgwLCBlbmRJbmRleCAqIDMpIDogdm9pZCAwOwogICAgbGV0IG5vcm1hbHNVUkw7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1lc2hOb3JtYWxzKSkgewogICAgICBjb25zdCBub3JtYWxzQmxvYiA9IG5ldyBCbG9iKFttZXNoTm9ybWFsc10sIHsKICAgICAgICB0eXBlOiAiYXBwbGljYXRpb24vYmluYXJ5IgogICAgICB9KTsKICAgICAgbm9ybWFsc1VSTCA9IFVSTC5jcmVhdGVPYmplY3RVUkwobm9ybWFsc0Jsb2IpOwogICAgfQogICAgY29uc3QgbWVzaFV2MHMgPSB1djBzID8gdXYwcy5zdWJhcnJheSgwLCBlbmRJbmRleCAqIDIpIDogdm9pZCAwOwogICAgbGV0IHV2MFVSTDsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobWVzaFV2MHMpKSB7CiAgICAgIGNvbnN0IHV2MEJsb2IgPSBuZXcgQmxvYihbbWVzaFV2MHNdLCB7IHR5cGU6ICJhcHBsaWNhdGlvbi9iaW5hcnkiIH0pOwogICAgICB1djBVUkwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHV2MEJsb2IpOwogICAgfQogICAgY29uc3QgbWVzaENvbG9yc0luQnl0ZXMgPSBkZWZpbmVkX2RlZmF1bHQoY29sb3JzKSA/IGNvbnZlcnRDb2xvcnNBcnJheShjb2xvcnMuc3ViYXJyYXkoMCwgZW5kSW5kZXggKiA0KSkgOiB2b2lkIDA7CiAgICBsZXQgY29sb3JzVVJMOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtZXNoQ29sb3JzSW5CeXRlcykpIHsKICAgICAgY29uc3QgY29sb3JzQmxvYiA9IG5ldyBCbG9iKFttZXNoQ29sb3JzSW5CeXRlc10sIHsKICAgICAgICB0eXBlOiAiYXBwbGljYXRpb24vYmluYXJ5IgogICAgICB9KTsKICAgICAgY29sb3JzVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTChjb2xvcnNCbG9iKTsKICAgIH0KICAgIGNvbnN0IG1lc2hGZWF0dXJlSWQwID0gZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVJbmRleEFycmF5KSA/IGZlYXR1cmVJbmRleEFycmF5LnN1YmFycmF5KDAsIGVuZEluZGV4KSA6IHZvaWQgMDsKICAgIGxldCBmZWF0dXJlSWQwVVJMOwogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtZXNoRmVhdHVyZUlkMCkpIHsKICAgICAgY29uc3QgZmVhdHVyZUlkMEJsb2IgPSBuZXcgQmxvYihbbWVzaEZlYXR1cmVJZDBdLCB7CiAgICAgICAgdHlwZTogImFwcGxpY2F0aW9uL2JpbmFyeSIKICAgICAgfSk7CiAgICAgIGZlYXR1cmVJZDBVUkwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGZlYXR1cmVJZDBCbG9iKTsKICAgIH0KICAgIGNvbnN0IG1lc2hQcm9wZXJ0eVRhYmxlMCA9IGRlZmluZWRfZGVmYXVsdChmZWF0dXJlSW5kZXhBcnJheSkgPyBuZXcgRmxvYXQzMkFycmF5KGZlYXR1cmVDb3VudCkgOiB2b2lkIDA7CiAgICBsZXQgcHJvcGVydHlUYWJsZTBVUkw7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG1lc2hQcm9wZXJ0eVRhYmxlMCkpIHsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IG1lc2hQcm9wZXJ0eVRhYmxlMC5sZW5ndGg7ICsraW5kZXgpIHsKICAgICAgICBtZXNoUHJvcGVydHlUYWJsZTBbaW5kZXhdID0gaW5kZXg7CiAgICAgIH0KICAgICAgY29uc3QgcHJvcGVydHlUYWJsZTBCbG9iID0gbmV3IEJsb2IoW21lc2hQcm9wZXJ0eVRhYmxlMF0sIHsKICAgICAgICB0eXBlOiAiYXBwbGljYXRpb24vYmluYXJ5IgogICAgICB9KTsKICAgICAgcHJvcGVydHlUYWJsZTBVUkwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHByb3BlcnR5VGFibGUwQmxvYik7CiAgICB9CiAgICBjb25zdCBhdHRyaWJ1dGVzID0ge307CiAgICBjb25zdCBleHRlbnNpb25zID0ge307CiAgICBhdHRyaWJ1dGVzLlBPU0lUSU9OID0gYWNjZXNzb3JzLmxlbmd0aDsKICAgIGJ1ZmZlcnMucHVzaCh7CiAgICAgIHVyaTogcG9zaXRpb25zVVJMLAogICAgICBieXRlTGVuZ3RoOiBtZXNoUG9zaXRpb25zLmJ5dGVMZW5ndGgKICAgIH0pOwogICAgYnVmZmVyVmlld3MucHVzaCh7CiAgICAgIGJ1ZmZlcjogYnVmZmVycy5sZW5ndGggLSAxLAogICAgICBieXRlT2Zmc2V0OiAwLAogICAgICBieXRlTGVuZ3RoOiBtZXNoUG9zaXRpb25zLmJ5dGVMZW5ndGgsCiAgICAgIHRhcmdldDogMzQ5NjIKICAgIH0pOwogICAgYWNjZXNzb3JzLnB1c2goewogICAgICBidWZmZXJWaWV3OiBidWZmZXJWaWV3cy5sZW5ndGggLSAxLAogICAgICBieXRlT2Zmc2V0OiAwLAogICAgICBjb21wb25lbnRUeXBlOiA1MTI2LAogICAgICBjb3VudDogbWVzaFBvc2l0aW9ucy5sZW5ndGggLyAzLAogICAgICB0eXBlOiAiVkVDMyIsCiAgICAgIG1heDogW21pblgsIG1pblksIG1pblpdLAogICAgICBtaW46IFttYXhYLCBtYXhZLCBtYXhaXQogICAgfSk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KG5vcm1hbHNVUkwpKSB7CiAgICAgIGF0dHJpYnV0ZXMuTk9STUFMID0gYWNjZXNzb3JzLmxlbmd0aDsKICAgICAgYnVmZmVycy5wdXNoKHsKICAgICAgICB1cmk6IG5vcm1hbHNVUkwsCiAgICAgICAgYnl0ZUxlbmd0aDogbWVzaE5vcm1hbHMuYnl0ZUxlbmd0aAogICAgICB9KTsKICAgICAgYnVmZmVyVmlld3MucHVzaCh7CiAgICAgICAgYnVmZmVyOiBidWZmZXJzLmxlbmd0aCAtIDEsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoTm9ybWFscy5ieXRlTGVuZ3RoLAogICAgICAgIHRhcmdldDogMzQ5NjIKICAgICAgfSk7CiAgICAgIGFjY2Vzc29ycy5wdXNoKHsKICAgICAgICBidWZmZXJWaWV3OiBidWZmZXJWaWV3cy5sZW5ndGggLSAxLAogICAgICAgIGJ5dGVPZmZzZXQ6IDAsCiAgICAgICAgY29tcG9uZW50VHlwZTogNTEyNiwKICAgICAgICBjb3VudDogbWVzaE5vcm1hbHMubGVuZ3RoIC8gMywKICAgICAgICB0eXBlOiAiVkVDMyIKICAgICAgfSk7CiAgICB9CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHV2MFVSTCkpIHsKICAgICAgYXR0cmlidXRlcy5URVhDT09SRF8wID0gYWNjZXNzb3JzLmxlbmd0aDsKICAgICAgYnVmZmVycy5wdXNoKHsKICAgICAgICB1cmk6IHV2MFVSTCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoVXYwcy5ieXRlTGVuZ3RoCiAgICAgIH0pOwogICAgICBidWZmZXJWaWV3cy5wdXNoKHsKICAgICAgICBidWZmZXI6IGJ1ZmZlcnMubGVuZ3RoIC0gMSwKICAgICAgICBieXRlT2Zmc2V0OiAwLAogICAgICAgIGJ5dGVMZW5ndGg6IG1lc2hVdjBzLmJ5dGVMZW5ndGgsCiAgICAgICAgdGFyZ2V0OiAzNDk2MgogICAgICB9KTsKICAgICAgYWNjZXNzb3JzLnB1c2goewogICAgICAgIGJ1ZmZlclZpZXc6IGJ1ZmZlclZpZXdzLmxlbmd0aCAtIDEsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBjb21wb25lbnRUeXBlOiA1MTI2LAogICAgICAgIGNvdW50OiBtZXNoVXYwcy5sZW5ndGggLyAyLAogICAgICAgIHR5cGU6ICJWRUMyIgogICAgICB9KTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoY29sb3JzVVJMKSkgewogICAgICBhdHRyaWJ1dGVzLkNPTE9SXzAgPSBhY2Nlc3NvcnMubGVuZ3RoOwogICAgICBidWZmZXJzLnB1c2goewogICAgICAgIHVyaTogY29sb3JzVVJMLAogICAgICAgIGJ5dGVMZW5ndGg6IG1lc2hDb2xvcnNJbkJ5dGVzLmJ5dGVMZW5ndGgKICAgICAgfSk7CiAgICAgIGJ1ZmZlclZpZXdzLnB1c2goewogICAgICAgIGJ1ZmZlcjogYnVmZmVycy5sZW5ndGggLSAxLAogICAgICAgIGJ5dGVPZmZzZXQ6IDAsCiAgICAgICAgYnl0ZUxlbmd0aDogbWVzaENvbG9yc0luQnl0ZXMuYnl0ZUxlbmd0aCwKICAgICAgICB0YXJnZXQ6IDM0OTYyCiAgICAgIH0pOwogICAgICBhY2Nlc3NvcnMucHVzaCh7CiAgICAgICAgYnVmZmVyVmlldzogYnVmZmVyVmlld3MubGVuZ3RoIC0gMSwKICAgICAgICBieXRlT2Zmc2V0OiAwLAogICAgICAgIGNvbXBvbmVudFR5cGU6IDUxMjYsCiAgICAgICAgY291bnQ6IG1lc2hDb2xvcnNJbkJ5dGVzLmxlbmd0aCAvIDQsCiAgICAgICAgdHlwZTogIlZFQzQiCiAgICAgIH0pOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChmZWF0dXJlSWQwVVJMKSkgewogICAgICBhdHRyaWJ1dGVzLl9GRUFUVVJFX0lEXzAgPSBhY2Nlc3NvcnMubGVuZ3RoOwogICAgICBidWZmZXJzLnB1c2goewogICAgICAgIHVyaTogZmVhdHVyZUlkMFVSTCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoRmVhdHVyZUlkMC5ieXRlTGVuZ3RoCiAgICAgIH0pOwogICAgICBidWZmZXJWaWV3cy5wdXNoKHsKICAgICAgICBidWZmZXI6IGJ1ZmZlcnMubGVuZ3RoIC0gMSwKICAgICAgICBieXRlT2Zmc2V0OiAwLAogICAgICAgIGJ5dGVMZW5ndGg6IG1lc2hGZWF0dXJlSWQwLmJ5dGVMZW5ndGgsCiAgICAgICAgdGFyZ2V0OiAzNDk2MwogICAgICB9KTsKICAgICAgYWNjZXNzb3JzLnB1c2goewogICAgICAgIGJ1ZmZlclZpZXc6IGJ1ZmZlclZpZXdzLmxlbmd0aCAtIDEsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBjb21wb25lbnRUeXBlOiA1MTI2LAogICAgICAgIGNvdW50OiBtZXNoRmVhdHVyZUlkMC5sZW5ndGgsCiAgICAgICAgdHlwZTogIlNDQUxBUiIKICAgICAgfSk7CiAgICAgIGV4dGVuc2lvbnMuRVhUX21lc2hfZmVhdHVyZXMgPSB7CiAgICAgICAgZmVhdHVyZUlkczogWwogICAgICAgICAgewogICAgICAgICAgICBhdHRyaWJ1dGU6IDAsCiAgICAgICAgICAgIHByb3BlcnR5VGFibGU6IDAsCiAgICAgICAgICAgIGZlYXR1cmVDb3VudAogICAgICAgICAgfQogICAgICAgIF0KICAgICAgfTsKICAgICAgZXh0ZW5zaW9uc1VzZWQucHVzaCgiRVhUX21lc2hfZmVhdHVyZXMiKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQocHJvcGVydHlUYWJsZTBVUkwpKSB7CiAgICAgIGJ1ZmZlcnMucHVzaCh7CiAgICAgICAgdXJpOiBwcm9wZXJ0eVRhYmxlMFVSTCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoUHJvcGVydHlUYWJsZTAuYnl0ZUxlbmd0aAogICAgICB9KTsKICAgICAgYnVmZmVyVmlld3MucHVzaCh7CiAgICAgICAgYnVmZmVyOiBidWZmZXJzLmxlbmd0aCAtIDEsCiAgICAgICAgYnl0ZU9mZnNldDogMCwKICAgICAgICBieXRlTGVuZ3RoOiBtZXNoUHJvcGVydHlUYWJsZTAuYnl0ZUxlbmd0aCwKICAgICAgICB0YXJnZXQ6IDM0OTYzCiAgICAgIH0pOwogICAgICByb290RXh0ZW5zaW9ucy5FWFRfc3RydWN0dXJhbF9tZXRhZGF0YSA9IHsKICAgICAgICBzY2hlbWE6IHsKICAgICAgICAgIGlkOiAiaTNzLW1ldGFkYXRhLXNjaGVtYS0wMDEiLAogICAgICAgICAgbmFtZTogIkkzUyBtZXRhZGF0YSBzY2hlbWEgMDAxIiwKICAgICAgICAgIGRlc2NyaXB0aW9uOiAiVGhlIHNjaGVtYSBmb3IgSTNTIG1ldGFkYXRhIiwKICAgICAgICAgIHZlcnNpb246ICIxLjAiLAogICAgICAgICAgY2xhc3NlczogewogICAgICAgICAgICBmZWF0dXJlOiB7CiAgICAgICAgICAgICAgbmFtZTogImZlYXR1cmUiLAogICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiRmVhdHVyZSBtZXRhZGF0YSIsCiAgICAgICAgICAgICAgcHJvcGVydGllczogewogICAgICAgICAgICAgICAgaW5kZXg6IHsKICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICJUaGUgZmVhdHVyZSBpbmRleCIsCiAgICAgICAgICAgICAgICAgIHR5cGU6ICJTQ0FMQVIiLAogICAgICAgICAgICAgICAgICBjb21wb25lbnRUeXBlOiAiRkxPQVQzMiIsCiAgICAgICAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBwcm9wZXJ0eVRhYmxlczogWwogICAgICAgICAgewogICAgICAgICAgICBuYW1lOiAiZmVhdHVyZS1pbmRpY2VzLW1hcHBpbmciLAogICAgICAgICAgICBjbGFzczogImZlYXR1cmUiLAogICAgICAgICAgICBjb3VudDogZmVhdHVyZUNvdW50LAogICAgICAgICAgICBwcm9wZXJ0aWVzOiB7CiAgICAgICAgICAgICAgaW5kZXg6IHsKICAgICAgICAgICAgICAgIHZhbHVlczogYnVmZmVyVmlld3MubGVuZ3RoIC0gMQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIF0KICAgICAgfTsKICAgICAgZXh0ZW5zaW9uc1VzZWQucHVzaCgiRVhUX3N0cnVjdHVyYWxfbWV0YWRhdGEiKTsKICAgIH0KICAgIGlmIChkZWZpbmVkX2RlZmF1bHQob3V0bGluZXNJbmRpY2VzVVJMKSkgewogICAgICBidWZmZXJzLnB1c2goewogICAgICAgIHVyaTogb3V0bGluZXNJbmRpY2VzVVJMLAogICAgICAgIGJ5dGVMZW5ndGg6IG91dGxpbmVzSW5kZXhBcnJheS5ieXRlTGVuZ3RoCiAgICAgIH0pOwogICAgICBidWZmZXJWaWV3cy5wdXNoKHsKICAgICAgICBidWZmZXI6IGJ1ZmZlcnMubGVuZ3RoIC0gMSwKICAgICAgICBieXRlT2Zmc2V0OiAwLAogICAgICAgIGJ5dGVMZW5ndGg6IG91dGxpbmVzSW5kZXhBcnJheS5ieXRlTGVuZ3RoLAogICAgICAgIHRhcmdldDogMzQ5NjMKICAgICAgfSk7CiAgICAgIGFjY2Vzc29ycy5wdXNoKHsKICAgICAgICBidWZmZXJWaWV3OiBidWZmZXJWaWV3cy5sZW5ndGggLSAxLAogICAgICAgIGJ5dGVPZmZzZXQ6IDAsCiAgICAgICAgY29tcG9uZW50VHlwZTogNTEyNSwKICAgICAgICBjb3VudDogb3V0bGluZXNJbmRleEFycmF5Lmxlbmd0aCwKICAgICAgICB0eXBlOiAiU0NBTEFSIgogICAgICB9KTsKICAgICAgZXh0ZW5zaW9ucy5DRVNJVU1fcHJpbWl0aXZlX291dGxpbmUgPSB7CiAgICAgICAgaW5kaWNlczogYWNjZXNzb3JzLmxlbmd0aCAtIDEKICAgICAgfTsKICAgICAgZXh0ZW5zaW9uc1VzZWQucHVzaCgiQ0VTSVVNX3ByaW1pdGl2ZV9vdXRsaW5lIik7CiAgICB9CiAgICBidWZmZXJzLnB1c2goewogICAgICB1cmk6IGluZGljZXNVUkwsCiAgICAgIGJ5dGVMZW5ndGg6IGluZGV4QXJyYXkuYnl0ZUxlbmd0aAogICAgfSk7CiAgICBidWZmZXJWaWV3cy5wdXNoKHsKICAgICAgYnVmZmVyOiBidWZmZXJzLmxlbmd0aCAtIDEsCiAgICAgIGJ5dGVPZmZzZXQ6IDAsCiAgICAgIGJ5dGVMZW5ndGg6IGluZGV4QXJyYXkuYnl0ZUxlbmd0aCwKICAgICAgdGFyZ2V0OiAzNDk2MwogICAgfSk7CiAgICBjb25zdCBtZXNoUHJpbWl0aXZlcyA9IFtdOwogICAgaWYgKHRyYW5zcGFyZW50VmVydGV4T2Zmc2V0ID4gMCkgewogICAgICBhY2Nlc3NvcnMucHVzaCh7CiAgICAgICAgYnVmZmVyVmlldzogYnVmZmVyVmlld3MubGVuZ3RoIC0gMSwKICAgICAgICBieXRlT2Zmc2V0OiAwLAogICAgICAgIGNvbXBvbmVudFR5cGU6IDUxMjUsCiAgICAgICAgY291bnQ6IHRyYW5zcGFyZW50VmVydGV4T2Zmc2V0LAogICAgICAgIHR5cGU6ICJTQ0FMQVIiCiAgICAgIH0pOwogICAgICBtZXNoUHJpbWl0aXZlcy5wdXNoKHsKICAgICAgICBhdHRyaWJ1dGVzLAogICAgICAgIGluZGljZXM6IGFjY2Vzc29ycy5sZW5ndGggLSAxLAogICAgICAgIG1hdGVyaWFsOiBtZXNoUHJpbWl0aXZlcy5sZW5ndGgsCiAgICAgICAgZXh0ZW5zaW9ucwogICAgICB9KTsKICAgIH0KICAgIGlmICh0cmFuc3BhcmVudFZlcnRleE9mZnNldCA8IHZlcnRleENvdW50KSB7CiAgICAgIGFjY2Vzc29ycy5wdXNoKHsKICAgICAgICBidWZmZXJWaWV3OiBidWZmZXJWaWV3cy5sZW5ndGggLSAxLAogICAgICAgIGJ5dGVPZmZzZXQ6IDQgKiB0cmFuc3BhcmVudFZlcnRleE9mZnNldCwKICAgICAgICAvLyBza2lwIDQgYnl0ZXMgZm9yIGVhY2ggb3BhcXVlIHZlcnRleAogICAgICAgIGNvbXBvbmVudFR5cGU6IDUxMjUsCiAgICAgICAgY291bnQ6IHZlcnRleENvdW50IC0gdHJhbnNwYXJlbnRWZXJ0ZXhPZmZzZXQsCiAgICAgICAgdHlwZTogIlNDQUxBUiIKICAgICAgfSk7CiAgICAgIG1lc2hQcmltaXRpdmVzLnB1c2goewogICAgICAgIGF0dHJpYnV0ZXMsCiAgICAgICAgaW5kaWNlczogYWNjZXNzb3JzLmxlbmd0aCAtIDEsCiAgICAgICAgbWF0ZXJpYWw6IG1lc2hQcmltaXRpdmVzLmxlbmd0aCwKICAgICAgICBleHRlbnNpb25zLAogICAgICAgIGV4dHJhOiB7CiAgICAgICAgICBpc1RyYW5zcGFyZW50OiB0cnVlCiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIG1lc2hlcy5wdXNoKHsKICAgICAgcHJpbWl0aXZlczogbWVzaFByaW1pdGl2ZXMKICAgIH0pOwogICAgbm9kZXNJblNjZW5lLnB1c2goMCk7CiAgICBub2Rlcy5wdXNoKHsgbWVzaDogMCB9KTsKICAgIHJldHVybiB7CiAgICAgIGJ1ZmZlcnMsCiAgICAgIGJ1ZmZlclZpZXdzLAogICAgICBhY2Nlc3NvcnMsCiAgICAgIG1lc2hlcywKICAgICAgbm9kZXMsCiAgICAgIG5vZGVzSW5TY2VuZSwKICAgICAgcm9vdEV4dGVuc2lvbnMsCiAgICAgIGV4dGVuc2lvbnNVc2VkCiAgICB9OwogIH0KICBmdW5jdGlvbiBkZWNvZGUyKGRhdGEsIHNjaGVtYSwgYnVmZmVySW5mbywgZmVhdHVyZURhdGEpIHsKICAgIGNvbnN0IG1hZ2ljTnVtYmVyID0gbmV3IFVpbnQ4QXJyYXkoZGF0YSwgMCwgNSk7CiAgICBpZiAobWFnaWNOdW1iZXJbMF0gPT09ICJEIi5jaGFyQ29kZUF0KCkgJiYgbWFnaWNOdW1iZXJbMV0gPT09ICJSIi5jaGFyQ29kZUF0KCkgJiYgbWFnaWNOdW1iZXJbMl0gPT09ICJBIi5jaGFyQ29kZUF0KCkgJiYgbWFnaWNOdW1iZXJbM10gPT09ICJDIi5jaGFyQ29kZUF0KCkgJiYgbWFnaWNOdW1iZXJbNF0gPT09ICJPIi5jaGFyQ29kZUF0KCkpIHsKICAgICAgcmV0dXJuIGRlY29kZURyYWNvRW5jb2RlZEdlb21ldHJ5KGRhdGEsIGJ1ZmZlckluZm8pOwogICAgfQogICAgcmV0dXJuIGRlY29kZUJpbmFyeUdlb21ldHJ5KGRhdGEsIHNjaGVtYSwgYnVmZmVySW5mbywgZmVhdHVyZURhdGEpOwogIH0KICBmdW5jdGlvbiBkZWNvZGVEcmFjb0VuY29kZWRHZW9tZXRyeShkYXRhKSB7CiAgICBjb25zdCBkcmFjb0RlY29kZXJNb2R1bGUgPSBkcmFjbzI7CiAgICBjb25zdCBidWZmZXIgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRlY29kZXJCdWZmZXIoKTsKICAgIGNvbnN0IGJ5dGVBcnJheSA9IG5ldyBVaW50OEFycmF5KGRhdGEpOwogICAgYnVmZmVyLkluaXQoYnl0ZUFycmF5LCBieXRlQXJyYXkubGVuZ3RoKTsKICAgIGNvbnN0IGRyYWNvRGVjb2RlciA9IG5ldyBkcmFjb0RlY29kZXJNb2R1bGUuRGVjb2RlcigpOwogICAgY29uc3QgZ2VvbWV0cnlUeXBlID0gZHJhY29EZWNvZGVyLkdldEVuY29kZWRHZW9tZXRyeVR5cGUoYnVmZmVyKTsKICAgIGNvbnN0IG1ldGFkYXRhUXVlcmllciA9IG5ldyBkcmFjb0RlY29kZXJNb2R1bGUuTWV0YWRhdGFRdWVyaWVyKCk7CiAgICBsZXQgZHJhY29HZW9tZXRyeTsKICAgIGxldCBzdGF0dXM7CiAgICBpZiAoZ2VvbWV0cnlUeXBlID09PSBkcmFjb0RlY29kZXJNb2R1bGUuVFJJQU5HVUxBUl9NRVNIKSB7CiAgICAgIGRyYWNvR2VvbWV0cnkgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLk1lc2goKTsKICAgICAgc3RhdHVzID0gZHJhY29EZWNvZGVyLkRlY29kZUJ1ZmZlclRvTWVzaChidWZmZXIsIGRyYWNvR2VvbWV0cnkpOwogICAgfQogICAgY29uc3QgZGVjb2RlZEdlb21ldHJ5ID0gewogICAgICB2ZXJ0ZXhDb3VudDogWzBdLAogICAgICBmZWF0dXJlQ291bnQ6IDAKICAgIH07CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHN0YXR1cykgJiYgc3RhdHVzLm9rKCkgJiYgZHJhY29HZW9tZXRyeS5wdHIgIT09IDApIHsKICAgICAgY29uc3QgZmFjZUNvdW50ID0gZHJhY29HZW9tZXRyeS5udW1fZmFjZXMoKTsKICAgICAgY29uc3QgYXR0cmlidXRlc0NvdW50ID0gZHJhY29HZW9tZXRyeS5udW1fYXR0cmlidXRlcygpOwogICAgICBjb25zdCB2ZXJ0ZXhDb3VudCA9IGRyYWNvR2VvbWV0cnkubnVtX3BvaW50cygpOwogICAgICBkZWNvZGVkR2VvbWV0cnkuaW5kaWNlcyA9IG5ldyBVaW50MzJBcnJheShmYWNlQ291bnQgKiAzKTsKICAgICAgY29uc3QgZmFjZXMyID0gZGVjb2RlZEdlb21ldHJ5LmluZGljZXM7CiAgICAgIGRlY29kZWRHZW9tZXRyeS52ZXJ0ZXhDb3VudFswXSA9IHZlcnRleENvdW50OwogICAgICBkZWNvZGVkR2VvbWV0cnkuc2NhbGVfeCA9IDE7CiAgICAgIGRlY29kZWRHZW9tZXRyeS5zY2FsZV95ID0gMTsKICAgICAgY29uc3QgZmFjZSA9IG5ldyBkcmFjb0RlY29kZXJNb2R1bGUuRHJhY29JbnQzMkFycmF5KDMpOwogICAgICBmb3IgKGxldCBmYWNlSW5kZXggPSAwOyBmYWNlSW5kZXggPCBmYWNlQ291bnQ7ICsrZmFjZUluZGV4KSB7CiAgICAgICAgZHJhY29EZWNvZGVyLkdldEZhY2VGcm9tTWVzaChkcmFjb0dlb21ldHJ5LCBmYWNlSW5kZXgsIGZhY2UpOwogICAgICAgIGZhY2VzMltmYWNlSW5kZXggKiAzXSA9IGZhY2UuR2V0VmFsdWUoMCk7CiAgICAgICAgZmFjZXMyW2ZhY2VJbmRleCAqIDMgKyAxXSA9IGZhY2UuR2V0VmFsdWUoMSk7CiAgICAgICAgZmFjZXMyW2ZhY2VJbmRleCAqIDMgKyAyXSA9IGZhY2UuR2V0VmFsdWUoMik7CiAgICAgIH0KICAgICAgZHJhY29EZWNvZGVyTW9kdWxlLmRlc3Ryb3koZmFjZSk7CiAgICAgIGZvciAobGV0IGF0dHJJbmRleCA9IDA7IGF0dHJJbmRleCA8IGF0dHJpYnV0ZXNDb3VudDsgKythdHRySW5kZXgpIHsKICAgICAgICBjb25zdCBkcmFjb0F0dHJpYnV0ZSA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGUoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgYXR0ckluZGV4CiAgICAgICAgKTsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVEYXRhID0gZGVjb2RlRHJhY29BdHRyaWJ1dGUoCiAgICAgICAgICBkcmFjb0RlY29kZXJNb2R1bGUsCiAgICAgICAgICBkcmFjb0RlY29kZXIsCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICB2ZXJ0ZXhDb3VudAogICAgICAgICk7CiAgICAgICAgY29uc3QgZHJhY29BdHRyaWJ1dGVUeXBlID0gZHJhY29BdHRyaWJ1dGUuYXR0cmlidXRlX3R5cGUoKTsKICAgICAgICBsZXQgYXR0cmlidXRlaTNzTmFtZSA9ICJ1bmtub3duIjsKICAgICAgICBpZiAoZHJhY29BdHRyaWJ1dGVUeXBlID09PSBkcmFjb0RlY29kZXJNb2R1bGUuUE9TSVRJT04pIHsKICAgICAgICAgIGF0dHJpYnV0ZWkzc05hbWUgPSAicG9zaXRpb25zIjsKICAgICAgICB9IGVsc2UgaWYgKGRyYWNvQXR0cmlidXRlVHlwZSA9PT0gZHJhY29EZWNvZGVyTW9kdWxlLk5PUk1BTCkgewogICAgICAgICAgYXR0cmlidXRlaTNzTmFtZSA9ICJub3JtYWxzIjsKICAgICAgICB9IGVsc2UgaWYgKGRyYWNvQXR0cmlidXRlVHlwZSA9PT0gZHJhY29EZWNvZGVyTW9kdWxlLkNPTE9SKSB7CiAgICAgICAgICBhdHRyaWJ1dGVpM3NOYW1lID0gImNvbG9ycyI7CiAgICAgICAgfSBlbHNlIGlmIChkcmFjb0F0dHJpYnV0ZVR5cGUgPT09IGRyYWNvRGVjb2Rlck1vZHVsZS5URVhfQ09PUkQpIHsKICAgICAgICAgIGF0dHJpYnV0ZWkzc05hbWUgPSAidXYwcyI7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1ldGFkYXRhID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZU1ldGFkYXRhKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGF0dHJJbmRleAogICAgICAgICk7CiAgICAgICAgaWYgKG1ldGFkYXRhLnB0ciAhPT0gMCkgewogICAgICAgICAgY29uc3QgbnVtRW50cmllcyA9IG1ldGFkYXRhUXVlcmllci5OdW1FbnRyaWVzKG1ldGFkYXRhKTsKICAgICAgICAgIGZvciAobGV0IGVudHJ5ID0gMDsgZW50cnkgPCBudW1FbnRyaWVzOyArK2VudHJ5KSB7CiAgICAgICAgICAgIGNvbnN0IGVudHJ5TmFtZSA9IG1ldGFkYXRhUXVlcmllci5HZXRFbnRyeU5hbWUobWV0YWRhdGEsIGVudHJ5KTsKICAgICAgICAgICAgaWYgKGVudHJ5TmFtZSA9PT0gImkzcy1zY2FsZV94IikgewogICAgICAgICAgICAgIGRlY29kZWRHZW9tZXRyeS5zY2FsZV94ID0gbWV0YWRhdGFRdWVyaWVyLkdldERvdWJsZUVudHJ5KAogICAgICAgICAgICAgICAgbWV0YWRhdGEsCiAgICAgICAgICAgICAgICAiaTNzLXNjYWxlX3giCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlbnRyeU5hbWUgPT09ICJpM3Mtc2NhbGVfeSIpIHsKICAgICAgICAgICAgICBkZWNvZGVkR2VvbWV0cnkuc2NhbGVfeSA9IG1ldGFkYXRhUXVlcmllci5HZXREb3VibGVFbnRyeSgKICAgICAgICAgICAgICAgIG1ldGFkYXRhLAogICAgICAgICAgICAgICAgImkzcy1zY2FsZV95IgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZW50cnlOYW1lID09PSAiaTNzLWF0dHJpYnV0ZS10eXBlIikgewogICAgICAgICAgICAgIGF0dHJpYnV0ZWkzc05hbWUgPSBtZXRhZGF0YVF1ZXJpZXIuR2V0U3RyaW5nRW50cnkoCiAgICAgICAgICAgICAgICBtZXRhZGF0YSwKICAgICAgICAgICAgICAgICJpM3MtYXR0cmlidXRlLXR5cGUiCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGRlY29kZWRHZW9tZXRyeVthdHRyaWJ1dGVpM3NOYW1lXSkpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCJBdHRyaWJ1dGUgYWxyZWFkeSBleGlzdHMiLCBhdHRyaWJ1dGVpM3NOYW1lKTsKICAgICAgICB9CiAgICAgICAgZGVjb2RlZEdlb21ldHJ5W2F0dHJpYnV0ZWkzc05hbWVdID0gYXR0cmlidXRlRGF0YTsKICAgICAgICBpZiAoYXR0cmlidXRlaTNzTmFtZSA9PT0gImZlYXR1cmUtaW5kZXgiKSB7CiAgICAgICAgICBkZWNvZGVkR2VvbWV0cnkuZmVhdHVyZUNvdW50Kys7CiAgICAgICAgfQogICAgICB9CiAgICAgIGRyYWNvRGVjb2Rlck1vZHVsZS5kZXN0cm95KGRyYWNvR2VvbWV0cnkpOwogICAgfQogICAgZHJhY29EZWNvZGVyTW9kdWxlLmRlc3Ryb3kobWV0YWRhdGFRdWVyaWVyKTsKICAgIGRyYWNvRGVjb2Rlck1vZHVsZS5kZXN0cm95KGRyYWNvRGVjb2Rlcik7CiAgICByZXR1cm4gZGVjb2RlZEdlb21ldHJ5OwogIH0KICBmdW5jdGlvbiBkZWNvZGVEcmFjb0F0dHJpYnV0ZShkcmFjb0RlY29kZXJNb2R1bGUsIGRyYWNvRGVjb2RlciwgZHJhY29HZW9tZXRyeSwgZHJhY29BdHRyaWJ1dGUsIHZlcnRleENvdW50KSB7CiAgICBjb25zdCBidWZmZXJTaXplID0gZHJhY29BdHRyaWJ1dGUubnVtX2NvbXBvbmVudHMoKSAqIHZlcnRleENvdW50OwogICAgbGV0IGRyYWNvQXR0cmlidXRlRGF0YTsKICAgIGNvbnN0IGhhbmRsZXJzID0gWwogICAgICBmdW5jdGlvbigpIHsKICAgICAgfSwKICAgICAgLy8gRFRfSU5WQUxJRCAtIDAKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5EcmFjb0ludDhBcnJheShidWZmZXJTaXplKTsKICAgICAgICBjb25zdCBzdWNjZXNzID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUludDhGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGlmICghc3VjY2VzcykgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQmFkIHN0cmVhbSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVEYXRhMiA9IG5ldyBJbnQ4QXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXJTaXplOyArK2kpIHsKICAgICAgICAgIGF0dHJpYnV0ZURhdGEyW2ldID0gZHJhY29BdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlRGF0YTI7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjb0RlY29kZXJNb2R1bGUuRHJhY29JbnQ4QXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVVSW50OEZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgaWYgKCFzdWNjZXNzKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCJCYWQgc3RyZWFtIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZURhdGEyID0gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXJTaXplOyArK2kpIHsKICAgICAgICAgIGF0dHJpYnV0ZURhdGEyW2ldID0gZHJhY29BdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlRGF0YTI7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YSA9IG5ldyBkcmFjb0RlY29kZXJNb2R1bGUuRHJhY29JbnQxNkFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlSW50MTZGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGlmICghc3VjY2VzcykgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQmFkIHN0cmVhbSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVEYXRhMiA9IG5ldyBJbnQxNkFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyU2l6ZTsgKytpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVEYXRhMltpXSA9IGRyYWNvQXR0cmlidXRlRGF0YS5HZXRWYWx1ZShpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZURhdGEyOwogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRyYWNvSW50MTZBcnJheShidWZmZXJTaXplKTsKICAgICAgICBjb25zdCBzdWNjZXNzID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQxNkZvckFsbFBvaW50cygKICAgICAgICAgIGRyYWNvR2VvbWV0cnksCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlRGF0YQogICAgICAgICk7CiAgICAgICAgaWYgKCFzdWNjZXNzKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCJCYWQgc3RyZWFtIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJpYnV0ZURhdGEyID0gbmV3IFVpbnQxNkFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnVmZmVyU2l6ZTsgKytpKSB7CiAgICAgICAgICBhdHRyaWJ1dGVEYXRhMltpXSA9IGRyYWNvQXR0cmlidXRlRGF0YS5HZXRWYWx1ZShpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZURhdGEyOwogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRyYWNvSW50MzJBcnJheShidWZmZXJTaXplKTsKICAgICAgICBjb25zdCBzdWNjZXNzID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZUludDMyRm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkJhZCBzdHJlYW0iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YTIgPSBuZXcgSW50MzJBcnJheShidWZmZXJTaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlclNpemU7ICsraSkgewogICAgICAgICAgYXR0cmlidXRlRGF0YTJbaV0gPSBkcmFjb0F0dHJpYnV0ZURhdGEuR2V0VmFsdWUoaSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyaWJ1dGVEYXRhMjsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhID0gbmV3IGRyYWNvRGVjb2Rlck1vZHVsZS5EcmFjb0ludDMyQXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRyYWNvRGVjb2Rlci5HZXRBdHRyaWJ1dGVVSW50MzJGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGlmICghc3VjY2VzcykgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQmFkIHN0cmVhbSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVEYXRhMiA9IG5ldyBVaW50MzJBcnJheShidWZmZXJTaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlclNpemU7ICsraSkgewogICAgICAgICAgYXR0cmlidXRlRGF0YTJbaV0gPSBkcmFjb0F0dHJpYnV0ZURhdGEuR2V0VmFsdWUoaSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyaWJ1dGVEYXRhMjsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRyYWNvRmxvYXQzMkFycmF5KGJ1ZmZlclNpemUpOwogICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBkcmFjb0RlY29kZXIuR2V0QXR0cmlidXRlRmxvYXRGb3JBbGxQb2ludHMoCiAgICAgICAgICBkcmFjb0dlb21ldHJ5LAogICAgICAgICAgZHJhY29BdHRyaWJ1dGUsCiAgICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEKICAgICAgICApOwogICAgICAgIGlmICghc3VjY2VzcykgewogICAgICAgICAgY29uc29sZS5lcnJvcigiQmFkIHN0cmVhbSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyaWJ1dGVEYXRhMiA9IG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyU2l6ZSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXJTaXplOyArK2kpIHsKICAgICAgICAgIGF0dHJpYnV0ZURhdGEyW2ldID0gZHJhY29BdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cmlidXRlRGF0YTI7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBkcmFjb0F0dHJpYnV0ZURhdGEgPSBuZXcgZHJhY29EZWNvZGVyTW9kdWxlLkRyYWNvVUludDhBcnJheShidWZmZXJTaXplKTsKICAgICAgICBjb25zdCBzdWNjZXNzID0gZHJhY29EZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQ4Rm9yQWxsUG9pbnRzKAogICAgICAgICAgZHJhY29HZW9tZXRyeSwKICAgICAgICAgIGRyYWNvQXR0cmlidXRlLAogICAgICAgICAgZHJhY29BdHRyaWJ1dGVEYXRhCiAgICAgICAgKTsKICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkJhZCBzdHJlYW0iKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YTIgPSBuZXcgVWludDhBcnJheShidWZmZXJTaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlclNpemU7ICsraSkgewogICAgICAgICAgYXR0cmlidXRlRGF0YTJbaV0gPSBkcmFjb0F0dHJpYnV0ZURhdGEuR2V0VmFsdWUoaSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyaWJ1dGVEYXRhMjsKICAgICAgfQogICAgXTsKICAgIGNvbnN0IGF0dHJpYnV0ZURhdGEgPSBoYW5kbGVyc1tkcmFjb0F0dHJpYnV0ZS5kYXRhX3R5cGUoKV0oKTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZHJhY29BdHRyaWJ1dGVEYXRhKSkgewogICAgICBkcmFjb0RlY29kZXJNb2R1bGUuZGVzdHJveShkcmFjb0F0dHJpYnV0ZURhdGEpOwogICAgfQogICAgcmV0dXJuIGF0dHJpYnV0ZURhdGE7CiAgfQogIGZ1bmN0aW9uIGRlY29kZUJpbmFyeUdlb21ldHJ5KGRhdGEsIHNjaGVtYSwgYnVmZmVySW5mbywgZmVhdHVyZURhdGEpIHsKICAgIGNvbnN0IGRlY29kZWRHZW9tZXRyeSA9IHsKICAgICAgdmVydGV4Q291bnQ6IDAKICAgIH07CiAgICBjb25zdCBkYXRhVmlldyA9IG5ldyBEYXRhVmlldyhkYXRhKTsKICAgIHRyeSB7CiAgICAgIGxldCBvZmZzZXQgPSAwOwogICAgICBkZWNvZGVkR2VvbWV0cnkudmVydGV4Q291bnQgPSBkYXRhVmlldy5nZXRVaW50MzIob2Zmc2V0LCAxKTsKICAgICAgb2Zmc2V0ICs9IDQ7CiAgICAgIGRlY29kZWRHZW9tZXRyeS5mZWF0dXJlQ291bnQgPSBkYXRhVmlldy5nZXRVaW50MzIob2Zmc2V0LCAxKTsKICAgICAgb2Zmc2V0ICs9IDQ7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoYnVmZmVySW5mbykpIHsKICAgICAgICBmb3IgKGxldCBhdHRySW5kZXggPSAwOyBhdHRySW5kZXggPCBidWZmZXJJbmZvLmF0dHJpYnV0ZXMubGVuZ3RoOyBhdHRySW5kZXgrKykgewogICAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChiaW5hcnlBdHRyaWJ1dGVEZWNvZGVyc1tidWZmZXJJbmZvLmF0dHJpYnV0ZXNbYXR0ckluZGV4XV0pKSB7CiAgICAgICAgICAgIG9mZnNldCA9IGJpbmFyeUF0dHJpYnV0ZURlY29kZXJzW2J1ZmZlckluZm8uYXR0cmlidXRlc1thdHRySW5kZXhdXSgKICAgICAgICAgICAgICBkZWNvZGVkR2VvbWV0cnksCiAgICAgICAgICAgICAgZGF0YSwKICAgICAgICAgICAgICBvZmZzZXQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAgICAgIlVua25vd24gZGVjb2RlciBmb3IiLAogICAgICAgICAgICAgIGJ1ZmZlckluZm8uYXR0cmlidXRlc1thdHRySW5kZXhdCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGxldCBvcmRlcmluZyA9IHNjaGVtYS5vcmRlcmluZzsKICAgICAgICBsZXQgZmVhdHVyZUF0dHJpYnV0ZU9yZGVyID0gc2NoZW1hLmZlYXR1cmVBdHRyaWJ1dGVPcmRlcjsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGZlYXR1cmVEYXRhKSAmJiBkZWZpbmVkX2RlZmF1bHQoZmVhdHVyZURhdGEuZ2VvbWV0cnlEYXRhKSAmJiBkZWZpbmVkX2RlZmF1bHQoZmVhdHVyZURhdGEuZ2VvbWV0cnlEYXRhWzBdKSAmJiBkZWZpbmVkX2RlZmF1bHQoZmVhdHVyZURhdGEuZ2VvbWV0cnlEYXRhWzBdLnBhcmFtcykpIHsKICAgICAgICAgIG9yZGVyaW5nID0gT2JqZWN0LmtleXMoCiAgICAgICAgICAgIGZlYXR1cmVEYXRhLmdlb21ldHJ5RGF0YVswXS5wYXJhbXMudmVydGV4QXR0cmlidXRlcwogICAgICAgICAgKTsKICAgICAgICAgIGZlYXR1cmVBdHRyaWJ1dGVPcmRlciA9IE9iamVjdC5rZXlzKAogICAgICAgICAgICBmZWF0dXJlRGF0YS5nZW9tZXRyeURhdGFbMF0ucGFyYW1zLmZlYXR1cmVBdHRyaWJ1dGVzCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9yZGVyaW5nLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBkZWNvZGVyID0gYmluYXJ5QXR0cmlidXRlRGVjb2RlcnNbb3JkZXJpbmdbaV1dOwogICAgICAgICAgb2Zmc2V0ID0gZGVjb2RlcihkZWNvZGVkR2VvbWV0cnksIGRhdGEsIG9mZnNldCk7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgZmVhdHVyZUF0dHJpYnV0ZU9yZGVyLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBjb25zdCBjdXJEZWNvZGVyID0gYmluYXJ5QXR0cmlidXRlRGVjb2RlcnNbZmVhdHVyZUF0dHJpYnV0ZU9yZGVyW2pdXTsKICAgICAgICAgIG9mZnNldCA9IGN1ckRlY29kZXIoZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpOwogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBjb25zb2xlLmVycm9yKGUpOwogICAgfQogICAgZGVjb2RlZEdlb21ldHJ5LnNjYWxlX3ggPSAxOwogICAgZGVjb2RlZEdlb21ldHJ5LnNjYWxlX3kgPSAxOwogICAgcmV0dXJuIGRlY29kZWRHZW9tZXRyeTsKICB9CiAgZnVuY3Rpb24gZGVjb2RlQW5kQ3JlYXRlR2x0ZihwYXJhbWV0ZXJzKSB7CiAgICBjb25zdCBnZW9tZXRyeURhdGEgPSBkZWNvZGUyKAogICAgICBwYXJhbWV0ZXJzLmJpbmFyeURhdGEsCiAgICAgIHBhcmFtZXRlcnMuc2NoZW1hLAogICAgICBwYXJhbWV0ZXJzLmJ1ZmZlckluZm8sCiAgICAgIHBhcmFtZXRlcnMuZmVhdHVyZURhdGEKICAgICk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHBhcmFtZXRlcnMuZ2VvaWREYXRhTGlzdCkgJiYgcGFyYW1ldGVycy5nZW9pZERhdGFMaXN0Lmxlbmd0aCA+IDApIHsKICAgICAgb3J0aG9tZXRyaWNUb0VsbGlwc29pZGFsKAogICAgICAgIGdlb21ldHJ5RGF0YS52ZXJ0ZXhDb3VudCwKICAgICAgICBnZW9tZXRyeURhdGEucG9zaXRpb25zLAogICAgICAgIGdlb21ldHJ5RGF0YS5zY2FsZV94LAogICAgICAgIGdlb21ldHJ5RGF0YS5zY2FsZV95LAogICAgICAgIHBhcmFtZXRlcnMuY2FydG9ncmFwaGljQ2VudGVyLAogICAgICAgIHBhcmFtZXRlcnMuZ2VvaWREYXRhTGlzdCwKICAgICAgICBmYWxzZQogICAgICApOwogICAgfQogICAgdHJhbnNmb3JtVG9Mb2NhbCgKICAgICAgZ2VvbWV0cnlEYXRhLnZlcnRleENvdW50LAogICAgICBnZW9tZXRyeURhdGEucG9zaXRpb25zLAogICAgICBnZW9tZXRyeURhdGEubm9ybWFscywKICAgICAgcGFyYW1ldGVycy5jYXJ0b2dyYXBoaWNDZW50ZXIsCiAgICAgIHBhcmFtZXRlcnMuY2FydGVzaWFuQ2VudGVyLAogICAgICBwYXJhbWV0ZXJzLnBhcmVudFJvdGF0aW9uLAogICAgICBwYXJhbWV0ZXJzLmVsbGlwc29pZFJhZGlpU3F1YXJlLAogICAgICBnZW9tZXRyeURhdGEuc2NhbGVfeCwKICAgICAgZ2VvbWV0cnlEYXRhLnNjYWxlX3kKICAgICk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KGdlb21ldHJ5RGF0YS51djBzKSAmJiBkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnlEYXRhWyJ1di1yZWdpb24iXSkpIHsKICAgICAgY3JvcFVWcygKICAgICAgICBnZW9tZXRyeURhdGEudmVydGV4Q291bnQsCiAgICAgICAgZ2VvbWV0cnlEYXRhLnV2MHMsCiAgICAgICAgZ2VvbWV0cnlEYXRhWyJ1di1yZWdpb24iXQogICAgICApOwogICAgfQogICAgbGV0IGZlYXR1cmVJbmRleDsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnlEYXRhWyJmZWF0dXJlLWluZGV4Il0pKSB7CiAgICAgIGZlYXR1cmVJbmRleCA9IGdlb21ldHJ5RGF0YVsiZmVhdHVyZS1pbmRleCJdOwogICAgfSBlbHNlIGlmIChkZWZpbmVkX2RlZmF1bHQoZ2VvbWV0cnlEYXRhWyJmYWNlUmFuZ2UiXSkpIHsKICAgICAgZmVhdHVyZUluZGV4ID0gbmV3IEFycmF5KGdlb21ldHJ5RGF0YS52ZXJ0ZXhDb3VudCk7CiAgICAgIGZvciAobGV0IHJhbmdlID0gMDsgcmFuZ2UgPCBnZW9tZXRyeURhdGFbImZhY2VSYW5nZSJdLmxlbmd0aCAtIDE7IHJhbmdlICs9IDIpIHsKICAgICAgICBjb25zdCBjdXJJbmRleCA9IHJhbmdlIC8gMjsKICAgICAgICBjb25zdCByYW5nZVN0YXJ0ID0gZ2VvbWV0cnlEYXRhWyJmYWNlUmFuZ2UiXVtyYW5nZV07CiAgICAgICAgY29uc3QgcmFuZ2VFbmQgPSBnZW9tZXRyeURhdGFbImZhY2VSYW5nZSJdW3JhbmdlICsgMV07CiAgICAgICAgZm9yIChsZXQgaSA9IHJhbmdlU3RhcnQ7IGkgPD0gcmFuZ2VFbmQ7IGkrKykgewogICAgICAgICAgZmVhdHVyZUluZGV4W2kgKiAzXSA9IGN1ckluZGV4OwogICAgICAgICAgZmVhdHVyZUluZGV4W2kgKiAzICsgMV0gPSBjdXJJbmRleDsKICAgICAgICAgIGZlYXR1cmVJbmRleFtpICogMyArIDJdID0gY3VySW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAocGFyYW1ldGVycy5jYWxjdWxhdGVOb3JtYWxzKSB7CiAgICAgIGNvbnN0IGRhdGEgPSBnZW5lcmF0ZU5vcm1hbHMoCiAgICAgICAgZ2VvbWV0cnlEYXRhLnZlcnRleENvdW50LAogICAgICAgIGdlb21ldHJ5RGF0YS5pbmRpY2VzLAogICAgICAgIGdlb21ldHJ5RGF0YS5wb3NpdGlvbnMsCiAgICAgICAgZ2VvbWV0cnlEYXRhLm5vcm1hbHMsCiAgICAgICAgZ2VvbWV0cnlEYXRhLnV2MHMsCiAgICAgICAgZ2VvbWV0cnlEYXRhLmNvbG9ycywKICAgICAgICBmZWF0dXJlSW5kZXgKICAgICAgKTsKICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChkYXRhLm5vcm1hbHMpKSB7CiAgICAgICAgZ2VvbWV0cnlEYXRhLm5vcm1hbHMgPSBkYXRhLm5vcm1hbHM7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChkYXRhLnZlcnRleENvdW50KSkgewogICAgICAgICAgZ2VvbWV0cnlEYXRhLnZlcnRleENvdW50ID0gZGF0YS52ZXJ0ZXhDb3VudDsKICAgICAgICAgIGdlb21ldHJ5RGF0YS5pbmRpY2VzID0gZGF0YS5pbmRpY2VzOwogICAgICAgICAgZ2VvbWV0cnlEYXRhLnBvc2l0aW9ucyA9IGRhdGEucG9zaXRpb25zOwogICAgICAgICAgZ2VvbWV0cnlEYXRhLnV2MHMgPSBkYXRhLnV2MHM7CiAgICAgICAgICBnZW9tZXRyeURhdGEuY29sb3JzID0gZGF0YS5jb2xvcnM7CiAgICAgICAgICBmZWF0dXJlSW5kZXggPSBkYXRhLmZlYXR1cmVJbmRleDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IG1lc2hEYXRhID0gZ2VuZXJhdGVHbHRmQnVmZmVyKAogICAgICBnZW9tZXRyeURhdGEudmVydGV4Q291bnQsCiAgICAgIGdlb21ldHJ5RGF0YS5pbmRpY2VzLAogICAgICBnZW9tZXRyeURhdGEucG9zaXRpb25zLAogICAgICBnZW9tZXRyeURhdGEubm9ybWFscywKICAgICAgZ2VvbWV0cnlEYXRhLnV2MHMsCiAgICAgIGdlb21ldHJ5RGF0YS5jb2xvcnMsCiAgICAgIGZlYXR1cmVJbmRleCwKICAgICAgcGFyYW1ldGVycwogICAgKTsKICAgIGNvbnN0IGN1c3RvbUF0dHJpYnV0ZXMgPSB7CiAgICAgIHBvc2l0aW9uczogZ2VvbWV0cnlEYXRhLnBvc2l0aW9ucywKICAgICAgaW5kaWNlczogZ2VvbWV0cnlEYXRhLmluZGljZXMsCiAgICAgIGZlYXR1cmVJbmRleCwKICAgICAgc291cmNlVVJMOiBwYXJhbWV0ZXJzLnVybCwKICAgICAgY2FydGVzaWFuQ2VudGVyOiBwYXJhbWV0ZXJzLmNhcnRlc2lhbkNlbnRlciwKICAgICAgcGFyZW50Um90YXRpb246IHBhcmFtZXRlcnMucGFyZW50Um90YXRpb24KICAgIH07CiAgICBtZXNoRGF0YS5fY3VzdG9tQXR0cmlidXRlcyA9IGN1c3RvbUF0dHJpYnV0ZXM7CiAgICBjb25zdCByZXN1bHRzID0gewogICAgICBtZXNoRGF0YQogICAgfTsKICAgIHJldHVybiByZXN1bHRzOwogIH0KICBhc3luYyBmdW5jdGlvbiBpbml0V29ya2VyMihwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCB3YXNtQ29uZmlnID0gcGFyYW1ldGVycy53ZWJBc3NlbWJseUNvbmZpZzsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQod2FzbUNvbmZpZykgJiYgZGVmaW5lZF9kZWZhdWx0KHdhc21Db25maWcud2FzbUJpbmFyeUZpbGUpKSB7CiAgICAgIGRyYWNvMiA9IGF3YWl0ICgwLCBpbXBvcnRfZHJhY29fZGVjb2Rlcl9ub2RlanMyLmRlZmF1bHQpKHdhc21Db25maWcpOwogICAgfSBlbHNlIHsKICAgICAgZHJhY28yID0gYXdhaXQgKDAsIGltcG9ydF9kcmFjb19kZWNvZGVyX25vZGVqczIuZGVmYXVsdCkoKTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICBmdW5jdGlvbiBkZWNvZGVJM1MocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3Qgd2FzbUNvbmZpZyA9IHBhcmFtZXRlcnMud2ViQXNzZW1ibHlDb25maWc7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHdhc21Db25maWcpKSB7CiAgICAgIHJldHVybiBpbml0V29ya2VyMihwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKTsKICAgIH0KICAgIHJldHVybiBkZWNvZGVBbmRDcmVhdGVHbHRmKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpOwogIH0KICB2YXIgaW1wb3J0X2RyYWNvX2RlY29kZXJfbm9kZWpzMiwgZHJhY28yLCBjYWxjdWxhdGVGYWNlTm9ybWFsQSwgY2FsY3VsYXRlRmFjZU5vcm1hbEIsIGNhbGN1bGF0ZUZhY2VOb3JtYWxDLCBpc0VkZ2VTbW9vdGhBLCBpc0VkZ2VTbW9vdGhCLCBiaW5hcnlBdHRyaWJ1dGVEZWNvZGVycywgZGVjb2RlSTNTX2RlZmF1bHQ7CiAgdmFyIGluaXRfZGVjb2RlSTNTID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9kZWNvZGVJM1MuanMiKCkgewogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgaW5pdF9kZWZhdWx0VmFsdWUoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfV2ViTWVyY2F0b3JQcm9qZWN0aW9uKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfQ2FydG9ncmFwaGljKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMygpOwogICAgICBpbml0X0NvbG9yKCk7CiAgICAgIGluaXRfTWF0cml4MygpOwogICAgICBpbml0X01hdGgoKTsKICAgICAgaW1wb3J0X2RyYWNvX2RlY29kZXJfbm9kZWpzMiA9IF9fdG9FU00ocmVxdWlyZV9kcmFjb19kZWNvZGVyX25vZGVqcygpLCAxKTsKICAgICAgaW5pdF9zcmdiVG9MaW5lYXIoKTsKICAgICAgY2FsY3VsYXRlRmFjZU5vcm1hbEEgPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIGNhbGN1bGF0ZUZhY2VOb3JtYWxCID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBjYWxjdWxhdGVGYWNlTm9ybWFsQyA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgaXNFZGdlU21vb3RoQSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgaXNFZGdlU21vb3RoQiA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgYmluYXJ5QXR0cmlidXRlRGVjb2RlcnMgPSB7CiAgICAgICAgcG9zaXRpb246IGZ1bmN0aW9uKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICBjb25zdCBjb3VudCA9IGRlY29kZWRHZW9tZXRyeS52ZXJ0ZXhDb3VudCAqIDM7CiAgICAgICAgICBkZWNvZGVkR2VvbWV0cnkucG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShkYXRhLCBvZmZzZXQsIGNvdW50KTsKICAgICAgICAgIG9mZnNldCArPSBjb3VudCAqIDQ7CiAgICAgICAgICByZXR1cm4gb2Zmc2V0OwogICAgICAgIH0sCiAgICAgICAgbm9ybWFsOiBmdW5jdGlvbihkZWNvZGVkR2VvbWV0cnksIGRhdGEsIG9mZnNldCkgewogICAgICAgICAgY29uc3QgY291bnQgPSBkZWNvZGVkR2VvbWV0cnkudmVydGV4Q291bnQgKiAzOwogICAgICAgICAgZGVjb2RlZEdlb21ldHJ5Lm5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KGRhdGEsIG9mZnNldCwgY291bnQpOwogICAgICAgICAgb2Zmc2V0ICs9IGNvdW50ICogNDsKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfSwKICAgICAgICB1djA6IGZ1bmN0aW9uKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICBjb25zdCBjb3VudCA9IGRlY29kZWRHZW9tZXRyeS52ZXJ0ZXhDb3VudCAqIDI7CiAgICAgICAgICBkZWNvZGVkR2VvbWV0cnkudXYwcyA9IG5ldyBGbG9hdDMyQXJyYXkoZGF0YSwgb2Zmc2V0LCBjb3VudCk7CiAgICAgICAgICBvZmZzZXQgKz0gY291bnQgKiA0OwogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9LAogICAgICAgIGNvbG9yOiBmdW5jdGlvbihkZWNvZGVkR2VvbWV0cnksIGRhdGEsIG9mZnNldCkgewogICAgICAgICAgY29uc3QgY291bnQgPSBkZWNvZGVkR2VvbWV0cnkudmVydGV4Q291bnQgKiA0OwogICAgICAgICAgZGVjb2RlZEdlb21ldHJ5LmNvbG9ycyA9IG5ldyBVaW50OEFycmF5KGRhdGEsIG9mZnNldCwgY291bnQpOwogICAgICAgICAgb2Zmc2V0ICs9IGNvdW50OwogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9LAogICAgICAgIGZlYXR1cmVJZDogZnVuY3Rpb24oZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpIHsKICAgICAgICAgIGNvbnN0IGNvdW50ID0gZGVjb2RlZEdlb21ldHJ5LmZlYXR1cmVDb3VudDsKICAgICAgICAgIG9mZnNldCArPSBjb3VudCAqIDg7CiAgICAgICAgICByZXR1cm4gb2Zmc2V0OwogICAgICAgIH0sCiAgICAgICAgaWQ6IGZ1bmN0aW9uKGRlY29kZWRHZW9tZXRyeSwgZGF0YSwgb2Zmc2V0KSB7CiAgICAgICAgICBjb25zdCBjb3VudCA9IGRlY29kZWRHZW9tZXRyeS5mZWF0dXJlQ291bnQ7CiAgICAgICAgICBvZmZzZXQgKz0gY291bnQgKiA4OwogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9LAogICAgICAgIGZhY2VSYW5nZTogZnVuY3Rpb24oZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpIHsKICAgICAgICAgIGNvbnN0IGNvdW50ID0gZGVjb2RlZEdlb21ldHJ5LmZlYXR1cmVDb3VudCAqIDI7CiAgICAgICAgICBkZWNvZGVkR2VvbWV0cnkuZmFjZVJhbmdlID0gbmV3IFVpbnQzMkFycmF5KGRhdGEsIG9mZnNldCwgY291bnQpOwogICAgICAgICAgb2Zmc2V0ICs9IGNvdW50ICogNDsKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgICAgfSwKICAgICAgICB1dlJlZ2lvbjogZnVuY3Rpb24oZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpIHsKICAgICAgICAgIGNvbnN0IGNvdW50ID0gZGVjb2RlZEdlb21ldHJ5LnZlcnRleENvdW50ICogNDsKICAgICAgICAgIGRlY29kZWRHZW9tZXRyeVsidXYtcmVnaW9uIl0gPSBuZXcgVWludDE2QXJyYXkoZGF0YSwgb2Zmc2V0LCBjb3VudCk7CiAgICAgICAgICBvZmZzZXQgKz0gY291bnQgKiAyOwogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9LAogICAgICAgIHJlZ2lvbjogZnVuY3Rpb24oZGVjb2RlZEdlb21ldHJ5LCBkYXRhLCBvZmZzZXQpIHsKICAgICAgICAgIGNvbnN0IGNvdW50ID0gZGVjb2RlZEdlb21ldHJ5LnZlcnRleENvdW50ICogNDsKICAgICAgICAgIGRlY29kZWRHZW9tZXRyeVsidXYtcmVnaW9uIl0gPSBuZXcgVWludDE2QXJyYXkoZGF0YSwgb2Zmc2V0LCBjb3VudCk7CiAgICAgICAgICBvZmZzZXQgKz0gY291bnQgKiAyOwogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGRlY29kZUkzU19kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KGRlY29kZUkzUyk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvUmVuZGVyZXIvUGl4ZWxEYXRhdHlwZS5qcwogIHZhciBQaXhlbERhdGF0eXBlLCBQaXhlbERhdGF0eXBlX2RlZmF1bHQ7CiAgdmFyIGluaXRfUGl4ZWxEYXRhdHlwZSA9IF9fZXNtKHsKICAgICJwYWNrYWdlcy9lbmdpbmUvU291cmNlL1JlbmRlcmVyL1BpeGVsRGF0YXR5cGUuanMiKCkgewogICAgICBpbml0X1dlYkdMQ29uc3RhbnRzKCk7CiAgICAgIFBpeGVsRGF0YXR5cGUgPSB7CiAgICAgICAgVU5TSUdORURfQllURTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9CWVRFLAogICAgICAgIFVOU0lHTkVEX1NIT1JUOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX1NIT1JULAogICAgICAgIFVOU0lHTkVEX0lOVDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9JTlQsCiAgICAgICAgRkxPQVQ6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuRkxPQVQsCiAgICAgICAgSEFMRl9GTE9BVDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5IQUxGX0ZMT0FUX09FUywKICAgICAgICBVTlNJR05FRF9JTlRfMjRfODogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9JTlRfMjRfOCwKICAgICAgICBVTlNJR05FRF9TSE9SVF80XzRfNF80OiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX1NIT1JUXzRfNF80XzQsCiAgICAgICAgVU5TSUdORURfU0hPUlRfNV81XzVfMTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVF81XzVfNV8xLAogICAgICAgIFVOU0lHTkVEX1NIT1JUXzVfNl81OiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX1NIT1JUXzVfNl81CiAgICAgIH07CiAgICAgIFBpeGVsRGF0YXR5cGUudG9XZWJHTENvbnN0YW50ID0gZnVuY3Rpb24ocGl4ZWxEYXRhdHlwZSwgY29udGV4dCkgewogICAgICAgIHN3aXRjaCAocGl4ZWxEYXRhdHlwZSkgewogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0JZVEU6CiAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX0JZVEU7CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlQ6CiAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX1NIT1JUOwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0lOVDoKICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuVU5TSUdORURfSU5UOwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLkZMT0FUOgogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5GTE9BVDsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5IQUxGX0ZMT0FUOgogICAgICAgICAgICByZXR1cm4gY29udGV4dC53ZWJnbDIgPyBXZWJHTENvbnN0YW50c19kZWZhdWx0LkhBTEZfRkxPQVQgOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkhBTEZfRkxPQVRfT0VTOwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0lOVF8yNF84OgogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9JTlRfMjRfODsKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF80XzRfNF80OgogICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5VTlNJR05FRF9TSE9SVF80XzRfNF80OwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzVfNV81XzE6CiAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlVOU0lHTkVEX1NIT1JUXzVfNV81XzE7CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNV82XzU6CiAgICAgICAgICAgIHJldHVybiBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzVfNl81OwogICAgICAgIH0KICAgICAgfTsKICAgICAgUGl4ZWxEYXRhdHlwZS5pc1BhY2tlZCA9IGZ1bmN0aW9uKHBpeGVsRGF0YXR5cGUpIHsKICAgICAgICByZXR1cm4gcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlRfMjRfOCB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzRfNF80XzQgfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF81XzVfNV8xIHx8IHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNV82XzU7CiAgICAgIH07CiAgICAgIFBpeGVsRGF0YXR5cGUuc2l6ZUluQnl0ZXMgPSBmdW5jdGlvbihwaXhlbERhdGF0eXBlKSB7CiAgICAgICAgc3dpdGNoIChwaXhlbERhdGF0eXBlKSB7CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfQllURToKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlQ6CiAgICAgICAgICBjYXNlIFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNF80XzRfNDoKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF81XzVfNV8xOgogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzVfNl81OgogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLkhBTEZfRkxPQVQ6CiAgICAgICAgICAgIHJldHVybiAyOwogICAgICAgICAgY2FzZSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0lOVDoKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5GTE9BVDoKICAgICAgICAgIGNhc2UgUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9JTlRfMjRfODoKICAgICAgICAgICAgcmV0dXJuIDQ7CiAgICAgICAgfQogICAgICB9OwogICAgICBQaXhlbERhdGF0eXBlLnZhbGlkYXRlID0gZnVuY3Rpb24ocGl4ZWxEYXRhdHlwZSkgewogICAgICAgIHJldHVybiBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0JZVEUgfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVCB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0lOVCB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLkZMT0FUIHx8IHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuSEFMRl9GTE9BVCB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0lOVF8yNF84IHx8IHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGUuVU5TSUdORURfU0hPUlRfNF80XzRfNCB8fCBwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUXzVfNV81XzEgfHwgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZS5VTlNJR05FRF9TSE9SVF81XzZfNTsKICAgICAgfTsKICAgICAgUGl4ZWxEYXRhdHlwZV9kZWZhdWx0ID0gT2JqZWN0LmZyZWV6ZShQaXhlbERhdGF0eXBlKTsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Db3JlL1BpeGVsRm9ybWF0LmpzCiAgdmFyIFBpeGVsRm9ybWF0LCBQaXhlbEZvcm1hdF9kZWZhdWx0OwogIHZhciBpbml0X1BpeGVsRm9ybWF0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9QaXhlbEZvcm1hdC5qcyIoKSB7CiAgICAgIGluaXRfUGl4ZWxEYXRhdHlwZSgpOwogICAgICBpbml0X1dlYkdMQ29uc3RhbnRzKCk7CiAgICAgIFBpeGVsRm9ybWF0ID0gewogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgYSBkZXB0aCB2YWx1ZS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgREVQVEhfQ09NUE9ORU5UOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkRFUFRIX0NPTVBPTkVOVCwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIGEgZGVwdGggYW5kIHN0ZW5jaWwgdmFsdWUsIG1vc3Qgb2Z0ZW4gdXNlZCB3aXRoIHtAbGluayBQaXhlbERhdGF0eXBlLlVOU0lHTkVEX0lOVF8yNF84fS4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgREVQVEhfU1RFTkNJTDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5ERVBUSF9TVEVOQ0lMLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgYW4gYWxwaGEgY2hhbm5lbC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgQUxQSEE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQUxQSEEsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyBhIHJlZCBjaGFubmVsCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJFRDogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SRUQsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQgYW5kIGdyZWVuIGNoYW5uZWxzLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSRzogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SRywKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGFuZCBibHVlIGNoYW5uZWxzLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0I6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUkdCLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYmx1ZSwgYW5kIGFscGhhIGNoYW5uZWxzLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JBOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlJHQkEsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyBhIGx1bWluYW5jZSAoaW50ZW5zaXR5KSBjaGFubmVsLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBMVU1JTkFOQ0U6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuTFVNSU5BTkNFLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgbHVtaW5hbmNlIChpbnRlbnNpdHkpIGFuZCBhbHBoYSBjaGFubmVscy4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgTFVNSU5BTkNFX0FMUEhBOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkxVTUlOQU5DRV9BTFBIQSwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGFuZCBibHVlIGNoYW5uZWxzIHRoYXQgaXMgRFhUMSBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JfRFhUMTogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DT01QUkVTU0VEX1JHQl9TM1RDX0RYVDFfRVhULAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYmx1ZSwgYW5kIGFscGhhIGNoYW5uZWxzIHRoYXQgaXMgRFhUMSBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JBX0RYVDE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUMV9FWFQsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBibHVlLCBhbmQgYWxwaGEgY2hhbm5lbHMgdGhhdCBpcyBEWFQzIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkFfRFhUMzogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQzX0VYVCwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGJsdWUsIGFuZCBhbHBoYSBjaGFubmVscyB0aGF0IGlzIERYVDUgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCQV9EWFQ1OiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDVfRVhULAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYW5kIGJsdWUgY2hhbm5lbHMgdGhhdCBpcyBQVlIgNGJwcCBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0JfUFZSVENfNEJQUFYxOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCX1BWUlRDXzRCUFBWMV9JTUcsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBhbmQgYmx1ZSBjaGFubmVscyB0aGF0IGlzIFBWUiAyYnBwIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQl9QVlJUQ18yQlBQVjE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JfUFZSVENfMkJQUFYxX0lNRywKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGJsdWUsIGFuZCBhbHBoYSBjaGFubmVscyB0aGF0IGlzIFBWUiA0YnBwIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkFfUFZSVENfNEJQUFYxOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCQV9QVlJUQ180QlBQVjFfSU1HLAogICAgICAgIC8qKgogICAgICAgICAqIEEgcGl4ZWwgZm9ybWF0IGNvbnRhaW5pbmcgcmVkLCBncmVlbiwgYmx1ZSwgYW5kIGFscGhhIGNoYW5uZWxzIHRoYXQgaXMgUFZSIDJicHAgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCQV9QVlJUQ18yQlBQVjE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JBX1BWUlRDXzJCUFBWMV9JTUcsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBibHVlLCBhbmQgYWxwaGEgY2hhbm5lbHMgdGhhdCBpcyBBU1RDIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkFfQVNUQzogV2ViR0xDb25zdGFudHNfZGVmYXVsdC5DT01QUkVTU0VEX1JHQkFfQVNUQ180eDRfV0VCR0wsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBhbmQgYmx1ZSBjaGFubmVscyB0aGF0IGlzIEVUQzEgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCX0VUQzE6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JfRVRDMV9XRUJHTCwKICAgICAgICAvKioKICAgICAgICAgKiBBIHBpeGVsIGZvcm1hdCBjb250YWluaW5nIHJlZCwgZ3JlZW4sIGFuZCBibHVlIGNoYW5uZWxzIHRoYXQgaXMgRVRDMiBjb21wcmVzc2VkLgogICAgICAgICAqCiAgICAgICAgICogQHR5cGUge251bWJlcn0KICAgICAgICAgKiBAY29uc3RhbnQKICAgICAgICAgKi8KICAgICAgICBSR0I4X0VUQzI6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0I4X0VUQzIsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBibHVlLCBhbmQgYWxwaGEgY2hhbm5lbHMgdGhhdCBpcyBFVEMyIGNvbXByZXNzZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAdHlwZSB7bnVtYmVyfQogICAgICAgICAqIEBjb25zdGFudAogICAgICAgICAqLwogICAgICAgIFJHQkE4X0VUQzJfRUFDOiBXZWJHTENvbnN0YW50c19kZWZhdWx0LkNPTVBSRVNTRURfUkdCQThfRVRDMl9FQUMsCiAgICAgICAgLyoqCiAgICAgICAgICogQSBwaXhlbCBmb3JtYXQgY29udGFpbmluZyByZWQsIGdyZWVuLCBibHVlLCBhbmQgYWxwaGEgY2hhbm5lbHMgdGhhdCBpcyBCQzcgY29tcHJlc3NlZC4KICAgICAgICAgKgogICAgICAgICAqIEB0eXBlIHtudW1iZXJ9CiAgICAgICAgICogQGNvbnN0YW50CiAgICAgICAgICovCiAgICAgICAgUkdCQV9CQzc6IFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuQ09NUFJFU1NFRF9SR0JBX0JQVENfVU5PUk0KICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuY29tcG9uZW50c0xlbmd0aCA9IGZ1bmN0aW9uKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgc3dpdGNoIChwaXhlbEZvcm1hdCkgewogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0I6CiAgICAgICAgICAgIHJldHVybiAzOwogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBOgogICAgICAgICAgICByZXR1cm4gNDsKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuTFVNSU5BTkNFX0FMUEhBOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SRzoKICAgICAgICAgICAgcmV0dXJuIDI7CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LkFMUEhBOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SRUQ6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LkxVTUlOQU5DRToKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LnZhbGlkYXRlID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LkRFUFRIX0NPTVBPTkVOVCB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuREVQVEhfU1RFTkNJTCB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuQUxQSEEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJFRCB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkcgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQiB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuTFVNSU5BTkNFIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5MVU1JTkFOQ0VfQUxQSEEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9EWFQxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0RYVDEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfRFhUMyB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9EWFQ1IHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfUFZSVENfNEJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfUFZSVENfMkJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX1BWUlRDXzRCUFBWMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9QVlJUQ18yQlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfQVNUQyB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCX0VUQzEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQjhfRVRDMiB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQThfRVRDMl9FQUMgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfQkM3OwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5pc0NvbG9yRm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJFRCB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuQUxQSEEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQiB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuTFVNSU5BTkNFIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5MVU1JTkFOQ0VfQUxQSEE7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmlzRGVwdGhGb3JtYXQgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCkgewogICAgICAgIHJldHVybiBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuREVQVEhfQ09NUE9ORU5UIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5ERVBUSF9TVEVOQ0lMOwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5pc0NvbXByZXNzZWRGb3JtYXQgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCkgewogICAgICAgIHJldHVybiBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCX0RYVDEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfRFhUMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9EWFQzIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0RYVDUgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9QVlJUQ180QlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9QVlJUQ18yQlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfUFZSVENfNEJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX1BWUlRDXzJCUFBWMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9BU1RDIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JfRVRDMSB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCOF9FVEMyIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBOF9FVEMyX0VBQyB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9CQzc7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmlzRFhURm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9EWFQxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX0RYVDEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfRFhUMyB8fCBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9EWFQ1OwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5pc1BWUlRDRm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9QVlJUQ180QlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9QVlJUQ18yQlBQVjEgfHwgcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfUFZSVENfNEJQUFYxIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBX1BWUlRDXzJCUFBWMTsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuaXNBU1RDRm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQkFfQVNUQzsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuaXNFVEMxRm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQpIHsKICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQgPT09IFBpeGVsRm9ybWF0LlJHQl9FVEMxOwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5pc0VUQzJGb3JtYXQgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCkgewogICAgICAgIHJldHVybiBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCOF9FVEMyIHx8IHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5SR0JBOF9FVEMyX0VBQzsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuaXNCQzdGb3JtYXQgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCkgewogICAgICAgIHJldHVybiBwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuUkdCQV9CQzc7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmNvbXByZXNzZWRUZXh0dXJlU2l6ZUluQnl0ZXMgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCwgd2lkdGgsIGhlaWdodCkgewogICAgICAgIHN3aXRjaCAocGl4ZWxGb3JtYXQpIHsKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCX0RYVDE6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkFfRFhUMToKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCX0VUQzE6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQjhfRVRDMjoKICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoKHdpZHRoICsgMykgLyA0KSAqIE1hdGguZmxvb3IoKGhlaWdodCArIDMpIC8gNCkgKiA4OwogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBX0RYVDM6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkFfRFhUNToKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCQV9BU1RDOgogICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBOF9FVEMyX0VBQzoKICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoKHdpZHRoICsgMykgLyA0KSAqIE1hdGguZmxvb3IoKGhlaWdodCArIDMpIC8gNCkgKiAxNjsKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCX1BWUlRDXzRCUFBWMToKICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCQV9QVlJUQ180QlBQVjE6CiAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKChNYXRoLm1heCh3aWR0aCwgOCkgKiBNYXRoLm1heChoZWlnaHQsIDgpICogNCArIDcpIC8gOCk7CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQl9QVlJUQ18yQlBQVjE6CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkFfUFZSVENfMkJQUFYxOgogICAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcigKICAgICAgICAgICAgICAoTWF0aC5tYXgod2lkdGgsIDE2KSAqIE1hdGgubWF4KGhlaWdodCwgOCkgKiAyICsgNykgLyA4CiAgICAgICAgICAgICk7CiAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQkFfQkM3OgogICAgICAgICAgICByZXR1cm4gTWF0aC5jZWlsKHdpZHRoIC8gNCkgKiBNYXRoLmNlaWwoaGVpZ2h0IC8gNCkgKiAxNjsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQudGV4dHVyZVNpemVJbkJ5dGVzID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQsIHBpeGVsRGF0YXR5cGUsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICBsZXQgY29tcG9uZW50c0xlbmd0aCA9IFBpeGVsRm9ybWF0LmNvbXBvbmVudHNMZW5ndGgocGl4ZWxGb3JtYXQpOwogICAgICAgIGlmIChQaXhlbERhdGF0eXBlX2RlZmF1bHQuaXNQYWNrZWQocGl4ZWxEYXRhdHlwZSkpIHsKICAgICAgICAgIGNvbXBvbmVudHNMZW5ndGggPSAxOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29tcG9uZW50c0xlbmd0aCAqIFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5zaXplSW5CeXRlcyhwaXhlbERhdGF0eXBlKSAqIHdpZHRoICogaGVpZ2h0OwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC5hbGlnbm1lbnRJbkJ5dGVzID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQsIHBpeGVsRGF0YXR5cGUsIHdpZHRoKSB7CiAgICAgICAgY29uc3QgbW9kID0gUGl4ZWxGb3JtYXQudGV4dHVyZVNpemVJbkJ5dGVzKHBpeGVsRm9ybWF0LCBwaXhlbERhdGF0eXBlLCB3aWR0aCwgMSkgJSA0OwogICAgICAgIHJldHVybiBtb2QgPT09IDAgPyA0IDogbW9kID09PSAyID8gMiA6IDE7CiAgICAgIH07CiAgICAgIFBpeGVsRm9ybWF0LmNyZWF0ZVR5cGVkQXJyYXkgPSBmdW5jdGlvbihwaXhlbEZvcm1hdCwgcGl4ZWxEYXRhdHlwZSwgd2lkdGgsIGhlaWdodCkgewogICAgICAgIGxldCBjb25zdHJ1Y3RvcjsKICAgICAgICBjb25zdCBzaXplSW5CeXRlcyA9IFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5zaXplSW5CeXRlcyhwaXhlbERhdGF0eXBlKTsKICAgICAgICBpZiAoc2l6ZUluQnl0ZXMgPT09IFVpbnQ4QXJyYXkuQllURVNfUEVSX0VMRU1FTlQpIHsKICAgICAgICAgIGNvbnN0cnVjdG9yID0gVWludDhBcnJheTsKICAgICAgICB9IGVsc2UgaWYgKHNpemVJbkJ5dGVzID09PSBVaW50MTZBcnJheS5CWVRFU19QRVJfRUxFTUVOVCkgewogICAgICAgICAgY29uc3RydWN0b3IgPSBVaW50MTZBcnJheTsKICAgICAgICB9IGVsc2UgaWYgKHNpemVJbkJ5dGVzID09PSBGbG9hdDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQgJiYgcGl4ZWxEYXRhdHlwZSA9PT0gUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LkZMT0FUKSB7CiAgICAgICAgICBjb25zdHJ1Y3RvciA9IEZsb2F0MzJBcnJheTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3RydWN0b3IgPSBVaW50MzJBcnJheTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2l6ZSA9IFBpeGVsRm9ybWF0LmNvbXBvbmVudHNMZW5ndGgocGl4ZWxGb3JtYXQpICogd2lkdGggKiBoZWlnaHQ7CiAgICAgICAgcmV0dXJuIG5ldyBjb25zdHJ1Y3RvcihzaXplKTsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXQuZmxpcFkgPSBmdW5jdGlvbihidWZmZXJWaWV3LCBwaXhlbEZvcm1hdCwgcGl4ZWxEYXRhdHlwZSwgd2lkdGgsIGhlaWdodCkgewogICAgICAgIGlmIChoZWlnaHQgPT09IDEpIHsKICAgICAgICAgIHJldHVybiBidWZmZXJWaWV3OwogICAgICAgIH0KICAgICAgICBjb25zdCBmbGlwcGVkID0gUGl4ZWxGb3JtYXQuY3JlYXRlVHlwZWRBcnJheSgKICAgICAgICAgIHBpeGVsRm9ybWF0LAogICAgICAgICAgcGl4ZWxEYXRhdHlwZSwKICAgICAgICAgIHdpZHRoLAogICAgICAgICAgaGVpZ2h0CiAgICAgICAgKTsKICAgICAgICBjb25zdCBudW1iZXJPZkNvbXBvbmVudHMgPSBQaXhlbEZvcm1hdC5jb21wb25lbnRzTGVuZ3RoKHBpeGVsRm9ybWF0KTsKICAgICAgICBjb25zdCB0ZXh0dXJlV2lkdGggPSB3aWR0aCAqIG51bWJlck9mQ29tcG9uZW50czsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhlaWdodDsgKytpKSB7CiAgICAgICAgICBjb25zdCByb3cgPSBpICogd2lkdGggKiBudW1iZXJPZkNvbXBvbmVudHM7CiAgICAgICAgICBjb25zdCBmbGlwcGVkUm93ID0gKGhlaWdodCAtIGkgLSAxKSAqIHdpZHRoICogbnVtYmVyT2ZDb21wb25lbnRzOwogICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB0ZXh0dXJlV2lkdGg7ICsraikgewogICAgICAgICAgICBmbGlwcGVkW2ZsaXBwZWRSb3cgKyBqXSA9IGJ1ZmZlclZpZXdbcm93ICsgal07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmbGlwcGVkOwogICAgICB9OwogICAgICBQaXhlbEZvcm1hdC50b0ludGVybmFsRm9ybWF0ID0gZnVuY3Rpb24ocGl4ZWxGb3JtYXQsIHBpeGVsRGF0YXR5cGUsIGNvbnRleHQpIHsKICAgICAgICBpZiAoIWNvbnRleHQud2ViZ2wyKSB7CiAgICAgICAgICByZXR1cm4gcGl4ZWxGb3JtYXQ7CiAgICAgICAgfQogICAgICAgIGlmIChwaXhlbEZvcm1hdCA9PT0gUGl4ZWxGb3JtYXQuREVQVEhfU1RFTkNJTCkgewogICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuREVQVEgyNF9TVEVOQ0lMODsKICAgICAgICB9CiAgICAgICAgaWYgKHBpeGVsRm9ybWF0ID09PSBQaXhlbEZvcm1hdC5ERVBUSF9DT01QT05FTlQpIHsKICAgICAgICAgIGlmIChwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlX2RlZmF1bHQuVU5TSUdORURfU0hPUlQpIHsKICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuREVQVEhfQ09NUE9ORU5UMTY7CiAgICAgICAgICB9IGVsc2UgaWYgKHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5VTlNJR05FRF9JTlQpIHsKICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuREVQVEhfQ09NUE9ORU5UMjQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwaXhlbERhdGF0eXBlID09PSBQaXhlbERhdGF0eXBlX2RlZmF1bHQuRkxPQVQpIHsKICAgICAgICAgIHN3aXRjaCAocGl4ZWxGb3JtYXQpIHsKICAgICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SR0JBOgogICAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlJHQkEzMkY7CiAgICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCOgogICAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlJHQjMyRjsKICAgICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SRzoKICAgICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SRzMyRjsKICAgICAgICAgICAgY2FzZSBQaXhlbEZvcm1hdC5SRUQ6CiAgICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUjMyRjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHBpeGVsRGF0YXR5cGUgPT09IFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5IQUxGX0ZMT0FUKSB7CiAgICAgICAgICBzd2l0Y2ggKHBpeGVsRm9ybWF0KSB7CiAgICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkdCQToKICAgICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SR0JBMTZGOwogICAgICAgICAgICBjYXNlIFBpeGVsRm9ybWF0LlJHQjoKICAgICAgICAgICAgICByZXR1cm4gV2ViR0xDb25zdGFudHNfZGVmYXVsdC5SR0IxNkY7CiAgICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkc6CiAgICAgICAgICAgICAgcmV0dXJuIFdlYkdMQ29uc3RhbnRzX2RlZmF1bHQuUkcxNkY7CiAgICAgICAgICAgIGNhc2UgUGl4ZWxGb3JtYXQuUkVEOgogICAgICAgICAgICAgIHJldHVybiBXZWJHTENvbnN0YW50c19kZWZhdWx0LlIxNkY7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBwaXhlbEZvcm1hdDsKICAgICAgfTsKICAgICAgUGl4ZWxGb3JtYXRfZGVmYXVsdCA9IE9iamVjdC5mcmVlemUoUGl4ZWxGb3JtYXQpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvVnVsa2FuQ29uc3RhbnRzLmpzCiAgdmFyIFZ1bGthbkNvbnN0YW50cywgVnVsa2FuQ29uc3RhbnRzX2RlZmF1bHQ7CiAgdmFyIGluaXRfVnVsa2FuQ29uc3RhbnRzID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9WdWxrYW5Db25zdGFudHMuanMiKCkgewogICAgICBWdWxrYW5Db25zdGFudHMgPSB7CiAgICAgICAgVktfRk9STUFUX1VOREVGSU5FRDogMCwKICAgICAgICBWS19GT1JNQVRfUjRHNF9VTk9STV9QQUNLODogMSwKICAgICAgICBWS19GT1JNQVRfUjRHNEI0QTRfVU5PUk1fUEFDSzE2OiAyLAogICAgICAgIFZLX0ZPUk1BVF9CNEc0UjRBNF9VTk9STV9QQUNLMTY6IDMsCiAgICAgICAgVktfRk9STUFUX1I1RzZCNV9VTk9STV9QQUNLMTY6IDQsCiAgICAgICAgVktfRk9STUFUX0I1RzZSNV9VTk9STV9QQUNLMTY6IDUsCiAgICAgICAgVktfRk9STUFUX1I1RzVCNUExX1VOT1JNX1BBQ0sxNjogNiwKICAgICAgICBWS19GT1JNQVRfQjVHNVI1QTFfVU5PUk1fUEFDSzE2OiA3LAogICAgICAgIFZLX0ZPUk1BVF9BMVI1RzVCNV9VTk9STV9QQUNLMTY6IDgsCiAgICAgICAgVktfRk9STUFUX1I4X1VOT1JNOiA5LAogICAgICAgIFZLX0ZPUk1BVF9SOF9TTk9STTogMTAsCiAgICAgICAgVktfRk9STUFUX1I4X1VTQ0FMRUQ6IDExLAogICAgICAgIFZLX0ZPUk1BVF9SOF9TU0NBTEVEOiAxMiwKICAgICAgICBWS19GT1JNQVRfUjhfVUlOVDogMTMsCiAgICAgICAgVktfRk9STUFUX1I4X1NJTlQ6IDE0LAogICAgICAgIFZLX0ZPUk1BVF9SOF9TUkdCOiAxNSwKICAgICAgICBWS19GT1JNQVRfUjhHOF9VTk9STTogMTYsCiAgICAgICAgVktfRk9STUFUX1I4RzhfU05PUk06IDE3LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4X1VTQ0FMRUQ6IDE4LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4X1NTQ0FMRUQ6IDE5LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4X1VJTlQ6IDIwLAogICAgICAgIFZLX0ZPUk1BVF9SOEc4X1NJTlQ6IDIxLAogICAgICAgIFZLX0ZPUk1BVF9SOEc4X1NSR0I6IDIyLAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhfVU5PUk06IDIzLAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhfU05PUk06IDI0LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhfVVNDQUxFRDogMjUsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOF9TU0NBTEVEOiAyNiwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4X1VJTlQ6IDI3LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhfU0lOVDogMjgsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOF9TUkdCOiAyOSwKICAgICAgICBWS19GT1JNQVRfQjhHOFI4X1VOT1JNOiAzMCwKICAgICAgICBWS19GT1JNQVRfQjhHOFI4X1NOT1JNOiAzMSwKICAgICAgICBWS19GT1JNQVRfQjhHOFI4X1VTQ0FMRUQ6IDMyLAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhfU1NDQUxFRDogMzMsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOF9VSU5UOiAzNCwKICAgICAgICBWS19GT1JNQVRfQjhHOFI4X1NJTlQ6IDM1LAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhfU1JHQjogMzYsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOEE4X1VOT1JNOiAzNywKICAgICAgICBWS19GT1JNQVRfUjhHOEI4QThfU05PUk06IDM4LAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhBOF9VU0NBTEVEOiAzOSwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4QThfU1NDQUxFRDogNDAsCiAgICAgICAgVktfRk9STUFUX1I4RzhCOEE4X1VJTlQ6IDQxLAogICAgICAgIFZLX0ZPUk1BVF9SOEc4QjhBOF9TSU5UOiA0MiwKICAgICAgICBWS19GT1JNQVRfUjhHOEI4QThfU1JHQjogNDMsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOEE4X1VOT1JNOiA0NCwKICAgICAgICBWS19GT1JNQVRfQjhHOFI4QThfU05PUk06IDQ1LAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhBOF9VU0NBTEVEOiA0NiwKICAgICAgICBWS19GT1JNQVRfQjhHOFI4QThfU1NDQUxFRDogNDcsCiAgICAgICAgVktfRk9STUFUX0I4RzhSOEE4X1VJTlQ6IDQ4LAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhBOF9TSU5UOiA0OSwKICAgICAgICBWS19GT1JNQVRfQjhHOFI4QThfU1JHQjogNTAsCiAgICAgICAgVktfRk9STUFUX0E4QjhHOFI4X1VOT1JNX1BBQ0szMjogNTEsCiAgICAgICAgVktfRk9STUFUX0E4QjhHOFI4X1NOT1JNX1BBQ0szMjogNTIsCiAgICAgICAgVktfRk9STUFUX0E4QjhHOFI4X1VTQ0FMRURfUEFDSzMyOiA1MywKICAgICAgICBWS19GT1JNQVRfQThCOEc4UjhfU1NDQUxFRF9QQUNLMzI6IDU0LAogICAgICAgIFZLX0ZPUk1BVF9BOEI4RzhSOF9VSU5UX1BBQ0szMjogNTUsCiAgICAgICAgVktfRk9STUFUX0E4QjhHOFI4X1NJTlRfUEFDSzMyOiA1NiwKICAgICAgICBWS19GT1JNQVRfQThCOEc4UjhfU1JHQl9QQUNLMzI6IDU3LAogICAgICAgIFZLX0ZPUk1BVF9BMlIxMEcxMEIxMF9VTk9STV9QQUNLMzI6IDU4LAogICAgICAgIFZLX0ZPUk1BVF9BMlIxMEcxMEIxMF9TTk9STV9QQUNLMzI6IDU5LAogICAgICAgIFZLX0ZPUk1BVF9BMlIxMEcxMEIxMF9VU0NBTEVEX1BBQ0szMjogNjAsCiAgICAgICAgVktfRk9STUFUX0EyUjEwRzEwQjEwX1NTQ0FMRURfUEFDSzMyOiA2MSwKICAgICAgICBWS19GT1JNQVRfQTJSMTBHMTBCMTBfVUlOVF9QQUNLMzI6IDYyLAogICAgICAgIFZLX0ZPUk1BVF9BMlIxMEcxMEIxMF9TSU5UX1BBQ0szMjogNjMsCiAgICAgICAgVktfRk9STUFUX0EyQjEwRzEwUjEwX1VOT1JNX1BBQ0szMjogNjQsCiAgICAgICAgVktfRk9STUFUX0EyQjEwRzEwUjEwX1NOT1JNX1BBQ0szMjogNjUsCiAgICAgICAgVktfRk9STUFUX0EyQjEwRzEwUjEwX1VTQ0FMRURfUEFDSzMyOiA2NiwKICAgICAgICBWS19GT1JNQVRfQTJCMTBHMTBSMTBfU1NDQUxFRF9QQUNLMzI6IDY3LAogICAgICAgIFZLX0ZPUk1BVF9BMkIxMEcxMFIxMF9VSU5UX1BBQ0szMjogNjgsCiAgICAgICAgVktfRk9STUFUX0EyQjEwRzEwUjEwX1NJTlRfUEFDSzMyOiA2OSwKICAgICAgICBWS19GT1JNQVRfUjE2X1VOT1JNOiA3MCwKICAgICAgICBWS19GT1JNQVRfUjE2X1NOT1JNOiA3MSwKICAgICAgICBWS19GT1JNQVRfUjE2X1VTQ0FMRUQ6IDcyLAogICAgICAgIFZLX0ZPUk1BVF9SMTZfU1NDQUxFRDogNzMsCiAgICAgICAgVktfRk9STUFUX1IxNl9VSU5UOiA3NCwKICAgICAgICBWS19GT1JNQVRfUjE2X1NJTlQ6IDc1LAogICAgICAgIFZLX0ZPUk1BVF9SMTZfU0ZMT0FUOiA3NiwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2X1VOT1JNOiA3NywKICAgICAgICBWS19GT1JNQVRfUjE2RzE2X1NOT1JNOiA3OCwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2X1VTQ0FMRUQ6IDc5LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZfU1NDQUxFRDogODAsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNl9VSU5UOiA4MSwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2X1NJTlQ6IDgyLAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZfU0ZMT0FUOiA4MywKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2X1VOT1JNOiA4NCwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2X1NOT1JNOiA4NSwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2X1VTQ0FMRUQ6IDg2LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZfU1NDQUxFRDogODcsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNl9VSU5UOiA4OCwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2X1NJTlQ6IDg5LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZfU0ZMT0FUOiA5MCwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2QTE2X1VOT1JNOiA5MSwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2QTE2X1NOT1JNOiA5MiwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2QTE2X1VTQ0FMRUQ6IDkzLAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZBMTZfU1NDQUxFRDogOTQsCiAgICAgICAgVktfRk9STUFUX1IxNkcxNkIxNkExNl9VSU5UOiA5NSwKICAgICAgICBWS19GT1JNQVRfUjE2RzE2QjE2QTE2X1NJTlQ6IDk2LAogICAgICAgIFZLX0ZPUk1BVF9SMTZHMTZCMTZBMTZfU0ZMT0FUOiA5NywKICAgICAgICBWS19GT1JNQVRfUjMyX1VJTlQ6IDk4LAogICAgICAgIFZLX0ZPUk1BVF9SMzJfU0lOVDogOTksCiAgICAgICAgVktfRk9STUFUX1IzMl9TRkxPQVQ6IDEwMCwKICAgICAgICBWS19GT1JNQVRfUjMyRzMyX1VJTlQ6IDEwMSwKICAgICAgICBWS19GT1JNQVRfUjMyRzMyX1NJTlQ6IDEwMiwKICAgICAgICBWS19GT1JNQVRfUjMyRzMyX1NGTE9BVDogMTAzLAogICAgICAgIFZLX0ZPUk1BVF9SMzJHMzJCMzJfVUlOVDogMTA0LAogICAgICAgIFZLX0ZPUk1BVF9SMzJHMzJCMzJfU0lOVDogMTA1LAogICAgICAgIFZLX0ZPUk1BVF9SMzJHMzJCMzJfU0ZMT0FUOiAxMDYsCiAgICAgICAgVktfRk9STUFUX1IzMkczMkIzMkEzMl9VSU5UOiAxMDcsCiAgICAgICAgVktfRk9STUFUX1IzMkczMkIzMkEzMl9TSU5UOiAxMDgsCiAgICAgICAgVktfRk9STUFUX1IzMkczMkIzMkEzMl9TRkxPQVQ6IDEwOSwKICAgICAgICBWS19GT1JNQVRfUjY0X1VJTlQ6IDExMCwKICAgICAgICBWS19GT1JNQVRfUjY0X1NJTlQ6IDExMSwKICAgICAgICBWS19GT1JNQVRfUjY0X1NGTE9BVDogMTEyLAogICAgICAgIFZLX0ZPUk1BVF9SNjRHNjRfVUlOVDogMTEzLAogICAgICAgIFZLX0ZPUk1BVF9SNjRHNjRfU0lOVDogMTE0LAogICAgICAgIFZLX0ZPUk1BVF9SNjRHNjRfU0ZMT0FUOiAxMTUsCiAgICAgICAgVktfRk9STUFUX1I2NEc2NEI2NF9VSU5UOiAxMTYsCiAgICAgICAgVktfRk9STUFUX1I2NEc2NEI2NF9TSU5UOiAxMTcsCiAgICAgICAgVktfRk9STUFUX1I2NEc2NEI2NF9TRkxPQVQ6IDExOCwKICAgICAgICBWS19GT1JNQVRfUjY0RzY0QjY0QTY0X1VJTlQ6IDExOSwKICAgICAgICBWS19GT1JNQVRfUjY0RzY0QjY0QTY0X1NJTlQ6IDEyMCwKICAgICAgICBWS19GT1JNQVRfUjY0RzY0QjY0QTY0X1NGTE9BVDogMTIxLAogICAgICAgIFZLX0ZPUk1BVF9CMTBHMTFSMTFfVUZMT0FUX1BBQ0szMjogMTIyLAogICAgICAgIFZLX0ZPUk1BVF9FNUI5RzlSOV9VRkxPQVRfUEFDSzMyOiAxMjMsCiAgICAgICAgVktfRk9STUFUX0QxNl9VTk9STTogMTI0LAogICAgICAgIFZLX0ZPUk1BVF9YOF9EMjRfVU5PUk1fUEFDSzMyOiAxMjUsCiAgICAgICAgVktfRk9STUFUX0QzMl9TRkxPQVQ6IDEyNiwKICAgICAgICBWS19GT1JNQVRfUzhfVUlOVDogMTI3LAogICAgICAgIFZLX0ZPUk1BVF9EMTZfVU5PUk1fUzhfVUlOVDogMTI4LAogICAgICAgIFZLX0ZPUk1BVF9EMjRfVU5PUk1fUzhfVUlOVDogMTI5LAogICAgICAgIFZLX0ZPUk1BVF9EMzJfU0ZMT0FUX1M4X1VJTlQ6IDEzMCwKICAgICAgICBWS19GT1JNQVRfQkMxX1JHQl9VTk9STV9CTE9DSzogMTMxLAogICAgICAgIFZLX0ZPUk1BVF9CQzFfUkdCX1NSR0JfQkxPQ0s6IDEzMiwKICAgICAgICBWS19GT1JNQVRfQkMxX1JHQkFfVU5PUk1fQkxPQ0s6IDEzMywKICAgICAgICBWS19GT1JNQVRfQkMxX1JHQkFfU1JHQl9CTE9DSzogMTM0LAogICAgICAgIFZLX0ZPUk1BVF9CQzJfVU5PUk1fQkxPQ0s6IDEzNSwKICAgICAgICBWS19GT1JNQVRfQkMyX1NSR0JfQkxPQ0s6IDEzNiwKICAgICAgICBWS19GT1JNQVRfQkMzX1VOT1JNX0JMT0NLOiAxMzcsCiAgICAgICAgVktfRk9STUFUX0JDM19TUkdCX0JMT0NLOiAxMzgsCiAgICAgICAgVktfRk9STUFUX0JDNF9VTk9STV9CTE9DSzogMTM5LAogICAgICAgIFZLX0ZPUk1BVF9CQzRfU05PUk1fQkxPQ0s6IDE0MCwKICAgICAgICBWS19GT1JNQVRfQkM1X1VOT1JNX0JMT0NLOiAxNDEsCiAgICAgICAgVktfRk9STUFUX0JDNV9TTk9STV9CTE9DSzogMTQyLAogICAgICAgIFZLX0ZPUk1BVF9CQzZIX1VGTE9BVF9CTE9DSzogMTQzLAogICAgICAgIFZLX0ZPUk1BVF9CQzZIX1NGTE9BVF9CTE9DSzogMTQ0LAogICAgICAgIFZLX0ZPUk1BVF9CQzdfVU5PUk1fQkxPQ0s6IDE0NSwKICAgICAgICBWS19GT1JNQVRfQkM3X1NSR0JfQkxPQ0s6IDE0NiwKICAgICAgICBWS19GT1JNQVRfRVRDMl9SOEc4QjhfVU5PUk1fQkxPQ0s6IDE0NywKICAgICAgICBWS19GT1JNQVRfRVRDMl9SOEc4QjhfU1JHQl9CTE9DSzogMTQ4LAogICAgICAgIFZLX0ZPUk1BVF9FVEMyX1I4RzhCOEExX1VOT1JNX0JMT0NLOiAxNDksCiAgICAgICAgVktfRk9STUFUX0VUQzJfUjhHOEI4QTFfU1JHQl9CTE9DSzogMTUwLAogICAgICAgIFZLX0ZPUk1BVF9FVEMyX1I4RzhCOEE4X1VOT1JNX0JMT0NLOiAxNTEsCiAgICAgICAgVktfRk9STUFUX0VUQzJfUjhHOEI4QThfU1JHQl9CTE9DSzogMTUyLAogICAgICAgIFZLX0ZPUk1BVF9FQUNfUjExX1VOT1JNX0JMT0NLOiAxNTMsCiAgICAgICAgVktfRk9STUFUX0VBQ19SMTFfU05PUk1fQkxPQ0s6IDE1NCwKICAgICAgICBWS19GT1JNQVRfRUFDX1IxMUcxMV9VTk9STV9CTE9DSzogMTU1LAogICAgICAgIFZLX0ZPUk1BVF9FQUNfUjExRzExX1NOT1JNX0JMT0NLOiAxNTYsCiAgICAgICAgVktfRk9STUFUX0FTVENfNHg0X1VOT1JNX0JMT0NLOiAxNTcsCiAgICAgICAgVktfRk9STUFUX0FTVENfNHg0X1NSR0JfQkxPQ0s6IDE1OCwKICAgICAgICBWS19GT1JNQVRfQVNUQ181eDRfVU5PUk1fQkxPQ0s6IDE1OSwKICAgICAgICBWS19GT1JNQVRfQVNUQ181eDRfU1JHQl9CTE9DSzogMTYwLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzV4NV9VTk9STV9CTE9DSzogMTYxLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzV4NV9TUkdCX0JMT0NLOiAxNjIsCiAgICAgICAgVktfRk9STUFUX0FTVENfNng1X1VOT1JNX0JMT0NLOiAxNjMsCiAgICAgICAgVktfRk9STUFUX0FTVENfNng1X1NSR0JfQkxPQ0s6IDE2NCwKICAgICAgICBWS19GT1JNQVRfQVNUQ182eDZfVU5PUk1fQkxPQ0s6IDE2NSwKICAgICAgICBWS19GT1JNQVRfQVNUQ182eDZfU1JHQl9CTE9DSzogMTY2LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzh4NV9VTk9STV9CTE9DSzogMTY3LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzh4NV9TUkdCX0JMT0NLOiAxNjgsCiAgICAgICAgVktfRk9STUFUX0FTVENfOHg2X1VOT1JNX0JMT0NLOiAxNjksCiAgICAgICAgVktfRk9STUFUX0FTVENfOHg2X1NSR0JfQkxPQ0s6IDE3MCwKICAgICAgICBWS19GT1JNQVRfQVNUQ184eDhfVU5PUk1fQkxPQ0s6IDE3MSwKICAgICAgICBWS19GT1JNQVRfQVNUQ184eDhfU1JHQl9CTE9DSzogMTcyLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDVfVU5PUk1fQkxPQ0s6IDE3MywKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHg1X1NSR0JfQkxPQ0s6IDE3NCwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHg2X1VOT1JNX0JMT0NLOiAxNzUsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4Nl9TUkdCX0JMT0NLOiAxNzYsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4OF9VTk9STV9CTE9DSzogMTc3LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDhfU1JHQl9CTE9DSzogMTc4LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDEwX1VOT1JNX0JMT0NLOiAxNzksCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4MTBfU1JHQl9CTE9DSzogMTgwLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEyeDEwX1VOT1JNX0JMT0NLOiAxODEsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTJ4MTBfU1JHQl9CTE9DSzogMTgyLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEyeDEyX1VOT1JNX0JMT0NLOiAxODMsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTJ4MTJfU1JHQl9CTE9DSzogMTg0LAogICAgICAgIFZLX0ZPUk1BVF9HOEI4RzhSOF80MjJfVU5PUk06IDEwMDAxNTZlMywKICAgICAgICBWS19GT1JNQVRfQjhHOFI4RzhfNDIyX1VOT1JNOiAxMDAwMTU2MDAxLAogICAgICAgIFZLX0ZPUk1BVF9HOF9COF9SOF8zUExBTkVfNDIwX1VOT1JNOiAxMDAwMTU2MDAyLAogICAgICAgIFZLX0ZPUk1BVF9HOF9COFI4XzJQTEFORV80MjBfVU5PUk06IDEwMDAxNTYwMDMsCiAgICAgICAgVktfRk9STUFUX0c4X0I4X1I4XzNQTEFORV80MjJfVU5PUk06IDEwMDAxNTYwMDQsCiAgICAgICAgVktfRk9STUFUX0c4X0I4UjhfMlBMQU5FXzQyMl9VTk9STTogMTAwMDE1NjAwNSwKICAgICAgICBWS19GT1JNQVRfRzhfQjhfUjhfM1BMQU5FXzQ0NF9VTk9STTogMTAwMDE1NjAwNiwKICAgICAgICBWS19GT1JNQVRfUjEwWDZfVU5PUk1fUEFDSzE2OiAxMDAwMTU2MDA3LAogICAgICAgIFZLX0ZPUk1BVF9SMTBYNkcxMFg2X1VOT1JNXzJQQUNLMTY6IDEwMDAxNTYwMDgsCiAgICAgICAgVktfRk9STUFUX1IxMFg2RzEwWDZCMTBYNkExMFg2X1VOT1JNXzRQQUNLMTY6IDEwMDAxNTYwMDksCiAgICAgICAgVktfRk9STUFUX0cxMFg2QjEwWDZHMTBYNlIxMFg2XzQyMl9VTk9STV80UEFDSzE2OiAxMDAwMTU2MDEwLAogICAgICAgIFZLX0ZPUk1BVF9CMTBYNkcxMFg2UjEwWDZHMTBYNl80MjJfVU5PUk1fNFBBQ0sxNjogMTAwMDE1NjAxMSwKICAgICAgICBWS19GT1JNQVRfRzEwWDZfQjEwWDZfUjEwWDZfM1BMQU5FXzQyMF9VTk9STV8zUEFDSzE2OiAxMDAwMTU2MDEyLAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNlIxMFg2XzJQTEFORV80MjBfVU5PUk1fM1BBQ0sxNjogMTAwMDE1NjAxMywKICAgICAgICBWS19GT1JNQVRfRzEwWDZfQjEwWDZfUjEwWDZfM1BMQU5FXzQyMl9VTk9STV8zUEFDSzE2OiAxMDAwMTU2MDE0LAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNlIxMFg2XzJQTEFORV80MjJfVU5PUk1fM1BBQ0sxNjogMTAwMDE1NjAxNSwKICAgICAgICBWS19GT1JNQVRfRzEwWDZfQjEwWDZfUjEwWDZfM1BMQU5FXzQ0NF9VTk9STV8zUEFDSzE2OiAxMDAwMTU2MDE2LAogICAgICAgIFZLX0ZPUk1BVF9SMTJYNF9VTk9STV9QQUNLMTY6IDEwMDAxNTYwMTcsCiAgICAgICAgVktfRk9STUFUX1IxMlg0RzEyWDRfVU5PUk1fMlBBQ0sxNjogMTAwMDE1NjAxOCwKICAgICAgICBWS19GT1JNQVRfUjEyWDRHMTJYNEIxMlg0QTEyWDRfVU5PUk1fNFBBQ0sxNjogMTAwMDE1NjAxOSwKICAgICAgICBWS19GT1JNQVRfRzEyWDRCMTJYNEcxMlg0UjEyWDRfNDIyX1VOT1JNXzRQQUNLMTY6IDEwMDAxNTYwMjAsCiAgICAgICAgVktfRk9STUFUX0IxMlg0RzEyWDRSMTJYNEcxMlg0XzQyMl9VTk9STV80UEFDSzE2OiAxMDAwMTU2MDIxLAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNF9CMTJYNF9SMTJYNF8zUExBTkVfNDIwX1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMjIsCiAgICAgICAgVktfRk9STUFUX0cxMlg0X0IxMlg0UjEyWDRfMlBMQU5FXzQyMF9VTk9STV8zUEFDSzE2OiAxMDAwMTU2MDIzLAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNF9CMTJYNF9SMTJYNF8zUExBTkVfNDIyX1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMjQsCiAgICAgICAgVktfRk9STUFUX0cxMlg0X0IxMlg0UjEyWDRfMlBMQU5FXzQyMl9VTk9STV8zUEFDSzE2OiAxMDAwMTU2MDI1LAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNF9CMTJYNF9SMTJYNF8zUExBTkVfNDQ0X1VOT1JNXzNQQUNLMTY6IDEwMDAxNTYwMjYsCiAgICAgICAgVktfRk9STUFUX0cxNkIxNkcxNlIxNl80MjJfVU5PUk06IDEwMDAxNTYwMjcsCiAgICAgICAgVktfRk9STUFUX0IxNkcxNlIxNkcxNl80MjJfVU5PUk06IDEwMDAxNTYwMjgsCiAgICAgICAgVktfRk9STUFUX0cxNl9CMTZfUjE2XzNQTEFORV80MjBfVU5PUk06IDEwMDAxNTYwMjksCiAgICAgICAgVktfRk9STUFUX0cxNl9CMTZSMTZfMlBMQU5FXzQyMF9VTk9STTogMTAwMDE1NjAzMCwKICAgICAgICBWS19GT1JNQVRfRzE2X0IxNl9SMTZfM1BMQU5FXzQyMl9VTk9STTogMTAwMDE1NjAzMSwKICAgICAgICBWS19GT1JNQVRfRzE2X0IxNlIxNl8yUExBTkVfNDIyX1VOT1JNOiAxMDAwMTU2MDMyLAogICAgICAgIFZLX0ZPUk1BVF9HMTZfQjE2X1IxNl8zUExBTkVfNDQ0X1VOT1JNOiAxMDAwMTU2MDMzLAogICAgICAgIFZLX0ZPUk1BVF9QVlJUQzFfMkJQUF9VTk9STV9CTE9DS19JTUc6IDEwMDAwNTRlMywKICAgICAgICBWS19GT1JNQVRfUFZSVEMxXzRCUFBfVU5PUk1fQkxPQ0tfSU1HOiAxMDAwMDU0MDAxLAogICAgICAgIFZLX0ZPUk1BVF9QVlJUQzJfMkJQUF9VTk9STV9CTE9DS19JTUc6IDEwMDAwNTQwMDIsCiAgICAgICAgVktfRk9STUFUX1BWUlRDMl80QlBQX1VOT1JNX0JMT0NLX0lNRzogMTAwMDA1NDAwMywKICAgICAgICBWS19GT1JNQVRfUFZSVEMxXzJCUFBfU1JHQl9CTE9DS19JTUc6IDEwMDAwNTQwMDQsCiAgICAgICAgVktfRk9STUFUX1BWUlRDMV80QlBQX1NSR0JfQkxPQ0tfSU1HOiAxMDAwMDU0MDA1LAogICAgICAgIFZLX0ZPUk1BVF9QVlJUQzJfMkJQUF9TUkdCX0JMT0NLX0lNRzogMTAwMDA1NDAwNiwKICAgICAgICBWS19GT1JNQVRfUFZSVEMyXzRCUFBfU1JHQl9CTE9DS19JTUc6IDEwMDAwNTQwMDcsCiAgICAgICAgVktfRk9STUFUX0FTVENfNHg0X1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjZlMywKICAgICAgICBWS19GT1JNQVRfQVNUQ181eDRfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAwMSwKICAgICAgICBWS19GT1JNQVRfQVNUQ181eDVfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAwMiwKICAgICAgICBWS19GT1JNQVRfQVNUQ182eDVfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAwMywKICAgICAgICBWS19GT1JNQVRfQVNUQ182eDZfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAwNCwKICAgICAgICBWS19GT1JNQVRfQVNUQ184eDVfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAwNSwKICAgICAgICBWS19GT1JNQVRfQVNUQ184eDZfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAwNiwKICAgICAgICBWS19GT1JNQVRfQVNUQ184eDhfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAwNywKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHg1X1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMDgsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTB4Nl9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDA5LAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEweDhfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAxMCwKICAgICAgICBWS19GT1JNQVRfQVNUQ18xMHgxMF9TRkxPQVRfQkxPQ0tfRVhUOiAxMDAwMDY2MDExLAogICAgICAgIFZLX0ZPUk1BVF9BU1RDXzEyeDEwX1NGTE9BVF9CTE9DS19FWFQ6IDEwMDAwNjYwMTIsCiAgICAgICAgVktfRk9STUFUX0FTVENfMTJ4MTJfU0ZMT0FUX0JMT0NLX0VYVDogMTAwMDA2NjAxMywKICAgICAgICBWS19GT1JNQVRfRzhCOEc4UjhfNDIyX1VOT1JNX0tIUjogMTAwMDE1NmUzLAogICAgICAgIFZLX0ZPUk1BVF9COEc4UjhHOF80MjJfVU5PUk1fS0hSOiAxMDAwMTU2MDAxLAogICAgICAgIFZLX0ZPUk1BVF9HOF9COF9SOF8zUExBTkVfNDIwX1VOT1JNX0tIUjogMTAwMDE1NjAwMiwKICAgICAgICBWS19GT1JNQVRfRzhfQjhSOF8yUExBTkVfNDIwX1VOT1JNX0tIUjogMTAwMDE1NjAwMywKICAgICAgICBWS19GT1JNQVRfRzhfQjhfUjhfM1BMQU5FXzQyMl9VTk9STV9LSFI6IDEwMDAxNTYwMDQsCiAgICAgICAgVktfRk9STUFUX0c4X0I4UjhfMlBMQU5FXzQyMl9VTk9STV9LSFI6IDEwMDAxNTYwMDUsCiAgICAgICAgVktfRk9STUFUX0c4X0I4X1I4XzNQTEFORV80NDRfVU5PUk1fS0hSOiAxMDAwMTU2MDA2LAogICAgICAgIFZLX0ZPUk1BVF9SMTBYNl9VTk9STV9QQUNLMTZfS0hSOiAxMDAwMTU2MDA3LAogICAgICAgIFZLX0ZPUk1BVF9SMTBYNkcxMFg2X1VOT1JNXzJQQUNLMTZfS0hSOiAxMDAwMTU2MDA4LAogICAgICAgIFZLX0ZPUk1BVF9SMTBYNkcxMFg2QjEwWDZBMTBYNl9VTk9STV80UEFDSzE2X0tIUjogMTAwMDE1NjAwOSwKICAgICAgICBWS19GT1JNQVRfRzEwWDZCMTBYNkcxMFg2UjEwWDZfNDIyX1VOT1JNXzRQQUNLMTZfS0hSOiAxMDAwMTU2MDEwLAogICAgICAgIFZLX0ZPUk1BVF9CMTBYNkcxMFg2UjEwWDZHMTBYNl80MjJfVU5PUk1fNFBBQ0sxNl9LSFI6IDEwMDAxNTYwMTEsCiAgICAgICAgVktfRk9STUFUX0cxMFg2X0IxMFg2X1IxMFg2XzNQTEFORV80MjBfVU5PUk1fM1BBQ0sxNl9LSFI6IDEwMDAxNTYwMTIsCiAgICAgICAgVktfRk9STUFUX0cxMFg2X0IxMFg2UjEwWDZfMlBMQU5FXzQyMF9VTk9STV8zUEFDSzE2X0tIUjogMTAwMDE1NjAxMywKICAgICAgICBWS19GT1JNQVRfRzEwWDZfQjEwWDZfUjEwWDZfM1BMQU5FXzQyMl9VTk9STV8zUEFDSzE2X0tIUjogMTAwMDE1NjAxNCwKICAgICAgICBWS19GT1JNQVRfRzEwWDZfQjEwWDZSMTBYNl8yUExBTkVfNDIyX1VOT1JNXzNQQUNLMTZfS0hSOiAxMDAwMTU2MDE1LAogICAgICAgIFZLX0ZPUk1BVF9HMTBYNl9CMTBYNl9SMTBYNl8zUExBTkVfNDQ0X1VOT1JNXzNQQUNLMTZfS0hSOiAxMDAwMTU2MDE2LAogICAgICAgIFZLX0ZPUk1BVF9SMTJYNF9VTk9STV9QQUNLMTZfS0hSOiAxMDAwMTU2MDE3LAogICAgICAgIFZLX0ZPUk1BVF9SMTJYNEcxMlg0X1VOT1JNXzJQQUNLMTZfS0hSOiAxMDAwMTU2MDE4LAogICAgICAgIFZLX0ZPUk1BVF9SMTJYNEcxMlg0QjEyWDRBMTJYNF9VTk9STV80UEFDSzE2X0tIUjogMTAwMDE1NjAxOSwKICAgICAgICBWS19GT1JNQVRfRzEyWDRCMTJYNEcxMlg0UjEyWDRfNDIyX1VOT1JNXzRQQUNLMTZfS0hSOiAxMDAwMTU2MDIwLAogICAgICAgIFZLX0ZPUk1BVF9CMTJYNEcxMlg0UjEyWDRHMTJYNF80MjJfVU5PUk1fNFBBQ0sxNl9LSFI6IDEwMDAxNTYwMjEsCiAgICAgICAgVktfRk9STUFUX0cxMlg0X0IxMlg0X1IxMlg0XzNQTEFORV80MjBfVU5PUk1fM1BBQ0sxNl9LSFI6IDEwMDAxNTYwMjIsCiAgICAgICAgVktfRk9STUFUX0cxMlg0X0IxMlg0UjEyWDRfMlBMQU5FXzQyMF9VTk9STV8zUEFDSzE2X0tIUjogMTAwMDE1NjAyMywKICAgICAgICBWS19GT1JNQVRfRzEyWDRfQjEyWDRfUjEyWDRfM1BMQU5FXzQyMl9VTk9STV8zUEFDSzE2X0tIUjogMTAwMDE1NjAyNCwKICAgICAgICBWS19GT1JNQVRfRzEyWDRfQjEyWDRSMTJYNF8yUExBTkVfNDIyX1VOT1JNXzNQQUNLMTZfS0hSOiAxMDAwMTU2MDI1LAogICAgICAgIFZLX0ZPUk1BVF9HMTJYNF9CMTJYNF9SMTJYNF8zUExBTkVfNDQ0X1VOT1JNXzNQQUNLMTZfS0hSOiAxMDAwMTU2MDI2LAogICAgICAgIFZLX0ZPUk1BVF9HMTZCMTZHMTZSMTZfNDIyX1VOT1JNX0tIUjogMTAwMDE1NjAyNywKICAgICAgICBWS19GT1JNQVRfQjE2RzE2UjE2RzE2XzQyMl9VTk9STV9LSFI6IDEwMDAxNTYwMjgsCiAgICAgICAgVktfRk9STUFUX0cxNl9CMTZfUjE2XzNQTEFORV80MjBfVU5PUk1fS0hSOiAxMDAwMTU2MDI5LAogICAgICAgIFZLX0ZPUk1BVF9HMTZfQjE2UjE2XzJQTEFORV80MjBfVU5PUk1fS0hSOiAxMDAwMTU2MDMwLAogICAgICAgIFZLX0ZPUk1BVF9HMTZfQjE2X1IxNl8zUExBTkVfNDIyX1VOT1JNX0tIUjogMTAwMDE1NjAzMSwKICAgICAgICBWS19GT1JNQVRfRzE2X0IxNlIxNl8yUExBTkVfNDIyX1VOT1JNX0tIUjogMTAwMDE1NjAzMiwKICAgICAgICBWS19GT1JNQVRfRzE2X0IxNl9SMTZfM1BMQU5FXzQ0NF9VTk9STV9LSFI6IDEwMDAxNTYwMzMKICAgICAgfTsKICAgICAgVnVsa2FuQ29uc3RhbnRzX2RlZmF1bHQgPSBPYmplY3QuZnJlZXplKFZ1bGthbkNvbnN0YW50cyk7CiAgICB9CiAgfSk7CgogIC8vIG5vZGVfbW9kdWxlcy9rdHgtcGFyc2UvZGlzdC9rdHgtcGFyc2UubW9kZXJuLmpzCiAgZnVuY3Rpb24gZGVjb2RlVGV4dChidWZmZXIpIHsKICAgIGlmICh0eXBlb2YgVGV4dERlY29kZXIgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoYnVmZmVyKTsKICAgIH0KICAgIHJldHVybiBCdWZmZXIuZnJvbShidWZmZXIpLnRvU3RyaW5nKCJ1dGY4Iik7CiAgfQogIGZ1bmN0aW9uIHJlYWQyKGRhdGEpIHsKICAgIGNvbnN0IGlkID0gbmV3IFVpbnQ4QXJyYXkoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCwgS1RYMl9JRC5sZW5ndGgpOwogICAgaWYgKGlkWzBdICE9PSBLVFgyX0lEWzBdIHx8IC8vICfCtCcKICAgIGlkWzFdICE9PSBLVFgyX0lEWzFdIHx8IC8vICdLJwogICAgaWRbMl0gIT09IEtUWDJfSURbMl0gfHwgLy8gJ1QnCiAgICBpZFszXSAhPT0gS1RYMl9JRFszXSB8fCAvLyAnWCcKICAgIGlkWzRdICE9PSBLVFgyX0lEWzRdIHx8IC8vICcgJwogICAgaWRbNV0gIT09IEtUWDJfSURbNV0gfHwgLy8gJzInCiAgICBpZFs2XSAhPT0gS1RYMl9JRFs2XSB8fCAvLyAnMCcKICAgIGlkWzddICE9PSBLVFgyX0lEWzddIHx8IC8vICfCqicKICAgIGlkWzhdICE9PSBLVFgyX0lEWzhdIHx8IC8vICdccicKICAgIGlkWzldICE9PSBLVFgyX0lEWzldIHx8IC8vICdcbicKICAgIGlkWzEwXSAhPT0gS1RYMl9JRFsxMF0gfHwgLy8gJ1x4MUEnCiAgICBpZFsxMV0gIT09IEtUWDJfSURbMTFdKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBLVFggMi4wIGlkZW50aWZpZXIuIik7CiAgICB9CiAgICBjb25zdCBjb250YWluZXIgPSBuZXcgS1RYMkNvbnRhaW5lcigpOwogICAgY29uc3QgaGVhZGVyQnl0ZUxlbmd0aCA9IDE3ICogVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICBjb25zdCBoZWFkZXJSZWFkZXIgPSBuZXcgQnVmZmVyUmVhZGVyKGRhdGEsIEtUWDJfSUQubGVuZ3RoLCBoZWFkZXJCeXRlTGVuZ3RoLCB0cnVlKTsKICAgIGNvbnRhaW5lci52a0Zvcm1hdCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29udGFpbmVyLnR5cGVTaXplID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb250YWluZXIucGl4ZWxXaWR0aCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29udGFpbmVyLnBpeGVsSGVpZ2h0ID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb250YWluZXIucGl4ZWxEZXB0aCA9IGhlYWRlclJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgY29udGFpbmVyLmxheWVyQ291bnQgPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnRhaW5lci5mYWNlQ291bnQgPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnN0IGxldmVsQ291bnQgPSBoZWFkZXJSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnRhaW5lci5zdXBlcmNvbXByZXNzaW9uU2NoZW1lID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb25zdCBkZmRCeXRlT2Zmc2V0ID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb25zdCBkZmRCeXRlTGVuZ3RoID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb25zdCBrdmRCeXRlT2Zmc2V0ID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb25zdCBrdmRCeXRlTGVuZ3RoID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb25zdCBzZ2RCeXRlT2Zmc2V0ID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDY0KCk7CiAgICBjb25zdCBzZ2RCeXRlTGVuZ3RoID0gaGVhZGVyUmVhZGVyLl9uZXh0VWludDY0KCk7CiAgICBjb25zdCBsZXZlbEJ5dGVMZW5ndGggPSBsZXZlbENvdW50ICogMyAqIDg7CiAgICBjb25zdCBsZXZlbFJlYWRlciA9IG5ldyBCdWZmZXJSZWFkZXIoZGF0YSwgS1RYMl9JRC5sZW5ndGggKyBoZWFkZXJCeXRlTGVuZ3RoLCBsZXZlbEJ5dGVMZW5ndGgsIHRydWUpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZXZlbENvdW50OyBpKyspIHsKICAgICAgY29udGFpbmVyLmxldmVscy5wdXNoKHsKICAgICAgICBsZXZlbERhdGE6IG5ldyBVaW50OEFycmF5KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQgKyBsZXZlbFJlYWRlci5fbmV4dFVpbnQ2NCgpLCBsZXZlbFJlYWRlci5fbmV4dFVpbnQ2NCgpKSwKICAgICAgICB1bmNvbXByZXNzZWRCeXRlTGVuZ3RoOiBsZXZlbFJlYWRlci5fbmV4dFVpbnQ2NCgpCiAgICAgIH0pOwogICAgfQogICAgY29uc3QgZGZkUmVhZGVyID0gbmV3IEJ1ZmZlclJlYWRlcihkYXRhLCBkZmRCeXRlT2Zmc2V0LCBkZmRCeXRlTGVuZ3RoLCB0cnVlKTsKICAgIGNvbnN0IGRmZCA9IHsKICAgICAgdmVuZG9ySWQ6IGRmZFJlYWRlci5fc2tpcCgKICAgICAgICA0CiAgICAgICAgLyogdG90YWxTaXplICovCiAgICAgICkuX25leHRVaW50MTYoKSwKICAgICAgZGVzY3JpcHRvclR5cGU6IGRmZFJlYWRlci5fbmV4dFVpbnQxNigpLAogICAgICB2ZXJzaW9uTnVtYmVyOiBkZmRSZWFkZXIuX25leHRVaW50MTYoKSwKICAgICAgZGVzY3JpcHRvckJsb2NrU2l6ZTogZGZkUmVhZGVyLl9uZXh0VWludDE2KCksCiAgICAgIGNvbG9yTW9kZWw6IGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksCiAgICAgIGNvbG9yUHJpbWFyaWVzOiBkZmRSZWFkZXIuX25leHRVaW50OCgpLAogICAgICB0cmFuc2ZlckZ1bmN0aW9uOiBkZmRSZWFkZXIuX25leHRVaW50OCgpLAogICAgICBmbGFnczogZGZkUmVhZGVyLl9uZXh0VWludDgoKSwKICAgICAgdGV4ZWxCbG9ja0RpbWVuc2lvbjogW2RmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCldLAogICAgICBieXRlc1BsYW5lOiBbZGZkUmVhZGVyLl9uZXh0VWludDgoKSwgZGZkUmVhZGVyLl9uZXh0VWludDgoKSwgZGZkUmVhZGVyLl9uZXh0VWludDgoKSwgZGZkUmVhZGVyLl9uZXh0VWludDgoKSwgZGZkUmVhZGVyLl9uZXh0VWludDgoKSwgZGZkUmVhZGVyLl9uZXh0VWludDgoKSwgZGZkUmVhZGVyLl9uZXh0VWludDgoKSwgZGZkUmVhZGVyLl9uZXh0VWludDgoKV0sCiAgICAgIHNhbXBsZXM6IFtdCiAgICB9OwogICAgY29uc3Qgc2FtcGxlU3RhcnQgPSA2OwogICAgY29uc3Qgc2FtcGxlV29yZHMgPSA0OwogICAgY29uc3QgbnVtU2FtcGxlcyA9IChkZmQuZGVzY3JpcHRvckJsb2NrU2l6ZSAvIDQgLSBzYW1wbGVTdGFydCkgLyBzYW1wbGVXb3JkczsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtU2FtcGxlczsgaSsrKSB7CiAgICAgIGNvbnN0IHNhbXBsZSA9IHsKICAgICAgICBiaXRPZmZzZXQ6IGRmZFJlYWRlci5fbmV4dFVpbnQxNigpLAogICAgICAgIGJpdExlbmd0aDogZGZkUmVhZGVyLl9uZXh0VWludDgoKSwKICAgICAgICBjaGFubmVsVHlwZTogZGZkUmVhZGVyLl9uZXh0VWludDgoKSwKICAgICAgICBzYW1wbGVQb3NpdGlvbjogW2RmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCksIGRmZFJlYWRlci5fbmV4dFVpbnQ4KCldLAogICAgICAgIHNhbXBsZUxvd2VyOiAtSW5maW5pdHksCiAgICAgICAgc2FtcGxlVXBwZXI6IEluZmluaXR5CiAgICAgIH07CiAgICAgIGlmIChzYW1wbGUuY2hhbm5lbFR5cGUgJiBLSFJfREZfU0FNUExFX0RBVEFUWVBFX1NJR05FRCkgewogICAgICAgIHNhbXBsZS5zYW1wbGVMb3dlciA9IGRmZFJlYWRlci5fbmV4dEludDMyKCk7CiAgICAgICAgc2FtcGxlLnNhbXBsZVVwcGVyID0gZGZkUmVhZGVyLl9uZXh0SW50MzIoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzYW1wbGUuc2FtcGxlTG93ZXIgPSBkZmRSZWFkZXIuX25leHRVaW50MzIoKTsKICAgICAgICBzYW1wbGUuc2FtcGxlVXBwZXIgPSBkZmRSZWFkZXIuX25leHRVaW50MzIoKTsKICAgICAgfQogICAgICBkZmQuc2FtcGxlc1tpXSA9IHNhbXBsZTsKICAgIH0KICAgIGNvbnRhaW5lci5kYXRhRm9ybWF0RGVzY3JpcHRvci5sZW5ndGggPSAwOwogICAgY29udGFpbmVyLmRhdGFGb3JtYXREZXNjcmlwdG9yLnB1c2goZGZkKTsKICAgIGNvbnN0IGt2ZFJlYWRlciA9IG5ldyBCdWZmZXJSZWFkZXIoZGF0YSwga3ZkQnl0ZU9mZnNldCwga3ZkQnl0ZUxlbmd0aCwgdHJ1ZSk7CiAgICB3aGlsZSAoa3ZkUmVhZGVyLl9vZmZzZXQgPCBrdmRCeXRlTGVuZ3RoKSB7CiAgICAgIGNvbnN0IGtleVZhbHVlQnl0ZUxlbmd0aCA9IGt2ZFJlYWRlci5fbmV4dFVpbnQzMigpOwogICAgICBjb25zdCBrZXlEYXRhID0ga3ZkUmVhZGVyLl9zY2FuKGtleVZhbHVlQnl0ZUxlbmd0aCk7CiAgICAgIGNvbnN0IGtleSA9IGRlY29kZVRleHQoa2V5RGF0YSk7CiAgICAgIGNvbnRhaW5lci5rZXlWYWx1ZVtrZXldID0ga3ZkUmVhZGVyLl9uZXh0VWludDhBcnJheShrZXlWYWx1ZUJ5dGVMZW5ndGggLSBrZXlEYXRhLmJ5dGVMZW5ndGggLSAxKTsKICAgICAgaWYgKGtleS5tYXRjaCgvXmt0eC9pKSkgewogICAgICAgIGNvbnN0IHRleHQgPSBkZWNvZGVUZXh0KGNvbnRhaW5lci5rZXlWYWx1ZVtrZXldKTsKICAgICAgICBjb250YWluZXIua2V5VmFsdWVba2V5XSA9IHRleHQuc3Vic3RyaW5nKDAsIHRleHQubGFzdEluZGV4T2YoIlwwIikpOwogICAgICB9CiAgICAgIGNvbnN0IGt2UGFkZGluZyA9IGtleVZhbHVlQnl0ZUxlbmd0aCAlIDQgPyA0IC0ga2V5VmFsdWVCeXRlTGVuZ3RoICUgNCA6IDA7CiAgICAgIGt2ZFJlYWRlci5fc2tpcChrdlBhZGRpbmcpOwogICAgfQogICAgaWYgKHNnZEJ5dGVMZW5ndGggPD0gMCkgcmV0dXJuIGNvbnRhaW5lcjsKICAgIGNvbnN0IHNnZFJlYWRlciA9IG5ldyBCdWZmZXJSZWFkZXIoZGF0YSwgc2dkQnl0ZU9mZnNldCwgc2dkQnl0ZUxlbmd0aCwgdHJ1ZSk7CiAgICBjb25zdCBlbmRwb2ludENvdW50ID0gc2dkUmVhZGVyLl9uZXh0VWludDE2KCk7CiAgICBjb25zdCBzZWxlY3RvckNvdW50ID0gc2dkUmVhZGVyLl9uZXh0VWludDE2KCk7CiAgICBjb25zdCBlbmRwb2ludHNCeXRlTGVuZ3RoID0gc2dkUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb25zdCBzZWxlY3RvcnNCeXRlTGVuZ3RoID0gc2dkUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb25zdCB0YWJsZXNCeXRlTGVuZ3RoID0gc2dkUmVhZGVyLl9uZXh0VWludDMyKCk7CiAgICBjb25zdCBleHRlbmRlZEJ5dGVMZW5ndGggPSBzZ2RSZWFkZXIuX25leHRVaW50MzIoKTsKICAgIGNvbnN0IGltYWdlRGVzY3MgPSBbXTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGV2ZWxDb3VudDsgaSsrKSB7CiAgICAgIGltYWdlRGVzY3MucHVzaCh7CiAgICAgICAgaW1hZ2VGbGFnczogc2dkUmVhZGVyLl9uZXh0VWludDMyKCksCiAgICAgICAgcmdiU2xpY2VCeXRlT2Zmc2V0OiBzZ2RSZWFkZXIuX25leHRVaW50MzIoKSwKICAgICAgICByZ2JTbGljZUJ5dGVMZW5ndGg6IHNnZFJlYWRlci5fbmV4dFVpbnQzMigpLAogICAgICAgIGFscGhhU2xpY2VCeXRlT2Zmc2V0OiBzZ2RSZWFkZXIuX25leHRVaW50MzIoKSwKICAgICAgICBhbHBoYVNsaWNlQnl0ZUxlbmd0aDogc2dkUmVhZGVyLl9uZXh0VWludDMyKCkKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBlbmRwb2ludHNCeXRlT2Zmc2V0ID0gc2dkQnl0ZU9mZnNldCArIHNnZFJlYWRlci5fb2Zmc2V0OwogICAgY29uc3Qgc2VsZWN0b3JzQnl0ZU9mZnNldCA9IGVuZHBvaW50c0J5dGVPZmZzZXQgKyBlbmRwb2ludHNCeXRlTGVuZ3RoOwogICAgY29uc3QgdGFibGVzQnl0ZU9mZnNldCA9IHNlbGVjdG9yc0J5dGVPZmZzZXQgKyBzZWxlY3RvcnNCeXRlTGVuZ3RoOwogICAgY29uc3QgZXh0ZW5kZWRCeXRlT2Zmc2V0ID0gdGFibGVzQnl0ZU9mZnNldCArIHRhYmxlc0J5dGVMZW5ndGg7CiAgICBjb25zdCBlbmRwb2ludHNEYXRhID0gbmV3IFVpbnQ4QXJyYXkoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCArIGVuZHBvaW50c0J5dGVPZmZzZXQsIGVuZHBvaW50c0J5dGVMZW5ndGgpOwogICAgY29uc3Qgc2VsZWN0b3JzRGF0YSA9IG5ldyBVaW50OEFycmF5KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQgKyBzZWxlY3RvcnNCeXRlT2Zmc2V0LCBzZWxlY3RvcnNCeXRlTGVuZ3RoKTsKICAgIGNvbnN0IHRhYmxlc0RhdGEgPSBuZXcgVWludDhBcnJheShkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgdGFibGVzQnl0ZU9mZnNldCwgdGFibGVzQnl0ZUxlbmd0aCk7CiAgICBjb25zdCBleHRlbmRlZERhdGEgPSBuZXcgVWludDhBcnJheShkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgZXh0ZW5kZWRCeXRlT2Zmc2V0LCBleHRlbmRlZEJ5dGVMZW5ndGgpOwogICAgY29udGFpbmVyLmdsb2JhbERhdGEgPSB7CiAgICAgIGVuZHBvaW50Q291bnQsCiAgICAgIHNlbGVjdG9yQ291bnQsCiAgICAgIGltYWdlRGVzY3MsCiAgICAgIGVuZHBvaW50c0RhdGEsCiAgICAgIHNlbGVjdG9yc0RhdGEsCiAgICAgIHRhYmxlc0RhdGEsCiAgICAgIGV4dGVuZGVkRGF0YQogICAgfTsKICAgIHJldHVybiBjb250YWluZXI7CiAgfQogIHZhciBLSFJfU1VQRVJDT01QUkVTU0lPTl9OT05FLCBLSFJfREZfS0hSX0RFU0NSSVBUT1JUWVBFX0JBU0lDRk9STUFULCBLSFJfREZfVkVORE9SSURfS0hST05PUywgS0hSX0RGX1ZFUlNJT04sIEtIUl9ERl9NT0RFTF9VTlNQRUNJRklFRCwgS0hSX0RGX0ZMQUdfQUxQSEFfU1RSQUlHSFQsIEtIUl9ERl9UUkFOU0ZFUl9TUkdCLCBLSFJfREZfUFJJTUFSSUVTX0JUNzA5LCBLSFJfREZfU0FNUExFX0RBVEFUWVBFX1NJR05FRCwgVktfRk9STUFUX1VOREVGSU5FRCwgS1RYMkNvbnRhaW5lciwgQnVmZmVyUmVhZGVyLCBOVUwsIEtUWDJfSUQ7CiAgdmFyIGluaXRfa3R4X3BhcnNlX21vZGVybiA9IF9fZXNtKHsKICAgICJub2RlX21vZHVsZXMva3R4LXBhcnNlL2Rpc3Qva3R4LXBhcnNlLm1vZGVybi5qcyIoKSB7CiAgICAgIEtIUl9TVVBFUkNPTVBSRVNTSU9OX05PTkUgPSAwOwogICAgICBLSFJfREZfS0hSX0RFU0NSSVBUT1JUWVBFX0JBU0lDRk9STUFUID0gMDsKICAgICAgS0hSX0RGX1ZFTkRPUklEX0tIUk9OT1MgPSAwOwogICAgICBLSFJfREZfVkVSU0lPTiA9IDI7CiAgICAgIEtIUl9ERl9NT0RFTF9VTlNQRUNJRklFRCA9IDA7CiAgICAgIEtIUl9ERl9GTEFHX0FMUEhBX1NUUkFJR0hUID0gMDsKICAgICAgS0hSX0RGX1RSQU5TRkVSX1NSR0IgPSAyOwogICAgICBLSFJfREZfUFJJTUFSSUVTX0JUNzA5ID0gMTsKICAgICAgS0hSX0RGX1NBTVBMRV9EQVRBVFlQRV9TSUdORUQgPSA2NDsKICAgICAgVktfRk9STUFUX1VOREVGSU5FRCA9IDA7CiAgICAgIEtUWDJDb250YWluZXIgPSBjbGFzcyB7CiAgICAgICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgICB0aGlzLnZrRm9ybWF0ID0gVktfRk9STUFUX1VOREVGSU5FRDsKICAgICAgICAgIHRoaXMudHlwZVNpemUgPSAxOwogICAgICAgICAgdGhpcy5waXhlbFdpZHRoID0gMDsKICAgICAgICAgIHRoaXMucGl4ZWxIZWlnaHQgPSAwOwogICAgICAgICAgdGhpcy5waXhlbERlcHRoID0gMDsKICAgICAgICAgIHRoaXMubGF5ZXJDb3VudCA9IDA7CiAgICAgICAgICB0aGlzLmZhY2VDb3VudCA9IDE7CiAgICAgICAgICB0aGlzLnN1cGVyY29tcHJlc3Npb25TY2hlbWUgPSBLSFJfU1VQRVJDT01QUkVTU0lPTl9OT05FOwogICAgICAgICAgdGhpcy5sZXZlbHMgPSBbXTsKICAgICAgICAgIHRoaXMuZGF0YUZvcm1hdERlc2NyaXB0b3IgPSBbewogICAgICAgICAgICB2ZW5kb3JJZDogS0hSX0RGX1ZFTkRPUklEX0tIUk9OT1MsCiAgICAgICAgICAgIGRlc2NyaXB0b3JUeXBlOiBLSFJfREZfS0hSX0RFU0NSSVBUT1JUWVBFX0JBU0lDRk9STUFULAogICAgICAgICAgICBkZXNjcmlwdG9yQmxvY2tTaXplOiAwLAogICAgICAgICAgICB2ZXJzaW9uTnVtYmVyOiBLSFJfREZfVkVSU0lPTiwKICAgICAgICAgICAgY29sb3JNb2RlbDogS0hSX0RGX01PREVMX1VOU1BFQ0lGSUVELAogICAgICAgICAgICBjb2xvclByaW1hcmllczogS0hSX0RGX1BSSU1BUklFU19CVDcwOSwKICAgICAgICAgICAgdHJhbnNmZXJGdW5jdGlvbjogS0hSX0RGX1RSQU5TRkVSX1NSR0IsCiAgICAgICAgICAgIGZsYWdzOiBLSFJfREZfRkxBR19BTFBIQV9TVFJBSUdIVCwKICAgICAgICAgICAgdGV4ZWxCbG9ja0RpbWVuc2lvbjogWzAsIDAsIDAsIDBdLAogICAgICAgICAgICBieXRlc1BsYW5lOiBbMCwgMCwgMCwgMCwgMCwgMCwgMCwgMF0sCiAgICAgICAgICAgIHNhbXBsZXM6IFtdCiAgICAgICAgICB9XTsKICAgICAgICAgIHRoaXMua2V5VmFsdWUgPSB7fTsKICAgICAgICAgIHRoaXMuZ2xvYmFsRGF0YSA9IG51bGw7CiAgICAgICAgfQogICAgICB9OwogICAgICBCdWZmZXJSZWFkZXIgPSBjbGFzcyB7CiAgICAgICAgY29uc3RydWN0b3IoZGF0YSwgYnl0ZU9mZnNldCwgYnl0ZUxlbmd0aCwgbGl0dGxlRW5kaWFuMikgewogICAgICAgICAgdGhpcy5fZGF0YVZpZXcgPSB2b2lkIDA7CiAgICAgICAgICB0aGlzLl9saXR0bGVFbmRpYW4gPSB2b2lkIDA7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgPSB2b2lkIDA7CiAgICAgICAgICB0aGlzLl9kYXRhVmlldyA9IG5ldyBEYXRhVmlldyhkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0ICsgYnl0ZU9mZnNldCwgYnl0ZUxlbmd0aCk7CiAgICAgICAgICB0aGlzLl9saXR0bGVFbmRpYW4gPSBsaXR0bGVFbmRpYW4yOwogICAgICAgICAgdGhpcy5fb2Zmc2V0ID0gMDsKICAgICAgICB9CiAgICAgICAgX25leHRVaW50OCgpIHsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5fZGF0YVZpZXcuZ2V0VWludDgodGhpcy5fb2Zmc2V0KTsKICAgICAgICAgIHRoaXMuX29mZnNldCArPSAxOwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBfbmV4dFVpbnQxNigpIHsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5fZGF0YVZpZXcuZ2V0VWludDE2KHRoaXMuX29mZnNldCwgdGhpcy5fbGl0dGxlRW5kaWFuKTsKICAgICAgICAgIHRoaXMuX29mZnNldCArPSAyOwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBfbmV4dFVpbnQzMigpIHsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5fZGF0YVZpZXcuZ2V0VWludDMyKHRoaXMuX29mZnNldCwgdGhpcy5fbGl0dGxlRW5kaWFuKTsKICAgICAgICAgIHRoaXMuX29mZnNldCArPSA0OwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBfbmV4dFVpbnQ2NCgpIHsKICAgICAgICAgIGNvbnN0IGxlZnQgPSB0aGlzLl9kYXRhVmlldy5nZXRVaW50MzIodGhpcy5fb2Zmc2V0LCB0aGlzLl9saXR0bGVFbmRpYW4pOwogICAgICAgICAgY29uc3QgcmlnaHQgPSB0aGlzLl9kYXRhVmlldy5nZXRVaW50MzIodGhpcy5fb2Zmc2V0ICsgNCwgdGhpcy5fbGl0dGxlRW5kaWFuKTsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gbGVmdCArIDIgKiogMzIgKiByaWdodDsKICAgICAgICAgIHRoaXMuX29mZnNldCArPSA4OwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBfbmV4dEludDMyKCkgewogICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9kYXRhVmlldy5nZXRJbnQzMih0aGlzLl9vZmZzZXQsIHRoaXMuX2xpdHRsZUVuZGlhbik7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgKz0gNDsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgX25leHRVaW50OEFycmF5KGxlbikgewogICAgICAgICAgY29uc3QgdmFsdWUgPSBuZXcgVWludDhBcnJheSh0aGlzLl9kYXRhVmlldy5idWZmZXIsIHRoaXMuX2RhdGFWaWV3LmJ5dGVPZmZzZXQgKyB0aGlzLl9vZmZzZXQsIGxlbik7CiAgICAgICAgICB0aGlzLl9vZmZzZXQgKz0gbGVuOwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBfc2tpcChieXRlcykgewogICAgICAgICAgdGhpcy5fb2Zmc2V0ICs9IGJ5dGVzOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICAgIF9zY2FuKG1heEJ5dGVMZW5ndGgsIHRlcm0gPSAwKSB7CiAgICAgICAgICBjb25zdCBieXRlT2Zmc2V0ID0gdGhpcy5fb2Zmc2V0OwogICAgICAgICAgbGV0IGJ5dGVMZW5ndGggPSAwOwogICAgICAgICAgd2hpbGUgKHRoaXMuX2RhdGFWaWV3LmdldFVpbnQ4KHRoaXMuX29mZnNldCkgIT09IHRlcm0gJiYgYnl0ZUxlbmd0aCA8IG1heEJ5dGVMZW5ndGgpIHsKICAgICAgICAgICAgYnl0ZUxlbmd0aCsrOwogICAgICAgICAgICB0aGlzLl9vZmZzZXQrKzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChieXRlTGVuZ3RoIDwgbWF4Qnl0ZUxlbmd0aCkgdGhpcy5fb2Zmc2V0Kys7CiAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkodGhpcy5fZGF0YVZpZXcuYnVmZmVyLCB0aGlzLl9kYXRhVmlldy5ieXRlT2Zmc2V0ICsgYnl0ZU9mZnNldCwgYnl0ZUxlbmd0aCk7CiAgICAgICAgfQogICAgICB9OwogICAgICBOVUwgPSBuZXcgVWludDhBcnJheShbMF0pOwogICAgICBLVFgyX0lEID0gWwogICAgICAgIC8vICfCtCcsICdLJywgJ1QnLCAnWCcsICcyJywgJzAnLCAnwqonLCAnXHInLCAnXG4nLCAnXHgxQScsICdcbicKICAgICAgICAxNzEsCiAgICAgICAgNzUsCiAgICAgICAgODQsCiAgICAgICAgODgsCiAgICAgICAgMzIsCiAgICAgICAgNTAsCiAgICAgICAgNDgsCiAgICAgICAgMTg3LAogICAgICAgIDEzLAogICAgICAgIDEwLAogICAgICAgIDI2LAogICAgICAgIDEwCiAgICAgIF07CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvVGhpcmRQYXJ0eS9Xb3JrZXJzL2Jhc2lzX3RyYW5zY29kZXIuanMKICB2YXIgcmVxdWlyZV9iYXNpc190cmFuc2NvZGVyID0gX19jb21tb25KUyh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9UaGlyZFBhcnR5L1dvcmtlcnMvYmFzaXNfdHJhbnNjb2Rlci5qcyIoZXhwb3J0czIsIG1vZHVsZSkgewogICAgICB2YXIgQkFTSVMgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgX3NjcmlwdERpciA9IHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnQuY3VycmVudFNjcmlwdCA/IGRvY3VtZW50LmN1cnJlbnRTY3JpcHQuc3JjIDogdm9pZCAwOwogICAgICAgIGlmICh0eXBlb2YgX19maWxlbmFtZSAhPT0gInVuZGVmaW5lZCIpIF9zY3JpcHREaXIgPSBfc2NyaXB0RGlyIHx8IF9fZmlsZW5hbWU7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKEJBU0lTMikgewogICAgICAgICAgQkFTSVMyID0gQkFTSVMyIHx8IHt9OwogICAgICAgICAgdmFyIE1vZHVsZSA9IHR5cGVvZiBCQVNJUzIgIT09ICJ1bmRlZmluZWQiID8gQkFTSVMyIDoge307CiAgICAgICAgICB2YXIgcmVhZHlQcm9taXNlUmVzb2x2ZSwgcmVhZHlQcm9taXNlUmVqZWN0OwogICAgICAgICAgTW9kdWxlWyJyZWFkeSJdID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgIHJlYWR5UHJvbWlzZVJlc29sdmUgPSByZXNvbHZlOwogICAgICAgICAgICByZWFkeVByb21pc2VSZWplY3QgPSByZWplY3Q7CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBtb2R1bGVPdmVycmlkZXMgPSB7fTsKICAgICAgICAgIHZhciBrZXk7CiAgICAgICAgICBmb3IgKGtleSBpbiBNb2R1bGUpIHsKICAgICAgICAgICAgaWYgKE1vZHVsZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgbW9kdWxlT3ZlcnJpZGVzW2tleV0gPSBNb2R1bGVba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGFyZ3VtZW50c18gPSBbXTsKICAgICAgICAgIHZhciB0aGlzUHJvZ3JhbSA9ICIuL3RoaXMucHJvZ3JhbSI7CiAgICAgICAgICB2YXIgcXVpdF8gPSBmdW5jdGlvbihzdGF0dXMsIHRvVGhyb3cpIHsKICAgICAgICAgICAgdGhyb3cgdG9UaHJvdzsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgRU5WSVJPTk1FTlRfSVNfV0VCID0gZmFsc2U7CiAgICAgICAgICB2YXIgRU5WSVJPTk1FTlRfSVNfV09SS0VSID0gZmFsc2U7CiAgICAgICAgICB2YXIgRU5WSVJPTk1FTlRfSVNfTk9ERSA9IGZhbHNlOwogICAgICAgICAgdmFyIEVOVklST05NRU5UX0lTX1NIRUxMID0gZmFsc2U7CiAgICAgICAgICBFTlZJUk9OTUVOVF9JU19XRUIgPSB0eXBlb2Ygd2luZG93ID09PSAib2JqZWN0IjsKICAgICAgICAgIEVOVklST05NRU5UX0lTX1dPUktFUiA9IHR5cGVvZiBpbXBvcnRTY3JpcHRzID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgRU5WSVJPTk1FTlRfSVNfTk9ERSA9IHR5cGVvZiBwcm9jZXNzID09PSAib2JqZWN0IiAmJiB0eXBlb2YgcHJvY2Vzcy52ZXJzaW9ucyA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHByb2Nlc3MudmVyc2lvbnMubm9kZSA9PT0gInN0cmluZyI7CiAgICAgICAgICBFTlZJUk9OTUVOVF9JU19TSEVMTCA9ICFFTlZJUk9OTUVOVF9JU19XRUIgJiYgIUVOVklST05NRU5UX0lTX05PREUgJiYgIUVOVklST05NRU5UX0lTX1dPUktFUjsKICAgICAgICAgIHZhciBzY3JpcHREaXJlY3RvcnkgPSAiIjsKICAgICAgICAgIGZ1bmN0aW9uIGxvY2F0ZUZpbGUocGF0aCkgewogICAgICAgICAgICBpZiAoTW9kdWxlWyJsb2NhdGVGaWxlIl0pIHsKICAgICAgICAgICAgICByZXR1cm4gTW9kdWxlWyJsb2NhdGVGaWxlIl0ocGF0aCwgc2NyaXB0RGlyZWN0b3J5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2NyaXB0RGlyZWN0b3J5ICsgcGF0aDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZWFkXywgcmVhZEFzeW5jLCByZWFkQmluYXJ5LCBzZXRXaW5kb3dUaXRsZTsKICAgICAgICAgIHZhciBub2RlRlM7CiAgICAgICAgICB2YXIgbm9kZVBhdGg7CiAgICAgICAgICBpZiAoRU5WSVJPTk1FTlRfSVNfTk9ERSkgewogICAgICAgICAgICBpZiAoRU5WSVJPTk1FTlRfSVNfV09SS0VSKSB7CiAgICAgICAgICAgICAgc2NyaXB0RGlyZWN0b3J5ID0gX19yZXF1aXJlKCJwYXRoIikuZGlybmFtZShzY3JpcHREaXJlY3RvcnkpICsgIi8iOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNjcmlwdERpcmVjdG9yeSA9IF9fZGlybmFtZSArICIvIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWFkXyA9IGZ1bmN0aW9uIHNoZWxsX3JlYWQoZmlsZW5hbWUsIGJpbmFyeSkgewogICAgICAgICAgICAgIGlmICghbm9kZUZTKSBub2RlRlMgPSBfX3JlcXVpcmUoImZzIik7CiAgICAgICAgICAgICAgaWYgKCFub2RlUGF0aCkgbm9kZVBhdGggPSBfX3JlcXVpcmUoInBhdGgiKTsKICAgICAgICAgICAgICBmaWxlbmFtZSA9IG5vZGVQYXRoWyJub3JtYWxpemUiXShmaWxlbmFtZSk7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGVGU1sicmVhZEZpbGVTeW5jIl0oZmlsZW5hbWUsIGJpbmFyeSA/IG51bGwgOiAidXRmOCIpOwogICAgICAgICAgICB9OwogICAgICAgICAgICByZWFkQmluYXJ5ID0gZnVuY3Rpb24gcmVhZEJpbmFyeTIoZmlsZW5hbWUpIHsKICAgICAgICAgICAgICB2YXIgcmV0ID0gcmVhZF8oZmlsZW5hbWUsIHRydWUpOwogICAgICAgICAgICAgIGlmICghcmV0LmJ1ZmZlcikgewogICAgICAgICAgICAgICAgcmV0ID0gbmV3IFVpbnQ4QXJyYXkocmV0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXNzZXJ0KHJldC5idWZmZXIpOwogICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChwcm9jZXNzWyJhcmd2Il0ubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgIHRoaXNQcm9ncmFtID0gcHJvY2Vzc1siYXJndiJdWzFdLnJlcGxhY2UoL1xcL2csICIvIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXJndW1lbnRzXyA9IHByb2Nlc3NbImFyZ3YiXS5zbGljZSgyKTsKICAgICAgICAgICAgcHJvY2Vzc1sib24iXSgidW5jYXVnaHRFeGNlcHRpb24iLCBmdW5jdGlvbihleCkgewogICAgICAgICAgICAgIGlmICghKGV4IGluc3RhbmNlb2YgRXhpdFN0YXR1cykpIHsKICAgICAgICAgICAgICAgIHRocm93IGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHByb2Nlc3NbIm9uIl0oInVuaGFuZGxlZFJlamVjdGlvbiIsIGFib3J0KTsKICAgICAgICAgICAgcXVpdF8gPSBmdW5jdGlvbihzdGF0dXMpIHsKICAgICAgICAgICAgICBwcm9jZXNzWyJleGl0Il0oc3RhdHVzKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgTW9kdWxlWyJpbnNwZWN0Il0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gIltFbXNjcmlwdGVuIE1vZHVsZSBvYmplY3RdIjsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSBpZiAoRU5WSVJPTk1FTlRfSVNfU0hFTEwpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiByZWFkICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgcmVhZF8gPSBmdW5jdGlvbiBzaGVsbF9yZWFkKGYpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWFkKGYpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVhZEJpbmFyeSA9IGZ1bmN0aW9uIHJlYWRCaW5hcnkyKGYpIHsKICAgICAgICAgICAgICB2YXIgZGF0YTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlYWRidWZmZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShyZWFkYnVmZmVyKGYpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGF0YSA9IHJlYWQoZiwgImJpbmFyeSIpOwogICAgICAgICAgICAgIGFzc2VydCh0eXBlb2YgZGF0YSA9PT0gIm9iamVjdCIpOwogICAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAodHlwZW9mIHNjcmlwdEFyZ3MgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBhcmd1bWVudHNfID0gc2NyaXB0QXJnczsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJndW1lbnRzICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgYXJndW1lbnRzXyA9IGFyZ3VtZW50czsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHF1aXQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBxdWl0XyA9IGZ1bmN0aW9uKHN0YXR1cykgewogICAgICAgICAgICAgICAgcXVpdChzdGF0dXMpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBwcmludCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnNvbGUgPT09ICJ1bmRlZmluZWQiKSBjb25zb2xlID0ge307CiAgICAgICAgICAgICAgY29uc29sZS5sb2cgPSBwcmludDsKICAgICAgICAgICAgICBjb25zb2xlLndhcm4gPSBjb25zb2xlLmVycm9yID0gdHlwZW9mIHByaW50RXJyICE9PSAidW5kZWZpbmVkIiA/IHByaW50RXJyIDogcHJpbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoRU5WSVJPTk1FTlRfSVNfV0VCIHx8IEVOVklST05NRU5UX0lTX1dPUktFUikgewogICAgICAgICAgICBpZiAoRU5WSVJPTk1FTlRfSVNfV09SS0VSKSB7CiAgICAgICAgICAgICAgc2NyaXB0RGlyZWN0b3J5ID0gc2VsZi5sb2NhdGlvbi5ocmVmOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnQuY3VycmVudFNjcmlwdCkgewogICAgICAgICAgICAgIHNjcmlwdERpcmVjdG9yeSA9IGRvY3VtZW50LmN1cnJlbnRTY3JpcHQuc3JjOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChfc2NyaXB0RGlyKSB7CiAgICAgICAgICAgICAgc2NyaXB0RGlyZWN0b3J5ID0gX3NjcmlwdERpcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2NyaXB0RGlyZWN0b3J5LmluZGV4T2YoImJsb2I6IikgIT09IDApIHsKICAgICAgICAgICAgICBzY3JpcHREaXJlY3RvcnkgPSBzY3JpcHREaXJlY3Rvcnkuc3Vic3RyKDAsIHNjcmlwdERpcmVjdG9yeS5sYXN0SW5kZXhPZigiLyIpICsgMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2NyaXB0RGlyZWN0b3J5ID0gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHJlYWRfID0gZnVuY3Rpb24odXJsKSB7CiAgICAgICAgICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgICAgICAgICB4aHIub3BlbigiR0VUIiwgdXJsLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB4aHIuc2VuZChudWxsKTsKICAgICAgICAgICAgICAgIHJldHVybiB4aHIucmVzcG9uc2VUZXh0OwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYgKEVOVklST05NRU5UX0lTX1dPUktFUikgewogICAgICAgICAgICAgICAgcmVhZEJpbmFyeSA9IGZ1bmN0aW9uKHVybCkgewogICAgICAgICAgICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgICAgICAgICAgIHhoci5vcGVuKCJHRVQiLCB1cmwsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9ICJhcnJheWJ1ZmZlciI7CiAgICAgICAgICAgICAgICAgIHhoci5zZW5kKG51bGwpOwogICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoeGhyLnJlc3BvbnNlKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlYWRBc3luYyA9IGZ1bmN0aW9uKHVybCwgb25sb2FkLCBvbmVycm9yKSB7CiAgICAgICAgICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgICAgICAgICB4aHIub3BlbigiR0VUIiwgdXJsLCB0cnVlKTsKICAgICAgICAgICAgICAgIHhoci5yZXNwb25zZVR5cGUgPSAiYXJyYXlidWZmZXIiOwogICAgICAgICAgICAgICAgeGhyLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAoeGhyLnN0YXR1cyA9PSAyMDAgfHwgeGhyLnN0YXR1cyA9PSAwICYmIHhoci5yZXNwb25zZSkgewogICAgICAgICAgICAgICAgICAgIG9ubG9hZCh4aHIucmVzcG9uc2UpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBvbmVycm9yKCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgeGhyLm9uZXJyb3IgPSBvbmVycm9yOwogICAgICAgICAgICAgICAgeGhyLnNlbmQobnVsbCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRXaW5kb3dUaXRsZSA9IGZ1bmN0aW9uKHRpdGxlKSB7CiAgICAgICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSB0aXRsZTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgb3V0ID0gTW9kdWxlWyJwcmludCJdIHx8IGNvbnNvbGUubG9nLmJpbmQoY29uc29sZSk7CiAgICAgICAgICB2YXIgZXJyID0gTW9kdWxlWyJwcmludEVyciJdIHx8IGNvbnNvbGUud2Fybi5iaW5kKGNvbnNvbGUpOwogICAgICAgICAgZm9yIChrZXkgaW4gbW9kdWxlT3ZlcnJpZGVzKSB7CiAgICAgICAgICAgIGlmIChtb2R1bGVPdmVycmlkZXMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgIE1vZHVsZVtrZXldID0gbW9kdWxlT3ZlcnJpZGVzW2tleV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1vZHVsZU92ZXJyaWRlcyA9IG51bGw7CiAgICAgICAgICBpZiAoTW9kdWxlWyJhcmd1bWVudHMiXSkgYXJndW1lbnRzXyA9IE1vZHVsZVsiYXJndW1lbnRzIl07CiAgICAgICAgICBpZiAoTW9kdWxlWyJ0aGlzUHJvZ3JhbSJdKSB0aGlzUHJvZ3JhbSA9IE1vZHVsZVsidGhpc1Byb2dyYW0iXTsKICAgICAgICAgIGlmIChNb2R1bGVbInF1aXQiXSkgcXVpdF8gPSBNb2R1bGVbInF1aXQiXTsKICAgICAgICAgIHZhciB0ZW1wUmV0MCA9IDA7CiAgICAgICAgICB2YXIgc2V0VGVtcFJldDAgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICB0ZW1wUmV0MCA9IHZhbHVlOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXNtQmluYXJ5OwogICAgICAgICAgaWYgKE1vZHVsZVsid2FzbUJpbmFyeSJdKSB3YXNtQmluYXJ5ID0gTW9kdWxlWyJ3YXNtQmluYXJ5Il07CiAgICAgICAgICB2YXIgbm9FeGl0UnVudGltZSA9IE1vZHVsZVsibm9FeGl0UnVudGltZSJdIHx8IHRydWU7CiAgICAgICAgICBpZiAodHlwZW9mIFdlYkFzc2VtYmx5ICE9PSAib2JqZWN0IikgewogICAgICAgICAgICBhYm9ydCgibm8gbmF0aXZlIHdhc20gc3VwcG9ydCBkZXRlY3RlZCIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdhc21NZW1vcnk7CiAgICAgICAgICB2YXIgQUJPUlQgPSBmYWxzZTsKICAgICAgICAgIHZhciBFWElUU1RBVFVTOwogICAgICAgICAgZnVuY3Rpb24gYXNzZXJ0KGNvbmRpdGlvbiwgdGV4dCkgewogICAgICAgICAgICBpZiAoIWNvbmRpdGlvbikgewogICAgICAgICAgICAgIGFib3J0KCJBc3NlcnRpb24gZmFpbGVkOiAiICsgdGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBVVEY4RGVjb2RlciA9IHR5cGVvZiBUZXh0RGVjb2RlciAhPT0gInVuZGVmaW5lZCIgPyBuZXcgVGV4dERlY29kZXIoInV0ZjgiKSA6IHZvaWQgMDsKICAgICAgICAgIGZ1bmN0aW9uIFVURjhBcnJheVRvU3RyaW5nKGhlYXAsIGlkeCwgbWF4Qnl0ZXNUb1JlYWQpIHsKICAgICAgICAgICAgdmFyIGVuZElkeCA9IGlkeCArIG1heEJ5dGVzVG9SZWFkOwogICAgICAgICAgICB2YXIgZW5kUHRyID0gaWR4OwogICAgICAgICAgICB3aGlsZSAoaGVhcFtlbmRQdHJdICYmICEoZW5kUHRyID49IGVuZElkeCkpICsrZW5kUHRyOwogICAgICAgICAgICBpZiAoZW5kUHRyIC0gaWR4ID4gMTYgJiYgaGVhcC5zdWJhcnJheSAmJiBVVEY4RGVjb2RlcikgewogICAgICAgICAgICAgIHJldHVybiBVVEY4RGVjb2Rlci5kZWNvZGUoaGVhcC5zdWJhcnJheShpZHgsIGVuZFB0cikpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBzdHIgPSAiIjsKICAgICAgICAgICAgICB3aGlsZSAoaWR4IDwgZW5kUHRyKSB7CiAgICAgICAgICAgICAgICB2YXIgdTAgPSBoZWFwW2lkeCsrXTsKICAgICAgICAgICAgICAgIGlmICghKHUwICYgMTI4KSkgewogICAgICAgICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSh1MCk7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHUxMiA9IGhlYXBbaWR4KytdICYgNjM7CiAgICAgICAgICAgICAgICBpZiAoKHUwICYgMjI0KSA9PSAxOTIpIHsKICAgICAgICAgICAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKHUwICYgMzEpIDw8IDYgfCB1MTIpOwogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciB1MjIgPSBoZWFwW2lkeCsrXSAmIDYzOwogICAgICAgICAgICAgICAgaWYgKCh1MCAmIDI0MCkgPT0gMjI0KSB7CiAgICAgICAgICAgICAgICAgIHUwID0gKHUwICYgMTUpIDw8IDEyIHwgdTEyIDw8IDYgfCB1MjI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB1MCA9ICh1MCAmIDcpIDw8IDE4IHwgdTEyIDw8IDEyIHwgdTIyIDw8IDYgfCBoZWFwW2lkeCsrXSAmIDYzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHUwIDwgNjU1MzYpIHsKICAgICAgICAgICAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUodTApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIGNoID0gdTAgLSA2NTUzNjsKICAgICAgICAgICAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoNTUyOTYgfCBjaCA+PiAxMCwgNTYzMjAgfCBjaCAmIDEwMjMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gVVRGOFRvU3RyaW5nKHB0ciwgbWF4Qnl0ZXNUb1JlYWQpIHsKICAgICAgICAgICAgcmV0dXJuIHB0ciA/IFVURjhBcnJheVRvU3RyaW5nKEhFQVBVOCwgcHRyLCBtYXhCeXRlc1RvUmVhZCkgOiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHN0cmluZ1RvVVRGOEFycmF5KHN0ciwgaGVhcCwgb3V0SWR4LCBtYXhCeXRlc1RvV3JpdGUpIHsKICAgICAgICAgICAgaWYgKCEobWF4Qnl0ZXNUb1dyaXRlID4gMCkpIHJldHVybiAwOwogICAgICAgICAgICB2YXIgc3RhcnRJZHggPSBvdXRJZHg7CiAgICAgICAgICAgIHZhciBlbmRJZHggPSBvdXRJZHggKyBtYXhCeXRlc1RvV3JpdGUgLSAxOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgIHZhciB1MyA9IHN0ci5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICAgIGlmICh1MyA+PSA1NTI5NiAmJiB1MyA8PSA1NzM0MykgewogICAgICAgICAgICAgICAgdmFyIHUxMiA9IHN0ci5jaGFyQ29kZUF0KCsraSk7CiAgICAgICAgICAgICAgICB1MyA9IDY1NTM2ICsgKCh1MyAmIDEwMjMpIDw8IDEwKSB8IHUxMiAmIDEwMjM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh1MyA8PSAxMjcpIHsKICAgICAgICAgICAgICAgIGlmIChvdXRJZHggPj0gZW5kSWR4KSBicmVhazsKICAgICAgICAgICAgICAgIGhlYXBbb3V0SWR4KytdID0gdTM7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh1MyA8PSAyMDQ3KSB7CiAgICAgICAgICAgICAgICBpZiAob3V0SWR4ICsgMSA+PSBlbmRJZHgpIGJyZWFrOwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxOTIgfCB1MyA+PiA2OwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1MyAmIDYzOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodTMgPD0gNjU1MzUpIHsKICAgICAgICAgICAgICAgIGlmIChvdXRJZHggKyAyID49IGVuZElkeCkgYnJlYWs7CiAgICAgICAgICAgICAgICBoZWFwW291dElkeCsrXSA9IDIyNCB8IHUzID4+IDEyOwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1MyA+PiA2ICYgNjM7CiAgICAgICAgICAgICAgICBoZWFwW291dElkeCsrXSA9IDEyOCB8IHUzICYgNjM7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChvdXRJZHggKyAzID49IGVuZElkeCkgYnJlYWs7CiAgICAgICAgICAgICAgICBoZWFwW291dElkeCsrXSA9IDI0MCB8IHUzID4+IDE4OwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1MyA+PiAxMiAmIDYzOwogICAgICAgICAgICAgICAgaGVhcFtvdXRJZHgrK10gPSAxMjggfCB1MyA+PiA2ICYgNjM7CiAgICAgICAgICAgICAgICBoZWFwW291dElkeCsrXSA9IDEyOCB8IHUzICYgNjM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGhlYXBbb3V0SWR4XSA9IDA7CiAgICAgICAgICAgIHJldHVybiBvdXRJZHggLSBzdGFydElkeDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHN0cmluZ1RvVVRGOChzdHIsIG91dFB0ciwgbWF4Qnl0ZXNUb1dyaXRlKSB7CiAgICAgICAgICAgIHJldHVybiBzdHJpbmdUb1VURjhBcnJheShzdHIsIEhFQVBVOCwgb3V0UHRyLCBtYXhCeXRlc1RvV3JpdGUpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbGVuZ3RoQnl0ZXNVVEY4KHN0cikgewogICAgICAgICAgICB2YXIgbGVuID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICB2YXIgdTMgPSBzdHIuY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgICBpZiAodTMgPj0gNTUyOTYgJiYgdTMgPD0gNTczNDMpIHUzID0gNjU1MzYgKyAoKHUzICYgMTAyMykgPDwgMTApIHwgc3RyLmNoYXJDb2RlQXQoKytpKSAmIDEwMjM7CiAgICAgICAgICAgICAgaWYgKHUzIDw9IDEyNykgKytsZW47CiAgICAgICAgICAgICAgZWxzZSBpZiAodTMgPD0gMjA0NykgbGVuICs9IDI7CiAgICAgICAgICAgICAgZWxzZSBpZiAodTMgPD0gNjU1MzUpIGxlbiArPSAzOwogICAgICAgICAgICAgIGVsc2UgbGVuICs9IDQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlbjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBVVEYxNkRlY29kZXIgPSB0eXBlb2YgVGV4dERlY29kZXIgIT09ICJ1bmRlZmluZWQiID8gbmV3IFRleHREZWNvZGVyKCJ1dGYtMTZsZSIpIDogdm9pZCAwOwogICAgICAgICAgZnVuY3Rpb24gVVRGMTZUb1N0cmluZyhwdHIsIG1heEJ5dGVzVG9SZWFkKSB7CiAgICAgICAgICAgIHZhciBlbmRQdHIgPSBwdHI7CiAgICAgICAgICAgIHZhciBpZHggPSBlbmRQdHIgPj4gMTsKICAgICAgICAgICAgdmFyIG1heElkeCA9IGlkeCArIG1heEJ5dGVzVG9SZWFkIC8gMjsKICAgICAgICAgICAgd2hpbGUgKCEoaWR4ID49IG1heElkeCkgJiYgSEVBUFUxNltpZHhdKSArK2lkeDsKICAgICAgICAgICAgZW5kUHRyID0gaWR4IDw8IDE7CiAgICAgICAgICAgIGlmIChlbmRQdHIgLSBwdHIgPiAzMiAmJiBVVEYxNkRlY29kZXIpIHsKICAgICAgICAgICAgICByZXR1cm4gVVRGMTZEZWNvZGVyLmRlY29kZShIRUFQVTguc3ViYXJyYXkocHRyLCBlbmRQdHIpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgc3RyID0gIiI7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7ICEoaSA+PSBtYXhCeXRlc1RvUmVhZCAvIDIpOyArK2kpIHsKICAgICAgICAgICAgICAgIHZhciBjb2RlVW5pdCA9IEhFQVAxNltwdHIgKyBpICogMiA+PiAxXTsKICAgICAgICAgICAgICAgIGlmIChjb2RlVW5pdCA9PSAwKSBicmVhazsKICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGNvZGVVbml0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc3RyaW5nVG9VVEYxNihzdHIsIG91dFB0ciwgbWF4Qnl0ZXNUb1dyaXRlKSB7CiAgICAgICAgICAgIGlmIChtYXhCeXRlc1RvV3JpdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIG1heEJ5dGVzVG9Xcml0ZSA9IDIxNDc0ODM2NDc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1heEJ5dGVzVG9Xcml0ZSA8IDIpIHJldHVybiAwOwogICAgICAgICAgICBtYXhCeXRlc1RvV3JpdGUgLT0gMjsKICAgICAgICAgICAgdmFyIHN0YXJ0UHRyID0gb3V0UHRyOwogICAgICAgICAgICB2YXIgbnVtQ2hhcnNUb1dyaXRlID0gbWF4Qnl0ZXNUb1dyaXRlIDwgc3RyLmxlbmd0aCAqIDIgPyBtYXhCeXRlc1RvV3JpdGUgLyAyIDogc3RyLmxlbmd0aDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBudW1DaGFyc1RvV3JpdGU7ICsraSkgewogICAgICAgICAgICAgIHZhciBjb2RlVW5pdCA9IHN0ci5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICAgIEhFQVAxNltvdXRQdHIgPj4gMV0gPSBjb2RlVW5pdDsKICAgICAgICAgICAgICBvdXRQdHIgKz0gMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBIRUFQMTZbb3V0UHRyID4+IDFdID0gMDsKICAgICAgICAgICAgcmV0dXJuIG91dFB0ciAtIHN0YXJ0UHRyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbGVuZ3RoQnl0ZXNVVEYxNihzdHIpIHsKICAgICAgICAgICAgcmV0dXJuIHN0ci5sZW5ndGggKiAyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gVVRGMzJUb1N0cmluZyhwdHIsIG1heEJ5dGVzVG9SZWFkKSB7CiAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgdmFyIHN0ciA9ICIiOwogICAgICAgICAgICB3aGlsZSAoIShpID49IG1heEJ5dGVzVG9SZWFkIC8gNCkpIHsKICAgICAgICAgICAgICB2YXIgdXRmMzIgPSBIRUFQMzJbcHRyICsgaSAqIDQgPj4gMl07CiAgICAgICAgICAgICAgaWYgKHV0ZjMyID09IDApIGJyZWFrOwogICAgICAgICAgICAgICsraTsKICAgICAgICAgICAgICBpZiAodXRmMzIgPj0gNjU1MzYpIHsKICAgICAgICAgICAgICAgIHZhciBjaCA9IHV0ZjMyIC0gNjU1MzY7CiAgICAgICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSg1NTI5NiB8IGNoID4+IDEwLCA1NjMyMCB8IGNoICYgMTAyMyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHV0ZjMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHN0cmluZ1RvVVRGMzIoc3RyLCBvdXRQdHIsIG1heEJ5dGVzVG9Xcml0ZSkgewogICAgICAgICAgICBpZiAobWF4Qnl0ZXNUb1dyaXRlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBtYXhCeXRlc1RvV3JpdGUgPSAyMTQ3NDgzNjQ3OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtYXhCeXRlc1RvV3JpdGUgPCA0KSByZXR1cm4gMDsKICAgICAgICAgICAgdmFyIHN0YXJ0UHRyID0gb3V0UHRyOwogICAgICAgICAgICB2YXIgZW5kUHRyID0gc3RhcnRQdHIgKyBtYXhCeXRlc1RvV3JpdGUgLSA0OwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgIHZhciBjb2RlVW5pdCA9IHN0ci5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICAgIGlmIChjb2RlVW5pdCA+PSA1NTI5NiAmJiBjb2RlVW5pdCA8PSA1NzM0MykgewogICAgICAgICAgICAgICAgdmFyIHRyYWlsU3Vycm9nYXRlID0gc3RyLmNoYXJDb2RlQXQoKytpKTsKICAgICAgICAgICAgICAgIGNvZGVVbml0ID0gNjU1MzYgKyAoKGNvZGVVbml0ICYgMTAyMykgPDwgMTApIHwgdHJhaWxTdXJyb2dhdGUgJiAxMDIzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBIRUFQMzJbb3V0UHRyID4+IDJdID0gY29kZVVuaXQ7CiAgICAgICAgICAgICAgb3V0UHRyICs9IDQ7CiAgICAgICAgICAgICAgaWYgKG91dFB0ciArIDQgPiBlbmRQdHIpIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEhFQVAzMltvdXRQdHIgPj4gMl0gPSAwOwogICAgICAgICAgICByZXR1cm4gb3V0UHRyIC0gc3RhcnRQdHI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBsZW5ndGhCeXRlc1VURjMyKHN0cikgewogICAgICAgICAgICB2YXIgbGVuID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICB2YXIgY29kZVVuaXQgPSBzdHIuY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgICBpZiAoY29kZVVuaXQgPj0gNTUyOTYgJiYgY29kZVVuaXQgPD0gNTczNDMpICsraTsKICAgICAgICAgICAgICBsZW4gKz0gNDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGVuOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYWxpZ25VcCh4LCBtdWx0aXBsZSkgewogICAgICAgICAgICBpZiAoeCAlIG11bHRpcGxlID4gMCkgewogICAgICAgICAgICAgIHggKz0gbXVsdGlwbGUgLSB4ICUgbXVsdGlwbGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHg7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgYnVmZmVyLCBIRUFQOCwgSEVBUFU4LCBIRUFQMTYsIEhFQVBVMTYsIEhFQVAzMiwgSEVBUFUzMiwgSEVBUEYzMiwgSEVBUEY2NDsKICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUdsb2JhbEJ1ZmZlckFuZFZpZXdzKGJ1ZikgewogICAgICAgICAgICBidWZmZXIgPSBidWY7CiAgICAgICAgICAgIE1vZHVsZVsiSEVBUDgiXSA9IEhFQVA4ID0gbmV3IEludDhBcnJheShidWYpOwogICAgICAgICAgICBNb2R1bGVbIkhFQVAxNiJdID0gSEVBUDE2ID0gbmV3IEludDE2QXJyYXkoYnVmKTsKICAgICAgICAgICAgTW9kdWxlWyJIRUFQMzIiXSA9IEhFQVAzMiA9IG5ldyBJbnQzMkFycmF5KGJ1Zik7CiAgICAgICAgICAgIE1vZHVsZVsiSEVBUFU4Il0gPSBIRUFQVTggPSBuZXcgVWludDhBcnJheShidWYpOwogICAgICAgICAgICBNb2R1bGVbIkhFQVBVMTYiXSA9IEhFQVBVMTYgPSBuZXcgVWludDE2QXJyYXkoYnVmKTsKICAgICAgICAgICAgTW9kdWxlWyJIRUFQVTMyIl0gPSBIRUFQVTMyID0gbmV3IFVpbnQzMkFycmF5KGJ1Zik7CiAgICAgICAgICAgIE1vZHVsZVsiSEVBUEYzMiJdID0gSEVBUEYzMiA9IG5ldyBGbG9hdDMyQXJyYXkoYnVmKTsKICAgICAgICAgICAgTW9kdWxlWyJIRUFQRjY0Il0gPSBIRUFQRjY0ID0gbmV3IEZsb2F0NjRBcnJheShidWYpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIElOSVRJQUxfTUVNT1JZID0gTW9kdWxlWyJJTklUSUFMX01FTU9SWSJdIHx8IDE2Nzc3MjE2OwogICAgICAgICAgdmFyIHdhc21UYWJsZTsKICAgICAgICAgIHZhciBfX0FUUFJFUlVOX18gPSBbXTsKICAgICAgICAgIHZhciBfX0FUSU5JVF9fID0gW107CiAgICAgICAgICB2YXIgX19BVE1BSU5fXyA9IFtdOwogICAgICAgICAgdmFyIF9fQVRQT1NUUlVOX18gPSBbXTsKICAgICAgICAgIHZhciBydW50aW1lSW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAgICAgICAgIGZ1bmN0aW9uIHByZVJ1bigpIHsKICAgICAgICAgICAgaWYgKE1vZHVsZVsicHJlUnVuIl0pIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIE1vZHVsZVsicHJlUnVuIl0gPT0gImZ1bmN0aW9uIikgTW9kdWxlWyJwcmVSdW4iXSA9IFtNb2R1bGVbInByZVJ1biJdXTsKICAgICAgICAgICAgICB3aGlsZSAoTW9kdWxlWyJwcmVSdW4iXS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGFkZE9uUHJlUnVuKE1vZHVsZVsicHJlUnVuIl0uc2hpZnQoKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxSdW50aW1lQ2FsbGJhY2tzKF9fQVRQUkVSVU5fXyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbml0UnVudGltZSgpIHsKICAgICAgICAgICAgcnVudGltZUluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICAgICAgY2FsbFJ1bnRpbWVDYWxsYmFja3MoX19BVElOSVRfXyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwcmVNYWluKCkgewogICAgICAgICAgICBjYWxsUnVudGltZUNhbGxiYWNrcyhfX0FUTUFJTl9fKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBvc3RSdW4oKSB7CiAgICAgICAgICAgIGlmIChNb2R1bGVbInBvc3RSdW4iXSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgTW9kdWxlWyJwb3N0UnVuIl0gPT0gImZ1bmN0aW9uIikgTW9kdWxlWyJwb3N0UnVuIl0gPSBbTW9kdWxlWyJwb3N0UnVuIl1dOwogICAgICAgICAgICAgIHdoaWxlIChNb2R1bGVbInBvc3RSdW4iXS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGFkZE9uUG9zdFJ1bihNb2R1bGVbInBvc3RSdW4iXS5zaGlmdCgpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FsbFJ1bnRpbWVDYWxsYmFja3MoX19BVFBPU1RSVU5fXyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhZGRPblByZVJ1bihjYikgewogICAgICAgICAgICBfX0FUUFJFUlVOX18udW5zaGlmdChjYik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBhZGRPbkluaXQoY2IpIHsKICAgICAgICAgICAgX19BVElOSVRfXy51bnNoaWZ0KGNiKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGFkZE9uUG9zdFJ1bihjYikgewogICAgICAgICAgICBfX0FUUE9TVFJVTl9fLnVuc2hpZnQoY2IpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJ1bkRlcGVuZGVuY2llcyA9IDA7CiAgICAgICAgICB2YXIgcnVuRGVwZW5kZW5jeVdhdGNoZXIgPSBudWxsOwogICAgICAgICAgdmFyIGRlcGVuZGVuY2llc0Z1bGZpbGxlZCA9IG51bGw7CiAgICAgICAgICBmdW5jdGlvbiBhZGRSdW5EZXBlbmRlbmN5KGlkKSB7CiAgICAgICAgICAgIHJ1bkRlcGVuZGVuY2llcysrOwogICAgICAgICAgICBpZiAoTW9kdWxlWyJtb25pdG9yUnVuRGVwZW5kZW5jaWVzIl0pIHsKICAgICAgICAgICAgICBNb2R1bGVbIm1vbml0b3JSdW5EZXBlbmRlbmNpZXMiXShydW5EZXBlbmRlbmNpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZW1vdmVSdW5EZXBlbmRlbmN5KGlkKSB7CiAgICAgICAgICAgIHJ1bkRlcGVuZGVuY2llcy0tOwogICAgICAgICAgICBpZiAoTW9kdWxlWyJtb25pdG9yUnVuRGVwZW5kZW5jaWVzIl0pIHsKICAgICAgICAgICAgICBNb2R1bGVbIm1vbml0b3JSdW5EZXBlbmRlbmNpZXMiXShydW5EZXBlbmRlbmNpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChydW5EZXBlbmRlbmNpZXMgPT0gMCkgewogICAgICAgICAgICAgIGlmIChydW5EZXBlbmRlbmN5V2F0Y2hlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChydW5EZXBlbmRlbmN5V2F0Y2hlcik7CiAgICAgICAgICAgICAgICBydW5EZXBlbmRlbmN5V2F0Y2hlciA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkZXBlbmRlbmNpZXNGdWxmaWxsZWQpIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGRlcGVuZGVuY2llc0Z1bGZpbGxlZDsKICAgICAgICAgICAgICAgIGRlcGVuZGVuY2llc0Z1bGZpbGxlZCA9IG51bGw7CiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgTW9kdWxlWyJwcmVsb2FkZWRJbWFnZXMiXSA9IHt9OwogICAgICAgICAgTW9kdWxlWyJwcmVsb2FkZWRBdWRpb3MiXSA9IHt9OwogICAgICAgICAgZnVuY3Rpb24gYWJvcnQod2hhdCkgewogICAgICAgICAgICBpZiAoTW9kdWxlWyJvbkFib3J0Il0pIHsKICAgICAgICAgICAgICBNb2R1bGVbIm9uQWJvcnQiXSh3aGF0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGF0ICs9ICIiOwogICAgICAgICAgICBlcnIod2hhdCk7CiAgICAgICAgICAgIEFCT1JUID0gdHJ1ZTsKICAgICAgICAgICAgRVhJVFNUQVRVUyA9IDE7CiAgICAgICAgICAgIHdoYXQgPSAiYWJvcnQoIiArIHdoYXQgKyAiKS4gQnVpbGQgd2l0aCAtcyBBU1NFUlRJT05TPTEgZm9yIG1vcmUgaW5mby4iOwogICAgICAgICAgICB2YXIgZSA9IG5ldyBXZWJBc3NlbWJseS5SdW50aW1lRXJyb3Iod2hhdCk7CiAgICAgICAgICAgIHJlYWR5UHJvbWlzZVJlamVjdChlKTsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGhhc1ByZWZpeChzdHIsIHByZWZpeCkgewogICAgICAgICAgICByZXR1cm4gU3RyaW5nLnByb3RvdHlwZS5zdGFydHNXaXRoID8gc3RyLnN0YXJ0c1dpdGgocHJlZml4KSA6IHN0ci5pbmRleE9mKHByZWZpeCkgPT09IDA7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGF0YVVSSVByZWZpeCA9ICJkYXRhOmFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbTtiYXNlNjQsIjsKICAgICAgICAgIGZ1bmN0aW9uIGlzRGF0YVVSSShmaWxlbmFtZSkgewogICAgICAgICAgICByZXR1cm4gaGFzUHJlZml4KGZpbGVuYW1lLCBkYXRhVVJJUHJlZml4KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWxlVVJJUHJlZml4ID0gImZpbGU6Ly8iOwogICAgICAgICAgZnVuY3Rpb24gaXNGaWxlVVJJKGZpbGVuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBoYXNQcmVmaXgoZmlsZW5hbWUsIGZpbGVVUklQcmVmaXgpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdhc21CaW5hcnlGaWxlID0gImJhc2lzX3RyYW5zY29kZXIud2FzbSI7CiAgICAgICAgICBpZiAoIWlzRGF0YVVSSSh3YXNtQmluYXJ5RmlsZSkpIHsKICAgICAgICAgICAgd2FzbUJpbmFyeUZpbGUgPSBsb2NhdGVGaWxlKHdhc21CaW5hcnlGaWxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldEJpbmFyeShmaWxlKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKGZpbGUgPT0gd2FzbUJpbmFyeUZpbGUgJiYgd2FzbUJpbmFyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHdhc21CaW5hcnkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVhZEJpbmFyeSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlYWRCaW5hcnkoZmlsZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93ICJib3RoIGFzeW5jIGFuZCBzeW5jIGZldGNoaW5nIG9mIHRoZSB3YXNtIGZhaWxlZCI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlcnIyKSB7CiAgICAgICAgICAgICAgYWJvcnQoZXJyMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldEJpbmFyeVByb21pc2UoKSB7CiAgICAgICAgICAgIGlmICghd2FzbUJpbmFyeSAmJiAoRU5WSVJPTk1FTlRfSVNfV0VCIHx8IEVOVklST05NRU5UX0lTX1dPUktFUikpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGZldGNoID09PSAiZnVuY3Rpb24iICYmICFpc0ZpbGVVUkkod2FzbUJpbmFyeUZpbGUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmV0Y2god2FzbUJpbmFyeUZpbGUsIHsgY3JlZGVudGlhbHM6ICJzYW1lLW9yaWdpbiIgfSkudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICBpZiAoIXJlc3BvbnNlWyJvayJdKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgImZhaWxlZCB0byBsb2FkIHdhc20gYmluYXJ5IGZpbGUgYXQgJyIgKyB3YXNtQmluYXJ5RmlsZSArICInIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VbImFycmF5QnVmZmVyIl0oKTsKICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0QmluYXJ5KHdhc21CaW5hcnlGaWxlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAocmVhZEFzeW5jKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgICByZWFkQXN5bmMod2FzbUJpbmFyeUZpbGUsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG5ldyBVaW50OEFycmF5KHJlc3BvbnNlKSk7CiAgICAgICAgICAgICAgICAgICAgfSwgcmVqZWN0KTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBnZXRCaW5hcnkod2FzbUJpbmFyeUZpbGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVdhc20oKSB7CiAgICAgICAgICAgIHZhciBpbmZvID0geyAiYSI6IGFzbUxpYnJhcnlBcmcgfTsKICAgICAgICAgICAgZnVuY3Rpb24gcmVjZWl2ZUluc3RhbmNlKGluc3RhbmNlLCBtb2R1bGUyKSB7CiAgICAgICAgICAgICAgdmFyIGV4cG9ydHM0ID0gaW5zdGFuY2UuZXhwb3J0czsKICAgICAgICAgICAgICBNb2R1bGVbImFzbSJdID0gZXhwb3J0czQ7CiAgICAgICAgICAgICAgd2FzbU1lbW9yeSA9IE1vZHVsZVsiYXNtIl1bIksiXTsKICAgICAgICAgICAgICB1cGRhdGVHbG9iYWxCdWZmZXJBbmRWaWV3cyh3YXNtTWVtb3J5LmJ1ZmZlcik7CiAgICAgICAgICAgICAgd2FzbVRhYmxlID0gTW9kdWxlWyJhc20iXVsiTyJdOwogICAgICAgICAgICAgIGFkZE9uSW5pdChNb2R1bGVbImFzbSJdWyJMIl0pOwogICAgICAgICAgICAgIHJlbW92ZVJ1bkRlcGVuZGVuY3koIndhc20taW5zdGFudGlhdGUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhZGRSdW5EZXBlbmRlbmN5KCJ3YXNtLWluc3RhbnRpYXRlIik7CiAgICAgICAgICAgIGZ1bmN0aW9uIHJlY2VpdmVJbnN0YW50aWF0ZWRTb3VyY2Uob3V0cHV0KSB7CiAgICAgICAgICAgICAgcmVjZWl2ZUluc3RhbmNlKG91dHB1dFsiaW5zdGFuY2UiXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gaW5zdGFudGlhdGVBcnJheUJ1ZmZlcihyZWNlaXZlcikgewogICAgICAgICAgICAgIHJldHVybiBnZXRCaW5hcnlQcm9taXNlKCkudGhlbihmdW5jdGlvbihiaW5hcnkpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBXZWJBc3NlbWJseS5pbnN0YW50aWF0ZShiaW5hcnksIGluZm8pOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICB9KS50aGVuKHJlY2VpdmVyLCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgICAgICAgIGVycigiZmFpbGVkIHRvIGFzeW5jaHJvbm91c2x5IHByZXBhcmUgd2FzbTogIiArIHJlYXNvbik7CiAgICAgICAgICAgICAgICBhYm9ydChyZWFzb24pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGluc3RhbnRpYXRlQXN5bmMoKSB7CiAgICAgICAgICAgICAgaWYgKCF3YXNtQmluYXJ5ICYmIHR5cGVvZiBXZWJBc3NlbWJseS5pbnN0YW50aWF0ZVN0cmVhbWluZyA9PT0gImZ1bmN0aW9uIiAmJiAhaXNEYXRhVVJJKHdhc21CaW5hcnlGaWxlKSAmJiAhaXNGaWxlVVJJKHdhc21CaW5hcnlGaWxlKSAmJiB0eXBlb2YgZmV0Y2ggPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmZXRjaCh3YXNtQmluYXJ5RmlsZSwgeyBjcmVkZW50aWFsczogInNhbWUtb3JpZ2luIiB9KS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBXZWJBc3NlbWJseS5pbnN0YW50aWF0ZVN0cmVhbWluZyhyZXNwb25zZSwgaW5mbyk7CiAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQudGhlbihyZWNlaXZlSW5zdGFudGlhdGVkU291cmNlLCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgICAgICAgICAgICBlcnIoIndhc20gc3RyZWFtaW5nIGNvbXBpbGUgZmFpbGVkOiAiICsgcmVhc29uKTsKICAgICAgICAgICAgICAgICAgICBlcnIoImZhbGxpbmcgYmFjayB0byBBcnJheUJ1ZmZlciBpbnN0YW50aWF0aW9uIik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbnRpYXRlQXJyYXlCdWZmZXIocmVjZWl2ZUluc3RhbnRpYXRlZFNvdXJjZSk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW50aWF0ZUFycmF5QnVmZmVyKHJlY2VpdmVJbnN0YW50aWF0ZWRTb3VyY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoTW9kdWxlWyJpbnN0YW50aWF0ZVdhc20iXSkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB2YXIgZXhwb3J0czMgPSBNb2R1bGVbImluc3RhbnRpYXRlV2FzbSJdKGluZm8sIHJlY2VpdmVJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZXhwb3J0czM7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgZXJyKCJNb2R1bGUuaW5zdGFudGlhdGVXYXNtIGNhbGxiYWNrIGZhaWxlZCB3aXRoIGVycm9yOiAiICsgZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbnRpYXRlQXN5bmMoKS5jYXRjaChyZWFkeVByb21pc2VSZWplY3QpOwogICAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjYWxsUnVudGltZUNhbGxiYWNrcyhjYWxsYmFja3MpIHsKICAgICAgICAgICAgd2hpbGUgKGNhbGxiYWNrcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gY2FsbGJhY2tzLnNoaWZ0KCk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhNb2R1bGUpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmdW5jID0gY2FsbGJhY2suZnVuYzsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGZ1bmMgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2suYXJnID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgd2FzbVRhYmxlLmdldChmdW5jKSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgd2FzbVRhYmxlLmdldChmdW5jKShjYWxsYmFjay5hcmcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmdW5jKGNhbGxiYWNrLmFyZyA9PT0gdm9pZCAwID8gbnVsbCA6IGNhbGxiYWNrLmFyZyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RydWN0UmVnaXN0cmF0aW9ucyA9IHt9OwogICAgICAgICAgZnVuY3Rpb24gcnVuRGVzdHJ1Y3RvcnMoZGVzdHJ1Y3RvcnMpIHsKICAgICAgICAgICAgd2hpbGUgKGRlc3RydWN0b3JzLmxlbmd0aCkgewogICAgICAgICAgICAgIHZhciBwdHIgPSBkZXN0cnVjdG9ycy5wb3AoKTsKICAgICAgICAgICAgICB2YXIgZGVsID0gZGVzdHJ1Y3RvcnMucG9wKCk7CiAgICAgICAgICAgICAgZGVsKHB0cik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNpbXBsZVJlYWRWYWx1ZUZyb21Qb2ludGVyKHBvaW50ZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbImZyb21XaXJlVHlwZSJdKEhFQVBVMzJbcG9pbnRlciA+PiAyXSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgYXdhaXRpbmdEZXBlbmRlbmNpZXMgPSB7fTsKICAgICAgICAgIHZhciByZWdpc3RlcmVkVHlwZXMgPSB7fTsKICAgICAgICAgIHZhciB0eXBlRGVwZW5kZW5jaWVzID0ge307CiAgICAgICAgICB2YXIgY2hhcl8wID0gNDg7CiAgICAgICAgICB2YXIgY2hhcl85ID0gNTc7CiAgICAgICAgICBmdW5jdGlvbiBtYWtlTGVnYWxGdW5jdGlvbk5hbWUobmFtZSkgewogICAgICAgICAgICBpZiAodm9pZCAwID09PSBuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJfdW5rbm93biI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmFtZSA9IG5hbWUucmVwbGFjZSgvW15hLXpBLVowLTlfXS9nLCAiJCIpOwogICAgICAgICAgICB2YXIgZiA9IG5hbWUuY2hhckNvZGVBdCgwKTsKICAgICAgICAgICAgaWYgKGYgPj0gY2hhcl8wICYmIGYgPD0gY2hhcl85KSB7CiAgICAgICAgICAgICAgcmV0dXJuICJfIiArIG5hbWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZU5hbWVkRnVuY3Rpb24obmFtZSwgYm9keSkgewogICAgICAgICAgICBuYW1lID0gbWFrZUxlZ2FsRnVuY3Rpb25OYW1lKG5hbWUpOwogICAgICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCJib2R5IiwgInJldHVybiBmdW5jdGlvbiAiICsgbmFtZSArICcoKSB7XG4gICAgInVzZSBzdHJpY3QiOyAgICByZXR1cm4gYm9keS5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xufTtcbicpKGJvZHkpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZXh0ZW5kRXJyb3IoYmFzZUVycm9yVHlwZSwgZXJyb3JOYW1lKSB7CiAgICAgICAgICAgIHZhciBlcnJvckNsYXNzID0gY3JlYXRlTmFtZWRGdW5jdGlvbihlcnJvck5hbWUsIGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgICAgICAgICB0aGlzLm5hbWUgPSBlcnJvck5hbWU7CiAgICAgICAgICAgICAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZTsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBuZXcgRXJyb3IobWVzc2FnZSkuc3RhY2s7CiAgICAgICAgICAgICAgaWYgKHN0YWNrICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhY2sgPSB0aGlzLnRvU3RyaW5nKCkgKyAiXG4iICsgc3RhY2sucmVwbGFjZSgvXkVycm9yKDpbXlxuXSopP1xuLywgIiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGVycm9yQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShiYXNlRXJyb3JUeXBlLnByb3RvdHlwZSk7CiAgICAgICAgICAgIGVycm9yQ2xhc3MucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gZXJyb3JDbGFzczsKICAgICAgICAgICAgZXJyb3JDbGFzcy5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5tZXNzYWdlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm5hbWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm5hbWUgKyAiOiAiICsgdGhpcy5tZXNzYWdlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIGVycm9yQ2xhc3M7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgSW50ZXJuYWxFcnJvciA9IHZvaWQgMDsKICAgICAgICAgIGZ1bmN0aW9uIHRocm93SW50ZXJuYWxFcnJvcihtZXNzYWdlKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBJbnRlcm5hbEVycm9yKG1lc3NhZ2UpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gd2hlbkRlcGVuZGVudFR5cGVzQXJlUmVzb2x2ZWQobXlUeXBlcywgZGVwZW5kZW50VHlwZXMsIGdldFR5cGVDb252ZXJ0ZXJzKSB7CiAgICAgICAgICAgIG15VHlwZXMuZm9yRWFjaChmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgICAgICAgdHlwZURlcGVuZGVuY2llc1t0eXBlXSA9IGRlcGVuZGVudFR5cGVzOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZnVuY3Rpb24gb25Db21wbGV0ZSh0eXBlQ29udmVydGVyczIpIHsKICAgICAgICAgICAgICB2YXIgbXlUeXBlQ29udmVydGVycyA9IGdldFR5cGVDb252ZXJ0ZXJzKHR5cGVDb252ZXJ0ZXJzMik7CiAgICAgICAgICAgICAgaWYgKG15VHlwZUNvbnZlcnRlcnMubGVuZ3RoICE9PSBteVR5cGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhyb3dJbnRlcm5hbEVycm9yKCJNaXNtYXRjaGVkIHR5cGUgY29udmVydGVyIGNvdW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbXlUeXBlcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgcmVnaXN0ZXJUeXBlKG15VHlwZXNbaV0sIG15VHlwZUNvbnZlcnRlcnNbaV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdHlwZUNvbnZlcnRlcnMgPSBuZXcgQXJyYXkoZGVwZW5kZW50VHlwZXMubGVuZ3RoKTsKICAgICAgICAgICAgdmFyIHVucmVnaXN0ZXJlZFR5cGVzID0gW107CiAgICAgICAgICAgIHZhciByZWdpc3RlcmVkID0gMDsKICAgICAgICAgICAgZGVwZW5kZW50VHlwZXMuZm9yRWFjaChmdW5jdGlvbihkdCwgaSkgewogICAgICAgICAgICAgIGlmIChyZWdpc3RlcmVkVHlwZXMuaGFzT3duUHJvcGVydHkoZHQpKSB7CiAgICAgICAgICAgICAgICB0eXBlQ29udmVydGVyc1tpXSA9IHJlZ2lzdGVyZWRUeXBlc1tkdF07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVucmVnaXN0ZXJlZFR5cGVzLnB1c2goZHQpOwogICAgICAgICAgICAgICAgaWYgKCFhd2FpdGluZ0RlcGVuZGVuY2llcy5oYXNPd25Qcm9wZXJ0eShkdCkpIHsKICAgICAgICAgICAgICAgICAgYXdhaXRpbmdEZXBlbmRlbmNpZXNbZHRdID0gW107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhd2FpdGluZ0RlcGVuZGVuY2llc1tkdF0ucHVzaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdHlwZUNvbnZlcnRlcnNbaV0gPSByZWdpc3RlcmVkVHlwZXNbZHRdOwogICAgICAgICAgICAgICAgICArK3JlZ2lzdGVyZWQ7CiAgICAgICAgICAgICAgICAgIGlmIChyZWdpc3RlcmVkID09PSB1bnJlZ2lzdGVyZWRUeXBlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBvbkNvbXBsZXRlKHR5cGVDb252ZXJ0ZXJzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKDAgPT09IHVucmVnaXN0ZXJlZFR5cGVzLmxlbmd0aCkgewogICAgICAgICAgICAgIG9uQ29tcGxldGUodHlwZUNvbnZlcnRlcnMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9maW5hbGl6ZV92YWx1ZV9vYmplY3Qoc3RydWN0VHlwZSkgewogICAgICAgICAgICB2YXIgcmVnID0gc3RydWN0UmVnaXN0cmF0aW9uc1tzdHJ1Y3RUeXBlXTsKICAgICAgICAgICAgZGVsZXRlIHN0cnVjdFJlZ2lzdHJhdGlvbnNbc3RydWN0VHlwZV07CiAgICAgICAgICAgIHZhciByYXdDb25zdHJ1Y3RvciA9IHJlZy5yYXdDb25zdHJ1Y3RvcjsKICAgICAgICAgICAgdmFyIHJhd0Rlc3RydWN0b3IgPSByZWcucmF3RGVzdHJ1Y3RvcjsKICAgICAgICAgICAgdmFyIGZpZWxkUmVjb3JkcyA9IHJlZy5maWVsZHM7CiAgICAgICAgICAgIHZhciBmaWVsZFR5cGVzID0gZmllbGRSZWNvcmRzLm1hcChmdW5jdGlvbihmaWVsZCkgewogICAgICAgICAgICAgIHJldHVybiBmaWVsZC5nZXR0ZXJSZXR1cm5UeXBlOwogICAgICAgICAgICB9KS5jb25jYXQoZmllbGRSZWNvcmRzLm1hcChmdW5jdGlvbihmaWVsZCkgewogICAgICAgICAgICAgIHJldHVybiBmaWVsZC5zZXR0ZXJBcmd1bWVudFR5cGU7CiAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgd2hlbkRlcGVuZGVudFR5cGVzQXJlUmVzb2x2ZWQoW3N0cnVjdFR5cGVdLCBmaWVsZFR5cGVzLCBmdW5jdGlvbihmaWVsZFR5cGVzMikgewogICAgICAgICAgICAgIHZhciBmaWVsZHMgPSB7fTsKICAgICAgICAgICAgICBmaWVsZFJlY29yZHMuZm9yRWFjaChmdW5jdGlvbihmaWVsZCwgaSkgewogICAgICAgICAgICAgICAgdmFyIGZpZWxkTmFtZSA9IGZpZWxkLmZpZWxkTmFtZTsKICAgICAgICAgICAgICAgIHZhciBnZXR0ZXJSZXR1cm5UeXBlID0gZmllbGRUeXBlczJbaV07CiAgICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gZmllbGQuZ2V0dGVyOwogICAgICAgICAgICAgICAgdmFyIGdldHRlckNvbnRleHQgPSBmaWVsZC5nZXR0ZXJDb250ZXh0OwogICAgICAgICAgICAgICAgdmFyIHNldHRlckFyZ3VtZW50VHlwZSA9IGZpZWxkVHlwZXMyW2kgKyBmaWVsZFJlY29yZHMubGVuZ3RoXTsKICAgICAgICAgICAgICAgIHZhciBzZXR0ZXIgPSBmaWVsZC5zZXR0ZXI7CiAgICAgICAgICAgICAgICB2YXIgc2V0dGVyQ29udGV4dCA9IGZpZWxkLnNldHRlckNvbnRleHQ7CiAgICAgICAgICAgICAgICBmaWVsZHNbZmllbGROYW1lXSA9IHsgcmVhZDogZnVuY3Rpb24ocHRyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXR0ZXJSZXR1cm5UeXBlWyJmcm9tV2lyZVR5cGUiXShnZXR0ZXIoZ2V0dGVyQ29udGV4dCwgcHRyKSk7CiAgICAgICAgICAgICAgICB9LCB3cml0ZTogZnVuY3Rpb24ocHRyLCBvKSB7CiAgICAgICAgICAgICAgICAgIHZhciBkZXN0cnVjdG9ycyA9IFtdOwogICAgICAgICAgICAgICAgICBzZXR0ZXIoc2V0dGVyQ29udGV4dCwgcHRyLCBzZXR0ZXJBcmd1bWVudFR5cGVbInRvV2lyZVR5cGUiXShkZXN0cnVjdG9ycywgbykpOwogICAgICAgICAgICAgICAgICBydW5EZXN0cnVjdG9ycyhkZXN0cnVjdG9ycyk7CiAgICAgICAgICAgICAgICB9IH07CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmV0dXJuIFt7IG5hbWU6IHJlZy5uYW1lLCAiZnJvbVdpcmVUeXBlIjogZnVuY3Rpb24ocHRyKSB7CiAgICAgICAgICAgICAgICB2YXIgcnYgPSB7fTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gZmllbGRzKSB7CiAgICAgICAgICAgICAgICAgIHJ2W2ldID0gZmllbGRzW2ldLnJlYWQocHRyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJhd0Rlc3RydWN0b3IocHRyKTsKICAgICAgICAgICAgICAgIHJldHVybiBydjsKICAgICAgICAgICAgICB9LCAidG9XaXJlVHlwZSI6IGZ1bmN0aW9uKGRlc3RydWN0b3JzLCBvKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBmaWVsZE5hbWUgaW4gZmllbGRzKSB7CiAgICAgICAgICAgICAgICAgIGlmICghKGZpZWxkTmFtZSBpbiBvKSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ01pc3NpbmcgZmllbGQ6ICAiJyArIGZpZWxkTmFtZSArICciJyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBwdHIgPSByYXdDb25zdHJ1Y3RvcigpOwogICAgICAgICAgICAgICAgZm9yIChmaWVsZE5hbWUgaW4gZmllbGRzKSB7CiAgICAgICAgICAgICAgICAgIGZpZWxkc1tmaWVsZE5hbWVdLndyaXRlKHB0ciwgb1tmaWVsZE5hbWVdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChkZXN0cnVjdG9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZXN0cnVjdG9ycy5wdXNoKHJhd0Rlc3RydWN0b3IsIHB0cik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgICAgIH0sICJhcmdQYWNrQWR2YW5jZSI6IDgsICJyZWFkVmFsdWVGcm9tUG9pbnRlciI6IHNpbXBsZVJlYWRWYWx1ZUZyb21Qb2ludGVyLCBkZXN0cnVjdG9yRnVuY3Rpb246IHJhd0Rlc3RydWN0b3IgfV07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0U2hpZnRGcm9tU2l6ZShzaXplKSB7CiAgICAgICAgICAgIHN3aXRjaCAoc2l6ZSkgewogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgIHJldHVybiAyOwogICAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgICAgIHJldHVybiAzOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIHR5cGUgc2l6ZTogIiArIHNpemUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBlbWJpbmRfaW5pdF9jaGFyQ29kZXMoKSB7CiAgICAgICAgICAgIHZhciBjb2RlcyA9IG5ldyBBcnJheSgyNTYpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDI1NjsgKytpKSB7CiAgICAgICAgICAgICAgY29kZXNbaV0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVtYmluZF9jaGFyQ29kZXMgPSBjb2RlczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbWJpbmRfY2hhckNvZGVzID0gdm9pZCAwOwogICAgICAgICAgZnVuY3Rpb24gcmVhZExhdGluMVN0cmluZyhwdHIpIHsKICAgICAgICAgICAgdmFyIHJldCA9ICIiOwogICAgICAgICAgICB2YXIgYyA9IHB0cjsKICAgICAgICAgICAgd2hpbGUgKEhFQVBVOFtjXSkgewogICAgICAgICAgICAgIHJldCArPSBlbWJpbmRfY2hhckNvZGVzW0hFQVBVOFtjKytdXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIEJpbmRpbmdFcnJvciA9IHZvaWQgMDsKICAgICAgICAgIGZ1bmN0aW9uIHRocm93QmluZGluZ0Vycm9yKG1lc3NhZ2UpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEJpbmRpbmdFcnJvcihtZXNzYWdlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyVHlwZShyYXdUeXBlLCByZWdpc3RlcmVkSW5zdGFuY2UsIG9wdGlvbnMpIHsKICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICAgIGlmICghKCJhcmdQYWNrQWR2YW5jZSIgaW4gcmVnaXN0ZXJlZEluc3RhbmNlKSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoInJlZ2lzdGVyVHlwZSByZWdpc3RlcmVkSW5zdGFuY2UgcmVxdWlyZXMgYXJnUGFja0FkdmFuY2UiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmFtZSA9IHJlZ2lzdGVyZWRJbnN0YW5jZS5uYW1lOwogICAgICAgICAgICBpZiAoIXJhd1R5cGUpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigndHlwZSAiJyArIG5hbWUgKyAnIiBtdXN0IGhhdmUgYSBwb3NpdGl2ZSBpbnRlZ2VyIHR5cGVpZCBwb2ludGVyJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlZ2lzdGVyZWRUeXBlcy5oYXNPd25Qcm9wZXJ0eShyYXdUeXBlKSkgewogICAgICAgICAgICAgIGlmIChvcHRpb25zLmlnbm9yZUR1cGxpY2F0ZVJlZ2lzdHJhdGlvbnMpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIkNhbm5vdCByZWdpc3RlciB0eXBlICciICsgbmFtZSArICInIHR3aWNlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlZ2lzdGVyZWRUeXBlc1tyYXdUeXBlXSA9IHJlZ2lzdGVyZWRJbnN0YW5jZTsKICAgICAgICAgICAgZGVsZXRlIHR5cGVEZXBlbmRlbmNpZXNbcmF3VHlwZV07CiAgICAgICAgICAgIGlmIChhd2FpdGluZ0RlcGVuZGVuY2llcy5oYXNPd25Qcm9wZXJ0eShyYXdUeXBlKSkgewogICAgICAgICAgICAgIHZhciBjYWxsYmFja3MgPSBhd2FpdGluZ0RlcGVuZGVuY2llc1tyYXdUeXBlXTsKICAgICAgICAgICAgICBkZWxldGUgYXdhaXRpbmdEZXBlbmRlbmNpZXNbcmF3VHlwZV07CiAgICAgICAgICAgICAgY2FsbGJhY2tzLmZvckVhY2goZnVuY3Rpb24oY2IpIHsKICAgICAgICAgICAgICAgIGNiKCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX2Jvb2wocmF3VHlwZSwgbmFtZSwgc2l6ZSwgdHJ1ZVZhbHVlLCBmYWxzZVZhbHVlKSB7CiAgICAgICAgICAgIHZhciBzaGlmdCA9IGdldFNoaWZ0RnJvbVNpemUoc2l6ZSk7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICByZWdpc3RlclR5cGUocmF3VHlwZSwgeyBuYW1lLCAiZnJvbVdpcmVUeXBlIjogZnVuY3Rpb24od3QpIHsKICAgICAgICAgICAgICByZXR1cm4gISF3dDsKICAgICAgICAgICAgfSwgInRvV2lyZVR5cGUiOiBmdW5jdGlvbihkZXN0cnVjdG9ycywgbykgewogICAgICAgICAgICAgIHJldHVybiBvID8gdHJ1ZVZhbHVlIDogZmFsc2VWYWx1ZTsKICAgICAgICAgICAgfSwgImFyZ1BhY2tBZHZhbmNlIjogOCwgInJlYWRWYWx1ZUZyb21Qb2ludGVyIjogZnVuY3Rpb24ocG9pbnRlcikgewogICAgICAgICAgICAgIHZhciBoZWFwOwogICAgICAgICAgICAgIGlmIChzaXplID09PSAxKSB7CiAgICAgICAgICAgICAgICBoZWFwID0gSEVBUDg7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzaXplID09PSAyKSB7CiAgICAgICAgICAgICAgICBoZWFwID0gSEVBUDE2OwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2l6ZSA9PT0gNCkgewogICAgICAgICAgICAgICAgaGVhcCA9IEhFQVAzMjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVW5rbm93biBib29sZWFuIHR5cGUgc2l6ZTogIiArIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdGhpc1siZnJvbVdpcmVUeXBlIl0oaGVhcFtwb2ludGVyID4+IHNoaWZ0XSk7CiAgICAgICAgICAgIH0sIGRlc3RydWN0b3JGdW5jdGlvbjogbnVsbCB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIENsYXNzSGFuZGxlX2lzQWxpYXNPZihvdGhlcikgewogICAgICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgQ2xhc3NIYW5kbGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghKG90aGVyIGluc3RhbmNlb2YgQ2xhc3NIYW5kbGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBsZWZ0Q2xhc3MgPSB0aGlzLiQkLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzOwogICAgICAgICAgICB2YXIgbGVmdCA9IHRoaXMuJCQucHRyOwogICAgICAgICAgICB2YXIgcmlnaHRDbGFzcyA9IG90aGVyLiQkLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzOwogICAgICAgICAgICB2YXIgcmlnaHQgPSBvdGhlci4kJC5wdHI7CiAgICAgICAgICAgIHdoaWxlIChsZWZ0Q2xhc3MuYmFzZUNsYXNzKSB7CiAgICAgICAgICAgICAgbGVmdCA9IGxlZnRDbGFzcy51cGNhc3QobGVmdCk7CiAgICAgICAgICAgICAgbGVmdENsYXNzID0gbGVmdENsYXNzLmJhc2VDbGFzczsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAocmlnaHRDbGFzcy5iYXNlQ2xhc3MpIHsKICAgICAgICAgICAgICByaWdodCA9IHJpZ2h0Q2xhc3MudXBjYXN0KHJpZ2h0KTsKICAgICAgICAgICAgICByaWdodENsYXNzID0gcmlnaHRDbGFzcy5iYXNlQ2xhc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnRDbGFzcyA9PT0gcmlnaHRDbGFzcyAmJiBsZWZ0ID09PSByaWdodDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHNoYWxsb3dDb3B5SW50ZXJuYWxQb2ludGVyKG8pIHsKICAgICAgICAgICAgcmV0dXJuIHsgY291bnQ6IG8uY291bnQsIGRlbGV0ZVNjaGVkdWxlZDogby5kZWxldGVTY2hlZHVsZWQsIHByZXNlcnZlUG9pbnRlck9uRGVsZXRlOiBvLnByZXNlcnZlUG9pbnRlck9uRGVsZXRlLCBwdHI6IG8ucHRyLCBwdHJUeXBlOiBvLnB0clR5cGUsIHNtYXJ0UHRyOiBvLnNtYXJ0UHRyLCBzbWFydFB0clR5cGU6IG8uc21hcnRQdHJUeXBlIH07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB0aHJvd0luc3RhbmNlQWxyZWFkeURlbGV0ZWQob2JqKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIGdldEluc3RhbmNlVHlwZU5hbWUoaGFuZGxlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZS4kJC5wdHJUeXBlLnJlZ2lzdGVyZWRDbGFzcy5uYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKGdldEluc3RhbmNlVHlwZU5hbWUob2JqKSArICIgaW5zdGFuY2UgYWxyZWFkeSBkZWxldGVkIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmluYWxpemF0aW9uR3JvdXAgPSBmYWxzZTsKICAgICAgICAgIGZ1bmN0aW9uIGRldGFjaEZpbmFsaXplcihoYW5kbGUpIHsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJ1bkRlc3RydWN0b3IoJCQpIHsKICAgICAgICAgICAgaWYgKCQkLnNtYXJ0UHRyKSB7CiAgICAgICAgICAgICAgJCQuc21hcnRQdHJUeXBlLnJhd0Rlc3RydWN0b3IoJCQuc21hcnRQdHIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICQkLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzLnJhd0Rlc3RydWN0b3IoJCQucHRyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVsZWFzZUNsYXNzSGFuZGxlKCQkKSB7CiAgICAgICAgICAgICQkLmNvdW50LnZhbHVlIC09IDE7CiAgICAgICAgICAgIHZhciB0b0RlbGV0ZSA9IDAgPT09ICQkLmNvdW50LnZhbHVlOwogICAgICAgICAgICBpZiAodG9EZWxldGUpIHsKICAgICAgICAgICAgICBydW5EZXN0cnVjdG9yKCQkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gYXR0YWNoRmluYWxpemVyKGhhbmRsZSkgewogICAgICAgICAgICBpZiAoInVuZGVmaW5lZCIgPT09IHR5cGVvZiBGaW5hbGl6YXRpb25Hcm91cCkgewogICAgICAgICAgICAgIGF0dGFjaEZpbmFsaXplciA9IGZ1bmN0aW9uKGhhbmRsZTIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGUyOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5hbGl6YXRpb25Hcm91cCA9IG5ldyBGaW5hbGl6YXRpb25Hcm91cChmdW5jdGlvbihpdGVyKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgcmVzdWx0ID0gaXRlci5uZXh0KCk7ICFyZXN1bHQuZG9uZTsgcmVzdWx0ID0gaXRlci5uZXh0KCkpIHsKICAgICAgICAgICAgICAgIHZhciAkJCA9IHJlc3VsdC52YWx1ZTsKICAgICAgICAgICAgICAgIGlmICghJCQucHRyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2Fybigib2JqZWN0IGFscmVhZHkgZGVsZXRlZDogIiArICQkLnB0cik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZWxlYXNlQ2xhc3NIYW5kbGUoJCQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGF0dGFjaEZpbmFsaXplciA9IGZ1bmN0aW9uKGhhbmRsZTIpIHsKICAgICAgICAgICAgICBmaW5hbGl6YXRpb25Hcm91cC5yZWdpc3RlcihoYW5kbGUyLCBoYW5kbGUyLiQkLCBoYW5kbGUyLiQkKTsKICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlMjsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgZGV0YWNoRmluYWxpemVyID0gZnVuY3Rpb24oaGFuZGxlMikgewogICAgICAgICAgICAgIGZpbmFsaXphdGlvbkdyb3VwLnVucmVnaXN0ZXIoaGFuZGxlMi4kJCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiBhdHRhY2hGaW5hbGl6ZXIoaGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIENsYXNzSGFuZGxlX2Nsb25lKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuJCQucHRyKSB7CiAgICAgICAgICAgICAgdGhyb3dJbnN0YW5jZUFscmVhZHlEZWxldGVkKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLiQkLnByZXNlcnZlUG9pbnRlck9uRGVsZXRlKSB7CiAgICAgICAgICAgICAgdGhpcy4kJC5jb3VudC52YWx1ZSArPSAxOwogICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBjbG9uZTIgPSBhdHRhY2hGaW5hbGl6ZXIoT2JqZWN0LmNyZWF0ZShPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcyksIHsgJCQ6IHsgdmFsdWU6IHNoYWxsb3dDb3B5SW50ZXJuYWxQb2ludGVyKHRoaXMuJCQpIH0gfSkpOwogICAgICAgICAgICAgIGNsb25lMi4kJC5jb3VudC52YWx1ZSArPSAxOwogICAgICAgICAgICAgIGNsb25lMi4kJC5kZWxldGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gY2xvbmUyOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBDbGFzc0hhbmRsZV9kZWxldGUoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy4kJC5wdHIpIHsKICAgICAgICAgICAgICB0aHJvd0luc3RhbmNlQWxyZWFkeURlbGV0ZWQodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuJCQuZGVsZXRlU2NoZWR1bGVkICYmICF0aGlzLiQkLnByZXNlcnZlUG9pbnRlck9uRGVsZXRlKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIk9iamVjdCBhbHJlYWR5IHNjaGVkdWxlZCBmb3IgZGVsZXRpb24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZXRhY2hGaW5hbGl6ZXIodGhpcyk7CiAgICAgICAgICAgIHJlbGVhc2VDbGFzc0hhbmRsZSh0aGlzLiQkKTsKICAgICAgICAgICAgaWYgKCF0aGlzLiQkLnByZXNlcnZlUG9pbnRlck9uRGVsZXRlKSB7CiAgICAgICAgICAgICAgdGhpcy4kJC5zbWFydFB0ciA9IHZvaWQgMDsKICAgICAgICAgICAgICB0aGlzLiQkLnB0ciA9IHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gQ2xhc3NIYW5kbGVfaXNEZWxldGVkKCkgewogICAgICAgICAgICByZXR1cm4gIXRoaXMuJCQucHRyOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRlbGF5RnVuY3Rpb24gPSB2b2lkIDA7CiAgICAgICAgICB2YXIgZGVsZXRpb25RdWV1ZSA9IFtdOwogICAgICAgICAgZnVuY3Rpb24gZmx1c2hQZW5kaW5nRGVsZXRlcygpIHsKICAgICAgICAgICAgd2hpbGUgKGRlbGV0aW9uUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgdmFyIG9iaiA9IGRlbGV0aW9uUXVldWUucG9wKCk7CiAgICAgICAgICAgICAgb2JqLiQkLmRlbGV0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgICAgIG9ialsiZGVsZXRlIl0oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gQ2xhc3NIYW5kbGVfZGVsZXRlTGF0ZXIoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy4kJC5wdHIpIHsKICAgICAgICAgICAgICB0aHJvd0luc3RhbmNlQWxyZWFkeURlbGV0ZWQodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuJCQuZGVsZXRlU2NoZWR1bGVkICYmICF0aGlzLiQkLnByZXNlcnZlUG9pbnRlck9uRGVsZXRlKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIk9iamVjdCBhbHJlYWR5IHNjaGVkdWxlZCBmb3IgZGVsZXRpb24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGlvblF1ZXVlLnB1c2godGhpcyk7CiAgICAgICAgICAgIGlmIChkZWxldGlvblF1ZXVlLmxlbmd0aCA9PT0gMSAmJiBkZWxheUZ1bmN0aW9uKSB7CiAgICAgICAgICAgICAgZGVsYXlGdW5jdGlvbihmbHVzaFBlbmRpbmdEZWxldGVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLiQkLmRlbGV0ZVNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW5pdF9DbGFzc0hhbmRsZSgpIHsKICAgICAgICAgICAgQ2xhc3NIYW5kbGUucHJvdG90eXBlWyJpc0FsaWFzT2YiXSA9IENsYXNzSGFuZGxlX2lzQWxpYXNPZjsKICAgICAgICAgICAgQ2xhc3NIYW5kbGUucHJvdG90eXBlWyJjbG9uZSJdID0gQ2xhc3NIYW5kbGVfY2xvbmU7CiAgICAgICAgICAgIENsYXNzSGFuZGxlLnByb3RvdHlwZVsiZGVsZXRlIl0gPSBDbGFzc0hhbmRsZV9kZWxldGU7CiAgICAgICAgICAgIENsYXNzSGFuZGxlLnByb3RvdHlwZVsiaXNEZWxldGVkIl0gPSBDbGFzc0hhbmRsZV9pc0RlbGV0ZWQ7CiAgICAgICAgICAgIENsYXNzSGFuZGxlLnByb3RvdHlwZVsiZGVsZXRlTGF0ZXIiXSA9IENsYXNzSGFuZGxlX2RlbGV0ZUxhdGVyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gQ2xhc3NIYW5kbGUoKSB7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVnaXN0ZXJlZFBvaW50ZXJzID0ge307CiAgICAgICAgICBmdW5jdGlvbiBlbnN1cmVPdmVybG9hZFRhYmxlKHByb3RvLCBtZXRob2ROYW1lLCBodW1hbk5hbWUpIHsKICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gcHJvdG9bbWV0aG9kTmFtZV0ub3ZlcmxvYWRUYWJsZSkgewogICAgICAgICAgICAgIHZhciBwcmV2RnVuYyA9IHByb3RvW21ldGhvZE5hbWVdOwogICAgICAgICAgICAgIHByb3RvW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoIXByb3RvW21ldGhvZE5hbWVdLm92ZXJsb2FkVGFibGUuaGFzT3duUHJvcGVydHkoYXJndW1lbnRzLmxlbmd0aCkpIHsKICAgICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIkZ1bmN0aW9uICciICsgaHVtYW5OYW1lICsgIicgY2FsbGVkIHdpdGggYW4gaW52YWxpZCBudW1iZXIgb2YgYXJndW1lbnRzICgiICsgYXJndW1lbnRzLmxlbmd0aCArICIpIC0gZXhwZWN0cyBvbmUgb2YgKCIgKyBwcm90b1ttZXRob2ROYW1lXS5vdmVybG9hZFRhYmxlICsgIikhIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcHJvdG9bbWV0aG9kTmFtZV0ub3ZlcmxvYWRUYWJsZVthcmd1bWVudHMubGVuZ3RoXS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgcHJvdG9bbWV0aG9kTmFtZV0ub3ZlcmxvYWRUYWJsZSA9IFtdOwogICAgICAgICAgICAgIHByb3RvW21ldGhvZE5hbWVdLm92ZXJsb2FkVGFibGVbcHJldkZ1bmMuYXJnQ291bnRdID0gcHJldkZ1bmM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGV4cG9zZVB1YmxpY1N5bWJvbChuYW1lLCB2YWx1ZSwgbnVtQXJndW1lbnRzKSB7CiAgICAgICAgICAgIGlmIChNb2R1bGUuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICBpZiAodm9pZCAwID09PSBudW1Bcmd1bWVudHMgfHwgdm9pZCAwICE9PSBNb2R1bGVbbmFtZV0ub3ZlcmxvYWRUYWJsZSAmJiB2b2lkIDAgIT09IE1vZHVsZVtuYW1lXS5vdmVybG9hZFRhYmxlW251bUFyZ3VtZW50c10pIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgcmVnaXN0ZXIgcHVibGljIG5hbWUgJyIgKyBuYW1lICsgIicgdHdpY2UiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZW5zdXJlT3ZlcmxvYWRUYWJsZShNb2R1bGUsIG5hbWUsIG5hbWUpOwogICAgICAgICAgICAgIGlmIChNb2R1bGUuaGFzT3duUHJvcGVydHkobnVtQXJndW1lbnRzKSkgewogICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIkNhbm5vdCByZWdpc3RlciBtdWx0aXBsZSBvdmVybG9hZHMgb2YgYSBmdW5jdGlvbiB3aXRoIHRoZSBzYW1lIG51bWJlciBvZiBhcmd1bWVudHMgKCIgKyBudW1Bcmd1bWVudHMgKyAiKSEiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgTW9kdWxlW25hbWVdLm92ZXJsb2FkVGFibGVbbnVtQXJndW1lbnRzXSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIE1vZHVsZVtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IG51bUFyZ3VtZW50cykgewogICAgICAgICAgICAgICAgTW9kdWxlW25hbWVdLm51bUFyZ3VtZW50cyA9IG51bUFyZ3VtZW50czsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFJlZ2lzdGVyZWRDbGFzcyhuYW1lLCBjb25zdHJ1Y3RvciwgaW5zdGFuY2VQcm90b3R5cGUsIHJhd0Rlc3RydWN0b3IsIGJhc2VDbGFzcywgZ2V0QWN0dWFsVHlwZSwgdXBjYXN0LCBkb3duY2FzdCkgewogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yID0gY29uc3RydWN0b3I7CiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2VQcm90b3R5cGUgPSBpbnN0YW5jZVByb3RvdHlwZTsKICAgICAgICAgICAgdGhpcy5yYXdEZXN0cnVjdG9yID0gcmF3RGVzdHJ1Y3RvcjsKICAgICAgICAgICAgdGhpcy5iYXNlQ2xhc3MgPSBiYXNlQ2xhc3M7CiAgICAgICAgICAgIHRoaXMuZ2V0QWN0dWFsVHlwZSA9IGdldEFjdHVhbFR5cGU7CiAgICAgICAgICAgIHRoaXMudXBjYXN0ID0gdXBjYXN0OwogICAgICAgICAgICB0aGlzLmRvd25jYXN0ID0gZG93bmNhc3Q7CiAgICAgICAgICAgIHRoaXMucHVyZVZpcnR1YWxGdW5jdGlvbnMgPSBbXTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwY2FzdFBvaW50ZXIocHRyLCBwdHJDbGFzcywgZGVzaXJlZENsYXNzKSB7CiAgICAgICAgICAgIHdoaWxlIChwdHJDbGFzcyAhPT0gZGVzaXJlZENsYXNzKSB7CiAgICAgICAgICAgICAgaWYgKCFwdHJDbGFzcy51cGNhc3QpIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJFeHBlY3RlZCBudWxsIG9yIGluc3RhbmNlIG9mICIgKyBkZXNpcmVkQ2xhc3MubmFtZSArICIsIGdvdCBhbiBpbnN0YW5jZSBvZiAiICsgcHRyQ2xhc3MubmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHB0ciA9IHB0ckNsYXNzLnVwY2FzdChwdHIpOwogICAgICAgICAgICAgIHB0ckNsYXNzID0gcHRyQ2xhc3MuYmFzZUNsYXNzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb25zdE5vU21hcnRQdHJSYXdQb2ludGVyVG9XaXJlVHlwZShkZXN0cnVjdG9ycywgaGFuZGxlKSB7CiAgICAgICAgICAgIGlmIChoYW5kbGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5pc1JlZmVyZW5jZSkgewogICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIm51bGwgaXMgbm90IGEgdmFsaWQgIiArIHRoaXMubmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaGFuZGxlLiQkKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoJ0Nhbm5vdCBwYXNzICInICsgX2VtYmluZF9yZXByKGhhbmRsZSkgKyAnIiBhcyBhICcgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaGFuZGxlLiQkLnB0cikgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgcGFzcyBkZWxldGVkIG9iamVjdCBhcyBhIHBvaW50ZXIgb2YgdHlwZSAiICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFuZGxlQ2xhc3MgPSBoYW5kbGUuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3M7CiAgICAgICAgICAgIHZhciBwdHIgPSB1cGNhc3RQb2ludGVyKGhhbmRsZS4kJC5wdHIsIGhhbmRsZUNsYXNzLCB0aGlzLnJlZ2lzdGVyZWRDbGFzcyk7CiAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZW5lcmljUG9pbnRlclRvV2lyZVR5cGUoZGVzdHJ1Y3RvcnMsIGhhbmRsZSkgewogICAgICAgICAgICB2YXIgcHRyOwogICAgICAgICAgICBpZiAoaGFuZGxlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSZWZlcmVuY2UpIHsKICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJudWxsIGlzIG5vdCBhIHZhbGlkICIgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodGhpcy5pc1NtYXJ0UG9pbnRlcikgewogICAgICAgICAgICAgICAgcHRyID0gdGhpcy5yYXdDb25zdHJ1Y3RvcigpOwogICAgICAgICAgICAgICAgaWYgKGRlc3RydWN0b3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGRlc3RydWN0b3JzLnB1c2godGhpcy5yYXdEZXN0cnVjdG9yLCBwdHIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHB0cjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaGFuZGxlLiQkKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoJ0Nhbm5vdCBwYXNzICInICsgX2VtYmluZF9yZXByKGhhbmRsZSkgKyAnIiBhcyBhICcgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaGFuZGxlLiQkLnB0cikgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgcGFzcyBkZWxldGVkIG9iamVjdCBhcyBhIHBvaW50ZXIgb2YgdHlwZSAiICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXRoaXMuaXNDb25zdCAmJiBoYW5kbGUuJCQucHRyVHlwZS5pc0NvbnN0KSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIkNhbm5vdCBjb252ZXJ0IGFyZ3VtZW50IG9mIHR5cGUgIiArIChoYW5kbGUuJCQuc21hcnRQdHJUeXBlID8gaGFuZGxlLiQkLnNtYXJ0UHRyVHlwZS5uYW1lIDogaGFuZGxlLiQkLnB0clR5cGUubmFtZSkgKyAiIHRvIHBhcmFtZXRlciB0eXBlICIgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYW5kbGVDbGFzcyA9IGhhbmRsZS4kJC5wdHJUeXBlLnJlZ2lzdGVyZWRDbGFzczsKICAgICAgICAgICAgcHRyID0gdXBjYXN0UG9pbnRlcihoYW5kbGUuJCQucHRyLCBoYW5kbGVDbGFzcywgdGhpcy5yZWdpc3RlcmVkQ2xhc3MpOwogICAgICAgICAgICBpZiAodGhpcy5pc1NtYXJ0UG9pbnRlcikgewogICAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IGhhbmRsZS4kJC5zbWFydFB0cikgewogICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIlBhc3NpbmcgcmF3IHBvaW50ZXIgdG8gc21hcnQgcG9pbnRlciBpcyBpbGxlZ2FsIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN3aXRjaCAodGhpcy5zaGFyaW5nUG9saWN5KSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgIGlmIChoYW5kbGUuJCQuc21hcnRQdHJUeXBlID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgICAgICAgcHRyID0gaGFuZGxlLiQkLnNtYXJ0UHRyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJDYW5ub3QgY29udmVydCBhcmd1bWVudCBvZiB0eXBlICIgKyAoaGFuZGxlLiQkLnNtYXJ0UHRyVHlwZSA/IGhhbmRsZS4kJC5zbWFydFB0clR5cGUubmFtZSA6IGhhbmRsZS4kJC5wdHJUeXBlLm5hbWUpICsgIiB0byBwYXJhbWV0ZXIgdHlwZSAiICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgICAgcHRyID0gaGFuZGxlLiQkLnNtYXJ0UHRyOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZS4kJC5zbWFydFB0clR5cGUgPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgICAgICBwdHIgPSBoYW5kbGUuJCQuc21hcnRQdHI7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNsb25lZEhhbmRsZSA9IGhhbmRsZVsiY2xvbmUiXSgpOwogICAgICAgICAgICAgICAgICAgIHB0ciA9IHRoaXMucmF3U2hhcmUocHRyLCBfX2VtdmFsX3JlZ2lzdGVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgY2xvbmVkSGFuZGxlWyJkZWxldGUiXSgpOwogICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGVzdHJ1Y3RvcnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIGRlc3RydWN0b3JzLnB1c2godGhpcy5yYXdEZXN0cnVjdG9yLCBwdHIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJVbnN1cHBvcnRpbmcgc2hhcmluZyBwb2xpY3kiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHB0cjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG5vbkNvbnN0Tm9TbWFydFB0clJhd1BvaW50ZXJUb1dpcmVUeXBlKGRlc3RydWN0b3JzLCBoYW5kbGUpIHsKICAgICAgICAgICAgaWYgKGhhbmRsZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICh0aGlzLmlzUmVmZXJlbmNlKSB7CiAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigibnVsbCBpcyBub3QgYSB2YWxpZCAiICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFoYW5kbGUuJCQpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcignQ2Fubm90IHBhc3MgIicgKyBfZW1iaW5kX3JlcHIoaGFuZGxlKSArICciIGFzIGEgJyArIHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFoYW5kbGUuJCQucHRyKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIkNhbm5vdCBwYXNzIGRlbGV0ZWQgb2JqZWN0IGFzIGEgcG9pbnRlciBvZiB0eXBlICIgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYW5kbGUuJCQucHRyVHlwZS5pc0NvbnN0KSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIkNhbm5vdCBjb252ZXJ0IGFyZ3VtZW50IG9mIHR5cGUgIiArIGhhbmRsZS4kJC5wdHJUeXBlLm5hbWUgKyAiIHRvIHBhcmFtZXRlciB0eXBlICIgKyB0aGlzLm5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYW5kbGVDbGFzcyA9IGhhbmRsZS4kJC5wdHJUeXBlLnJlZ2lzdGVyZWRDbGFzczsKICAgICAgICAgICAgdmFyIHB0ciA9IHVwY2FzdFBvaW50ZXIoaGFuZGxlLiQkLnB0ciwgaGFuZGxlQ2xhc3MsIHRoaXMucmVnaXN0ZXJlZENsYXNzKTsKICAgICAgICAgICAgcmV0dXJuIHB0cjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFJlZ2lzdGVyZWRQb2ludGVyX2dldFBvaW50ZWUocHRyKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnJhd0dldFBvaW50ZWUpIHsKICAgICAgICAgICAgICBwdHIgPSB0aGlzLnJhd0dldFBvaW50ZWUocHRyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gUmVnaXN0ZXJlZFBvaW50ZXJfZGVzdHJ1Y3RvcihwdHIpIHsKICAgICAgICAgICAgaWYgKHRoaXMucmF3RGVzdHJ1Y3RvcikgewogICAgICAgICAgICAgIHRoaXMucmF3RGVzdHJ1Y3RvcihwdHIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBSZWdpc3RlcmVkUG9pbnRlcl9kZWxldGVPYmplY3QoaGFuZGxlKSB7CiAgICAgICAgICAgIGlmIChoYW5kbGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBoYW5kbGVbImRlbGV0ZSJdKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRvd25jYXN0UG9pbnRlcihwdHIsIHB0ckNsYXNzLCBkZXNpcmVkQ2xhc3MpIHsKICAgICAgICAgICAgaWYgKHB0ckNsYXNzID09PSBkZXNpcmVkQ2xhc3MpIHsKICAgICAgICAgICAgICByZXR1cm4gcHRyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IGRlc2lyZWRDbGFzcy5iYXNlQ2xhc3MpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcnYgPSBkb3duY2FzdFBvaW50ZXIocHRyLCBwdHJDbGFzcywgZGVzaXJlZENsYXNzLmJhc2VDbGFzcyk7CiAgICAgICAgICAgIGlmIChydiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkZXNpcmVkQ2xhc3MuZG93bmNhc3QocnYpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0SW5oZXJpdGVkSW5zdGFuY2VDb3VudCgpIHsKICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHJlZ2lzdGVyZWRJbnN0YW5jZXMpLmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGdldExpdmVJbmhlcml0ZWRJbnN0YW5jZXMoKSB7CiAgICAgICAgICAgIHZhciBydiA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrIGluIHJlZ2lzdGVyZWRJbnN0YW5jZXMpIHsKICAgICAgICAgICAgICBpZiAocmVnaXN0ZXJlZEluc3RhbmNlcy5oYXNPd25Qcm9wZXJ0eShrKSkgewogICAgICAgICAgICAgICAgcnYucHVzaChyZWdpc3RlcmVkSW5zdGFuY2VzW2tdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJ2OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gc2V0RGVsYXlGdW5jdGlvbihmbikgewogICAgICAgICAgICBkZWxheUZ1bmN0aW9uID0gZm47CiAgICAgICAgICAgIGlmIChkZWxldGlvblF1ZXVlLmxlbmd0aCAmJiBkZWxheUZ1bmN0aW9uKSB7CiAgICAgICAgICAgICAgZGVsYXlGdW5jdGlvbihmbHVzaFBlbmRpbmdEZWxldGVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW5pdF9lbWJpbmQoKSB7CiAgICAgICAgICAgIE1vZHVsZVsiZ2V0SW5oZXJpdGVkSW5zdGFuY2VDb3VudCJdID0gZ2V0SW5oZXJpdGVkSW5zdGFuY2VDb3VudDsKICAgICAgICAgICAgTW9kdWxlWyJnZXRMaXZlSW5oZXJpdGVkSW5zdGFuY2VzIl0gPSBnZXRMaXZlSW5oZXJpdGVkSW5zdGFuY2VzOwogICAgICAgICAgICBNb2R1bGVbImZsdXNoUGVuZGluZ0RlbGV0ZXMiXSA9IGZsdXNoUGVuZGluZ0RlbGV0ZXM7CiAgICAgICAgICAgIE1vZHVsZVsic2V0RGVsYXlGdW5jdGlvbiJdID0gc2V0RGVsYXlGdW5jdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZWdpc3RlcmVkSW5zdGFuY2VzID0ge307CiAgICAgICAgICBmdW5jdGlvbiBnZXRCYXNlc3RQb2ludGVyKGNsYXNzXywgcHRyKSB7CiAgICAgICAgICAgIGlmIChwdHIgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJwdHIgc2hvdWxkIG5vdCBiZSB1bmRlZmluZWQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAoY2xhc3NfLmJhc2VDbGFzcykgewogICAgICAgICAgICAgIHB0ciA9IGNsYXNzXy51cGNhc3QocHRyKTsKICAgICAgICAgICAgICBjbGFzc18gPSBjbGFzc18uYmFzZUNsYXNzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBnZXRJbmhlcml0ZWRJbnN0YW5jZShjbGFzc18sIHB0cikgewogICAgICAgICAgICBwdHIgPSBnZXRCYXNlc3RQb2ludGVyKGNsYXNzXywgcHRyKTsKICAgICAgICAgICAgcmV0dXJuIHJlZ2lzdGVyZWRJbnN0YW5jZXNbcHRyXTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIG1ha2VDbGFzc0hhbmRsZShwcm90b3R5cGUsIHJlY29yZCkgewogICAgICAgICAgICBpZiAoIXJlY29yZC5wdHJUeXBlIHx8ICFyZWNvcmQucHRyKSB7CiAgICAgICAgICAgICAgdGhyb3dJbnRlcm5hbEVycm9yKCJtYWtlQ2xhc3NIYW5kbGUgcmVxdWlyZXMgcHRyIGFuZCBwdHJUeXBlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc1NtYXJ0UHRyVHlwZSA9ICEhcmVjb3JkLnNtYXJ0UHRyVHlwZTsKICAgICAgICAgICAgdmFyIGhhc1NtYXJ0UHRyID0gISFyZWNvcmQuc21hcnRQdHI7CiAgICAgICAgICAgIGlmIChoYXNTbWFydFB0clR5cGUgIT09IGhhc1NtYXJ0UHRyKSB7CiAgICAgICAgICAgICAgdGhyb3dJbnRlcm5hbEVycm9yKCJCb3RoIHNtYXJ0UHRyVHlwZSBhbmQgc21hcnRQdHIgbXVzdCBiZSBzcGVjaWZpZWQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWNvcmQuY291bnQgPSB7IHZhbHVlOiAxIH07CiAgICAgICAgICAgIHJldHVybiBhdHRhY2hGaW5hbGl6ZXIoT2JqZWN0LmNyZWF0ZShwcm90b3R5cGUsIHsgJCQ6IHsgdmFsdWU6IHJlY29yZCB9IH0pKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIFJlZ2lzdGVyZWRQb2ludGVyX2Zyb21XaXJlVHlwZShwdHIpIHsKICAgICAgICAgICAgdmFyIHJhd1BvaW50ZXIgPSB0aGlzLmdldFBvaW50ZWUocHRyKTsKICAgICAgICAgICAgaWYgKCFyYXdQb2ludGVyKSB7CiAgICAgICAgICAgICAgdGhpcy5kZXN0cnVjdG9yKHB0cik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlZ2lzdGVyZWRJbnN0YW5jZSA9IGdldEluaGVyaXRlZEluc3RhbmNlKHRoaXMucmVnaXN0ZXJlZENsYXNzLCByYXdQb2ludGVyKTsKICAgICAgICAgICAgaWYgKHZvaWQgMCAhPT0gcmVnaXN0ZXJlZEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgaWYgKDAgPT09IHJlZ2lzdGVyZWRJbnN0YW5jZS4kJC5jb3VudC52YWx1ZSkgewogICAgICAgICAgICAgICAgcmVnaXN0ZXJlZEluc3RhbmNlLiQkLnB0ciA9IHJhd1BvaW50ZXI7CiAgICAgICAgICAgICAgICByZWdpc3RlcmVkSW5zdGFuY2UuJCQuc21hcnRQdHIgPSBwdHI7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVnaXN0ZXJlZEluc3RhbmNlWyJjbG9uZSJdKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBydiA9IHJlZ2lzdGVyZWRJbnN0YW5jZVsiY2xvbmUiXSgpOwogICAgICAgICAgICAgICAgdGhpcy5kZXN0cnVjdG9yKHB0cik7CiAgICAgICAgICAgICAgICByZXR1cm4gcnY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIG1ha2VEZWZhdWx0SGFuZGxlKCkgewogICAgICAgICAgICAgIGlmICh0aGlzLmlzU21hcnRQb2ludGVyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWFrZUNsYXNzSGFuZGxlKHRoaXMucmVnaXN0ZXJlZENsYXNzLmluc3RhbmNlUHJvdG90eXBlLCB7IHB0clR5cGU6IHRoaXMucG9pbnRlZVR5cGUsIHB0cjogcmF3UG9pbnRlciwgc21hcnRQdHJUeXBlOiB0aGlzLCBzbWFydFB0cjogcHRyIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWFrZUNsYXNzSGFuZGxlKHRoaXMucmVnaXN0ZXJlZENsYXNzLmluc3RhbmNlUHJvdG90eXBlLCB7IHB0clR5cGU6IHRoaXMsIHB0ciB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFjdHVhbFR5cGUgPSB0aGlzLnJlZ2lzdGVyZWRDbGFzcy5nZXRBY3R1YWxUeXBlKHJhd1BvaW50ZXIpOwogICAgICAgICAgICB2YXIgcmVnaXN0ZXJlZFBvaW50ZXJSZWNvcmQgPSByZWdpc3RlcmVkUG9pbnRlcnNbYWN0dWFsVHlwZV07CiAgICAgICAgICAgIGlmICghcmVnaXN0ZXJlZFBvaW50ZXJSZWNvcmQpIHsKICAgICAgICAgICAgICByZXR1cm4gbWFrZURlZmF1bHRIYW5kbGUuY2FsbCh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdG9UeXBlOwogICAgICAgICAgICBpZiAodGhpcy5pc0NvbnN0KSB7CiAgICAgICAgICAgICAgdG9UeXBlID0gcmVnaXN0ZXJlZFBvaW50ZXJSZWNvcmQuY29uc3RQb2ludGVyVHlwZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0b1R5cGUgPSByZWdpc3RlcmVkUG9pbnRlclJlY29yZC5wb2ludGVyVHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZHAgPSBkb3duY2FzdFBvaW50ZXIocmF3UG9pbnRlciwgdGhpcy5yZWdpc3RlcmVkQ2xhc3MsIHRvVHlwZS5yZWdpc3RlcmVkQ2xhc3MpOwogICAgICAgICAgICBpZiAoZHAgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbWFrZURlZmF1bHRIYW5kbGUuY2FsbCh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5pc1NtYXJ0UG9pbnRlcikgewogICAgICAgICAgICAgIHJldHVybiBtYWtlQ2xhc3NIYW5kbGUodG9UeXBlLnJlZ2lzdGVyZWRDbGFzcy5pbnN0YW5jZVByb3RvdHlwZSwgeyBwdHJUeXBlOiB0b1R5cGUsIHB0cjogZHAsIHNtYXJ0UHRyVHlwZTogdGhpcywgc21hcnRQdHI6IHB0ciB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gbWFrZUNsYXNzSGFuZGxlKHRvVHlwZS5yZWdpc3RlcmVkQ2xhc3MuaW5zdGFuY2VQcm90b3R5cGUsIHsgcHRyVHlwZTogdG9UeXBlLCBwdHI6IGRwIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbml0X1JlZ2lzdGVyZWRQb2ludGVyKCkgewogICAgICAgICAgICBSZWdpc3RlcmVkUG9pbnRlci5wcm90b3R5cGUuZ2V0UG9pbnRlZSA9IFJlZ2lzdGVyZWRQb2ludGVyX2dldFBvaW50ZWU7CiAgICAgICAgICAgIFJlZ2lzdGVyZWRQb2ludGVyLnByb3RvdHlwZS5kZXN0cnVjdG9yID0gUmVnaXN0ZXJlZFBvaW50ZXJfZGVzdHJ1Y3RvcjsKICAgICAgICAgICAgUmVnaXN0ZXJlZFBvaW50ZXIucHJvdG90eXBlWyJhcmdQYWNrQWR2YW5jZSJdID0gODsKICAgICAgICAgICAgUmVnaXN0ZXJlZFBvaW50ZXIucHJvdG90eXBlWyJyZWFkVmFsdWVGcm9tUG9pbnRlciJdID0gc2ltcGxlUmVhZFZhbHVlRnJvbVBvaW50ZXI7CiAgICAgICAgICAgIFJlZ2lzdGVyZWRQb2ludGVyLnByb3RvdHlwZVsiZGVsZXRlT2JqZWN0Il0gPSBSZWdpc3RlcmVkUG9pbnRlcl9kZWxldGVPYmplY3Q7CiAgICAgICAgICAgIFJlZ2lzdGVyZWRQb2ludGVyLnByb3RvdHlwZVsiZnJvbVdpcmVUeXBlIl0gPSBSZWdpc3RlcmVkUG9pbnRlcl9mcm9tV2lyZVR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBSZWdpc3RlcmVkUG9pbnRlcihuYW1lLCByZWdpc3RlcmVkQ2xhc3MsIGlzUmVmZXJlbmNlLCBpc0NvbnN0LCBpc1NtYXJ0UG9pbnRlciwgcG9pbnRlZVR5cGUsIHNoYXJpbmdQb2xpY3ksIHJhd0dldFBvaW50ZWUsIHJhd0NvbnN0cnVjdG9yLCByYXdTaGFyZSwgcmF3RGVzdHJ1Y3RvcikgewogICAgICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgICAgICB0aGlzLnJlZ2lzdGVyZWRDbGFzcyA9IHJlZ2lzdGVyZWRDbGFzczsKICAgICAgICAgICAgdGhpcy5pc1JlZmVyZW5jZSA9IGlzUmVmZXJlbmNlOwogICAgICAgICAgICB0aGlzLmlzQ29uc3QgPSBpc0NvbnN0OwogICAgICAgICAgICB0aGlzLmlzU21hcnRQb2ludGVyID0gaXNTbWFydFBvaW50ZXI7CiAgICAgICAgICAgIHRoaXMucG9pbnRlZVR5cGUgPSBwb2ludGVlVHlwZTsKICAgICAgICAgICAgdGhpcy5zaGFyaW5nUG9saWN5ID0gc2hhcmluZ1BvbGljeTsKICAgICAgICAgICAgdGhpcy5yYXdHZXRQb2ludGVlID0gcmF3R2V0UG9pbnRlZTsKICAgICAgICAgICAgdGhpcy5yYXdDb25zdHJ1Y3RvciA9IHJhd0NvbnN0cnVjdG9yOwogICAgICAgICAgICB0aGlzLnJhd1NoYXJlID0gcmF3U2hhcmU7CiAgICAgICAgICAgIHRoaXMucmF3RGVzdHJ1Y3RvciA9IHJhd0Rlc3RydWN0b3I7CiAgICAgICAgICAgIGlmICghaXNTbWFydFBvaW50ZXIgJiYgcmVnaXN0ZXJlZENsYXNzLmJhc2VDbGFzcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKGlzQ29uc3QpIHsKICAgICAgICAgICAgICAgIHRoaXNbInRvV2lyZVR5cGUiXSA9IGNvbnN0Tm9TbWFydFB0clJhd1BvaW50ZXJUb1dpcmVUeXBlOwogICAgICAgICAgICAgICAgdGhpcy5kZXN0cnVjdG9yRnVuY3Rpb24gPSBudWxsOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzWyJ0b1dpcmVUeXBlIl0gPSBub25Db25zdE5vU21hcnRQdHJSYXdQb2ludGVyVG9XaXJlVHlwZTsKICAgICAgICAgICAgICAgIHRoaXMuZGVzdHJ1Y3RvckZ1bmN0aW9uID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpc1sidG9XaXJlVHlwZSJdID0gZ2VuZXJpY1BvaW50ZXJUb1dpcmVUeXBlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXBsYWNlUHVibGljU3ltYm9sKG5hbWUsIHZhbHVlLCBudW1Bcmd1bWVudHMpIHsKICAgICAgICAgICAgaWYgKCFNb2R1bGUuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICB0aHJvd0ludGVybmFsRXJyb3IoIlJlcGxhY2luZyBub25leGlzdGFudCBwdWJsaWMgc3ltYm9sIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZvaWQgMCAhPT0gTW9kdWxlW25hbWVdLm92ZXJsb2FkVGFibGUgJiYgdm9pZCAwICE9PSBudW1Bcmd1bWVudHMpIHsKICAgICAgICAgICAgICBNb2R1bGVbbmFtZV0ub3ZlcmxvYWRUYWJsZVtudW1Bcmd1bWVudHNdID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgTW9kdWxlW25hbWVdID0gdmFsdWU7CiAgICAgICAgICAgICAgTW9kdWxlW25hbWVdLmFyZ0NvdW50ID0gbnVtQXJndW1lbnRzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBkeW5DYWxsTGVnYWN5KHNpZywgcHRyLCBhcmdzKSB7CiAgICAgICAgICAgIHZhciBmID0gTW9kdWxlWyJkeW5DYWxsXyIgKyBzaWddOwogICAgICAgICAgICByZXR1cm4gYXJncyAmJiBhcmdzLmxlbmd0aCA/IGYuYXBwbHkobnVsbCwgW3B0cl0uY29uY2F0KGFyZ3MpKSA6IGYuY2FsbChudWxsLCBwdHIpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZHluQ2FsbChzaWcsIHB0ciwgYXJncykgewogICAgICAgICAgICBpZiAoc2lnLmluZGV4T2YoImoiKSAhPSAtMSkgewogICAgICAgICAgICAgIHJldHVybiBkeW5DYWxsTGVnYWN5KHNpZywgcHRyLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd2FzbVRhYmxlLmdldChwdHIpLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0RHluQ2FsbGVyKHNpZywgcHRyKSB7CiAgICAgICAgICAgIHZhciBhcmdDYWNoZSA9IFtdOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgYXJnQ2FjaGUubGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aDsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgYXJnQ2FjaGVbaV0gPSBhcmd1bWVudHNbaV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBkeW5DYWxsKHNpZywgcHRyLCBhcmdDYWNoZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBlbWJpbmRfX3JlcXVpcmVGdW5jdGlvbihzaWduYXR1cmUsIHJhd0Z1bmN0aW9uKSB7CiAgICAgICAgICAgIHNpZ25hdHVyZSA9IHJlYWRMYXRpbjFTdHJpbmcoc2lnbmF0dXJlKTsKICAgICAgICAgICAgZnVuY3Rpb24gbWFrZUR5bkNhbGxlcigpIHsKICAgICAgICAgICAgICBpZiAoc2lnbmF0dXJlLmluZGV4T2YoImoiKSAhPSAtMSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGdldER5bkNhbGxlcihzaWduYXR1cmUsIHJhd0Z1bmN0aW9uKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHdhc21UYWJsZS5nZXQocmF3RnVuY3Rpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmcCA9IG1ha2VEeW5DYWxsZXIoKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRocm93QmluZGluZ0Vycm9yKCJ1bmtub3duIGZ1bmN0aW9uIHBvaW50ZXIgd2l0aCBzaWduYXR1cmUgIiArIHNpZ25hdHVyZSArICI6ICIgKyByYXdGdW5jdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZwOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFVuYm91bmRUeXBlRXJyb3IgPSB2b2lkIDA7CiAgICAgICAgICBmdW5jdGlvbiBnZXRUeXBlTmFtZSh0eXBlKSB7CiAgICAgICAgICAgIHZhciBwdHIgPSBfX19nZXRUeXBlTmFtZSh0eXBlKTsKICAgICAgICAgICAgdmFyIHJ2ID0gcmVhZExhdGluMVN0cmluZyhwdHIpOwogICAgICAgICAgICBfZnJlZShwdHIpOwogICAgICAgICAgICByZXR1cm4gcnY7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB0aHJvd1VuYm91bmRUeXBlRXJyb3IobWVzc2FnZSwgdHlwZXMpIHsKICAgICAgICAgICAgdmFyIHVuYm91bmRUeXBlcyA9IFtdOwogICAgICAgICAgICB2YXIgc2VlbiA9IHt9OwogICAgICAgICAgICBmdW5jdGlvbiB2aXNpdCh0eXBlKSB7CiAgICAgICAgICAgICAgaWYgKHNlZW5bdHlwZV0pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdGVyZWRUeXBlc1t0eXBlXSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZURlcGVuZGVuY2llc1t0eXBlXSkgewogICAgICAgICAgICAgICAgdHlwZURlcGVuZGVuY2llc1t0eXBlXS5mb3JFYWNoKHZpc2l0KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdW5ib3VuZFR5cGVzLnB1c2godHlwZSk7CiAgICAgICAgICAgICAgc2Vlblt0eXBlXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHlwZXMuZm9yRWFjaCh2aXNpdCk7CiAgICAgICAgICAgIHRocm93IG5ldyBVbmJvdW5kVHlwZUVycm9yKG1lc3NhZ2UgKyAiOiAiICsgdW5ib3VuZFR5cGVzLm1hcChnZXRUeXBlTmFtZSkuam9pbihbIiwgIl0pKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX2NsYXNzKHJhd1R5cGUsIHJhd1BvaW50ZXJUeXBlLCByYXdDb25zdFBvaW50ZXJUeXBlLCBiYXNlQ2xhc3NSYXdUeXBlLCBnZXRBY3R1YWxUeXBlU2lnbmF0dXJlLCBnZXRBY3R1YWxUeXBlLCB1cGNhc3RTaWduYXR1cmUsIHVwY2FzdCwgZG93bmNhc3RTaWduYXR1cmUsIGRvd25jYXN0LCBuYW1lLCBkZXN0cnVjdG9yU2lnbmF0dXJlLCByYXdEZXN0cnVjdG9yKSB7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICBnZXRBY3R1YWxUeXBlID0gZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oZ2V0QWN0dWFsVHlwZVNpZ25hdHVyZSwgZ2V0QWN0dWFsVHlwZSk7CiAgICAgICAgICAgIGlmICh1cGNhc3QpIHsKICAgICAgICAgICAgICB1cGNhc3QgPSBlbWJpbmRfX3JlcXVpcmVGdW5jdGlvbih1cGNhc3RTaWduYXR1cmUsIHVwY2FzdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRvd25jYXN0KSB7CiAgICAgICAgICAgICAgZG93bmNhc3QgPSBlbWJpbmRfX3JlcXVpcmVGdW5jdGlvbihkb3duY2FzdFNpZ25hdHVyZSwgZG93bmNhc3QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJhd0Rlc3RydWN0b3IgPSBlbWJpbmRfX3JlcXVpcmVGdW5jdGlvbihkZXN0cnVjdG9yU2lnbmF0dXJlLCByYXdEZXN0cnVjdG9yKTsKICAgICAgICAgICAgdmFyIGxlZ2FsRnVuY3Rpb25OYW1lID0gbWFrZUxlZ2FsRnVuY3Rpb25OYW1lKG5hbWUpOwogICAgICAgICAgICBleHBvc2VQdWJsaWNTeW1ib2wobGVnYWxGdW5jdGlvbk5hbWUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRocm93VW5ib3VuZFR5cGVFcnJvcigiQ2Fubm90IGNvbnN0cnVjdCAiICsgbmFtZSArICIgZHVlIHRvIHVuYm91bmQgdHlwZXMiLCBbYmFzZUNsYXNzUmF3VHlwZV0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2hlbkRlcGVuZGVudFR5cGVzQXJlUmVzb2x2ZWQoW3Jhd1R5cGUsIHJhd1BvaW50ZXJUeXBlLCByYXdDb25zdFBvaW50ZXJUeXBlXSwgYmFzZUNsYXNzUmF3VHlwZSA/IFtiYXNlQ2xhc3NSYXdUeXBlXSA6IFtdLCBmdW5jdGlvbihiYXNlKSB7CiAgICAgICAgICAgICAgYmFzZSA9IGJhc2VbMF07CiAgICAgICAgICAgICAgdmFyIGJhc2VDbGFzczsKICAgICAgICAgICAgICB2YXIgYmFzZVByb3RvdHlwZTsKICAgICAgICAgICAgICBpZiAoYmFzZUNsYXNzUmF3VHlwZSkgewogICAgICAgICAgICAgICAgYmFzZUNsYXNzID0gYmFzZS5yZWdpc3RlcmVkQ2xhc3M7CiAgICAgICAgICAgICAgICBiYXNlUHJvdG90eXBlID0gYmFzZUNsYXNzLmluc3RhbmNlUHJvdG90eXBlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBiYXNlUHJvdG90eXBlID0gQ2xhc3NIYW5kbGUucHJvdG90eXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgY29uc3RydWN0b3IgPSBjcmVhdGVOYW1lZEZ1bmN0aW9uKGxlZ2FsRnVuY3Rpb25OYW1lLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmIChPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcykgIT09IGluc3RhbmNlUHJvdG90eXBlKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBCaW5kaW5nRXJyb3IoIlVzZSAnbmV3JyB0byBjb25zdHJ1Y3QgIiArIG5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gcmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHkpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJpbmRpbmdFcnJvcihuYW1lICsgIiBoYXMgbm8gYWNjZXNzaWJsZSBjb25zdHJ1Y3RvciIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGJvZHkgPSByZWdpc3RlcmVkQ2xhc3MuY29uc3RydWN0b3JfYm9keVthcmd1bWVudHMubGVuZ3RoXTsKICAgICAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IGJvZHkpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJpbmRpbmdFcnJvcigiVHJpZWQgdG8gaW52b2tlIGN0b3Igb2YgIiArIG5hbWUgKyAiIHdpdGggaW52YWxpZCBudW1iZXIgb2YgcGFyYW1ldGVycyAoIiArIGFyZ3VtZW50cy5sZW5ndGggKyAiKSAtIGV4cGVjdGVkICgiICsgT2JqZWN0LmtleXMocmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHkpLnRvU3RyaW5nKCkgKyAiKSBwYXJhbWV0ZXJzIGluc3RlYWQhIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYm9keS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciBpbnN0YW5jZVByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoYmFzZVByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogY29uc3RydWN0b3IgfSB9KTsKICAgICAgICAgICAgICBjb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSBpbnN0YW5jZVByb3RvdHlwZTsKICAgICAgICAgICAgICB2YXIgcmVnaXN0ZXJlZENsYXNzID0gbmV3IFJlZ2lzdGVyZWRDbGFzcyhuYW1lLCBjb25zdHJ1Y3RvciwgaW5zdGFuY2VQcm90b3R5cGUsIHJhd0Rlc3RydWN0b3IsIGJhc2VDbGFzcywgZ2V0QWN0dWFsVHlwZSwgdXBjYXN0LCBkb3duY2FzdCk7CiAgICAgICAgICAgICAgdmFyIHJlZmVyZW5jZUNvbnZlcnRlciA9IG5ldyBSZWdpc3RlcmVkUG9pbnRlcihuYW1lLCByZWdpc3RlcmVkQ2xhc3MsIHRydWUsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgdmFyIHBvaW50ZXJDb252ZXJ0ZXIgPSBuZXcgUmVnaXN0ZXJlZFBvaW50ZXIobmFtZSArICIqIiwgcmVnaXN0ZXJlZENsYXNzLCBmYWxzZSwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICB2YXIgY29uc3RQb2ludGVyQ29udmVydGVyID0gbmV3IFJlZ2lzdGVyZWRQb2ludGVyKG5hbWUgKyAiIGNvbnN0KiIsIHJlZ2lzdGVyZWRDbGFzcywgZmFsc2UsIHRydWUsIGZhbHNlKTsKICAgICAgICAgICAgICByZWdpc3RlcmVkUG9pbnRlcnNbcmF3VHlwZV0gPSB7IHBvaW50ZXJUeXBlOiBwb2ludGVyQ29udmVydGVyLCBjb25zdFBvaW50ZXJUeXBlOiBjb25zdFBvaW50ZXJDb252ZXJ0ZXIgfTsKICAgICAgICAgICAgICByZXBsYWNlUHVibGljU3ltYm9sKGxlZ2FsRnVuY3Rpb25OYW1lLCBjb25zdHJ1Y3Rvcik7CiAgICAgICAgICAgICAgcmV0dXJuIFtyZWZlcmVuY2VDb252ZXJ0ZXIsIHBvaW50ZXJDb252ZXJ0ZXIsIGNvbnN0UG9pbnRlckNvbnZlcnRlcl07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaGVhcDMyVmVjdG9yVG9BcnJheShjb3VudCwgZmlyc3RFbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgICAgICBhcnJheS5wdXNoKEhFQVAzMlsoZmlyc3RFbGVtZW50ID4+IDIpICsgaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhcnJheTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX2NsYXNzX2NvbnN0cnVjdG9yKHJhd0NsYXNzVHlwZSwgYXJnQ291bnQsIHJhd0FyZ1R5cGVzQWRkciwgaW52b2tlclNpZ25hdHVyZSwgaW52b2tlciwgcmF3Q29uc3RydWN0b3IpIHsKICAgICAgICAgICAgYXNzZXJ0KGFyZ0NvdW50ID4gMCk7CiAgICAgICAgICAgIHZhciByYXdBcmdUeXBlcyA9IGhlYXAzMlZlY3RvclRvQXJyYXkoYXJnQ291bnQsIHJhd0FyZ1R5cGVzQWRkcik7CiAgICAgICAgICAgIGludm9rZXIgPSBlbWJpbmRfX3JlcXVpcmVGdW5jdGlvbihpbnZva2VyU2lnbmF0dXJlLCBpbnZva2VyKTsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbcmF3Q29uc3RydWN0b3JdOwogICAgICAgICAgICB2YXIgZGVzdHJ1Y3RvcnMgPSBbXTsKICAgICAgICAgICAgd2hlbkRlcGVuZGVudFR5cGVzQXJlUmVzb2x2ZWQoW10sIFtyYXdDbGFzc1R5cGVdLCBmdW5jdGlvbihjbGFzc1R5cGUpIHsKICAgICAgICAgICAgICBjbGFzc1R5cGUgPSBjbGFzc1R5cGVbMF07CiAgICAgICAgICAgICAgdmFyIGh1bWFuTmFtZSA9ICJjb25zdHJ1Y3RvciAiICsgY2xhc3NUeXBlLm5hbWU7CiAgICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gY2xhc3NUeXBlLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5KSB7CiAgICAgICAgICAgICAgICBjbGFzc1R5cGUucmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHkgPSBbXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHZvaWQgMCAhPT0gY2xhc3NUeXBlLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5W2FyZ0NvdW50IC0gMV0pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBCaW5kaW5nRXJyb3IoIkNhbm5vdCByZWdpc3RlciBtdWx0aXBsZSBjb25zdHJ1Y3RvcnMgd2l0aCBpZGVudGljYWwgbnVtYmVyIG9mIHBhcmFtZXRlcnMgKCIgKyAoYXJnQ291bnQgLSAxKSArICIpIGZvciBjbGFzcyAnIiArIGNsYXNzVHlwZS5uYW1lICsgIichIE92ZXJsb2FkIHJlc29sdXRpb24gaXMgY3VycmVudGx5IG9ubHkgcGVyZm9ybWVkIHVzaW5nIHRoZSBwYXJhbWV0ZXIgY291bnQsIG5vdCBhY3R1YWwgdHlwZSBpbmZvISIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjbGFzc1R5cGUucmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHlbYXJnQ291bnQgLSAxXSA9IGZ1bmN0aW9uIHVuYm91bmRUeXBlSGFuZGxlcigpIHsKICAgICAgICAgICAgICAgIHRocm93VW5ib3VuZFR5cGVFcnJvcigiQ2Fubm90IGNvbnN0cnVjdCAiICsgY2xhc3NUeXBlLm5hbWUgKyAiIGR1ZSB0byB1bmJvdW5kIHR5cGVzIiwgcmF3QXJnVHlwZXMpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd2hlbkRlcGVuZGVudFR5cGVzQXJlUmVzb2x2ZWQoW10sIHJhd0FyZ1R5cGVzLCBmdW5jdGlvbihhcmdUeXBlcykgewogICAgICAgICAgICAgICAgY2xhc3NUeXBlLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5W2FyZ0NvdW50IC0gMV0gPSBmdW5jdGlvbiBjb25zdHJ1Y3Rvcl9ib2R5KCkgewogICAgICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCAhPT0gYXJnQ291bnQgLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoaHVtYW5OYW1lICsgIiBjYWxsZWQgd2l0aCAiICsgYXJndW1lbnRzLmxlbmd0aCArICIgYXJndW1lbnRzLCBleHBlY3RlZCAiICsgKGFyZ0NvdW50IC0gMSkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlc3RydWN0b3JzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICAgIGFyZ3MubGVuZ3RoID0gYXJnQ291bnQ7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJnQ291bnQ7ICsraSkgewogICAgICAgICAgICAgICAgICAgIGFyZ3NbaV0gPSBhcmdUeXBlc1tpXVsidG9XaXJlVHlwZSJdKGRlc3RydWN0b3JzLCBhcmd1bWVudHNbaSAtIDFdKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgcHRyID0gaW52b2tlci5hcHBseShudWxsLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgcnVuRGVzdHJ1Y3RvcnMoZGVzdHJ1Y3RvcnMpOwogICAgICAgICAgICAgICAgICByZXR1cm4gYXJnVHlwZXNbMF1bImZyb21XaXJlVHlwZSJdKHB0cik7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBuZXdfKGNvbnN0cnVjdG9yLCBhcmd1bWVudExpc3QpIHsKICAgICAgICAgICAgaWYgKCEoY29uc3RydWN0b3IgaW5zdGFuY2VvZiBGdW5jdGlvbikpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJuZXdfIGNhbGxlZCB3aXRoIGNvbnN0cnVjdG9yIHR5cGUgIiArIHR5cGVvZiBjb25zdHJ1Y3RvciArICIgd2hpY2ggaXMgbm90IGEgZnVuY3Rpb24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZHVtbXkgPSBjcmVhdGVOYW1lZEZ1bmN0aW9uKGNvbnN0cnVjdG9yLm5hbWUgfHwgInVua25vd25GdW5jdGlvbk5hbWUiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGR1bW15LnByb3RvdHlwZSA9IGNvbnN0cnVjdG9yLnByb3RvdHlwZTsKICAgICAgICAgICAgdmFyIG9iaiA9IG5ldyBkdW1teSgpOwogICAgICAgICAgICB2YXIgciA9IGNvbnN0cnVjdG9yLmFwcGx5KG9iaiwgYXJndW1lbnRMaXN0KTsKICAgICAgICAgICAgcmV0dXJuIHIgaW5zdGFuY2VvZiBPYmplY3QgPyByIDogb2JqOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JhZnRJbnZva2VyRnVuY3Rpb24oaHVtYW5OYW1lLCBhcmdUeXBlcywgY2xhc3NUeXBlLCBjcHBJbnZva2VyRnVuYywgY3BwVGFyZ2V0RnVuYykgewogICAgICAgICAgICB2YXIgYXJnQ291bnQgPSBhcmdUeXBlcy5sZW5ndGg7CiAgICAgICAgICAgIGlmIChhcmdDb3VudCA8IDIpIHsKICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiYXJnVHlwZXMgYXJyYXkgc2l6ZSBtaXNtYXRjaCEgTXVzdCBhdCBsZWFzdCBnZXQgcmV0dXJuIHZhbHVlIGFuZCAndGhpcycgdHlwZXMhIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGlzQ2xhc3NNZXRob2RGdW5jID0gYXJnVHlwZXNbMV0gIT09IG51bGwgJiYgY2xhc3NUeXBlICE9PSBudWxsOwogICAgICAgICAgICB2YXIgbmVlZHNEZXN0cnVjdG9yU3RhY2sgPSBmYWxzZTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmdUeXBlcy5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgIGlmIChhcmdUeXBlc1tpXSAhPT0gbnVsbCAmJiBhcmdUeXBlc1tpXS5kZXN0cnVjdG9yRnVuY3Rpb24gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgbmVlZHNEZXN0cnVjdG9yU3RhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXR1cm5zID0gYXJnVHlwZXNbMF0ubmFtZSAhPT0gInZvaWQiOwogICAgICAgICAgICB2YXIgYXJnc0xpc3QgPSAiIjsKICAgICAgICAgICAgdmFyIGFyZ3NMaXN0V2lyZWQgPSAiIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdDb3VudCAtIDI7ICsraSkgewogICAgICAgICAgICAgIGFyZ3NMaXN0ICs9IChpICE9PSAwID8gIiwgIiA6ICIiKSArICJhcmciICsgaTsKICAgICAgICAgICAgICBhcmdzTGlzdFdpcmVkICs9IChpICE9PSAwID8gIiwgIiA6ICIiKSArICJhcmciICsgaSArICJXaXJlZCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGludm9rZXJGbkJvZHkgPSAicmV0dXJuIGZ1bmN0aW9uICIgKyBtYWtlTGVnYWxGdW5jdGlvbk5hbWUoaHVtYW5OYW1lKSArICIoIiArIGFyZ3NMaXN0ICsgIikge1xuaWYgKGFyZ3VtZW50cy5sZW5ndGggIT09ICIgKyAoYXJnQ291bnQgLSAyKSArICIpIHtcbnRocm93QmluZGluZ0Vycm9yKCdmdW5jdGlvbiAiICsgaHVtYW5OYW1lICsgIiBjYWxsZWQgd2l0aCAnICsgYXJndW1lbnRzLmxlbmd0aCArICcgYXJndW1lbnRzLCBleHBlY3RlZCAiICsgKGFyZ0NvdW50IC0gMikgKyAiIGFyZ3MhJyk7XG59XG4iOwogICAgICAgICAgICBpZiAobmVlZHNEZXN0cnVjdG9yU3RhY2spIHsKICAgICAgICAgICAgICBpbnZva2VyRm5Cb2R5ICs9ICJ2YXIgZGVzdHJ1Y3RvcnMgPSBbXTtcbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGR0b3JTdGFjayA9IG5lZWRzRGVzdHJ1Y3RvclN0YWNrID8gImRlc3RydWN0b3JzIiA6ICJudWxsIjsKICAgICAgICAgICAgdmFyIGFyZ3MxID0gWyJ0aHJvd0JpbmRpbmdFcnJvciIsICJpbnZva2VyIiwgImZuIiwgInJ1bkRlc3RydWN0b3JzIiwgInJldFR5cGUiLCAiY2xhc3NQYXJhbSJdOwogICAgICAgICAgICB2YXIgYXJnczIgPSBbdGhyb3dCaW5kaW5nRXJyb3IsIGNwcEludm9rZXJGdW5jLCBjcHBUYXJnZXRGdW5jLCBydW5EZXN0cnVjdG9ycywgYXJnVHlwZXNbMF0sIGFyZ1R5cGVzWzFdXTsKICAgICAgICAgICAgaWYgKGlzQ2xhc3NNZXRob2RGdW5jKSB7CiAgICAgICAgICAgICAgaW52b2tlckZuQm9keSArPSAidmFyIHRoaXNXaXJlZCA9IGNsYXNzUGFyYW0udG9XaXJlVHlwZSgiICsgZHRvclN0YWNrICsgIiwgdGhpcyk7XG4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnQ291bnQgLSAyOyArK2kpIHsKICAgICAgICAgICAgICBpbnZva2VyRm5Cb2R5ICs9ICJ2YXIgYXJnIiArIGkgKyAiV2lyZWQgPSBhcmdUeXBlIiArIGkgKyAiLnRvV2lyZVR5cGUoIiArIGR0b3JTdGFjayArICIsIGFyZyIgKyBpICsgIik7IC8vICIgKyBhcmdUeXBlc1tpICsgMl0ubmFtZSArICJcbiI7CiAgICAgICAgICAgICAgYXJnczEucHVzaCgiYXJnVHlwZSIgKyBpKTsKICAgICAgICAgICAgICBhcmdzMi5wdXNoKGFyZ1R5cGVzW2kgKyAyXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ2xhc3NNZXRob2RGdW5jKSB7CiAgICAgICAgICAgICAgYXJnc0xpc3RXaXJlZCA9ICJ0aGlzV2lyZWQiICsgKGFyZ3NMaXN0V2lyZWQubGVuZ3RoID4gMCA/ICIsICIgOiAiIikgKyBhcmdzTGlzdFdpcmVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGludm9rZXJGbkJvZHkgKz0gKHJldHVybnMgPyAidmFyIHJ2ID0gIiA6ICIiKSArICJpbnZva2VyKGZuIiArIChhcmdzTGlzdFdpcmVkLmxlbmd0aCA+IDAgPyAiLCAiIDogIiIpICsgYXJnc0xpc3RXaXJlZCArICIpO1xuIjsKICAgICAgICAgICAgaWYgKG5lZWRzRGVzdHJ1Y3RvclN0YWNrKSB7CiAgICAgICAgICAgICAgaW52b2tlckZuQm9keSArPSAicnVuRGVzdHJ1Y3RvcnMoZGVzdHJ1Y3RvcnMpO1xuIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gaXNDbGFzc01ldGhvZEZ1bmMgPyAxIDogMjsgaSA8IGFyZ1R5cGVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFyYW1OYW1lID0gaSA9PT0gMSA/ICJ0aGlzV2lyZWQiIDogImFyZyIgKyAoaSAtIDIpICsgIldpcmVkIjsKICAgICAgICAgICAgICAgIGlmIChhcmdUeXBlc1tpXS5kZXN0cnVjdG9yRnVuY3Rpb24gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaW52b2tlckZuQm9keSArPSBwYXJhbU5hbWUgKyAiX2R0b3IoIiArIHBhcmFtTmFtZSArICIpOyAvLyAiICsgYXJnVHlwZXNbaV0ubmFtZSArICJcbiI7CiAgICAgICAgICAgICAgICAgIGFyZ3MxLnB1c2gocGFyYW1OYW1lICsgIl9kdG9yIik7CiAgICAgICAgICAgICAgICAgIGFyZ3MyLnB1c2goYXJnVHlwZXNbaV0uZGVzdHJ1Y3RvckZ1bmN0aW9uKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJldHVybnMpIHsKICAgICAgICAgICAgICBpbnZva2VyRm5Cb2R5ICs9ICJ2YXIgcmV0ID0gcmV0VHlwZS5mcm9tV2lyZVR5cGUocnYpO1xucmV0dXJuIHJldDtcbiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW52b2tlckZuQm9keSArPSAifVxuIjsKICAgICAgICAgICAgYXJnczEucHVzaChpbnZva2VyRm5Cb2R5KTsKICAgICAgICAgICAgdmFyIGludm9rZXJGdW5jdGlvbiA9IG5ld18oRnVuY3Rpb24sIGFyZ3MxKS5hcHBseShudWxsLCBhcmdzMik7CiAgICAgICAgICAgIHJldHVybiBpbnZva2VyRnVuY3Rpb247CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9jbGFzc19mdW5jdGlvbihyYXdDbGFzc1R5cGUsIG1ldGhvZE5hbWUsIGFyZ0NvdW50LCByYXdBcmdUeXBlc0FkZHIsIGludm9rZXJTaWduYXR1cmUsIHJhd0ludm9rZXIsIGNvbnRleHQsIGlzUHVyZVZpcnR1YWwpIHsKICAgICAgICAgICAgdmFyIHJhd0FyZ1R5cGVzID0gaGVhcDMyVmVjdG9yVG9BcnJheShhcmdDb3VudCwgcmF3QXJnVHlwZXNBZGRyKTsKICAgICAgICAgICAgbWV0aG9kTmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobWV0aG9kTmFtZSk7CiAgICAgICAgICAgIHJhd0ludm9rZXIgPSBlbWJpbmRfX3JlcXVpcmVGdW5jdGlvbihpbnZva2VyU2lnbmF0dXJlLCByYXdJbnZva2VyKTsKICAgICAgICAgICAgd2hlbkRlcGVuZGVudFR5cGVzQXJlUmVzb2x2ZWQoW10sIFtyYXdDbGFzc1R5cGVdLCBmdW5jdGlvbihjbGFzc1R5cGUpIHsKICAgICAgICAgICAgICBjbGFzc1R5cGUgPSBjbGFzc1R5cGVbMF07CiAgICAgICAgICAgICAgdmFyIGh1bWFuTmFtZSA9IGNsYXNzVHlwZS5uYW1lICsgIi4iICsgbWV0aG9kTmFtZTsKICAgICAgICAgICAgICBpZiAoaXNQdXJlVmlydHVhbCkgewogICAgICAgICAgICAgICAgY2xhc3NUeXBlLnJlZ2lzdGVyZWRDbGFzcy5wdXJlVmlydHVhbEZ1bmN0aW9ucy5wdXNoKG1ldGhvZE5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmdW5jdGlvbiB1bmJvdW5kVHlwZXNIYW5kbGVyKCkgewogICAgICAgICAgICAgICAgdGhyb3dVbmJvdW5kVHlwZUVycm9yKCJDYW5ub3QgY2FsbCAiICsgaHVtYW5OYW1lICsgIiBkdWUgdG8gdW5ib3VuZCB0eXBlcyIsIHJhd0FyZ1R5cGVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHByb3RvID0gY2xhc3NUeXBlLnJlZ2lzdGVyZWRDbGFzcy5pbnN0YW5jZVByb3RvdHlwZTsKICAgICAgICAgICAgICB2YXIgbWV0aG9kID0gcHJvdG9bbWV0aG9kTmFtZV07CiAgICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gbWV0aG9kIHx8IHZvaWQgMCA9PT0gbWV0aG9kLm92ZXJsb2FkVGFibGUgJiYgbWV0aG9kLmNsYXNzTmFtZSAhPT0gY2xhc3NUeXBlLm5hbWUgJiYgbWV0aG9kLmFyZ0NvdW50ID09PSBhcmdDb3VudCAtIDIpIHsKICAgICAgICAgICAgICAgIHVuYm91bmRUeXBlc0hhbmRsZXIuYXJnQ291bnQgPSBhcmdDb3VudCAtIDI7CiAgICAgICAgICAgICAgICB1bmJvdW5kVHlwZXNIYW5kbGVyLmNsYXNzTmFtZSA9IGNsYXNzVHlwZS5uYW1lOwogICAgICAgICAgICAgICAgcHJvdG9bbWV0aG9kTmFtZV0gPSB1bmJvdW5kVHlwZXNIYW5kbGVyOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbnN1cmVPdmVybG9hZFRhYmxlKHByb3RvLCBtZXRob2ROYW1lLCBodW1hbk5hbWUpOwogICAgICAgICAgICAgICAgcHJvdG9bbWV0aG9kTmFtZV0ub3ZlcmxvYWRUYWJsZVthcmdDb3VudCAtIDJdID0gdW5ib3VuZFR5cGVzSGFuZGxlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hlbkRlcGVuZGVudFR5cGVzQXJlUmVzb2x2ZWQoW10sIHJhd0FyZ1R5cGVzLCBmdW5jdGlvbihhcmdUeXBlcykgewogICAgICAgICAgICAgICAgdmFyIG1lbWJlckZ1bmN0aW9uID0gY3JhZnRJbnZva2VyRnVuY3Rpb24oaHVtYW5OYW1lLCBhcmdUeXBlcywgY2xhc3NUeXBlLCByYXdJbnZva2VyLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgIGlmICh2b2lkIDAgPT09IHByb3RvW21ldGhvZE5hbWVdLm92ZXJsb2FkVGFibGUpIHsKICAgICAgICAgICAgICAgICAgbWVtYmVyRnVuY3Rpb24uYXJnQ291bnQgPSBhcmdDb3VudCAtIDI7CiAgICAgICAgICAgICAgICAgIHByb3RvW21ldGhvZE5hbWVdID0gbWVtYmVyRnVuY3Rpb247CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcm90b1ttZXRob2ROYW1lXS5vdmVybG9hZFRhYmxlW2FyZ0NvdW50IC0gMl0gPSBtZW1iZXJGdW5jdGlvbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfY29uc3RhbnQobmFtZSwgdHlwZSwgdmFsdWUpIHsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKFtdLCBbdHlwZV0sIGZ1bmN0aW9uKHR5cGUyKSB7CiAgICAgICAgICAgICAgdHlwZTIgPSB0eXBlMlswXTsKICAgICAgICAgICAgICBNb2R1bGVbbmFtZV0gPSB0eXBlMlsiZnJvbVdpcmVUeXBlIl0odmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZW12YWxfZnJlZV9saXN0ID0gW107CiAgICAgICAgICB2YXIgZW12YWxfaGFuZGxlX2FycmF5ID0gW3t9LCB7IHZhbHVlOiB2b2lkIDAgfSwgeyB2YWx1ZTogbnVsbCB9LCB7IHZhbHVlOiB0cnVlIH0sIHsgdmFsdWU6IGZhbHNlIH1dOwogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9kZWNyZWYoaGFuZGxlKSB7CiAgICAgICAgICAgIGlmIChoYW5kbGUgPiA0ICYmIDAgPT09IC0tZW12YWxfaGFuZGxlX2FycmF5W2hhbmRsZV0ucmVmY291bnQpIHsKICAgICAgICAgICAgICBlbXZhbF9oYW5kbGVfYXJyYXlbaGFuZGxlXSA9IHZvaWQgMDsKICAgICAgICAgICAgICBlbXZhbF9mcmVlX2xpc3QucHVzaChoYW5kbGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBjb3VudF9lbXZhbF9oYW5kbGVzKCkgewogICAgICAgICAgICB2YXIgY291bnQgPSAwOwogICAgICAgICAgICBmb3IgKHZhciBpID0gNTsgaSA8IGVtdmFsX2hhbmRsZV9hcnJheS5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgIGlmIChlbXZhbF9oYW5kbGVfYXJyYXlbaV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgKytjb3VudDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvdW50OwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZ2V0X2ZpcnN0X2VtdmFsKCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gNTsgaSA8IGVtdmFsX2hhbmRsZV9hcnJheS5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgIGlmIChlbXZhbF9oYW5kbGVfYXJyYXlbaV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVtdmFsX2hhbmRsZV9hcnJheVtpXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBpbml0X2VtdmFsKCkgewogICAgICAgICAgICBNb2R1bGVbImNvdW50X2VtdmFsX2hhbmRsZXMiXSA9IGNvdW50X2VtdmFsX2hhbmRsZXM7CiAgICAgICAgICAgIE1vZHVsZVsiZ2V0X2ZpcnN0X2VtdmFsIl0gPSBnZXRfZmlyc3RfZW12YWw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX3JlZ2lzdGVyKHZhbHVlKSB7CiAgICAgICAgICAgIHN3aXRjaCAodmFsdWUpIHsKICAgICAgICAgICAgICBjYXNlIHZvaWQgMDogewogICAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgbnVsbDogewogICAgICAgICAgICAgICAgcmV0dXJuIDI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgdHJ1ZTogewogICAgICAgICAgICAgICAgcmV0dXJuIDM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgZmFsc2U6IHsKICAgICAgICAgICAgICAgIHJldHVybiA0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgICB2YXIgaGFuZGxlID0gZW12YWxfZnJlZV9saXN0Lmxlbmd0aCA/IGVtdmFsX2ZyZWVfbGlzdC5wb3AoKSA6IGVtdmFsX2hhbmRsZV9hcnJheS5sZW5ndGg7CiAgICAgICAgICAgICAgICBlbXZhbF9oYW5kbGVfYXJyYXlbaGFuZGxlXSA9IHsgcmVmY291bnQ6IDEsIHZhbHVlIH07CiAgICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfZW12YWwocmF3VHlwZSwgbmFtZSkgewogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgcmVnaXN0ZXJUeXBlKHJhd1R5cGUsIHsgbmFtZSwgImZyb21XaXJlVHlwZSI6IGZ1bmN0aW9uKGhhbmRsZSkgewogICAgICAgICAgICAgIHZhciBydiA9IGVtdmFsX2hhbmRsZV9hcnJheVtoYW5kbGVdLnZhbHVlOwogICAgICAgICAgICAgIF9fZW12YWxfZGVjcmVmKGhhbmRsZSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJ2OwogICAgICAgICAgICB9LCAidG9XaXJlVHlwZSI6IGZ1bmN0aW9uKGRlc3RydWN0b3JzLCB2YWx1ZSkgewogICAgICAgICAgICAgIHJldHVybiBfX2VtdmFsX3JlZ2lzdGVyKHZhbHVlKTsKICAgICAgICAgICAgfSwgImFyZ1BhY2tBZHZhbmNlIjogOCwgInJlYWRWYWx1ZUZyb21Qb2ludGVyIjogc2ltcGxlUmVhZFZhbHVlRnJvbVBvaW50ZXIsIGRlc3RydWN0b3JGdW5jdGlvbjogbnVsbCB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGVudW1SZWFkVmFsdWVGcm9tUG9pbnRlcihuYW1lLCBzaGlmdCwgc2lnbmVkKSB7CiAgICAgICAgICAgIHN3aXRjaCAoc2hpZnQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24ocG9pbnRlcikgewogICAgICAgICAgICAgICAgICB2YXIgaGVhcCA9IHNpZ25lZCA/IEhFQVA4IDogSEVBUFU4OwogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1siZnJvbVdpcmVUeXBlIl0oaGVhcFtwb2ludGVyXSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihwb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgIHZhciBoZWFwID0gc2lnbmVkID8gSEVBUDE2IDogSEVBUFUxNjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbImZyb21XaXJlVHlwZSJdKGhlYXBbcG9pbnRlciA+PiAxXSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihwb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgIHZhciBoZWFwID0gc2lnbmVkID8gSEVBUDMyIDogSEVBUFUzMjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbImZyb21XaXJlVHlwZSJdKGhlYXBbcG9pbnRlciA+PiAyXSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIGludGVnZXIgdHlwZTogIiArIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9lbnVtKHJhd1R5cGUsIG5hbWUsIHNpemUsIGlzU2lnbmVkKSB7CiAgICAgICAgICAgIHZhciBzaGlmdCA9IGdldFNoaWZ0RnJvbVNpemUoc2l6ZSk7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICBmdW5jdGlvbiBjdG9yKCkgewogICAgICAgICAgICB9CiAgICAgICAgICAgIGN0b3IudmFsdWVzID0ge307CiAgICAgICAgICAgIHJlZ2lzdGVyVHlwZShyYXdUeXBlLCB7IG5hbWUsIGNvbnN0cnVjdG9yOiBjdG9yLCAiZnJvbVdpcmVUeXBlIjogZnVuY3Rpb24oYykgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnZhbHVlc1tjXTsKICAgICAgICAgICAgfSwgInRvV2lyZVR5cGUiOiBmdW5jdGlvbihkZXN0cnVjdG9ycywgYykgewogICAgICAgICAgICAgIHJldHVybiBjLnZhbHVlOwogICAgICAgICAgICB9LCAiYXJnUGFja0FkdmFuY2UiOiA4LCAicmVhZFZhbHVlRnJvbVBvaW50ZXIiOiBlbnVtUmVhZFZhbHVlRnJvbVBvaW50ZXIobmFtZSwgc2hpZnQsIGlzU2lnbmVkKSwgZGVzdHJ1Y3RvckZ1bmN0aW9uOiBudWxsIH0pOwogICAgICAgICAgICBleHBvc2VQdWJsaWNTeW1ib2wobmFtZSwgY3Rvcik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZXF1aXJlUmVnaXN0ZXJlZFR5cGUocmF3VHlwZSwgaHVtYW5OYW1lKSB7CiAgICAgICAgICAgIHZhciBpbXBsID0gcmVnaXN0ZXJlZFR5cGVzW3Jhd1R5cGVdOwogICAgICAgICAgICBpZiAodm9pZCAwID09PSBpbXBsKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoaHVtYW5OYW1lICsgIiBoYXMgdW5rbm93biB0eXBlICIgKyBnZXRUeXBlTmFtZShyYXdUeXBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGltcGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9lbnVtX3ZhbHVlKHJhd0VudW1UeXBlLCBuYW1lLCBlbnVtVmFsdWUpIHsKICAgICAgICAgICAgdmFyIGVudW1UeXBlID0gcmVxdWlyZVJlZ2lzdGVyZWRUeXBlKHJhd0VudW1UeXBlLCAiZW51bSIpOwogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgdmFyIEVudW0gPSBlbnVtVHlwZS5jb25zdHJ1Y3RvcjsKICAgICAgICAgICAgdmFyIFZhbHVlID0gT2JqZWN0LmNyZWF0ZShlbnVtVHlwZS5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHsgdmFsdWU6IHsgdmFsdWU6IGVudW1WYWx1ZSB9LCBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogY3JlYXRlTmFtZWRGdW5jdGlvbihlbnVtVHlwZS5uYW1lICsgIl8iICsgbmFtZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIH0pIH0gfSk7CiAgICAgICAgICAgIEVudW0udmFsdWVzW2VudW1WYWx1ZV0gPSBWYWx1ZTsKICAgICAgICAgICAgRW51bVtuYW1lXSA9IFZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX2VtYmluZF9yZXByKHYzKSB7CiAgICAgICAgICAgIGlmICh2MyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiAibnVsbCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHQgPSB0eXBlb2YgdjM7CiAgICAgICAgICAgIGlmICh0ID09PSAib2JqZWN0IiB8fCB0ID09PSAiYXJyYXkiIHx8IHQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm4gdjMudG9TdHJpbmcoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gIiIgKyB2MzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZmxvYXRSZWFkVmFsdWVGcm9tUG9pbnRlcihuYW1lLCBzaGlmdCkgewogICAgICAgICAgICBzd2l0Y2ggKHNoaWZ0KSB7CiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHBvaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbImZyb21XaXJlVHlwZSJdKEhFQVBGMzJbcG9pbnRlciA+PiAyXSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihwb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWyJmcm9tV2lyZVR5cGUiXShIRUFQRjY0W3BvaW50ZXIgPj4gM10pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVW5rbm93biBmbG9hdCB0eXBlOiAiICsgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX2Zsb2F0KHJhd1R5cGUsIG5hbWUsIHNpemUpIHsKICAgICAgICAgICAgdmFyIHNoaWZ0ID0gZ2V0U2hpZnRGcm9tU2l6ZShzaXplKTsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIHJlZ2lzdGVyVHlwZShyYXdUeXBlLCB7IG5hbWUsICJmcm9tV2lyZVR5cGUiOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSwgInRvV2lyZVR5cGUiOiBmdW5jdGlvbihkZXN0cnVjdG9ycywgdmFsdWUpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAibnVtYmVyIiAmJiB0eXBlb2YgdmFsdWUgIT09ICJib29sZWFuIikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNvbnZlcnQgIicgKyBfZW1iaW5kX3JlcHIodmFsdWUpICsgJyIgdG8gJyArIHRoaXMubmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSwgImFyZ1BhY2tBZHZhbmNlIjogOCwgInJlYWRWYWx1ZUZyb21Qb2ludGVyIjogZmxvYXRSZWFkVmFsdWVGcm9tUG9pbnRlcihuYW1lLCBzaGlmdCksIGRlc3RydWN0b3JGdW5jdGlvbjogbnVsbCB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX2Z1bmN0aW9uKG5hbWUsIGFyZ0NvdW50LCByYXdBcmdUeXBlc0FkZHIsIHNpZ25hdHVyZSwgcmF3SW52b2tlciwgZm4pIHsKICAgICAgICAgICAgdmFyIGFyZ1R5cGVzID0gaGVhcDMyVmVjdG9yVG9BcnJheShhcmdDb3VudCwgcmF3QXJnVHlwZXNBZGRyKTsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIHJhd0ludm9rZXIgPSBlbWJpbmRfX3JlcXVpcmVGdW5jdGlvbihzaWduYXR1cmUsIHJhd0ludm9rZXIpOwogICAgICAgICAgICBleHBvc2VQdWJsaWNTeW1ib2wobmFtZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdGhyb3dVbmJvdW5kVHlwZUVycm9yKCJDYW5ub3QgY2FsbCAiICsgbmFtZSArICIgZHVlIHRvIHVuYm91bmQgdHlwZXMiLCBhcmdUeXBlcyk7CiAgICAgICAgICAgIH0sIGFyZ0NvdW50IC0gMSk7CiAgICAgICAgICAgIHdoZW5EZXBlbmRlbnRUeXBlc0FyZVJlc29sdmVkKFtdLCBhcmdUeXBlcywgZnVuY3Rpb24oYXJnVHlwZXMyKSB7CiAgICAgICAgICAgICAgdmFyIGludm9rZXJBcmdzQXJyYXkgPSBbYXJnVHlwZXMyWzBdLCBudWxsXS5jb25jYXQoYXJnVHlwZXMyLnNsaWNlKDEpKTsKICAgICAgICAgICAgICByZXBsYWNlUHVibGljU3ltYm9sKG5hbWUsIGNyYWZ0SW52b2tlckZ1bmN0aW9uKG5hbWUsIGludm9rZXJBcmdzQXJyYXksIG51bGwsIHJhd0ludm9rZXIsIGZuKSwgYXJnQ291bnQgLSAxKTsKICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gaW50ZWdlclJlYWRWYWx1ZUZyb21Qb2ludGVyKG5hbWUsIHNoaWZ0LCBzaWduZWQpIHsKICAgICAgICAgICAgc3dpdGNoIChzaGlmdCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJldHVybiBzaWduZWQgPyBmdW5jdGlvbiByZWFkUzhGcm9tUG9pbnRlcihwb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBIRUFQOFtwb2ludGVyXTsKICAgICAgICAgICAgICAgIH0gOiBmdW5jdGlvbiByZWFkVThGcm9tUG9pbnRlcihwb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBIRUFQVThbcG9pbnRlcl07CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIHJldHVybiBzaWduZWQgPyBmdW5jdGlvbiByZWFkUzE2RnJvbVBvaW50ZXIocG9pbnRlcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gSEVBUDE2W3BvaW50ZXIgPj4gMV07CiAgICAgICAgICAgICAgICB9IDogZnVuY3Rpb24gcmVhZFUxNkZyb21Qb2ludGVyKHBvaW50ZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIEhFQVBVMTZbcG9pbnRlciA+PiAxXTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgcmV0dXJuIHNpZ25lZCA/IGZ1bmN0aW9uIHJlYWRTMzJGcm9tUG9pbnRlcihwb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBIRUFQMzJbcG9pbnRlciA+PiAyXTsKICAgICAgICAgICAgICAgIH0gOiBmdW5jdGlvbiByZWFkVTMyRnJvbVBvaW50ZXIocG9pbnRlcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gSEVBUFUzMltwb2ludGVyID4+IDJdOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVW5rbm93biBpbnRlZ2VyIHR5cGU6ICIgKyBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfaW50ZWdlcihwcmltaXRpdmVUeXBlLCBuYW1lLCBzaXplLCBtaW5SYW5nZSwgbWF4UmFuZ2UpIHsKICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIGlmIChtYXhSYW5nZSA9PT0gLTEpIHsKICAgICAgICAgICAgICBtYXhSYW5nZSA9IDQyOTQ5NjcyOTU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNoaWZ0ID0gZ2V0U2hpZnRGcm9tU2l6ZShzaXplKTsKICAgICAgICAgICAgdmFyIGZyb21XaXJlVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAobWluUmFuZ2UgPT09IDApIHsKICAgICAgICAgICAgICB2YXIgYml0c2hpZnQgPSAzMiAtIDggKiBzaXplOwogICAgICAgICAgICAgIGZyb21XaXJlVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPDwgYml0c2hpZnQgPj4+IGJpdHNoaWZ0OwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGlzVW5zaWduZWRUeXBlID0gbmFtZS5pbmRleE9mKCJ1bnNpZ25lZCIpICE9IC0xOwogICAgICAgICAgICByZWdpc3RlclR5cGUocHJpbWl0aXZlVHlwZSwgeyBuYW1lLCAiZnJvbVdpcmVUeXBlIjogZnJvbVdpcmVUeXBlLCAidG9XaXJlVHlwZSI6IGZ1bmN0aW9uKGRlc3RydWN0b3JzLCB2YWx1ZSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICJudW1iZXIiICYmIHR5cGVvZiB2YWx1ZSAhPT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY29udmVydCAiJyArIF9lbWJpbmRfcmVwcih2YWx1ZSkgKyAnIiB0byAnICsgdGhpcy5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHZhbHVlIDwgbWluUmFuZ2UgfHwgdmFsdWUgPiBtYXhSYW5nZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignUGFzc2luZyBhIG51bWJlciAiJyArIF9lbWJpbmRfcmVwcih2YWx1ZSkgKyAnIiBmcm9tIEpTIHNpZGUgdG8gQy9DKysgc2lkZSB0byBhbiBhcmd1bWVudCBvZiB0eXBlICInICsgbmFtZSArICciLCB3aGljaCBpcyBvdXRzaWRlIHRoZSB2YWxpZCByYW5nZSBbJyArIG1pblJhbmdlICsgIiwgIiArIG1heFJhbmdlICsgIl0hIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBpc1Vuc2lnbmVkVHlwZSA/IHZhbHVlID4+PiAwIDogdmFsdWUgfCAwOwogICAgICAgICAgICB9LCAiYXJnUGFja0FkdmFuY2UiOiA4LCAicmVhZFZhbHVlRnJvbVBvaW50ZXIiOiBpbnRlZ2VyUmVhZFZhbHVlRnJvbVBvaW50ZXIobmFtZSwgc2hpZnQsIG1pblJhbmdlICE9PSAwKSwgZGVzdHJ1Y3RvckZ1bmN0aW9uOiBudWxsIH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfbWVtb3J5X3ZpZXcocmF3VHlwZSwgZGF0YVR5cGVJbmRleCwgbmFtZSkgewogICAgICAgICAgICB2YXIgdHlwZU1hcHBpbmcgPSBbSW50OEFycmF5LCBVaW50OEFycmF5LCBJbnQxNkFycmF5LCBVaW50MTZBcnJheSwgSW50MzJBcnJheSwgVWludDMyQXJyYXksIEZsb2F0MzJBcnJheSwgRmxvYXQ2NEFycmF5XTsKICAgICAgICAgICAgdmFyIFRBID0gdHlwZU1hcHBpbmdbZGF0YVR5cGVJbmRleF07CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlY29kZU1lbW9yeVZpZXcoaGFuZGxlKSB7CiAgICAgICAgICAgICAgaGFuZGxlID0gaGFuZGxlID4+IDI7CiAgICAgICAgICAgICAgdmFyIGhlYXAgPSBIRUFQVTMyOwogICAgICAgICAgICAgIHZhciBzaXplID0gaGVhcFtoYW5kbGVdOwogICAgICAgICAgICAgIHZhciBkYXRhID0gaGVhcFtoYW5kbGUgKyAxXTsKICAgICAgICAgICAgICByZXR1cm4gbmV3IFRBKGJ1ZmZlciwgZGF0YSwgc2l6ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmFtZSA9IHJlYWRMYXRpbjFTdHJpbmcobmFtZSk7CiAgICAgICAgICAgIHJlZ2lzdGVyVHlwZShyYXdUeXBlLCB7IG5hbWUsICJmcm9tV2lyZVR5cGUiOiBkZWNvZGVNZW1vcnlWaWV3LCAiYXJnUGFja0FkdmFuY2UiOiA4LCAicmVhZFZhbHVlRnJvbVBvaW50ZXIiOiBkZWNvZGVNZW1vcnlWaWV3IH0sIHsgaWdub3JlRHVwbGljYXRlUmVnaXN0cmF0aW9uczogdHJ1ZSB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX3N0ZF9zdHJpbmcocmF3VHlwZSwgbmFtZSkgewogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgdmFyIHN0ZFN0cmluZ0lzVVRGOCA9IG5hbWUgPT09ICJzdGQ6OnN0cmluZyI7CiAgICAgICAgICAgIHJlZ2lzdGVyVHlwZShyYXdUeXBlLCB7IG5hbWUsICJmcm9tV2lyZVR5cGUiOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHZhciBsZW5ndGggPSBIRUFQVTMyW3ZhbHVlID4+IDJdOwogICAgICAgICAgICAgIHZhciBzdHI7CiAgICAgICAgICAgICAgaWYgKHN0ZFN0cmluZ0lzVVRGOCkgewogICAgICAgICAgICAgICAgdmFyIGRlY29kZVN0YXJ0UHRyID0gdmFsdWUgKyA0OwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPD0gbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRCeXRlUHRyID0gdmFsdWUgKyA0ICsgaTsKICAgICAgICAgICAgICAgICAgaWYgKGkgPT0gbGVuZ3RoIHx8IEhFQVBVOFtjdXJyZW50Qnl0ZVB0cl0gPT0gMCkgewogICAgICAgICAgICAgICAgICAgIHZhciBtYXhSZWFkID0gY3VycmVudEJ5dGVQdHIgLSBkZWNvZGVTdGFydFB0cjsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RyaW5nU2VnbWVudCA9IFVURjhUb1N0cmluZyhkZWNvZGVTdGFydFB0ciwgbWF4UmVhZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0ciA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHJpbmdTZWdtZW50OwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgwKTsKICAgICAgICAgICAgICAgICAgICAgIHN0ciArPSBzdHJpbmdTZWdtZW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBkZWNvZGVTdGFydFB0ciA9IGN1cnJlbnRCeXRlUHRyICsgMTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgYTMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgICAgYTNbaV0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKEhFQVBVOFt2YWx1ZSArIDQgKyBpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHIgPSBhMy5qb2luKCIiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgX2ZyZWUodmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBzdHI7CiAgICAgICAgICAgIH0sICJ0b1dpcmVUeXBlIjogZnVuY3Rpb24oZGVzdHJ1Y3RvcnMsIHZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gbmV3IFVpbnQ4QXJyYXkodmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZ2V0TGVuZ3RoOwogICAgICAgICAgICAgIHZhciB2YWx1ZUlzT2ZUeXBlU3RyaW5nID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIjsKICAgICAgICAgICAgICBpZiAoISh2YWx1ZUlzT2ZUeXBlU3RyaW5nIHx8IHZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheSB8fCB2YWx1ZSBpbnN0YW5jZW9mIFVpbnQ4Q2xhbXBlZEFycmF5IHx8IHZhbHVlIGluc3RhbmNlb2YgSW50OEFycmF5KSkgewogICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIkNhbm5vdCBwYXNzIG5vbi1zdHJpbmcgdG8gc3RkOjpzdHJpbmciKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHN0ZFN0cmluZ0lzVVRGOCAmJiB2YWx1ZUlzT2ZUeXBlU3RyaW5nKSB7CiAgICAgICAgICAgICAgICBnZXRMZW5ndGggPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGxlbmd0aEJ5dGVzVVRGOCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBnZXRMZW5ndGggPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBsZW5ndGggPSBnZXRMZW5ndGgoKTsKICAgICAgICAgICAgICB2YXIgcHRyID0gX21hbGxvYyg0ICsgbGVuZ3RoICsgMSk7CiAgICAgICAgICAgICAgSEVBUFUzMltwdHIgPj4gMl0gPSBsZW5ndGg7CiAgICAgICAgICAgICAgaWYgKHN0ZFN0cmluZ0lzVVRGOCAmJiB2YWx1ZUlzT2ZUeXBlU3RyaW5nKSB7CiAgICAgICAgICAgICAgICBzdHJpbmdUb1VURjgodmFsdWUsIHB0ciArIDQsIGxlbmd0aCArIDEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodmFsdWVJc09mVHlwZVN0cmluZykgewogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNoYXJDb2RlID0gdmFsdWUuY2hhckNvZGVBdChpKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2hhckNvZGUgPiAyNTUpIHsKICAgICAgICAgICAgICAgICAgICAgIF9mcmVlKHB0cik7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvd0JpbmRpbmdFcnJvcigiU3RyaW5nIGhhcyBVVEYtMTYgY29kZSB1bml0cyB0aGF0IGRvIG5vdCBmaXQgaW4gOCBiaXRzIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIEhFQVBVOFtwdHIgKyA0ICsgaV0gPSBjaGFyQ29kZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgICAgICAgICAgIEhFQVBVOFtwdHIgKyA0ICsgaV0gPSB2YWx1ZVtpXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGVzdHJ1Y3RvcnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRlc3RydWN0b3JzLnB1c2goX2ZyZWUsIHB0cik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBwdHI7CiAgICAgICAgICAgIH0sICJhcmdQYWNrQWR2YW5jZSI6IDgsICJyZWFkVmFsdWVGcm9tUG9pbnRlciI6IHNpbXBsZVJlYWRWYWx1ZUZyb21Qb2ludGVyLCBkZXN0cnVjdG9yRnVuY3Rpb246IGZ1bmN0aW9uKHB0cikgewogICAgICAgICAgICAgIF9mcmVlKHB0cik7CiAgICAgICAgICAgIH0gfSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl9zdGRfd3N0cmluZyhyYXdUeXBlLCBjaGFyU2l6ZSwgbmFtZSkgewogICAgICAgICAgICBuYW1lID0gcmVhZExhdGluMVN0cmluZyhuYW1lKTsKICAgICAgICAgICAgdmFyIGRlY29kZVN0cmluZywgZW5jb2RlU3RyaW5nLCBnZXRIZWFwLCBsZW5ndGhCeXRlc1VURiwgc2hpZnQ7CiAgICAgICAgICAgIGlmIChjaGFyU2l6ZSA9PT0gMikgewogICAgICAgICAgICAgIGRlY29kZVN0cmluZyA9IFVURjE2VG9TdHJpbmc7CiAgICAgICAgICAgICAgZW5jb2RlU3RyaW5nID0gc3RyaW5nVG9VVEYxNjsKICAgICAgICAgICAgICBsZW5ndGhCeXRlc1VURiA9IGxlbmd0aEJ5dGVzVVRGMTY7CiAgICAgICAgICAgICAgZ2V0SGVhcCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIEhFQVBVMTY7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBzaGlmdCA9IDE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhclNpemUgPT09IDQpIHsKICAgICAgICAgICAgICBkZWNvZGVTdHJpbmcgPSBVVEYzMlRvU3RyaW5nOwogICAgICAgICAgICAgIGVuY29kZVN0cmluZyA9IHN0cmluZ1RvVVRGMzI7CiAgICAgICAgICAgICAgbGVuZ3RoQnl0ZXNVVEYgPSBsZW5ndGhCeXRlc1VURjMyOwogICAgICAgICAgICAgIGdldEhlYXAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBIRUFQVTMyOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgc2hpZnQgPSAyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlZ2lzdGVyVHlwZShyYXdUeXBlLCB7IG5hbWUsICJmcm9tV2lyZVR5cGUiOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHZhciBsZW5ndGggPSBIRUFQVTMyW3ZhbHVlID4+IDJdOwogICAgICAgICAgICAgIHZhciBIRUFQID0gZ2V0SGVhcCgpOwogICAgICAgICAgICAgIHZhciBzdHI7CiAgICAgICAgICAgICAgdmFyIGRlY29kZVN0YXJ0UHRyID0gdmFsdWUgKyA0OwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudEJ5dGVQdHIgPSB2YWx1ZSArIDQgKyBpICogY2hhclNpemU7CiAgICAgICAgICAgICAgICBpZiAoaSA9PSBsZW5ndGggfHwgSEVBUFtjdXJyZW50Qnl0ZVB0ciA+PiBzaGlmdF0gPT0gMCkgewogICAgICAgICAgICAgICAgICB2YXIgbWF4UmVhZEJ5dGVzID0gY3VycmVudEJ5dGVQdHIgLSBkZWNvZGVTdGFydFB0cjsKICAgICAgICAgICAgICAgICAgdmFyIHN0cmluZ1NlZ21lbnQgPSBkZWNvZGVTdHJpbmcoZGVjb2RlU3RhcnRQdHIsIG1heFJlYWRCeXRlcyk7CiAgICAgICAgICAgICAgICAgIGlmIChzdHIgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgIHN0ciA9IHN0cmluZ1NlZ21lbnQ7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMCk7CiAgICAgICAgICAgICAgICAgICAgc3RyICs9IHN0cmluZ1NlZ21lbnQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGVjb2RlU3RhcnRQdHIgPSBjdXJyZW50Qnl0ZVB0ciArIGNoYXJTaXplOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBfZnJlZSh2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgICAgICAgfSwgInRvV2lyZVR5cGUiOiBmdW5jdGlvbihkZXN0cnVjdG9ycywgdmFsdWUpIHsKICAgICAgICAgICAgICBpZiAoISh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSkgewogICAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIkNhbm5vdCBwYXNzIG5vbi1zdHJpbmcgdG8gQysrIHN0cmluZyB0eXBlICIgKyBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGxlbmd0aCA9IGxlbmd0aEJ5dGVzVVRGKHZhbHVlKTsKICAgICAgICAgICAgICB2YXIgcHRyID0gX21hbGxvYyg0ICsgbGVuZ3RoICsgY2hhclNpemUpOwogICAgICAgICAgICAgIEhFQVBVMzJbcHRyID4+IDJdID0gbGVuZ3RoID4+IHNoaWZ0OwogICAgICAgICAgICAgIGVuY29kZVN0cmluZyh2YWx1ZSwgcHRyICsgNCwgbGVuZ3RoICsgY2hhclNpemUpOwogICAgICAgICAgICAgIGlmIChkZXN0cnVjdG9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGVzdHJ1Y3RvcnMucHVzaChfZnJlZSwgcHRyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHB0cjsKICAgICAgICAgICAgfSwgImFyZ1BhY2tBZHZhbmNlIjogOCwgInJlYWRWYWx1ZUZyb21Qb2ludGVyIjogc2ltcGxlUmVhZFZhbHVlRnJvbVBvaW50ZXIsIGRlc3RydWN0b3JGdW5jdGlvbjogZnVuY3Rpb24ocHRyKSB7CiAgICAgICAgICAgICAgX2ZyZWUocHRyKTsKICAgICAgICAgICAgfSB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW1iaW5kX3JlZ2lzdGVyX3ZhbHVlX29iamVjdChyYXdUeXBlLCBuYW1lLCBjb25zdHJ1Y3RvclNpZ25hdHVyZSwgcmF3Q29uc3RydWN0b3IsIGRlc3RydWN0b3JTaWduYXR1cmUsIHJhd0Rlc3RydWN0b3IpIHsKICAgICAgICAgICAgc3RydWN0UmVnaXN0cmF0aW9uc1tyYXdUeXBlXSA9IHsgbmFtZTogcmVhZExhdGluMVN0cmluZyhuYW1lKSwgcmF3Q29uc3RydWN0b3I6IGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKGNvbnN0cnVjdG9yU2lnbmF0dXJlLCByYXdDb25zdHJ1Y3RvciksIHJhd0Rlc3RydWN0b3I6IGVtYmluZF9fcmVxdWlyZUZ1bmN0aW9uKGRlc3RydWN0b3JTaWduYXR1cmUsIHJhd0Rlc3RydWN0b3IpLCBmaWVsZHM6IFtdIH07CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtYmluZF9yZWdpc3Rlcl92YWx1ZV9vYmplY3RfZmllbGQoc3RydWN0VHlwZSwgZmllbGROYW1lLCBnZXR0ZXJSZXR1cm5UeXBlLCBnZXR0ZXJTaWduYXR1cmUsIGdldHRlciwgZ2V0dGVyQ29udGV4dCwgc2V0dGVyQXJndW1lbnRUeXBlLCBzZXR0ZXJTaWduYXR1cmUsIHNldHRlciwgc2V0dGVyQ29udGV4dCkgewogICAgICAgICAgICBzdHJ1Y3RSZWdpc3RyYXRpb25zW3N0cnVjdFR5cGVdLmZpZWxkcy5wdXNoKHsgZmllbGROYW1lOiByZWFkTGF0aW4xU3RyaW5nKGZpZWxkTmFtZSksIGdldHRlclJldHVyblR5cGUsIGdldHRlcjogZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oZ2V0dGVyU2lnbmF0dXJlLCBnZXR0ZXIpLCBnZXR0ZXJDb250ZXh0LCBzZXR0ZXJBcmd1bWVudFR5cGUsIHNldHRlcjogZW1iaW5kX19yZXF1aXJlRnVuY3Rpb24oc2V0dGVyU2lnbmF0dXJlLCBzZXR0ZXIpLCBzZXR0ZXJDb250ZXh0IH0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbWJpbmRfcmVnaXN0ZXJfdm9pZChyYXdUeXBlLCBuYW1lKSB7CiAgICAgICAgICAgIG5hbWUgPSByZWFkTGF0aW4xU3RyaW5nKG5hbWUpOwogICAgICAgICAgICByZWdpc3RlclR5cGUocmF3VHlwZSwgeyBpc1ZvaWQ6IHRydWUsIG5hbWUsICJhcmdQYWNrQWR2YW5jZSI6IDAsICJmcm9tV2lyZVR5cGUiOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9LCAidG9XaXJlVHlwZSI6IGZ1bmN0aW9uKGRlc3RydWN0b3JzLCBvKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfSB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlcXVpcmVIYW5kbGUoaGFuZGxlKSB7CiAgICAgICAgICAgIGlmICghaGFuZGxlKSB7CiAgICAgICAgICAgICAgdGhyb3dCaW5kaW5nRXJyb3IoIkNhbm5vdCB1c2UgZGVsZXRlZCB2YWwuIGhhbmRsZSA9ICIgKyBoYW5kbGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlbXZhbF9oYW5kbGVfYXJyYXlbaGFuZGxlXS52YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfYXMoaGFuZGxlLCByZXR1cm5UeXBlLCBkZXN0cnVjdG9yc1JlZikgewogICAgICAgICAgICBoYW5kbGUgPSByZXF1aXJlSGFuZGxlKGhhbmRsZSk7CiAgICAgICAgICAgIHJldHVyblR5cGUgPSByZXF1aXJlUmVnaXN0ZXJlZFR5cGUocmV0dXJuVHlwZSwgImVtdmFsOjphcyIpOwogICAgICAgICAgICB2YXIgZGVzdHJ1Y3RvcnMgPSBbXTsKICAgICAgICAgICAgdmFyIHJkID0gX19lbXZhbF9yZWdpc3RlcihkZXN0cnVjdG9ycyk7CiAgICAgICAgICAgIEhFQVAzMltkZXN0cnVjdG9yc1JlZiA+PiAyXSA9IHJkOwogICAgICAgICAgICByZXR1cm4gcmV0dXJuVHlwZVsidG9XaXJlVHlwZSJdKGRlc3RydWN0b3JzLCBoYW5kbGUpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGVtdmFsX3N5bWJvbHMgPSB7fTsKICAgICAgICAgIGZ1bmN0aW9uIGdldFN0cmluZ09yU3ltYm9sKGFkZHJlc3MpIHsKICAgICAgICAgICAgdmFyIHN5bWJvbCA9IGVtdmFsX3N5bWJvbHNbYWRkcmVzc107CiAgICAgICAgICAgIGlmIChzeW1ib2wgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiByZWFkTGF0aW4xU3RyaW5nKGFkZHJlc3MpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBzeW1ib2w7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbXZhbF9tZXRob2RDYWxsZXJzID0gW107CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX2NhbGxfdm9pZF9tZXRob2QoY2FsbGVyLCBoYW5kbGUsIG1ldGhvZE5hbWUsIGFyZ3MpIHsKICAgICAgICAgICAgY2FsbGVyID0gZW12YWxfbWV0aG9kQ2FsbGVyc1tjYWxsZXJdOwogICAgICAgICAgICBoYW5kbGUgPSByZXF1aXJlSGFuZGxlKGhhbmRsZSk7CiAgICAgICAgICAgIG1ldGhvZE5hbWUgPSBnZXRTdHJpbmdPclN5bWJvbChtZXRob2ROYW1lKTsKICAgICAgICAgICAgY2FsbGVyKGhhbmRsZSwgbWV0aG9kTmFtZSwgbnVsbCwgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBlbXZhbF9nZXRfZ2xvYmFsKCkgewogICAgICAgICAgICBpZiAodHlwZW9mIGdsb2JhbFRoaXMgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdsb2JhbFRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICgvKiBAX19QVVJFX18gKi8gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIEZ1bmN0aW9uOwogICAgICAgICAgICB9KCkpKCJyZXR1cm4gdGhpcyIpKCk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX2dldF9nbG9iYWwobmFtZSkgewogICAgICAgICAgICBpZiAobmFtZSA9PT0gMCkgewogICAgICAgICAgICAgIHJldHVybiBfX2VtdmFsX3JlZ2lzdGVyKGVtdmFsX2dldF9nbG9iYWwoKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmFtZSA9IGdldFN0cmluZ09yU3ltYm9sKG5hbWUpOwogICAgICAgICAgICAgIHJldHVybiBfX2VtdmFsX3JlZ2lzdGVyKGVtdmFsX2dldF9nbG9iYWwoKVtuYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfYWRkTWV0aG9kQ2FsbGVyKGNhbGxlcikgewogICAgICAgICAgICB2YXIgaWQgPSBlbXZhbF9tZXRob2RDYWxsZXJzLmxlbmd0aDsKICAgICAgICAgICAgZW12YWxfbWV0aG9kQ2FsbGVycy5wdXNoKGNhbGxlcik7CiAgICAgICAgICAgIHJldHVybiBpZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfbG9va3VwVHlwZXMoYXJnQ291bnQsIGFyZ1R5cGVzKSB7CiAgICAgICAgICAgIHZhciBhMyA9IG5ldyBBcnJheShhcmdDb3VudCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnQ291bnQ7ICsraSkgewogICAgICAgICAgICAgIGEzW2ldID0gcmVxdWlyZVJlZ2lzdGVyZWRUeXBlKEhFQVAzMlsoYXJnVHlwZXMgPj4gMikgKyBpXSwgInBhcmFtZXRlciAiICsgaSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGEzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX19lbXZhbF9nZXRfbWV0aG9kX2NhbGxlcihhcmdDb3VudCwgYXJnVHlwZXMpIHsKICAgICAgICAgICAgdmFyIHR5cGVzID0gX19lbXZhbF9sb29rdXBUeXBlcyhhcmdDb3VudCwgYXJnVHlwZXMpOwogICAgICAgICAgICB2YXIgcmV0VHlwZSA9IHR5cGVzWzBdOwogICAgICAgICAgICB2YXIgc2lnbmF0dXJlTmFtZSA9IHJldFR5cGUubmFtZSArICJfJCIgKyB0eXBlcy5zbGljZSgxKS5tYXAoZnVuY3Rpb24odCkgewogICAgICAgICAgICAgIHJldHVybiB0Lm5hbWU7CiAgICAgICAgICAgIH0pLmpvaW4oIl8iKSArICIkIjsKICAgICAgICAgICAgdmFyIHBhcmFtcyA9IFsicmV0VHlwZSJdOwogICAgICAgICAgICB2YXIgYXJncyA9IFtyZXRUeXBlXTsKICAgICAgICAgICAgdmFyIGFyZ3NMaXN0ID0gIiI7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnQ291bnQgLSAxOyArK2kpIHsKICAgICAgICAgICAgICBhcmdzTGlzdCArPSAoaSAhPT0gMCA/ICIsICIgOiAiIikgKyAiYXJnIiArIGk7CiAgICAgICAgICAgICAgcGFyYW1zLnB1c2goImFyZ1R5cGUiICsgaSk7CiAgICAgICAgICAgICAgYXJncy5wdXNoKHR5cGVzWzEgKyBpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IG1ha2VMZWdhbEZ1bmN0aW9uTmFtZSgibWV0aG9kQ2FsbGVyXyIgKyBzaWduYXR1cmVOYW1lKTsKICAgICAgICAgICAgdmFyIGZ1bmN0aW9uQm9keSA9ICJyZXR1cm4gZnVuY3Rpb24gIiArIGZ1bmN0aW9uTmFtZSArICIoaGFuZGxlLCBuYW1lLCBkZXN0cnVjdG9ycywgYXJncykge1xuIjsKICAgICAgICAgICAgdmFyIG9mZnNldCA9IDA7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnQ291bnQgLSAxOyArK2kpIHsKICAgICAgICAgICAgICBmdW5jdGlvbkJvZHkgKz0gIiAgICB2YXIgYXJnIiArIGkgKyAiID0gYXJnVHlwZSIgKyBpICsgIi5yZWFkVmFsdWVGcm9tUG9pbnRlcihhcmdzIiArIChvZmZzZXQgPyAiKyIgKyBvZmZzZXQgOiAiIikgKyAiKTtcbiI7CiAgICAgICAgICAgICAgb2Zmc2V0ICs9IHR5cGVzW2kgKyAxXVsiYXJnUGFja0FkdmFuY2UiXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbkJvZHkgKz0gIiAgICB2YXIgcnYgPSBoYW5kbGVbbmFtZV0oIiArIGFyZ3NMaXN0ICsgIik7XG4iOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ0NvdW50IC0gMTsgKytpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVzW2kgKyAxXVsiZGVsZXRlT2JqZWN0Il0pIHsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uQm9keSArPSAiICAgIGFyZ1R5cGUiICsgaSArICIuZGVsZXRlT2JqZWN0KGFyZyIgKyBpICsgIik7XG4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXJldFR5cGUuaXNWb2lkKSB7CiAgICAgICAgICAgICAgZnVuY3Rpb25Cb2R5ICs9ICIgICAgcmV0dXJuIHJldFR5cGUudG9XaXJlVHlwZShkZXN0cnVjdG9ycywgcnYpO1xuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbkJvZHkgKz0gIn07XG4iOwogICAgICAgICAgICBwYXJhbXMucHVzaChmdW5jdGlvbkJvZHkpOwogICAgICAgICAgICB2YXIgaW52b2tlckZ1bmN0aW9uID0gbmV3XyhGdW5jdGlvbiwgcGFyYW1zKS5hcHBseShudWxsLCBhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIF9fZW12YWxfYWRkTWV0aG9kQ2FsbGVyKGludm9rZXJGdW5jdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX2dldF9tb2R1bGVfcHJvcGVydHkobmFtZSkgewogICAgICAgICAgICBuYW1lID0gZ2V0U3RyaW5nT3JTeW1ib2wobmFtZSk7CiAgICAgICAgICAgIHJldHVybiBfX2VtdmFsX3JlZ2lzdGVyKE1vZHVsZVtuYW1lXSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX2dldF9wcm9wZXJ0eShoYW5kbGUsIGtleTIpIHsKICAgICAgICAgICAgaGFuZGxlID0gcmVxdWlyZUhhbmRsZShoYW5kbGUpOwogICAgICAgICAgICBrZXkyID0gcmVxdWlyZUhhbmRsZShrZXkyKTsKICAgICAgICAgICAgcmV0dXJuIF9fZW12YWxfcmVnaXN0ZXIoaGFuZGxlW2tleTJdKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9fZW12YWxfaW5jcmVmKGhhbmRsZSkgewogICAgICAgICAgICBpZiAoaGFuZGxlID4gNCkgewogICAgICAgICAgICAgIGVtdmFsX2hhbmRsZV9hcnJheVtoYW5kbGVdLnJlZmNvdW50ICs9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyYWZ0RW12YWxBbGxvY2F0b3IoYXJnQ291bnQpIHsKICAgICAgICAgICAgdmFyIGFyZ3NMaXN0ID0gIiI7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnQ291bnQ7ICsraSkgewogICAgICAgICAgICAgIGFyZ3NMaXN0ICs9IChpICE9PSAwID8gIiwgIiA6ICIiKSArICJhcmciICsgaTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZnVuY3Rpb25Cb2R5ID0gInJldHVybiBmdW5jdGlvbiBlbXZhbF9hbGxvY2F0b3JfIiArIGFyZ0NvdW50ICsgIihjb25zdHJ1Y3RvciwgYXJnVHlwZXMsIGFyZ3MpIHtcbiI7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnQ291bnQ7ICsraSkgewogICAgICAgICAgICAgIGZ1bmN0aW9uQm9keSArPSAidmFyIGFyZ1R5cGUiICsgaSArICIgPSByZXF1aXJlUmVnaXN0ZXJlZFR5cGUoTW9kdWxlWydIRUFQMzInXVsoYXJnVHlwZXMgPj4+IDIpICsgIiArIGkgKyAnXSwgInBhcmFtZXRlciAnICsgaSArICciKTtcbnZhciBhcmcnICsgaSArICIgPSBhcmdUeXBlIiArIGkgKyAiLnJlYWRWYWx1ZUZyb21Qb2ludGVyKGFyZ3MpO1xuYXJncyArPSBhcmdUeXBlIiArIGkgKyAiWydhcmdQYWNrQWR2YW5jZSddO1xuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbkJvZHkgKz0gInZhciBvYmogPSBuZXcgY29uc3RydWN0b3IoIiArIGFyZ3NMaXN0ICsgIik7XG5yZXR1cm4gX19lbXZhbF9yZWdpc3RlcihvYmopO1xufVxuIjsKICAgICAgICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbigicmVxdWlyZVJlZ2lzdGVyZWRUeXBlIiwgIk1vZHVsZSIsICJfX2VtdmFsX3JlZ2lzdGVyIiwgZnVuY3Rpb25Cb2R5KShyZXF1aXJlUmVnaXN0ZXJlZFR5cGUsIE1vZHVsZSwgX19lbXZhbF9yZWdpc3Rlcik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZW12YWxfbmV3ZXJzID0ge307CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX25ldyhoYW5kbGUsIGFyZ0NvdW50LCBhcmdUeXBlcywgYXJncykgewogICAgICAgICAgICBoYW5kbGUgPSByZXF1aXJlSGFuZGxlKGhhbmRsZSk7CiAgICAgICAgICAgIHZhciBuZXdlciA9IGVtdmFsX25ld2Vyc1thcmdDb3VudF07CiAgICAgICAgICAgIGlmICghbmV3ZXIpIHsKICAgICAgICAgICAgICBuZXdlciA9IGNyYWZ0RW12YWxBbGxvY2F0b3IoYXJnQ291bnQpOwogICAgICAgICAgICAgIGVtdmFsX25ld2Vyc1thcmdDb3VudF0gPSBuZXdlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3ZXIoaGFuZGxlLCBhcmdUeXBlcywgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX25ld19jc3RyaW5nKHYzKSB7CiAgICAgICAgICAgIHJldHVybiBfX2VtdmFsX3JlZ2lzdGVyKGdldFN0cmluZ09yU3ltYm9sKHYzKSk7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBfX2VtdmFsX3J1bl9kZXN0cnVjdG9ycyhoYW5kbGUpIHsKICAgICAgICAgICAgdmFyIGRlc3RydWN0b3JzID0gZW12YWxfaGFuZGxlX2FycmF5W2hhbmRsZV0udmFsdWU7CiAgICAgICAgICAgIHJ1bkRlc3RydWN0b3JzKGRlc3RydWN0b3JzKTsKICAgICAgICAgICAgX19lbXZhbF9kZWNyZWYoaGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9hYm9ydCgpIHsKICAgICAgICAgICAgYWJvcnQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9lbXNjcmlwdGVuX21lbWNweV9iaWcoZGVzdCwgc3JjLCBudW0pIHsKICAgICAgICAgICAgSEVBUFU4LmNvcHlXaXRoaW4oZGVzdCwgc3JjLCBzcmMgKyBudW0pOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZW1zY3JpcHRlbl9yZWFsbG9jX2J1ZmZlcihzaXplKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgd2FzbU1lbW9yeS5ncm93KHNpemUgLSBidWZmZXIuYnl0ZUxlbmd0aCArIDY1NTM1ID4+PiAxNik7CiAgICAgICAgICAgICAgdXBkYXRlR2xvYmFsQnVmZmVyQW5kVmlld3Mod2FzbU1lbW9yeS5idWZmZXIpOwogICAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIF9lbXNjcmlwdGVuX3Jlc2l6ZV9oZWFwKHJlcXVlc3RlZFNpemUpIHsKICAgICAgICAgICAgdmFyIG9sZFNpemUgPSBIRUFQVTgubGVuZ3RoOwogICAgICAgICAgICByZXF1ZXN0ZWRTaXplID0gcmVxdWVzdGVkU2l6ZSA+Pj4gMDsKICAgICAgICAgICAgdmFyIG1heEhlYXBTaXplID0gMjE0NzQ4MzY0ODsKICAgICAgICAgICAgaWYgKHJlcXVlc3RlZFNpemUgPiBtYXhIZWFwU2l6ZSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBjdXREb3duID0gMTsgY3V0RG93biA8PSA0OyBjdXREb3duICo9IDIpIHsKICAgICAgICAgICAgICB2YXIgb3Zlckdyb3duSGVhcFNpemUgPSBvbGRTaXplICogKDEgKyAwLjIgLyBjdXREb3duKTsKICAgICAgICAgICAgICBvdmVyR3Jvd25IZWFwU2l6ZSA9IE1hdGgubWluKG92ZXJHcm93bkhlYXBTaXplLCByZXF1ZXN0ZWRTaXplICsgMTAwNjYzMjk2KTsKICAgICAgICAgICAgICB2YXIgbmV3U2l6ZSA9IE1hdGgubWluKG1heEhlYXBTaXplLCBhbGlnblVwKE1hdGgubWF4KHJlcXVlc3RlZFNpemUsIG92ZXJHcm93bkhlYXBTaXplKSwgNjU1MzYpKTsKICAgICAgICAgICAgICB2YXIgcmVwbGFjZW1lbnQgPSBlbXNjcmlwdGVuX3JlYWxsb2NfYnVmZmVyKG5ld1NpemUpOwogICAgICAgICAgICAgIGlmIChyZXBsYWNlbWVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBTWVNDQUxMUyA9IHsgbWFwcGluZ3M6IHt9LCBidWZmZXJzOiBbbnVsbCwgW10sIFtdXSwgcHJpbnRDaGFyOiBmdW5jdGlvbihzdHJlYW0sIGN1cnIpIHsKICAgICAgICAgICAgdmFyIGJ1ZmZlcjIgPSBTWVNDQUxMUy5idWZmZXJzW3N0cmVhbV07CiAgICAgICAgICAgIGlmIChjdXJyID09PSAwIHx8IGN1cnIgPT09IDEwKSB7CiAgICAgICAgICAgICAgKHN0cmVhbSA9PT0gMSA/IG91dCA6IGVycikoVVRGOEFycmF5VG9TdHJpbmcoYnVmZmVyMiwgMCkpOwogICAgICAgICAgICAgIGJ1ZmZlcjIubGVuZ3RoID0gMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBidWZmZXIyLnB1c2goY3Vycik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIHZhcmFyZ3M6IHZvaWQgMCwgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgU1lTQ0FMTFMudmFyYXJncyArPSA0OwogICAgICAgICAgICB2YXIgcmV0ID0gSEVBUDMyW1NZU0NBTExTLnZhcmFyZ3MgLSA0ID4+IDJdOwogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgfSwgZ2V0U3RyOiBmdW5jdGlvbihwdHIpIHsKICAgICAgICAgICAgdmFyIHJldCA9IFVURjhUb1N0cmluZyhwdHIpOwogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgfSwgZ2V0NjQ6IGZ1bmN0aW9uKGxvdywgaGlnaCkgewogICAgICAgICAgICByZXR1cm4gbG93OwogICAgICAgICAgfSB9OwogICAgICAgICAgZnVuY3Rpb24gX2ZkX2Nsb3NlKGZkKSB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX2ZkX3NlZWsoZmQsIG9mZnNldF9sb3csIG9mZnNldF9oaWdoLCB3aGVuY2UsIG5ld09mZnNldCkgewogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX2ZkX3dyaXRlKGZkLCBpb3YsIGlvdmNudCwgcG51bSkgewogICAgICAgICAgICB2YXIgbnVtID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpb3ZjbnQ7IGkrKykgewogICAgICAgICAgICAgIHZhciBwdHIgPSBIRUFQMzJbaW92ICsgaSAqIDggPj4gMl07CiAgICAgICAgICAgICAgdmFyIGxlbiA9IEhFQVAzMltpb3YgKyAoaSAqIDggKyA0KSA+PiAyXTsKICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGxlbjsgaisrKSB7CiAgICAgICAgICAgICAgICBTWVNDQUxMUy5wcmludENoYXIoZmQsIEhFQVBVOFtwdHIgKyBqXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG51bSArPSBsZW47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgSEVBUDMyW3BudW0gPj4gMl0gPSBudW07CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gX3NldFRlbXBSZXQwKCRpKSB7CiAgICAgICAgICAgIHNldFRlbXBSZXQwKCRpIHwgMCk7CiAgICAgICAgICB9CiAgICAgICAgICBJbnRlcm5hbEVycm9yID0gTW9kdWxlWyJJbnRlcm5hbEVycm9yIl0gPSBleHRlbmRFcnJvcihFcnJvciwgIkludGVybmFsRXJyb3IiKTsKICAgICAgICAgIGVtYmluZF9pbml0X2NoYXJDb2RlcygpOwogICAgICAgICAgQmluZGluZ0Vycm9yID0gTW9kdWxlWyJCaW5kaW5nRXJyb3IiXSA9IGV4dGVuZEVycm9yKEVycm9yLCAiQmluZGluZ0Vycm9yIik7CiAgICAgICAgICBpbml0X0NsYXNzSGFuZGxlKCk7CiAgICAgICAgICBpbml0X1JlZ2lzdGVyZWRQb2ludGVyKCk7CiAgICAgICAgICBpbml0X2VtYmluZCgpOwogICAgICAgICAgVW5ib3VuZFR5cGVFcnJvciA9IE1vZHVsZVsiVW5ib3VuZFR5cGVFcnJvciJdID0gZXh0ZW5kRXJyb3IoRXJyb3IsICJVbmJvdW5kVHlwZUVycm9yIik7CiAgICAgICAgICBpbml0X2VtdmFsKCk7CiAgICAgICAgICB2YXIgYXNtTGlicmFyeUFyZyA9IHsgInQiOiBfX2VtYmluZF9maW5hbGl6ZV92YWx1ZV9vYmplY3QsICJJIjogX19lbWJpbmRfcmVnaXN0ZXJfYm9vbCwgIngiOiBfX2VtYmluZF9yZWdpc3Rlcl9jbGFzcywgInciOiBfX2VtYmluZF9yZWdpc3Rlcl9jbGFzc19jb25zdHJ1Y3RvciwgImQiOiBfX2VtYmluZF9yZWdpc3Rlcl9jbGFzc19mdW5jdGlvbiwgImsiOiBfX2VtYmluZF9yZWdpc3Rlcl9jb25zdGFudCwgIkgiOiBfX2VtYmluZF9yZWdpc3Rlcl9lbXZhbCwgIm4iOiBfX2VtYmluZF9yZWdpc3Rlcl9lbnVtLCAiYSI6IF9fZW1iaW5kX3JlZ2lzdGVyX2VudW1fdmFsdWUsICJBIjogX19lbWJpbmRfcmVnaXN0ZXJfZmxvYXQsICJpIjogX19lbWJpbmRfcmVnaXN0ZXJfZnVuY3Rpb24sICJqIjogX19lbWJpbmRfcmVnaXN0ZXJfaW50ZWdlciwgImgiOiBfX2VtYmluZF9yZWdpc3Rlcl9tZW1vcnlfdmlldywgIkIiOiBfX2VtYmluZF9yZWdpc3Rlcl9zdGRfc3RyaW5nLCAidiI6IF9fZW1iaW5kX3JlZ2lzdGVyX3N0ZF93c3RyaW5nLCAidSI6IF9fZW1iaW5kX3JlZ2lzdGVyX3ZhbHVlX29iamVjdCwgImMiOiBfX2VtYmluZF9yZWdpc3Rlcl92YWx1ZV9vYmplY3RfZmllbGQsICJKIjogX19lbWJpbmRfcmVnaXN0ZXJfdm9pZCwgIm0iOiBfX2VtdmFsX2FzLCAicyI6IF9fZW12YWxfY2FsbF92b2lkX21ldGhvZCwgImIiOiBfX2VtdmFsX2RlY3JlZiwgInkiOiBfX2VtdmFsX2dldF9nbG9iYWwsICJwIjogX19lbXZhbF9nZXRfbWV0aG9kX2NhbGxlciwgInIiOiBfX2VtdmFsX2dldF9tb2R1bGVfcHJvcGVydHksICJlIjogX19lbXZhbF9nZXRfcHJvcGVydHksICJnIjogX19lbXZhbF9pbmNyZWYsICJxIjogX19lbXZhbF9uZXcsICJmIjogX19lbXZhbF9uZXdfY3N0cmluZywgImwiOiBfX2VtdmFsX3J1bl9kZXN0cnVjdG9ycywgIm8iOiBfYWJvcnQsICJFIjogX2Vtc2NyaXB0ZW5fbWVtY3B5X2JpZywgIkYiOiBfZW1zY3JpcHRlbl9yZXNpemVfaGVhcCwgIkciOiBfZmRfY2xvc2UsICJDIjogX2ZkX3NlZWssICJ6IjogX2ZkX3dyaXRlLCAiRCI6IF9zZXRUZW1wUmV0MCB9OwogICAgICAgICAgdmFyIGFzbSA9IGNyZWF0ZVdhc20oKTsKICAgICAgICAgIHZhciBfX193YXNtX2NhbGxfY3RvcnMgPSBNb2R1bGVbIl9fX3dhc21fY2FsbF9jdG9ycyJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoX19fd2FzbV9jYWxsX2N0b3JzID0gTW9kdWxlWyJfX193YXNtX2NhbGxfY3RvcnMiXSA9IE1vZHVsZVsiYXNtIl1bIkwiXSkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgX21hbGxvYyA9IE1vZHVsZVsiX21hbGxvYyJdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAoX21hbGxvYyA9IE1vZHVsZVsiX21hbGxvYyJdID0gTW9kdWxlWyJhc20iXVsiTSJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfZnJlZSA9IE1vZHVsZVsiX2ZyZWUiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKF9mcmVlID0gTW9kdWxlWyJfZnJlZSJdID0gTW9kdWxlWyJhc20iXVsiTiJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfX19nZXRUeXBlTmFtZSA9IE1vZHVsZVsiX19fZ2V0VHlwZU5hbWUiXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKF9fX2dldFR5cGVOYW1lID0gTW9kdWxlWyJfX19nZXRUeXBlTmFtZSJdID0gTW9kdWxlWyJhc20iXVsiUCJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBfX19lbWJpbmRfcmVnaXN0ZXJfbmF0aXZlX2FuZF9idWlsdGluX3R5cGVzID0gTW9kdWxlWyJfX19lbWJpbmRfcmVnaXN0ZXJfbmF0aXZlX2FuZF9idWlsdGluX3R5cGVzIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChfX19lbWJpbmRfcmVnaXN0ZXJfbmF0aXZlX2FuZF9idWlsdGluX3R5cGVzID0gTW9kdWxlWyJfX19lbWJpbmRfcmVnaXN0ZXJfbmF0aXZlX2FuZF9idWlsdGluX3R5cGVzIl0gPSBNb2R1bGVbImFzbSJdWyJRIl0pLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGR5bkNhbGxfamlqaSA9IE1vZHVsZVsiZHluQ2FsbF9qaWppIl0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIChkeW5DYWxsX2ppamkgPSBNb2R1bGVbImR5bkNhbGxfamlqaSJdID0gTW9kdWxlWyJhc20iXVsiUiJdKS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjYWxsZWRSdW47CiAgICAgICAgICBmdW5jdGlvbiBFeGl0U3RhdHVzKHN0YXR1cykgewogICAgICAgICAgICB0aGlzLm5hbWUgPSAiRXhpdFN0YXR1cyI7CiAgICAgICAgICAgIHRoaXMubWVzc2FnZSA9ICJQcm9ncmFtIHRlcm1pbmF0ZWQgd2l0aCBleGl0KCIgKyBzdGF0dXMgKyAiKSI7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gc3RhdHVzOwogICAgICAgICAgfQogICAgICAgICAgZGVwZW5kZW5jaWVzRnVsZmlsbGVkID0gZnVuY3Rpb24gcnVuQ2FsbGVyKCkgewogICAgICAgICAgICBpZiAoIWNhbGxlZFJ1bikgcnVuKCk7CiAgICAgICAgICAgIGlmICghY2FsbGVkUnVuKSBkZXBlbmRlbmNpZXNGdWxmaWxsZWQgPSBydW5DYWxsZXI7CiAgICAgICAgICB9OwogICAgICAgICAgZnVuY3Rpb24gcnVuKGFyZ3MpIHsKICAgICAgICAgICAgYXJncyA9IGFyZ3MgfHwgYXJndW1lbnRzXzsKICAgICAgICAgICAgaWYgKHJ1bkRlcGVuZGVuY2llcyA+IDApIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJlUnVuKCk7CiAgICAgICAgICAgIGlmIChydW5EZXBlbmRlbmNpZXMgPiAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZ1bmN0aW9uIGRvUnVuKCkgewogICAgICAgICAgICAgIGlmIChjYWxsZWRSdW4pIHJldHVybjsKICAgICAgICAgICAgICBjYWxsZWRSdW4gPSB0cnVlOwogICAgICAgICAgICAgIE1vZHVsZVsiY2FsbGVkUnVuIl0gPSB0cnVlOwogICAgICAgICAgICAgIGlmIChBQk9SVCkgcmV0dXJuOwogICAgICAgICAgICAgIGluaXRSdW50aW1lKCk7CiAgICAgICAgICAgICAgcHJlTWFpbigpOwogICAgICAgICAgICAgIHJlYWR5UHJvbWlzZVJlc29sdmUoTW9kdWxlKTsKICAgICAgICAgICAgICBpZiAoTW9kdWxlWyJvblJ1bnRpbWVJbml0aWFsaXplZCJdKSBNb2R1bGVbIm9uUnVudGltZUluaXRpYWxpemVkIl0oKTsKICAgICAgICAgICAgICBwb3N0UnVuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKE1vZHVsZVsic2V0U3RhdHVzIl0pIHsKICAgICAgICAgICAgICBNb2R1bGVbInNldFN0YXR1cyJdKCJSdW5uaW5nLi4uIik7CiAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIE1vZHVsZVsic2V0U3RhdHVzIl0oIiIpOwogICAgICAgICAgICAgICAgfSwgMSk7CiAgICAgICAgICAgICAgICBkb1J1bigpOwogICAgICAgICAgICAgIH0sIDEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRvUnVuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIE1vZHVsZVsicnVuIl0gPSBydW47CiAgICAgICAgICBpZiAoTW9kdWxlWyJwcmVJbml0Il0pIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBNb2R1bGVbInByZUluaXQiXSA9PSAiZnVuY3Rpb24iKSBNb2R1bGVbInByZUluaXQiXSA9IFtNb2R1bGVbInByZUluaXQiXV07CiAgICAgICAgICAgIHdoaWxlIChNb2R1bGVbInByZUluaXQiXS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgTW9kdWxlWyJwcmVJbml0Il0ucG9wKCkoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcnVuKCk7CiAgICAgICAgICByZXR1cm4gQkFTSVMyLnJlYWR5OwogICAgICAgIH07CiAgICAgIH0oKTsKICAgICAgaWYgKHR5cGVvZiBleHBvcnRzMiA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG1vZHVsZSA9PT0gIm9iamVjdCIpCiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBCQVNJUzsKICAgICAgZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmVbImFtZCJdKQogICAgICAgIGRlZmluZShbXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gQkFTSVM7CiAgICAgICAgfSk7CiAgICAgIGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzMiA9PT0gIm9iamVjdCIpCiAgICAgICAgZXhwb3J0czJbIkJBU0lTIl0gPSBCQVNJUzsKICAgIH0KICB9KTsKCiAgLy8gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL3RyYW5zY29kZUtUWDIuanMKICB2YXIgdHJhbnNjb2RlS1RYMl9leHBvcnRzID0ge307CiAgX19leHBvcnQodHJhbnNjb2RlS1RYMl9leHBvcnRzLCB7CiAgICBkZWZhdWx0OiAoKSA9PiB0cmFuc2NvZGVLVFgyX2RlZmF1bHQKICB9KTsKICBmdW5jdGlvbiB0cmFuc2NvZGUocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgQ2hlY2tfZGVmYXVsdC50eXBlT2Yub2JqZWN0KCJ0cmFuc2NvZGVyTW9kdWxlIiwgdHJhbnNjb2Rlck1vZHVsZSk7CiAgICBjb25zdCBkYXRhID0gcGFyYW1ldGVycy5rdHgyQnVmZmVyOwogICAgY29uc3Qgc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cyA9IHBhcmFtZXRlcnMuc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0czsKICAgIGxldCBoZWFkZXI7CiAgICB0cnkgewogICAgICBoZWFkZXIgPSByZWFkMihkYXRhKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJJbnZhbGlkIEtUWDIgZmlsZS4iKTsKICAgIH0KICAgIGlmIChoZWFkZXIubGF5ZXJDb3VudCAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoIktUWDIgdGV4dHVyZSBhcnJheXMgYXJlIG5vdCBzdXBwb3J0ZWQuIik7CiAgICB9CiAgICBpZiAoaGVhZGVyLnBpeGVsRGVwdGggIT09IDApIHsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJLVFgyIDNEIHRleHR1cmVzIGFyZSB1bnN1cHBvcnRlZC4iKTsKICAgIH0KICAgIGNvbnN0IGRmZCA9IGhlYWRlci5kYXRhRm9ybWF0RGVzY3JpcHRvclswXTsKICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheShoZWFkZXIubGV2ZWxDb3VudCk7CiAgICBpZiAoaGVhZGVyLnZrRm9ybWF0ID09PSAwICYmIChkZmQuY29sb3JNb2RlbCA9PT0gY29sb3JNb2RlbEVUQzFTIHx8IGRmZC5jb2xvck1vZGVsID09PSBjb2xvck1vZGVsVUFTVEMpKSB7CiAgICAgIHRyYW5zY29kZUNvbXByZXNzZWQoCiAgICAgICAgZGF0YSwKICAgICAgICBoZWFkZXIsCiAgICAgICAgc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cywKICAgICAgICB0cmFuc2NvZGVyTW9kdWxlLAogICAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMsCiAgICAgICAgcmVzdWx0CiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goZGF0YS5idWZmZXIpOwogICAgICBwYXJzZVVuY29tcHJlc3NlZChoZWFkZXIsIHJlc3VsdCk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBwYXJzZVVuY29tcHJlc3NlZChoZWFkZXIsIHJlc3VsdCkgewogICAgY29uc3QgaW50ZXJuYWxGb3JtYXQgPSBoZWFkZXIudmtGb3JtYXQgPT09IFZ1bGthbkNvbnN0YW50c19kZWZhdWx0LlZLX0ZPUk1BVF9SOEc4QjhfU1JHQiA/IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCIDogUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBOwogICAgbGV0IGRhdGF0eXBlOwogICAgaWYgKGhlYWRlci52a0Zvcm1hdCA9PT0gVnVsa2FuQ29uc3RhbnRzX2RlZmF1bHQuVktfRk9STUFUX1I4RzhCOEE4X1VOT1JNKSB7CiAgICAgIGRhdGF0eXBlID0gUGl4ZWxEYXRhdHlwZV9kZWZhdWx0LlVOU0lHTkVEX0JZVEU7CiAgICB9IGVsc2UgaWYgKGhlYWRlci52a0Zvcm1hdCA9PT0gVnVsa2FuQ29uc3RhbnRzX2RlZmF1bHQuVktfRk9STUFUX1IxNkcxNkIxNkExNl9TRkxPQVQpIHsKICAgICAgZGF0YXR5cGUgPSBQaXhlbERhdGF0eXBlX2RlZmF1bHQuSEFMRl9GTE9BVDsKICAgIH0gZWxzZSBpZiAoaGVhZGVyLnZrRm9ybWF0ID09PSBWdWxrYW5Db25zdGFudHNfZGVmYXVsdC5WS19GT1JNQVRfUjMyRzMyQjMyQTMyX1NGTE9BVCkgewogICAgICBkYXRhdHlwZSA9IFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5GTE9BVDsKICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGVhZGVyLmxldmVscy5sZW5ndGg7ICsraSkgewogICAgICBjb25zdCBsZXZlbCA9IHt9OwogICAgICByZXN1bHRbaV0gPSBsZXZlbDsKICAgICAgY29uc3QgbGV2ZWxCdWZmZXIgPSBoZWFkZXIubGV2ZWxzW2ldLmxldmVsRGF0YTsKICAgICAgY29uc3Qgd2lkdGggPSBoZWFkZXIucGl4ZWxXaWR0aCA+PiBpOwogICAgICBjb25zdCBoZWlnaHQgPSBoZWFkZXIucGl4ZWxIZWlnaHQgPj4gaTsKICAgICAgY29uc3QgZmFjZUxlbmd0aCA9IHdpZHRoICogaGVpZ2h0ICogUGl4ZWxGb3JtYXRfZGVmYXVsdC5jb21wb25lbnRzTGVuZ3RoKGludGVybmFsRm9ybWF0KTsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBoZWFkZXIuZmFjZUNvdW50OyArK2opIHsKICAgICAgICBjb25zdCBmYWNlQnl0ZU9mZnNldCA9IGxldmVsQnVmZmVyLmJ5dGVPZmZzZXQgKyBmYWNlTGVuZ3RoICogaGVhZGVyLnR5cGVTaXplICogajsKICAgICAgICBsZXQgZmFjZVZpZXc7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoZGF0YXR5cGUpIHx8IFBpeGVsRGF0YXR5cGVfZGVmYXVsdC5zaXplSW5CeXRlcyhkYXRhdHlwZSkgPT09IDEpIHsKICAgICAgICAgIGZhY2VWaWV3ID0gbmV3IFVpbnQ4QXJyYXkoCiAgICAgICAgICAgIGxldmVsQnVmZmVyLmJ1ZmZlciwKICAgICAgICAgICAgZmFjZUJ5dGVPZmZzZXQsCiAgICAgICAgICAgIGZhY2VMZW5ndGgKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChQaXhlbERhdGF0eXBlX2RlZmF1bHQuc2l6ZUluQnl0ZXMoZGF0YXR5cGUpID09PSAyKSB7CiAgICAgICAgICBmYWNlVmlldyA9IG5ldyBVaW50MTZBcnJheSgKICAgICAgICAgICAgbGV2ZWxCdWZmZXIuYnVmZmVyLAogICAgICAgICAgICBmYWNlQnl0ZU9mZnNldCwKICAgICAgICAgICAgZmFjZUxlbmd0aAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZmFjZVZpZXcgPSBuZXcgRmxvYXQzMkFycmF5KAogICAgICAgICAgICBsZXZlbEJ1ZmZlci5idWZmZXIsCiAgICAgICAgICAgIGZhY2VCeXRlT2Zmc2V0LAogICAgICAgICAgICBmYWNlTGVuZ3RoCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBsZXZlbFtmYWNlT3JkZXJbal1dID0gewogICAgICAgICAgaW50ZXJuYWxGb3JtYXQsCiAgICAgICAgICBkYXRhdHlwZSwKICAgICAgICAgIHdpZHRoLAogICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgbGV2ZWxCdWZmZXI6IGZhY2VWaWV3CiAgICAgICAgfTsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiB0cmFuc2NvZGVDb21wcmVzc2VkKGRhdGEsIGhlYWRlciwgc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cywgdHJhbnNjb2Rlck1vZHVsZTIsIHRyYW5zZmVyYWJsZU9iamVjdHMsIHJlc3VsdCkgewogICAgY29uc3Qga3R4MkZpbGUgPSBuZXcgdHJhbnNjb2Rlck1vZHVsZTIuS1RYMkZpbGUoZGF0YSk7CiAgICBsZXQgd2lkdGggPSBrdHgyRmlsZS5nZXRXaWR0aCgpOwogICAgbGV0IGhlaWdodCA9IGt0eDJGaWxlLmdldEhlaWdodCgpOwogICAgY29uc3QgbGV2ZWxzID0ga3R4MkZpbGUuZ2V0TGV2ZWxzKCk7CiAgICBjb25zdCBoYXNBbHBoYSA9IGt0eDJGaWxlLmdldEhhc0FscGhhKCk7CiAgICBpZiAoISh3aWR0aCA+IDApIHx8ICEoaGVpZ2h0ID4gMCkgfHwgIShsZXZlbHMgPiAwKSkgewogICAgICBrdHgyRmlsZS5jbG9zZSgpOwogICAgICBrdHgyRmlsZS5kZWxldGUoKTsKICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJJbnZhbGlkIEtUWDIgZmlsZSIpOwogICAgfQogICAgbGV0IGludGVybmFsRm9ybWF0LCB0cmFuc2NvZGVyRm9ybWF0OwogICAgY29uc3QgZGZkID0gaGVhZGVyLmRhdGFGb3JtYXREZXNjcmlwdG9yWzBdOwogICAgY29uc3QgQmFzaXNGb3JtYXQgPSB0cmFuc2NvZGVyTW9kdWxlMi50cmFuc2NvZGVyX3RleHR1cmVfZm9ybWF0OwogICAgaWYgKGRmZC5jb2xvck1vZGVsID09PSBjb2xvck1vZGVsRVRDMVMpIHsKICAgICAgaWYgKHN1cHBvcnRlZFRhcmdldEZvcm1hdHMuZXRjKSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBoYXNBbHBoYSA/IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCQThfRVRDMl9FQUMgOiBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQjhfRVRDMjsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gaGFzQWxwaGEgPyBCYXNpc0Zvcm1hdC5jVEZFVEMyX1JHQkEgOiBCYXNpc0Zvcm1hdC5jVEZFVEMxX1JHQjsKICAgICAgfSBlbHNlIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLmV0YzEgJiYgIWhhc0FscGhhKSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQl9FVEMxOwogICAgICAgIHRyYW5zY29kZXJGb3JtYXQgPSBCYXNpc0Zvcm1hdC5jVEZFVEMxX1JHQjsKICAgICAgfSBlbHNlIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLnMzdGMpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IGhhc0FscGhhID8gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBX0RYVDUgOiBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQl9EWFQxOwogICAgICAgIHRyYW5zY29kZXJGb3JtYXQgPSBoYXNBbHBoYSA/IEJhc2lzRm9ybWF0LmNURkJDM19SR0JBIDogQmFzaXNGb3JtYXQuY1RGQkMxX1JHQjsKICAgICAgfSBlbHNlIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLnB2cnRjKSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBoYXNBbHBoYSA/IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCQV9QVlJUQ180QlBQVjEgOiBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQl9QVlJUQ180QlBQVjE7CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdCA9IGhhc0FscGhhID8gQmFzaXNGb3JtYXQuY1RGUFZSVEMxXzRfUkdCQSA6IEJhc2lzRm9ybWF0LmNURlBWUlRDMV80X1JHQjsKICAgICAgfSBlbHNlIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLmFzdGMpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCQV9BU1RDOwogICAgICAgIHRyYW5zY29kZXJGb3JtYXQgPSBCYXNpc0Zvcm1hdC5jVEZBU1RDXzR4NF9SR0JBOwogICAgICB9IGVsc2UgaWYgKHN1cHBvcnRlZFRhcmdldEZvcm1hdHMuYmM3KSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkFfQkM3OwogICAgICAgIHRyYW5zY29kZXJGb3JtYXQgPSBCYXNpc0Zvcm1hdC5jVEZCQzdfUkdCQTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoCiAgICAgICAgICAiTm8gdHJhbnNjb2RpbmcgZm9ybWF0IHRhcmdldCBhdmFpbGFibGUgZm9yIEVUQzFTIGNvbXByZXNzZWQga3R4Mi4iCiAgICAgICAgKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChkZmQuY29sb3JNb2RlbCA9PT0gY29sb3JNb2RlbFVBU1RDKSB7CiAgICAgIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLmFzdGMpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IFBpeGVsRm9ybWF0X2RlZmF1bHQuUkdCQV9BU1RDOwogICAgICAgIHRyYW5zY29kZXJGb3JtYXQgPSBCYXNpc0Zvcm1hdC5jVEZBU1RDXzR4NF9SR0JBOwogICAgICB9IGVsc2UgaWYgKHN1cHBvcnRlZFRhcmdldEZvcm1hdHMuYmM3KSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQgPSBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkFfQkM3OwogICAgICAgIHRyYW5zY29kZXJGb3JtYXQgPSBCYXNpc0Zvcm1hdC5jVEZCQzdfUkdCQTsKICAgICAgfSBlbHNlIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLnMzdGMpIHsKICAgICAgICBpbnRlcm5hbEZvcm1hdCA9IGhhc0FscGhhID8gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JBX0RYVDUgOiBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQl9EWFQxOwogICAgICAgIHRyYW5zY29kZXJGb3JtYXQgPSBoYXNBbHBoYSA/IEJhc2lzRm9ybWF0LmNURkJDM19SR0JBIDogQmFzaXNGb3JtYXQuY1RGQkMxX1JHQjsKICAgICAgfSBlbHNlIGlmIChzdXBwb3J0ZWRUYXJnZXRGb3JtYXRzLmV0YykgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gaGFzQWxwaGEgPyBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkE4X0VUQzJfRUFDIDogUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0I4X0VUQzI7CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdCA9IGhhc0FscGhhID8gQmFzaXNGb3JtYXQuY1RGRVRDMl9SR0JBIDogQmFzaXNGb3JtYXQuY1RGRVRDMV9SR0I7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5ldGMxICYmICFoYXNBbHBoYSkgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JfRVRDMTsKICAgICAgICB0cmFuc2NvZGVyRm9ybWF0ID0gQmFzaXNGb3JtYXQuY1RGRVRDMV9SR0I7CiAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydGVkVGFyZ2V0Rm9ybWF0cy5wdnJ0YykgewogICAgICAgIGludGVybmFsRm9ybWF0ID0gaGFzQWxwaGEgPyBQaXhlbEZvcm1hdF9kZWZhdWx0LlJHQkFfUFZSVENfNEJQUFYxIDogUGl4ZWxGb3JtYXRfZGVmYXVsdC5SR0JfUFZSVENfNEJQUFYxOwogICAgICAgIHRyYW5zY29kZXJGb3JtYXQgPSBoYXNBbHBoYSA/IEJhc2lzRm9ybWF0LmNURlBWUlRDMV80X1JHQkEgOiBCYXNpc0Zvcm1hdC5jVEZQVlJUQzFfNF9SR0I7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KAogICAgICAgICAgIk5vIHRyYW5zY29kaW5nIGZvcm1hdCB0YXJnZXQgYXZhaWxhYmxlIGZvciBVQVNUQyBjb21wcmVzc2VkIGt0eDIuIgogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIGlmICgha3R4MkZpbGUuc3RhcnRUcmFuc2NvZGluZygpKSB7CiAgICAgIGt0eDJGaWxlLmNsb3NlKCk7CiAgICAgIGt0eDJGaWxlLmRlbGV0ZSgpOwogICAgICB0aHJvdyBuZXcgUnVudGltZUVycm9yX2RlZmF1bHQoInN0YXJ0VHJhbnNjb2RpbmcoKSBmYWlsZWQiKTsKICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGVhZGVyLmxldmVscy5sZW5ndGg7ICsraSkgewogICAgICBjb25zdCBsZXZlbCA9IHt9OwogICAgICByZXN1bHRbaV0gPSBsZXZlbDsKICAgICAgd2lkdGggPSBoZWFkZXIucGl4ZWxXaWR0aCA+PiBpOwogICAgICBoZWlnaHQgPSBoZWFkZXIucGl4ZWxIZWlnaHQgPj4gaTsKICAgICAgY29uc3QgZHN0U2l6ZSA9IGt0eDJGaWxlLmdldEltYWdlVHJhbnNjb2RlZFNpemVJbkJ5dGVzKAogICAgICAgIGksCiAgICAgICAgLy8gbGV2ZWwgaW5kZXgKICAgICAgICAwLAogICAgICAgIC8vIGxheWVyIGluZGV4CiAgICAgICAgMCwKICAgICAgICAvLyBmYWNlIGluZGV4CiAgICAgICAgdHJhbnNjb2RlckZvcm1hdC52YWx1ZQogICAgICApOwogICAgICBjb25zdCBkc3QgPSBuZXcgVWludDhBcnJheShkc3RTaXplKTsKICAgICAgY29uc3QgdHJhbnNjb2RlZCA9IGt0eDJGaWxlLnRyYW5zY29kZUltYWdlKAogICAgICAgIGRzdCwKICAgICAgICBpLAogICAgICAgIC8vIGxldmVsIGluZGV4CiAgICAgICAgMCwKICAgICAgICAvLyBsYXllciBpbmRleAogICAgICAgIDAsCiAgICAgICAgLy8gZmFjZSBpbmRleAogICAgICAgIHRyYW5zY29kZXJGb3JtYXQudmFsdWUsCiAgICAgICAgMCwKICAgICAgICAvLyBnZXRfYWxwaGFfZm9yX29wYXF1ZV9mb3JtYXRzCiAgICAgICAgLTEsCiAgICAgICAgLy8gY2hhbm5lbDAKICAgICAgICAtMQogICAgICAgIC8vIGNoYW5uZWwxCiAgICAgICk7CiAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHRyYW5zY29kZWQpKSB7CiAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFcnJvcl9kZWZhdWx0KCJ0cmFuc2NvZGVJbWFnZSgpIGZhaWxlZC4iKTsKICAgICAgfQogICAgICB0cmFuc2ZlcmFibGVPYmplY3RzLnB1c2goZHN0LmJ1ZmZlcik7CiAgICAgIGxldmVsW2ZhY2VPcmRlclswXV0gPSB7CiAgICAgICAgaW50ZXJuYWxGb3JtYXQsCiAgICAgICAgd2lkdGgsCiAgICAgICAgaGVpZ2h0LAogICAgICAgIGxldmVsQnVmZmVyOiBkc3QKICAgICAgfTsKICAgIH0KICAgIGt0eDJGaWxlLmNsb3NlKCk7CiAgICBrdHgyRmlsZS5kZWxldGUoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGFzeW5jIGZ1bmN0aW9uIGluaXRXb3JrZXIzKHBhcmFtZXRlcnMsIHRyYW5zZmVyYWJsZU9iamVjdHMpIHsKICAgIGNvbnN0IHdhc21Db25maWcgPSBwYXJhbWV0ZXJzLndlYkFzc2VtYmx5Q29uZmlnOwogICAgY29uc3QgYmFzaXNUcmFuc2NvZGVyID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQoaW1wb3J0X2Jhc2lzX3RyYW5zY29kZXIuZGVmYXVsdCwgc2VsZi5CQVNJUyk7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHdhc21Db25maWcud2FzbUJpbmFyeUZpbGUpKSB7CiAgICAgIHRyYW5zY29kZXJNb2R1bGUgPSBhd2FpdCBiYXNpc1RyYW5zY29kZXIod2FzbUNvbmZpZyk7CiAgICB9IGVsc2UgewogICAgICB0cmFuc2NvZGVyTW9kdWxlID0gYXdhaXQgYmFzaXNUcmFuc2NvZGVyKCk7CiAgICB9CiAgICB0cmFuc2NvZGVyTW9kdWxlLmluaXRpYWxpemVCYXNpcygpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIGZ1bmN0aW9uIHRyYW5zY29kZUtUWDIocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3Qgd2FzbUNvbmZpZyA9IHBhcmFtZXRlcnMud2ViQXNzZW1ibHlDb25maWc7CiAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHdhc21Db25maWcpKSB7CiAgICAgIHJldHVybiBpbml0V29ya2VyMyhwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKTsKICAgIH0KICAgIHJldHVybiB0cmFuc2NvZGUocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cyk7CiAgfQogIHZhciBpbXBvcnRfYmFzaXNfdHJhbnNjb2RlciwgZmFjZU9yZGVyLCBjb2xvck1vZGVsRVRDMVMsIGNvbG9yTW9kZWxVQVNUQywgdHJhbnNjb2Rlck1vZHVsZSwgdHJhbnNjb2RlS1RYMl9kZWZhdWx0OwogIHZhciBpbml0X3RyYW5zY29kZUtUWDIgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL3RyYW5zY29kZUtUWDIuanMiKCkgewogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9DaGVjaygpOwogICAgICBpbml0X1BpeGVsRm9ybWF0KCk7CiAgICAgIGluaXRfUnVudGltZUVycm9yKCk7CiAgICAgIGluaXRfVnVsa2FuQ29uc3RhbnRzKCk7CiAgICAgIGluaXRfUGl4ZWxEYXRhdHlwZSgpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgaW5pdF9rdHhfcGFyc2VfbW9kZXJuKCk7CiAgICAgIGltcG9ydF9iYXNpc190cmFuc2NvZGVyID0gX190b0VTTShyZXF1aXJlX2Jhc2lzX3RyYW5zY29kZXIoKSwgMSk7CiAgICAgIGZhY2VPcmRlciA9IFsKICAgICAgICAicG9zaXRpdmVYIiwKICAgICAgICAibmVnYXRpdmVYIiwKICAgICAgICAicG9zaXRpdmVZIiwKICAgICAgICAibmVnYXRpdmVZIiwKICAgICAgICAicG9zaXRpdmVaIiwKICAgICAgICAibmVnYXRpdmVaIgogICAgICBdOwogICAgICBjb2xvck1vZGVsRVRDMVMgPSAxNjM7CiAgICAgIGNvbG9yTW9kZWxVQVNUQyA9IDE2NjsKICAgICAgdHJhbnNjb2RlS1RYMl9kZWZhdWx0ID0gY3JlYXRlVGFza1Byb2Nlc3Nvcldvcmtlcl9kZWZhdWx0KHRyYW5zY29kZUtUWDIpOwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL1dvcmtlcnMvdHJhbnNmZXJUeXBlZEFycmF5VGVzdC5qcwogIHZhciB0cmFuc2ZlclR5cGVkQXJyYXlUZXN0X2V4cG9ydHMgPSB7fTsKICB2YXIgaW5pdF90cmFuc2ZlclR5cGVkQXJyYXlUZXN0ID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy90cmFuc2ZlclR5cGVkQXJyYXlUZXN0LmpzIigpIHsKICAgICAgc2VsZi5vbm1lc3NhZ2UgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgIGNvbnN0IGFycmF5ID0gZXZlbnQuZGF0YS5hcnJheTsKICAgICAgICBjb25zdCBwb3N0TWVzc2FnZTIgPSBzZWxmLndlYmtpdFBvc3RNZXNzYWdlIHx8IHNlbGYucG9zdE1lc3NhZ2U7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHBvc3RNZXNzYWdlMigKICAgICAgICAgICAgewogICAgICAgICAgICAgIGFycmF5CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFthcnJheS5idWZmZXJdCiAgICAgICAgICApOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHBvc3RNZXNzYWdlMih7fSk7CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH0pOwoKICAvLyBwYWNrYWdlcy9lbmdpbmUvU291cmNlL0NvcmUvSW50ZXJzZWN0aW9uczJELmpzCiAgdmFyIEludGVyc2VjdGlvbnMyRCwgSW50ZXJzZWN0aW9uczJEX2RlZmF1bHQ7CiAgdmFyIGluaXRfSW50ZXJzZWN0aW9uczJEID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvQ29yZS9JbnRlcnNlY3Rpb25zMkQuanMiKCkgewogICAgICBpbml0X0NhcnRlc2lhbjIoKTsKICAgICAgaW5pdF9DYXJ0ZXNpYW4zKCk7CiAgICAgIGluaXRfQ2hlY2soKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRGV2ZWxvcGVyRXJyb3IoKTsKICAgICAgSW50ZXJzZWN0aW9uczJEID0ge307CiAgICAgIEludGVyc2VjdGlvbnMyRC5jbGlwVHJpYW5nbGVBdEF4aXNBbGlnbmVkVGhyZXNob2xkID0gZnVuY3Rpb24odGhyZXNob2xkLCBrZWVwQWJvdmUsIHUwLCB1MTIsIHUyMiwgcmVzdWx0KSB7CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodGhyZXNob2xkKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInRocmVzaG9sZCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoa2VlcEFib3ZlKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoImtlZXBBYm92ZSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodTApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgidTAgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHUxMikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ1MSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQodTIyKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInUyIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0Lmxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgICAgIGxldCB1MEJlaGluZDsKICAgICAgICBsZXQgdTFCZWhpbmQ7CiAgICAgICAgbGV0IHUyQmVoaW5kOwogICAgICAgIGlmIChrZWVwQWJvdmUpIHsKICAgICAgICAgIHUwQmVoaW5kID0gdTAgPCB0aHJlc2hvbGQ7CiAgICAgICAgICB1MUJlaGluZCA9IHUxMiA8IHRocmVzaG9sZDsKICAgICAgICAgIHUyQmVoaW5kID0gdTIyIDwgdGhyZXNob2xkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB1MEJlaGluZCA9IHUwID4gdGhyZXNob2xkOwogICAgICAgICAgdTFCZWhpbmQgPSB1MTIgPiB0aHJlc2hvbGQ7CiAgICAgICAgICB1MkJlaGluZCA9IHUyMiA+IHRocmVzaG9sZDsKICAgICAgICB9CiAgICAgICAgY29uc3QgbnVtQmVoaW5kID0gdTBCZWhpbmQgKyB1MUJlaGluZCArIHUyQmVoaW5kOwogICAgICAgIGxldCB1MDFSYXRpbzsKICAgICAgICBsZXQgdTAyUmF0aW87CiAgICAgICAgbGV0IHUxMlJhdGlvOwogICAgICAgIGxldCB1MTBSYXRpbzsKICAgICAgICBsZXQgdTIwUmF0aW87CiAgICAgICAgbGV0IHUyMVJhdGlvOwogICAgICAgIGlmIChudW1CZWhpbmQgPT09IDEpIHsKICAgICAgICAgIGlmICh1MEJlaGluZCkgewogICAgICAgICAgICB1MDFSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MCkgLyAodTEyIC0gdTApOwogICAgICAgICAgICB1MDJSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MCkgLyAodTIyIC0gdTApOwogICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgIGlmICh1MDJSYXRpbyAhPT0gMSkgewogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCh1MDJSYXRpbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHUwMVJhdGlvICE9PSAxKSB7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHUwMVJhdGlvKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh1MUJlaGluZCkgewogICAgICAgICAgICB1MTJSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MTIpIC8gKHUyMiAtIHUxMik7CiAgICAgICAgICAgIHUxMFJhdGlvID0gKHRocmVzaG9sZCAtIHUxMikgLyAodTAgLSB1MTIpOwogICAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgIGlmICh1MTBSYXRpbyAhPT0gMSkgewogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCh1MTBSYXRpbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHUxMlJhdGlvICE9PSAxKSB7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHUxMlJhdGlvKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh1MkJlaGluZCkgewogICAgICAgICAgICB1MjBSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MjIpIC8gKHUwIC0gdTIyKTsKICAgICAgICAgICAgdTIxUmF0aW8gPSAodGhyZXNob2xkIC0gdTIyKSAvICh1MTIgLSB1MjIpOwogICAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgIGlmICh1MjFSYXRpbyAhPT0gMSkgewogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgICByZXN1bHQucHVzaCh1MjFSYXRpbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHUyMFJhdGlvICE9PSAxKSB7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHUyMFJhdGlvKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAobnVtQmVoaW5kID09PSAyKSB7CiAgICAgICAgICBpZiAoIXUwQmVoaW5kICYmIHUwICE9PSB0aHJlc2hvbGQpIHsKICAgICAgICAgICAgdTEwUmF0aW8gPSAodGhyZXNob2xkIC0gdTEyKSAvICh1MCAtIHUxMik7CiAgICAgICAgICAgIHUyMFJhdGlvID0gKHRocmVzaG9sZCAtIHUyMikgLyAodTAgLSB1MjIpOwogICAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHUxMFJhdGlvKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHUyMFJhdGlvKTsKICAgICAgICAgIH0gZWxzZSBpZiAoIXUxQmVoaW5kICYmIHUxMiAhPT0gdGhyZXNob2xkKSB7CiAgICAgICAgICAgIHUyMVJhdGlvID0gKHRocmVzaG9sZCAtIHUyMikgLyAodTEyIC0gdTIyKTsKICAgICAgICAgICAgdTAxUmF0aW8gPSAodGhyZXNob2xkIC0gdTApIC8gKHUxMiAtIHUwKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgICAgICByZXN1bHQucHVzaCh1MjFSYXRpbyk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgICAgICByZXN1bHQucHVzaCh1MDFSYXRpbyk7CiAgICAgICAgICB9IGVsc2UgaWYgKCF1MkJlaGluZCAmJiB1MjIgIT09IHRocmVzaG9sZCkgewogICAgICAgICAgICB1MDJSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MCkgLyAodTIyIC0gdTApOwogICAgICAgICAgICB1MTJSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MTIpIC8gKHUyMiAtIHUxMik7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2godTAyUmF0aW8pOwogICAgICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICAgICAgcmVzdWx0LnB1c2godTEyUmF0aW8pOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAobnVtQmVoaW5kICE9PSAzKSB7CiAgICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIEludGVyc2VjdGlvbnMyRC5jb21wdXRlQmFyeWNlbnRyaWNDb29yZGluYXRlcyA9IGZ1bmN0aW9uKHgsIHksIHgxLCB5MSwgeDIsIHkyLCB4MywgeTMsIHJlc3VsdCkgewogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHgpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgieCBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoeSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ5IGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh4MSkpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ4MSBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoeTEpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgieTEgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHgyKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIngyIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdCh5MikpIHsKICAgICAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcl9kZWZhdWx0KCJ5MiBpcyByZXF1aXJlZC4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFkZWZpbmVkX2RlZmF1bHQoeDMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3JfZGVmYXVsdCgieDMgaXMgcmVxdWlyZWQuIik7CiAgICAgICAgfQogICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHkzKSkgewogICAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoInkzIGlzIHJlcXVpcmVkLiIpOwogICAgICAgIH0KICAgICAgICBjb25zdCB4MW14MyA9IHgxIC0geDM7CiAgICAgICAgY29uc3QgeDNteDIgPSB4MyAtIHgyOwogICAgICAgIGNvbnN0IHkybXkzID0geTIgLSB5MzsKICAgICAgICBjb25zdCB5MW15MyA9IHkxIC0geTM7CiAgICAgICAgY29uc3QgaW52ZXJzZURldGVybWluYW50ID0gMSAvICh5Mm15MyAqIHgxbXgzICsgeDNteDIgKiB5MW15Myk7CiAgICAgICAgY29uc3QgeW15MyA9IHkgLSB5MzsKICAgICAgICBjb25zdCB4bXgzID0geCAtIHgzOwogICAgICAgIGNvbnN0IGwxID0gKHkybXkzICogeG14MyArIHgzbXgyICogeW15MykgKiBpbnZlcnNlRGV0ZXJtaW5hbnQ7CiAgICAgICAgY29uc3QgbDIgPSAoLXkxbXkzICogeG14MyArIHgxbXgzICogeW15MykgKiBpbnZlcnNlRGV0ZXJtaW5hbnQ7CiAgICAgICAgY29uc3QgbDMgPSAxIC0gbDEgLSBsMjsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdC54ID0gbDE7CiAgICAgICAgICByZXN1bHQueSA9IGwyOwogICAgICAgICAgcmVzdWx0LnogPSBsMzsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KGwxLCBsMiwgbDMpOwogICAgICB9OwogICAgICBJbnRlcnNlY3Rpb25zMkQuY29tcHV0ZUxpbmVTZWdtZW50TGluZVNlZ21lbnRJbnRlcnNlY3Rpb24gPSBmdW5jdGlvbih4MDAsIHkwMCwgeDAxLCB5MDEsIHgxMCwgeTEwLCB4MTEsIHkxMSwgcmVzdWx0KSB7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ4MDAiLCB4MDApOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieTAwIiwgeTAwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoIngwMSIsIHgwMSk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ5MDEiLCB5MDEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieDEwIiwgeDEwKTsKICAgICAgICBDaGVja19kZWZhdWx0LnR5cGVPZi5udW1iZXIoInkxMCIsIHkxMCk7CiAgICAgICAgQ2hlY2tfZGVmYXVsdC50eXBlT2YubnVtYmVyKCJ4MTEiLCB4MTEpOwogICAgICAgIENoZWNrX2RlZmF1bHQudHlwZU9mLm51bWJlcigieTExIiwgeTExKTsKICAgICAgICBjb25zdCBudW1lcmF0b3IxQSA9ICh4MTEgLSB4MTApICogKHkwMCAtIHkxMCkgLSAoeTExIC0geTEwKSAqICh4MDAgLSB4MTApOwogICAgICAgIGNvbnN0IG51bWVyYXRvcjFCID0gKHgwMSAtIHgwMCkgKiAoeTAwIC0geTEwKSAtICh5MDEgLSB5MDApICogKHgwMCAtIHgxMCk7CiAgICAgICAgY29uc3QgZGVub21pbmF0b3IxID0gKHkxMSAtIHkxMCkgKiAoeDAxIC0geDAwKSAtICh4MTEgLSB4MTApICogKHkwMSAtIHkwMCk7CiAgICAgICAgaWYgKGRlbm9taW5hdG9yMSA9PT0gMCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB1YTEgPSBudW1lcmF0b3IxQSAvIGRlbm9taW5hdG9yMTsKICAgICAgICBjb25zdCB1YjEgPSBudW1lcmF0b3IxQiAvIGRlbm9taW5hdG9yMTsKICAgICAgICBpZiAodWExID49IDAgJiYgdWExIDw9IDEgJiYgdWIxID49IDAgJiYgdWIxIDw9IDEpIHsKICAgICAgICAgIGlmICghZGVmaW5lZF9kZWZhdWx0KHJlc3VsdCkpIHsKICAgICAgICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjJfZGVmYXVsdCgpOwogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0LnggPSB4MDAgKyB1YTEgKiAoeDAxIC0geDAwKTsKICAgICAgICAgIHJlc3VsdC55ID0geTAwICsgdWExICogKHkwMSAtIHkwMCk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfTsKICAgICAgSW50ZXJzZWN0aW9uczJEX2RlZmF1bHQgPSBJbnRlcnNlY3Rpb25zMkQ7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy91cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoLmpzCiAgdmFyIHVwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2hfZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KHVwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2hfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaF9kZWZhdWx0CiAgfSk7CiAgZnVuY3Rpb24gdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaChwYXJhbWV0ZXJzLCB0cmFuc2ZlcmFibGVPYmplY3RzKSB7CiAgICBjb25zdCBpc0Vhc3RDaGlsZCA9IHBhcmFtZXRlcnMuaXNFYXN0Q2hpbGQ7CiAgICBjb25zdCBpc05vcnRoQ2hpbGQgPSBwYXJhbWV0ZXJzLmlzTm9ydGhDaGlsZDsKICAgIGNvbnN0IG1pblUgPSBpc0Vhc3RDaGlsZCA/IGhhbGZNYXhTaG9ydCA6IDA7CiAgICBjb25zdCBtYXhVID0gaXNFYXN0Q2hpbGQgPyBtYXhTaG9ydDUgOiBoYWxmTWF4U2hvcnQ7CiAgICBjb25zdCBtaW5WID0gaXNOb3J0aENoaWxkID8gaGFsZk1heFNob3J0IDogMDsKICAgIGNvbnN0IG1heFYgPSBpc05vcnRoQ2hpbGQgPyBtYXhTaG9ydDUgOiBoYWxmTWF4U2hvcnQ7CiAgICBjb25zdCB1QnVmZmVyID0gdVNjcmF0Y2g7CiAgICBjb25zdCB2QnVmZmVyID0gdlNjcmF0Y2g7CiAgICBjb25zdCBoZWlnaHRCdWZmZXIgPSBoZWlnaHRTY3JhdGNoOwogICAgY29uc3Qgbm9ybWFsQnVmZmVyID0gbm9ybWFsc1NjcmF0Y2g7CiAgICB1QnVmZmVyLmxlbmd0aCA9IDA7CiAgICB2QnVmZmVyLmxlbmd0aCA9IDA7CiAgICBoZWlnaHRCdWZmZXIubGVuZ3RoID0gMDsKICAgIG5vcm1hbEJ1ZmZlci5sZW5ndGggPSAwOwogICAgY29uc3QgaW5kaWNlcyA9IGluZGljZXNTY3JhdGNoOwogICAgaW5kaWNlcy5sZW5ndGggPSAwOwogICAgY29uc3QgdmVydGV4TWFwID0ge307CiAgICBjb25zdCBwYXJlbnRWZXJ0aWNlcyA9IHBhcmFtZXRlcnMudmVydGljZXM7CiAgICBsZXQgcGFyZW50SW5kaWNlcyA9IHBhcmFtZXRlcnMuaW5kaWNlczsKICAgIHBhcmVudEluZGljZXMgPSBwYXJlbnRJbmRpY2VzLnN1YmFycmF5KDAsIHBhcmFtZXRlcnMuaW5kZXhDb3VudFdpdGhvdXRTa2lydHMpOwogICAgY29uc3QgZW5jb2RpbmcgPSBUZXJyYWluRW5jb2RpbmdfZGVmYXVsdC5jbG9uZShwYXJhbWV0ZXJzLmVuY29kaW5nKTsKICAgIGNvbnN0IGhhc1ZlcnRleE5vcm1hbHMgPSBlbmNvZGluZy5oYXNWZXJ0ZXhOb3JtYWxzOwogICAgbGV0IHZlcnRleENvdW50ID0gMDsKICAgIGNvbnN0IHF1YW50aXplZFZlcnRleENvdW50ID0gcGFyYW1ldGVycy52ZXJ0ZXhDb3VudFdpdGhvdXRTa2lydHM7CiAgICBjb25zdCBwYXJlbnRNaW5pbXVtSGVpZ2h0ID0gcGFyYW1ldGVycy5taW5pbXVtSGVpZ2h0OwogICAgY29uc3QgcGFyZW50TWF4aW11bUhlaWdodCA9IHBhcmFtZXRlcnMubWF4aW11bUhlaWdodDsKICAgIGNvbnN0IHBhcmVudFVCdWZmZXIgPSBuZXcgQXJyYXkocXVhbnRpemVkVmVydGV4Q291bnQpOwogICAgY29uc3QgcGFyZW50VkJ1ZmZlciA9IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgICBjb25zdCBwYXJlbnRIZWlnaHRCdWZmZXIgPSBuZXcgQXJyYXkocXVhbnRpemVkVmVydGV4Q291bnQpOwogICAgY29uc3QgcGFyZW50Tm9ybWFsQnVmZmVyID0gaGFzVmVydGV4Tm9ybWFscyA/IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCAqIDIpIDogdm9pZCAwOwogICAgY29uc3QgdGhyZXNob2xkID0gMjA7CiAgICBsZXQgaGVpZ2h0OwogICAgbGV0IGksIG47CiAgICBsZXQgdTMsIHYzOwogICAgZm9yIChpID0gMCwgbiA9IDA7IGkgPCBxdWFudGl6ZWRWZXJ0ZXhDb3VudDsgKytpLCBuICs9IDIpIHsKICAgICAgY29uc3QgdGV4Q29vcmRzID0gZW5jb2RpbmcuZGVjb2RlVGV4dHVyZUNvb3JkaW5hdGVzKAogICAgICAgIHBhcmVudFZlcnRpY2VzLAogICAgICAgIGksCiAgICAgICAgZGVjb2RlVGV4Q29vcmRzU2NyYXRjaAogICAgICApOwogICAgICBoZWlnaHQgPSBlbmNvZGluZy5kZWNvZGVIZWlnaHQocGFyZW50VmVydGljZXMsIGkpOwogICAgICB1MyA9IE1hdGhfZGVmYXVsdC5jbGFtcCh0ZXhDb29yZHMueCAqIG1heFNob3J0NSB8IDAsIDAsIG1heFNob3J0NSk7CiAgICAgIHYzID0gTWF0aF9kZWZhdWx0LmNsYW1wKHRleENvb3Jkcy55ICogbWF4U2hvcnQ1IHwgMCwgMCwgbWF4U2hvcnQ1KTsKICAgICAgcGFyZW50SGVpZ2h0QnVmZmVyW2ldID0gTWF0aF9kZWZhdWx0LmNsYW1wKAogICAgICAgIChoZWlnaHQgLSBwYXJlbnRNaW5pbXVtSGVpZ2h0KSAvIChwYXJlbnRNYXhpbXVtSGVpZ2h0IC0gcGFyZW50TWluaW11bUhlaWdodCkgKiBtYXhTaG9ydDUgfCAwLAogICAgICAgIDAsCiAgICAgICAgbWF4U2hvcnQ1CiAgICAgICk7CiAgICAgIGlmICh1MyA8IHRocmVzaG9sZCkgewogICAgICAgIHUzID0gMDsKICAgICAgfQogICAgICBpZiAodjMgPCB0aHJlc2hvbGQpIHsKICAgICAgICB2MyA9IDA7CiAgICAgIH0KICAgICAgaWYgKG1heFNob3J0NSAtIHUzIDwgdGhyZXNob2xkKSB7CiAgICAgICAgdTMgPSBtYXhTaG9ydDU7CiAgICAgIH0KICAgICAgaWYgKG1heFNob3J0NSAtIHYzIDwgdGhyZXNob2xkKSB7CiAgICAgICAgdjMgPSBtYXhTaG9ydDU7CiAgICAgIH0KICAgICAgcGFyZW50VUJ1ZmZlcltpXSA9IHUzOwogICAgICBwYXJlbnRWQnVmZmVyW2ldID0gdjM7CiAgICAgIGlmIChoYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICAgICAgY29uc3QgZW5jb2RlZE5vcm1hbCA9IGVuY29kaW5nLmdldE9jdEVuY29kZWROb3JtYWwoCiAgICAgICAgICBwYXJlbnRWZXJ0aWNlcywKICAgICAgICAgIGksCiAgICAgICAgICBvY3RFbmNvZGVkTm9ybWFsU2NyYXRjaAogICAgICAgICk7CiAgICAgICAgcGFyZW50Tm9ybWFsQnVmZmVyW25dID0gZW5jb2RlZE5vcm1hbC54OwogICAgICAgIHBhcmVudE5vcm1hbEJ1ZmZlcltuICsgMV0gPSBlbmNvZGVkTm9ybWFsLnk7CiAgICAgIH0KICAgICAgaWYgKChpc0Vhc3RDaGlsZCAmJiB1MyA+PSBoYWxmTWF4U2hvcnQgfHwgIWlzRWFzdENoaWxkICYmIHUzIDw9IGhhbGZNYXhTaG9ydCkgJiYgKGlzTm9ydGhDaGlsZCAmJiB2MyA+PSBoYWxmTWF4U2hvcnQgfHwgIWlzTm9ydGhDaGlsZCAmJiB2MyA8PSBoYWxmTWF4U2hvcnQpKSB7CiAgICAgICAgdmVydGV4TWFwW2ldID0gdmVydGV4Q291bnQ7CiAgICAgICAgdUJ1ZmZlci5wdXNoKHUzKTsKICAgICAgICB2QnVmZmVyLnB1c2godjMpOwogICAgICAgIGhlaWdodEJ1ZmZlci5wdXNoKHBhcmVudEhlaWdodEJ1ZmZlcltpXSk7CiAgICAgICAgaWYgKGhhc1ZlcnRleE5vcm1hbHMpIHsKICAgICAgICAgIG5vcm1hbEJ1ZmZlci5wdXNoKHBhcmVudE5vcm1hbEJ1ZmZlcltuXSk7CiAgICAgICAgICBub3JtYWxCdWZmZXIucHVzaChwYXJlbnROb3JtYWxCdWZmZXJbbiArIDFdKTsKICAgICAgICB9CiAgICAgICAgKyt2ZXJ0ZXhDb3VudDsKICAgICAgfQogICAgfQogICAgY29uc3QgdHJpYW5nbGVWZXJ0aWNlcyA9IFtdOwogICAgdHJpYW5nbGVWZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgICB0cmlhbmdsZVZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgIHRyaWFuZ2xlVmVydGljZXMucHVzaChuZXcgVmVydGV4KCkpOwogICAgY29uc3QgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXMgPSBbXTsKICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICAgIGxldCBjbGlwcGVkSW5kZXg7CiAgICBsZXQgY2xpcHBlZDI7CiAgICBmb3IgKGkgPSAwOyBpIDwgcGFyZW50SW5kaWNlcy5sZW5ndGg7IGkgKz0gMykgewogICAgICBjb25zdCBpMCA9IHBhcmVudEluZGljZXNbaV07CiAgICAgIGNvbnN0IGkxID0gcGFyZW50SW5kaWNlc1tpICsgMV07CiAgICAgIGNvbnN0IGkyID0gcGFyZW50SW5kaWNlc1tpICsgMl07CiAgICAgIGNvbnN0IHUwID0gcGFyZW50VUJ1ZmZlcltpMF07CiAgICAgIGNvbnN0IHUxMiA9IHBhcmVudFVCdWZmZXJbaTFdOwogICAgICBjb25zdCB1MjIgPSBwYXJlbnRVQnVmZmVyW2kyXTsKICAgICAgdHJpYW5nbGVWZXJ0aWNlc1swXS5pbml0aWFsaXplSW5kZXhlZCgKICAgICAgICBwYXJlbnRVQnVmZmVyLAogICAgICAgIHBhcmVudFZCdWZmZXIsCiAgICAgICAgcGFyZW50SGVpZ2h0QnVmZmVyLAogICAgICAgIHBhcmVudE5vcm1hbEJ1ZmZlciwKICAgICAgICBpMAogICAgICApOwogICAgICB0cmlhbmdsZVZlcnRpY2VzWzFdLmluaXRpYWxpemVJbmRleGVkKAogICAgICAgIHBhcmVudFVCdWZmZXIsCiAgICAgICAgcGFyZW50VkJ1ZmZlciwKICAgICAgICBwYXJlbnRIZWlnaHRCdWZmZXIsCiAgICAgICAgcGFyZW50Tm9ybWFsQnVmZmVyLAogICAgICAgIGkxCiAgICAgICk7CiAgICAgIHRyaWFuZ2xlVmVydGljZXNbMl0uaW5pdGlhbGl6ZUluZGV4ZWQoCiAgICAgICAgcGFyZW50VUJ1ZmZlciwKICAgICAgICBwYXJlbnRWQnVmZmVyLAogICAgICAgIHBhcmVudEhlaWdodEJ1ZmZlciwKICAgICAgICBwYXJlbnROb3JtYWxCdWZmZXIsCiAgICAgICAgaTIKICAgICAgKTsKICAgICAgY29uc3QgY2xpcHBlZCA9IEludGVyc2VjdGlvbnMyRF9kZWZhdWx0LmNsaXBUcmlhbmdsZUF0QXhpc0FsaWduZWRUaHJlc2hvbGQoCiAgICAgICAgaGFsZk1heFNob3J0LAogICAgICAgIGlzRWFzdENoaWxkLAogICAgICAgIHUwLAogICAgICAgIHUxMiwKICAgICAgICB1MjIsCiAgICAgICAgY2xpcFNjcmF0Y2gKICAgICAgKTsKICAgICAgY2xpcHBlZEluZGV4ID0gMDsKICAgICAgaWYgKGNsaXBwZWRJbmRleCA+PSBjbGlwcGVkLmxlbmd0aCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNsaXBwZWRJbmRleCA9IGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzBdLmluaXRpYWxpemVGcm9tQ2xpcFJlc3VsdCgKICAgICAgICBjbGlwcGVkLAogICAgICAgIGNsaXBwZWRJbmRleCwKICAgICAgICB0cmlhbmdsZVZlcnRpY2VzCiAgICAgICk7CiAgICAgIGlmIChjbGlwcGVkSW5kZXggPj0gY2xpcHBlZC5sZW5ndGgpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjbGlwcGVkSW5kZXggPSBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1sxXS5pbml0aWFsaXplRnJvbUNsaXBSZXN1bHQoCiAgICAgICAgY2xpcHBlZCwKICAgICAgICBjbGlwcGVkSW5kZXgsCiAgICAgICAgdHJpYW5nbGVWZXJ0aWNlcwogICAgICApOwogICAgICBpZiAoY2xpcHBlZEluZGV4ID49IGNsaXBwZWQubGVuZ3RoKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY2xpcHBlZEluZGV4ID0gY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMl0uaW5pdGlhbGl6ZUZyb21DbGlwUmVzdWx0KAogICAgICAgIGNsaXBwZWQsCiAgICAgICAgY2xpcHBlZEluZGV4LAogICAgICAgIHRyaWFuZ2xlVmVydGljZXMKICAgICAgKTsKICAgICAgY2xpcHBlZDIgPSBJbnRlcnNlY3Rpb25zMkRfZGVmYXVsdC5jbGlwVHJpYW5nbGVBdEF4aXNBbGlnbmVkVGhyZXNob2xkKAogICAgICAgIGhhbGZNYXhTaG9ydCwKICAgICAgICBpc05vcnRoQ2hpbGQsCiAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMF0uZ2V0VigpLAogICAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzFdLmdldFYoKSwKICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1syXS5nZXRWKCksCiAgICAgICAgY2xpcFNjcmF0Y2gyCiAgICAgICk7CiAgICAgIGFkZENsaXBwZWRQb2x5Z29uKAogICAgICAgIHVCdWZmZXIsCiAgICAgICAgdkJ1ZmZlciwKICAgICAgICBoZWlnaHRCdWZmZXIsCiAgICAgICAgbm9ybWFsQnVmZmVyLAogICAgICAgIGluZGljZXMsCiAgICAgICAgdmVydGV4TWFwLAogICAgICAgIGNsaXBwZWQyLAogICAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzLAogICAgICAgIGhhc1ZlcnRleE5vcm1hbHMKICAgICAgKTsKICAgICAgaWYgKGNsaXBwZWRJbmRleCA8IGNsaXBwZWQubGVuZ3RoKSB7CiAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMl0uY2xvbmUoY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMV0pOwogICAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzJdLmluaXRpYWxpemVGcm9tQ2xpcFJlc3VsdCgKICAgICAgICAgIGNsaXBwZWQsCiAgICAgICAgICBjbGlwcGVkSW5kZXgsCiAgICAgICAgICB0cmlhbmdsZVZlcnRpY2VzCiAgICAgICAgKTsKICAgICAgICBjbGlwcGVkMiA9IEludGVyc2VjdGlvbnMyRF9kZWZhdWx0LmNsaXBUcmlhbmdsZUF0QXhpc0FsaWduZWRUaHJlc2hvbGQoCiAgICAgICAgICBoYWxmTWF4U2hvcnQsCiAgICAgICAgICBpc05vcnRoQ2hpbGQsCiAgICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1swXS5nZXRWKCksCiAgICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1sxXS5nZXRWKCksCiAgICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1syXS5nZXRWKCksCiAgICAgICAgICBjbGlwU2NyYXRjaDIKICAgICAgICApOwogICAgICAgIGFkZENsaXBwZWRQb2x5Z29uKAogICAgICAgICAgdUJ1ZmZlciwKICAgICAgICAgIHZCdWZmZXIsCiAgICAgICAgICBoZWlnaHRCdWZmZXIsCiAgICAgICAgICBub3JtYWxCdWZmZXIsCiAgICAgICAgICBpbmRpY2VzLAogICAgICAgICAgdmVydGV4TWFwLAogICAgICAgICAgY2xpcHBlZDIsCiAgICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlcywKICAgICAgICAgIGhhc1ZlcnRleE5vcm1hbHMKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICBjb25zdCB1T2Zmc2V0ID0gaXNFYXN0Q2hpbGQgPyAtbWF4U2hvcnQ1IDogMDsKICAgIGNvbnN0IHZPZmZzZXQgPSBpc05vcnRoQ2hpbGQgPyAtbWF4U2hvcnQ1IDogMDsKICAgIGNvbnN0IHdlc3RJbmRpY2VzID0gW107CiAgICBjb25zdCBzb3V0aEluZGljZXMgPSBbXTsKICAgIGNvbnN0IGVhc3RJbmRpY2VzID0gW107CiAgICBjb25zdCBub3J0aEluZGljZXMgPSBbXTsKICAgIGxldCBtaW5pbXVtSGVpZ2h0ID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgIGxldCBtYXhpbXVtSGVpZ2h0ID0gLW1pbmltdW1IZWlnaHQ7CiAgICBjb25zdCBjYXJ0ZXNpYW5WZXJ0aWNlcyA9IHZlcnRpY2VzU2NyYXRjaDsKICAgIGNhcnRlc2lhblZlcnRpY2VzLmxlbmd0aCA9IDA7CiAgICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWRfZGVmYXVsdC5jbG9uZShwYXJhbWV0ZXJzLmVsbGlwc29pZCk7CiAgICBjb25zdCByZWN0YW5nbGUgPSBSZWN0YW5nbGVfZGVmYXVsdC5jbG9uZShwYXJhbWV0ZXJzLmNoaWxkUmVjdGFuZ2xlKTsKICAgIGNvbnN0IG5vcnRoID0gcmVjdGFuZ2xlLm5vcnRoOwogICAgY29uc3Qgc291dGggPSByZWN0YW5nbGUuc291dGg7CiAgICBsZXQgZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogICAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogICAgaWYgKGVhc3QgPCB3ZXN0KSB7CiAgICAgIGVhc3QgKz0gTWF0aF9kZWZhdWx0LlRXT19QSTsKICAgIH0KICAgIGZvciAoaSA9IDA7IGkgPCB1QnVmZmVyLmxlbmd0aDsgKytpKSB7CiAgICAgIHUzID0gTWF0aC5yb3VuZCh1QnVmZmVyW2ldKTsKICAgICAgaWYgKHUzIDw9IG1pblUpIHsKICAgICAgICB3ZXN0SW5kaWNlcy5wdXNoKGkpOwogICAgICAgIHUzID0gMDsKICAgICAgfSBlbHNlIGlmICh1MyA+PSBtYXhVKSB7CiAgICAgICAgZWFzdEluZGljZXMucHVzaChpKTsKICAgICAgICB1MyA9IG1heFNob3J0NTsKICAgICAgfSBlbHNlIHsKICAgICAgICB1MyA9IHUzICogMiArIHVPZmZzZXQ7CiAgICAgIH0KICAgICAgdUJ1ZmZlcltpXSA9IHUzOwogICAgICB2MyA9IE1hdGgucm91bmQodkJ1ZmZlcltpXSk7CiAgICAgIGlmICh2MyA8PSBtaW5WKSB7CiAgICAgICAgc291dGhJbmRpY2VzLnB1c2goaSk7CiAgICAgICAgdjMgPSAwOwogICAgICB9IGVsc2UgaWYgKHYzID49IG1heFYpIHsKICAgICAgICBub3J0aEluZGljZXMucHVzaChpKTsKICAgICAgICB2MyA9IG1heFNob3J0NTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2MyA9IHYzICogMiArIHZPZmZzZXQ7CiAgICAgIH0KICAgICAgdkJ1ZmZlcltpXSA9IHYzOwogICAgICBoZWlnaHQgPSBNYXRoX2RlZmF1bHQubGVycCgKICAgICAgICBwYXJlbnRNaW5pbXVtSGVpZ2h0LAogICAgICAgIHBhcmVudE1heGltdW1IZWlnaHQsCiAgICAgICAgaGVpZ2h0QnVmZmVyW2ldIC8gbWF4U2hvcnQ1CiAgICAgICk7CiAgICAgIGlmIChoZWlnaHQgPCBtaW5pbXVtSGVpZ2h0KSB7CiAgICAgICAgbWluaW11bUhlaWdodCA9IGhlaWdodDsKICAgICAgfQogICAgICBpZiAoaGVpZ2h0ID4gbWF4aW11bUhlaWdodCkgewogICAgICAgIG1heGltdW1IZWlnaHQgPSBoZWlnaHQ7CiAgICAgIH0KICAgICAgaGVpZ2h0QnVmZmVyW2ldID0gaGVpZ2h0OwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoMi5sb25naXR1ZGUgPSBNYXRoX2RlZmF1bHQubGVycCh3ZXN0LCBlYXN0LCB1MyAvIG1heFNob3J0NSk7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gyLmxhdGl0dWRlID0gTWF0aF9kZWZhdWx0LmxlcnAoc291dGgsIG5vcnRoLCB2MyAvIG1heFNob3J0NSk7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gyLmhlaWdodCA9IGhlaWdodDsKICAgICAgZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGNhcnRvZ3JhcGhpY1NjcmF0Y2gyLCBjYXJ0ZXNpYW4zU2NyYXRjaDkpOwogICAgICBjYXJ0ZXNpYW5WZXJ0aWNlcy5wdXNoKGNhcnRlc2lhbjNTY3JhdGNoOS54KTsKICAgICAgY2FydGVzaWFuVmVydGljZXMucHVzaChjYXJ0ZXNpYW4zU2NyYXRjaDkueSk7CiAgICAgIGNhcnRlc2lhblZlcnRpY2VzLnB1c2goY2FydGVzaWFuM1NjcmF0Y2g5LnopOwogICAgfQogICAgY29uc3QgYm91bmRpbmdTcGhlcmUgPSBCb3VuZGluZ1NwaGVyZV9kZWZhdWx0LmZyb21WZXJ0aWNlcygKICAgICAgY2FydGVzaWFuVmVydGljZXMsCiAgICAgIENhcnRlc2lhbjNfZGVmYXVsdC5aRVJPLAogICAgICAzLAogICAgICBib3VuZGluZ1NwaGVyZVNjcmF0Y2gKICAgICk7CiAgICBjb25zdCBvcmllbnRlZEJvdW5kaW5nQm94ID0gT3JpZW50ZWRCb3VuZGluZ0JveF9kZWZhdWx0LmZyb21SZWN0YW5nbGUoCiAgICAgIHJlY3RhbmdsZSwKICAgICAgbWluaW11bUhlaWdodCwKICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgZWxsaXBzb2lkLAogICAgICBvcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaAogICAgKTsKICAgIGNvbnN0IG9jY2x1ZGVyID0gbmV3IEVsbGlwc29pZGFsT2NjbHVkZXJfZGVmYXVsdChlbGxpcHNvaWQpOwogICAgY29uc3QgaG9yaXpvbk9jY2x1c2lvblBvaW50ID0gb2NjbHVkZXIuY29tcHV0ZUhvcml6b25DdWxsaW5nUG9pbnRGcm9tVmVydGljZXNQb3NzaWJseVVuZGVyRWxsaXBzb2lkKAogICAgICBib3VuZGluZ1NwaGVyZS5jZW50ZXIsCiAgICAgIGNhcnRlc2lhblZlcnRpY2VzLAogICAgICAzLAogICAgICBib3VuZGluZ1NwaGVyZS5jZW50ZXIsCiAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgIGhvcml6b25PY2NsdXNpb25Qb2ludFNjcmF0Y2gKICAgICk7CiAgICBjb25zdCBoZWlnaHRSYW5nZSA9IG1heGltdW1IZWlnaHQgLSBtaW5pbXVtSGVpZ2h0OwogICAgY29uc3QgdmVydGljZXMgPSBuZXcgVWludDE2QXJyYXkoCiAgICAgIHVCdWZmZXIubGVuZ3RoICsgdkJ1ZmZlci5sZW5ndGggKyBoZWlnaHRCdWZmZXIubGVuZ3RoCiAgICApOwogICAgZm9yIChpID0gMDsgaSA8IHVCdWZmZXIubGVuZ3RoOyArK2kpIHsKICAgICAgdmVydGljZXNbaV0gPSB1QnVmZmVyW2ldOwogICAgfQogICAgbGV0IHN0YXJ0ID0gdUJ1ZmZlci5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgdkJ1ZmZlci5sZW5ndGg7ICsraSkgewogICAgICB2ZXJ0aWNlc1tzdGFydCArIGldID0gdkJ1ZmZlcltpXTsKICAgIH0KICAgIHN0YXJ0ICs9IHZCdWZmZXIubGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IGhlaWdodEJ1ZmZlci5sZW5ndGg7ICsraSkgewogICAgICB2ZXJ0aWNlc1tzdGFydCArIGldID0gbWF4U2hvcnQ1ICogKGhlaWdodEJ1ZmZlcltpXSAtIG1pbmltdW1IZWlnaHQpIC8gaGVpZ2h0UmFuZ2U7CiAgICB9CiAgICBjb25zdCBpbmRpY2VzVHlwZWRBcnJheSA9IEluZGV4RGF0YXR5cGVfZGVmYXVsdC5jcmVhdGVUeXBlZEFycmF5KAogICAgICB1QnVmZmVyLmxlbmd0aCwKICAgICAgaW5kaWNlcwogICAgKTsKICAgIGxldCBlbmNvZGVkTm9ybWFsczsKICAgIGlmIChoYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICAgIGNvbnN0IG5vcm1hbEFycmF5ID0gbmV3IFVpbnQ4QXJyYXkobm9ybWFsQnVmZmVyKTsKICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKAogICAgICAgIHZlcnRpY2VzLmJ1ZmZlciwKICAgICAgICBpbmRpY2VzVHlwZWRBcnJheS5idWZmZXIsCiAgICAgICAgbm9ybWFsQXJyYXkuYnVmZmVyCiAgICAgICk7CiAgICAgIGVuY29kZWROb3JtYWxzID0gbm9ybWFsQXJyYXkuYnVmZmVyOwogICAgfSBlbHNlIHsKICAgICAgdHJhbnNmZXJhYmxlT2JqZWN0cy5wdXNoKHZlcnRpY2VzLmJ1ZmZlciwgaW5kaWNlc1R5cGVkQXJyYXkuYnVmZmVyKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHZlcnRpY2VzOiB2ZXJ0aWNlcy5idWZmZXIsCiAgICAgIGVuY29kZWROb3JtYWxzLAogICAgICBpbmRpY2VzOiBpbmRpY2VzVHlwZWRBcnJheS5idWZmZXIsCiAgICAgIG1pbmltdW1IZWlnaHQsCiAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgIHdlc3RJbmRpY2VzLAogICAgICBzb3V0aEluZGljZXMsCiAgICAgIGVhc3RJbmRpY2VzLAogICAgICBub3J0aEluZGljZXMsCiAgICAgIGJvdW5kaW5nU3BoZXJlLAogICAgICBvcmllbnRlZEJvdW5kaW5nQm94LAogICAgICBob3Jpem9uT2NjbHVzaW9uUG9pbnQKICAgIH07CiAgfQogIGZ1bmN0aW9uIFZlcnRleCgpIHsKICAgIHRoaXMudmVydGV4QnVmZmVyID0gdm9pZCAwOwogICAgdGhpcy5pbmRleCA9IHZvaWQgMDsKICAgIHRoaXMuZmlyc3QgPSB2b2lkIDA7CiAgICB0aGlzLnNlY29uZCA9IHZvaWQgMDsKICAgIHRoaXMucmF0aW8gPSB2b2lkIDA7CiAgfQogIGZ1bmN0aW9uIGxlcnBPY3RFbmNvZGVkTm9ybWFsKHZlcnRleCwgcmVzdWx0KSB7CiAgICArK2RlcHRoOwogICAgbGV0IGZpcnN0ID0gY2FydGVzaWFuU2NyYXRjaDFbZGVwdGhdOwogICAgbGV0IHNlY29uZCA9IGNhcnRlc2lhblNjcmF0Y2gyW2RlcHRoXTsKICAgIGZpcnN0ID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5vY3REZWNvZGUoCiAgICAgIHZlcnRleC5maXJzdC5nZXROb3JtYWxYKCksCiAgICAgIHZlcnRleC5maXJzdC5nZXROb3JtYWxZKCksCiAgICAgIGZpcnN0CiAgICApOwogICAgc2Vjb25kID0gQXR0cmlidXRlQ29tcHJlc3Npb25fZGVmYXVsdC5vY3REZWNvZGUoCiAgICAgIHZlcnRleC5zZWNvbmQuZ2V0Tm9ybWFsWCgpLAogICAgICB2ZXJ0ZXguc2Vjb25kLmdldE5vcm1hbFkoKSwKICAgICAgc2Vjb25kCiAgICApOwogICAgY2FydGVzaWFuM1NjcmF0Y2g5ID0gQ2FydGVzaWFuM19kZWZhdWx0LmxlcnAoCiAgICAgIGZpcnN0LAogICAgICBzZWNvbmQsCiAgICAgIHZlcnRleC5yYXRpbywKICAgICAgY2FydGVzaWFuM1NjcmF0Y2g5CiAgICApOwogICAgQ2FydGVzaWFuM19kZWZhdWx0Lm5vcm1hbGl6ZShjYXJ0ZXNpYW4zU2NyYXRjaDksIGNhcnRlc2lhbjNTY3JhdGNoOSk7CiAgICBBdHRyaWJ1dGVDb21wcmVzc2lvbl9kZWZhdWx0Lm9jdEVuY29kZShjYXJ0ZXNpYW4zU2NyYXRjaDksIHJlc3VsdCk7CiAgICAtLWRlcHRoOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gYWRkQ2xpcHBlZFBvbHlnb24odUJ1ZmZlciwgdkJ1ZmZlciwgaGVpZ2h0QnVmZmVyLCBub3JtYWxCdWZmZXIsIGluZGljZXMsIHZlcnRleE1hcCwgY2xpcHBlZCwgdHJpYW5nbGVWZXJ0aWNlcywgaGFzVmVydGV4Tm9ybWFscykgewogICAgaWYgKGNsaXBwZWQubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGxldCBudW1WZXJ0aWNlcyA9IDA7CiAgICBsZXQgY2xpcHBlZEluZGV4ID0gMDsKICAgIHdoaWxlIChjbGlwcGVkSW5kZXggPCBjbGlwcGVkLmxlbmd0aCkgewogICAgICBjbGlwcGVkSW5kZXggPSBwb2x5Z29uVmVydGljZXNbbnVtVmVydGljZXMrK10uaW5pdGlhbGl6ZUZyb21DbGlwUmVzdWx0KAogICAgICAgIGNsaXBwZWQsCiAgICAgICAgY2xpcHBlZEluZGV4LAogICAgICAgIHRyaWFuZ2xlVmVydGljZXMKICAgICAgKTsKICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtVmVydGljZXM7ICsraSkgewogICAgICBjb25zdCBwb2x5Z29uVmVydGV4ID0gcG9seWdvblZlcnRpY2VzW2ldOwogICAgICBpZiAoIXBvbHlnb25WZXJ0ZXguaXNJbmRleGVkKCkpIHsKICAgICAgICBjb25zdCBrZXkgPSBwb2x5Z29uVmVydGV4LmdldEtleSgpOwogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodmVydGV4TWFwW2tleV0pKSB7CiAgICAgICAgICBwb2x5Z29uVmVydGV4Lm5ld0luZGV4ID0gdmVydGV4TWFwW2tleV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IG5ld0luZGV4ID0gdUJ1ZmZlci5sZW5ndGg7CiAgICAgICAgICB1QnVmZmVyLnB1c2gocG9seWdvblZlcnRleC5nZXRVKCkpOwogICAgICAgICAgdkJ1ZmZlci5wdXNoKHBvbHlnb25WZXJ0ZXguZ2V0VigpKTsKICAgICAgICAgIGhlaWdodEJ1ZmZlci5wdXNoKHBvbHlnb25WZXJ0ZXguZ2V0SCgpKTsKICAgICAgICAgIGlmIChoYXNWZXJ0ZXhOb3JtYWxzKSB7CiAgICAgICAgICAgIG5vcm1hbEJ1ZmZlci5wdXNoKHBvbHlnb25WZXJ0ZXguZ2V0Tm9ybWFsWCgpKTsKICAgICAgICAgICAgbm9ybWFsQnVmZmVyLnB1c2gocG9seWdvblZlcnRleC5nZXROb3JtYWxZKCkpOwogICAgICAgICAgfQogICAgICAgICAgcG9seWdvblZlcnRleC5uZXdJbmRleCA9IG5ld0luZGV4OwogICAgICAgICAgdmVydGV4TWFwW2tleV0gPSBuZXdJbmRleDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcG9seWdvblZlcnRleC5uZXdJbmRleCA9IHZlcnRleE1hcFtwb2x5Z29uVmVydGV4LmluZGV4XTsKICAgICAgICBwb2x5Z29uVmVydGV4LnVCdWZmZXIgPSB1QnVmZmVyOwogICAgICAgIHBvbHlnb25WZXJ0ZXgudkJ1ZmZlciA9IHZCdWZmZXI7CiAgICAgICAgcG9seWdvblZlcnRleC5oZWlnaHRCdWZmZXIgPSBoZWlnaHRCdWZmZXI7CiAgICAgICAgaWYgKGhhc1ZlcnRleE5vcm1hbHMpIHsKICAgICAgICAgIHBvbHlnb25WZXJ0ZXgubm9ybWFsQnVmZmVyID0gbm9ybWFsQnVmZmVyOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKG51bVZlcnRpY2VzID09PSAzKSB7CiAgICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbMF0ubmV3SW5kZXgpOwogICAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzFdLm5ld0luZGV4KTsKICAgICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1syXS5uZXdJbmRleCk7CiAgICB9IGVsc2UgaWYgKG51bVZlcnRpY2VzID09PSA0KSB7CiAgICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbMF0ubmV3SW5kZXgpOwogICAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzFdLm5ld0luZGV4KTsKICAgICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1syXS5uZXdJbmRleCk7CiAgICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbMF0ubmV3SW5kZXgpOwogICAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzJdLm5ld0luZGV4KTsKICAgICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1szXS5uZXdJbmRleCk7CiAgICB9CiAgfQogIHZhciBtYXhTaG9ydDUsIGhhbGZNYXhTaG9ydCwgY2xpcFNjcmF0Y2gsIGNsaXBTY3JhdGNoMiwgdmVydGljZXNTY3JhdGNoLCBjYXJ0b2dyYXBoaWNTY3JhdGNoMiwgY2FydGVzaWFuM1NjcmF0Y2g5LCB1U2NyYXRjaCwgdlNjcmF0Y2gsIGhlaWdodFNjcmF0Y2gsIGluZGljZXNTY3JhdGNoLCBub3JtYWxzU2NyYXRjaCwgaG9yaXpvbk9jY2x1c2lvblBvaW50U2NyYXRjaCwgYm91bmRpbmdTcGhlcmVTY3JhdGNoLCBvcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaCwgZGVjb2RlVGV4Q29vcmRzU2NyYXRjaCwgb2N0RW5jb2RlZE5vcm1hbFNjcmF0Y2gsIGVuY29kZWRTY3JhdGNoLCBkZXB0aCwgY2FydGVzaWFuU2NyYXRjaDEsIGNhcnRlc2lhblNjcmF0Y2gyLCBwb2x5Z29uVmVydGljZXMsIHVwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2hfZGVmYXVsdDsKICB2YXIgaW5pdF91cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoID0gX19lc20oewogICAgInBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy91cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoLmpzIigpIHsKICAgICAgaW5pdF9BdHRyaWJ1dGVDb21wcmVzc2lvbigpOwogICAgICBpbml0X0JvdW5kaW5nU3BoZXJlKCk7CiAgICAgIGluaXRfQ2FydGVzaWFuMigpOwogICAgICBpbml0X0NhcnRlc2lhbjMoKTsKICAgICAgaW5pdF9DYXJ0b2dyYXBoaWMoKTsKICAgICAgaW5pdF9kZWZpbmVkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkKCk7CiAgICAgIGluaXRfRWxsaXBzb2lkYWxPY2NsdWRlcigpOwogICAgICBpbml0X0luZGV4RGF0YXR5cGUoKTsKICAgICAgaW5pdF9JbnRlcnNlY3Rpb25zMkQoKTsKICAgICAgaW5pdF9NYXRoKCk7CiAgICAgIGluaXRfT3JpZW50ZWRCb3VuZGluZ0JveCgpOwogICAgICBpbml0X1JlY3RhbmdsZSgpOwogICAgICBpbml0X1RlcnJhaW5FbmNvZGluZygpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgbWF4U2hvcnQ1ID0gMzI3Njc7CiAgICAgIGhhbGZNYXhTaG9ydCA9IG1heFNob3J0NSAvIDIgfCAwOwogICAgICBjbGlwU2NyYXRjaCA9IFtdOwogICAgICBjbGlwU2NyYXRjaDIgPSBbXTsKICAgICAgdmVydGljZXNTY3JhdGNoID0gW107CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gyID0gbmV3IENhcnRvZ3JhcGhpY19kZWZhdWx0KCk7CiAgICAgIGNhcnRlc2lhbjNTY3JhdGNoOSA9IG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKTsKICAgICAgdVNjcmF0Y2ggPSBbXTsKICAgICAgdlNjcmF0Y2ggPSBbXTsKICAgICAgaGVpZ2h0U2NyYXRjaCA9IFtdOwogICAgICBpbmRpY2VzU2NyYXRjaCA9IFtdOwogICAgICBub3JtYWxzU2NyYXRjaCA9IFtdOwogICAgICBob3Jpem9uT2NjbHVzaW9uUG9pbnRTY3JhdGNoID0gbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpOwogICAgICBib3VuZGluZ1NwaGVyZVNjcmF0Y2ggPSBuZXcgQm91bmRpbmdTcGhlcmVfZGVmYXVsdCgpOwogICAgICBvcmllbnRlZEJvdW5kaW5nQm94U2NyYXRjaCA9IG5ldyBPcmllbnRlZEJvdW5kaW5nQm94X2RlZmF1bHQoKTsKICAgICAgZGVjb2RlVGV4Q29vcmRzU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgb2N0RW5jb2RlZE5vcm1hbFNjcmF0Y2ggPSBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCk7CiAgICAgIFZlcnRleC5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICBpZiAoIWRlZmluZWRfZGVmYXVsdChyZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBuZXcgVmVydGV4KCk7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC51QnVmZmVyID0gdGhpcy51QnVmZmVyOwogICAgICAgIHJlc3VsdC52QnVmZmVyID0gdGhpcy52QnVmZmVyOwogICAgICAgIHJlc3VsdC5oZWlnaHRCdWZmZXIgPSB0aGlzLmhlaWdodEJ1ZmZlcjsKICAgICAgICByZXN1bHQubm9ybWFsQnVmZmVyID0gdGhpcy5ub3JtYWxCdWZmZXI7CiAgICAgICAgcmVzdWx0LmluZGV4ID0gdGhpcy5pbmRleDsKICAgICAgICByZXN1bHQuZmlyc3QgPSB0aGlzLmZpcnN0OwogICAgICAgIHJlc3VsdC5zZWNvbmQgPSB0aGlzLnNlY29uZDsKICAgICAgICByZXN1bHQucmF0aW8gPSB0aGlzLnJhdGlvOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICAgIFZlcnRleC5wcm90b3R5cGUuaW5pdGlhbGl6ZUluZGV4ZWQgPSBmdW5jdGlvbih1QnVmZmVyLCB2QnVmZmVyLCBoZWlnaHRCdWZmZXIsIG5vcm1hbEJ1ZmZlciwgaW5kZXgpIHsKICAgICAgICB0aGlzLnVCdWZmZXIgPSB1QnVmZmVyOwogICAgICAgIHRoaXMudkJ1ZmZlciA9IHZCdWZmZXI7CiAgICAgICAgdGhpcy5oZWlnaHRCdWZmZXIgPSBoZWlnaHRCdWZmZXI7CiAgICAgICAgdGhpcy5ub3JtYWxCdWZmZXIgPSBub3JtYWxCdWZmZXI7CiAgICAgICAgdGhpcy5pbmRleCA9IGluZGV4OwogICAgICAgIHRoaXMuZmlyc3QgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5zZWNvbmQgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5yYXRpbyA9IHZvaWQgMDsKICAgICAgfTsKICAgICAgVmVydGV4LnByb3RvdHlwZS5pbml0aWFsaXplRnJvbUNsaXBSZXN1bHQgPSBmdW5jdGlvbihjbGlwUmVzdWx0LCBpbmRleCwgdmVydGljZXMpIHsKICAgICAgICBsZXQgbmV4dEluZGV4ID0gaW5kZXggKyAxOwogICAgICAgIGlmIChjbGlwUmVzdWx0W2luZGV4XSAhPT0gLTEpIHsKICAgICAgICAgIHZlcnRpY2VzW2NsaXBSZXN1bHRbaW5kZXhdXS5jbG9uZSh0aGlzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy52ZXJ0ZXhCdWZmZXIgPSB2b2lkIDA7CiAgICAgICAgICB0aGlzLmluZGV4ID0gdm9pZCAwOwogICAgICAgICAgdGhpcy5maXJzdCA9IHZlcnRpY2VzW2NsaXBSZXN1bHRbbmV4dEluZGV4XV07CiAgICAgICAgICArK25leHRJbmRleDsKICAgICAgICAgIHRoaXMuc2Vjb25kID0gdmVydGljZXNbY2xpcFJlc3VsdFtuZXh0SW5kZXhdXTsKICAgICAgICAgICsrbmV4dEluZGV4OwogICAgICAgICAgdGhpcy5yYXRpbyA9IGNsaXBSZXN1bHRbbmV4dEluZGV4XTsKICAgICAgICAgICsrbmV4dEluZGV4OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV4dEluZGV4OwogICAgICB9OwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmdldEtleSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmlzSW5kZXhlZCgpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5pbmRleDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIGZpcnN0OiB0aGlzLmZpcnN0LmdldEtleSgpLAogICAgICAgICAgc2Vjb25kOiB0aGlzLnNlY29uZC5nZXRLZXkoKSwKICAgICAgICAgIHJhdGlvOiB0aGlzLnJhdGlvCiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIFZlcnRleC5wcm90b3R5cGUuaXNJbmRleGVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGRlZmluZWRfZGVmYXVsdCh0aGlzLmluZGV4KTsKICAgICAgfTsKICAgICAgVmVydGV4LnByb3RvdHlwZS5nZXRIID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aGlzLmluZGV4KSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuaGVpZ2h0QnVmZmVyW3RoaXMuaW5kZXhdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gTWF0aF9kZWZhdWx0LmxlcnAodGhpcy5maXJzdC5nZXRIKCksIHRoaXMuc2Vjb25kLmdldEgoKSwgdGhpcy5yYXRpbyk7CiAgICAgIH07CiAgICAgIFZlcnRleC5wcm90b3R5cGUuZ2V0VSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGhpcy5pbmRleCkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnVCdWZmZXJbdGhpcy5pbmRleF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBNYXRoX2RlZmF1bHQubGVycCh0aGlzLmZpcnN0LmdldFUoKSwgdGhpcy5zZWNvbmQuZ2V0VSgpLCB0aGlzLnJhdGlvKTsKICAgICAgfTsKICAgICAgVmVydGV4LnByb3RvdHlwZS5nZXRWID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdCh0aGlzLmluZGV4KSkgewogICAgICAgICAgcmV0dXJuIHRoaXMudkJ1ZmZlclt0aGlzLmluZGV4XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE1hdGhfZGVmYXVsdC5sZXJwKHRoaXMuZmlyc3QuZ2V0VigpLCB0aGlzLnNlY29uZC5nZXRWKCksIHRoaXMucmF0aW8pOwogICAgICB9OwogICAgICBlbmNvZGVkU2NyYXRjaCA9IG5ldyBDYXJ0ZXNpYW4yX2RlZmF1bHQoKTsKICAgICAgZGVwdGggPSAtMTsKICAgICAgY2FydGVzaWFuU2NyYXRjaDEgPSBbbmV3IENhcnRlc2lhbjNfZGVmYXVsdCgpLCBuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCldOwogICAgICBjYXJ0ZXNpYW5TY3JhdGNoMiA9IFtuZXcgQ2FydGVzaWFuM19kZWZhdWx0KCksIG5ldyBDYXJ0ZXNpYW4zX2RlZmF1bHQoKV07CiAgICAgIFZlcnRleC5wcm90b3R5cGUuZ2V0Tm9ybWFsWCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQodGhpcy5pbmRleCkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm5vcm1hbEJ1ZmZlclt0aGlzLmluZGV4ICogMl07CiAgICAgICAgfQogICAgICAgIGVuY29kZWRTY3JhdGNoID0gbGVycE9jdEVuY29kZWROb3JtYWwodGhpcywgZW5jb2RlZFNjcmF0Y2gpOwogICAgICAgIHJldHVybiBlbmNvZGVkU2NyYXRjaC54OwogICAgICB9OwogICAgICBWZXJ0ZXgucHJvdG90eXBlLmdldE5vcm1hbFkgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoZGVmaW5lZF9kZWZhdWx0KHRoaXMuaW5kZXgpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5ub3JtYWxCdWZmZXJbdGhpcy5pbmRleCAqIDIgKyAxXTsKICAgICAgICB9CiAgICAgICAgZW5jb2RlZFNjcmF0Y2ggPSBsZXJwT2N0RW5jb2RlZE5vcm1hbCh0aGlzLCBlbmNvZGVkU2NyYXRjaCk7CiAgICAgICAgcmV0dXJuIGVuY29kZWRTY3JhdGNoLnk7CiAgICAgIH07CiAgICAgIHBvbHlnb25WZXJ0aWNlcyA9IFtdOwogICAgICBwb2x5Z29uVmVydGljZXMucHVzaChuZXcgVmVydGV4KCkpOwogICAgICBwb2x5Z29uVmVydGljZXMucHVzaChuZXcgVmVydGV4KCkpOwogICAgICBwb2x5Z29uVmVydGljZXMucHVzaChuZXcgVmVydGV4KCkpOwogICAgICBwb2x5Z29uVmVydGljZXMucHVzaChuZXcgVmVydGV4KCkpOwogICAgICB1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoX2RlZmF1bHQgPSBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyX2RlZmF1bHQodXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaCk7CiAgICB9CiAgfSk7CgogIC8vIGltcG9ydCgiLi8qKi8qLmpzIikgaW4gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUdlb21ldHJ5LmpzCiAgdmFyIGdsb2JJbXBvcnRfanM7CiAgdmFyIGluaXRfID0gX19lc20oewogICAgJ2ltcG9ydCgiLi8qKi8qLmpzIikgaW4gcGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUdlb21ldHJ5LmpzJygpIHsKICAgICAgZ2xvYkltcG9ydF9qcyA9IF9fZ2xvYih7CiAgICAgICAgIi4vY29tYmluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jb21iaW5lR2VvbWV0cnkoKSwgY29tYmluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVCb3hHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlQm94R2VvbWV0cnkoKSwgY3JlYXRlQm94R2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUJveE91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlQ2lyY2xlR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUNpcmNsZUdlb21ldHJ5KCksIGNyZWF0ZUNpcmNsZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeSgpLCBjcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVDb3JyaWRvckdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVDb3JyaWRvckdlb21ldHJ5KCksIGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlQ3lsaW5kZXJHZW9tZXRyeSgpLCBjcmVhdGVDeWxpbmRlckdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUVsbGlwc2VHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlRWxsaXBzZUdlb21ldHJ5KCksIGNyZWF0ZUVsbGlwc2VHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlRWxsaXBzZU91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVFbGxpcHNvaWRHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnkoKSwgY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlRnJ1c3R1bUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVGcnVzdHVtR2VvbWV0cnkoKSwgY3JlYXRlRnJ1c3R1bUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVHZW9tZXRyeSgpLCBjcmVhdGVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlR3JvdW5kUG9seWxpbmVHZW9tZXRyeSgpLCBjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVQbGFuZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVQbGFuZUdlb21ldHJ5KCksIGNyZWF0ZVBsYW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeSgpLCBjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlUG9seWdvbkdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVQb2x5Z29uR2VvbWV0cnkoKSwgY3JlYXRlUG9seWdvbkdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVQb2x5Z29uT3V0bGluZUdlb21ldHJ5KCksIGNyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVBvbHlsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVBvbHlsaW5lR2VvbWV0cnkoKSwgY3JlYXRlUG9seWxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlUG9seWxpbmVWb2x1bWVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUG9seWxpbmVWb2x1bWVHZW9tZXRyeSgpLCBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeS5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVSZWN0YW5nbGVHZW9tZXRyeSgpLCBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5KCksIGNyZWF0ZVNpbXBsZVBvbHlsaW5lR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVNwaGVyZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVTcGhlcmVHZW9tZXRyeSgpLCBjcmVhdGVTcGhlcmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5X2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyKCksIGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lcygpLCBjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lc19leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzKCksIGNyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzX2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVWZWN0b3JUaWxlUG9pbnRzLmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9jcmVhdGVWZWN0b3JUaWxlUG9pbnRzKCksIGNyZWF0ZVZlY3RvclRpbGVQb2ludHNfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVZlY3RvclRpbGVQb2x5Z29ucy5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zKCksIGNyZWF0ZVZlY3RvclRpbGVQb2x5Z29uc19leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lcy5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lcygpLCBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzX2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXIuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcigpLCBjcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXJfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcC5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwKCksIGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcF9leHBvcnRzKSksCiAgICAgICAgIi4vY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2guanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoKCksIGNyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoX2V4cG9ydHMpKSwKICAgICAgICAiLi9jcmVhdGVXYWxsR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVdhbGxHZW9tZXRyeSgpLCBjcmVhdGVXYWxsR2VvbWV0cnlfZXhwb3J0cykpLAogICAgICAgICIuL2NyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2NyZWF0ZVdhbGxPdXRsaW5lR2VvbWV0cnkoKSwgY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeV9leHBvcnRzKSksCiAgICAgICAgIi4vZGVjb2RlRHJhY28uanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2RlY29kZURyYWNvKCksIGRlY29kZURyYWNvX2V4cG9ydHMpKSwKICAgICAgICAiLi9kZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQuanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2RlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldCgpLCBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXRfZXhwb3J0cykpLAogICAgICAgICIuL2RlY29kZUkzUy5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfZGVjb2RlSTNTKCksIGRlY29kZUkzU19leHBvcnRzKSksCiAgICAgICAgIi4vdHJhbnNjb2RlS1RYMi5qcyI6ICgpID0+IFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gKGluaXRfdHJhbnNjb2RlS1RYMigpLCB0cmFuc2NvZGVLVFgyX2V4cG9ydHMpKSwKICAgICAgICAiLi90cmFuc2ZlclR5cGVkQXJyYXlUZXN0LmpzIjogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF90cmFuc2ZlclR5cGVkQXJyYXlUZXN0KCksIHRyYW5zZmVyVHlwZWRBcnJheVRlc3RfZXhwb3J0cykpLAogICAgICAgICIuL3Vwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2guanMiOiAoKSA9PiBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X3Vwc2FtcGxlUXVhbnRpemVkVGVycmFpbk1lc2goKSwgdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaF9leHBvcnRzKSkKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIC8vIHBhY2thZ2VzL2VuZ2luZS9Tb3VyY2UvV29ya2Vycy9jcmVhdGVHZW9tZXRyeS5qcwogIHZhciBjcmVhdGVHZW9tZXRyeV9leHBvcnRzID0ge307CiAgX19leHBvcnQoY3JlYXRlR2VvbWV0cnlfZXhwb3J0cywgewogICAgZGVmYXVsdDogKCkgPT4gY3JlYXRlR2VvbWV0cnlfZGVmYXVsdAogIH0pOwogIGFzeW5jIGZ1bmN0aW9uIGdldE1vZHVsZShtb2R1bGVOYW1lLCBtb2R1bGVQYXRoKSB7CiAgICBsZXQgbW9kdWxlID0gZGVmYXVsdFZhbHVlX2RlZmF1bHQobW9kdWxlQ2FjaGVbbW9kdWxlUGF0aF0sIG1vZHVsZUNhY2hlW21vZHVsZU5hbWVdKTsKICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobW9kdWxlKSkgewogICAgICByZXR1cm4gbW9kdWxlOwogICAgfQogICAgaWYgKGRlZmluZWRfZGVmYXVsdChtb2R1bGVQYXRoKSkgewogICAgICBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICJvYmplY3QiKSB7CiAgICAgICAgbW9kdWxlID0gX19yZXF1aXJlKG1vZHVsZVBhdGgpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGltcG9ydChtb2R1bGVQYXRoKTsKICAgICAgICBtb2R1bGUgPSByZXN1bHQuZGVmYXVsdDsKICAgICAgfQogICAgICBtb2R1bGVDYWNoZVttb2R1bGVQYXRoXSA9IG1vZHVsZTsKICAgICAgcmV0dXJuIG1vZHVsZTsKICAgIH0KICAgIGlmICh0eXBlb2YgZXhwb3J0cyA9PT0gIm9iamVjdCIpIHsKICAgICAgbW9kdWxlID0gX19yZXF1aXJlKGBXb3JrZXJzLyR7bW9kdWxlTmFtZX1gKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHJlc3VsdCA9IGRlZmluZWRfZGVmYXVsdChtb2R1bGVQYXRoKSA/IGF3YWl0IGltcG9ydChtb2R1bGVQYXRoKSA6IGF3YWl0IGdsb2JJbXBvcnRfanMoYC4vJHttb2R1bGVOYW1lfS5qc2ApOwogICAgICBtb2R1bGUgPSByZXN1bHQuZGVmYXVsdDsKICAgIH0KICAgIG1vZHVsZUNhY2hlW21vZHVsZU5hbWVdID0gbW9kdWxlOwogICAgcmV0dXJuIG1vZHVsZTsKICB9CiAgYXN5bmMgZnVuY3Rpb24gY3JlYXRlR2VvbWV0cnkocGFyYW1ldGVycywgdHJhbnNmZXJhYmxlT2JqZWN0cykgewogICAgY29uc3Qgc3ViVGFza3MgPSBwYXJhbWV0ZXJzLnN1YlRhc2tzOwogICAgY29uc3QgbGVuZ3RoID0gc3ViVGFza3MubGVuZ3RoOwogICAgY29uc3QgcmVzdWx0c09yUHJvbWlzZXMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgdGFzayA9IHN1YlRhc2tzW2ldOwogICAgICBjb25zdCBnZW9tZXRyeSA9IHRhc2suZ2VvbWV0cnk7CiAgICAgIGNvbnN0IG1vZHVsZU5hbWUgPSB0YXNrLm1vZHVsZU5hbWU7CiAgICAgIGNvbnN0IG1vZHVsZVBhdGggPSB0YXNrLm1vZHVsZVBhdGg7CiAgICAgIGlmIChkZWZpbmVkX2RlZmF1bHQobW9kdWxlTmFtZSkgJiYgZGVmaW5lZF9kZWZhdWx0KG1vZHVsZVBhdGgpKSB7CiAgICAgICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yX2RlZmF1bHQoIk11c3Qgb25seSBzZXQgbW9kdWxlTmFtZSBvciBtb2R1bGVQYXRoIik7CiAgICAgIH0KICAgICAgaWYgKGRlZmluZWRfZGVmYXVsdChtb2R1bGVOYW1lKSB8fCBkZWZpbmVkX2RlZmF1bHQobW9kdWxlUGF0aCkpIHsKICAgICAgICByZXN1bHRzT3JQcm9taXNlc1tpXSA9IGdldE1vZHVsZSgKICAgICAgICAgIG1vZHVsZU5hbWUsCiAgICAgICAgICBtb2R1bGVQYXRoCiAgICAgICAgKS50aGVuKChjcmVhdGVGdW5jdGlvbikgPT4gY3JlYXRlRnVuY3Rpb24oZ2VvbWV0cnksIHRhc2sub2Zmc2V0KSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0c09yUHJvbWlzZXNbaV0gPSBnZW9tZXRyeTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIFByb21pc2UuYWxsKHJlc3VsdHNPclByb21pc2VzKS50aGVuKGZ1bmN0aW9uKHJlc3VsdHMpIHsKICAgICAgcmV0dXJuIFByaW1pdGl2ZVBpcGVsaW5lX2RlZmF1bHQucGFja0NyZWF0ZUdlb21ldHJ5UmVzdWx0cygKICAgICAgICByZXN1bHRzLAogICAgICAgIHRyYW5zZmVyYWJsZU9iamVjdHMKICAgICAgKTsKICAgIH0pOwogIH0KICB2YXIgbW9kdWxlQ2FjaGUsIGNyZWF0ZUdlb21ldHJ5X2RlZmF1bHQ7CiAgdmFyIGluaXRfY3JlYXRlR2VvbWV0cnkgPSBfX2VzbSh7CiAgICAicGFja2FnZXMvZW5naW5lL1NvdXJjZS9Xb3JrZXJzL2NyZWF0ZUdlb21ldHJ5LmpzIigpIHsKICAgICAgaW5pdF9EZXZlbG9wZXJFcnJvcigpOwogICAgICBpbml0X2RlZmF1bHRWYWx1ZSgpOwogICAgICBpbml0X2RlZmluZWQoKTsKICAgICAgaW5pdF9QcmltaXRpdmVQaXBlbGluZSgpOwogICAgICBpbml0X2NyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXIoKTsKICAgICAgaW5pdF8oKTsKICAgICAgbW9kdWxlQ2FjaGUgPSB7fTsKICAgICAgY3JlYXRlR2VvbWV0cnlfZGVmYXVsdCA9IGNyZWF0ZVRhc2tQcm9jZXNzb3JXb3JrZXJfZGVmYXVsdChjcmVhdGVHZW9tZXRyeSk7CiAgICB9CiAgfSk7CgogIC8vIDxzdGRpbj4KICB2YXIgc3RkaW5fZXhwb3J0cyA9IHt9OwogIF9fZXhwb3J0KHN0ZGluX2V4cG9ydHMsIHsKICAgIGNvbWJpbmVHZW9tZXRyeTogKCkgPT4gY29tYmluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUJveEdlb21ldHJ5OiAoKSA9PiBjcmVhdGVCb3hHZW9tZXRyeTIsCiAgICBjcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUJveE91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVDaXJjbGVHZW9tZXRyeTogKCkgPT4gY3JlYXRlQ2lyY2xlR2VvbWV0cnkyLAogICAgY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVDaXJjbGVPdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlQ29wbGFuYXJQb2x5Z29uR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5MiwKICAgIGNyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlQ29wbGFuYXJQb2x5Z29uT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUNvcnJpZG9yR2VvbWV0cnkyLAogICAgY3JlYXRlQ29ycmlkb3JPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUN5bGluZGVyR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUN5bGluZGVyR2VvbWV0cnkyLAogICAgY3JlYXRlQ3lsaW5kZXJPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUVsbGlwc2VHZW9tZXRyeTogKCkgPT4gY3JlYXRlRWxsaXBzZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUVsbGlwc2VPdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlRWxsaXBzb2lkR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5MiwKICAgIGNyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlRWxsaXBzb2lkT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUZydXN0dW1HZW9tZXRyeTogKCkgPT4gY3JlYXRlRnJ1c3R1bUdlb21ldHJ5MiwKICAgIGNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUZydXN0dW1PdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUdlb21ldHJ5MiwKICAgIGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZUdyb3VuZFBvbHlsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlUGxhbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlUGxhbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVQbGFuZU91dGxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnkyLAogICAgY3JlYXRlUG9seWdvbkdlb21ldHJ5OiAoKSA9PiBjcmVhdGVQb2x5Z29uR2VvbWV0cnkyLAogICAgY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeTogKCkgPT4gY3JlYXRlUG9seWdvbk91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVQb2x5bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVQb2x5bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVBvbHlsaW5lVm9sdW1lR2VvbWV0cnkyLAogICAgY3JlYXRlUG9seWxpbmVWb2x1bWVPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZVJlY3RhbmdsZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeTIsCiAgICBjcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVJlY3RhbmdsZU91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVTaW1wbGVQb2x5bGluZUdlb21ldHJ5MiwKICAgIGNyZWF0ZVNwaGVyZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVTcGhlcmVHZW9tZXRyeTIsCiAgICBjcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVNwaGVyZU91dGxpbmVHZW9tZXRyeTIsCiAgICBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyOiAoKSA9PiBjcmVhdGVUYXNrUHJvY2Vzc29yV29ya2VyMiwKICAgIGNyZWF0ZVZlY3RvclRpbGVDbGFtcGVkUG9seWxpbmVzOiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lczIsCiAgICBjcmVhdGVWZWN0b3JUaWxlR2VvbWV0cmllczogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMyLAogICAgY3JlYXRlVmVjdG9yVGlsZVBvaW50czogKCkgPT4gY3JlYXRlVmVjdG9yVGlsZVBvaW50czIsCiAgICBjcmVhdGVWZWN0b3JUaWxlUG9seWdvbnM6ICgpID0+IGNyZWF0ZVZlY3RvclRpbGVQb2x5Z29uczIsCiAgICBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzOiAoKSA9PiBjcmVhdGVWZWN0b3JUaWxlUG9seWxpbmVzMiwKICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcjogKCkgPT4gY3JlYXRlVmVydGljZXNGcm9tR29vZ2xlRWFydGhFbnRlcnByaXNlQnVmZmVyMiwKICAgIGNyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcDogKCkgPT4gY3JlYXRlVmVydGljZXNGcm9tSGVpZ2h0bWFwMiwKICAgIGNyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoOiAoKSA9PiBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaDIsCiAgICBjcmVhdGVXYWxsR2VvbWV0cnk6ICgpID0+IGNyZWF0ZVdhbGxHZW9tZXRyeTIsCiAgICBjcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5OiAoKSA9PiBjcmVhdGVXYWxsT3V0bGluZUdlb21ldHJ5MiwKICAgIGRlY29kZURyYWNvOiAoKSA9PiBkZWNvZGVEcmFjbzIsCiAgICBkZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQ6ICgpID0+IGRlY29kZUdvb2dsZUVhcnRoRW50ZXJwcmlzZVBhY2tldDIsCiAgICBkZWNvZGVJM1M6ICgpID0+IGRlY29kZUkzUzIsCiAgICB0cmFuc2NvZGVLVFgyOiAoKSA9PiB0cmFuc2NvZGVLVFgyMiwKICAgIHRyYW5zZmVyVHlwZWRBcnJheVRlc3Q6ICgpID0+IHRyYW5zZmVyVHlwZWRBcnJheVRlc3QsCiAgICB1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoOiAoKSA9PiB1cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoMgogIH0pOwogIHZhciBjb21iaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NvbWJpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVCb3hHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlQm94R2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlQm94T3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVCb3hPdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlQ2lyY2xlR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUNpcmNsZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUNpcmNsZU91dGxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlQ2lyY2xlT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUNvcGxhbmFyUG9seWdvbkdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDb3BsYW5hclBvbHlnb25HZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVDb3BsYW5hclBvbHlnb25PdXRsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUNvcGxhbmFyUG9seWdvbk91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVDb3JyaWRvckdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDb3JyaWRvckdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUNvcnJpZG9yT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDb3JyaWRvck91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVDeWxpbmRlckdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDeWxpbmRlckdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUN5bGluZGVyT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVDeWxpbmRlck91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVFbGxpcHNlR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUVsbGlwc2VHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVFbGxpcHNlT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUVsbGlwc29pZEdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVFbGxpcHNvaWRHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVFbGxpcHNvaWRPdXRsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUVsbGlwc29pZE91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVGcnVzdHVtR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZUZydXN0dW1HZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVGcnVzdHVtT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVHcm91bmRQb2x5bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVBsYW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVBsYW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlUGxhbmVPdXRsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVBsYW5lT3V0bGluZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVBvbHlnb25HZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlUG9seWdvbkdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnkyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVBvbHlnb25PdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlUG9seWxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlUG9seWxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVQb2x5bGluZVZvbHVtZUdlb21ldHJ5KCkpOwogIH07CiAgdmFyIGNyZWF0ZVBvbHlsaW5lVm9sdW1lT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVQb2x5bGluZVZvbHVtZU91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVSZWN0YW5nbGVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlUmVjdGFuZ2xlR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlUmVjdGFuZ2xlT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVSZWN0YW5nbGVPdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlU2ltcGxlUG9seWxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBjcmVhdGVTcGhlcmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlU3BoZXJlR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlU3BoZXJlT3V0bGluZUdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVTcGhlcmVPdXRsaW5lR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcjIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlVGFza1Byb2Nlc3NvcldvcmtlcigpKTsKICB9OwogIHZhciBjcmVhdGVWZWN0b3JUaWxlQ2xhbXBlZFBvbHlsaW5lczIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlVmVjdG9yVGlsZUNsYW1wZWRQb2x5bGluZXMoKSk7CiAgfTsKICB2YXIgY3JlYXRlVmVjdG9yVGlsZUdlb21ldHJpZXMyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlY3RvclRpbGVHZW9tZXRyaWVzKCkpOwogIH07CiAgdmFyIGNyZWF0ZVZlY3RvclRpbGVQb2ludHMyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlY3RvclRpbGVQb2ludHMoKSk7CiAgfTsKICB2YXIgY3JlYXRlVmVjdG9yVGlsZVBvbHlnb25zMiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVWZWN0b3JUaWxlUG9seWdvbnMoKSk7CiAgfTsKICB2YXIgY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lczIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlVmVjdG9yVGlsZVBvbHlsaW5lcygpKTsKICB9OwogIHZhciBjcmVhdGVWZXJ0aWNlc0Zyb21Hb29nbGVFYXJ0aEVudGVycHJpc2VCdWZmZXIyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbUdvb2dsZUVhcnRoRW50ZXJwcmlzZUJ1ZmZlcigpKTsKICB9OwogIHZhciBjcmVhdGVWZXJ0aWNlc0Zyb21IZWlnaHRtYXAyID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X2NyZWF0ZVZlcnRpY2VzRnJvbUhlaWdodG1hcCgpKTsKICB9OwogIHZhciBjcmVhdGVWZXJ0aWNlc0Zyb21RdWFudGl6ZWRUZXJyYWluTWVzaDIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlVmVydGljZXNGcm9tUXVhbnRpemVkVGVycmFpbk1lc2goKSk7CiAgfTsKICB2YXIgY3JlYXRlV2FsbEdlb21ldHJ5MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9jcmVhdGVXYWxsR2VvbWV0cnkoKSk7CiAgfTsKICB2YXIgY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeTIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfY3JlYXRlV2FsbE91dGxpbmVHZW9tZXRyeSgpKTsKICB9OwogIHZhciBkZWNvZGVEcmFjbzIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfZGVjb2RlRHJhY28oKSk7CiAgfTsKICB2YXIgZGVjb2RlR29vZ2xlRWFydGhFbnRlcnByaXNlUGFja2V0MiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9kZWNvZGVHb29nbGVFYXJ0aEVudGVycHJpc2VQYWNrZXQoKSk7CiAgfTsKICB2YXIgZGVjb2RlSTNTMiA9ICgpID0+IHsKICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gaW5pdF9kZWNvZGVJM1MoKSk7CiAgfTsKICB2YXIgdHJhbnNjb2RlS1RYMjIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfdHJhbnNjb2RlS1RYMigpKTsKICB9OwogIHZhciB0cmFuc2ZlclR5cGVkQXJyYXlUZXN0ID0gKCkgPT4gewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBpbml0X3RyYW5zZmVyVHlwZWRBcnJheVRlc3QoKSk7CiAgfTsKICB2YXIgdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaDIgPSAoKSA9PiB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGluaXRfdXBzYW1wbGVRdWFudGl6ZWRUZXJyYWluTWVzaCgpKTsKICB9OwogIHJldHVybiBfX3RvQ29tbW9uSlMoc3RkaW5fZXhwb3J0cyk7Cn0pKCk7Cg==");